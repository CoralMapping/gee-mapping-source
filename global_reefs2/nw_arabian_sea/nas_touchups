/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var imageVisParam = {"opacity":1,"bands":["depth"],"min":1500,"max":2500,"gamma":1},
    geometry = /* color: #d63000 */ee.Geometry.MultiPoint(),
    GCRMN_ext = ee.Image("projects/coral_atlas/global_datasets/GCRMN_reefextent_final"),
    mid_mask = /* color: #d6af32 */ee.Geometry({
      "type": "GeometryCollection",
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                49.99863893693888,
                29.906019458556198
              ],
              [
                50.34470827287638,
                29.440673471940798
              ],
              [
                50.45731813615763,
                29.210791558897924
              ],
              [
                50.61661989397013,
                28.91311315339347
              ],
              [
                50.95994264787638,
                28.419079138708632
              ],
              [
                51.03410036272013,
                28.05631211047235
              ],
              [
                51.19065553850138,
                27.638609437669416
              ],
              [
                51.49003297990763,
                27.353558732398387
              ],
              [
                51.87455446428263,
                27.346240046110307
              ],
              [
                52.02561647600138,
                27.587500883032718
              ],
              [
                52.03385622209513,
                27.813657433806906
              ],
              [
                52.12312013811076,
                27.848876117755516
              ],
              [
                51.78666383928263,
                27.89622114621874
              ],
              [
                51.25769246309832,
                29.007222151784248
              ],
              [
                50.64434800250122,
                29.885098984980488
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                54.81762160862138,
                26.554622748431317
              ],
              [
                54.80460056301248,
                26.51773821358238
              ],
              [
                54.82179018008156,
                26.458733903417304
              ],
              [
                54.93023147190263,
                26.35544619371216
              ],
              [
                55.28522719944169,
                26.34929329324787
              ],
              [
                55.47954787815263,
                26.400967479826335
              ],
              [
                55.67919609306939,
                26.514407019235207
              ],
              [
                55.68405762572328,
                26.648663158890056
              ],
              [
                55.634451875562284,
                26.629751932099186
              ],
              [
                55.61282167544202,
                26.626902833999132
              ],
              [
                55.583260365979,
                26.653734253089105
              ],
              [
                55.67730178440263,
                26.711752607336205
              ],
              [
                56.20739211643388,
                26.969074318436807
              ],
              [
                56.29253615940263,
                26.92745241317057
              ],
              [
                56.38042678440263,
                26.97886547340657
              ],
              [
                56.42302875817825,
                26.962825396606952
              ],
              [
                56.48311411341312,
                26.97578372426924
              ],
              [
                56.528779053756125,
                27.01136433701954
              ],
              [
                56.52808631421452,
                27.040893888623284
              ],
              [
                56.60293187786718,
                27.035039177543066
              ],
              [
                56.763186540115754,
                26.955388671176436
              ],
              [
                56.993944921450556,
                26.507942215319414
              ],
              [
                56.95344326423149,
                26.30617346289286
              ],
              [
                57.17751907928015,
                25.88186289925245
              ],
              [
                57.34894459664794,
                25.723405335869405
              ],
              [
                57.777941895513194,
                25.594739820781648
              ],
              [
                58.32356023509874,
                25.475516821387124
              ],
              [
                59.1151025811464,
                25.273098951334124
              ],
              [
                59.45312137199569,
                25.381858715168118
              ],
              [
                60.017746176500204,
                25.28206901859547
              ],
              [
                60.12566506800068,
                25.36831695114481
              ],
              [
                60.13477123563342,
                25.414830733778327
              ],
              [
                58.90658274370702,
                25.68323929468942
              ],
              [
                57.838927249417935,
                25.737986492026366
              ],
              [
                57.22605176423162,
                26.507749840410263
              ],
              [
                56.862516736439886,
                27.13955762322518
              ],
              [
                56.42448928627639,
                27.269689884576607
              ],
              [
                56.20464553440263,
                27.27708557726463
              ],
              [
                55.4869410264111,
                26.946932723762323
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                60.68635819985862,
                25.327613096732044
              ],
              [
                60.61220048501487,
                25.272984222847064
              ],
              [
                61.61607621743674,
                24.77648134936344
              ],
              [
                61.83717607095237,
                24.855009852002553
              ],
              [
                61.774047800307166,
                24.9707929747951
              ],
              [
                61.77849688148368,
                24.991177917511223
              ],
              [
                61.78664749336026,
                25.002341810744955
              ],
              [
                61.78037869672991,
                25.010394176812838
              ],
              [
                61.78020083774617,
                25.0289881709559
              ],
              [
                61.79460404946799,
                25.095270675498153
              ],
              [
                61.88524125649924,
                25.246902675872573
              ],
              [
                61.59685014321799,
                25.286643749265973
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                61.87288163735862,
                25.183538470648184
              ],
              [
                61.82564945409002,
                25.06056914529143
              ],
              [
                61.7835167333047,
                25.021466085380506
              ],
              [
                61.78099312893906,
                25.018091767149514
              ],
              [
                61.780847062366426,
                25.012282450892872
              ],
              [
                61.80456040933127,
                25.002271983051255
              ],
              [
                63.08824418618674,
                25.062931306673462
              ],
              [
                63.556491099975865,
                24.873278013573145
              ],
              [
                64.07976029946799,
                25.085321010364552
              ],
              [
                64.7094639440163,
                25.092783335060826
              ],
              [
                64.95940290886006,
                25.145006859647584
              ],
              [
                64.98686872917256,
                25.59171745412589
              ],
              [
                63.86041777297626,
                25.546446049158686
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                49.22500695135639,
                27.476362515538057
              ],
              [
                49.65896691229389,
                27.392261863326972
              ],
              [
                49.72076500799702,
                27.59935066067188
              ],
              [
                49.49279869940327,
                27.6881572780046
              ],
              [
                49.21676720526264,
                27.665050168312334
              ],
              [
                49.25659264471577,
                28.040236341844086
              ],
              [
                48.94189714925376,
                28.413283353241784
              ],
              [
                48.602496590250176,
                28.57639263851514
              ],
              [
                48.592217855067815,
                28.701704723337333
              ],
              [
                48.680108480067815,
                28.698090988973174
              ],
              [
                48.64577620467719,
                28.856977117455205
              ],
              [
                48.701941218094646,
                28.88849433810867
              ],
              [
                48.74229024840664,
                28.93076193647251
              ],
              [
                49.18330861209946,
                29.023007001736108
              ],
              [
                49.15189698313906,
                29.1727383606818
              ],
              [
                49.07292061619433,
                29.303719017732565
              ],
              [
                49.201196233061104,
                29.797651051667327
              ],
              [
                48.66067817977513,
                29.888870841907337
              ],
              [
                48.39593675979563,
                30.1395727142165
              ],
              [
                47.97600418294658,
                30.224250031816403
              ],
              [
                47.45085146144893,
                29.703334442035995
              ],
              [
                47.65568428806933,
                29.07217843997087
              ],
              [
                48.20037102011149,
                28.641993671603732
              ],
              [
                48.493296285450874,
                28.135547995001552
              ],
              [
                48.713624661462575,
                27.653167249809048
              ],
              [
                48.94205592314628,
                27.533341865791943
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                50.943144815710404,
                26.50393157890123
              ],
              [
                50.704183760431256,
                26.484266286314885
              ],
              [
                51.12717160374941,
                26.28742285695176
              ],
              [
                51.3826123853344,
                26.22584021965416
              ],
              [
                51.657474027569215,
                25.97674855598602
              ],
              [
                51.60313155209235,
                25.94278114827776
              ],
              [
                51.56462240047433,
                25.911906912017688
              ],
              [
                51.556813821452046,
                25.85516353089379
              ],
              [
                51.52800834272707,
                25.737727409703506
              ],
              [
                51.49197430652292,
                25.682401922891824
              ],
              [
                51.46915726204204,
                25.556421328881118
              ],
              [
                51.47882535148023,
                25.55524051540178
              ],
              [
                51.44763712802644,
                25.49674269251073
              ],
              [
                51.50811339277924,
                25.43945145882561
              ],
              [
                51.479183944050746,
                25.342261635901718
              ],
              [
                51.540770508742725,
                25.229225346322277
              ],
              [
                51.598968068880396,
                25.17763036386078
              ],
              [
                51.64762044215515,
                25.174801095007787
              ],
              [
                51.66133341274916,
                25.16943056379568
              ],
              [
                51.6592623061282,
                25.156489612303364
              ],
              [
                51.699424271341016,
                25.11676165454218
              ],
              [
                51.707999323338534,
                25.150381598509597
              ],
              [
                51.738869767193364,
                25.221026473685956
              ],
              [
                51.744080011980735,
                25.389303188636426
              ],
              [
                51.73043246054142,
                25.502810484557873
              ],
              [
                51.851605513202706,
                25.651886174874686
              ],
              [
                51.956008342401006,
                25.70638296315453
              ],
              [
                52.091337398184486,
                25.66668354979186
              ],
              [
                52.15969107026163,
                25.694694046454668
              ],
              [
                52.19288032979063,
                25.840831405564696
              ],
              [
                52.522483220661314,
                26.201194374674202
              ],
              [
                51.67951990828021,
                26.432102173419235
              ],
              [
                51.48516359585426,
                26.618681379687644
              ],
              [
                51.230172508841655,
                26.539564882957865
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                53.4139574464952,
                24.897019120496072
              ],
              [
                53.94336113301864,
                24.275128674823236
              ],
              [
                53.95897684817,
                24.248364374970325
              ],
              [
                53.97390640225041,
                24.224102297060508
              ],
              [
                53.995519499903665,
                24.184342663445072
              ],
              [
                53.986562613430515,
                24.162444264408382
              ],
              [
                53.95493078696781,
                24.13619379988011
              ],
              [
                53.9108362685545,
                24.118160546579162
              ],
              [
                53.83102698965985,
                24.12201516805564
              ],
              [
                53.78539418011614,
                24.115908498083265
              ],
              [
                53.733570239577894,
                24.10483646311739
              ],
              [
                53.689295297619005,
                24.101899042481936
              ],
              [
                53.59797844258895,
                24.124815939405227
              ],
              [
                53.235402415185405,
                24.210059132540888
              ],
              [
                53.00941031610536,
                24.34239401327155
              ],
              [
                53.05862476538062,
                24.392288602536468
              ],
              [
                52.99250703070702,
                24.495942458147493
              ],
              [
                52.81899082397201,
                24.47818912307984
              ],
              [
                52.71510069431786,
                24.430129524260657
              ],
              [
                52.67791183066874,
                24.27434929571505
              ],
              [
                52.549488512819046,
                24.23403025401574
              ],
              [
                52.32326112958333,
                24.245190446880585
              ],
              [
                52.15947738266717,
                24.00722861929327
              ],
              [
                52.13673549668482,
                23.949278898833985
              ],
              [
                52.313106451498044,
                23.96659189053395
              ],
              [
                52.30195776394066,
                24.03132222212469
              ],
              [
                52.38224485177989,
                24.102006997151367
              ],
              [
                52.39723011382233,
                24.06158651882328
              ],
              [
                52.40384070865043,
                24.03216303777837
              ],
              [
                52.64081478258361,
                24.11605628191966
              ],
              [
                53.35627922383895,
                24.06714913345558
              ],
              [
                54.04841789571395,
                23.924124066670558
              ],
              [
                54.9630297121202,
                24.75742586080889
              ],
              [
                55.1607836183702,
                24.979205643802977
              ],
              [
                55.1992357668077,
                25.056361172378487
              ],
              [
                55.674594825298875,
                25.554599556590713
              ],
              [
                56.228378242784025,
                25.028600271681434
              ],
              [
                56.44447872438716,
                24.43655459635373
              ],
              [
                57.052004761620516,
                23.83918540983969
              ],
              [
                57.83962508145801,
                23.656842557841507
              ],
              [
                58.28307295670888,
                23.58391577498332
              ],
              [
                58.518912908958455,
                23.605893122574315
              ],
              [
                58.467786385833826,
                23.65675687200744
              ],
              [
                58.266595544831546,
                23.734629035042687
              ],
              [
                57.89983682813656,
                23.799838007953426
              ],
              [
                57.63853680471482,
                23.86611013651726
              ],
              [
                56.939502060653844,
                24.219333204769153
              ],
              [
                56.649393659754686,
                24.912162149352056
              ],
              [
                56.42276841433952,
                25.715610282148557
              ],
              [
                56.57610744662749,
                25.910431239967448
              ],
              [
                56.68786612626357,
                26.32669713188769
              ],
              [
                56.46494575747182,
                26.518469205562717
              ],
              [
                55.039209226509215,
                25.383500815830512
              ],
              [
                54.4961107668077,
                25.195615777866884
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                51.85999281808252,
                24.03320003934677
              ],
              [
                51.79733236332714,
                24.072310004247342
              ],
              [
                51.791581707199214,
                24.069253689368995
              ],
              [
                51.789521770675776,
                24.06870511232307
              ],
              [
                51.78342779179394,
                24.070507570949804
              ],
              [
                51.77501638432324,
                24.071604707277956
              ],
              [
                51.779822902877925,
                24.019558771155676
              ],
              [
                51.8114085962373,
                23.996037126322904
              ],
              [
                51.8194766809541,
                23.985058887236143
              ],
              [
                51.82960470219433,
                23.972511182223283
              ],
              [
                51.862220363815425,
                23.982235760176085
              ],
              [
                51.86840017338574,
                23.995096171083674
              ],
              [
                51.87663991947949,
                23.99791901616466
              ],
              [
                51.88178976078808,
                24.0079552972172
              ],
              [
                51.88728292485058,
                24.016422800360996
              ],
              [
                51.89071615238964,
                24.023635418838193
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                51.20329078178948,
                24.64943247639868
              ],
              [
                51.24174293022698,
                24.522680849393893
              ],
              [
                51.28980811577385,
                24.48206826446793
              ],
              [
                51.39280494194573,
                24.541420692355373
              ],
              [
                51.422330698781664,
                24.611045902768595
              ],
              [
                51.410314402394945,
                24.612294432081974
              ],
              [
                51.400358042531664,
                24.623530635006272
              ],
              [
                51.40825446587151,
                24.640383045811365
              ],
              [
                51.396581492238695,
                24.677824706871647
              ],
              [
                51.26234229546135,
                24.68406389138521
              ],
              [
                51.19137222451452,
                24.67439302231381
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                51.46519575675247,
                24.788828172677384
              ],
              [
                51.45729933341263,
                24.782282536539476
              ],
              [
                51.468628984291534,
                24.768878490084575
              ],
              [
                51.47892866690872,
                24.776204136684324
              ],
              [
                51.47446582035517,
                24.784386524729996
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                51.4885417040181,
                24.789139861023113
              ],
              [
                51.493863206703644,
                24.76139653257972
              ],
              [
                51.47944365103958,
                24.73567386696608
              ],
              [
                51.49763975699661,
                24.727098462374908
              ],
              [
                51.53643522818802,
                24.77854201801028
              ],
              [
                51.546420851659995,
                24.825851978335837
              ],
              [
                51.56773317116827,
                24.852712250838813
              ],
              [
                51.582839372340146,
                24.831059157332646
              ],
              [
                51.61150682229132,
                24.827943292592625
              ],
              [
                51.63262117165655,
                24.859098410892376
              ],
              [
                51.6928743149671,
                24.83324021600004
              ],
              [
                51.72548997658819,
                24.90581637290787
              ],
              [
                51.720683458033506,
                24.92169645366675
              ],
              [
                51.69527757424444,
                24.902079586254885
              ],
              [
                51.680514695826474,
                24.877164784462245
              ],
              [
                51.654765489283506,
                24.921385099184942
              ],
              [
                51.619059922877256,
                24.912666854545286
              ],
              [
                51.59914720315069,
                24.917026053897626
              ],
              [
                51.59193742531866,
                24.937574489638887
              ],
              [
                51.57648790139288,
                24.95158282252347
              ],
              [
                51.49992692727179,
                24.890868547501295
              ],
              [
                51.45769822854132,
                24.814855804663818
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                50.05204564756563,
                26.25654556496321
              ],
              [
                49.83779877978349,
                26.16043494205721
              ],
              [
                49.961403045059285,
                25.932164428040096
              ],
              [
                50.154042056822895,
                25.750895556611333
              ],
              [
                50.24322957704748,
                25.681285898852757
              ],
              [
                50.26165810383931,
                25.634114057829642
              ],
              [
                50.29901274899821,
                25.572146103158953
              ],
              [
                50.33003341601279,
                25.55852093091426
              ],
              [
                50.34278755942144,
                25.517014544595916
              ],
              [
                50.37182541652939,
                25.505564618079678
              ],
              [
                50.39732674779776,
                25.465751058742953
              ],
              [
                50.45677549706714,
                25.404917515250983
              ],
              [
                50.296507133335986,
                25.41104813572837
              ],
              [
                50.43235967488783,
                25.085599518746545
              ],
              [
                50.70428729775088,
                24.665713785174038
              ],
              [
                50.80866365584746,
                24.721863888875344
              ],
              [
                50.70291421259788,
                24.9748484555447
              ],
              [
                50.62600546591856,
                25.20122100928527
              ],
              [
                50.59991162938759,
                25.620510830376503
              ],
              [
                50.60403182304948,
                25.719537130123996
              ],
              [
                50.66952381760954,
                25.730626345155382
              ],
              [
                50.69541188421487,
                25.783787301303374
              ],
              [
                50.655378816930536,
                25.783769501246937
              ],
              [
                50.679304293829006,
                25.85912104727801
              ],
              [
                50.54303362373478,
                25.938137513475798
              ],
              [
                50.481801489695485,
                26.17029636468658
              ],
              [
                50.42480591804858,
                26.170609624885376
              ],
              [
                50.402145568689214,
                26.161667936579043
              ],
              [
                50.405965934511734,
                26.192892968895716
              ],
              [
                50.40566737140937,
                26.224117979777624
              ],
              [
                50.400948880823115,
                26.26808816371497
              ],
              [
                50.36198047737835,
                26.197721677613863
              ],
              [
                50.326611520504834,
                26.193714938959232
              ],
              [
                50.292967522107126,
                26.213431449993124
              ],
              [
                50.30154783755263,
                26.252850089268723
              ],
              [
                50.26755451693204,
                26.228213659748995
              ],
              [
                50.23871341405865,
                26.183854600166136
              ],
              [
                50.23253221807735,
                26.17892701209194
              ],
              [
                50.18789860504578,
                26.185086476672073
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                51.61252312745135,
                24.548486166649543
              ],
              [
                51.702473688974784,
                24.63527266685667
              ],
              [
                51.64410882081072,
                24.66273210720742
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                58.16455795519975,
                20.434260301729875
              ],
              [
                58.21951160302905,
                20.455271325979748
              ],
              [
                58.29097581826121,
                20.509711842365327
              ],
              [
                58.30768737626823,
                20.63228062918281
              ],
              [
                58.17073858547253,
                20.67947440005161
              ],
              [
                57.8089544964086,
                20.375022424588494
              ],
              [
                57.63386149385228,
                19.97671513896537
              ],
              [
                57.594036054399155,
                19.22248188580322
              ],
              [
                57.800163218512544,
                18.996068915454412
              ],
              [
                57.83294761524205,
                18.996962474208452
              ],
              [
                57.84753772660415,
                19.00775426738169
              ],
              [
                57.862613797590804,
                19.002231891841507
              ],
              [
                57.926372480180405,
                18.956438821442294
              ],
              [
                58.16395182588353,
                19.22248188580322
              ],
              [
                58.206523847367905,
                19.3780151941462
              ],
              [
                58.29911352821722,
                19.849342626516034
              ],
              [
                58.34305884071722,
                20.027497155265788
              ],
              [
                58.553796401370306,
                20.039090111110887
              ],
              [
                58.603586847043424,
                20.301388827272362
              ],
              [
                58.57926489540472,
                20.348438595882847
              ],
              [
                58.519520801503795,
                20.327196607232775
              ],
              [
                58.47489477821722,
                20.29821438353442
              ],
              [
                58.33962459126928,
                20.294393193729316
              ],
              [
                58.229075686420344,
                20.295638343525578
              ],
              [
                58.11509253212347,
                20.42567473085155
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                57.81649716634064,
                18.97650800708653
              ],
              [
                57.80445435210461,
                18.9663879381177
              ],
              [
                57.79169846903275,
                18.965627062302055
              ],
              [
                57.74970777367953,
                18.96377379874818
              ],
              [
                57.7314069122486,
                18.957037835439458
              ],
              [
                57.6932464054218,
                18.960000449135364
              ],
              [
                57.649591124050716,
                18.963603479226183
              ],
              [
                57.46721554375482,
                18.96053187036374
              ],
              [
                57.09493271431714,
                18.953839395341046
              ],
              [
                56.80310583918908,
                18.822703930223685
              ],
              [
                56.671002682751265,
                18.61852994194167
              ],
              [
                56.2677885703711,
                17.99540103101295
              ],
              [
                56.327534207926554,
                17.927803756465472
              ],
              [
                56.37763841181428,
                17.90395981034563
              ],
              [
                56.46963806637474,
                17.896772789515992
              ],
              [
                56.55065283630627,
                17.92747695552845
              ],
              [
                56.68727981579634,
                18.13834351948248
              ],
              [
                56.831464392621804,
                18.05282478791744
              ],
              [
                56.988211732681904,
                18.020801609703476
              ],
              [
                57.79490236514131,
                18.26771968120243
              ],
              [
                57.11451830252003,
                18.744292410500055
              ],
              [
                57.58961809149551,
                18.81644405009092
              ],
              [
                57.7180050624049,
                18.776797859090625
              ],
              [
                57.888271777497415,
                18.832691194114993
              ],
              [
                57.87797275226763,
                18.944420398971562
              ],
              [
                57.83128657141214,
                18.966497344347786
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.575231225831295,
                17.890379218946222
              ],
              [
                55.36867250285118,
                17.83257924629166
              ],
              [
                55.266279791247555,
                17.707633569446113
              ],
              [
                55.180122178682595,
                17.569887514355372
              ],
              [
                55.20540707109198,
                17.462305833213815
              ],
              [
                55.269265103318546,
                17.44363734388258
              ],
              [
                55.26960842607245,
                17.45379061915094
              ],
              [
                55.31012051103339,
                17.475077907850117
              ],
              [
                55.46017329462966,
                17.650848171894456
              ],
              [
                55.50274531611404,
                17.733273538907795
              ],
              [
                55.6490008092781,
                17.845729494322374
              ],
              [
                55.75783412226638,
                17.886575279777773
              ],
              [
                55.742727921094506,
                17.90552453423313
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.256658153216804,
                17.331904233883666
              ],
              [
                55.33699567763087,
                17.280770585183713
              ],
              [
                55.3496986195254,
                17.402353550517276
              ],
              [
                55.30540998427149,
                17.38892112096327
              ],
              [
                55.29305036513087,
                17.395473648875672
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                54.87467016531946,
                16.986385422962176
              ],
              [
                54.91655554129602,
                16.96537016463363
              ],
              [
                54.90179266287805,
                16.918405702727444
              ],
              [
                54.99654974295618,
                16.948621946797132
              ],
              [
                54.93852819754602,
                16.94106834068392
              ],
              [
                55.015089171667114,
                16.988355482764586
              ],
              [
                55.01337255789758,
                17.00936816590953
              ],
              [
                55.00719274832727,
                17.013636079232437
              ],
              [
                55.008566039342895,
                17.026767509997185
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                54.68020679297229,
                16.984752446709653
              ],
              [
                54.69198041013501,
                16.981309986157196
              ],
              [
                54.69208237561212,
                17.02646058391299
              ],
              [
                54.43905629818056,
                17.060559967375813
              ],
              [
                54.19184002290605,
                17.037940101048914
              ],
              [
                53.773801014172186,
                16.93418516336274
              ],
              [
                53.6918433872023,
                16.855180733315223
              ],
              [
                53.59021985204605,
                16.77893625813639
              ],
              [
                53.58987652929214,
                16.730939123551448
              ],
              [
                53.674677249506985,
                16.745076523277284
              ],
              [
                53.61219250829605,
                16.46476414851524
              ],
              [
                53.90573346288589,
                16.36036558856179
              ],
              [
                53.850458499506985,
                16.85255212428221
              ],
              [
                53.99808728368667,
                16.86733757475997
              ],
              [
                54.258993187042066,
                16.950087317300536
              ],
              [
                54.37204565360071,
                17.012322885492882
              ],
              [
                54.44809405351112,
                17.005277697672888
              ],
              [
                54.520704406042114,
                17.000175406920782
              ],
              [
                54.63365759207727,
                16.966026927067823
              ],
              [
                54.695455687780395,
                16.911507836723185
              ],
              [
                54.70232214285852,
                16.954204851928818
              ],
              [
                54.67863287283899,
                16.971280943852513
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                53.2530225241989,
                16.716487192070332
              ],
              [
                53.28186163552702,
                16.676367687307337
              ],
              [
                53.44940313943327,
                16.677025452018494
              ],
              [
                53.49884161599577,
                16.73753011762926
              ],
              [
                53.45146307595671,
                16.740817864891405
              ],
              [
                53.41644415505827,
                16.773034783558817
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                52.25155491798738,
                16.472104321045435
              ],
              [
                52.10157342992494,
                16.155617819540204
              ],
              [
                52.13453241429994,
                15.701345353816242
              ],
              [
                52.04320187290177,
                15.582993158102601
              ],
              [
                52.212761066978764,
                15.514897824975696
              ],
              [
                52.44764276586244,
                15.828222274311557
              ],
              [
                52.498454533440565,
                16.098890154835804
              ],
              [
                52.764872990471815,
                16.511441023850917
              ],
              [
                52.687968693596815,
                16.540405385792276
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                50.23821976968171,
                26.73149132769673
              ],
              [
                50.27667191811921,
                26.61736787930856
              ],
              [
                50.62823441811921,
                26.605089744865673
              ],
              [
                50.80813554116609,
                26.52033471765242
              ],
              [
                51.01138261147859,
                26.56947570317643
              ],
              [
                50.85070756265046,
                26.767054833098303
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.8433260430777,
                26.716001378514687
              ],
              [
                55.78564782042145,
                26.666923347433734
              ],
              [
                55.785304497667546,
                26.63224925993626
              ],
              [
                55.834742974230046,
                26.634090626623276
              ],
              [
                55.85293908018708,
                26.673979614948294
              ],
              [
                55.87559838194489,
                26.687477345037887
              ],
              [
                55.89928765196442,
                26.694532340646873
              ],
              [
                55.90649742979645,
                26.70005333688916
              ],
              [
                55.897227715440984,
                26.712627940586348
              ],
              [
                55.887958001085515,
                26.72489450841915
              ],
              [
                55.881434868761296,
                26.725814447714043
              ],
              [
                55.86564202208161,
                26.728267582807593
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.98117012877106,
                26.735382374709214
              ],
              [
                56.010695885607,
                26.705943104129766
              ],
              [
                56.167594384142156,
                26.795157435759652
              ],
              [
                56.17926735777497,
                26.890732039247382
              ],
              [
                56.14905495543122,
                26.88093323021845
              ],
              [
                56.09240670103669,
                26.86807100413117
              ],
              [
                56.08588356871247,
                26.85091909363116
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                58.8808986007349,
                23.286656126906074
              ],
              [
                58.84999955288334,
                23.26047907625066
              ],
              [
                58.91282761684818,
                23.145389776923388
              ],
              [
                58.998658305324746,
                23.026006345121136
              ],
              [
                59.09211319467319,
                22.93515050058874
              ],
              [
                59.15528458139194,
                22.79754163372475
              ],
              [
                59.299788948877136,
                22.66433071791857
              ],
              [
                59.41377210317401,
                22.644053332958528
              ],
              [
                59.45104154109515,
                22.70654407001813
              ],
              [
                59.172778449054135,
                23.001717547602844
              ],
              [
                59.10892041682757,
                23.051956360917263
              ],
              [
                59.08883603572406,
                23.090828203092506
              ],
              [
                59.06274010104672,
                23.105992838327836
              ],
              [
                59.028407825656096,
                23.144828350556505
              ],
              [
                59.025661243624846,
                23.169134288458594
              ],
              [
                59.01422991000659,
                23.21934266183283
              ],
              [
                58.961245779523864,
                23.261087353607007
              ],
              [
                58.94716954661371,
                23.29167916358707
              ],
              [
                58.941161182768056,
                23.300430593624878
              ],
              [
                58.91249394846918,
                23.28836801817885
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                58.77549851528568,
                23.38122902313377
              ],
              [
                58.894288188137246,
                23.31125155624315
              ],
              [
                58.92106736294193,
                23.33647291248088
              ],
              [
                58.80605424038334,
                23.4580985877912
              ],
              [
                58.77412522427006,
                23.452429408879038
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                59.53254740236459,
                22.591420992740396
              ],
              [
                59.514007973653655,
                22.56986474603492
              ],
              [
                59.710045266134124,
                22.52166800758865
              ],
              [
                59.72583811281381,
                22.52198514638088
              ],
              [
                59.73888437746225,
                22.527217831356396
              ],
              [
                59.73836939333139,
                22.54291469690007
              ],
              [
                59.74317591188608,
                22.55892683154896
              ],
              [
                59.672794747335296,
                22.569706231731782
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                59.77406094746622,
                22.551013205341416
              ],
              [
                59.77680752949747,
                22.53198758835714
              ],
              [
                59.74934170918497,
                22.530084882455988
              ],
              [
                59.80015347676309,
                22.44126281657676
              ],
              [
                59.767881137895905,
                22.37905350061665
              ],
              [
                59.77200101094278,
                22.245432688551492
              ],
              [
                59.58698208105239,
                22.032867982965925
              ],
              [
                59.482706465313676,
                21.822569571544758
              ],
              [
                59.345660173436684,
                21.59145065044996
              ],
              [
                58.47636696054606,
                20.843179641841637
              ],
              [
                58.48586268017575,
                20.479549565946396
              ],
              [
                58.5600203950195,
                20.46411084838433
              ],
              [
                58.597099252441375,
                20.449957326705732
              ],
              [
                58.684989877441375,
                20.474403499326403
              ],
              [
                58.72756189892575,
                20.514280998880107
              ],
              [
                58.708335824707,
                20.642847247445207
              ],
              [
                58.726188607910125,
                20.70837425617679
              ],
              [
                58.76052088330075,
                20.759748177212025
              ],
              [
                58.939048715332,
                20.776440944945886
              ],
              [
                59.031059213378875,
                20.78928028015811
              ],
              [
                59.323385481462736,
                20.864436134770813
              ],
              [
                59.642173715332,
                21.152378748485663
              ],
              [
                59.643932315008236,
                21.331231973284275
              ],
              [
                59.68060515986131,
                21.64805711872058
              ],
              [
                59.932909784200476,
                22.12358905078204
              ],
              [
                60.061999139669226,
                22.587165808151838
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.270146934479236,
                26.575706368931286
              ],
              [
                55.266885368317126,
                26.57555284450449
              ],
              [
                55.26774367520189,
                26.568644032330294
              ],
              [
                55.269202796905994,
                26.564114696037556
              ],
              [
                55.271176902740955,
                26.560659997163164
              ],
              [
                55.271691886871814,
                26.558126485137663
              ],
              [
                55.27220687100267,
                26.554901934298847
              ],
              [
                55.27435263821459,
                26.550525613088727
              ],
              [
                55.27735671231127,
                26.545688432154712
              ],
              [
                55.28156241604662,
                26.540620690442378
              ],
              [
                55.28482398220873,
                26.539161753595913
              ],
              [
                55.28757056423998,
                26.53777958578443
              ],
              [
                55.29417952725267,
                26.536934919480053
              ],
              [
                55.29349288174486,
                26.538624245870167
              ],
              [
                55.2805324477849,
                26.54998815861661
              ],
              [
                55.27109107205248,
                26.57156113718207
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                53.860015049243856,
                26.268380374756518
              ],
              [
                54.041289463306356,
                26.435739626993815
              ],
              [
                53.85864175822823,
                26.51687068589096
              ],
              [
                53.90808023479073,
                26.575839121947414
              ],
              [
                54.04540933635323,
                26.6360047683084
              ],
              [
                53.892974033618856,
                26.694911836774143
              ],
              [
                53.77075113322823,
                26.694911836774143
              ],
              [
                53.63891519572823,
                26.627411613842796
              ],
              [
                53.670500889087606,
                26.514413009914932
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                54.19921793010323,
                26.46647782011556
              ],
              [
                54.477996006275106,
                26.387771672508798
              ],
              [
                54.55078043010323,
                26.47631230878171
              ],
              [
                54.337920322681356,
                26.61513455797104
              ],
              [
                54.28985513713448,
                26.624956308156744
              ],
              [
                54.222563877368856,
                26.65318913806514
              ],
              [
                54.192351475025106,
                26.64336981484792
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        }
      ],
      "coordinates": []
    }),
    ORFtoBRS = 
    /* color: #36ffed */
    /* shown: false */
    ee.Geometry.MultiPolygon(
        [[[[51.77273766018589, 24.29178526171062],
           [51.770849385039405, 24.267531201207312],
           [51.760640429114616, 24.186849982898423],
           [51.75652055606774, 24.140020404289505],
           [51.769395159339226, 24.08641704081955],
           [51.78072481021813, 24.07168498582465],
           [51.79445772037438, 24.07168498582465],
           [51.80698900089196, 24.115562712283538],
           [51.80026429190814, 24.16887024739209],
           [51.798490444492664, 24.211462146707806],
           [51.81823150284227, 24.270463089360284],
           [51.789220730137195, 24.303634454223484]]],
         [[[51.75214002722632, 24.26103601933793],
           [51.767932873906005, 24.29796482779642],
           [51.78539622150177, 24.30633528738777],
           [51.794144370104696, 24.306469316329608],
           [51.89378428728974, 24.220404328766293],
           [52.01261308062332, 24.263226384174608],
           [52.09366681945927, 24.23360822690431],
           [52.13296733848555, 24.329001837212534],
           [52.07551434729474, 24.460062948324587],
           [51.89846253462271, 24.460996296700205],
           [51.84827039832007, 24.58738818904517],
           [51.722584346980355, 24.636748659770458],
           [51.60794447058569, 24.524934052371556],
           [51.58322523230444, 24.460573804154443],
           [51.52554700964819, 24.464948844437004],
           [51.45619581335913, 24.498694044812847],
           [51.48297498816382, 24.386174883911686],
           [51.39371107214819, 24.367411933535394],
           [51.36941142254283, 24.441558844457035],
           [51.41273285089433, 24.436622653154505],
           [51.405561764442716, 24.479859198067164],
           [51.42139640147894, 24.48965429068887],
           [51.43319945495137, 24.50663404098585],
           [51.48106123799408, 24.531105270324776],
           [51.54486393754061, 24.555834335063093],
           [51.591618212911435, 24.55964281693819],
           [51.56349810800699, 24.612439507589297],
           [51.51063570107078, 24.621036135212144],
           [51.45159958898675, 24.645625424514584],
           [51.407656619113006, 24.652721907274405],
           [51.44382317304597, 24.573240334901417],
           [51.385044055826846, 24.49911720332539],
           [51.30696115403642, 24.420161940228674],
           [51.28606687614691, 24.351854543843544],
           [51.30135725134741, 24.29874710163808],
           [51.39027784460913, 24.25978400721503],
           [51.66493604773413, 24.158956626062654]]],
         [[[51.453351121742706, 24.726942540455944],
           [51.46227751334427, 24.722888501977337],
           [51.496094804604034, 24.760617136086555],
           [51.48974333365677, 24.783373499874433],
           [51.47669706900833, 24.771372375751127]]],
         [[[51.58270247326407, 24.95291683769488],
           [51.59746535168204, 24.91368991709038],
           [51.66853316174063, 24.92614426031066],
           [51.64621718273673, 24.966300944271243],
           [51.62819285361297, 24.97252735266595],
           [51.600555256467196, 24.967234664839438]]],
         [[[51.63557417736563, 25.008311353067153],
           [51.62321455822501, 24.99462064871224],
           [51.63111098156485, 24.992753616292383],
           [51.66956313000235, 24.972214388209625],
           [51.6832960401586, 24.955095744903765],
           [51.683982685666415, 24.918360443191904],
           [51.697715595822665, 24.904348334382856],
           [51.70973189220938, 24.92022860411103],
           [51.69840224133048, 24.919605886949064],
           [51.69874556408438, 24.947002466633705],
           [51.67677290783438, 25.034132845450465],
           [51.63557417736563, 25.018578380014528]]],
         [[[51.589402599303256, 25.110358095224793],
           [51.61480848309232, 25.041013095968484],
           [51.65017072674466, 25.03541402956135],
           [51.64227430340482, 25.05718674073626],
           [51.6467374992056, 25.103829524086933],
           [51.64467756268216, 25.134914835035172],
           [51.63300458904935, 25.15200838458032],
           [51.63678113934232, 25.154494519639453],
           [51.63540784832669, 25.175624621990483],
           [51.60725538250638, 25.1774888669942]]],
         [[[51.40763052604502, 26.14236311496963],
           [51.21925506289666, 26.248311414584165],
           [50.88554534609978, 26.32465078436525],
           [50.732807969132935, 26.157658873258516],
           [50.67174853646263, 26.175229325571465],
           [50.61613536021825, 26.148013754102475],
           [50.58803178642604, 26.052975195809005],
           [50.54771575625603, 25.90663525547988],
           [50.70772678277158, 25.875277380503135],
           [50.67752083222592, 25.79633769529647],
           [50.72214208724888, 25.787149488173235],
           [50.77227635515372, 25.845945520905236],
           [50.81555434512125, 25.9080396421046],
           [50.99540862734978, 25.857213505877315],
           [51.55433807070916, 25.891810902544247],
           [51.59004363711541, 25.95233194736706]]],
         [[[50.75645599063103, 24.94917441258574],
           [50.81688079531853, 24.711123836464587],
           [50.91163787539666, 24.82584406631577],
           [50.85395965274041, 25.124613615641206],
           [50.82512054141228, 25.400326708018813],
           [51.05034026797478, 25.658082227332596],
           [51.04759368594353, 25.83249487834858],
           [50.85121307070916, 25.888104523342488],
           [50.78385016074947, 25.842080702076405],
           [50.73301458758936, 25.792325057325257],
           [50.61500701602166, 25.696450218812327],
           [50.63011321719353, 25.475975833995207],
           [50.66307220156853, 25.213721717214664],
           [50.71800384219353, 25.032188930552106],
           [50.73173675234978, 25.003566737675133]]],
         [[[50.35781802616229, 26.218479830706446],
           [50.41961612186542, 26.150083682174603],
           [50.60089053592792, 26.14638544973296],
           [50.68054141483417, 26.179665321646315],
           [50.73547305545917, 26.17720047165038],
           [50.718306917763854, 26.323768207336396],
           [50.69496097049823, 26.36930196563441],
           [50.65101565799823, 26.497192637708306],
           [50.54939212284198, 26.580122560425135],
           [50.4448763048387, 26.52653511695614],
           [50.42820813264582, 26.401608279862536],
           [50.39764346561542, 26.331153277289403],
           [50.391463656045104, 26.302225730196486]]],
         [[[49.144277367026355, 27.452779155418334],
           [49.196462425620105, 27.282647167483013],
           [49.29465273323729, 27.200231488107597],
           [49.396486043997946, 27.046435491417757],
           [49.564027547904196, 26.985263558737454],
           [49.80160689360732, 26.85914456146885],
           [49.99936079985732, 26.530946208793242],
           [50.08488598500713, 26.45015371243929],
           [50.19093489653701, 26.3434206856392],
           [50.21179125284325, 26.156881564242344],
           [50.39192483675392, 26.31515948743523],
           [50.36771389340514, 26.36807419573292],
           [50.423707723685446, 26.40739809376876],
           [50.052232503958884, 26.830962827075993],
           [49.86683821684951, 27.04031979696066],
           [49.76521468169326, 27.221813687186806],
           [49.79062056548232, 27.33532625577593],
           [49.563057096444524, 27.406856727406247],
           [49.3859025554289, 27.45865858777626],
           [49.271266550082444, 27.46734720052875]]],
         [[[52.07655329220728, 27.87245653270633],
           [52.036727852754154, 27.795949054828526],
           [52.26332087033228, 27.5843630192069],
           [52.50776667111353, 27.47476134475197],
           [52.577804512910404, 27.341875443936903],
           [52.871688790254154, 27.145302705481036],
           [53.094161934785404, 27.049944041024048],
           [53.313888497285404, 26.972864360285048],
           [53.09553522580103, 26.868784293257022],
           [53.267196602754154, 26.69346868713005],
           [53.605026192597904, 26.590360066949298],
           [53.99092096798853, 26.440441581804922],
           [54.54847712033228, 26.45519633615526],
           [54.821762032441654, 26.43060402900435],
           [54.794296212129154, 26.57807903407775],
           [54.308151192597904, 26.824674406383917],
           [53.508895821504154, 27.05605921100269],
           [52.90602106564478, 27.34919441856344],
           [52.473434395722904, 27.752206293267164],
           [52.174056954316654, 27.85303117298935]]],
         [[[51.90020577404636, 24.09720359865653],
           [51.88372628185886, 23.946681687712502],
           [52.13915841076511, 23.878889415204057],
           [52.17761055920261, 24.102217957874146]]],
         [[[51.856884512942436, 25.22404431004924],
           [51.700329337161186, 24.800916406940566],
           [51.80209822161663, 24.71375419707218],
           [52.139782462161186, 24.636251778072122],
           [52.161755118411186, 25.171854617584753]]],
         [[[52.919811759036186, 24.713621385216754],
           [53.015942130129936, 24.231155849313854],
           [53.705334219973686, 24.08831371127028],
           [53.713573966067436, 24.333802994142868],
           [53.392223868411186, 24.7385690775031]]],
         [[[49.864916890894136, 27.324865868659792],
           [49.94868764284726, 27.332185966583566],
           [49.88551625612851, 27.768073949888397],
           [49.763293355737886, 27.765643635141174]]],
         [[[50.296980083764986, 29.301691686285945],
           [50.351911724389986, 29.275341416110376],
           [50.376630962671236, 29.34599271430982],
           [50.32856577712436, 29.372324741458957]]],
         [[[58.259288088764094, 20.410230600322567],
           [58.17277075477972, 20.444977713977924],
           [58.15629126259222, 20.393497710717504],
           [58.237315432514094, 20.302078363224634],
           [58.28263403602972, 20.217048568261216],
           [58.602610842670344, 20.09715497580447],
           [58.87040259071722, 20.56940379099859],
           [58.88688208290472, 20.67479801734497],
           [59.00223852821722, 20.77755119894786],
           [58.943187014545344, 21.085390399087288],
           [58.88413550087347, 21.12766868967117]]],
         [[[56.0994402624031, 17.931331468338865],
           [56.11317317255935, 17.90225756578985],
           [56.34354274043044, 17.91075155855223],
           [56.320540115918725, 17.928718278985418],
           [56.240889237012475, 17.95582824224969]]],
         [[[55.67235131163239, 26.688306562443753],
           [55.70084710020661, 26.647502018678246],
           [55.781871270128484, 26.670207099901422],
           [55.82993645567536, 26.702722722014915],
           [55.87285179991364, 26.724803513404527],
           [55.919200371690984, 26.678490261340453],
           [55.97722191710114, 26.679717345201194],
           [55.99850792784333, 26.717443725447534],
           [55.956622551866765, 26.751785329785278],
           [55.746852349230046, 26.725416807584544]]],
         [[[56.15051781660733, 26.887638768502015],
           [56.176953668658115, 26.87600226969277],
           [56.31393944746671, 26.916112512836378],
           [56.270337457720615, 26.95039394037942],
           [56.165092374916995, 26.93127324491856]]],
         [[[60.160838587499796, 25.402725432338656],
           [60.05784176132792, 25.310892487580297],
           [60.39567135117167, 25.19413940311367],
           [60.65385006210917, 25.29723569270823],
           [60.627757532812296, 25.50812301799181],
           [60.35721920273417, 25.484571569174737]]]]),
    ORFtoDeep = 
    /* color: #0b4a8b */
    /* shown: false */
    ee.Geometry.MultiPolygon(
        [[[[51.41901884635208, 24.65316958356075],
           [51.43034849723099, 24.645368622754415],
           [51.47515211661575, 24.637099072241213],
           [51.503304582436066, 24.660190031529556],
           [51.46244917472122, 24.680469107053923],
           [51.47000227530716, 24.71696313123507],
           [51.44768629630325, 24.722888501977337]]],
         [[[51.575836018185946, 25.034132845450465],
           [51.59574873791251, 24.99617648739661],
           [51.61840803967032, 25.00053273092242],
           [51.63523085461173, 25.014845014993966],
           [51.634544209103915, 25.01888948864188],
           [51.686729267697665, 25.039420914549634],
           [51.69737227306876, 25.11063208149619],
           [51.65068037853751, 25.167001445398732],
           [51.63488753185782, 25.15115309127377],
           [51.647247150998446, 25.135613490793933],
           [51.64759047375235, 25.095201276075173],
           [51.644500568967196, 25.070947536485527],
           [51.65239699230704, 25.031758272230036],
           [51.63866408215079, 25.038290686197904]]],
         [[[55.87696711787185, 17.89212958123853],
           [55.85173073895053, 17.89393473147665],
           [55.824349920545785, 17.892873698480184],
           [55.79246408373132, 17.893974151664505],
           [55.77823836773637, 17.89550263157629],
           [55.76264064082107, 17.878733617178618],
           [55.92331568964919, 17.859454725158947],
           [56.06613795527419, 17.861088610664282],
           [56.10768000849685, 17.90160416487975],
           [56.097037003125756, 17.94733641140535],
           [55.908552811231225, 17.936884367654677]]],
         [[[55.327554301898445, 17.47605051585878],
           [55.26747281996485, 17.455909636735957],
           [55.272107677142586, 17.4180780675799],
           [55.300088481585945, 17.389412568698358],
           [55.323091106097664, 17.38728295231231],
           [55.33922727553126, 17.439860838388036]]],
         [[[61.773401039775756, 25.003096439960025],
           [61.790138024028685, 25.002396354417385],
           [61.79005219334021, 25.020208401250944],
           [61.774173515972045, 25.021997241338507]]]]),
    ORFtoRS = /* color: #87b484 */ee.Geometry({
      "type": "GeometryCollection",
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                54.390295827379994,
                26.34919950630454
              ],
              [
                54.35047038792687,
                26.036202465624427
              ],
              [
                54.154089772692494,
                25.1518976250675
              ],
              [
                55.181311452379994,
                25.68648345160387
              ],
              [
                55.04810222386437,
                26.06951371167765
              ],
              [
                55.41308419201511,
                26.215165942100818
              ],
              [
                55.37875191662449,
                26.295220726631964
              ],
              [
                54.55615059826511,
                26.36783802208935
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                51.85084595115044,
                24.16039216911532
              ],
              [
                51.9311834755645,
                24.137836264368065
              ],
              [
                52.02868713767388,
                24.139716075142534
              ],
              [
                52.0630194130645,
                24.19609753886036
              ],
              [
                52.02731384665825,
                24.26935618140448
              ],
              [
                51.84741272361138,
                24.244315235260764
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                52.22094787986138,
                24.4013654329691
              ],
              [
                52.605774561253476,
                24.23353010134467
              ],
              [
                52.70893125843294,
                24.309614875151237
              ],
              [
                52.68031372458794,
                24.443254256911718
              ],
              [
                52.89218684891928,
                24.755537282557118
              ],
              [
                53.19564115238927,
                24.90021467630461
              ],
              [
                52.91325216377854,
                25.210528586521672
              ],
              [
                52.19348205954888,
                25.08607674305352
              ],
              [
                52.25116028220513,
                24.560718685686318
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                50.25440806228061,
                29.18306198138061
              ],
              [
                50.349165142358736,
                29.144687639240477
              ],
              [
                50.38075083571811,
                29.253777049502116
              ],
              [
                50.247541607202486,
                29.308876943726922
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                56.06159828588863,
                23.794603761741108
              ],
              [
                57.84138344213863,
                23.522904571613978
              ],
              [
                58.93841739786469,
                22.83209653117801
              ],
              [
                59.39489629094935,
                21.980483408589823
              ],
              [
                58.687067599472556,
                21.193588462998886
              ],
              [
                58.888512752689124,
                21.130649069947474
              ],
              [
                58.911587668923445,
                21.102330685785194
              ],
              [
                58.934658558023706,
                21.104756304793764
              ],
              [
                59.418381709002695,
                21.16371714906583
              ],
              [
                60.01353632900316,
                22.154173836658074
              ],
              [
                59.93197098534298,
                22.630268928758248
              ],
              [
                59.32047950217897,
                23.17659281110642
              ],
              [
                58.26424934177559,
                23.941590469126655
              ],
              [
                57.58732322720001,
                24.69131327618109
              ],
              [
                56.96247719213863,
                25.858442839442162
              ],
              [
                55.97370766088863,
                25.91774583883118
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                58.95280005165472,
                20.70211845439566
              ],
              [
                58.89786841102972,
                20.731661809765278
              ],
              [
                57.971343212356814,
                20.39973630377408
              ],
              [
                58.62321020790472,
                20.113919828790422
              ],
              [
                58.91984106727972,
                20.28662186620867
              ],
              [
                58.992603157024185,
                20.527812926624055
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.60346560492301,
                17.415932713773167
              ],
              [
                56.43692652949294,
                17.396466334257653
              ],
              [
                56.39847438105544,
                17.626963924185922
              ],
              [
                55.56626002558669,
                17.502583946840712
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.135938781042114,
                17.14146411293341
              ],
              [
                54.99603475882532,
                17.020858480161756
              ],
              [
                55.02384390189172,
                16.966519497386237
              ],
              [
                55.20151342703821,
                17.12866885084433
              ],
              [
                55.216704506825174,
                17.179478688559847
              ],
              [
                55.27819113169785,
                17.230897902812895
              ],
              [
                55.289864105330665,
                17.31055868232026
              ],
              [
                55.259651702986915,
                17.328093663066067
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                53.4397901023239,
                16.773034783558817
              ],
              [
                53.44871649392546,
                16.719117684764882
              ],
              [
                53.59771856912077,
                16.69741503563469
              ],
              [
                53.6155713523239,
                16.78223861517633
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                52.70886377271069,
                16.568122666302102
              ],
              [
                52.76516870435132,
                16.423278254460715
              ],
              [
                53.31860498364819,
                16.657608455881803
              ],
              [
                53.24719385083569,
                16.77598122751927
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                54.705048465219306,
                17.009413493685308
              ],
              [
                54.644623660531806,
                16.94571156718183
              ],
              [
                54.78881921717243,
                16.838617482011216
              ],
              [
                54.954300784555244,
                16.964758738471744
              ],
              [
                54.913102054086494,
                17.02582800845095
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                57.681033192468796,
                18.993263044474578
              ],
              [
                57.86093431551567,
                18.841266477884986
              ],
              [
                57.95431810457817,
                19.0737520854965
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                49.87292435952546,
                27.222258029508914
              ],
              [
                49.94158891030671,
                27.00222847872514
              ],
              [
                50.16818192788484,
                26.803832952676682
              ],
              [
                50.67904618569734,
                26.92389165853476
              ],
              [
                50.37966874429109,
                27.109852530984746
              ],
              [
                50.118184352105295,
                27.21148017185095
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.86735863585114,
                26.690544788096677
              ],
              [
                55.82238335508942,
                26.618438063955466
              ],
              [
                55.86358208555817,
                26.579973766585958
              ],
              [
                55.95078606505036,
                26.618346983972625
              ],
              [
                55.91199059385895,
                26.68186471018108
              ],
              [
                55.901690911241765,
                26.69076050564173
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                56.358228082720615,
                26.91488798343322
              ],
              [
                56.26312767988858,
                26.82331682512376
              ],
              [
                56.31634270674405,
                26.786851503239504
              ],
              [
                56.459851617876865,
                26.822091290493912
              ],
              [
                56.45195519453702,
                26.89804935704902
              ]
            ]
          ],
          "evenOdd": true
        }
      ],
      "coordinates": []
    }),
    TRFtoIRF = 
    /* color: #00ffff */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[55.22549108897324, 17.298430707762567],
          [55.25072531138535, 17.24614015761932],
          [55.283855957137305, 17.31055868232026],
          [55.26394323741074, 17.32366910616906]]]),
    DLtoBRS = /* color: #d63000 */ee.Geometry.Polygon(
        [[[54.01794351604073, 26.617590074626943],
          [54.598845615650106, 26.39269238048438],
          [54.612578525806356, 26.590576491598174],
          [54.381865635181356, 26.764824443237757],
          [54.09759439494698, 26.750109570565517]]]),
    garbage = /* color: #d6aa45 */ee.Geometry.MultiPolygon(
        [[[[50.334099606275075, 29.18273198635301],
           [50.31624682307195, 29.111667962027717],
           [50.37186510920476, 29.10986823502506],
           [50.391777828931325, 29.185429651182424]]],
         [[[53.804492938820886, 16.784724960937172],
           [53.387012470070886, 16.500520375751748],
           [53.97684096128182, 16.49788688785487],
           [54.191761005227136, 16.652543313938367],
           [54.17184828550057, 16.840595055798502],
           [53.87247084409432, 16.839280654528118]]],
         [[[56.388921317261946, 17.823421057929885],
           [56.51114421765257, 17.568300547082803],
           [57.12637859265257, 17.564372791312245],
           [57.039861258668196, 18.11472696904779],
           [56.682805594605696, 18.132999165645163]]],
         [[[56.995617716626136, 18.41846727222494],
           [57.77976688654801, 18.39110329197758],
           [57.849804728344886, 18.836200362561886],
           [57.176892130688636, 18.80890349970603]]],
         [[[57.92873703559008, 23.849367470586113],
           [57.97405563910571, 23.818905215459875],
           [57.97989212592211, 23.830211629579225],
           [57.9682191522893, 23.83774869158596],
           [57.947619787054926, 23.855019472996954]]],
         [[[52.58422094184914, 24.85174143816804],
           [52.5821610053257, 24.738916054082992],
           [52.68790441352883, 24.80188652275486],
           [52.66387182075539, 24.886627930732203]]],
         [[[51.37847143013039, 24.44796678564346],
           [51.38602453071633, 24.421710727399013],
           [51.41623693306008, 24.44359115560618]]],
         [[[51.66534219372985, 24.75438231618104],
           [51.743619781620474, 24.670798487607065],
           [51.771085601932974, 24.68639674240173],
           [51.6845682679486, 24.801139794706557]]],
         [[[51.44389901746032, 24.67360631746462],
           [51.44115243542907, 24.665806634023017],
           [51.433942657597036, 24.649269692598914],
           [51.44939218152282, 24.64646131513737],
           [51.4593485413861, 24.644276977890165],
           [51.47960458386657, 24.62399202215631],
           [51.50295053113219, 24.67267038120194]]],
         [[[51.707914215214224, 25.077186111278277],
           [51.691434723026724, 24.976393550097225],
           [51.700361114628286, 24.92534356852304],
           [51.76421914685485, 24.9222300804193],
           [51.829450470097036, 24.936551474639344],
           [51.817777496464224, 25.007511195736758],
           [51.7504862366986, 25.00813346828344],
           [51.727826934940786, 25.079673768716148]]],
         [[[52.0635965882611, 25.218901804929555],
           [52.16590676892516, 25.12941629769279],
           [52.221525055057974, 25.225113635802497]]],
         [[[49.590630296926825, 27.911162250906205],
           [49.69980693266901, 27.80978405092311],
           [49.82477641509089, 27.933003804151838],
           [49.6771476309112, 27.929363851724396],
           [49.65792155669245, 27.960906032159237]]]]),
    benthic = ee.Image("projects/coral_atlas/nw_arabian_sea/in_out/nw_arabian_sea_benthic_clean2b");
/***** End of imports. If edited, may not auto-convert in the playground. *****/
///////////////////////////////
// Global coral atlas project - Red Sea and Gulf of Aden
// Contact: mitchell.lyons@gmail.com
// Region coordinator: Chris Roelfsema
// Description:
// - Developing a process to combine OBIA and supervised classification
// - This script loads the raw classification data (from *_classification script)
// - Then applied some cleanup and object-based relational rules
///////////////////////////////

// Table of contents
// 1. Setting constants 
// 2. Data loads & vis
// 3. OBIA clean up rules 
// 4. Export

// Load and libraries needed
var map_palettes = require('users/mitchest/global_reefs_modules:colour_pals');
var param_module = require('users/mitchest/global_reefs_modules:reef_params');
var pkg_vis = require('users/mitchest/global_reefs_modules:pkg_vis');

// ###########################################
// SENSOR GENERICS
var sensor_params = param_module.dove;         //<------------ THIS IS WHERE YOU CHOOSE THE SENSOR
// REGION AND SENSOR SPECIFIC LOAD PATHS
var region_params = param_module.nw_arabian_sea;  //<------------ THIS IS WHERE YOU CHOOSE THE REGION
//  ^^ all the data paths are in this module ^^
// ###########################################

// 1. Setting constants

// These will get written to the asset metadata 

var vars = {
  
  // analysis type
  geomorphic: false, // map geomorphic zonation (when set to true) or benthic habitat (when set to false)

  // analysis parameters
  image_data_scale: sensor_params.pixel,
  small_object_geo: ee.Number(400).int(), // smallest object szie in pixels (geomorphic)
  small_object_benthic: ee.Number(130).int(), // smallest object szie in pixels (benthic)
  smooth_radius: ee.Number(1), // radius in pixels for initial smooth 
  dist_to_land_ORF: 1250, //distance to land in meters to convert terrestrial reef flat to ORF
  dist_to_land_RC: 500, //distance to land in meters to convert reef crest to TRF
  wave_height: 0.6, //cut off height for waves in metres, Hs95 threshold
  geo_depth_cutoff: 1250, //depth in centimetres
  shallowlag_depth_cutoff: 500, //depth in centimetres
  benthic_depth_cutoff: 800, //depth in centimetres
  turbid1_depth_cutoff: 500,//depth in centimeters to be combined with depth5m_mask Code introduced CR
  turbid2_depth_cutoff: 800,//depth in centimeters to be combined with depth8m_mask Code introduced CR
  
  //############
  // Clean-up stage selection
  cleanup_stage: 2, // set to 1, 2 or 3
  geo_refinement: false, // set to true to apply the refinement_mask (the other stage 3 masks will still run)
  
  // should the global extent + depth cleanup be applied?
  global_extent_clean: true,
  global_depth_thresh: 500, // this is the depth limit for ADDING to the global extent (i.e. 5 = everything <5m will be added to the global extent layer)
  
  /*
  - GEOMORPHIC 1: The first pass does a small object filter, just to generally clean noise and reduce the amount of cleaning needed
  -            2: The second pass runs the OBIA cleanup rules
  -            3: The third pass is the MANUAL cleanup stage, which includes AT LEAST the no_reef masking
                        - see below where it starts/ends (only that section is run)
                        - please put region specific stuff in here ONLY

  - BENTHIC 1: This is the main benthic stge - it does noise removal, no data reclaim and OBIA rules - review those if needed
            2: The second mas is the MANUAL stage - it's optional, but shuold include ALL region specific stuff
                        - see below where it starts/ends (only that section is run)
                        - please put region specific stuff in here ONLY
  */
  
  // DON'T TOUCH --->
  obia_2nd_pass: null,
  obia_clean: null, // run object-based relationship rules + small object clean up
  fast_clean: null, // run a faster (but less precise) version of the OBIA clean; only applies to geomorphic (`obia_clean: true` also)
  manual_clean: false, // apply manual touch ups
  // --------------<
  //############
  
  reproject_display: true,
  
  // export options
  do_export: true, // export the results?
  geomorph_output_name: region_params.sname + '_geo_clean', // DO NOT CHANGE - change in the pop up dialouge if you must
  benthic_output_name: region_params.sname + '_benthic_clean', // DO NOT CHANGE - change in the pop up dialouge if you must
  asset_output: region_params.asset // asset path

};


// Clean up stage auto-parameterisation (DON'T TOUCH) --->

if (vars.geomorphic) {
  var temp_outname = vars.geomorph_output_name;
  if (vars.cleanup_stage == 1) {
    vars.obia_2nd_pass = false;
    vars.obia_clean = false;
    vars.fast_clean = true;
    vars.manual_clean = false;
    vars.geomorph_output_name = temp_outname + '1';
  } else if (vars.cleanup_stage == 2) {
    vars.obia_2nd_pass = true;
    vars.obia_clean = true;
    vars.fast_clean = true;
    vars.manual_clean = false;
    vars.geomorph_output_name = temp_outname + '2';
  } else if (vars.cleanup_stage == 3) {
    vars.manual_clean = true;
    vars.obia_2nd_pass = false;
    vars.obia_clean = false;
    vars.fast_clean = false;
    vars.do_export = false;
    vars.geomorph_output_name = temp_outname + '3FINAL';
  }
}

if (!vars.geomorphic) {
  var temp_outname = vars.benthic_output_name;
  if (vars.cleanup_stage == 1) {
    vars.obia_2nd_pass = true,
    vars.obia_clean = true, 
    vars.fast_clean = false, 
    vars.manual_clean = false;
    vars.benthic_output_name = temp_outname + '1';
  } else if (vars.cleanup_stage == 2) {
    vars.manual_clean = true;
    vars.obia_2nd_pass = false,
    vars.obia_clean = false, 
    vars.fast_clean = false,
    vars.do_export = false;
    vars.benthic_output_name = temp_outname + '2FINAL';
  }
}

//Region extent is created in map viewer and exported to GEE asset
var region_extent = ee.FeatureCollection(region_params.extent_mask).geometry();
Map.addLayer(region_extent, {}, "Manual reef outline", false);
// -----------------------------------------<

//################################################################################################
//START OF CLEAN 3 - Manual Cleanup
//Review everything in this section
//This is the section to add/remove manual cleanups
//You MUST review it for each region

//###############################################################################################

if (vars.manual_clean && vars.geomorphic) {
  
  print("Doing GEOMORPHIC manual clean ups - make sure this is what you want to do");
  print("Export the manual map, check 'manual' layer in the viewer for effects");
  
  //var depth = ee.Image(region_params.segments).select('depth');// replace pixel with segments
  
  // define the manually edited map - uses the output from the second pass of cleaning
  var man_geo = ee.Image(region_params.geo_map_clean3);
  
  /*
   // the "GLOBAL MASK" clean
  // currently uses GCRMN extent + bathymetry threhold < vars.global_depth_thresh
  if (vars.global_extent_clean) {
    var blanket_mask = ee.Image([param_module.global_extent_mask.gcrmn]).unmask(0, false)
              .eq(1) // extent according to global extent layer
              .add(depth.lt(vars.global_depth_thresh)) // combine with areas less than depth thrshold
              .eq(0) // get leftovers
              .selfMask().connectedPixelCount(25, true).gte(25);
    
    man_geo = man_geo.where({
      test: blanket_mask.eq(1),
      value: ee.Image(0)
    });
  }
  */
  /*
  // import the mid mask from asset ****only use ee.FC if mid_mask created in map viewer****
  var mid_mask = ee.FeatureCollection(region_params.mid_mask).geometry();
  var midmask = ee.Image().byte().paint(ee.Feature(mid_mask.dissolve(),{zone: 1}), "zone").clip(mid_mask.dissolve());
  
  // the "MID MASK" CLEAN
  man_geo = man_geo.where({
    test: midmask.eq(1),
    value: ee.Image(0)
  });
  */
  
 //START**************************************************************************************************************************START
 //************************************* START clean up deep water using reef extent  *******************************START
 //*******************************************************************************************************************************START
 // Masking out all the areas that fall outside GCRMN_ext (the reef extent globally) or areas deeper then treshold depth
 // no additional mask are needed
 //*******************************************************************************************************************************START
 //***********Intergrating global mask to get out reefs to deep imagery to bad to get out using GCRMN_ext_mask created in viewer 
 /*
 var GCRMNext = ee.Image(GCRMN_ext).unmask(0,false);//to take care GCRMN_ext has 1 for reef and 0 for no reef

 // START-ALL REEF EXTENT *****Maps areas that fall within GCRMN reef ext and < 5 m (turbid1_depth_cutoff)*************START
 
  man_geo = man_geo.where({
    test:  (GCRMNext.eq(1).add(depth.lt(vars.turbid1_depth_cutoff)).eq(0)),
    value: ee.Image(0)
  });
  */
 // END-ALL REEF EXTENT *****Maps areas that fall within GCRMN reef ext and < 5 m (turbid1_depth_cutoff)*************START*/
 /*
// import the depth8m_mask from asset ****only use ee.FC if depth8m_mask created in map viewer****
  
  var turbiddeep_mask = ee.FeatureCollection(region_params.depth8m_mask).geometry();
  var turbiddeepmask = ee.Image().byte().paint(ee.Feature(turbiddeep_mask.dissolve(),{zone: 1}), "zone").clip(turbiddeep_mask.dissolve());
  
  // the "turdbid MASK" applied to areas deeper then 8 m
  man_geo = man_geo.where({
    test: (turbiddeepmask.eq(1).and(GCRMNextmask.neq(1)))
                           .and(depth.gt(vars.turbid2_depth_cutoff)),
                         //.and ((GCRMNextmask.eq(0).add(depth.gt(vars.turbid2_depth_cutoff))).eq(1)),
    value: ee.Image(0)
  });
  
   // import the depth5m_mask from asset ****only use ee.FC if depth5m_mask created in map viewer****
  
  var turbid_mask = ee.FeatureCollection(region_params.depth5m_mask).geometry();
  var turbidmask = ee.Image().byte().paint(ee.Feature(turbid_mask.dissolve(),{zone: 1}), "zone").clip(turbid_mask.dissolve());
  
  // the "turdbid MASK" applied to areas deeper then 5 m
  man_geo = man_geo.where({
    test: (turbidmask.eq(1).and (GCRMNextmask.eq(0)))
                     .and(depth.gt(vars.turbid1_depth_cutoff)),
                     //.and ((GCRMNextmask.eq(0).add(depth.gt(vars.turbid1_depth_cutoff))).eq(0)),
    value: ee.Image(0)
  });
  */

/*
  //************************************* clean up small groups of  pixesl in deep water Chris RSAG ************************************
  
var man_geo = man_geo.where({
   test:man_geo.eq(22)// Reef Slope pixels
    .connectedPixelCount(25,false).lt(25),//selects group of pixel that are RS and neighbouring each other, with groups smaller then 25
   value: ee.Image(0) // change those selected no class
  });
   var man_geo = man_geo.where({
    test:man_geo.eq(12)// Deep Lagoon pixels
    .connectedPixelCount(25,false).lt(25),//selects group of pixel that are Deep Lagoon and neighbouring each other, with groups smaller then 25
    value: ee.Image(0) // change those selected no class
  });
     var man_geo = man_geo.where({
    test:man_geo.eq(23)// Plateau pixels
    .connectedPixelCount(25,false).lt(25),//selects group of pixel that are Plateau and neighbouring each other, with groups smaller then 25
    value: ee.Image(0) // change those selected no class
  });
  
 //************************************* END flean up small groups of pixesl in deep water Chris RSAG ************************************
 //************************************* END Import AND APPLY 5m and 8 m mask Chris RSAG************************************START
 //*************************************************************************************************************************START 
 */
 
// Manual additions for NAS
/*
var MidMask = ee.Image().byte().paint(ee.Feature(mid_mask, {zone: 1}), "zone").clip(mid_mask);
  
  man_geo = man_geo.where({
    test:  MidMask.eq(1),
    value: ee.Image(0)
  });
  
 // TRF to IRF
var TRFIRF = ee.Image().byte().paint(ee.Feature(TRFtoIRF, {zone: 1}), "zone").clip(TRFtoIRF);
  
  man_geo = man_geo.where({
    test:  TRFIRF.eq(1)
                .and(man_geo.eq(16)), //TRF
    value: ee.Image(13)//IRF
  });

// ORF to Deep
var ORFDeep = ee.Image().byte().paint(ee.Feature(ORFtoDeep, {zone: 1}), "zone").clip(ORFtoDeep);
  
  man_geo = man_geo.where({
    test:  ORFDeep.eq(1)
                .and(man_geo.eq(14)), //ORF
    value: ee.Image(2)//Deep
  });

// ORFto BRS
var ORFBRS = ee.Image().byte().paint(ee.Feature(ORFtoBRS, {zone: 1}), "zone").clip(ORFtoBRS);
  
  man_geo = man_geo.where({
    test:  ORFBRS.eq(1)
                .and(man_geo.eq(14)), //ORF
    value: ee.Image(24)//BRS
  });
  */
  // Cleanup phantom reefs
var crap = ee.Image().byte().paint(ee.Feature(garbage, {zone: 1}), "zone").clip(garbage);
  
  man_geo = man_geo.where({
    test:  crap.eq(1),
    value: ee.Image(0)
  });
  
/*
// ORF to RS
var ORFRS = ee.Image().byte().paint(ee.Feature(ORFtoRS, {zone: 1}), "zone").clip(ORFtoRS);
  
  man_geo = man_geo.where({
    test:  ORFRS.eq(1)
                .and(man_geo.eq(14)), //ORF
    value: ee.Image(22)//RS
  });

// DL to BRS
var DLBRS = ee.Image().byte().paint(ee.Feature(DLtoBRS, {zone: 1}), "zone").clip(DLtoBRS);
  
  man_geo = man_geo.where({
    test:  DLBRS.eq(1)
                .and(man_geo.eq(12)), //DL
    value: ee.Image(24)//BRS
  });
*/
/* 
 //************************************* START Import AND APPLY Lagoons mask Chris Red Sea ************************************START
  // import the lagoon mask from asset ****only use ee.FC if  lagoons mask created in map viewer****
  var lagoons_mask = ee.FeatureCollection(region_params.Lagoons_mask).geometry();
  var lagoonsmask = ee.Image().byte().paint(ee.Feature(lagoons_mask.dissolve(),{zone: 1}), "zone").clip(lagoons_mask.dissolve());

  
  // RC within Lagoon ORF
man_geo = man_geo.where({
test: lagoonsmask.eq(1)
             .and(man_geo.eq(15)),
  value: ee.Image(14)
});
// Reef slope, sheltered slope (within lagoon mask) -> Back Reef Slope
 man_geo = man_geo.where({
  test: lagoonsmask.eq(1)
                    .and(man_geo.eq(21).or(man_geo.eq(22))),
    value: ee.Image(24)
 });    

 
 //************************************* START Import AND APPLY coast mask Chris Red Sea ************************************START
  // import the coast mask from asset ****only use ee.FC if  coast mask created in map viewer****
  var Coast_mask = ee.FeatureCollection(region_params.Coast_mask).geometry();
  var Coastmask = ee.Image().byte().paint(ee.Feature(Coast_mask.dissolve(),{zone: 1}), "zone").clip(Coast_mask.dissolve());

  
  //Back Reef Slope or Sheltered slope within Coast RS
man_geo = man_geo.where({
test: Coastmask.eq(1)
             .and(man_geo.eq(21).or(man_geo.eq(22))),//
  value: ee.Image(24)
});
    //Deep Lagoon within Coast Deep Water
man_geo = man_geo.where({
test: Coastmask.eq(1)
             .and(man_geo.eq(12)),//
  value: ee.Image(2)
}); 
  //************************************* END IMPORT AND APPLY Lagoons mask Chris Red Sea ************************************END
  
  
  */
  /*
  
  // the "REEF MASK" CLEAN
  
  // Define a kernel for reef mask Morphological Operations
  var kernel_rm = ee.Kernel.circle({radius: vars.smooth_radius.multiply(5)});

  // Create reef mask to clean areas inside the reef - Perform an dilation of deepwater
  var reef_mask = man_geo.eq(2)
            .focal_max({kernel: kernel_rm, iterations: 2});

  // Inner Reef Flat (outside reef mask) -> outer reef flat
  man_geo = man_geo.where({
    test: reef_mask.eq(1)
                    .and(man_geo.eq(13)),
    value: ee.Image(14)
  });
  
  // Reef crest, slope, sheltered slope (within reef mask) -> outer reef flat
  man_geo = man_geo.where({
    test: reef_mask.eq(0)
                    .and(man_geo.eq(15).or(man_geo.eq(21)).or(man_geo.eq(22))),
    value: ee.Image(14)
  });
  
*/
  /*
  // WAVE clean (un-comment this sectio nbased on whether you have waves or not)
  
  var waves = ee.Image(region_params.waves)
  Map.addLayer(waves.lt(vars.wave_height), {}, vars.wave_height + "m Hs95 threshold", false)
  
  man_geo = man_geo.where({
    test: waves.lte(vars.wave_height)
               .and(man_geo.eq(22)),
    value: ee.Image(21)
  })*/
  
  
  
  
  /*
  ##############
  
  The rest of the manual geometry paintings and rules should go here
      - make the geom, paint the layer, use it in a rule
      - consult previous regions *_cleanup script for ideas/hints/existing rules etc.
  e.g. 
  var notreefcrest = ee.Image().byte().paint(ee.Feature(not_reef_crest, {zone: 1}), "zone").clip(not_reef_crest);
  var notdeepwater = ee.Image().byte().paint(ee.Feature(not_deep_water, {zone: 1}), "zone").clip(not_deep_water);
  
  
  // Reef crest -> Inner reef flat (inside the reef)
  man_geo = man_geo.where({
    test: notreefcrest.eq(1)
                     .and(man_geo.eq(15)),
    value: ee.Image(13)
  });
  
  // Deep water -> Deep lagoon (inside the reef)
  man_geo = man_geo.where({
    test: notdeepwater.eq(1)
                     .and(man_geo.eq(2)),
    value: ee.Image(12)
  });
  
  ##############
  */
  
  if (vars.geo_refinement) {
    // make the mask image layer
    var refine = ee.Image().byte().paint(ee.Feature(refinement_mask, {zone: 1}), "zone").clip(refinement_mask);
    // apply
    man_geo = man_geo.where({
      test: refine.eq(1),
      value: ee.Image(0)
    });
  }
  
  man_geo = man_geo.updateMask(man_geo.gt(2)); // this ignores 0/land; make it .gt(2) if you want to mask deep too
  
  // Add data + the manual layer to the map
  var lowtide_image = ee.Image(region_params.image);
  Map.addLayer(lowtide_image, {bands: ['b3','b2','b1'], min:0, max:2000, gamma:1.5}, sensor_params.sname + ' low tide', false);
  var geo_clean1 = ee.Image(region_params.geo_map_clean1);
  Map.addLayer(geo_clean1, map_palettes.geo, 'Geo clean stage 1', false);
  var geo_clean2 = ee.Image(region_params.geo_map_clean2);
  Map.addLayer(geo_clean2, map_palettes.geo, 'Geo clean stage 2', false);
//  Map.addLayer(man_geo.updateMask(man_geo), map_palettes.geo, 'Geo clean stage 3', false);
//Map.addLayer(mid_mask, {color: 'red'}, "mid mask import", false, 0.4);// CR added
//Map.addLayer(lagoons_mask, {color: 'blue'}, "lagoons mask import", true, 0.4);// CR added*/
//Map.addLayer(turbiddeepmask, {color: 'green'}, "turbiddeep import", false, 0.4);// CR added
//Map.addLayer(reef_band_mask, {}, "band(buffer) around lagoon");// CR added*/
//Map.addLayer(ORFtoRS_mask, {}, "ORF_IRF_RCToRS");// CR added*/
var GCRMNext=ee.Image([param_module.global_extent_mask.gcrmn])
Map.addLayer(GCRMNext, {}, "GCRMNextmask");// CR added GCRMN_ext
 Map.addLayer(man_geo.updateMask(man_geo.gt(2)), map_palettes.geo, 'Geo clean stage 3 - no DW', false);
  //Map.addLayer(global_reef_mask.updateMask(global_reef_mask.eq(1)), {palette: ['F8FF23'], opacity: 0.4}, 'global_reef_mask - land', false);
  // Map.addLayer(global_reef_mask.updateMask(global_reef_mask.eq(3)), {palette: ['0000ff'], opacity: 0.4}, 'global_reef_mask - reef', false);
  //Map.addLayer(global_reef_mask.updateMask(global_reef_mask.eq(2)), {palette: ['FF0000'], opacity: 0.4}, 'global_reef_mask - water', false);

  
  
  // Export
  var output_name = (vars.geomorphic) ? vars.geomorph_output_name : vars.benthic_output_name;
  Export.image.toAsset({
    image: man_geo,
    description: output_name,
    assetId: vars.asset_output + 'in_out/' + output_name,
    region: region_extent,
    scale: vars.image_data_scale,
    crs: 'EPSG:4326',
    maxPixels: 1e13,
    pyramidingPolicy: {'.default': 'mode'}
  });
  
} 

if (vars.manual_clean && !vars.geomorphic) {
  
  print("Doing BENTHIC manual clean ups - make sure this is what you want to do");
  print("Export the manual map, check 'manual' layer in the viewer for effects");
  
  //var depth = ee.Image(region_params.segments).select('depth');
  
  // define the final geomorphic map (the manually edited geo map - stage 3)
  var geo_map = ee.Image(region_params.geo_map_clean3);
  
  // define the clean benthic map to apply 2nd stage rules to
  var man_benthic = ee.Image(region_params.benthic_map_clean2mid);
  
    // Cleanup phantom reefs
  var crap = ee.Image().byte().paint(ee.Feature(garbage, {zone: 1}), "zone").clip(garbage);
  
  man_benthic = man_benthic.where({
    test:  crap.eq(1),
    value: ee.Image(0)
  });
  /*
  // extra depth cutoff refinement
  man_benthic = man_benthic.where({
          test: depth.gt(vars.benthic_depth_cutoff),
          value: ee.Image(0)
        });
  */
  /*
  **Generic benthic rules**
    - should be generally applicable, but still review
  */
  /*
  // BMA on inner RF, outer RF,reef crest, reef slope -> rubble 
  man_benthic = man_benthic.where({
    test: man_benthic.eq(18)
                     .and(geo_map.eq(13).or(geo_map.eq(14)).or(geo_map.eq(15)).or(geo_map.eq(22))),
    value: ee.Image(12)
  });
  
  // Rubble on Reef crest -> rock 
  man_benthic = man_benthic.where({
    test: man_benthic.eq(12)
                     .and(geo_map.eq(15)), //(geo_map.eq(14).or
    value: ee.Image(13)
  });
     // Coral/Algae and Seagrass on Deep Lagoon -> Sand
  man_benthic = man_benthic.where({
    test: man_benthic.eq(15)
                     .and(geo_map.eq(12)),
    value: ee.Image(11)
  });
  man_benthic = man_benthic.where({
    test: man_benthic.eq(14)
                     .and(geo_map.eq(12)),
    value: ee.Image(11)
  });
  man_benthic = man_benthic.where({
    test: man_benthic.eq(13)
                     .and((geo_map.eq(12)).or(geo_map.eq(11))),
    value: ee.Image(11)
  });
  // Seagrass on Reef Crest or Outer Reef Flat or reef slope or sheltered slope change to coral/algae or rock -> coral algae
  // Seagrass in generaly does not grow on hard substrate areas.
  
  man_benthic = man_benthic.where({
    test: man_benthic.eq(14)
                     .and(geo_map.eq(15)),
    value: ee.Image(15)
  });  
   // Seagrass on reef slope or sheltered slope change to rock -> rock
  // Seagrass in generaly does not grow on hard substrate areas.
  
  man_benthic = man_benthic.where({
    test: man_benthic.eq(14)
                     .and(geo_map.eq(21).or(geo_map.eq(22))),
    value: ee.Image(13)
  }); 
  // Sand on Reef crest ->  ROCK
  // Sand in generally cannot stay in high energy zone so has to be hard substrate posisble Rock
  man_benthic = man_benthic.where({
    test: man_benthic.eq(11)
                     .and(geo_map.eq(15)),
    value: ee.Image(13)
  });  
  // Sand on Reef slope or sheltered slope -> Rubble CR ADDED
  man_benthic = man_benthic.where({
    test: man_benthic.eq(11)
                     .and((geo_map.eq(21)).or(geo_map.eq(22))),
    value: ee.Image(12)
  });  
  /*
  
  **Manual polygon guided rules**
   - same as per geomorphic clean section
   - add a geometry, paint the layer, create a rule
  
  
  
  
  // final smooth for missing data due to depth
  man_benthic = man_benthic.focal_mode(2)
                           .selfMask()
  */
  
  // Add the manual layer to the map

  var dove_image = ee.Image(region_params.image);
  Map.addLayer(dove_image, {bands: ['b3','b2','b1'], min:0, max:4000, gamma:1.5}, sensor_params.sname + ' low tide', true);
  var benthic_clean1 = ee.Image(region_params.benthic_map_clean1);
  var geo_clean1 = ee.Image(region_params.geo_map_clean1);
  var geo_clean2 = ee.Image(region_params.geo_map_clean2);
  Map.addLayer(GCRMN_ext, {}, "GCRMN_ext");// CR added GCRMN_ext
  Map.addLayer(geo_clean1, map_palettes.geo, 'Geo clean stage 1', false);
  Map.addLayer(geo_clean2.updateMask(geo_clean2.gt(2)), map_palettes.geo, 'Geo clean stage 2', false);
  Map.addLayer(geo_map.updateMask(geo_map.gt(2)), map_palettes.geo, 'Geo clean stage 3 - MANUAL', true);
  Map.addLayer(benthic_clean1, map_palettes.benthic, 'Benthic clean stage 1', false);
  Map.addLayer(man_benthic.reproject({crs:'EPSG:4326', scale: 5}), map_palettes.benthic, 'Benthic clean stage 2 - MANUAL', true);
 
  // Export
  var output_name = (vars.geomorphic) ? vars.geomorph_output_name : vars.benthic_output_name;
  Export.image.toAsset({
    image: man_benthic,
    description: output_name,
    assetId: vars.asset_output + 'in_out/' + output_name,
    region: region_extent,
    scale: vars.image_data_scale,
    crs: 'EPSG:4326',
    maxPixels: 1e13,
    pyramidingPolicy: {'.default': 'mode'}
  });
  
}

// #################################################################################################
// END OF MANUAL SECTION
// #################################################################################################


// 2. Data loads & vis

if (!vars.manual_clean) {

  // load input data
  
  // define raw geo/benthic outputs
  // Run check to see if the region has been split into multiple areas
  
  // geo
  if (ee.List(region_params.geo_map).length().getInfo() > 1) {
    var geo_map_raw = ee.Image(region_params.geo_map[0]).unmask(0, false)
                 .add(ee.Image(region_params.geo_map[1]).unmask(0,false))
                 .selfMask();
  } else {
    var geo_map_raw = ee.Image(region_params.geo_map);
  }
  
  // benthic
  if (ee.List(region_params.benthic_map).length().getInfo() > 1) {
      var benthic_map = ee.Image(region_params.benthic_map[0]).unmask(0, false)
               .add(ee.Image(region_params.benthic_map[1]).unmask(0,false))
               .selfMask();
  } else {
      var benthic_map = ee.Image(region_params.benthic_map);
  }
  
  // set the geo map for further processing
  if (vars.geomorphic && vars.obia_2nd_pass) {
    // if it's 2nd pass, you want to make sure you're loading the latest geo clean map
    var geo_map = ee.Image(region_params.geo_map_clean1);
  } else if (vars.geomorphic) {
    var geo_map = geo_map_raw;
  }
  
  var depth = ee.Image(region_params.pixels).select('depth');
  var low_tide_image = ee.Image(region_params.image);
  
  var display_pal = (vars.geomorphic) ? map_palettes.geo : map_palettes.benthic;
  Map.addLayer(depth, {min:0, max:2500}, 'Depth data', false);
  Map.addLayer(low_tide_image, {bands: ['b3','b2','b1'], min:0, max:3000}, sensor_params.sname + ' low tide', false);
  
  // load for display purposes
  if (vars.geomorphic) {
    Map.addLayer(geo_map_raw, display_pal, 'Geomorphic map RAW', false);
    if (vars.cleanup_stage == 2) Map.addLayer(ee.Image(region_params.geo_map_clean1), display_pal, 'Geo clean stage 1', false);
  }
  if (!vars.geomorphic) {
    // Use the manually cleaned geomorphic map as input for the benthic clean
    var geo_map = ee.Image(region_params.geo_map_clean3);
    Map.addLayer(geo_map.updateMask(geo_map.gt(2)), map_palettes.geo, 'Geo clean stage 3', false);
    Map.addLayer(benthic_map, display_pal, 'Benthic map RAW', false);
  }
  
  // 3. Object-based re-classificaiton and cleaning
  
  /* OUTPUT EXTENT
    - to the mapping extent just so it doesn't balloon out
    - to the 'reef boundary' extent for noise/deep removal
  */  
  var class_extent_mask = geo_map.gt(0);
  
  /*
  
  ########
  Initial small object clean
   - this was originally at the end, but we needed to massively reduce the number of objects to 
     iterate through in the OBIA cleaning, so this happens first now
   - future collabs with google might fix this, but need to change the parallel serialisation of vector procesing
   
   - includes a possible special case for:
        - geomorphic to clean up turbid areas over size threshold; fix shallow vs. deep lagoon
        - benthic to allow breaking waves (temporal class) to grow into surrounding class
  ########
  
  */
  
  // ##############################################################################################
  // START OF CLEAN 1
  // ##############################################################################################
  
  if (vars.geomorphic && !vars.obia_2nd_pass) {
    
    // shallow lagoon > 5m == deep lagoon
    geo_map = geo_map.where({
      test: geo_map.eq(11)
                    .and(depth.gt(vars.shallowlag_depth_cutoff)),
      value: ee.Image(12)
    });
    
    // deep water in depth data == deep (s2 + ls8 data should be good enough for this)
    geo_map = geo_map.where({
      test: depth.gt(vars.geo_depth_cutoff),
      value: ee.Image(2)
    });
   
    // make a smooth map with masked area as a value - *** Change to ee.kernal*** see reef mask in clean 3
    var smooth_map = geo_map
                        .focal_mode({
                          radius: vars.smooth_radius, // relates to smoothness required
                          kernelType: 'circle', units: 'pixels', iterations: 2
                        });
    
    // replace small objects with smooth underneath
    var clean_map = geo_map.where({
      test: geo_map.connectedPixelCount(vars.small_object_geo, false).lt(vars.small_object_geo), 
      value: smooth_map
    }).updateMask(class_extent_mask);
    
    // display distance to land mask for assessing cut-off distances
    var distToLand = ee.Image(region_params.distToLand);
    
    Map.addLayer(distToLand.lte(vars.dist_to_land_RC), {}, 'RC to TRF ' + vars.dist_to_land_RC + 'm', false);
    Map.addLayer(distToLand.unmask(100000, false).lte(vars.dist_to_land_ORF), {}, 'TRF to ORF ' + vars.dist_to_land_ORF + 'm', false);

   // reef crest close to land -> TRF - Not need when using .focal masks (reef mask) as this will take care of RC inside the reef
    clean_map = clean_map.where({
    test: distToLand.lte(vars.dist_to_land_RC)
                     .and(clean_map.eq(15)),
       value: ee.Image(14)
     });
    
    // TRF outside of specified distance from land -> ORF
    clean_map = clean_map.where({
      test: distToLand.unmask(100000, false).gt(vars.dist_to_land_ORF)
                       .and(clean_map.eq(16)),
      value: ee.Image(14)
    });
  }
  
  if (!vars.geomorphic && vars.cleanup_stage == 1) {
   // TRF
    // make a smooth map with masked area as a value, and without temporal class (basically breaking waves)
    var smooth_map = benthic_map
                        .focal_mode({
                          radius: vars.smooth_radius, // relates to smoothness required
                          kernelType: 'circle', units: 'pixels', iterations: 1
                        });
    
    //replace small objects with smooth underneath
    var clean_map = benthic_map.where({
      test: benthic_map.connectedPixelCount(vars.small_object_benthic, false).lt(vars.small_object_benthic),
      value: smooth_map
    }).updateMask(class_extent_mask);
    
  }
  
  // ##############################################################################################
  // START OF CLEAN 2
  // ##############################################################################################
  
  if (vars.geomorphic && vars.obia_2nd_pass) {
    var clean_map = geo_map;
  }
  
  if (vars.obia_clean) {
    
    if (vars.geomorphic && !vars.fast_clean) { 
      
      // FUNCTION that maps over feature colleciton and assigns neighbour percentages
      var set_neighbour_properties = function(f) {
        // make the 1px buffer
        var diff = f.buffer(vars.image_data_scale).difference(f, ee.ErrorMargin(0.5));
        // reduce the classes in the buffer zone
        var diff_classes = ee.Dictionary(
          clean_map.unmask(ee.Image(0)).reduceRegion({
            reducer: ee.Reducer.frequencyHistogram(),
            geometry: diff.geometry(),
            scale: vars.image_data_scale,
            maxPixels: 1e11
          }).get('classification')
        );
        // calculate the percentages
        var diff_sum = diff_classes.toArray().reduce(ee.Reducer.sum(), [0]).get([0]);
        var diff_percs = diff_classes.map(function(k,v){return(ee.Number(v).divide(diff_sum).multiply(100).toUint8())});
        
        /* NOW, we can try to do the class logic right here (see /users/mitchest/global_reefs/obia_dev),
           or we can return the neighbour % and do image logic via (painted) rasters */
        
        return(f.set(diff_percs));
      };
      
      // FUNCTION to reduce the map to vectors and map the neighbour properties function
      var reduce_neighbours = function() {
        // reduce map to vectors
        var map_fc = clean_map
              .updateMask(segment_id).updateMask(clean_map.eq(classn)) // only vectorise class/es of interest
              .reduceToVectors({
                scale: vars.image_data_scale, 
                eightConnected: false,
                bestEffort: true, 
                maxPixels: 1e13,
                tileScale: 1,
                geometry: region_extent
              });
        // map the function, calculate neighbour properties
        return(map_fc.map(set_neighbour_properties));
      };
      
      // first make a make size threshold, so we're not vecortising huge objects when we don't have to
      var segment_id = clean_map.connectedComponents(ee.Kernel.plus(1),vars.small_object_geo.sqrt()).select('labels');
      //Map.addLayer(segment_id.reproject(ee.Projection('EPSG:4326').atScale(ee.Number(vars.image_data_scale))))
      Map.addLayer(clean_map.updateMask(segment_id).reproject(ee.Projection('EPSG:4326').atScale(ee.Number(vars.image_data_scale))), display_pal, 'Map objects to be iterated through (OBIA)', false);
      
      // This is where we select the single or group of classes to vectorise for cleaning up
      //var classn = ee.Number(15) // one class
      var classn = clean_map.where({
        test: clean_map.neq(16) //TRF
                .and(clean_map.neq(15)) //RR
                .and(clean_map.neq(14)) //ORF
                .and(clean_map.neq(13)) //IRF
                //.and(clean_map.neq(12)) // deep L
                .and(clean_map.neq(11)), // shallow L 
        value: ee.Image(99) // 99 ensures it's ignored in logic
      });
      
      // Minimum size of object to reclass based on neighbourhood
      var max_size = ee.Number(1000).divide(vars.image_data_scale).pow(2); // the first number is the square dimension of the desired min size;
      // calculate neighbours
      var map_fc_neighbours = reduce_neighbours();
      
      // #########
      // REEF RIM
      // #########
      
      var focus_class = ee.Number(15); //RR
      
      // start the object-based neighbourhood rules
      // paint out to rasters (only paint the layers needed)
      var objsize = ee.Image(30000).paint(map_fc_neighbours, 'count').rename('count');
      //var nb24 = ee.Image().byte().paint(map_fc_neighbours, '24').unmask(0).rename('nb24') //OCL
      var nb22 = ee.Image().byte().paint(map_fc_neighbours, '22').unmask(0).rename('nb22'); //SL ex
      var nb21 = ee.Image().byte().paint(map_fc_neighbours, '21').unmask(0).rename('nb21'); //Sl sh
      var nb16 = ee.Image().byte().paint(map_fc_neighbours, '16').unmask(0).rename('nb16'); //TRF
      var nb15 = ee.Image().byte().paint(map_fc_neighbours, '15').unmask(0).rename('nb15'); //RR
      var nb14 = ee.Image().byte().paint(map_fc_neighbours, '14').unmask(0).rename('nb14'); //ORF
      var nb13 = ee.Image().byte().paint(map_fc_neighbours, '13').unmask(0).rename('nb13'); //IRF
      //var nb3 = ee.Image().byte().paint(map_fc_neighbours, '3').unmask(0).rename('nb3') //Turbid
      
      // RR surrounded by ORF --> ORF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb14.gt(75)),
        value: ee.Image(14)
      });
      
      // RR surrounded by IRF --> IRF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb13.gt(75)),
        value: ee.Image(13)
      });
      
      // RR surrounded by IRF + ORF --> IRF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb13.add(nb14).gt(75)),
        value: ee.Image(13)
      });
      
      // RR with decent border to TRF --> TRF (often dark, probably seagrass)
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb16.gt(40)),
        value: ee.Image(16)
      });
      
      // RR surrounded by OCL --> OCL
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb24.gt(75)),
        value: ee.Image(24)
      })
      
      // small RR objects touching OCL + stuff --> ORF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(objsize.lte(max_size))
                .and(nb13.lte(75).and(nb14.lte(75))) // to ensure we're no re-writing previous rules
                .and(nb24.gt(1)),
        value: ee.Image(14)
      })
      
      // ####
      // ORF
      // ####
      
      focus_class = ee.Number(14); // ORF
      
      // ORF surrounded by IRF --> IRF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb13.gt(75)),
        value: ee.Image(13)
      });
      
      // ORF surrounded by TRF --> TRF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb16.gt(75)),
        value: ee.Image(16)
      });
      
      // ORF surrounded by RR --> RR
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb15.gt(85)),
        value: ee.Image(15)
      });
      
      // ORF touching slope and RR --> RR
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb21.gt(0).or(nb22.gt(0)))
                .and(nb15.gt(0)),
        value: ee.Image(15)
      });
      
      // ####
      // IRF
      // ####
      
      focus_class = ee.Number(13); // IRF
      
      // IRF surrounded by ORF --> ORF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb14.gt(75)),
        value: ee.Image(14)
      });
      
      // IRF surrounded by TRF --> TRF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb16.gt(75)),
        value: ee.Image(16)
      });
      
      // IRF surrounded by RR --> RR
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb15.gt(85)),
        value: ee.Image(15)
      });
      
      // ####
      // TRF
      // ####
      
      focus_class = ee.Number(16); // TRF
      
      // TRF surrounded by ORF --> ORF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb14.gt(75)),
        value: ee.Image(14)
      });
      
      // TRF surrounded by IRF --> IRF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb13.gt(75)),
        value: ee.Image(13)
      });
      
      // TRF surrounded by IRF + ORF --> IRF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb13.add(nb14).gt(75)),
        value: ee.Image(13)
      });
      
      // ####
      // LAGOONS
      // ####
      
      var nb11 = ee.Image().byte().paint(map_fc_neighbours, '11').unmask(0).rename('nb11'); // shallow lag
      
      // SL sourrounded by DL --> DL
      clean_map = clean_map.where({
        test: clean_map.eq(11)
                .and(nb12.gt(75)),
        value: ee.Image(12)
      })
      
      // DL sourrounded by SL --> SL
      clean_map = clean_map.where({
        test: clean_map.eq(12)
                .and(nb11.gt(75)),
        value: ee.Image(11)
      })
      
      // DL/SL surrounded by IRF --> IRF
      clean_map = clean_map.where({
        test: clean_map.eq(11).or(clean_map.eq(12))
                .and(objsize.lte(max_size))
                .and(nb13.gt(80)),
        value: ee.Image(13)
      })
      
      // SL surrounded by IRF --> IRF
      clean_map = clean_map.where({
        test: clean_map.eq(11)
                .and(objsize.lte(max_size))
                .and(nb13.gt(80)),
        value: ee.Image(13)
      });
      
    
    } else if (vars.geomorphic && vars.fast_clean) {
      print("Executing the fast version OBIA");
      
      /* fast version of the geo clean up
        - blanket version assigns the underlying most common in neighbourhood
        - mode OBIA version iterates through objects+buffers but take the mode instead of doing the class percs, to see if that speeds things up
      */
      
      
      // ## Blanket version
      
      // make a very smooth map to capture the broader neighbourhood  - *** Change to ee.kernal*** see reef mask in clean 3
      var smooth_map = clean_map
                          .focal_mode({
                            radius: vars.smooth_radius.multiply(3), // relates to smoothness required
                            kernelType: 'circle', units: 'pixels', iterations: 2
                          });
      
      // first make a make size threshold, so we're not vectorising huge objects when we don't have t
      // - the unmask(99) captures small no data values/ data gaps
      var segment_id = clean_map.unmask(0).connectedComponents(ee.Kernel.plus(1),vars.small_object_geo.sqrt().multiply(2)).select('labels').pow(2).log().int();
      Map.addLayer(clean_map.unmask(0).updateMask(segment_id.gt(0)).reproject(ee.Projection('EPSG:4326').atScale(ee.Number(vars.image_data_scale))), display_pal, 'Map objects to be iterated through (OBIA)', false);
      
      // replace small objects with smooth underneath
      var clean_map = clean_map.unmask(0).where({
        test: segment_id.gt(0), 
        value: smooth_map
      }).selfMask();
      
      
      // ## mode OBIA version
      
      /* A possible faster plan
            - vectorise one/few class/es at a time, thus only spending resources on what is actually needed to clean up
            - BUT, just assign the mode of the neighbours, so save resouces even further??
      
      // FUNCTION that maps over feature colleciton and assigns neighbour percentages
      var set_neighbour_mode = function(f) {
        // make the 1px buffer
        var diff = f.buffer(vars.image_data_scale).difference(f, ee.ErrorMargin(0.5))
        // reduce the classes in the buffer zone
        var diff_mode = ee.Number(ee.Dictionary(
          clean_map.unmask(ee.Image(0)).reduceRegion({
            reducer: ee.Reducer.mode(),
            geometry: diff.geometry(),
            scale: vars.image_data_scale,
            maxPixels: 1e11
          })).get('classification'))
        
        return(f.set('mode',diff_mode))
      }
      
      // FUNCTION to reduce the map to vectors and map the neighbour properties function
      var reduce_neighbours_mode = function() {
        // reduce map to vectors
        var map_fc = clean_map.unmask(0)
              .updateMask(classn.gt(0)) // only vectorise class/es of interest
              .reduceToVectors({
                scale: vars.image_data_scale, 
                eightConnected: false,
                bestEffort: true, 
                maxPixels: 1e13,
                tileScale: 1,
                geometry: region_extent
              })
        // map the function, calculate neighbour properties
        return(map_fc.map(set_neighbour_mode))
      }
      
      // first make a make size threshold, so we're not vecortising huge objects when we don't have to
      var segment_id = clean_map.unmask(0).connectedComponents(ee.Kernel.plus(1),vars.small_object_geo.sqrt()).select('labels')
      Map.addLayer(clean_map.unmask(0).updateMask(segment_id.gt(0)).reproject(ee.Projection('EPSG:4326').atScale(ee.Number(vars.image_data_scale))), display_pal, 'Map objects to be iterated through (OBIA)', false)
      
      // This is where we select the single or group of classes to vectorise for cleaning up
      var classn = segment_id.where({
        test: clean_map.neq(16) //TRF
                .and(clean_map.neq(15)) //RR
                .and(clean_map.neq(14)) //ORF
                .and(clean_map.neq(13)) //IRF
                //.and(clean_map.neq(12)) // deep L
                .and(clean_map.neq(11)) // shallow L 
                .and(clean_map.unmask(0).neq(0)), // no data values (want to reclaim the small gaps 
        value: ee.Image(0) // 99 ensures it's ignored in logic
      })
      
      // calculate neighbours
      var map_fc_neighbours = reduce_neighbours_mode()
      
      //print(map_fc_neighbours.limit(10))
      
      var mode_map = ee.Image().byte().paint(map_fc_neighbours, 'mode').unmask(0).rename('mode') // paint out the mode values to an image
      //Map.addLayer(mode_map, display_pal, "mode map", false)
      
      // replace small objects with mode underneath
      var clean_map = clean_map.unmask(0).where({
        test: segment_id.gt(0), 
        value: mode_map
      }).selfMask()
      
      */
      
    } else {
      
      if (vars.cleanup_stage == 1) {
        // BENTHIC CLEAN-UP RULES
        
        /*// reclaim shallow no data to surrounding class
        var smooth_map = clean_map
                            .focal_mode({
                              radius: vars.smooth_radius.multiply(3), // relates to smoothness required
                              kernelType: 'circle', units: 'pixels', iterations: 2
                            });
        
        var clean_map = clean_map.unmask(0).where({
          test: geo_map.gt(2).and(clean_map.eq(0)), 
          value: smooth_map
        }).selfMask();*/
        
        // cut benthic off to < 10 - 15 m
        clean_map = clean_map.where({
          test: depth.gt(vars.benthic_depth_cutoff),
          value: ee.Image(0)
        });
        
        // Deep (or land or missing) in geo == masked from benthic
        clean_map = clean_map.where({
          test: geo_map.unmask(0).lte(2),
          value: ee.Image(0)
        });
        
      }
    }
  }
  
  // Final clip to the classified extent and move on
  if (vars.geomorphic) {
    clean_map = clean_map.updateMask(clean_map.gt(1)); // this ignores 0/land; make it .gt(2) if you want to mask deep too
  } else {
    clean_map = clean_map.updateMask(clean_map.gt(1)); // this ignores 0/land; make it .gt(2) if you want to mask deep too
  }

  
  
  // 4. Export data
  
  var output_name = (vars.geomorphic) ? vars.geomorph_output_name : vars.benthic_output_name;
  
  if (vars.do_export) {
    print("For export, the image data scale must be set to:", vars.image_data_scale);
    
    Map.addLayer(region_extent, {}, "Export footprint", false);
    
    Export.image.toAsset({
      image: clean_map.set(vars),
      description: output_name,
      assetId: vars.asset_output + 'in_out/' + output_name,
      region: region_extent,
      scale: vars.image_data_scale,
      crs: 'EPSG:4326',
      maxPixels: 1e13,
      pyramidingPolicy: {'.default': 'mode'}
    });
    
  } else {
    if (vars.reproject_display) {
      Map.addLayer(clean_map.reproject(ee.Projection('EPSG:4326').atScale(vars.image_data_scale)), display_pal, output_name, true);
    } else {
      Map.addLayer(clean_map, display_pal, output_name, false);
    }
  }

}

//Generate title
var title = ui.Label({
  value: 'Classes',
  style: {fontWeight: 'bold', fontSize: '12px'}
});

// generate the legend
var geo_legend = pkg_vis.discrete_legend(map_palettes.geo_atlas_names, map_palettes.geo_atlas_cols, 'Geomorphic Zone', false);
var benthic_legend = pkg_vis.discrete_legend(map_palettes.benthic_atlas_names, map_palettes.benthic_atlas_cols, 'Benthic Habitat', false);
//var mask_legend = pkg_vis.discrete_legend(["Low confidence depth","Water conditions"], ["#f7f7f7","#bababa"], 'Confidence Mask reason', false)
var legend = (vars.geomorphic) ? geo_legend : benthic_legend;
pkg_vis.add_lgds([title, legend]);//, mask_legend])
// generate the legend
