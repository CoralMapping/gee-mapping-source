/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var keep_mask = 
    /* color: #00d1d6 */
    /* shown: false */
    ee.Geometry({
      "type": "GeometryCollection",
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                152.41274319986974,
                -24.75890010258654
              ],
              [
                152.41377316813146,
                -24.76162800662334
              ],
              [
                152.4169489036051,
                -24.769889293382743
              ],
              [
                152.42029630045568,
                -24.776747302600157
              ],
              [
                152.4257036338297,
                -24.77877346009396
              ],
              [
                152.43222676615392,
                -24.784540035000568
              ],
              [
                152.43800443191265,
                -24.79157187485462
              ],
              [
                152.4394206382725,
                -24.790987470020937
              ],
              [
                152.4398497917149,
                -24.78974073050752
              ],
              [
                152.43950646896099,
                -24.788065404556217
              ],
              [
                152.43766110915874,
                -24.78588355079694
              ],
              [
                152.4358157493565,
                -24.785727702631686
              ],
              [
                152.43611615676616,
                -24.784402985323805
              ],
              [
                152.4356011726353,
                -24.783467882238735
              ],
              [
                152.4337987281773,
                -24.782182103991214
              ],
              [
                152.43229669112895,
                -24.781013203115037
              ],
              [
                152.43023675460552,
                -24.778753296870484
              ],
              [
                152.42834847945903,
                -24.777857115758756
              ],
              [
                152.42667478103374,
                -24.77727264633034
              ],
              [
                152.42487233657573,
                -24.77664920924001
              ],
              [
                152.4231557228062,
                -24.775207498976233
              ],
              [
                152.42161077041362,
                -24.773259215261792
              ],
              [
                152.42019456405376,
                -24.771427800692383
              ],
              [
                152.41963666457866,
                -24.770141897724532
              ],
              [
                152.41985124129985,
                -24.768427339718798
              ],
              [
                152.41959374923442,
                -24.766011331438786
              ],
              [
                152.41847795028423,
                -24.765037121254466
              ],
              [
                152.41804879684184,
                -24.763478369064806
              ],
              [
                152.41770547408794,
                -24.762114444851903
              ],
              [
                152.41663259048198,
                -24.76145196197325
              ],
              [
                152.41560262222026,
                -24.759893164792434
              ],
              [
                152.4148730613682,
                -24.758373318708642
              ],
              [
                152.41401475448345,
                -24.75677551175207
              ],
              [
                152.4121693946812,
                -24.75654168462022
              ],
              [
                152.41032403487895,
                -24.75685345403157
              ],
              [
                152.41088193435405,
                -24.75763287413726
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                152.45324349648365,
                -24.80328897107891
              ],
              [
                152.45736336953053,
                -24.808197399157585
              ],
              [
                152.46646142250904,
                -24.81754624825995
              ],
              [
                152.4655172849358,
                -24.82253201271165
              ],
              [
                152.46714806801685,
                -24.822843616327443
              ],
              [
                152.46800637490162,
                -24.82120768859978
              ],
              [
                152.46852135903248,
                -24.819961252973183
              ],
              [
                152.46963715798267,
                -24.818013672200905
              ],
              [
                152.46998048073658,
                -24.816221870851066
              ],
              [
                152.46946549660572,
                -24.814819573459488
              ],
              [
                152.4706671262444,
                -24.813573073566705
              ],
              [
                152.46860718972096,
                -24.81108003616668
              ],
              [
                152.46671891457447,
                -24.813417260198502
              ],
              [
                152.46491647011646,
                -24.812560283171493
              ],
              [
                152.46380067116627,
                -24.810223042977828
              ],
              [
                152.46234154946217,
                -24.808509038823125
              ],
              [
                152.46277070290455,
                -24.806950832660306
              ],
              [
                152.46208405739674,
                -24.80414601220794
              ],
              [
                152.46019578225025,
                -24.803211057955224
              ],
              [
                152.45907998330006,
                -24.800328237958816
              ],
              [
                152.45770669228443,
                -24.801029470613415
              ],
              [
                152.45264268166432,
                -24.800561982617648
              ],
              [
                152.45032525307545,
                -24.799393254917238
              ],
              [
                152.4490377927483,
                -24.79954908591375
              ],
              [
                152.44560456520924,
                -24.798614096997287
              ],
              [
                152.4461195493401,
                -24.80017240794146
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                152.46793821271842,
                -24.83164191026687
              ],
              [
                152.47557714399284,
                -24.84028798352791
              ],
              [
                152.47892454084342,
                -24.852282436303476
              ],
              [
                152.47986867841666,
                -24.869726837051502
              ],
              [
                152.4838168900866,
                -24.883509287734412
              ],
              [
                152.49136999067252,
                -24.912704314632855
              ],
              [
                152.48982503827995,
                -24.91954040702963
              ],
              [
                152.49385908063834,
                -24.929425675924335
              ],
              [
                152.49463155683463,
                -24.931760663083036
              ],
              [
                152.49669149335807,
                -24.931527166357675
              ],
              [
                152.49609067853874,
                -24.928958673184756
              ],
              [
                152.49360158857291,
                -24.92506691488734
              ],
              [
                152.49308660444206,
                -24.923510177169923
              ],
              [
                152.4948032182116,
                -24.921642065964637
              ],
              [
                152.4961765092272,
                -24.91922904710416
              ],
              [
                152.49574735578483,
                -24.916971664135755
              ],
              [
                152.4954898637194,
                -24.91541482422269
              ],
              [
                152.49445989545768,
                -24.913079527509232
              ],
              [
                152.49317243513053,
                -24.910977722667514
              ],
              [
                152.49351575788444,
                -24.908253107541757
              ],
              [
                152.49265745099967,
                -24.90443854528775
              ],
              [
                152.4922282975573,
                -24.901090975150012
              ],
              [
                152.49162748273795,
                -24.898599701237536
              ],
              [
                152.49119832929557,
                -24.896497649764633
              ],
              [
                152.4893100541491,
                -24.890736288180555
              ],
              [
                152.4888809007067,
                -24.888945539953422
              ],
              [
                152.48956754621452,
                -24.885130381055344
              ],
              [
                152.49085500654166,
                -24.881704423664157
              ],
              [
                152.49008253034538,
                -24.880458597419118
              ],
              [
                152.4885375779528,
                -24.87804477331871
              ],
              [
                152.48733594831413,
                -24.877032510467817
              ],
              [
                152.48716428693717,
                -24.874852223853868
              ],
              [
                152.48699262556022,
                -24.87220468124937
              ],
              [
                152.48587682661002,
                -24.87064727675246
              ],
              [
                152.48553350385612,
                -24.867566634980516
              ],
              [
                152.48579099592155,
                -24.864451689487307
              ],
              [
                152.48364522870963,
                -24.862582684519232
              ],
              [
                152.4848468583483,
                -24.860168511288105
              ],
              [
                152.48441770490592,
                -24.85666398240831
              ],
              [
                152.48364522870963,
                -24.85424969363202
              ],
              [
                152.48278692182487,
                -24.852614180912454
              ],
              [
                152.48184278425163,
                -24.850355580178476
              ],
              [
                152.48029783185905,
                -24.848720015974383
              ],
              [
                152.47926786359733,
                -24.846850773265622
              ],
              [
                152.47943952497428,
                -24.84490361541548
              ],
              [
                152.4801261704821,
                -24.842878538748906
              ],
              [
                152.48072698530143,
                -24.840619760296367
              ],
              [
                152.47995450910514,
                -24.83968508129214
              ],
              [
                152.47729375776237,
                -24.83703678578377
              ],
              [
                152.47454717573112,
                -24.835790509468936
              ],
              [
                152.4728305619616,
                -24.83283055293769
              ],
              [
                152.47068479474967,
                -24.83033790307725
              ],
              [
                152.4687965196032,
                -24.830571591133317
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                152.89592249280503,
                -25.302577767888916
              ],
              [
                152.89472086316636,
                -25.311578613373136
              ],
              [
                152.899699043098,
                -25.31142343204668
              ],
              [
                152.9029606092601,
                -25.31933742623655
              ],
              [
                152.90210230237534,
                -25.3325262673079
              ],
              [
                152.90450556165268,
                -25.341369744067176
              ],
              [
                152.91017038709214,
                -25.353004912885474
              ],
              [
                152.91532022840073,
                -25.364638962256496
              ],
              [
                152.92029840833237,
                -25.364483848963303
              ],
              [
                152.92098505384018,
                -25.362777589599318
              ],
              [
                152.9197834242015,
                -25.35455618415558
              ],
              [
                152.91772348767807,
                -25.354090804864235
              ],
              [
                152.9165218580394,
                -25.34804071108887
              ],
              [
                152.91308863050034,
                -25.34416228665726
              ],
              [
                152.9129169691234,
                -25.341059457578147
              ],
              [
                152.9139469373851,
                -25.336715363177973
              ],
              [
                152.91257364636948,
                -25.334232953499576
              ],
              [
                152.90948374158432,
                -25.33004377170416
              ],
              [
                152.91205866223862,
                -25.328181866588938
              ],
              [
                152.914290260139,
                -25.324613135073548
              ],
              [
                152.91171533948472,
                -25.32150980477111
              ],
              [
                152.9081104505687,
                -25.31763053004993
              ],
              [
                152.90622217542222,
                -25.314992552262936
              ],
              [
                152.9055355299144,
                -25.311113068797436
              ],
              [
                152.9055355299144,
                -25.30661271233797
              ],
              [
                152.90828211194565,
                -25.30149141373762
              ],
              [
                152.90965540296128,
                -25.29807709444332
              ],
              [
                152.90605051404526,
                -25.296835499946337
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                153.19605482104453,
                -25.911410195187223
              ],
              [
                153.19684875491293,
                -25.911255790694547
              ],
              [
                153.19768560412558,
                -25.910831177297382
              ],
              [
                153.19772851946982,
                -25.91002054747591
              ],
              [
                153.1975997734371,
                -25.909383620136147
              ],
              [
                153.19620502474936,
                -25.909711734649818
              ],
              [
                153.19564712527426,
                -25.91002054747591
              ],
              [
                153.19549692156943,
                -25.910811876652094
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                153.092718004154,
                -26.387269359045597
              ],
              [
                153.09984195129755,
                -26.38131038263074
              ],
              [
                153.10688006775263,
                -26.380041657636024
              ],
              [
                153.11675059692743,
                -26.380733691178705
              ],
              [
                153.1187247027624,
                -26.3810028142146
              ],
              [
                153.12091338531854,
                -26.38031078228413
              ],
              [
                153.12215793030146,
                -26.378849812372458
              ],
              [
                153.12215793030146,
                -26.3773888239852
              ],
              [
                153.1207417239416,
                -26.3762738467337
              ],
              [
                153.11730849640253,
                -26.374889722073423
              ],
              [
                153.1153773059118,
                -26.374889722073423
              ],
              [
                153.11275946991327,
                -26.376081608189065
              ],
              [
                153.11104285614374,
                -26.37700435028633
              ],
              [
                153.1080816973913,
                -26.375735578002704
              ],
              [
                153.10619342224481,
                -26.37673521793586
              ],
              [
                153.10507762329462,
                -26.377734849220275
              ],
              [
                153.0994557131994,
                -26.378542237405213
              ],
              [
                153.09606540100458,
                -26.380195443226004
              ],
              [
                153.09409129516962,
                -26.381963962796004
              ],
              [
                153.09155928985956,
                -26.384078461524062
              ],
              [
                153.08894145386103,
                -26.385693143577306
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                153.09448491030412,
                -26.53792782618222
              ],
              [
                153.0981756299086,
                -26.543456390368004
              ],
              [
                153.1010938733168,
                -26.547372295447357
              ],
              [
                153.10598622255998,
                -26.55343784521833
              ],
              [
                153.111393555934,
                -26.55274684941389
              ],
              [
                153.11371098452287,
                -26.548216884895968
              ],
              [
                153.11225186281877,
                -26.54445457494772
              ],
              [
                153.10838948183732,
                -26.536929584807822
              ],
              [
                153.1055570691176,
                -26.53562417913617
              ],
              [
                153.09620152407365,
                -26.533934808573218
              ],
              [
                153.09354077273088,
                -26.534241968707423
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                153.11199336029233,
                -26.612988570490415
              ],
              [
                153.1118431565875,
                -26.61425472661433
              ],
              [
                153.11287312484922,
                -26.615309846007875
              ],
              [
                153.11467556930722,
                -26.616249853266464
              ],
              [
                153.1163278100604,
                -26.615866177767792
              ],
              [
                153.1171217439288,
                -26.615041271085975
              ],
              [
                153.11679987884702,
                -26.613736755349095
              ],
              [
                153.11540513015927,
                -26.613122860440903
              ],
              [
                153.11225085235776,
                -26.612585699692733
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                153.13339119106365,
                -26.67957387699116
              ],
              [
                153.13577299266888,
                -26.680359971638847
              ],
              [
                153.13854103237225,
                -26.681970490087977
              ],
              [
                153.139399339257,
                -26.682238907617702
              ],
              [
                153.14012890010906,
                -26.680722712100533
              ],
              [
                153.1403863921745,
                -26.680243388265602
              ],
              [
                153.14087991863323,
                -26.679399773421977
              ],
              [
                153.1406224265678,
                -26.6787095384528
              ],
              [
                153.13851957470013,
                -26.678134339453408
              ],
              [
                153.13706045299602,
                -26.67805764603426
              ],
              [
                153.13564424663616,
                -26.67790425904123
              ],
              [
                153.1350005164726,
                -26.678000125936045
              ],
              [
                153.13341264873577,
                -26.678076819393894
              ],
              [
                153.13272600322796,
                -26.67834524609009
              ],
              [
                153.1324255958183,
                -26.678882097586797
              ],
              [
                153.13336973339153,
                -26.67943811968665
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                153.1473035999776,
                -26.791229044872782
              ],
              [
                153.1478614994527,
                -26.79777962453664
              ],
              [
                153.1512518116475,
                -26.801878332874953
              ],
              [
                153.15198137249956,
                -26.801725112798245
              ],
              [
                153.15193845715532,
                -26.801342061700904
              ],
              [
                153.15142347302447,
                -26.800422733789105
              ],
              [
                153.15150930371294,
                -26.79946509262407
              ],
              [
                153.15060808148394,
                -26.798354218743633
              ],
              [
                153.15030767407427,
                -26.797549786038903
              ],
              [
                153.14902021374712,
                -26.79628566597739
              ],
              [
                153.14919187512407,
                -26.794983224514297
              ],
              [
                153.14974977459917,
                -26.794561843192536
              ],
              [
                153.15009309735308,
                -26.793757383595892
              ],
              [
                153.14974977459917,
                -26.792301680302774
              ],
              [
                153.1496639439107,
                -26.791458896175683
              ],
              [
                153.14880563702593,
                -26.790386252778692
              ],
              [
                153.14713193860064,
                -26.789773309142213
              ],
              [
                153.14700319256792,
                -26.7890837435937
              ],
              [
                153.14627363171587,
                -26.78885388747972
              ],
              [
                153.1438274570943,
                -26.789735000055007
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                153.4543568965097,
                -27.02592318936222
              ],
              [
                153.46551488601165,
                -27.03066348938742
              ],
              [
                153.4524686213632,
                -27.064910032127163
              ],
              [
                153.4579617854257,
                -27.06582720649195
              ],
              [
                153.45847676955657,
                -27.06399285026056
              ],
              [
                153.4608800288339,
                -27.059253957781824
              ],
              [
                153.46362661086516,
                -27.054209110283406
              ],
              [
                153.46654485427337,
                -27.04931692029099
              ],
              [
                153.46911977492766,
                -27.044883188866965
              ],
              [
                153.47014974318938,
                -27.039073206693573
              ],
              [
                153.47135137282805,
                -27.033721641286032
              ],
              [
                153.4718663569589,
                -27.028675645993324
              ],
              [
                153.4711797114511,
                -27.024394017644134
              ],
              [
                153.4689481135507,
                -27.024241099327373
              ],
              [
                153.4631116267343,
                -27.024852771345397
              ],
              [
                153.46070836745696,
                -27.023935262069358
              ],
              [
                153.45933507644133,
                -27.02179437794874
              ],
              [
                153.45624517165618,
                -27.019806377590946
              ],
              [
                153.4543568965097,
                -27.01965345302946
              ],
              [
                153.45195363723235,
                -27.01995930194428
              ],
              [
                153.449550377955,
                -27.021488534029526
              ],
              [
                153.44268392287688,
                -27.02668776741464
              ],
              [
                153.4411389704843,
                -27.030510579606315
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                153.36657570966565,
                -27.07129467105559
              ],
              [
                153.36554574140393,
                -27.073128907826536
              ],
              [
                153.3657174027809,
                -27.077408676904067
              ],
              [
                153.36485909589612,
                -27.087801721393237
              ],
              [
                153.36537408002698,
                -27.094831763630644
              ],
              [
                153.36623238691175,
                -27.102166989409096
              ],
              [
                153.36434411176526,
                -27.118975069119585
              ],
              [
                153.36194085248792,
                -27.129975354170533
              ],
              [
                153.36073922284925,
                -27.13684998287718
              ],
              [
                153.36211251386487,
                -27.135627857557235
              ],
              [
                153.3715538895973,
                -27.11164094477129
              ],
              [
                153.37138222822034,
                -27.088718708446343
              ],
              [
                153.36743401655042,
                -27.075574510166657
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                153.2372338231237,
                -27.334109384736337
              ],
              [
                153.23508805591177,
                -27.333499405619417
              ],
              [
                153.2338864262731,
                -27.33151695030826
              ],
              [
                153.234229749027,
                -27.33487185391218
              ],
              [
                153.23483056384634,
                -27.33662551311224
              ],
              [
                153.23448724109244,
                -27.339294071700436
              ],
              [
                153.2331997807653,
                -27.34142887230654
              ],
              [
                153.23362893420767,
                -27.344097315229988
              ],
              [
                153.2350022252233,
                -27.345393392891214
              ],
              [
                153.23697633105826,
                -27.345698350137525
              ],
              [
                153.2386929448278,
                -27.345088434805508
              ],
              [
                153.2412678654821,
                -27.346765693889285
              ],
              [
                153.24401444751334,
                -27.3478330273581
              ],
              [
                153.24427193957877,
                -27.34912906131702
              ],
              [
                153.24504441577506,
                -27.349815190803714
              ],
              [
                153.24701852161002,
                -27.349434008280223
              ],
              [
                153.24864930469107,
                -27.349510244889863
              ],
              [
                153.25010842639517,
                -27.350501316040496
              ],
              [
                153.25173920947623,
                -27.349891427151004
              ],
              [
                153.2547432835729,
                -27.350501316040496
              ],
              [
                153.25637406665396,
                -27.34996766344583
              ],
              [
                153.25937814075064,
                -27.34585082844592
              ],
              [
                153.26015061694693,
                -27.3455458716193
              ],
              [
                153.26126641589713,
                -27.342724981181245
              ],
              [
                153.26298302966666,
                -27.33853163294613
              ],
              [
                153.26332635242056,
                -27.336244285211613
              ],
              [
                153.26401299792838,
                -27.33525308653329
              ],
              [
                153.26487130481314,
                -27.33372814818161
              ],
              [
                153.2646996434362,
                -27.332660678853
              ],
              [
                153.26495713550162,
                -27.331821945740636
              ],
              [
                153.26306886035513,
                -27.33189819446763
              ],
              [
                153.26229638415884,
                -27.331135704837788
              ],
              [
                153.26006478625845,
                -27.33090695692617
              ],
              [
                153.25929231006216,
                -27.32961070984509
              ],
              [
                153.26092309314322,
                -27.32922945781929
              ],
              [
                153.26109475452017,
                -27.32785693967113
              ],
              [
                153.25980729419302,
                -27.325798130592105
              ],
              [
                153.25886315661978,
                -27.32785693967113
              ],
              [
                153.25671738940787,
                -27.326179394416755
              ],
              [
                153.25594491321158,
                -27.32595063627927
              ],
              [
                153.25560159045767,
                -27.328390698747697
              ],
              [
                153.25465745288443,
                -27.328695702780625
              ],
              [
                153.252597516361,
                -27.326484404532582
              ],
              [
                153.25062341052603,
                -27.325798130592105
              ],
              [
                153.24942178088736,
                -27.323205501819604
              ],
              [
                153.24839181262564,
                -27.3226717177833
              ],
              [
                153.2466751988561,
                -27.322976737547215
              ],
              [
                153.24607438403677,
                -27.32450182378272
              ],
              [
                153.24470109302115,
                -27.32572187766987
              ],
              [
                153.24255532580924,
                -27.32633189957954
              ],
              [
                153.24109620410513,
                -27.32755193333085
              ],
              [
                153.23843545276236,
                -27.332355685728192
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                153.2224713627361,
                -27.391106874448383
              ],
              [
                153.22264302411304,
                -27.393393088883688
              ],
              [
                153.22676289715992,
                -27.39644130126284
              ],
              [
                153.22985280194507,
                -27.398879810653842
              ],
              [
                153.2344876591228,
                -27.402232673233147
              ],
              [
                153.23877919354663,
                -27.401318266252588
              ],
              [
                153.24101079144702,
                -27.398727405392805
              ],
              [
                153.24272740521656,
                -27.394764794854517
              ],
              [
                153.24272740521656,
                -27.390497209282263
              ],
              [
                153.24478734174,
                -27.388515774278513
              ],
              [
                153.24324238934742,
                -27.38775367443912
              ],
              [
                153.24083913007007,
                -27.382571256260942
              ],
              [
                153.2403241459392,
                -27.378455633560513
              ],
              [
                153.23792088666187,
                -27.376321546698325
              ],
              [
                153.23757756390796,
                -27.372967898466396
              ],
              [
                153.23328602948413,
                -27.372205691511667
              ],
              [
                153.226419574406,
                -27.38180911546083
              ],
              [
                153.22367299237476,
                -27.38973512309777
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                153.22075474896656,
                -27.418843082804067
              ],
              [
                153.21920979657398,
                -27.421433472011238
              ],
              [
                153.2224713627361,
                -27.422652457672957
              ],
              [
                153.2260762516521,
                -27.426156966495242
              ],
              [
                153.22847951092945,
                -27.429661364086293
              ],
              [
                153.2315694157146,
                -27.434232150287816
              ],
              [
                153.23620427289234,
                -27.43804099420275
              ],
              [
                153.2396375004314,
                -27.440783280425144
              ],
              [
                153.24375737347827,
                -27.439564494961957
              ],
              [
                153.24564564862476,
                -27.43484157414749
              ],
              [
                153.24616063275562,
                -27.429966089054606
              ],
              [
                153.24684727826343,
                -27.424176170827643
              ],
              [
                153.2480489079021,
                -27.418995460321646
              ],
              [
                153.24650395550952,
                -27.416405013932035
              ],
              [
                153.2403241459392,
                -27.415795488305243
              ],
              [
                153.2370625797771,
                -27.41777643429457
              ],
              [
                153.2341443363689,
                -27.417166916235658
              ],
              [
                153.23208439984546,
                -27.41549072423056
              ],
              [
                153.2257329288982,
                -27.4153383418779
              ],
              [
                153.2231580082439,
                -27.41792881328376
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                153.32334414419586,
                -27.502237701328195
              ],
              [
                153.32403078970367,
                -27.50376031484698
              ],
              [
                153.32935229238922,
                -27.50360805444309
              ],
              [
                153.337420377106,
                -27.503912575040196
              ],
              [
                153.33862200674469,
                -27.50726224599067
              ],
              [
                153.3389653294986,
                -27.51609270786668
              ],
              [
                153.34085360464508,
                -27.518224092461846
              ],
              [
                153.3473767369693,
                -27.51883305190244
              ],
              [
                153.35338488516265,
                -27.517462888419438
              ],
              [
                153.35733309683258,
                -27.514874755267837
              ],
              [
                153.3561314671939,
                -27.510155061568117
              ],
              [
                153.35372820791656,
                -27.506348709480356
              ],
              [
                153.35767641958648,
                -27.504369354355845
              ],
              [
                153.36780444082672,
                -27.501933176096504
              ],
              [
                153.37106600698883,
                -27.502237701328195
              ],
              [
                153.37501421865875,
                -27.5004105372987
              ],
              [
                153.37930575308258,
                -27.497212927257653
              ],
              [
                153.37861910757476,
                -27.493253852796272
              ],
              [
                153.37673083242828,
                -27.4905128716886
              ],
              [
                153.37501421865875,
                -27.485944418213478
              ],
              [
                153.37089434561187,
                -27.483964696183822
              ],
              [
                153.36608782705719,
                -27.483964696183822
              ],
              [
                153.36042300161773,
                -27.48137577522041
              ],
              [
                153.36025134024078,
                -27.47817761237343
              ],
              [
                153.35784808096344,
                -27.476502347160796
              ],
              [
                153.35578814444,
                -27.47802531658858
              ],
              [
                153.35458651480133,
                -27.48137577522041
              ],
              [
                153.35304156240875,
                -27.485335276763852
              ],
              [
                153.35080996450836,
                -27.4870104076431
              ],
              [
                153.35132494863922,
                -27.48335554378463
              ],
              [
                153.3509816258853,
                -27.48000514536966
              ],
              [
                153.3535565465396,
                -27.47711153745828
              ],
              [
                153.35372820791656,
                -27.472694831487562
              ],
              [
                153.35218325552398,
                -27.470105645677947
              ],
              [
                153.34823504385406,
                -27.46949641664657
              ],
              [
                153.34617510733062,
                -27.472390224549848
              ],
              [
                153.34428683218414,
                -27.47635004906011
              ],
              [
                153.34617510733062,
                -27.48030973125477
              ],
              [
                153.34205523428375,
                -27.480766608503338
              ],
              [
                153.3399952977603,
                -27.483507832200267
              ],
              [
                153.3360470860904,
                -27.48548756244213
              ],
              [
                153.33209887442047,
                -27.492797027350328
              ],
              [
                153.326434048981,
                -27.496756118240242
              ],
              [
                153.32454577383453,
                -27.501476386669044
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                153.40118795579133,
                -27.47887280063677
              ],
              [
                153.4016171092337,
                -27.479520051289096
              ],
              [
                153.40200334733186,
                -27.48024344457666
              ],
              [
                153.40157419388947,
                -27.481918652898614
              ],
              [
                153.40110212510285,
                -27.483213114606823
              ],
              [
                153.40144544785676,
                -27.484507561101974
              ],
              [
                153.40286165421662,
                -27.48477406290364
              ],
              [
                153.4037199611014,
                -27.482527813244563
              ],
              [
                153.4046211833304,
                -27.482185160964498
              ],
              [
                153.40560823624787,
                -27.481994798126106
              ],
              [
                153.4062090510672,
                -27.482832392154183
              ],
              [
                153.40603738969025,
                -27.485230921634738
              ],
              [
                153.40779691880402,
                -27.486220775717374
              ],
              [
                153.4096851939505,
                -27.48123334348258
              ],
              [
                153.4096851939505,
                -27.476702579521728
              ],
              [
                153.4132471675223,
                -27.475598415528726
              ],
              [
                153.4171953791922,
                -27.475903013597563
              ],
              [
                153.4234117103988,
                -27.471090110943454
              ],
              [
                153.42418418659508,
                -27.46895781364715
              ],
              [
                153.42414127125085,
                -27.467853572047293
              ],
              [
                153.424527509349,
                -27.466025837502478
              ],
              [
                153.42384086384118,
                -27.46636854003829
              ],
              [
                153.4225104881698,
                -27.46625430597807
              ],
              [
                153.4217380119735,
                -27.465530820847416
              ],
              [
                153.42079387440026,
                -27.46507388042343
              ],
              [
                153.41830478443444,
                -27.464540780868056
              ],
              [
                153.4165881706649,
                -27.466863552931134
              ],
              [
                153.4150003029281,
                -27.46869127358429
              ],
              [
                153.41229663624108,
                -27.470823576037656
              ],
              [
                153.40955005420983,
                -27.4721181681128
              ],
              [
                153.40628848804772,
                -27.472993912951342
              ],
              [
                153.40319858326257,
                -27.475316506858462
              ],
              [
                153.40135322346032,
                -27.477600977693754
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                153.57942272610933,
                -28.193874823159916
              ],
              [
                153.57914377637178,
                -28.193572233861225
              ],
              [
                153.57858587689668,
                -28.19417741160197
              ],
              [
                153.57727695889741,
                -28.194669115993257
              ],
              [
                153.57656885571748,
                -28.19495279057463
              ],
              [
                153.57601095624238,
                -28.195387756803754
              ],
              [
                153.57620407529146,
                -28.196106392782117
              ],
              [
                153.57740570493013,
                -28.196541354316274
              ],
              [
                153.57862879224092,
                -28.196881757760345
              ],
              [
                153.5792939800766,
                -28.197241071330573
              ],
              [
                153.58010937161714,
                -28.19769493937673
              ],
              [
                153.58045269437105,
                -28.197524739085317
              ],
              [
                153.58068872876436,
                -28.19674937877205
              ],
              [
                153.58161140866548,
                -28.19665482225144
              ],
              [
                153.58150412030488,
                -28.19604965853847
              ],
              [
                153.58092476315767,
                -28.196068569956353
              ],
              [
                153.57987333722383,
                -28.195368845265378
              ],
              [
                153.57886482663423,
                -28.194366528943252
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                153.4793911461984,
                -26.979310384932553
              ],
              [
                153.4793911461984,
                -26.981222612918405
              ],
              [
                153.47999196101773,
                -26.983631973919678
              ],
              [
                153.4835539345895,
                -26.985429400116683
              ],
              [
                153.486343431965,
                -26.984855756577474
              ],
              [
                153.48917584468472,
                -26.982790615622086
              ],
              [
                153.49076371242154,
                -26.980495970111136
              ],
              [
                153.49114995051968,
                -26.97854548464109
              ],
              [
                153.4903774743234,
                -26.97583004662504
              ],
              [
                153.4912786965524,
                -26.972196611606503
              ],
              [
                153.48934750606168,
                -26.97277031966893
              ],
              [
                153.48733048488248,
                -26.974644412298602
              ],
              [
                153.48381142665494,
                -26.976059522794202
              ],
              [
                153.4800777917062,
                -26.97854548464109
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                153.5256476126035,
                -27.416010809241506
              ],
              [
                153.52702090361913,
                -27.415553663705275
              ],
              [
                153.52702090361913,
                -27.414334599692733
              ],
              [
                153.5286516867002,
                -27.41357267785317
              ],
              [
                153.52796504119237,
                -27.41235359197941
              ],
              [
                153.52702090361913,
                -27.41227739866563
              ],
              [
                153.5246176443418,
                -27.412886943704503
              ],
              [
                153.5238451681455,
                -27.414791750274
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                153.54041049102148,
                -27.42187734234715
              ],
              [
                153.5399813375791,
                -27.4230201372058
              ],
              [
                153.54169795134862,
                -27.425153322632266
              ],
              [
                153.54229876616796,
                -27.426219899891397
              ],
              [
                153.54375788787206,
                -27.42774356381735
              ],
              [
                153.54556033233007,
                -27.428429205723855
              ],
              [
                153.54770609954198,
                -27.429267206715803
              ],
              [
                153.54968020537694,
                -27.42888629796255
              ],
              [
                153.551310988458,
                -27.425458060043326
              ],
              [
                153.5520834646543,
                -27.423781993874574
              ],
              [
                153.55182597258886,
                -27.421267846920223
              ],
              [
                153.55071017363866,
                -27.419591717151377
              ],
              [
                153.54753443816503,
                -27.419210775019835
              ],
              [
                153.54264208892187,
                -27.419972657968973
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                153.55525920012792,
                -27.419210775019835
              ],
              [
                153.5560316763242,
                -27.418753642727566
              ],
              [
                153.55594584563573,
                -27.41799175136923
              ],
              [
                153.5545725546201,
                -27.41783937246689
              ],
              [
                153.55414340117773,
                -27.418601264876354
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                153.5507823005122,
                -27.38831551693664
              ],
              [
                153.54949484018505,
                -27.388391726769736
              ],
              [
                153.5485507026118,
                -27.389763494784777
              ],
              [
                153.54872236398876,
                -27.391592492334812
              ],
              [
                153.54949484018505,
                -27.393192840374468
              ],
              [
                153.55052480844677,
                -27.3948693706197
              ],
              [
                153.55267057565868,
                -27.395097986410704
              ],
              [
                153.55344305185497,
                -27.39403110867486
              ],
              [
                153.55344305185497,
                -27.392430772768154
              ],
              [
                153.55498800424755,
                -27.390982829846134
              ],
              [
                153.5544730201167,
                -27.389458658918624
              ],
              [
                153.5522414222163,
                -27.388239307051023
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                153.60749237078676,
                -28.63959813681881
              ],
              [
                153.6238002015973,
                -28.64321388905364
              ],
              [
                153.63452903765688,
                -28.6376395523262
              ],
              [
                153.62843505877504,
                -28.65315656506617
              ],
              [
                153.6307524873639,
                -28.65315656506617
              ],
              [
                153.63281242388734,
                -28.651574838752396
              ],
              [
                153.63452903765688,
                -28.64803469816899
              ],
              [
                153.6362456514264,
                -28.646302245398644
              ],
              [
                153.63839141863832,
                -28.64238529017367
              ],
              [
                153.6388205720807,
                -28.639673466261456
              ],
              [
                153.64002220171938,
                -28.636886240862964
              ],
              [
                153.64002220171938,
                -28.634776939993856
              ],
              [
                153.63967887896547,
                -28.632441593146158
              ],
              [
                153.63907806414613,
                -28.630407539032337
              ],
              [
                153.63761894244203,
                -28.62995552165349
              ],
              [
                153.63341323870668,
                -28.633119602423523
              ],
              [
                153.63066665667543,
                -28.63522893660665
              ],
              [
                153.62800590533266,
                -28.634927605747777
              ],
              [
                153.62620346087465,
                -28.635906927875336
              ],
              [
                153.62465850848207,
                -28.63801620602963
              ],
              [
                153.6234568788434,
                -28.639673466261456
              ],
              [
                153.62156860369691,
                -28.639899454264828
              ],
              [
                153.61950866717348,
                -28.640125441781425
              ],
              [
                153.61418716448793,
                -28.638317528018867
              ],
              [
                153.60972396868715,
                -28.635906927875336
              ],
              [
                153.60826484698305,
                -28.636283587798385
              ],
              [
                153.60500328082094,
                -28.637187566097257
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                159.03980051494966,
                -29.455159149581174
              ],
              [
                159.04786859966646,
                -29.47309427179821
              ],
              [
                159.06263147808443,
                -29.481164041902073
              ],
              [
                159.06881128765474,
                -29.48355496151227
              ],
              [
                159.0854624412192,
                -29.485796397416074
              ],
              [
                159.09696375347505,
                -29.485945824713497
              ],
              [
                159.11189829326997,
                -29.4825089411236
              ],
              [
                159.1239145896567,
                -29.47638203346607
              ],
              [
                159.13369928814302,
                -29.469208597815594
              ],
              [
                159.13730417705904,
                -29.463379807639065
              ],
              [
                159.14193903423677,
                -29.4614368031323
              ],
              [
                159.14417063213716,
                -29.438715835120007
              ],
              [
                159.13249765850435,
                -29.424363129361442
              ],
              [
                159.1129282615317,
                -29.417335544239798
              ],
              [
                159.08117090679536,
                -29.424811682119802
              ],
              [
                159.04907022930513,
                -29.445143993389877
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                159.0829363511134,
                -29.904296803254642
              ],
              [
                159.0602770493556,
                -29.907570487446076
              ],
              [
                159.04517084818372,
                -29.918878750452933
              ],
              [
                159.01804835062512,
                -29.92602014964446
              ],
              [
                159.01049525003918,
                -29.938516365372685
              ],
              [
                159.01289850931653,
                -29.954580622293285
              ],
              [
                159.03075129251965,
                -29.96528868517599
              ],
              [
                159.0657702134181,
                -29.976887784732885
              ],
              [
                159.10010248880872,
                -29.98937760815326
              ],
              [
                159.12894160013684,
                -29.98372764451499
              ],
              [
                159.13443476419934,
                -29.949226158301386
              ],
              [
                159.10593897562512,
                -29.929293119721116
              ],
              [
                159.0822497056056,
                -29.908463291735703
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                159.06868046001944,
                -31.484405168679967
              ],
              [
                159.02713840679678,
                -31.51309316732836
              ],
              [
                159.06318729595694,
                -31.577608967348127
              ],
              [
                159.07743548733475,
                -31.583093164441735
              ],
              [
                159.08515995220694,
                -31.584628403435154
              ],
              [
                159.1098791904882,
                -31.560496877338984
              ],
              [
                159.07348697857412,
                -31.484697947805703
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                152.92805373192317,
                -25.290075718399287
              ],
              [
                152.93320357323176,
                -25.29271423861227
              ],
              [
                152.94504820824153,
                -25.300629454740605
              ],
              [
                152.95071303368098,
                -25.303578128610145
              ],
              [
                152.96187102318294,
                -25.306992292936
              ],
              [
                152.96736418724544,
                -25.3096304449387
              ],
              [
                152.97491728783137,
                -25.315216930139748
              ],
              [
                152.9810970974017,
                -25.316613511185064
              ],
              [
                152.98933684349544,
                -25.313354797030918
              ],
              [
                152.987276906972,
                -25.311492635296727
              ],
              [
                152.97869383812434,
                -25.302802168757726
              ],
              [
                152.97526061058528,
                -25.296128708952086
              ],
              [
                152.96873747826106,
                -25.292093415492115
              ],
              [
                152.96221434593684,
                -25.285264151391406
              ],
              [
                152.9568928432513,
                -25.277347932287086
              ],
              [
                152.94607817650325,
                -25.267257884789792
              ],
              [
                152.93766676903255,
                -25.262600656878885
              ],
              [
                152.93543517113216,
                -25.263221630922747
              ],
              [
                152.93286025047786,
                -25.266481692545117
              ],
              [
                152.9268521022845,
                -25.26741312264316
              ],
              [
                152.9210156154681,
                -25.26741312264316
              ],
              [
                152.91998564720637,
                -25.267102646737907
              ],
              [
                152.91861235619075,
                -25.266947408487486
              ],
              [
                152.91672408104426,
                -25.267568360298
              ],
              [
                152.91483580589778,
                -25.266792170038553
              ],
              [
                152.91346251488216,
                -25.26741312264316
              ],
              [
                152.91311919212825,
                -25.268499782057965
              ],
              [
                152.91346251488216,
                -25.269896901296963
              ],
              [
                152.9155224514056,
                -25.27377770369063
              ],
              [
                152.91741072655208,
                -25.277813606533442
              ],
              [
                152.91964232445247,
                -25.285264151391406
              ],
              [
                152.9239338588763,
                -25.288834041962737
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                152.7892953154747,
                -25.249839783408625
              ],
              [
                152.7896386382286,
                -25.252013407048448
              ],
              [
                152.79461681816025,
                -25.25046082270289
              ],
              [
                152.79908001396103,
                -25.248908218514476
              ],
              [
                152.8025132415001,
                -25.247821383776547
              ],
              [
                152.8050881621544,
                -25.24813190897946
              ],
              [
                152.813842892379,
                -25.250771341159467
              ],
              [
                152.82500088188095,
                -25.27219519743676
              ],
              [
                152.84766018363877,
                -25.287251732098827
              ],
              [
                152.8955537078087,
                -25.282750489721852
              ],
              [
                152.9075700041954,
                -25.29206322025019
              ],
              [
                152.9120331999962,
                -25.291752807420803
              ],
              [
                152.91031658622666,
                -25.285078739393235
              ],
              [
                152.90533840629502,
                -25.279025197298015
              ],
              [
                152.89984524223252,
                -25.27685205722464
              ],
              [
                152.89246380302353,
                -25.275920699563997
              ],
              [
                152.88285076591416,
                -25.27716250818955
              ],
              [
                152.8636246916954,
                -25.277084895522794
              ],
              [
                152.85641491386338,
                -25.275998312975418
              ],
              [
                152.85057842704697,
                -25.271496653055348
              ],
              [
                152.84474194023056,
                -25.26575291349084
              ],
              [
                152.83770382377548,
                -25.267305302336823
              ],
              [
                152.83530056449814,
                -25.263113806893745
              ],
              [
                152.8325539824669,
                -25.252556806881344
              ],
              [
                152.8354722258751,
                -25.24557005232062
              ],
              [
                152.83152401420517,
                -25.240601449087457
              ],
              [
                152.8186494109337,
                -25.238582895998434
              ],
              [
                152.80663311454697,
                -25.23671958646978
              ],
              [
                152.79839336845322,
                -25.23734069281968
              ],
              [
                152.79393017265244,
                -25.239359266538465
              ],
              [
                152.78912365409775,
                -25.24883058778419
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                152.9974171822136,
                -25.345913516420367
              ],
              [
                152.99801799703295,
                -25.34746487865567
              ],
              [
                152.99939128804857,
                -25.34917135413211
              ],
              [
                153.00239536214525,
                -25.351420762289667
              ],
              [
                153.00376865316088,
                -25.353902819285782
              ],
              [
                153.00488445211107,
                -25.35560920391668
              ],
              [
                153.00651523519213,
                -25.357005318884056
              ],
              [
                153.00763103414232,
                -25.3573931257361
              ],
              [
                153.00866100240404,
                -25.3573931257361
              ],
              [
                153.00823184896166,
                -25.353902819285782
              ],
              [
                153.00677272725756,
                -25.350489977781667
              ],
              [
                153.0043694679802,
                -25.34847325343828
              ],
              [
                153.0007645790642,
                -25.344168210122284
              ],
              [
                152.9985329811638,
                -25.344168210122284
              ],
              [
                152.997846335656,
                -25.34533175045232
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                153.01718048338643,
                -25.317191324816186
              ],
              [
                153.02078537230244,
                -25.322311959773714
              ],
              [
                153.02336029295674,
                -25.32650140913594
              ],
              [
                153.02559189085713,
                -25.33045797819836
              ],
              [
                153.02687935118428,
                -25.334104113611136
              ],
              [
                153.02945427183857,
                -25.337129546839698
              ],
              [
                153.0311708856081,
                -25.337362269339707
              ],
              [
                153.03142837767354,
                -25.334491993892968
              ],
              [
                153.03039840941182,
                -25.326578990164414
              ],
              [
                153.02996925596943,
                -25.315561986470616
              ],
              [
                153.02782348875752,
                -25.306949405423538
              ],
              [
                153.02524856810322,
                -25.305707901813378
              ],
              [
                153.01769546751729,
                -25.309277190407716
              ],
              [
                153.01666549925557,
                -25.312536014252093
              ],
              [
                153.01563553099385,
                -25.312536014252093
              ],
              [
                153.01589302305928,
                -25.31385503707672
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                153.2673805538302,
                -27.504422296576454
              ],
              [
                153.26944049035365,
                -27.504650685413385
              ],
              [
                153.27210124169642,
                -27.504117777389865
              ],
              [
                153.27295954858118,
                -27.50267129974585
              ],
              [
                153.27313120995814,
                -27.501224803089613
              ],
              [
                153.2721870723849,
                -27.50015895128286
              ],
              [
                153.2717579189425,
                -27.498027216704283
              ],
              [
                153.27167208825404,
                -27.496504523871504
              ],
              [
                153.273646194089,
                -27.49452499169982
              ],
              [
                153.27244456445032,
                -27.49444885513622
              ],
              [
                153.27141460271835,
                -27.495286353886982
              ],
              [
                153.27064211999232,
                -27.496352253429748
              ],
              [
                153.2699554744845,
                -27.49848402044671
              ],
              [
                153.27004130517298,
                -27.500311216458634
              ],
              [
                153.26875384484583,
                -27.50297582293509
              ],
              [
                153.26746638451868,
                -27.503660997029943
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                153.22918589745814,
                -27.451893664999357
              ],
              [
                153.229700881589,
                -27.4532646444674
              ],
              [
                153.23133166467005,
                -27.45402629236323
              ],
              [
                153.23201831017786,
                -27.457148993738873
              ],
              [
                153.23321993981654,
                -27.457605967010593
              ],
              [
                153.23416407738978,
                -27.4589768754625
              ],
              [
                153.2351940456515,
                -27.461185525448347
              ],
              [
                153.2363098446017,
                -27.463165656783694
              ],
              [
                153.23819811974818,
                -27.464384181465533
              ],
              [
                153.23982890282923,
                -27.46628809931502
              ],
              [
                153.24008639489466,
                -27.468039674691155
              ],
              [
                153.23897059594447,
                -27.474360345647934
              ],
              [
                153.240687209714,
                -27.481670549020844
              ],
              [
                153.24901278649622,
                -27.485401611666774
              ],
              [
                153.2612007442599,
                -27.48631532202739
              ],
              [
                153.26386149560267,
                -27.486772174364923
              ],
              [
                153.26583560143763,
                -27.483802600294943
              ],
              [
                153.26660807763392,
                -27.48273657981658
              ],
              [
                153.26549227868372,
                -27.477406322669378
              ],
              [
                153.26180155907923,
                -27.474208044586383
              ],
              [
                153.25793917809779,
                -27.470019682901192
              ],
              [
                153.25364764367396,
                -27.465907318375997
              ],
              [
                153.25193102990443,
                -27.46278486505833
              ],
              [
                153.25081523095423,
                -27.45996696541042
              ],
              [
                153.24866946374232,
                -27.45783445293626
              ],
              [
                153.24703868066126,
                -27.456006552274026
              ],
              [
                153.2458370510226,
                -27.45166516676444
              ],
              [
                153.2428329769259,
                -27.449303990617356
              ],
              [
                153.24060137902552,
                -27.45014183310048
              ],
              [
                153.23948558007532,
                -27.44998949857694
              ],
              [
                153.23785479699427,
                -27.44884698294413
              ],
              [
                153.23570902978236,
                -27.44877081481449
              ],
              [
                153.23416407738978,
                -27.449760996397114
              ],
              [
                153.23098834191615,
                -27.449913331236257
              ],
              [
                153.22944338952357,
                -27.450827335852896
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        }
      ],
      "coordinates": []
    }),
    doveVisParam = {"opacity":1,"bands":["b3","b2","b1"],"min":100,"max":1800,"gamma":1},
    any_to_trf = 
    /* color: #00d61f */
    /* shown: false */
    /* displayProperties: [
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      }
    ] */
    ee.Geometry.MultiPolygon(
        [[[[152.40290437280305, -24.74894161581136],
           [152.40290437280305, -25.037943939447768],
           [152.58280549584993, -25.037943939447768],
           [152.58280549584993, -24.74894161581136]]],
         [[[152.73659301516446, -25.1908707374599],
           [152.73659301516446, -25.2927281625223],
           [152.91271758791837, -25.2927281625223],
           [152.91271758791837, -25.1908707374599]]],
         [[[153.15471374604112, -25.91553189970146],
           [153.15471374604112, -25.964774887852727],
           [153.2166835031212, -25.964774887852727],
           [153.2166835031212, -25.91553189970146]]],
         [[[153.05408648444467, -26.330582594991967],
           [153.05408648444467, -26.408097753741124],
           [153.14060381842904, -26.408097753741124],
           [153.14060381842904, -26.330582594991967]]],
         [[[153.0829255957728, -26.51137032709747],
           [153.0829255957728, -26.567885059753348],
           [153.12893084479623, -26.567885059753348],
           [153.12893084479623, -26.51137032709747]]],
         [[[153.1074068744673, -26.609523076716957],
           [153.1074068744673, -26.619863254812024],
           [153.12182643013136, -26.619863254812024],
           [153.12182643013136, -26.609523076716957]]],
         [[[153.12257594997482, -26.670012011832583],
           [153.12257594997482, -26.6933260804023],
           [153.15038509304122, -26.6933260804023],
           [153.15038509304122, -26.670012011832583]]],
         [[[153.18772704906007, -27.01093115797346],
           [153.18772704906007, -27.530925109899385],
           [153.4362927228882, -27.530925109899385],
           [153.4362927228882, -27.01093115797346]]],
         [[[153.42839629954835, -27.711312750544167],
           [153.42839629954835, -27.76054060324605],
           [153.47577483958742, -27.76054060324605],
           [153.47577483958742, -27.711312750544167]]],
         [[[153.59379950079494, -28.617190409921513],
           [153.59379950079494, -28.657266591598187],
           [153.6543959668594, -28.657266591598187],
           [153.6543959668594, -28.617190409921513]]],
         [[[152.89168706573037, -25.294188467558573],
           [152.89168706573037, -25.381381430292738],
           [152.92876592315224, -25.381381430292738],
           [152.92876592315224, -25.294188467558573]]]], null, false),
    lagoon = 
    /* color: #00edff */
    /* shown: false */
    ee.Geometry.MultiPolygon(
        [[[[159.06153054827666, -29.448669208356815],
           [159.0574106752298, -29.450911415490875],
           [159.05500741595245, -29.453004097449508],
           [159.0526041566751, -29.457189331883708],
           [159.0526041566751, -29.462420632126108],
           [159.05432077044463, -29.466754933650797],
           [159.05689569109893, -29.469743999184917],
           [159.06084390276885, -29.471836292631636],
           [159.06307550066924, -29.47348020719239],
           [159.06565042132354, -29.474376876626604],
           [159.06753869647002, -29.47617019170192],
           [159.0720018922708, -29.477664596696954],
           [159.07620759600616, -29.47893482362006],
           [159.07981248492217, -29.479009542355104],
           [159.08273072833038, -29.478635948129075],
           [159.085906463804, -29.478635948129075],
           [159.08796640032745, -29.478486510053102],
           [159.0902838289163, -29.477664596696954],
           [159.09260125750518, -29.477963475052135],
           [159.09457536334014, -29.478112913899235],
           [159.0962061464212, -29.478486510053102],
           [159.09783692950225, -29.477515157188872],
           [159.0998110353372, -29.477515157188872],
           [159.10401673907256, -29.477216277511772],
           [159.1086515962503, -29.47594602905246],
           [159.11036821001983, -29.47512409509673],
           [159.11328645342803, -29.47392854290086],
           [159.11465974444366, -29.473554929948154],
           [159.1167196809671, -29.472807699912117],
           [159.11955209368682, -29.471462671968524],
           [159.12281365984893, -29.469743999184917],
           [159.12444444292998, -29.467427481078072],
           [159.12650437945342, -29.465858196809258],
           [159.12890763873077, -29.464139429032215],
           [159.1317400514505, -29.46107546640323],
           [159.1331991731546, -29.458534549142172],
           [159.13517327898956, -29.45487252701243],
           [159.1357740938089, -29.452480931006058],
           [159.13585992449737, -29.448669208356815],
           [159.13551660174346, -29.444334134087732],
           [159.13440080279327, -29.440895840076376],
           [159.13225503558135, -29.43790592453217],
           [159.128049331846, -29.433645142741526],
           [159.12384362811065, -29.430131732036422],
           [159.12118287676788, -29.428412359097837],
           [159.11646218890166, -29.42721625640811],
           [159.11328645342803, -29.427440526735356],
           [159.10890908831573, -29.428337603092405],
           [159.1073212205789, -29.427982511315154],
           [159.10723538989043, -29.42820677995047],
           [159.10710664385772, -29.428449737079923],
           [159.1068706094644, -29.428487115048256],
           [159.1066345750711, -29.428767449372266],
           [159.10637708300567, -29.428898271792004],
           [159.10601230257964, -29.42884220506133],
           [159.10556169146514, -29.428318914082435],
           [159.10545440310455, -29.428337603092405],
           [159.10554023379302, -29.428393670101638],
           [159.1056260644815, -29.428487115048256],
           [159.10487504595733, -29.42781430951369],
           [159.10401673907256, -29.42945893739653],
           [159.10195680254913, -29.42945893739653],
           [159.10006852740264, -29.429608447701685],
           [159.09929605120635, -29.431402554195646],
           [159.10084100359893, -29.43312187651058],
           [159.10247178667998, -29.435663430088002],
           [159.10221429461456, -29.439400893311422],
           [159.10178514117217, -29.444109901071855],
           [159.10006852740264, -29.44754808621145],
           [159.09603448504424, -29.451285111863154],
           [159.09200044268584, -29.453377786114704],
           [159.08350320452666, -29.45644198125441],
           [159.07775254839873, -29.458310347504565],
           [159.071315246763, -29.45913241775328],
           [159.07140107745147, -29.458011411216912],
           [159.07105775469756, -29.45696512727301],
           [159.07157274812315, -29.45595624861479],
           [159.07122941607452, -29.456217774992037],
           [159.07146551419797, -29.45522757602043],
           [159.07180877322173, -29.45496594758735],
           [159.07210926407708, -29.454909909316786],
           [159.07228084200835, -29.45487252701243],
           [159.07202335155475, -29.45498462380088],
           [159.0734610139749, -29.454424107055335],
           [159.07170148486114, -29.45453621223041],
           [159.06963621464197, -29.45514813666041],
           [159.06701298504123, -29.457217370262658],
           [159.06803222292876, -29.45481647462617],
           [159.0681824266336, -29.453844895010793],
           [159.0689656364175, -29.453172256981123],
           [159.06970592135406, -29.452593038328164],
           [159.0698561250589, -29.451714860989888],
           [159.06895487139815, -29.451677484142156],
           [159.0687510391973, -29.451471955377894],
           [159.06859012240386, -29.451098263849037],
           [159.0685257493875, -29.450612457402162],
           [159.06854720705962, -29.450014538582412],
           [159.06607957476592, -29.447622828073136],
           [159.06256051653838, -29.448071278087237]]],
         [[[159.0221797053266, -29.94128318212985],
           [159.0218363825727, -29.944704396170817],
           [159.02355299634223, -29.948274233184762],
           [159.02784453076606, -29.951546471211785],
           [159.03728590649848, -29.95571098205207],
           [159.04724226636176, -29.95809062421233],
           [159.0554820124555, -29.958685525851955],
           [159.0635500971723, -29.960172764374857],
           [159.07007322949653, -29.96225486092296],
           [159.07522307080512, -29.965080493617013],
           [159.07796965283637, -29.96731119952156],
           [159.08380613965278, -29.97132634395972],
           [159.0884409968305, -29.974449121902317],
           [159.09753904980903, -29.978017890782354],
           [159.10474882764106, -29.979207451916324],
           [159.11178694409614, -29.978761368160622],
           [159.1174517695356, -29.975936124517254],
           [159.12260161084419, -29.96597278198766],
           [159.123288256352, -29.958388075477178],
           [159.12225828809028, -29.953182549844936],
           [159.1184817377973, -29.94753052770715],
           [159.1090403620649, -29.940985679695665],
           [159.10303221387153, -29.937564337753514],
           [159.0983973566938, -29.93652303641656],
           [159.09479246777778, -29.93726682419791],
           [159.09307585400825, -29.936374278193053],
           [159.09479246777778, -29.933845354364202],
           [159.093934160893, -29.931167600252937],
           [159.09015761060004, -29.932655250321787],
           [159.0880976740766, -29.93206019296298],
           [159.08672438306098, -29.93072130089561],
           [159.0870677058149, -29.926704516613885],
           [159.0851794306684, -29.923282683620688],
           [159.08140288037544, -29.919265599147412],
           [159.0771113459516, -29.916141088053468],
           [159.07436476392036, -29.913760442364065],
           [159.071961504643, -29.914058026187693],
           [159.06972990674262, -29.91539714238931],
           [159.06715498608833, -29.919116815128174],
           [159.06458006543403, -29.921646113216706],
           [159.06131849927192, -29.92506800246709],
           [159.05393706006294, -29.928341003853674],
           [159.05307875317817, -29.93012623197237],
           [159.04947386426215, -29.93131636626059],
           [159.04775725049262, -29.93087006757044],
           [159.0438090388227, -29.929828696176425],
           [159.04020414990669, -29.929679927944882],
           [159.03436766309028, -29.931167600252937],
           [159.02784453076606, -29.932804014105482],
           [159.02389631909614, -29.937564337753514]]]]),
    exposed = 
    /* color: #0b4a8b */
    /* shown: false */
    ee.Geometry.MultiPolygon(
        [[[[159.1148314058206, -29.429085160670752],
           [159.128049331846, -29.43297237137791],
           [159.13697572344756, -29.44732386029615],
           [159.12942262286163, -29.462869016735937],
           [159.10298677081084, -29.474376876626604],
           [159.0698561250589, -29.47617019170192],
           [159.0540632783792, -29.46451307667907],
           [159.05680986041045, -29.460029214062892],
           [159.06024308794952, -29.45644198125441],
           [159.0650496065042, -29.451060894204925],
           [159.0679678499124, -29.442689747134466],
           [159.06333299273467, -29.438653411673535],
           [159.03827043169952, -29.446277466141105],
           [159.03655381792998, -29.47871066708445],
           [159.07775254839873, -29.501721483818503],
           [159.1313108980081, -29.49977921426631],
           [159.15568681353545, -29.469594548000856],
           [159.14315553301788, -29.42938418216143],
           [159.1122564851663, -29.41667499248816],
           [159.0928587495706, -29.42280550600714],
           [159.0921721040628, -29.43252385465922],
           [159.09818025225616, -29.43252385465922]]],
         [[[159.01428328198676, -29.923133905604825],
           [159.00879011792426, -29.955562252525766],
           [159.0815745417524, -29.98470898683432],
           [159.12723646802192, -29.987385299025686],
           [159.13478956860786, -29.943960663998094],
           [159.07848463696723, -29.902302789039414]]]]),
    missing_to_rc = 
    /* color: #ce5100 */
    /* shown: false */
    ee.Geometry.MultiPolygon(
        [[[[159.0484946848078, -29.45635774367208],
           [159.04755054723455, -29.458375579411225],
           [159.0473788858576, -29.464204657190198],
           [159.04866634618475, -29.467417979897615],
           [159.05347286473943, -29.47362015204956],
           [159.0569060922785, -29.476384853515516],
           [159.05922352086736, -29.47758037674231],
           [159.06686245214178, -29.48161516352954],
           [159.07390056859686, -29.48310948824438],
           [159.08523021947576, -29.48445436164822],
           [159.0975898386164, -29.483856642338885],
           [159.11449848424627, -29.47907476094697],
           [159.13363872777654, -29.466371792985335],
           [159.13938938390447, -29.45710509492194],
           [159.14050518285467, -29.452247213388674],
           [159.14059101354314, -29.444474119160315],
           [159.13956104528143, -29.44215702397093],
           [159.13775860082342, -29.443128715490065],
           [159.13466869603826, -29.458151377422272],
           [159.12557064305975, -29.469360869813322],
           [159.1134514117041, -29.475861807669933],
           [159.0881313586035, -29.482362328641234],
           [159.07002108333495, -29.479448353555576],
           [159.05680315730956, -29.47376959729971],
           [159.05088083980468, -29.466072880456558],
           [159.04950754878905, -29.457478768482265]]],
         [[[159.02747178674548, -29.955696173527308],
           [159.02833009363025, -29.95733218387516],
           [159.0351107180199, -29.960083595105996],
           [159.05004525781482, -29.963429803423647],
           [159.05905748010485, -29.964024673108106],
           [159.06738305688708, -29.966552829543097],
           [159.07854104638903, -29.973095994585343],
           [159.0855791628441, -29.977482648027813],
           [159.093303924807, -29.98060523244554],
           [159.10240197778552, -29.982166487839912],
           [159.10969758630603, -29.982315177549797],
           [159.11364579797595, -29.981423035951206],
           [159.11888146997302, -29.978672215572026],
           [159.12291551233142, -29.97465736801395],
           [159.12523294092028, -29.96960140323009],
           [159.12712121606677, -29.95904252954249],
           [159.12609124780505, -29.952275337620787],
           [159.1236879885277, -29.950639244059904],
           [159.1181948244652, -29.97540087054519],
           [159.10523439050525, -29.979341341054884],
           [159.0955355227074, -29.97778004124948],
           [159.08463502527087, -29.97324469787392],
           [159.06678224206775, -29.963132367246207],
           [159.04111886621325, -29.958819442646057],
           [159.02858758569567, -29.955026888807005]]]]),
    lordh_dove = ee.Image("projects/coral_atlas/workflow/mapping/lord_howe_island/lord_howe_reef_low_tide_normalized_sr_august2018_dec2020_v2_shift_mosaic/20210413T225448Z/lord_howe_reef_low_tide_normalized_sr_august2018_dec2020_v2_shift_mosaic"),
    lh_missing_orf = 
    /* color: #bf04c2 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[159.04300513609223, -31.51989691947226],
          [159.04291930540376, -31.52033592112632],
          [159.04291930540376, -31.52209190711366],
          [159.04176059110932, -31.52256748097169],
          [159.0458804641562, -31.524323425012426],
          [159.04742541654878, -31.525237966127406],
          [159.04759707792573, -31.528347338939845],
          [159.0501290832358, -31.533761058680046],
          [159.05489268644624, -31.537565106408596],
          [159.05841174467378, -31.540893521029414],
          [159.0581193090889, -31.545900017950025],
          [159.05897761597367, -31.547618950559535],
          [159.0611233831856, -31.549886430253178],
          [159.0624966742012, -31.549703571029987],
          [159.06374121918412, -31.54787495909042],
          [159.0649428488228, -31.55054472048973],
          [159.06777526154252, -31.550910435281157],
          [159.06962062134477, -31.551020149439086],
          [159.06923438324662, -31.552190425763634],
          [159.0673031927559, -31.5524464217531],
          [159.06704570069047, -31.554055523318684],
          [159.06867648377153, -31.554933203385158],
          [159.07142306580278, -31.553945812729832],
          [159.0707793356392, -31.55559145801666],
          [159.06871939911576, -31.55745648758421],
          [159.06777526154252, -31.558151292988473],
          [159.06781817688676, -31.559175207309575],
          [159.06859065308305, -31.560000036996055],
          [159.0693202139351, -31.56051198541507],
          [159.07004977478715, -31.560767958570903],
          [159.07039309754106, -31.561901545531484],
          [159.06983519806596, -31.56215751487394],
          [159.07107974304887, -31.564278376687675],
          [159.07082225098344, -31.565485052400113],
          [159.07103682770463, -31.566582016772063],
          [159.07344008698198, -31.56873934239419],
          [159.0740409018013, -31.568519955627554],
          [159.07453442826005, -31.567733815475172],
          [159.07243157639238, -31.56590555693446],
          [159.07214189660414, -31.5653479283908],
          [159.07217408432695, -31.564516056471845],
          [159.07238866248994, -31.563908138127655],
          [159.07241011982234, -31.563391635257105],
          [159.07228137268754, -31.562102664359706],
          [159.0711226583931, -31.559981753071977],
          [159.0727963568184, -31.558756721994932],
          [159.07318259494596, -31.558701869394863],
          [159.07283927216264, -31.558500743319932],
          [159.0727963561623, -31.558208195357885],
          [159.07232428803178, -31.558025352488496],
          [159.07037163986894, -31.557751087445265],
          [159.0704360128853, -31.557184270467392],
          [159.0718096945862, -31.554772677739916],
          [159.07335493406333, -31.55173938105591],
          [159.07185288363712, -31.550596530268233],
          [159.0705010636715, -31.549837665382675],
          [159.0697285874752, -31.549362230408622],
          [159.0683767541317, -31.548557642626673],
          [159.06730387052573, -31.54645470998313],
          [159.06655284944532, -31.546216986309773],
          [159.06560871442832, -31.546070691079425],
          [159.065007899609, -31.54579639089507],
          [159.064471457806, -31.544461451822706],
          [159.06318399747886, -31.541608641314482],
          [159.0618428746987, -31.539139766309578],
          [159.06170341810264, -31.537000070929743],
          [159.0566179498104, -31.534677411541722],
          [159.05642483098407, -31.534531095325],
          [159.05642483076133, -31.533287446006273],
          [159.05655357679404, -31.53226324763505],
          [159.05530903181113, -31.531019563081998],
          [159.0551588281063, -31.52800173023755],
          [159.05636045774497, -31.526117821509512],
          [159.0499875291256, -31.523740018384068],
          [159.0477559312252, -31.522386472647824],
          [159.04691908201255, -31.5224230552229],
          [159.04592129546933, -31.522038940479106],
          [159.04490206083335, -31.521691400999632],
          [159.04410812696494, -31.51997199101901],
          [159.04252025922813, -31.519386652741712]]]),
    lh_missing_irf = 
    /* color: #ff0000 */
    /* shown: false */
    ee.Geometry.MultiPolygon(
        [[[[159.04991883353927, -31.52364253733396],
           [159.0523220928166, -31.52477657525049],
           [159.05614155845382, -31.526130086353742],
           [159.05506867484786, -31.527959124250856],
           [159.05519742088057, -31.531087467088305],
           [159.05644196586348, -31.532257993333833],
           [159.05639905051925, -31.53467215737635],
           [159.0602614315007, -31.536464450914437],
           [159.06163472251632, -31.537049682169396],
           [159.06180638389327, -31.539207690717156],
           [159.0642096431706, -31.543956435965224],
           [159.0649821193669, -31.545931418233323],
           [159.0672137172673, -31.54651659013874],
           [159.0683295162175, -31.54863780753879],
           [159.07141942100264, -31.550393261338545],
           [159.07330769614913, -31.551709830016684],
           [159.07176274375655, -31.554708611548552],
           [159.0702607067082, -31.557231901822018],
           [159.07030362205245, -31.55778043415495],
           [159.07266396598556, -31.558145331556123],
           [159.07309311942794, -31.558693858518033],
           [159.07197732047774, -31.55916924594268],
           [159.0710331829045, -31.55993717435703],
           [159.07141942100264, -31.560814799089375],
           [159.07223481254317, -31.562021519613502],
           [159.07232064323165, -31.563813287954034],
           [159.07210606651046, -31.564873706063448],
           [159.07202023582198, -31.56545875916945],
           [159.07262105064132, -31.566372897299892],
           [159.074723902509, -31.567872064435484],
           [159.0750672252629, -31.56651915856921],
           [159.07553929404952, -31.564873706063448],
           [159.07511014060714, -31.56311852472418],
           [159.07523888663985, -31.561655848376045],
           [159.07609719352462, -31.55799905715488],
           [159.07626885490157, -31.555548926838508],
           [159.07592553214766, -31.55346443695601],
           [159.07446641044356, -31.552074751161474],
           [159.07408017234542, -31.550685044669258],
           [159.07489556388595, -31.54936846153211],
           [159.0745093257878, -31.5482347222793],
           [159.07493847923018, -31.54691810457157],
           [159.0765586396716, -31.545177673585222],
           [159.0770307084582, -31.543495270333104],
           [159.0761294862292, -31.542251735395137],
           [159.07406954970577, -31.540386401925634],
           [159.07261042800167, -31.538301573350154],
           [159.07123713698604, -31.537496890218968],
           [159.06969218459346, -31.534936488659785],
           [159.06754641738155, -31.53215654461134],
           [159.06269698348262, -31.52604769261978],
           [159.0605512162707, -31.525279485344484],
           [159.05956416335323, -31.525133159432837],
           [159.05904917922237, -31.52451127175108],
           [159.05767588820675, -31.523121154902984],
           [159.0576329728625, -31.520816441918296],
           [159.0561738511584, -31.519755523179867],
           [159.0540280839465, -31.519426270087266],
           [159.05351309981563, -31.5201579420506],
           [159.05286936965206, -31.52224317570861],
           [159.05162482466915, -31.52337723061363],
           [159.04986529555538, -31.522170010403265],
           [159.04836325850704, -31.519462853821516],
           [159.0479770204089, -31.518511672075125],
           [159.04746203627803, -31.51810924611341],
           [159.0459599992297, -31.517706818418382],
           [159.0454020997546, -31.517487311672348],
           [159.04368548598507, -31.51781657159802],
           [159.04269843306759, -31.518658008358724],
           [159.04265551772335, -31.519462853821516],
           [159.04355673995235, -31.519755523179867],
           [159.04420047011592, -31.52012135858853],
           [159.04432921614864, -31.52077985871408],
           [159.04480128493526, -31.521657851661363],
           [159.0468612214587, -31.522462671280813],
           [159.04767661299923, -31.522462671280813]]],
         [[[159.06488789315028, -31.513903725333165],
           [159.0639008402328, -31.51576958779561],
           [159.06394375557704, -31.516903721282304],
           [159.06514538521571, -31.517854919398516],
           [159.06789196724696, -31.51844026727225],
           [159.0687073587875, -31.517781750656443],
           [159.06965149636073, -31.51745249060807],
           [159.07033814186855, -31.51712322939937],
           [159.07261265511318, -31.517598828550593],
           [159.07317055458827, -31.518367098988588],
           [159.0743292688827, -31.521440117566385],
           [159.07381428475185, -31.523159500526162],
           [159.07484425301357, -31.52473252530001],
           [159.0747584223251, -31.52550073707373],
           [159.07493008370204, -31.526634752430358],
           [159.07587422127528, -31.52729320664178],
           [159.07681835884853, -31.52729320664178],
           [159.07874954933925, -31.526561590564768],
           [159.07973660225673, -31.52630552358391],
           [159.07618391276344, -31.521805946378343],
           [159.072321531782, -31.51697689071196],
           [159.06871664286598, -31.51580617296166],
           [159.06545507670387, -31.510464587099733]]],
         [[[159.09390794993385, -31.548544151966524],
           [159.0944229340647, -31.549385311877145],
           [159.09523832560524, -31.5496413155624],
           [159.09605371714576, -31.54986074673362],
           [159.0963112092112, -31.550738466258593],
           [159.09695493937477, -31.551213894220822],
           [159.09785616160377, -31.55183560405486],
           [159.09725534678444, -31.547629839116237],
           [159.09549581767067, -31.54613034665003],
           [159.09468042613014, -31.546240066427895],
           [159.09287798167213, -31.546971528317364]]],
         [[[159.09781324625953, -31.55271330500378],
           [159.09656870127662, -31.553115581846114],
           [159.09545290232643, -31.55377384930155],
           [159.09545290232643, -31.554285831889402],
           [159.09751283884987, -31.555382927974225],
           [159.09772741557106, -31.55600461002904],
           [159.097899076948, -31.556845702685735],
           [159.09819948435768, -31.55779649394902],
           [159.09815656901344, -31.559295798944188],
           [159.0986715531443, -31.559186094517734],
           [159.09931528330787, -31.55823531741754],
           [159.0997873520945, -31.55732109952868],
           [159.09862863780006, -31.555017230712707]]]]),
    lh_to_brs = 
    /* color: #00ff00 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[159.06109190747907, -31.517337643098465],
          [159.06890250013043, -31.52063019541464],
          [159.07508230970075, -31.530946107901322],
          [159.07825655922124, -31.536939842965438],
          [159.08443636879156, -31.54440122867222],
          [159.09070200905035, -31.547985407770383],
          [159.09748263344, -31.560638653411843],
          [159.1011733530445, -31.55968789111699],
          [159.10057253822515, -31.548497422119333],
          [159.08126063331792, -31.523185922539273],
          [159.06512446388433, -31.507015160290557],
          [159.06177706703374, -31.506941983061022],
          [159.0586013315601, -31.508990923832716],
          [159.05439562782476, -31.512356943305548]]]),
    near_shore = 
    /* color: #d63000 */
    /* shown: false */
    ee.Geometry({
      "type": "GeometryCollection",
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                152.91743742549227,
                -25.29147947502139
              ],
              [
                152.9524563463907,
                -25.3132065025735
              ],
              [
                152.97236906611727,
                -25.33368841712274
              ],
              [
                153.00807463252352,
                -25.365335467533423
              ],
              [
                153.03622709834383,
                -25.3423766672966
              ],
              [
                153.03210722529695,
                -25.302653861384456
              ],
              [
                152.9469631823282,
                -25.25608712551669
              ],
              [
                152.90576445185945,
                -25.262918031746963
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                153.43606285007624,
                -27.03286797795872
              ],
              [
                153.45219940841855,
                -27.033479428120078
              ],
              [
                153.44670624435605,
                -27.06894797836747
              ],
              [
                153.4659323185748,
                -27.073839312119354
              ],
              [
                153.48103851974668,
                -27.022469667799992
              ],
              [
                153.45631928146543,
                -27.009011828658632
              ],
              [
                153.43434662521543,
                -27.023693027796707
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                153.51142258346738,
                -27.43977452142616
              ],
              [
                153.55811447799863,
                -27.440993304569563
              ],
              [
                153.55828613937558,
                -27.410976854802282
              ],
              [
                153.5160574406451,
                -27.409300568872272
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        }
      ],
      "coordinates": []
    }),
    sg_to_ca = 
    /* color: #0e6b00 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[153.2391625102938, -27.44417998978635],
          [153.245685642618, -27.442656552753373],
          [153.25186545218833, -27.414621557795236],
          [153.2501488384188, -27.3624941309841],
          [153.2731514629305, -27.333523837160925],
          [153.2504921611727, -27.31644306305943],
          [153.22937781180747, -27.33169388007416],
          [153.23126608695395, -27.35166927619836],
          [153.23933417167075, -27.361579395457195],
          [153.22697455253012, -27.37148862775021],
          [153.2171898540438, -27.388560915754713],
          [153.21581656302817, -27.41980247347306],
          [153.23298270072348, -27.443570617497432]]]);
/***** End of imports. If edited, may not auto-convert in the playground. *****/
///////////////////////////////
// Global coral atlas project - Subtropical Eastern Australia
// Contact: mitchell.lyons@gmail.com
// Region coordinator: Mitchell Lyons
// Description:
// - Developing a process to combine OBIA and supervised classification
// - This script loads the raw classification data (from *_classification script)
// - Then applied some cleanup and object-based relational rules
///////////////////////////////

// Table of contents
// 1. Setting constants
// 2. Data loads & vis
// 3. OBIA clean up rules
// 4. Export

// Load and libraries needed
var map_palettes = require('users/mitchest/global_reefs_modules:colour_pals');
var pkg_vis = require('users/mitchest/global_reefs_modules:pkg_vis');
var param_module = require('users/mitchest/global_reefs_modules:reef_params');

// ###########################################
// SENSOR GENERICS
var sensor_params = param_module.dove;         //<------------ THIS IS WHERE YOU CHOOSE THE SENSOR
// REGION AND SENSOR SPECIFIC LOAD PATHS
var region_params = param_module.subtropical_eastern_australia;  //<------------ THIS IS WHERE YOU CHOOSE THE REGION
//  ^^ all the data paths are in this module ^^
// ###########################################

// 1. Setting constants

// These will get written to the asset metadata 

var vars = {
  
  // analysis type
  geomorphic: false, // map geomorphic zonation (when set to true) or benthic habitat (when set to false)

  // analysis parameters
  image_data_scale: sensor_params.pixel,
  small_object_geo: ee.Number(400).int(), // smallest object szie in pixels (geomorphic)
  small_object_benthic: ee.Number(130).int(), // smallest object szie in pixels (benthic)
  smooth_radius: ee.Number(3), // radius in pixels for initial smooth 
  dist_to_land_ORF: 1000, //distance to land in meters to convert terrestrial reef flat to ORF
  dist_to_land_RC: 500, //distance to land in meters to convert reef crest to TRF - not used for Indo
  wave_height: 0.4, //cut off height for waves in metres, Hs95 threshold
  geo_depth_cutoff: 1500, //depth in centimetres
  shallowlag_depth_cutoff: 500, //depth in centimetres
  benthic_depth_cutoff: 1000, //depth in centimetres
  
  //############
  // Clean-up stage selection
  cleanup_stage: 2, // set to 1, 2 or 3
  geo_refinement: false, // set to true to apply the refinement_mask (the other stage 3 masks will still run)
  
  // should the global extent + depth cleanup be applied?
  global_extent_clean: false,
  global_depth_thresh: 500, // this is the depth limit for ADDING to the global extent (i.e. 5 = everything <5m will be added to the global extent layer)
  global_land_dist: -1, // [-1 (don't apply) OR +ve distance in meters] WITHIN this distance, the global extent/depth mask will be applied
  global_not_applied: true, // true = EXCLUDE reefs within 'global_not_applied' geometry polygons - mutually exclusive to land distance rule
 
  /*
  - GEOMORPHIC 1: The first pass does a small object filter, just to generally clean noise and reduce the amount of cleaning needed
  -            2: The second pass runs the OBIA cleanup rules
  -            3: The third pass is the MANUAL cleanup stage, which includes AT LEAST the no_reef masking
                        - see below where it starts/ends (only that section is run)
                        - please put region specific stuff in here ONLY

  - BENTHIC 1: This is the main benthic stge - it does noise removal, no data reclaim and OBIA rules - review those if needed
            2: The second mas is the MANUAL stage - it's optional, but shuold include ALL region specific stuff
                        - see below where it starts/ends (only that section is run)
                        - please put region specific stuff in here ONLY
  */
  
  // DON'T TOUCH --->
  obia_2nd_pass: null,
  obia_clean: null, // run object-based relationship rules + small object clean up
  fast_clean: null, // run a faster (but less precise) version of the OBIA clean; only applies to geomorphic (`obia_clean: true` also)
  manual_clean: false, // apply manual touch ups
  // --------------<
  //############
  
  reproject_display: true,
  
  // export options
  do_export: true, // export the results?
  geomorph_output_name: region_params.sname + '_geo_clean', // DO NOT CHANGE - change in the pop up dialouge if you must
  benthic_output_name: region_params.sname + '_benthic_clean', // DO NOT CHANGE - change in the pop up dialouge if you must
  asset_output: region_params.asset // asset path

};


// Clean up stage auto-parameterisation (DON'T TOUCH) --->

if (vars.geomorphic) {
  var temp_outname = vars.geomorph_output_name;
  if (vars.cleanup_stage == 1) {
    vars.obia_2nd_pass = false;
    vars.obia_clean = false;
    vars.fast_clean = true;
    vars.manual_clean = false;
    vars.geomorph_output_name = temp_outname + '1';
  } else if (vars.cleanup_stage == 2) {
    vars.obia_2nd_pass = true;
    vars.obia_clean = true;
    vars.fast_clean = true;
    vars.manual_clean = false;
    vars.geomorph_output_name = temp_outname + '2';
  } else if (vars.cleanup_stage == 3) {
    vars.manual_clean = true;
    vars.obia_2nd_pass = false;
    vars.obia_clean = false;
    vars.fast_clean = false;
    vars.do_export = false;
    vars.geomorph_output_name = temp_outname + '3';
  }
}

if (!vars.geomorphic) {
  var temp_outname = vars.benthic_output_name;
  if (vars.cleanup_stage == 1) {
    vars.obia_2nd_pass = true,
    vars.obia_clean = true, 
    vars.fast_clean = false, 
    vars.manual_clean = false;
    vars.benthic_output_name = temp_outname + '1';
  } else if (vars.cleanup_stage == 2) {
    vars.manual_clean = true;
    vars.obia_2nd_pass = false,
    vars.obia_clean = false, 
    vars.fast_clean = false,
    vars.do_export = false;
    vars.benthic_output_name = temp_outname + '2';
  }
}

//Region extent is created in map viewer and exported to GEE asset
var region_extent = ee.FeatureCollection(region_params.extent_mask).geometry();
Map.addLayer(region_extent, {}, "Manual reef outline", false);
// -----------------------------------------<

//################################################################################################
//START OF CLEAN 3 - Manual Cleanup
//Review everything in this section
//This is the section to add/remove manual cleanups
//You MUST review it for each region

//###############################################################################################

if (vars.manual_clean && vars.geomorphic) {
  
  print("Doing GEOMORPHIC manual clean ups - make sure this is what you want to do");
  print("Export the manual map, check 'manual' layer in the viewer for effects");
  
  var depth = ee.Image(region_params.pixels).select('depth');
  
  // define the manually edited map - uses the output from the second pass of cleaning
  var man_geo = ee.Image(region_params.geo_map_clean2);
  //var man_geo = ee.Image(region_params.geo_map_clean2).clip(indo_west); // use this when testing for a small area
  
  // the "GLOBAL MASK" clean
  // currently uses GCRMN extent + bathymetry threhold < vars.global_depth_thresh
  if (vars.global_extent_clean) {
    var blanket_mask = ee.Image([param_module.global_extent_mask.gcrmn]).unmask(0, false)
              .eq(1) // extent according to global extent layer
              .add(depth.lt(vars.global_depth_thresh)) // combine with areas less than depth thrshold
              .eq(0) // get leftovers
              .selfMask().connectedPixelCount(25, true).gte(25)
    
    if (vars.global_land_dist > 0) {
      var distToLand = ee.Image(region_params.distToLand);
      man_geo = man_geo.where({
        test: blanket_mask.eq(1)
                          .and(distToLand.lte(vars.global_land_dist)),
        value: ee.Image(0)
      });
    } else if (vars.global_not_applied) {
      var global_not_applied_i = ee.Image().byte().paint(ee.Feature(global_not_applied, {zone: 1}), 'zone').unmask(0, false)
      man_geo = man_geo.where({
        test: blanket_mask.eq(1)
                          .and(global_not_applied_i.eq(0)),
        value: ee.Image(0)
      });
    } else {
      man_geo = man_geo.where({
        test: blanket_mask.eq(1),
        value: ee.Image(0)
      });
    }
  }
  
  /* #### SPECIAL CASE ####
  - This is a special case for the mid mask, since the region has such little reef
  - Here we draw areas that we want to KEEP
  - ALL of the remaining areas will be masked out
  - Don't use this as a template unless you have a similar scenario of needing to onyl keep very very areas 
  */
  var mid_mask = region_extent.difference(keep_mask);
  var midmask = ee.Image().byte().paint(ee.Feature(mid_mask.dissolve(),{zone: 1}), "zone");//.clip(mid_mask.dissolve());
  Map.addLayer(midmask, {}, "mid mask raster", false);
  // #############
  
  
  // the "MID MASK" CLEAN
  man_geo = man_geo.where({
    test: midmask.eq(1),
    value: ee.Image(0)
  });
  
  /*
  // the "REEF MASK" CLEAN
  // Define a kernel for reef mask Morphological Operations
  var kernel_rm = ee.Kernel.circle({radius: vars.smooth_radius.multiply(5)});

  // Create reef mask to clean areas inside the reef - Perform an dilation of deepwater
  var reef_mask = man_geo.eq(2)
            .focal_max({kernel: kernel_rm, iterations: 2});
  
  // Reef crest, slope, sheltered slope (within reef mask) -> Inner reef flat
  man_geo = man_geo.where({
    test: reef_mask.eq(0)
                    .and(man_geo.eq(15).or(man_geo.eq(21)).or(man_geo.eq(22))),
    value: ee.Image(13)
  });
  
  // the "DEEP WATER" CLEAN
  
  // Define a kernel for deep water Morphological Operations
  var kernel_dw = ee.Kernel.circle({radius: vars.smooth_radius.multiply(5)});

  // Create mask to clean deepwater areas - Perform an dilation of deepwater followed by a erosion
  var deepwater = man_geo.eq(2)
           .focal_max({kernel: kernel_dw, iterations: 2})
           .focal_min({kernel: kernel_dw, iterations: 2});
    
  
  // Deep lagoon (outside reef mask and global mask) -> deepwater 
  man_geo = man_geo.where({
    test: deepwater.eq(1)
                   .and(man_geo.eq(12)),
    value: ee.Image(2)
  });
  
  
  // Reef classes in deepwater -> deepwater
  man_geo = man_geo.where({
    test: deepwater.eq(1)
                   .and(man_geo.eq(15).or(man_geo.eq(21)).or(man_geo.eq(22)).or(man_geo.eq(24))),
    value: ee.Image(2)
  });
  
  
  // WAVE clean (un-comment this sectio nbased on whether you have waves or not)
  
  var waves = ee.Image(region_params.waves)
  Map.addLayer(waves.lt(vars.wave_height), {}, vars.wave_height + "m Hs95 threshold", false)
  
  man_geo = man_geo.where({
    test: waves.lte(vars.wave_height)
               .and(man_geo.eq(22)),
    value: ee.Image(21)
  })
  */
  
  // use a distance to deepwater to cut out RC/slope - note used for SEA (not enough reef and not enough DW offshore cause Dove only)
  /*
  var dist_to_deep = man_geo.eq(2).fastDistanceTransform(256).sqrt()
                                  .multiply(ee.Image.pixelArea().sqrt())
                                  .uint16()
                                  .selfMask();
  Map.addLayer(dist_to_deep, {}, "distance to deepwater", false);
  
  man_geo = man_geo.where({
    test: man_geo.eq(15)
                 .and(dist_to_deep.gte(300)),
    value: ee.Image(14)
  });
  
  man_geo = man_geo.where({
    test: man_geo.eq(21).or(man_geo.eq(22))
                .and(dist_to_deep.gte(1500)),
    value: ee.Image(24)
  });
  */
  
  /*
  ##############
  
  The rest of the manual geometry paintings and rules should go here
      - make the geom, paint the layer, use it in a rule
      - consult previous regions *_cleanup script for ideas/hints/existing rules etc.
  e.g. 
  var notreefcrest = ee.Image().byte().paint(ee.Feature(not_reef_crest, {zone: 1}), "zone").clip(not_reef_crest);
  var notdeepwater = ee.Image().byte().paint(ee.Feature(not_deep_water, {zone: 1}), "zone").clip(not_deep_water);
  
  
  // Reef crest -> Inner reef flat (inside the reef)
  man_geo = man_geo.where({
    test: notreefcrest.eq(1)
                     .and(man_geo.eq(15)),
    value: ee.Image(13)
  });
  
  // Deep water -> Deep lagoon (inside the reef)
  man_geo = man_geo.where({
    test: notdeepwater.eq(1)
                     .and(man_geo.eq(2)),
    value: ee.Image(12)
  });
  
  ##############
  */
  
  // turn all near-shore areas within geoms to TRF (it's the only sensible class?)
  var any_to_trf_i = ee.Image().byte().paint(ee.Feature(any_to_trf, {zone: 1}), "zone");
  man_geo = man_geo.where({
    test: man_geo.gt(2)
                 .and(any_to_trf_i.eq(1)),
    value: ee.Image(16)
  });
  
  // make TRF or RS from anything not connected to land
  var near_shore_i = ee.Image().byte().paint(ee.Feature(near_shore, {zone: 1}), "zone");
  man_geo = man_geo.where({
    test: near_shore_i.eq(1)
                      .and(man_geo.gt(20)),
    value: ee.Image(22)
  });
  man_geo = man_geo.where({
    test: near_shore_i.eq(1)
                      .and(man_geo.lt(20).and(man_geo.gt(2))),
    value: ee.Image(16)
  });
  
  
  // ########### Elizabeth and Middleton 
  var lagoon_i = ee.Image().byte().paint(ee.Feature(lagoon, {zone: 1}), "zone")
  var exposed_i = ee.Image().byte().paint(ee.Feature(exposed, {zone: 1}), "zone")
  var missing_i = ee.Image().byte().paint(ee.Feature(missing_to_rc, {zone: 1}), "zone")
  
  // BRS exposed -> RS
  man_geo = man_geo.where({
    test: exposed_i.eq(1)
                   .and(man_geo.eq(24).or(man_geo.eq(21))),
    value: ee.Image(22)
  });
  
  // RC/ORF/slopes within lagoon -> IRF
  man_geo = man_geo.where({
    test: lagoon_i.eq(1)
                  .and(man_geo.eq(15).or(man_geo.eq(14)).or(man_geo.eq(21)).or(man_geo.eq(22))),
    value: ee.Image(13)
  });
  
  // Gain back missing reef crest
  man_geo = man_geo.unmask(0, false).where({
    test: missing_i.eq(1)
                   .and(man_geo.unmask(0, false).eq(0)),
    value: ee.Image(15)
  }).selfMask();
  
  
  // ######### Lord Howe Is
  var missing_irf = ee.Image().byte().paint(ee.Feature(lh_missing_irf, {zone: 1}), "zone")
  var missing_orf = ee.Image().byte().paint(ee.Feature(lh_missing_orf, {zone: 1}), "zone")
  var to_brs = ee.Image().byte().paint(ee.Feature(lh_to_brs, {zone: 1}), "zone")
  
  // missing or ORF -> IRF
  man_geo = man_geo.unmask(0, false).where({
    test: missing_irf.eq(1)
                     .and(man_geo.unmask(0, false).eq(0).or(man_geo.unmask(0, false).eq(14))),
    value: ee.Image(13)
  }).selfMask();
  
  // missing -> ORF
  man_geo = man_geo.unmask(0, false).where({
    test: missing_orf.eq(1)
                     .and(man_geo.unmask(0, false).eq(0)),
    value: ee.Image(14)
  }).selfMask();
  
  // stuff -> BRS
  man_geo = man_geo.where({
    test: to_brs.eq(1)
                .and(man_geo.eq(11).or(man_geo.eq(14)).or(man_geo.eq(15)).or(man_geo.eq(21)).or(man_geo.eq(22))),
    value: ee.Image(24)
  });
  
  
  
  //mask to deep and anything removed to this point
  man_geo = man_geo.updateMask(man_geo.gt(2)).selfMask()
  
  if (vars.geo_refinement) {
    // make the mask image layer
    var refine = ee.Image().byte().paint(ee.Feature(refinement_mask, {zone: 1}), "zone")//.clip(refinement_mask);
    // apply
    man_geo = man_geo.where({
      test: refine.eq(1),
      value: ee.Image(0)
    });
  }
  
  // Add data + the manual layer to the map
  var lowtide_image = ee.Image(region_params.pixels).select(['b1','b2','b3']);
  Map.addLayer(lowtide_image, doveVisParam, sensor_params.sname + ' low tide', false);
  Map.addLayer(lordh_dove, doveVisParam, 'lord howe dove', false);
  
  var geo_clean1 = ee.Image(region_params.geo_map_clean1);
  Map.addLayer(geo_clean1, map_palettes.geo, 'Geo clean stage 1', false);
  var geo_clean2 = ee.Image(region_params.geo_map_clean2);
  Map.addLayer(geo_clean2, map_palettes.geo, 'Geo clean stage 2', false);
  Map.addLayer(man_geo.updateMask(man_geo), map_palettes.geo, 'Geo clean stage 3', false);
  //Map.addLayer(global_reef_mask.updateMask(global_reef_mask.eq(1)), {palette: ['F8FF23'], opacity: 0.4}, 'global_reef_mask - land', false);
  //Map.addLayer(global_reef_mask.updateMask(global_reef_mask.eq(3)), {palette: ['0000ff'], opacity: 0.4}, 'global_reef_mask - reef', false);
  //Map.addLayer(global_reef_mask.updateMask(global_reef_mask.eq(2)), {palette: ['FF0000'], opacity: 0.4}, 'global_reef_mask - water', false);

  // display distance to land mask for assessing cut-off distances
  var distToLand = ee.Image(region_params.distToLand);
    
  //Map.addLayer(distToLand.lte(vars.dist_to_land_RC), {}, 'RC to TRF ' + vars.dist_to_land_RC + 'm', false);
  Map.addLayer(distToLand.unmask(100000, false).lte(vars.dist_to_land_ORF), {}, 'TRF to ORF ' + vars.dist_to_land_ORF + 'm', false);
  
  // display distance to water mask
  var distToWater = ee.Image(region_params.distToWater);
    
  Map.addLayer(distToWater.unmask(100000, false).lte(vars.dist_to_land_ORF), {}, 'distToWater ' + vars.dist_to_land_ORF + 'm', false);
  
  
  // Export
  var output_name = (vars.geomorphic) ? vars.geomorph_output_name : vars.benthic_output_name;
  Export.image.toAsset({
    image: man_geo,
    description: output_name,
    assetId: vars.asset_output + 'in_out/' + output_name,
    region: region_extent,
    scale: vars.image_data_scale,
    crs: 'EPSG:4326',
    maxPixels: 1e13,
    pyramidingPolicy: {'.default': 'mode'}
  });
  
} 

if (vars.manual_clean && !vars.geomorphic) {
  
  print("Doing BENTHIC manual clean ups - make sure this is what you want to do");
  print("Export the manual map, check 'manual' layer in the viewer for effects");
  
  var depth = ee.Image(region_params.segments).select('depth');
  
  // define the final geomorphic map (the manually edited geo map - stage 3)
  var geo_map = ee.Image(region_params.geo_map_clean3);
  
  // define the clean benthic map to apply 2nd stage rules to
  var man_benthic = ee.Image(region_params.benthic_map_clean1);
  
  // extra depth cutoff refinement
  man_benthic = man_benthic.where({
          test: depth.gt(vars.benthic_depth_cutoff),
          value: ee.Image(0)
        });
  
  /*
  **Generic benthic rules**
    - should be generally applicable, but still review
  */
  
  /*
  // BMA on inner RF, outer RF,reef crest, reef slope -> rubble 
  man_benthic = man_benthic.where({
    test: man_benthic.eq(18)
                     .and(geo_map.eq(13).or(geo_map.eq(14)).or(geo_map.eq(15)).or(geo_map.eq(22))),
    value: ee.Image(12)
  });
  */
  
  // Rubble on Outer reef flat and Reef crest -> rock 
  man_benthic = man_benthic.where({
    test: man_benthic.eq(12)
                     .and(geo_map.eq(14).or(geo_map.eq(15))),
    value: ee.Image(13)
  });
    
  // Seagrass on RC or ORF -> Coral/Algae
  man_benthic = man_benthic.where({
    test: man_benthic.eq(14)
                     .and(geo_map.eq(14).or(geo_map.eq(15))),
    value: ee.Image(15)
  });
  
  // Seagrass on slope or plateau -> Coral/Algae
  man_benthic = man_benthic.where({
    test: man_benthic.eq(14)
                     .and(geo_map.eq(23).or(geo_map.eq(22))),
    value: ee.Image(15)
  });
  
  // Sand on RC or reef slope -> Coral/Algae
  man_benthic = man_benthic.where({
    test: man_benthic.eq(11)
                     .and(geo_map.eq(15).or(geo_map.eq(22))),
    value: ee.Image(15)
  });
  
  // Sand on ORF -> rubble
  man_benthic = man_benthic.where({
    test: man_benthic.eq(11)
                     .and(geo_map.eq(14)),
    value: ee.Image(12)
  });
  
    
  /*
  
  **Manual polygon guided rules**
   - same as per geomorphic clean section
   - add a geometry, paint the layer, create a rule
  .
  */
  
  var any_to_trf_i = ee.Image().byte().paint(ee.Feature(any_to_trf, {zone: 1}), "zone")
  // any terrestrial rock/rubble -> sand
  man_benthic = man_benthic.where({
    test: any_to_trf_i.eq(1)
                      .and(man_benthic.eq(12).or(man_benthic.eq(13))),
    value: ee.Image(11)
  });
  
  var sg_to_ca_i = ee.Image().byte().paint(ee.Feature(sg_to_ca, {zone: 1}), "zone")
  // coral/algae to seagrass
  man_benthic = man_benthic.where({
    test: sg_to_ca_i.eq(1)
                    .and(man_benthic.eq(14)),
    value: ee.Image(15)
  });
  
  
  // #### special add for missing data on Elizabth and Middleton
  var missing_i = ee.Image().byte().paint(ee.Feature(missing_to_rc, {zone: 1}), "zone")
  // Gain back missing reef crest
  man_benthic = man_benthic.unmask(0, false).where({
    test: missing_i.eq(1)
                   .and(geo_map.eq(15)),
    value: ee.Image(15)
  }).selfMask();
  
  // #### special add for missing data on Lord Howe
  var missing_combined = ee.FeatureCollection(lh_missing_irf).merge(ee.FeatureCollection(lh_missing_orf)).merge(ee.FeatureCollection(lh_to_brs)).geometry().dissolve()
  var missing_combined_i = ee.Image().byte().paint(ee.Feature(missing_combined, {zone: 1}), "zone")
  // Gain back missing reef crest
  man_benthic = man_benthic.unmask(0, false).where({
    test: missing_combined_i.eq(1)
                            .and(geo_map.gt(2))
                            .and(man_benthic.unmask(0, false).eq(0)),
    value: ee.Image(15)
  }).selfMask();
  
  
  // final smooth for missing data due to depth
  man_benthic = man_benthic.focal_mode(2)
                           .selfMask()
  
  
  // Add the manual layer to the map

  var dove_image = ee.Image(region_params.pixels).select(['b1','b2','b3']);
  Map.addLayer(dove_image, doveVisParam, sensor_params.sname + ' low tide', true);
  Map.addLayer(lordh_dove, doveVisParam, 'lord howe dove', false);
  
  var benthic_clean1 = ee.Image(region_params.benthic_map_clean1);
  var geo_clean1 = ee.Image(region_params.geo_map_clean1);
  var geo_clean2 = ee.Image(region_params.geo_map_clean2);
  Map.addLayer(geo_clean1, map_palettes.geo, 'Geo clean stage 1', false);
  Map.addLayer(geo_clean2.updateMask(geo_clean2.gt(2)), map_palettes.geo, 'Geo clean stage 2', false);
  Map.addLayer(geo_map.updateMask(geo_map.gt(2)), map_palettes.geo, 'Geo clean stage 3 - MANUAL', true);
  Map.addLayer(benthic_clean1, map_palettes.benthic, 'Benthic clean stage 1', false);
  Map.addLayer(man_benthic.reproject({crs:'EPSG:4326', scale: 5}), map_palettes.benthic, 'Benthic clean stage 2 - MANUAL', true);
  
  // Export
  var output_name = (vars.geomorphic) ? vars.geomorph_output_name : vars.benthic_output_name;
  Export.image.toAsset({
    image: man_benthic,
    description: output_name,
    assetId: vars.asset_output + 'in_out/' + output_name,
    region: region_extent,
    scale: vars.image_data_scale,
    crs: 'EPSG:4326',
    maxPixels: 1e13,
    pyramidingPolicy: {'.default': 'mode'}
  });
  
}

// #################################################################################################
// END OF MANUAL SECTION
// #################################################################################################


// 2. Data loads & vis

if (!vars.manual_clean) {

  // load input data
  
  // define raw geo/benthic outputs
  // Run check to see if the region has been split into multiple areas
  
  // geo
  if (ee.List(region_params.geo_map).length().getInfo() > 1) {
    var geo_map_raw = ee.Image(region_params.geo_map[0]).unmask(0, false)
                 .add(ee.Image(region_params.geo_map[1]).unmask(0,false))
                 .selfMask();
  } else {
    var geo_map_raw = ee.Image(region_params.geo_map);
  }
  
  // benthic
  if (ee.List(region_params.benthic_map).length().getInfo() > 1) {
      var benthic_map = ee.Image(region_params.benthic_map[0]).unmask(0, false)
               .add(ee.Image(region_params.benthic_map[1]).unmask(0,false))
               .selfMask();
  } else {
      var benthic_map = ee.Image(region_params.benthic_map);
  }
  
  // set the geo map for further processing
  if (vars.geomorphic && vars.obia_2nd_pass) {
    // if it's 2nd pass, you want to make sure you're loading the latest geo clean map
    var geo_map = ee.Image(region_params.geo_map_clean1);
  } else if (vars.geomorphic) {
    var geo_map = geo_map_raw;
  }
  
  var depth = ee.Image(region_params.pixels).select('depth');
  var low_tide_image = ee.Image(region_params.pixels).select(['b1','b2','b3']);
  
  var display_pal = (vars.geomorphic) ? map_palettes.geo : map_palettes.benthic;
  Map.addLayer(depth, {min:0, max:2500}, 'Depth data', false);
  Map.addLayer(low_tide_image, doveVisParam, sensor_params.sname + ' low tide', false);
  
  // load for display purposes
  if (vars.geomorphic) {
    Map.addLayer(geo_map_raw, display_pal, 'Geomorphic map RAW', false);
    if (vars.cleanup_stage == 2) Map.addLayer(ee.Image(region_params.geo_map_clean1), display_pal, 'Geo clean stage 1', false);
  }
  if (!vars.geomorphic) {
    // Use the manually cleaned geomorphic map as input for the benthic clean
    var geo_map = ee.Image(region_params.geo_map_clean3);
    Map.addLayer(geo_map.updateMask(geo_map.gt(2)), map_palettes.geo, 'Geo clean stage 3', false);
    Map.addLayer(benthic_map, display_pal, 'Benthic map RAW', false);
  }
  
  // 3. Object-based re-classificaiton and cleaning
  
  /* OUTPUT EXTENT
    - to the mapping extent just so it doesn't balloon out
    - to the 'reef boundary' extent for noise/deep removal
  */  
  var class_extent_mask = geo_map.gt(0);
  
  /*
  
  ########
  Initial small object clean
   - this was originally at the end, but we needed to massively reduce the number of objects to 
     iterate through in the OBIA cleaning, so this happens first now
   - future collabs with google might fix this, but need to change the parallel serialisation of vector procesing
   
   - includes a possible special case for:
        - geomorphic to clean up turbid areas over size threshold; fix shallow vs. deep lagoon
        - benthic to allow breaking waves (temporal class) to grow into surrounding class
  ########
  
  */
  
  // ##############################################################################################
  // START OF CLEAN 1
  // ##############################################################################################
  
  if (vars.geomorphic && !vars.obia_2nd_pass) {
    
    // shallow lagoon > 5m == deep lagoon
    geo_map = geo_map.where({
      test: geo_map.eq(11)
                    .and(depth.gt(vars.shallowlag_depth_cutoff)),
      value: ee.Image(12)
    });
    
    // deep water in depth data == deep (s2 + ls8 data should be good enough for this)
    geo_map = geo_map.where({
      test: depth.gt(vars.geo_depth_cutoff),
      value: ee.Image(2)
    });
    
    // make a smooth map with masked area as a value - *** Change to ee.kernal*** see reef mask in clean 3
    var smooth_map = geo_map
                        .focal_mode({
                          radius: vars.smooth_radius, // relates to smoothness required
                          kernelType: 'circle', units: 'pixels', iterations: 2
                        });
    
    // replace small objects with smooth underneath
    var clean_map = geo_map.where({
      test: geo_map.connectedPixelCount(vars.small_object_geo, false).lt(vars.small_object_geo), 
      value: smooth_map
    }).updateMask(class_extent_mask);
    
    // display distance to land mask for assessing cut-off distances
    var distToLand = ee.Image(region_params.distToLand);
    
    Map.addLayer(distToLand.lte(vars.dist_to_land_RC), {}, 'RC to TRF ' + vars.dist_to_land_RC + 'm', false);
    Map.addLayer(distToLand.unmask(100000, false).lte(vars.dist_to_land_ORF), {}, 'TRF to ORF ' + vars.dist_to_land_ORF + 'm', false);

    // // reef crest close to land -> TRF - Not need when using .focal masks (reef mask) as this will take care of RC inside the reef
    // clean_map = clean_map.where({
    //   test: distToLand.lte(vars.dist_to_land_RC)
    //                 .and(clean_map.eq(15)),
    //   value: ee.Image(16)
    // });
    
    // TRF outside of specified distance from land -> ORF
    clean_map = clean_map.where({
      test: distToLand.unmask(100000, false).gt(vars.dist_to_land_ORF)
                       .and(clean_map.eq(16)),
      value: ee.Image(14)
    });
  }
  
  if (!vars.geomorphic && vars.cleanup_stage == 1) {
    
    // make a smooth map with masked area as a value, and without temporal class (basically breaking waves)
    var smooth_map = benthic_map
                        .focal_mode({
                          radius: vars.smooth_radius, // relates to smoothness required
                          kernelType: 'circle', units: 'pixels', iterations: 1
                        });
    
    //replace small objects with smooth underneath
    var clean_map = benthic_map.where({
      test: benthic_map.connectedPixelCount(vars.small_object_benthic, false).lt(vars.small_object_benthic),
      value: smooth_map
    }).updateMask(class_extent_mask);
    
  }
  
  // ##############################################################################################
  // START OF CLEAN 2
  // ##############################################################################################
  
  if (vars.geomorphic && vars.obia_2nd_pass) {
    var clean_map = geo_map;
  }
  
  if (vars.obia_clean) {
    
    if (vars.geomorphic && !vars.fast_clean) { 
      
      // FUNCTION that maps over feature colleciton and assigns neighbour percentages
      var set_neighbour_properties = function(f) {
        // make the 1px buffer
        var diff = f.buffer(vars.image_data_scale).difference(f, ee.ErrorMargin(0.5));
        // reduce the classes in the buffer zone
        var diff_classes = ee.Dictionary(
          clean_map.unmask(ee.Image(0)).reduceRegion({
            reducer: ee.Reducer.frequencyHistogram(),
            geometry: diff.geometry(),
            scale: vars.image_data_scale,
            maxPixels: 1e11
          }).get('classification')
        );
        // calculate the percentages
        var diff_sum = diff_classes.toArray().reduce(ee.Reducer.sum(), [0]).get([0]);
        var diff_percs = diff_classes.map(function(k,v){return(ee.Number(v).divide(diff_sum).multiply(100).toUint8())});
        
        /* NOW, we can try to do the class logic right here (see /users/mitchest/global_reefs/obia_dev),
           or we can return the neighbour % and do image logic via (painted) rasters */
        
        return(f.set(diff_percs));
      };
      
      // FUNCTION to reduce the map to vectors and map the neighbour properties function
      var reduce_neighbours = function() {
        // reduce map to vectors
        var map_fc = clean_map
              .updateMask(segment_id).updateMask(clean_map.eq(classn)) // only vectorise class/es of interest
              .reduceToVectors({
                scale: vars.image_data_scale, 
                eightConnected: false,
                bestEffort: true, 
                maxPixels: 1e13,
                tileScale: 1,
                geometry: region_extent
              });
        // map the function, calculate neighbour properties
        return(map_fc.map(set_neighbour_properties));
      };
      
      // first make a make size threshold, so we're not vecortising huge objects when we don't have to
      var segment_id = clean_map.connectedComponents(ee.Kernel.plus(1),vars.small_object_geo.sqrt()).select('labels');
      //Map.addLayer(segment_id.reproject(ee.Projection('EPSG:4326').atScale(ee.Number(vars.image_data_scale))))
      Map.addLayer(clean_map.updateMask(segment_id).reproject(ee.Projection('EPSG:4326').atScale(ee.Number(vars.image_data_scale))), display_pal, 'Map objects to be iterated through (OBIA)', false);
      
      // This is where we select the single or group of classes to vectorise for cleaning up
      //var classn = ee.Number(15) // one class
      var classn = clean_map.where({
        test: clean_map.neq(16) //TRF
                .and(clean_map.neq(15)) //RR
                .and(clean_map.neq(14)) //ORF
                .and(clean_map.neq(13)) //IRF
                //.and(clean_map.neq(12)) // deep L
                .and(clean_map.neq(11)), // shallow L 
        value: ee.Image(99) // 99 ensures it's ignored in logic
      });
      
      // Minimum size of object to reclass based on neighbourhood
      var max_size = ee.Number(1000).divide(vars.image_data_scale).pow(2); // the first number is the square dimension of the desired min size;
      // calculate neighbours
      var map_fc_neighbours = reduce_neighbours();
      
      // #########
      // REEF RIM
      // #########
      
      var focus_class = ee.Number(15); //RR
      
      // start the object-based neighbourhood rules
      // paint out to rasters (only paint the layers needed)
      var objsize = ee.Image(30000).paint(map_fc_neighbours, 'count').rename('count');
      //var nb24 = ee.Image().byte().paint(map_fc_neighbours, '24').unmask(0).rename('nb24') //OCL
      var nb22 = ee.Image().byte().paint(map_fc_neighbours, '22').unmask(0).rename('nb22'); //SL ex
      var nb21 = ee.Image().byte().paint(map_fc_neighbours, '21').unmask(0).rename('nb21'); //Sl sh
      var nb16 = ee.Image().byte().paint(map_fc_neighbours, '16').unmask(0).rename('nb16'); //TRF
      var nb15 = ee.Image().byte().paint(map_fc_neighbours, '15').unmask(0).rename('nb15'); //RR
      var nb14 = ee.Image().byte().paint(map_fc_neighbours, '14').unmask(0).rename('nb14'); //ORF
      var nb13 = ee.Image().byte().paint(map_fc_neighbours, '13').unmask(0).rename('nb13'); //IRF
      //var nb3 = ee.Image().byte().paint(map_fc_neighbours, '3').unmask(0).rename('nb3') //Turbid
      
      // RR surrounded by ORF --> ORF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb14.gt(75)),
        value: ee.Image(14)
      });
      
      // RR surrounded by IRF --> IRF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb13.gt(75)),
        value: ee.Image(13)
      });
      
      // RR surrounded by IRF + ORF --> IRF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb13.add(nb14).gt(75)),
        value: ee.Image(13)
      });
      
      // RR with decent border to TRF --> TRF (often dark, probably seagrass)
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb16.gt(40)),
        value: ee.Image(16)
      });
      
      // RR surrounded by OCL --> OCL
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb24.gt(75)),
        value: ee.Image(24)
      })
      
      // small RR objects touching OCL + stuff --> ORF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(objsize.lte(max_size))
                .and(nb13.lte(75).and(nb14.lte(75))) // to ensure we're no re-writing previous rules
                .and(nb24.gt(1)),
        value: ee.Image(14)
      })
      
      // ####
      // ORF
      // ####
      
      focus_class = ee.Number(14); // ORF
      
      // ORF surrounded by IRF --> IRF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb13.gt(75)),
        value: ee.Image(13)
      });
      
      // ORF surrounded by TRF --> TRF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb16.gt(75)),
        value: ee.Image(16)
      });
      
      // ORF surrounded by RR --> RR
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb15.gt(85)),
        value: ee.Image(15)
      });
      
      // ORF touching slope and RR --> RR
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb21.gt(0).or(nb22.gt(0)))
                .and(nb15.gt(0)),
        value: ee.Image(15)
      });
      
      // ####
      // IRF
      // ####
      
      focus_class = ee.Number(13); // IRF
      
      // IRF surrounded by ORF --> ORF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb14.gt(75)),
        value: ee.Image(14)
      });
      
      // IRF surrounded by TRF --> TRF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb16.gt(75)),
        value: ee.Image(16)
      });
      
      // IRF surrounded by RR --> RR
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb15.gt(85)),
        value: ee.Image(15)
      });
      
      // ####
      // TRF
      // ####
      
      focus_class = ee.Number(16); // TRF
      
      // TRF surrounded by ORF --> ORF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb14.gt(75)),
        value: ee.Image(14)
      });
      
      // TRF surrounded by IRF --> IRF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb13.gt(75)),
        value: ee.Image(13)
      });
      
      // TRF surrounded by IRF + ORF --> IRF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb13.add(nb14).gt(75)),
        value: ee.Image(13)
      });
      
      // ####
      // LAGOONS
      // ####
      
      var nb11 = ee.Image().byte().paint(map_fc_neighbours, '11').unmask(0).rename('nb11'); // shallow lag
      
      // SL sourrounded by DL --> DL
      clean_map = clean_map.where({
        test: clean_map.eq(11)
                .and(nb12.gt(75)),
        value: ee.Image(12)
      })
      
      // DL sourrounded by SL --> SL
      clean_map = clean_map.where({
        test: clean_map.eq(12)
                .and(nb11.gt(75)),
        value: ee.Image(11)
      })
      
      // DL/SL surrounded by IRF --> IRF
      clean_map = clean_map.where({
        test: clean_map.eq(11).or(clean_map.eq(12))
                .and(objsize.lte(max_size))
                .and(nb13.gt(80)),
        value: ee.Image(13)
      })
      
      // SL surrounded by IRF --> IRF
      clean_map = clean_map.where({
        test: clean_map.eq(11)
                .and(objsize.lte(max_size))
                .and(nb13.gt(80)),
        value: ee.Image(13)
      });
      
    
    } else if (vars.geomorphic && vars.fast_clean) {
      print("Executing the fast version OBIA");
      
      /* fast version of the geo clean up
        - blanket version assigns the underlying most common in neighbourhood
        - mode OBIA version iterates through objects+buffers but take the mode instead of doing the class percs, to see if that speeds things up
      */
      
      
      // ## Blanket version
      
      // the "LAND MASK" CLEAN  ****to be moved to datagen for next region****
      var global_reef_mask = ee.Image(region_params.global_reef_mask);
  
      clean_map = clean_map.where({
        test: global_reef_mask.eq(1),
        value: ee.Image(0)
      });
      
      // make a very smooth map to capture the broader neighbourhood  - *** Change to ee.kernal*** see reef mask in clean 3
      var smooth_map = clean_map
                          .focal_mode({
                            radius: vars.smooth_radius.multiply(3), // relates to smoothness required
                            kernelType: 'circle', units: 'pixels', iterations: 2
                          });
      
      // first make a make size threshold, so we're not vectorising huge objects when we don't have t
      // - the unmask(99) captures small no data values/ data gaps
      var segment_id = clean_map.unmask(0).connectedComponents(ee.Kernel.plus(1),vars.small_object_geo.sqrt().multiply(2)).select('labels').pow(2).log().int();
      Map.addLayer(clean_map.unmask(0).updateMask(segment_id.gt(0)).reproject(ee.Projection('EPSG:4326').atScale(ee.Number(vars.image_data_scale))), display_pal, 'Map objects to be iterated through (OBIA)', false);
      
      // replace small objects with smooth underneath
      var clean_map = clean_map.unmask(0).where({
        test: segment_id.gt(0), 
        value: smooth_map
      }).selfMask();
      
      
      // ## mode OBIA version
      
      /* A possible faster plan
            - vectorise one/few class/es at a time, thus only spending resources on what is actually needed to clean up
            - BUT, just assign the mode of the neighbours, so save resouces even further??
      
      // FUNCTION that maps over feature colleciton and assigns neighbour percentages
      var set_neighbour_mode = function(f) {
        // make the 1px buffer
        var diff = f.buffer(vars.image_data_scale).difference(f, ee.ErrorMargin(0.5))
        // reduce the classes in the buffer zone
        var diff_mode = ee.Number(ee.Dictionary(
          clean_map.unmask(ee.Image(0)).reduceRegion({
            reducer: ee.Reducer.mode(),
            geometry: diff.geometry(),
            scale: vars.image_data_scale,
            maxPixels: 1e11
          })).get('classification'))
        
        return(f.set('mode',diff_mode))
      }
      
      // FUNCTION to reduce the map to vectors and map the neighbour properties function
      var reduce_neighbours_mode = function() {
        // reduce map to vectors
        var map_fc = clean_map.unmask(0)
              .updateMask(classn.gt(0)) // only vectorise class/es of interest
              .reduceToVectors({
                scale: vars.image_data_scale, 
                eightConnected: false,
                bestEffort: true, 
                maxPixels: 1e13,
                tileScale: 1,
                geometry: region_extent
              })
        // map the function, calculate neighbour properties
        return(map_fc.map(set_neighbour_mode))
      }
      
      // first make a make size threshold, so we're not vecortising huge objects when we don't have to
      var segment_id = clean_map.unmask(0).connectedComponents(ee.Kernel.plus(1),vars.small_object_geo.sqrt()).select('labels')
      Map.addLayer(clean_map.unmask(0).updateMask(segment_id.gt(0)).reproject(ee.Projection('EPSG:4326').atScale(ee.Number(vars.image_data_scale))), display_pal, 'Map objects to be iterated through (OBIA)', false)
      
      // This is where we select the single or group of classes to vectorise for cleaning up
      var classn = segment_id.where({
        test: clean_map.neq(16) //TRF
                .and(clean_map.neq(15)) //RR
                .and(clean_map.neq(14)) //ORF
                .and(clean_map.neq(13)) //IRF
                //.and(clean_map.neq(12)) // deep L
                .and(clean_map.neq(11)) // shallow L 
                .and(clean_map.unmask(0).neq(0)), // no data values (want to reclaim the small gaps 
        value: ee.Image(0) // 99 ensures it's ignored in logic
      })
      
      // calculate neighbours
      var map_fc_neighbours = reduce_neighbours_mode()
      
      //print(map_fc_neighbours.limit(10))
      
      var mode_map = ee.Image().byte().paint(map_fc_neighbours, 'mode').unmask(0).rename('mode') // paint out the mode values to an image
      //Map.addLayer(mode_map, display_pal, "mode map", false)
      
      // replace small objects with mode underneath
      var clean_map = clean_map.unmask(0).where({
        test: segment_id.gt(0), 
        value: mode_map
      }).selfMask()
      
      */
      
    } else {
      
      if (vars.cleanup_stage == 1) {
        // BENTHIC CLEAN-UP RULES
        
        /*// reclaim shallow no data to surrounding class
        var smooth_map = clean_map
                            .focal_mode({
                              radius: vars.smooth_radius.multiply(3), // relates to smoothness required
                              kernelType: 'circle', units: 'pixels', iterations: 2
                            });
        
        var clean_map = clean_map.unmask(0).where({
          test: geo_map.gt(2).and(clean_map.eq(0)), 
          value: smooth_map
        }).selfMask();*/
        
        // cut benthic off to < 10 - 15 m
        clean_map = clean_map.where({
          test: depth.gt(vars.benthic_depth_cutoff),
          value: ee.Image(0)
        });
        
        // Deep (or land or missing) in geo == masked from benthic
        clean_map = clean_map.where({
          test: geo_map.unmask(0).lte(2),
          value: ee.Image(0)
        });
        
      }
    }
  }
  
  // Final clip to the classified extent and move on
  if (vars.geomorphic) {
    clean_map = clean_map.updateMask(clean_map.gt(1)); // this ignores 0/land; make it .gt(2) if you want to mask deep too
  } else {
    clean_map = clean_map.updateMask(clean_map.gt(1)); // this ignores 0/land; make it .gt(2) if you want to mask deep too
  }

  
  
  // 4. Export data
  
  var output_name = (vars.geomorphic) ? vars.geomorph_output_name : vars.benthic_output_name;
  
  if (vars.do_export) {
    print("For export, the image data scale must be set to:", vars.image_data_scale);
    
    Map.addLayer(region_extent, {}, "Export footprint", false);
    
    Export.image.toAsset({
      image: clean_map.set(vars),
      description: output_name,
      assetId: vars.asset_output + 'in_out/' + output_name,
      region: region_extent,
      scale: vars.image_data_scale,
      crs: 'EPSG:4326',
      maxPixels: 1e13,
      pyramidingPolicy: {'.default': 'mode'}
    });
    
  } else {
    if (vars.reproject_display) {
      Map.addLayer(clean_map.reproject(ee.Projection('EPSG:4326').atScale(vars.image_data_scale)), display_pal, output_name, true);
    } else {
      Map.addLayer(clean_map, display_pal, output_name, false);
    }
  }

}

//Generate title
var title = ui.Label({
  value: 'Classes',
  style: {fontWeight: 'bold', fontSize: '12px'}
});

// generate the legend
var geo_legend = pkg_vis.discrete_legend(map_palettes.geo_atlas_names, map_palettes.geo_atlas_cols, 'Geomorphic Zone', false);
var benthic_legend = pkg_vis.discrete_legend(map_palettes.benthic_atlas_names, map_palettes.benthic_atlas_cols, 'Benthic Habitat', false);
//var mask_legend = pkg_vis.discrete_legend(["Low confidence depth","Water conditions"], ["#f7f7f7","#bababa"], 'Confidence Mask reason', false)
var legend = (vars.geomorphic) ? geo_legend : benthic_legend;
pkg_vis.add_lgds([title, legend]);//, mask_legend])
// generate the legend
