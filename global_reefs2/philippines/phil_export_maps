/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var pixels = ee.Image("projects/coral_atlas/philippines/in_out/phil_pixels"),
    geo = ee.Image("projects/coral_atlas/philippines/in_out/phil_geo_clean3"),
    benthic = ee.Image("projects/coral_atlas/philippines/in_out/phil_benthic_clean2"),
    qc_mask = 
    /* color: #d63000 */
    /* shown: false */
    ee.Geometry({
      "type": "GeometryCollection",
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                117.22199693660264,
                7.053364973247443
              ],
              [
                117.2038008306456,
                7.042120926319738
              ],
              [
                117.19041124324326,
                7.025083972323981
              ],
              [
                117.18629137019639,
                7.007364877936936
              ],
              [
                117.19487443904404,
                6.996801251092572
              ],
              [
                117.20586076716904,
                6.993393578522597
              ],
              [
                117.21238389949326,
                6.999186607092646
              ],
              [
                117.22302690486435,
                7.007705636109504
              ],
              [
                117.23195329646592,
                7.006683360844549
              ],
              [
                117.23435655574326,
                7.0008904253427575
              ],
              [
                117.23435655574326,
                6.9954381850487035
              ],
              [
                117.23401323298935,
                6.982488859288463
              ],
              [
                117.23607316951279,
                6.979762639747276
              ],
              [
                117.25014940242295,
                6.983170411691661
              ],
              [
                117.25976243953232,
                6.982488859288463
              ],
              [
                117.27177873591904,
                6.9729470214285785
              ],
              [
                117.28654161433701,
                6.953181167891007
              ],
              [
                117.28207841853623,
                6.9398898675944745
              ],
              [
                117.27967515925889,
                6.931028792183206
              ],
              [
                117.28173509578232,
                6.912965315068148
              ],
              [
                117.29306474666123,
                6.907852884783909
              ],
              [
                117.30336442927842,
                6.905467065068441
              ],
              [
                117.30851427058701,
                6.892174420795132
              ],
              [
                117.29546800593857,
                6.885357535496981
              ],
              [
                117.27795854548935,
                6.874109460680236
              ],
              [
                117.27109209041123,
                6.863542844859268
              ],
              [
                117.26147905330185,
                6.850249027303203
              ],
              [
                117.26079240779404,
                6.8427497872163405
              ],
              [
                117.27315202693467,
                6.846499421991089
              ],
              [
                117.2858549688292,
                6.856384681493592
              ],
              [
                117.29237810115342,
                6.866610596213445
              ],
              [
                117.30714097957139,
                6.875813731562805
              ],
              [
                117.32156053523545,
                6.881949056114719
              ],
              [
                117.32911363582139,
                6.877858848552761
              ],
              [
                117.33323350886826,
                6.8536577338250195
              ],
              [
                117.33632341365342,
                6.839341002776748
              ],
              [
                117.34147325496201,
                6.830818935284874
              ],
              [
                117.35486284236435,
                6.834227780512971
              ],
              [
                117.38438859920029,
                6.846499421991089
              ],
              [
                117.39331499080185,
                6.8410453980378225
              ],
              [
                117.4012114141417,
                6.833205129496178
              ],
              [
                117.38576189021592,
                6.826387400169701
              ],
              [
                117.37477556209092,
                6.816842415978185
              ],
              [
                117.36138597468857,
                6.800820051028217
              ],
              [
                117.3627592657042,
                6.783092556571317
              ],
              [
                117.36790910701279,
                6.772183004825708
              ],
              [
                117.3795820806456,
                6.768773719297944
              ],
              [
                117.40945116023545,
                6.766728136423061
              ],
              [
                117.41940752009873,
                6.771842077356769
              ],
              [
                117.4345137212706,
                6.77013743639908
              ],
              [
                117.45888963679795,
                6.767069067504041
              ],
              [
                117.4729658697081,
                6.774228564579944
              ],
              [
                117.48257890681748,
                6.774228564579944
              ],
              [
                117.50283494929795,
                6.765364409692122
              ],
              [
                117.50901475886826,
                6.757181968470883
              ],
              [
                117.51828447322373,
                6.752067872387173
              ],
              [
                117.52858415584092,
                6.757863843863174
              ],
              [
                117.54540697078232,
                6.746953722259059
              ],
              [
                117.57252946834092,
                6.743203311173467
              ],
              [
                117.58179918269639,
                6.754113517308241
              ],
              [
                117.59484544734482,
                6.754454457287547
              ],
              [
                117.61613145808701,
                6.756500092117059
              ],
              [
                117.64531389216904,
                6.750704104302358
              ],
              [
                117.65321031550889,
                6.766046273538962
              ],
              [
                117.65836015681748,
                6.775592266263492
              ],
              [
                117.66248002986435,
                6.805184131416485
              ],
              [
                117.64771715144639,
                6.812343061464918
              ],
              [
                117.62540117244248,
                6.818479202177148
              ],
              [
                117.61510148982529,
                6.81200216245618
              ],
              [
                117.59862199763779,
                6.814388450428608
              ],
              [
                117.60456039979425,
                6.83610419849545
              ],
              [
                117.59288742616144,
                6.844285295715294
              ],
              [
                117.58190109803644,
                6.844967047490405
              ],
              [
                117.57881119325128,
                6.839513006032268
              ],
              [
                117.56713821961847,
                6.829968283668324
              ],
              [
                117.53864243104425,
                6.820764263877672
              ],
              [
                117.524909520888,
                6.819741584090981
              ],
              [
                117.50053360536066,
                6.814628152418427
              ],
              [
                117.48817398622003,
                6.80951466621015
              ],
              [
                117.51529648377863,
                6.796901167314804
              ],
              [
                117.52902939393488,
                6.796901167314804
              ],
              [
                117.53314926698175,
                6.790423836523771
              ],
              [
                117.5304026849505,
                6.785310092724532
              ],
              [
                117.52147629334894,
                6.782241820375778
              ],
              [
                117.5135798700091,
                6.774741516829874
              ],
              [
                117.50431015565363,
                6.775082442249658
              ],
              [
                117.49641373231378,
                6.778832605958692
              ],
              [
                117.5084300287005,
                6.792810231700904
              ],
              [
                117.49504044129816,
                6.801332974942815
              ],
              [
                117.48336746766535,
                6.80406022085607
              ],
              [
                117.48714401795831,
                6.791787492360185
              ],
              [
                117.4751277215716,
                6.783946418538138
              ],
              [
                117.46276810243097,
                6.77951445077154
              ],
              [
                117.4476619012591,
                6.78053721618212
              ],
              [
                117.42637589051691,
                6.77815076018132
              ],
              [
                117.40474655702081,
                6.778832605958692
              ],
              [
                117.40680649354425,
                6.790764750845213
              ],
              [
                117.41298630311456,
                6.8026965998351665
              ],
              [
                117.42259934022394,
                6.833377134960047
              ],
              [
                117.44354202821222,
                6.844285295715294
              ],
              [
                117.46688797547785,
                6.854852338755351
              ],
              [
                117.48680069520441,
                6.853488862487686
              ],
              [
                117.50019028260675,
                6.8562158111224605
              ],
              [
                117.51151993348566,
                6.855193207212825
              ],
              [
                117.51289322450128,
                6.8661008690630085
              ],
              [
                117.49092056825128,
                6.8705320352899815
              ],
              [
                117.47993424012628,
                6.870872892520517
              ],
              [
                117.45555832459894,
                6.875304014278119
              ],
              [
                117.41058304383722,
                6.877349133462225
              ],
              [
                117.39376022889581,
                6.87359974156757
              ],
              [
                117.38105728700128,
                6.869168603924586
              ],
              [
                117.36972763612238,
                6.872918030772202
              ],
              [
                117.35530808045831,
                6.889278819808756
              ],
              [
                117.35565140321222,
                6.898140678278452
              ],
              [
                117.35942795350519,
                6.9039348807128285
              ],
              [
                117.38140060975519,
                6.930370758233449
              ],
              [
                117.36389114930597,
                6.9375278036257315
              ],
              [
                117.35668137147394,
                6.928325868156707
              ],
              [
                117.34775497987238,
                6.919123753101084
              ],
              [
                117.33127548768488,
                6.926621786318114
              ],
              [
                117.327155614638,
                6.931052386287806
              ],
              [
                117.32578232362238,
                6.9385502298043304
              ],
              [
                117.32921555116144,
                6.948092767025786
              ],
              [
                117.36320450379816,
                6.943662327385946
              ],
              [
                117.40302994325128,
                6.946729559274338
              ],
              [
                117.4092097528216,
                6.974674527222364
              ],
              [
                117.37522080018488,
                6.988305614282968
              ],
              [
                117.34706833436456,
                6.985238654324216
              ],
              [
                117.32406570985285,
                6.978763895032722
              ],
              [
                117.31136276795831,
                6.9658141078341105
              ],
              [
                117.3106761224505,
                6.950819170670201
              ],
              [
                117.2996897943255,
                6.951159970013788
              ],
              [
                117.29110672547785,
                6.957975904969873
              ],
              [
                117.29076340272394,
                6.967518047647769
              ],
              [
                117.32303574159113,
                6.989668701139127
              ],
              [
                117.3323054559466,
                6.988646386369686
              ],
              [
                117.33573868348566,
                6.985920202720334
              ],
              [
                117.38929703309503,
                6.99273563202798
              ],
              [
                117.38826706483331,
                7.0022770659840985
              ],
              [
                117.37728073670831,
                7.014203583960387
              ],
              [
                117.3546214349505,
                7.020677851554753
              ],
              [
                117.34123184754816,
                7.021018599985828
              ],
              [
                117.32818558289972,
                7.014544337131175
              ],
              [
                117.31445267274347,
                7.006706951141391
              ],
              [
                117.29728653504816,
                7.003980872947566
              ],
              [
                117.28389694764581,
                6.99512100879864
              ],
              [
                117.28012039735285,
                6.986942523451827
              ],
              [
                117.27531387879816,
                6.985920202720334
              ],
              [
                117.27394058778253,
                6.99512100879864
              ],
              [
                117.283210302138,
                6.999210197768649
              ],
              [
                117.2993464715716,
                7.007729226354617
              ],
              [
                117.28492691590753,
                7.017270353519814
              ],
              [
                117.27153732850519,
                7.025448306874151
              ],
              [
                117.25986435487238,
                7.037374230957231
              ],
              [
                117.24750473573175,
                7.050322030135382
              ],
              [
                117.24372818543878,
                7.072468742129975
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                121.39285468150858,
                11.892387230024275
              ],
              [
                121.45877265025858,
                11.890707455824725
              ],
              [
                121.53876685191874,
                11.896754594403115
              ],
              [
                121.5370502381492,
                11.90414535895422
              ],
              [
                121.53567694713358,
                11.907840665873136
              ],
              [
                121.5367069153953,
                11.914559276956934
              ],
              [
                121.53773688365702,
                11.920269965684634
              ],
              [
                121.53979682018046,
                11.922957307042793
              ],
              [
                121.53979682018046,
                11.9286678190545
              ],
              [
                121.54048346568827,
                11.933370503375372
              ],
              [
                121.54014014293436,
                11.9380731061233
              ],
              [
                121.5367069153953,
                11.942775627268041
              ],
              [
                121.5363635926414,
                11.95016513840807
              ],
              [
                121.52065676067298,
                11.952102883319826
              ],
              [
                121.46718427445737,
                11.95134935218904
              ],
              [
                121.39663123180155,
                11.95184454463234
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                121.40761755992655,
                11.831572807295345
              ],
              [
                121.40246771861796,
                11.82149176031252
              ],
              [
                121.4100208192039,
                11.797967874077372
              ],
              [
                121.44160651256327,
                11.790238156632627
              ],
              [
                121.4814319520164,
                11.80233674846897
              ],
              [
                121.48246192027811,
                11.82149176031252
              ],
              [
                121.46289252330546,
                11.815106905180318
              ],
              [
                121.44469641734842,
                11.818803418403002
              ],
              [
                121.43371008922342,
                11.829556627613947
              ],
              [
                121.42615698863749,
                11.832244863886519
              ],
              [
                121.41860388805155,
                11.829220596222275
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                121.92497819139383,
                12.117107595383342
              ],
              [
                121.90437882615946,
                12.11979297171537
              ],
              [
                121.8683299369993,
                12.114086514710815
              ],
              [
                121.8408641166868,
                12.086223826801602
              ],
              [
                121.83811753465555,
                12.063730142621292
              ],
              [
                121.84223740770243,
                12.02444560305755
              ],
              [
                121.85837357713602,
                12.006312340698512
              ],
              [
                121.88789933397196,
                12.002954195152556
              ],
              [
                121.90403550340555,
                12.027131908381959
              ],
              [
                121.90197556688211,
                12.04962866152683
              ],
              [
                121.90060227586649,
                12.066080317382713
              ],
              [
                121.90815537645243,
                12.082530963518446
              ],
              [
                121.91261857225321,
                12.088238094384781
              ],
              [
                121.92360490037821,
                12.09360940045712
              ],
              [
                121.93562119676493,
                12.104015998910711
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                120.99598077150738,
                10.759433244240952
              ],
              [
                121.04267266603863,
                10.758758669429822
              ],
              [
                121.052285703148,
                10.774948048171476
              ],
              [
                121.07082513185894,
                10.777308926536932
              ],
              [
                121.0739150366441,
                10.766853467535435
              ],
              [
                121.07872155519878,
                10.750326356987502
              ],
              [
                121.140176328148,
                10.803614603271027
              ],
              [
                121.15150597902691,
                10.85959080168291
              ],
              [
                121.09691766115581,
                10.870380189850907
              ],
              [
                121.0903945288316,
                10.824185385923833
              ],
              [
                121.06704858156597,
                10.79990496780389
              ],
              [
                121.03649285646831,
                10.784054191249032
              ],
              [
                120.99460748049175,
                10.774273508095078
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        }
      ],
      "coordinates": []
    });
/***** End of imports. If edited, may not auto-convert in the playground. *****/

///////////////////////////////
// Global coral atlas project - Philippines
// Contact: mitchell.lyons@gmail.com
// Region coordinator: 
// Description:
// - export geomorphic and benthic to Vulcan bucket
///////////////////////////////

// so we can visualise maps before export
var map_palettes = require('users/mitchest/global_reefs_modules:colour_pals');

// will need to import depth mosaic from pixels now
var depth = pixels.select('depth'); //.multiply(100).uint16()

// load extent
var reef_boundary = ee.FeatureCollection("projects/coral_atlas/philippines/in_out/phil_extent").geometry()
//Map.addLayer(image, {}, "Dove image", false)

/*
##################
A few additional QC changes
##################
*/
var qc_mask_i = ee.Image().byte().paint(ee.Feature(qc_mask, {zone: 1}), "zone").clip(qc_mask);

// additional masking (various provenance)
geo = geo.where({
  test: qc_mask_i.eq(1),
  value: ee.Image(0)
});

/*
##################
##################
*/


// finalise layers (include 'mapped area' as zeros)
geo = geo.where(geo.lte(2), 0).selfMask();
benthic = benthic.updateMask(geo.gt(0)).selfMask();

// make reef/non-reef layer 
var reef_top = geo.eq([11,13,14,15,16,25,26]).reduce(ee.Reducer.sum());
var reef_all = geo.eq([11,12,13,14,15,16,21,22,23,24,25,26]).reduce(ee.Reducer.sum());
var reef_layer = reef_top.addBands(reef_all).reduce(ee.Reducer.sum());

// check before export 
//Map.addLayer(lowtide_sr, {"opacity":1,"bands":["b3","b2","b1"],"min":1,"max":1514,"gamma":1}, 'lowtide_sr', false);
Map.addLayer(reef_layer.selfMask(), {min:0, max:2}, "reef layer", false);
Map.addLayer(geo, map_palettes.geo, "geomorphic map", false);
Map.addLayer(benthic, map_palettes.benthic, "benthic map", false);
Map.addLayer(depth, {min: -3, max: 1200, palette:['#d0d1e6','#a6bddb','#74a9cf','#3690c0','#0570b0','#045a8d','#023858']}, "depth layer", false);

// combine into single stack
var export_stack = depth.updateMask(geo.gt(2)).rename('depth')
                    .addBands(reef_layer.rename('reef'))
                    .addBands(geo.rename('geomorphic'))
                    .addBands(benthic.rename('benthic'))
                    .toInt16();

Map.addLayer(export_stack, {}, "export raster stack", false);

// run the export
Map.addLayer(reef_boundary, {}, "Reef Boundary", false)
Export.image.toCloudStorage({
  image: export_stack,
  description: 'philippines_stack',
  bucket: 'coral-atlas-data-pipeline',
  fileNamePrefix: 'coral-gee-export-bucket/philippines/v2/phil_stack_',
  region: reef_boundary, 
  scale: 5,
  crs: 'EPSG:4326',
  maxPixels: 1e13, 
  skipEmptyTiles: true
});


