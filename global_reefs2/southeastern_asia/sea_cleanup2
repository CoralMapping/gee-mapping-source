/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var map_centre = /* color: #d63000 */ee.Geometry.Point([110.54123843930057, 11.203641832350737]),
    region_extent = 
    /* color: #d6ce3f */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[116.38606558463863, 24.209573647975855],
          [105.04817495963863, 22.59644299595178],
          [95.99544058463863, 7.365385406360969],
          [105.31184683463863, -0.5243936157772531],
          [114.10090933463863, 0.6181651949272102],
          [118.84700308463863, 7.365385406360969],
          [115.33137808463863, 9.191775121314864],
          [110.32161245963863, 4.83119211083598],
          [105.75129995963863, 6.230859367180478],
          [110.84895620963863, 10.749860501427356],
          [111.28840933463863, 16.47051682571067],
          [117.61653433463863, 22.352797521719562]]]),
    turbid2 = 
    /* color: #16d61c */
    /* shown: false */
    ee.Geometry({
      "type": "GeometryCollection",
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                115.70895329285901,
                22.891662906985072
              ],
              [
                115.56922093201916,
                22.875531497747982
              ],
              [
                115.54518833924573,
                22.810037290303363
              ],
              [
                115.23328232224965,
                22.880747073862292
              ],
              [
                114.88455888521477,
                22.903217263605004
              ],
              [
                114.6294100049573,
                22.79478938879519
              ],
              [
                114.96854893803497,
                22.68383280828163
              ],
              [
                114.98563790496894,
                22.629248295153843
              ],
              [
                115.18667869051892,
                22.765153041620742
              ],
              [
                115.40170841456147,
                22.63615694982899
              ],
              [
                115.48455371057906,
                22.616571233833092
              ],
              [
                115.53546590031063,
                22.66146259891171
              ],
              [
                115.56405895577004,
                22.66404441464351
              ],
              [
                115.56420894146814,
                22.673688304341432
              ],
              [
                115.5830409647737,
                22.669531915780208
              ],
              [
                115.6027376502616,
                22.73584331746088
              ],
              [
                115.57986393739026,
                22.75306019715654
              ],
              [
                115.60627296455847,
                22.76677038522017
              ],
              [
                115.66428390784833,
                22.789647857879
              ],
              [
                115.77487126160901,
                22.842313739529015
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                111.88971265941264,
                21.728189485122957
              ],
              [
                111.69684324923405,
                21.82795993355595
              ],
              [
                111.68906456724567,
                21.70243682352647
              ],
              [
                111.79657285385589,
                21.629204445991245
              ],
              [
                111.78866546615455,
                21.541696059639264
              ],
              [
                112.00890503721642,
                21.574805324132782
              ],
              [
                112.10883405763718,
                21.679203504721514
              ],
              [
                112.33328565745951,
                21.622265831884246
              ],
              [
                112.4458703499798,
                21.70525118069278
              ],
              [
                112.53653272777201,
                21.69374093605708
              ],
              [
                112.81119093089701,
                21.795786703476377
              ],
              [
                112.96499952464701,
                21.785585390439145
              ],
              [
                113.54727491527201,
                21.714155886602025
              ],
              [
                113.59524705307965,
                21.965119295427076
              ],
              [
                113.66812452464701,
                22.152373180395756
              ],
              [
                113.73953565745951,
                22.203240804008633
              ],
              [
                113.87686475902201,
                22.39509973496946
              ],
              [
                113.99488262711974,
                22.441432313964913
              ],
              [
                114.09659132152201,
                22.609515662514156
              ],
              [
                113.74502882152201,
                23.080305483443496
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                110.61152590305747,
                21.472494078997435
              ],
              [
                109.50714100982155,
                21.90229754412787
              ],
              [
                108.3585625953065,
                21.9459324598531
              ],
              [
                107.46118755123034,
                21.502157891325748
              ],
              [
                107.27119722357554,
                21.22688401531392
              ],
              [
                107.4108297986071,
                21.1141711789949
              ],
              [
                107.449465927271,
                21.199270711348554
              ],
              [
                107.46572501977927,
                21.285531510249083
              ],
              [
                107.54571571171364,
                21.232638867461457
              ],
              [
                107.62750212173304,
                21.278135643116265
              ],
              [
                107.70934196392513,
                21.3287115602012
              ],
              [
                107.89239373746466,
                21.40157955919398
              ],
              [
                107.99108999984493,
                21.40668840265844
              ],
              [
                108.1067677193183,
                21.37871639199205
              ],
              [
                108.45293666728902,
                21.493247496935144
              ],
              [
                109.53002117580395,
                21.155744298631486
              ],
              [
                109.80128420383872,
                20.275336228614663
              ],
              [
                109.69404269945181,
                19.89334033522597
              ],
              [
                109.94586817394087,
                19.887092619685266
              ],
              [
                110.15381985157404,
                19.942530335891952
              ],
              [
                110.45801525572745,
                19.957657185143436
              ],
              [
                110.66098008000844,
                19.89021402855697
              ],
              [
                110.60306213544611,
                20.049940640180054
              ],
              [
                110.54755990045663,
                20.46372216235907
              ],
              [
                110.49570922888691,
                20.86797875394182
              ],
              [
                110.53175448538981,
                20.888008659287394
              ],
              [
                110.58817995579184,
                20.991187450763515
              ],
              [
                111.10041750461997,
                21.375335593320663
              ],
              [
                111.19380129368247,
                21.411138344841387
              ],
              [
                111.22264524323403,
                21.420729313833967
              ],
              [
                111.26521242649497,
                21.371499064534845
              ],
              [
                111.3434900143856,
                21.441819437445343
              ],
              [
                111.3929284909481,
                21.471216097826733
              ],
              [
                111.46845655636763,
                21.49168322298734
              ],
              [
                111.56046999485434,
                21.481439633208137
              ],
              [
                111.55085695774497,
                21.54915241076319
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                106.800882513531,
                21.00393711673011
              ],
              [
                106.70938375583465,
                20.974120565115573
              ],
              [
                106.67809885256148,
                20.793127669381015
              ],
              [
                106.47897165529585,
                20.575143279934014
              ],
              [
                106.43021982424116,
                20.36221341694406
              ],
              [
                106.07709874122895,
                20.18895095375251
              ],
              [
                105.75016847630297,
                19.910967375012703
              ],
              [
                105.65741955732338,
                19.613067014180622
              ],
              [
                105.59356152509682,
                19.345714679623956
              ],
              [
                105.41675297314467,
                19.013022835738074
              ],
              [
                105.58154789501967,
                18.947442209968965
              ],
              [
                105.64375489821145,
                18.87927088069073
              ],
              [
                105.73622987439201,
                19.066953480434297
              ],
              [
                105.8526285541929,
                19.29340607501845
              ],
              [
                105.83134254345072,
                19.39447572010856
              ],
              [
                105.86292823681009,
                19.527196181683653
              ],
              [
                105.95356544384134,
                19.680425631883494
              ],
              [
                106.26118263134134,
                19.917527863389722
              ],
              [
                106.38889869579447,
                20.13106774475066
              ],
              [
                106.6436441791929,
                20.149118212588522
              ],
              [
                106.68912031917596,
                20.34706401935575
              ],
              [
                106.73993208675408,
                20.574801078137494
              ],
              [
                107.02832320003533,
                20.68276115668421
              ],
              [
                107.03862288265252,
                20.740565365446564
              ],
              [
                106.9775114324572,
                20.780373203991264
              ],
              [
                107.01939680843377,
                20.843273864920896
              ],
              [
                107.0702085760119,
                20.893960371683434
              ],
              [
                107.07158186702752,
                20.940140765586065
              ],
              [
                107.13337996273064,
                21.013230591769922
              ],
              [
                107.00772383480096,
                21.06257803222756
              ],
              [
                106.85185530452752,
                21.022204069329405
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                105.68363075715169,
                18.6204312732307
              ],
              [
                105.93230959032287,
                18.292435343143268
              ],
              [
                106.30095270607953,
                18.005807938416435
              ],
              [
                106.37920265656575,
                18.17346730604602
              ],
              [
                105.81336343285045,
                18.751172133850726
              ],
              [
                105.7556852101942,
                18.795379993427296
              ],
              [
                105.74263894554576,
                18.84802420770668
              ],
              [
                105.70350015160045,
                18.841525814334027
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                108.11841372617127,
                18.837671736172144
              ],
              [
                109.04675845273377,
                18.003808148403085
              ],
              [
                109.20606021054627,
                18.389972222740468
              ],
              [
                108.92041567929627,
                19.15969485679925
              ],
              [
                108.52490786679627,
                19.475911590502864
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                108.49489243177442,
                15.525394986459194
              ],
              [
                108.62810166029004,
                15.555825931607817
              ],
              [
                108.50725205091504,
                15.882342642196535
              ],
              [
                108.33421738294629,
                15.863849661280062
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                109.14122641406982,
                12.494939491999633
              ],
              [
                109.08835470996826,
                12.438285983178027
              ],
              [
                109.1783052714917,
                12.351773377906873
              ],
              [
                109.20731661050846,
                12.326116283991253
              ],
              [
                109.21298086963623,
                12.3346686557585
              ],
              [
                109.20474112354248,
                12.358480806946838
              ],
              [
                109.19993460498779,
                12.373571893131235
              ],
              [
                109.21298086963623,
                12.390338743968258
              ],
              [
                109.21332419239013,
                12.412469336448128
              ],
              [
                109.2387300761792,
                12.401739586953529
              ],
              [
                109.24490988574951,
                12.392686017104378
              ],
              [
                109.25280630908935,
                12.365188063946528
              ],
              [
                109.26001608692138,
                12.351773377906873
              ],
              [
                109.2866233746634,
                12.353785580639647
              ],
              [
                109.27409231983154,
                12.368541627903934
              ],
              [
                109.22122061572998,
                12.475958326517318
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                109.11902542749218,
                11.906727826079061
              ],
              [
                109.16056748071483,
                11.888922630578397
              ],
              [
                109.18974991479686,
                11.918149412821068
              ],
              [
                109.22305222192577,
                11.956441812078387
              ],
              [
                109.21790238061718,
                11.996072096936926
              ],
              [
                109.16777725854686,
                11.991370502863713
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                108.97629625433063,
                11.50924211862823
              ],
              [
                109.04770738714313,
                11.469878298485376
              ],
              [
                109.07071001165485,
                11.504532207575789
              ],
              [
                109.02058488958454,
                11.557345975353966
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                109.00959856145954,
                11.591652773554317
              ],
              [
                109.02676469915485,
                11.554318703051377
              ],
              [
                109.05835039251423,
                11.567100296902083
              ],
              [
                109.05457384222126,
                11.597033850133784
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                106.6941312905177,
                10.519738799299803
              ],
              [
                106.61791363915052,
                10.379747396287389
              ],
              [
                106.49178095049483,
                10.101356295370481
              ],
              [
                106.37985773272139,
                9.88766925242849
              ],
              [
                106.30226679033858,
                9.691441665839474
              ],
              [
                106.06331415361983,
                9.625781180914577
              ],
              [
                106.08597345537764,
                9.41178883456813
              ],
              [
                105.55382318682295,
                9.225453336134857
              ],
              [
                105.16243524736983,
                10.316928092334019
              ],
              [
                104.87198419756514,
                10.452007760757391
              ],
              [
                104.63867934155897,
                10.16142700122703
              ],
              [
                104.76266476197893,
                9.01867523207883
              ],
              [
                104.69949337526018,
                8.863344125244124
              ],
              [
                104.49899288697893,
                8.631921807668146
              ],
              [
                104.58963009401018,
                8.51038499569124
              ],
              [
                104.77296444459611,
                8.445187309968219
              ],
              [
                104.95080563111955,
                8.481862369085066
              ],
              [
                105.14100643678361,
                8.535510311541156
              ],
              [
                105.35180660768205,
                8.727629988326775
              ],
              [
                105.42665096803361,
                8.924399182822501
              ],
              [
                105.69639107445461,
                9.07523245481536
              ],
              [
                106.14421556181033,
                9.236153955525559
              ],
              [
                106.40170762724001,
                9.442232552887099
              ],
              [
                106.55826280302126,
                9.475420734675629
              ],
              [
                106.66400621122439,
                9.600806612628984
              ],
              [
                106.7580766457947,
                9.692869886281718
              ],
              [
                106.79216013715335,
                9.864920238548025
              ],
              [
                106.85052500531741,
                10.021152885772368
              ],
              [
                106.94047556684085,
                10.313800968720543
              ],
              [
                107.07437144086428,
                10.365814064773195
              ],
              [
                107.11419688031741,
                10.377971726578185
              ],
              [
                107.15539561078616,
                10.432000055889604
              ],
              [
                107.0585785941846,
                10.544753916679875
              ],
              [
                106.9706879691846,
                10.544078866320678
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                103.09124595064287,
                10.993635623768489
              ],
              [
                103.08897311425721,
                10.917221184048904
              ],
              [
                103.12010430613135,
                10.853388451801099
              ],
              [
                103.16633370294295,
                10.855634787881026
              ],
              [
                103.52966910738115,
                10.67430448271298
              ],
              [
                103.68520065944797,
                10.742749951213472
              ],
              [
                103.7408126010335,
                10.951167770434935
              ],
              [
                103.6199629916585,
                11.143909066576713
              ],
              [
                103.44143515962725,
                11.254374601648335
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                102.31602317232256,
                12.204333306129444
              ],
              [
                102.32838279146318,
                12.15600774201003
              ],
              [
                102.59480124849443,
                12.010306878351578
              ],
              [
                102.735563577596,
                12.155336491714632
              ],
              [
                102.57969504732256,
                12.242584794973272
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                102.19428393705833,
                12.457397343880976
              ],
              [
                102.08373401030052,
                12.531139592704376
              ],
              [
                101.97078082426536,
                12.616587166701427
              ],
              [
                101.9288954482888,
                12.60117519715539
              ],
              [
                101.94777819975364,
                12.518738959202262
              ],
              [
                102.07961413725364,
                12.420853634548678
              ],
              [
                102.22277972563255,
                12.29743886292972
              ],
              [
                102.27462146147239,
                12.250136832708609
              ],
              [
                102.28217456205833,
                12.236380748778728
              ],
              [
                102.28114459379661,
                12.220275155027878
              ],
              [
                102.28904101713646,
                12.213228649351885
              ],
              [
                102.36731860502708,
                12.289388053749182
              ],
              [
                102.24578235014427,
                12.399059069681154
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                101.63700802122953,
                12.653438112151493
              ],
              [
                101.65589077269438,
                12.62965310975984
              ],
              [
                101.71391231810453,
                12.660137712868265
              ],
              [
                101.85295803343656,
                12.630323140131354
              ],
              [
                101.88111049925688,
                12.643723378729947
              ],
              [
                101.75339443480375,
                12.726789139891773
              ],
              [
                101.68061001097563,
                12.729133344213677
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                101.04314630914192,
                12.671762035277093
              ],
              [
                100.97756796512489,
                12.661967378505134
              ],
              [
                100.95113581109504,
                12.630726090376822
              ],
              [
                101.15335291314582,
                12.621345520216273
              ],
              [
                101.19678324151496,
                12.635081238125705
              ],
              [
                101.22459238458137,
                12.65618590249526
              ],
              [
                101.22648065972786,
                12.675446572647264
              ],
              [
                101.10339878964545,
                12.689697472899143
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                99.94276266702852,
                13.132249242581056
              ],
              [
                100.26273947366914,
                13.156320848811344
              ],
              [
                100.97410421976289,
                13.311392104523733
              ],
              [
                101.09632712015352,
                13.626574435457904
              ],
              [
                100.27509909280977,
                13.665275690015724
              ],
              [
                99.82328634866914,
                13.418280042877132
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                99.06525250919694,
                10.338656554953152
              ],
              [
                99.29184552677506,
                10.165681905415294
              ],
              [
                99.35639020450944,
                10.285963356784254
              ],
              [
                99.16962262638444,
                10.43186130242227
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                99.12632425105943,
                9.19341413313774
              ],
              [
                99.36802346980943,
                9.110709816516168
              ],
              [
                99.80747659480943,
                9.250346870178099
              ],
              [
                99.87614114559068,
                9.368249601085473
              ],
              [
                99.84043557918443,
                9.44682922185508
              ],
              [
                99.63169534480943,
                9.342504127078763
              ],
              [
                99.57951028621568,
                9.393993166657467
              ],
              [
                99.34193094051255,
                9.404831990522746
              ],
              [
                99.23344095027818,
                9.41025127512485
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                100.06840188777818,
                8.345514250328584
              ],
              [
                100.4461715406413,
                7.317635987802172
              ],
              [
                100.84494413922326,
                6.828766942908107
              ],
              [
                101.23772254617664,
                6.764040465599855
              ],
              [
                102.16951309266742,
                6.122530941197481
              ],
              [
                102.31280177890774,
                6.0228217582351435
              ],
              [
                103.35943398558089,
                3.4963386320895036
              ],
              [
                103.5157899492493,
                3.535099094246775
              ],
              [
                103.56230092740483,
                3.6615696736320382
              ],
              [
                103.49061918823513,
                4.813262412301439
              ],
              [
                103.23714365410092,
                5.210283261333487
              ],
              [
                103.0986527538341,
                5.481694182195043
              ],
              [
                102.84804536209879,
                5.639247032632445
              ],
              [
                102.64124133146552,
                5.840442074589577
              ],
              [
                102.47805208866791,
                6.084210516049115
              ],
              [
                102.3773733920752,
                6.239761216371432
              ],
              [
                101.72252199380759,
                6.769089181990344
              ],
              [
                101.47952334071306,
                6.945920796992589
              ],
              [
                100.41996438777818,
                7.8193316660419
              ],
              [
                100.34306009090318,
                8.288442633811831
              ],
              [
                100.16590554988755,
                8.55198905143703
              ],
              [
                99.97913797176255,
                8.694554519997254
              ],
              [
                99.9269529131688,
                8.651111701426476
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                103.34934483279436,
                3.3334206984149066
              ],
              [
                103.38093052615373,
                2.9872805478970568
              ],
              [
                103.50110064268706,
                2.7640578493701096
              ],
              [
                103.52508647326634,
                2.771174215664855
              ],
              [
                103.54709873904436,
                2.791835486355177
              ],
              [
                103.50109349002092,
                3.1641798249826842
              ],
              [
                103.49766026248186,
                3.386289442932862
              ],
              [
                103.56151829470842,
                3.5261103185227647
              ],
              [
                103.46607456912248,
                3.560376965130011
              ],
              [
                103.4502817224428,
                3.5343344293425263
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                103.81530853524984,
                2.3526605532246663
              ],
              [
                103.94096466317953,
                2.2380827797575327
              ],
              [
                103.97186371103109,
                2.2195573765626424
              ],
              [
                104.03984161630453,
                2.2874827052552056
              ],
              [
                103.88752438557961,
                2.4231520302567287
              ],
              [
                103.8593719197593,
                2.5205649558950736
              ],
              [
                103.83671261800148,
                2.5740703802906584
              ],
              [
                103.81130673421242,
                2.6124831486193427
              ],
              [
                103.7659881306968,
                2.652952472356752
              ],
              [
                103.74264218343117,
                2.6646128800580478
              ],
              [
                103.54969479573586,
                2.7860116505763735
              ],
              [
                103.52806522157523,
                2.7735809347587246
              ],
              [
                103.50918271077492,
                2.7578921253619617
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                104.01199414544072,
                2.1253546961271432
              ],
              [
                104.03576922230833,
                2.066600032923717
              ],
              [
                104.05297832855557,
                2.076077909432527
              ],
              [
                104.03036191074494,
                2.1181498620699672
              ],
              [
                103.99208142795135,
                2.178875260384997
              ],
              [
                103.98452832823298,
                2.187280561982744
              ],
              [
                103.9728553569109,
                2.1932843198796808
              ],
              [
                103.97036625672723,
                2.1929412539333377
              ],
              [
                103.96547391757517,
                2.190025140092039
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                104.0792002447331,
                1.9174537145582364
              ],
              [
                104.11524913389326,
                1.8299532299587147
              ],
              [
                104.15301463682295,
                1.8412770669214644
              ],
              [
                104.14717815000654,
                1.8539734046056222
              ],
              [
                104.13756511289716,
                1.9051009714591662
              ],
              [
                104.1063227422917,
                1.955197652497735
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                104.23818060966317,
                1.6521942176627713
              ],
              [
                104.25294348808114,
                1.6600873424740359
              ],
              [
                104.22685095878427,
                1.6988661472584
              ],
              [
                104.20796820731942,
                1.7005820057229066
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                104.26530310722177,
                1.3698037019679732
              ],
              [
                104.30787512870614,
                1.422316489343628
              ],
              [
                104.2666763982374,
                1.460756467531867
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                110.03152696006588,
                2.3762569122537074
              ],
              [
                108.71316687575349,
                1.6681232719181946
              ],
              [
                110.23474887246779,
                1.1354180171786894
              ],
              [
                111.6904267441907,
                1.0420316984429001
              ],
              [
                112.15186154480149,
                2.7823047210790692
              ],
              [
                113.26695574225346,
                3.023685528365633
              ],
              [
                113.28343498518426,
                3.237595154006612
              ],
              [
                115.54962463290526,
                4.934704719690608
              ],
              [
                116.67291029357638,
                6.498893639571357
              ],
              [
                116.48221272128573,
                6.524095823713878
              ],
              [
                116.3299872547046,
                6.440082808535625
              ],
              [
                116.10806846365631,
                6.217350591526773
              ],
              [
                116.19707189027378,
                6.154110705844474
              ],
              [
                116.00186564530047,
                5.732655780822767
              ],
              [
                115.93007700330885,
                5.780252653810443
              ],
              [
                115.70991560445201,
                5.574802185954898
              ],
              [
                115.58682726869993,
                5.570275872343941
              ],
              [
                115.50768014843865,
                5.598535158357711
              ],
              [
                115.34490971541742,
                5.449122078893742
              ],
              [
                115.40940359893672,
                5.330703750169146
              ],
              [
                115.10436227117006,
                5.048256605690432
              ],
              [
                115.05397719650533,
                5.061881811585597
              ],
              [
                114.79487005968981,
                4.971503423543598
              ],
              [
                114.50194316164026,
                4.755094466063257
              ],
              [
                113.94923483268403,
                4.6284622811512
              ],
              [
                113.76148876211008,
                4.287486759847235
              ],
              [
                113.35738355495221,
                3.707843021896675
              ],
              [
                113.40823463034039,
                3.6015966111041995
              ],
              [
                113.09034793542874,
                3.2551221215186383
              ],
              [
                112.93695386849272,
                3.2902413544072973
              ],
              [
                112.82751093700594,
                3.210174016232231
              ],
              [
                111.29494613498996,
                3.138885028814194
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                99.41729354338997,
                10.90217856474417
              ],
              [
                99.49969100432747,
                10.78348651881546
              ],
              [
                100.12591170745247,
                12.209928405885684
              ],
              [
                100.20830916838997,
                13.19056940787706
              ],
              [
                99.85125350432747,
                13.19056940787706
              ],
              [
                99.29095076995247,
                10.945327597418332
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                99.27384161469045,
                10.441184879453951
              ],
              [
                99.3479993295342,
                10.655847899532976
              ],
              [
                99.34937262054983,
                10.704429956611847
              ],
              [
                99.26834845062795,
                10.719272922682123
              ],
              [
                99.17908453461233,
                10.491151256545761
              ],
              [
                99.26148199554983,
                10.402016427360213
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                99.15169525254693,
                10.297306266591479
              ],
              [
                99.05281829942193,
                9.815927656241914
              ],
              [
                99.25475646514484,
                9.388616372139744
              ],
              [
                99.35088683623859,
                9.395390782015388
              ],
              [
                99.24857665557452,
                9.611424412684801
              ],
              [
                99.17922545928546,
                9.679795184733205
              ],
              [
                99.16617919463702,
                9.734617141057884
              ],
              [
                99.15999938506671,
                9.788753451805178
              ],
              [
                99.17510558623859,
                9.928790087821202
              ],
              [
                99.19021178741046,
                10.032933128487127
              ],
              [
                99.19364501494952,
                10.060653893016676
              ],
              [
                99.1867785598714,
                10.11541230632279
              ],
              [
                99.22866393584796,
                10.21881935628295
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                99.93778590795303,
                8.650047211722137
              ],
              [
                99.97623805639053,
                8.651404879635933
              ],
              [
                99.9309194528749,
                9.255070440280425
              ],
              [
                99.8430288278749,
                9.326900009797559
              ],
              [
                99.80320338842178,
                9.283532974794966
              ],
              [
                99.90757350560928,
                8.669054116807125
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                100.87865202832641,
                13.307893406752362
              ],
              [
                100.81960051465454,
                12.728544148943204
              ],
              [
                100.96791594434204,
                12.709789864513468
              ],
              [
                100.95967619824829,
                13.329275090773255
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                101.21098845410766,
                12.652178770268781
              ],
              [
                101.36479704785766,
                12.579811537541536
              ],
              [
                101.42659514356079,
                12.574450188795861
              ],
              [
                101.44719450879516,
                12.613317429055138
              ],
              [
                101.51448576856079,
                12.621358191096533
              ],
              [
                101.65868132520141,
                12.620018081631823
              ],
              [
                101.65318816113891,
                12.673616978909694
              ],
              [
                101.21373503613891,
                12.687014943557141
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                102.64940540202448,
                12.101615500936939
              ],
              [
                102.96800891764948,
                11.335160694769108
              ],
              [
                103.14104358561823,
                11.351318284809842
              ],
              [
                102.77300159343073,
                12.133840103706746
              ],
              [
                102.69060413249323,
                12.144580772629643
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                103.08611194499323,
                11.270521212577878
              ],
              [
                103.00920764811823,
                11.205867194392852
              ],
              [
                103.07512561686823,
                11.011818715095472
              ],
              [
                103.13074390300105,
                11.025298463514341
              ],
              [
                103.15477649577448,
                11.149283066585863
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                103.86828383379874,
                10.278500915728188
              ],
              [
                103.97200237938677,
                10.004397166582171
              ],
              [
                104.0441082277711,
                10.198061280501722
              ],
              [
                104.10311659747062,
                10.02842107356131
              ],
              [
                104.50995406084952,
                9.93137840620646
              ],
              [
                104.58626063921623,
                9.989816166452052
              ],
              [
                104.56016810991936,
                10.172348074426926
              ],
              [
                104.58214076616936,
                10.118275336887155
              ],
              [
                104.62883266070061,
                10.093939630610636
              ],
              [
                104.71397670366936,
                10.166941211876892
              ],
              [
                104.38164027788811,
                10.577598578995755
              ],
              [
                103.88939117540609,
                10.67110663641596
              ],
              [
                103.40248378374748,
                10.672080832204184
              ],
              [
                103.50026343456516,
                10.596803048395302
              ],
              [
                103.55119802807359,
                10.560502777263984
              ],
              [
                103.55812284790161,
                10.52952352463662
              ],
              [
                103.57600415149352,
                10.531585141882168
              ],
              [
                103.58461629104342,
                10.544109990030817
              ],
              [
                103.6078962186585,
                10.502731676000861
              ],
              [
                103.62313887391336,
                10.46431694640415
              ],
              [
                103.63151422907629,
                10.48059262285283
              ],
              [
                103.74395813124548,
                10.427516883121857
              ],
              [
                103.83359964770862,
                10.370589579552588
              ],
              [
                103.8873354669575,
                10.35427408019659
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                108.58166730852953,
                11.231812926958758
              ],
              [
                108.12298810931078,
                11.000038477494755
              ],
              [
                107.91150129290453,
                10.773478026316523
              ],
              [
                107.10949933977953,
                10.37118543146814
              ],
              [
                107.12323224993578,
                10.314444416000876
              ],
              [
                107.41711652727953,
                10.392798354758684
              ],
              [
                107.41436994524828,
                10.479235066736905
              ],
              [
                107.44458234759203,
                10.48733727519504
              ],
              [
                107.54071271868578,
                10.44682411521427
              ],
              [
                107.91974103899828,
                10.614244086079692
              ],
              [
                108.22735822649828,
                10.800458521047176
              ],
              [
                108.62561262102953,
                11.11055857252478
              ],
              [
                108.60363996477953,
                11.204871898436332
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                109.39683893079292,
                12.695928086222679
              ],
              [
                109.40851190442574,
                12.708655053303879
              ],
              [
                109.37211969251167,
                12.803082586009404
              ],
              [
                109.34946039075386,
                12.803752158858384
              ],
              [
                109.19702508801949,
                12.673151924302108
              ],
              [
                109.1702459132148,
                12.621563094616883
              ],
              [
                109.19908502454292,
                12.62692345799027
              ],
              [
                109.21213128919136,
                12.635633808847167
              ],
              [
                109.23204400891792,
                12.643003873878373
              ],
              [
                109.22586419934761,
                12.677171395044848
              ],
              [
                109.23273065442574,
                12.688559550974142
              ],
              [
                109.25882318372261,
                12.695928086222679
              ],
              [
                109.28079583997261,
                12.722051172022912
              ],
              [
                109.29727533216011,
                12.739465069171816
              ],
              [
                109.29864862317574,
                12.750180718963975
              ],
              [
                109.31238153333199,
                12.757547465173172
              ],
              [
                109.33092096204292,
                12.763574643479105
              ],
              [
                109.34328058118355,
                12.77294996868822
              ],
              [
                109.35495355481636,
                12.740804550182483
              ],
              [
                109.36593988294136,
                12.716692809345759
              ],
              [
                109.35220697278511,
                12.699277349861221
              ],
              [
                109.35838678235542,
                12.683200482226676
              ],
              [
                109.38035943860542,
                12.686549913416584
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                109.31482556914963,
                13.154225871768052
              ],
              [
                109.27362683868088,
                13.130154060006834
              ],
              [
                109.42194226836838,
                12.902693367063273
              ],
              [
                109.46314099883713,
                12.945525419192144
              ],
              [
                109.37250379180588,
                13.084678648403488
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                109.22968152618088,
                13.875386029501364
              ],
              [
                109.31207898711838,
                13.907381048725908
              ],
              [
                109.00446179961838,
                15.151644725049216
              ],
              [
                108.86713269805588,
                15.18875692022485
              ],
              [
                108.97150281524338,
                14.62076666672611
              ],
              [
                109.15277722930588,
                13.960696246434289
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                108.07245080352595,
                16.136168040700962
              ],
              [
                108.15484826446345,
                16.273316023982566
              ],
              [
                107.22650353790095,
                17.067913547237648
              ],
              [
                107.10016076446345,
                17.05741078864082
              ],
              [
                107.04522912383845,
                17.120418467828618
              ],
              [
                107.08917443633845,
                17.314557532050003
              ],
              [
                106.52337853790095,
                18.05248982126815
              ],
              [
                106.32562463165095,
                18.031597571580043
              ],
              [
                106.41351525665095,
                17.58181842055102
              ],
              [
                107.86920373321345,
                16.2469488270528
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        }
      ],
      "coordinates": []
    }),
    thisIsRC = 
    /* color: #aa2600 */
    /* shown: false */
    ee.Geometry.MultiPolygon(
        [[[[105.59890781422358, 3.0926622631114267],
           [105.59607540150385, 3.0889340593229373],
           [105.60611759205561, 3.081520465779681],
           [105.61246906300288, 3.0834060089236757]]],
         [[[103.99325486913258, 2.4537492183764926],
           [103.97814866796071, 2.448346832043015],
           [103.99205323949391, 2.4292239247972085],
           [104.00861856236989, 2.4360841918358425]]],
         [[[106.64119766497093, 8.733174157696784],
           [106.62883823097825, 8.721381714235912],
           [106.65081088722825, 8.698474682215585],
           [106.65287082375168, 8.68897209457728],
           [106.67175357521653, 8.693723418519925],
           [106.65115420998215, 8.733767894716177]]],
         [[[108.919412826437, 10.552451087852013],
           [108.97966596974754, 10.543000484459288],
           [108.95220014943504, 10.564770188396338]]],
         [[[110.12606062315652, 18.55984879306336],
           [110.13979353331277, 18.538529365599764],
           [110.16777433775613, 18.557082300125796],
           [110.16588606260964, 18.59271780437398]]],
         [[[110.84106712240032, 19.483581799288476],
           [110.80948142904094, 19.466426746726558],
           [110.80295829671672, 19.404264947968855],
           [110.84656028646282, 19.460600089349217]]],
         [[[110.87198078667251, 19.55422138238065],
           [110.90699970757095, 19.53966225025022],
           [110.92416584526626, 19.599508053950238]]]]),
    toDW = 
    /* color: #3e48c7 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[104.49238163149833, 2.4157656631227886],
          [104.53340870059013, 2.416108680712027],
          [104.56344944155693, 2.431715889166377],
          [104.52207904971122, 2.492942414170052],
          [104.46937900698661, 2.4903699279408036]]]),
    DLSLRStoBRS = 
    /* color: #3d8b4e */
    /* shown: false */
    ee.Geometry.MultiPolygon(
        [[[[106.17528037892305, 3.1345232691868996],
           [106.18969993458711, 3.112583256635746],
           [106.27175446669271, 3.0594463156723277],
           [106.27965049611055, 3.094071015553092],
           [106.3009364850793, 3.0759014116263694],
           [106.31329612599336, 3.09681359023565],
           [106.32977561818086, 3.1557772176482453],
           [106.30024986134492, 3.191428024575271],
           [106.30093650685274, 3.255185028472142],
           [106.30299644337617, 3.307970035572365],
           [106.32084904162969, 3.328192029077646],
           [106.32428245411836, 3.3422445119235333],
           [106.33252220021211, 3.38405775043935],
           [106.28308372364961, 3.4286108544851523],
           [106.17459373341524, 3.3847431983947263],
           [106.13064842091524, 3.257241639262441],
           [106.16910056935274, 3.175659550165037]]],
         [[[105.67268363678981, 3.075855260416485],
           [105.60813895905544, 2.980201959882611],
           [105.70304032579594, 2.805141711506941],
           [105.71994401086562, 2.9080105414011457],
           [105.74878312219374, 3.060924762548585]]],
         [[[104.12932170251754, 2.8883536328706887],
           [104.0716434798613, 2.794398859075265],
           [104.14648784021286, 2.690148276052323],
           [104.1712070784941, 2.913726957246909]]],
         [[[104.27895583108445, 2.5989501943786193],
           [104.33543242410202, 2.551962488210059],
           [104.3285659690239, 2.579400775466175],
           [104.33423079446335, 2.610954073646809]]],
         [[[104.48938926873448, 2.4944077890246583],
           [104.4651850145841, 2.467482214839794],
           [104.51170524773839, 2.423062403532237],
           [104.52663978753331, 2.491663806589452]]],
         [[[103.90035919526566, 2.4988801928052715],
           [103.9903097567891, 2.3949482635692347],
           [103.98284259624229, 2.4497434633023314],
           [103.98584656098832, 2.5256336290310775]]],
         [[[104.04558472016801, 2.329429343372558],
           [104.12317566255082, 2.2529295807453074],
           [104.12008575776566, 2.340406550102844]]],
         [[[104.01262573579301, 2.258813740704597],
           [104.09193329194535, 2.142170102628713],
           [104.0943365512227, 2.244748377280802]]],
         [[[103.83477211370531, 2.711814077399721],
           [103.89657020940844, 2.6562568088459115],
           [103.9219760931975, 2.7169581406657595]]],
         [[[106.1728830621501, 2.8379849318543626],
           [106.09666541078292, 2.768716733854285],
           [106.2168283746501, 2.702873898718786],
           [106.2491007135173, 2.8252975001753455]]],
         [[[106.22879357508029, 3.0123467868013223],
           [106.23394341638888, 2.9778899832727337],
           [106.2514528768381, 3.0077183240807117]]],
         [[[106.12356515100802, 3.0061754988066514],
           [106.10914559534396, 2.993318536783646],
           [106.13506646326388, 2.9667470045931594],
           [106.1496576803049, 3.0111468168729587]]],
         [[[106.14828438928927, 2.977204264758804],
           [106.15051598718966, 2.9427463619049496],
           [106.18124337366427, 2.973947095990542]]],
         [[[106.11257884298897, 2.9477179410878684],
           [106.08202313420156, 2.9262884659628026],
           [106.1078583267963, 2.917631078059739],
           [106.12781390196263, 2.900615586280769],
           [106.14002324432964, 2.901279825514323],
           [106.15354694185147, 2.8963455415403216],
           [106.15926002963673, 2.9000689834906472],
           [106.13077493917072, 2.910687549861342],
           [106.14038797107106, 2.9427463394948155]]],
         [[[106.14785523584689, 2.91994527257577],
           [106.15025849512423, 2.9172879725849654],
           [106.15266175440158, 2.918059447423098],
           [106.15317673853244, 2.9208881839649963]]],
         [[[106.18051409611483, 2.960647876016469],
           [106.17439865964926, 2.9593835530448955],
           [106.17087960142172, 2.949183275584296],
           [106.1768019189266, 2.9407829768256897],
           [106.18405461210287, 2.9420258821650584],
           [106.18353962797201, 2.959426411155725]]],
         [[[105.94259115726774, 3.1120946549343067],
           [105.93441605466879, 3.019297562713553],
           [105.95896363157308, 3.034039847856332],
           [105.96600174802816, 3.0163833663541],
           [105.9845411767391, 3.095235312894979]]],
         [[[106.07228349877978, 3.1380162971279275],
           [106.10344003869677, 3.1531854393151013],
           [106.08241152002002, 3.166811768270291],
           [106.06730531884814, 3.1541281470753693]]],
         [[[105.70381408144924, 3.0763719684901982],
           [105.72175269534084, 3.0881994683462333],
           [105.73951964785549, 3.096512922049542],
           [105.70158248354885, 3.1051104650854886],
           [105.68742041995021, 3.0951686759831976]]],
         [[[105.63918357302639, 3.106224625279713],
           [105.64836745669338, 3.1127381536423395],
           [105.68106894900295, 3.1015965675454655],
           [105.68312888552639, 3.1198515662443715],
           [105.65540557314846, 3.123022590091579],
           [105.63454871584865, 3.1152235683290295]]],
         [[[105.58212434580916, 3.0852915139127197],
           [105.59692642637143, 3.070764235388074],
           [105.61756870695004, 3.0720498463216295],
           [105.58302913685542, 3.0928765272988397]]],
         [[[106.36850102322714, 3.045737079261944],
           [106.3872979440035, 3.0278236560556424],
           [106.39914257901327, 3.0291950290914014],
           [106.40472157376425, 3.0218238786205696],
           [106.41236050503866, 3.0263665703028018],
           [106.41836865323202, 3.050022543098998],
           [106.38609631436483, 3.05456511611892]]],
         [[[106.34652836697714, 3.1206544671144023],
           [106.30189640896933, 3.065802861002847],
           [106.34069188016073, 3.0373474791917774],
           [106.36266453641073, 3.1048849213643614]]],
         [[[106.35639889615194, 3.1591345912845856],
           [106.38171894925253, 3.154763869151614],
           [106.39236195462362, 3.1395947499361623],
           [106.41287548916952, 3.1365094783569973],
           [106.42094357388632, 3.1619626958015554],
           [106.35974629300253, 3.1617055957094755]]],
         [[[106.42188771145956, 3.248687456949236],
           [106.44420369046347, 3.2154381219363906],
           [106.45107014554159, 3.2617126716968032]]],
         [[[106.49553044217245, 3.212695860199129],
           [106.47905094998495, 3.2132100348362203],
           [106.46342976468222, 3.1907575016101344],
           [106.48900730984823, 3.1818449094874426],
           [106.50153859036581, 3.209268022668256]]],
         [[[106.38842378516584, 3.295323688601593],
           [106.39168535132795, 3.2714162357212393],
           [106.41297136207014, 3.2629328087094525],
           [106.41365800757795, 3.2746724815769572],
           [106.39760766883283, 3.298322790975456]]],
         [[[106.38275895972639, 3.298322790975456],
           [106.40902315040022, 3.300122248057691],
           [106.41305719275861, 3.328227629855315],
           [106.3728025998631, 3.32557136272715]]],
         [[[106.42757234715664, 3.402058344168611],
           [106.41959009312832, 3.3715559863137696],
           [106.44825754307949, 3.3843225395135943],
           [106.45512399815762, 3.404371685968572]]],
         [[[107.95854349089394, 4.780033696367472],
           [107.83220071745644, 4.6777296437047555],
           [107.93691415739785, 4.644537476425112],
           [108.01896829558144, 4.800218989742897]]],
         [[[107.65023965788613, 4.282404250519751],
           [108.03201456022988, 3.5480432335314824],
           [108.12402505827676, 3.648095855933778],
           [108.17071695280801, 3.6014973716847685],
           [108.18994302702676, 4.060520614938756],
           [108.25174112272988, 4.275556935188313]]],
         [[[108.8632446322552, 3.0843293491796175],
           [108.83509216643489, 2.80249064150549],
           [109.04932556487239, 2.889587051927002]]],
         [[[103.67321013376846, 4.823704016898117],
           [103.65458487436905, 4.812072287568317],
           [103.67552756235733, 4.786071233301529],
           [103.68977545664444, 4.822164534741735]]],
         [[[103.26605736026167, 5.237241429958907],
           [103.25704513797163, 5.239207291359838],
           [103.23927818545698, 5.217240575978501],
           [103.26142250308393, 5.20382084206657],
           [103.27000557193159, 5.235788397993053]]],
         [[[103.0011329548088, 5.744291644676648],
           [103.02688216135176, 5.744120845272551],
           [103.02739714548262, 5.797920116828518],
           [103.00233458444747, 5.792796596915074]]],
         [[[102.71497236685967, 5.949168808961963],
           [102.67222868399834, 5.891285980147523],
           [102.75116899435235, 5.873697963974298],
           [102.7619836611004, 5.9358511735170625]]],
         [[[102.66414830721449, 5.950138319128267],
           [102.68989734409958, 5.953339737510361],
           [102.69092748201918, 5.964053171598298],
           [102.68015573061537, 5.970754370354602],
           [102.65771100557875, 5.96640073462517]]],
         [[[100.04422254606582, 9.64244585774716],
           [100.06070203825332, 9.827200821182092],
           [100.03048963590957, 9.911084875690472],
           [99.65764112516739, 9.745325705694556],
           [99.62963020299044, 9.599656085222914],
           [99.65228950474825, 9.34906298249386],
           [99.924201125842, 9.345675342128045],
           [100.0944892117795, 9.620643378165367]]],
         [[[99.76312553664692, 10.118251887502359],
           [99.82423698684224, 10.026307348358333],
           [99.84552299758442, 10.162186685913953]]],
         [[[102.20877896716416, 12.178408382599173],
           [102.52875577380479, 11.77673477903199],
           [102.67844449450791, 11.939356855241936],
           [102.37494718005479, 12.154244340473998]]],
         [[[103.22026034829975, 10.799138620041099],
           [103.30265780923725, 10.58120144717901],
           [103.34797641275287, 10.514372197556444],
           [103.46745273111225, 10.608199039810398],
           [103.32531711099506, 10.801162068412411]]],
         [[[103.13339502301616, 10.331292959578118],
           [103.13373834577007, 10.298022181131557],
           [103.14163476910991, 10.29177296279075],
           [103.14729959454937, 10.280625401202252],
           [103.14781457868023, 10.259849350602783],
           [103.16377908673687, 10.265085719641185],
           [103.17596704450054, 10.324537756141046]]],
         [[[102.97224985776596, 10.361994838834239],
           [102.9662417095726, 10.382848570649045],
           [102.95328127561264, 10.368327090493299]]],
         [[[103.8235619260607, 10.39496490465593],
           [103.9883568479357, 10.26661724199055],
           [104.01925589578727, 10.005032859046434],
           [104.04397513406852, 9.959047781393204],
           [104.18130423563102, 10.220669597341578],
           [104.05839468973258, 10.498280258146835]]],
         [[[104.3502261742114, 9.73909491464735],
           [104.35640598378171, 9.705932531144416],
           [104.35503269276609, 9.682581535722578],
           [104.35709262928953, 9.661598096648284],
           [104.37288547596921, 9.62064278034523],
           [104.43605686268796, 9.612857323544546],
           [104.4384601219653, 9.73165058429866]]],
         [[[104.61149478993406, 9.838900531006441],
           [104.64376712880124, 9.766502153756857],
           [104.717924843645, 9.834841227668488]]],
         [[[103.47595653407653, 9.270378313462864],
           [103.50719806255019, 9.271309531276515],
           [103.56487628520644, 9.328229650033927],
           [103.54612155454771, 9.334837708336252],
           [103.52702394196893, 9.320101538360452],
           [103.47441073955214, 9.31264530041916],
           [103.45913287700331, 9.295874408615123]]],
         [[[106.48272653825725, 8.746801517218328],
           [106.56031748064007, 8.588640402549185],
           [106.62623544939007, 8.728477251533722],
           [106.64546152360882, 8.765803507047663]]],
         [[[106.63104196794475, 8.674856646259881],
           [106.65782114274944, 8.59407192742671],
           [106.68254038103069, 8.703364759745254]]],
         [[[108.91353131072646, 10.48760504730087],
           [108.96880627410536, 10.496382192867173],
           [108.9217710568202, 10.559502773464608],
           [108.91421795623427, 10.5541025880328]]],
         [[[105.88481457876453, 19.377683480621688],
           [105.9215501134325, 19.35160952248621],
           [105.92841656851063, 19.393066778242254]]],
         [[[106.90389519916026, 20.752504969164637],
           [107.43673211322276, 20.832103858754554],
           [107.60015374408214, 21.0885871653861],
           [107.65920525775401, 21.14495432801505],
           [107.77593499408214, 21.391947311690448],
           [107.37905389056651, 21.287057936433058],
           [106.92037469134776, 20.943728133830415]]],
         [[[108.02312737689464, 21.296014834492002],
           [107.66881829486339, 21.107805649306492],
           [107.73198968158214, 20.87573701611621],
           [107.88167840228526, 21.07833629055938]]],
         [[[109.07395735579568, 21.076964547539745],
           [109.14365187483865, 20.99557242644521],
           [109.16699782210428, 21.100028234279154]]],
         [[[110.44552971979356, 18.682581947363502],
           [110.48192193170762, 18.636880653578825],
           [110.47917534967637, 18.697216768153766]]]]),
    DLSLBRStoRS = 
    /* color: #ac871e */
    /* shown: false */
    ee.Geometry.MultiPolygon(
        [[[[106.34265862500112, 3.419837349186236],
           [106.3302990058605, 3.3595182607328495],
           [106.32068596875112, 3.3235306612077373],
           [106.30695305859487, 3.3094780032981026],
           [106.30386315380971, 3.2820576099058667],
           [106.30145989453237, 3.19295572609838],
           [106.346778498048, 3.1353654371342534],
           [106.3599966063001, 3.228078659327304],
           [106.3457488226389, 3.2776013952739462]]],
         [[[105.81928245270778, 3.033000884107596],
           [105.80795280182888, 2.956201608773837],
           [105.72246543610622, 2.8800827954292636],
           [105.7104491397195, 2.795728984125418],
           [105.8532714053445, 2.8262479426942932],
           [105.88863364899684, 3.027858244346578]]],
         [[[104.1760135970488, 2.91784149662945],
           [104.17326701501754, 2.668885538459224],
           [104.31677592615036, 2.670257339112557],
           [104.29480326990036, 2.928127779150818]]],
         [[[106.2436075494548, 2.7930639434974034],
           [106.22644141175948, 2.711104450248212],
           [106.24498084047042, 2.7207066895937584],
           [106.25562384584151, 2.7248219116333305],
           [106.2714166925212, 2.7889489574743265]]],
         [[[106.19169354337728, 2.957112070799732],
           [106.18384003538168, 2.9393257756985074],
           [106.18997692960775, 2.9374828421360735],
           [106.1984312524227, 2.9558691823189314]]],
         [[[105.98739477665251, 3.0805550727585778],
           [105.96628042728727, 3.012501825588189],
           [105.99117132694548, 3.0094161863979565],
           [106.00404593021696, 3.0615280245172922]]],
         [[[105.95083090336149, 3.0137017940231297],
           [105.95735403568571, 3.0298155274737053],
           [105.93829962284391, 3.0207301539834144]]],
         [[[106.09854768945361, 3.1435012101668898],
           [106.07520174218799, 3.1191616893151024],
           [106.09871935083056, 3.1225041217785527],
           [106.11743044091845, 3.1435869117044497],
           [106.11047815515185, 3.14187287961585],
           [106.10206674768115, 3.135959447314161]]],
         [[[106.12069200708056, 3.114276576604498],
           [106.10618662072802, 3.107334535357086],
           [106.12369608117724, 3.1041634642799893]]],
         [[[105.73419814516994, 3.092940331135367],
           [105.70407157351467, 3.075370525313642],
           [105.70853476931545, 3.0734849679478216],
           [105.71625953127834, 3.070570918193315],
           [105.74029212405178, 3.0817985367200498]]],
         [[[105.67042594363186, 3.103567779799408],
           [105.66656356265041, 3.0889978633965436],
           [105.68149810244533, 3.0839411985647356],
           [105.68433051516506, 3.099111120770401]]],
         [[[105.60687386928042, 3.081143690152761],
           [105.61343991694888, 3.069830357211813],
           [105.62159383235415, 3.075358478075704]]],
         [[[103.98603545455103, 2.4553819812028803],
           [103.98603545455103, 2.431456991465782],
           [103.9883528831399, 2.416192797594296],
           [104.01126967696314, 2.4167930781297717],
           [104.01564704207544, 2.4406325755408282]]],
         [[[104.09732181981326, 2.198452736847425],
           [104.09457523778201, 2.170663805016881],
           [104.1271908994031, 2.1545391284568045],
           [104.13800556615115, 2.176667630072468]]],
         [[[106.41270382779257, 3.024738060378362],
           [106.40146000760214, 3.0134241345064394],
           [106.42077191250937, 3.01068134686955]]],
         [[[106.36927349942343, 3.1943567957635377],
           [106.3664410867037, 3.185701329012457],
           [106.36626942532675, 3.1737035320145797],
           [106.36326535123007, 3.1689900736223424],
           [106.36395199673788, 3.164105194089906],
           [106.37665493863241, 3.1626482957355],
           [106.37545330899374, 3.1936712168972434]]],
         [[[106.45072682278769, 3.254514547521357],
           [106.44780857937948, 3.2390898227059126],
           [106.467892960483, 3.243545878507496]]],
         [[[106.50325520413534, 3.1970991066494405],
           [106.49364216702597, 3.1801309406213867],
           [106.51595814602987, 3.1844158574418007]]],
         [[[108.24624795866738, 4.237210841508641],
           [108.21191568327676, 4.201602051557139],
           [108.18994302702676, 3.6028679495383598],
           [108.39181680632363, 3.6261674565668303],
           [108.56622476530801, 4.057780922698406]]],
         [[[108.72797546721614, 3.043189505918966],
           [108.74445495940364, 2.831980713101816],
           [108.8357788119427, 2.9163318619137213],
           [108.85569153166927, 3.0713019033490325]]],
         [[[100.08885450407364, 9.605211844764822],
           [99.96388502165176, 9.379012446021944],
           [100.05658216520645, 9.344459942141098],
           [100.16095228239395, 9.580838272312192]]],
         [[[100.06276197477676, 9.804196630148544],
           [100.05589551969864, 9.777130832724623],
           [100.05314893766739, 9.66072286989793],
           [100.12593336149551, 9.635676342501721],
           [100.12318677946426, 9.763597107382525]]],
         [[[102.23899136950791, 11.718920208664692],
           [102.52051602771104, 11.767323931953825],
           [102.23899136950791, 12.112623346959115]]],
         [[[106.67115877865436, 8.780054361857074],
           [106.57708834408405, 8.677571798043237],
           [106.60386751888873, 8.597466590962586],
           [106.64506624935748, 8.670105083405229],
           [106.7171640276778, 8.751552105660387]]],
         [[[106.71206613786663, 8.706079705042484],
           [106.65438791521038, 8.632090420069181],
           [106.73335214860882, 8.651098231422386]]],
         [[[108.9217710568202, 10.562202830604281],
           [108.97292614715224, 10.502458532344763],
           [108.98528576629286, 10.509209880542464],
           [108.98116589324599, 10.58245250251052]]],
         [[[109.0310420115574, 20.987238442219017],
           [109.13472548323709, 21.003264922069643],
           [109.07258406478006, 21.072479526107923]]],
         [[[109.3125588096767, 19.97171320704235],
           [109.32560507432514, 19.83936072821396],
           [109.60781637803608, 19.892315002140567],
           [109.47323385850483, 19.994298893897184]]]]),
    SLtoPlateau = 
    /* color: #00a0a0 */
    /* shown: false */
    ee.Geometry.MultiPolygon(
        [[[[108.0217148776127, 4.7995347522740515],
           [108.00077218962441, 4.783454974455342],
           [107.93657083464394, 4.6400889226777],
           [108.03167123747598, 4.631191731109964],
           [108.06497354460488, 4.791323849160109]]],
         [[[108.88384399748958, 3.0891288942882373],
           [108.66343078948177, 2.948561941210254],
           [108.80968628264583, 2.799061515041106],
           [108.78428039885677, 2.676292271556859],
           [108.95250854827083, 2.6522856572019475],
           [109.10425720549739, 2.972562458035429]]],
         [[[108.90878681820664, 2.5560148608742046],
           [108.93487934750351, 2.404408402098512],
           [109.0605354754332, 2.5100545645342773]]]]),
    notRC = 
    /* color: #671700 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[103.41064727522318, 2.6025869519765803],
          [104.12475860334818, 1.3564074468980039],
          [107.82753726047083, 1.3783738459305968],
          [110.36537905734583, 1.482711418990795],
          [111.03005190890833, 1.3124740538287951],
          [111.91445132297083, 2.6958709244194807],
          [113.81508608859583, 3.2060560616707208],
          [116.07826968234583, 5.096139382741247],
          [117.39113589328333, 7.220524482774901],
          [116.10024233859583, 7.699829672763294],
          [113.40859194797083, 5.211029479333703],
          [109.99082774406239, 2.6739223886193035],
          [108.84275645499989, 4.652803472801571],
          [107.91441172843739, 5.544637072311616],
          [104.19213933334403, 3.761343449775456],
          [104.12544661869215, 5.983051916759455],
          [102.55440169681715, 6.970955889645657],
          [101.13167220462965, 8.625375002415636],
          [100.52742415775465, 9.877763475660533],
          [100.03853255619215, 11.146962371117581],
          [100.55488997806715, 11.776841798764384],
          [101.21406966556715, 11.803728146274294],
          [102.30720931400465, 10.791037824932522],
          [102.47200423587965, 9.357833859001788],
          [103.55415755619215, 8.283066709665098],
          [105.43831282962965, 7.809867873095166],
          [106.87752181400465, 8.206957311039917],
          [106.62629025986666, 8.735313782782896],
          [106.64860623887057, 8.739385845004172],
          [106.67332547715182, 8.644359510612336],
          [106.84464353135104, 8.633837259639954],
          [109.01460604740844, 10.487455427608106],
          [108.97855715824828, 10.542477286151543],
          [108.9081759936975, 10.554290515118002],
          [109.042985317893, 10.636295537356398],
          [109.54309352163628, 11.70334615738631],
          [109.57055934194878, 13.643322568370703],
          [109.25032337437892, 15.565340296215485],
          [107.44856556187892, 17.371790793636283],
          [106.1403472375066, 18.932447673574043],
          [106.4699370812566, 19.9634375792461],
          [108.4145171593816, 21.095162126788846],
          [109.3868071984441, 20.020221265921798],
          [108.53043857897507, 19.613940356621434],
          [108.40409580553757, 18.57056675049142],
          [109.57413975085007, 17.981153311241147],
          [110.23615621213446, 18.44343122848549],
          [110.10432027463446, 18.578864103045596],
          [110.15719197873602, 18.606848856254178],
          [110.18534444455634, 18.542411955034016],
          [110.60694478635321, 18.587975922822263],
          [110.7001906177065, 18.850056447812495],
          [110.96544631547007, 19.362354689380457],
          [110.7745588642982, 19.460791928993405],
          [110.86382278031382, 19.492188623669595],
          [110.90776809281382, 19.537492703028228],
          [110.8548928387915, 19.562731381359207],
          [110.9156609662329, 19.59863639158927],
          [110.95273982365478, 19.555937641590912],
          [111.20282409625528, 19.617528834970585],
          [110.96661804156778, 20.31195246898812],
          [110.9296432745809, 21.253336596542773],
          [112.96486055973715, 21.534642119432274],
          [114.23378145817465, 21.647012341728583],
          [116.11793673161215, 22.664506561620914],
          [115.82679903629965, 23.003705284094117],
          [113.75587618473715, 22.910130510309305],
          [112.38546054392711, 22.151318325462018],
          [110.13051669627086, 21.337510225756567],
          [109.83663241892711, 21.68757844995704],
          [108.24636142283336, 22.092797384457945],
          [107.54323642283336, 21.62631362462153],
          [106.43906418004273, 20.881395313148868],
          [105.75237097382534, 19.876872970043664],
          [105.2395257261805, 18.763881766723628],
          [106.10469906602425, 17.883369177993544],
          [106.80782406602425, 16.939862441143116],
          [108.562889983993, 15.208623452899621],
          [108.94117263884952, 14.202141810005052],
          [109.00606988877693, 12.776582543660917],
          [108.64352106065193, 11.420400716052885],
          [106.85422350153114, 10.521264692744406],
          [106.27744127496864, 9.950962290687473],
          [105.00904021278782, 8.911058218867915],
          [105.32685476112404, 10.0840049413432],
          [104.81873708534279, 10.824070955108015],
          [103.33832937049904, 11.41697057836184],
          [102.55420943027775, 12.448851489533638],
          [101.25895771570319, 13.103992230990157],
          [101.19029316492194, 13.587696694947743],
          [99.50114521570319, 13.44081736304574],
          [99.73735127039069, 12.956820027938251],
          [99.56154795325537, 11.608556757412249],
          [98.97460004830836, 10.457850805649624],
          [99.06798383737086, 9.109076904534273],
          [99.71617719674586, 8.93004404737879],
          [100.03853537903368, 7.970552057483635],
          [100.75782781233909, 6.647021639081341],
          [101.66419988265159, 6.385053284141534],
          [102.68043523421409, 5.437067848196338],
          [103.30390935530784, 4.7066067510820995],
          [103.10066228499534, 3.6630849254509905],
          [103.32588201155784, 2.832112076662316]]]),
    RSSRStoBRS = 
    /* color: #86d2d6 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[103.73620111062498, 2.6422998500649233],
          [103.79851419045896, 2.6422998500649233],
          [103.77911645486326, 2.707974504960689],
          [103.71766168191404, 2.7050595168228093]]]),
    miss2 = 
    /* color: #c6ff1a */
    /* shown: false */
    ee.Geometry.MultiPolygon(
        [[[[109.40805585113712, 12.695279760324581],
           [109.36685712066837, 12.676941713655726],
           [109.35698659149357, 12.679872540396852],
           [109.35312421051212, 12.692432844295388],
           [109.34642941681095, 12.682300914144706],
           [109.34333951202579, 12.672587280229529],
           [109.3436828347797, 12.668149031124816],
           [109.34085042205997, 12.668149031124816],
           [109.33715970245548, 12.664548130727763],
           [109.33544308868595, 12.663794447464163],
           [109.33046490875431, 12.663375733577357],
           [109.32943494049259, 12.662119587791832],
           [109.33836133209415, 12.650981491250118],
           [109.33896214691349, 12.647882836609691],
           [109.35046345916935, 12.649976526298543],
           [109.35655743805118, 12.654833820242027],
           [109.37140614715763, 12.658937324111953],
           [109.37046200958439, 12.661533384307829],
           [109.36771542755314, 12.666892908855944],
           [109.37217862335392, 12.673173458294892],
           [109.37741429535099, 12.670326295060509],
           [109.38462407318302, 12.669321406324372],
           [109.38865811554142, 12.669572628879857],
           [109.39449460235782, 12.668316513626321],
           [109.39612538543888, 12.672168580785796],
           [109.39337880340763, 12.677192928697876],
           [109.3949237558002, 12.681798493890076],
           [109.40436513153263, 12.668818960470567],
           [109.40762669769474, 12.668651478299202],
           [109.4136348458881, 12.647296600420072],
           [109.40539509979435, 12.64218791380402],
           [109.4055667611713, 12.639591656857595],
           [109.40805585113712, 12.635822849830708],
           [109.40076024261661, 12.635990353545509],
           [109.392005512392, 12.63289151705215],
           [109.38994557586857, 12.630462673000087],
           [109.40899998871036, 12.602738715981092],
           [109.41208989349552, 12.603743866559894],
           [109.41500813690372, 12.59788043261104],
           [109.43535001007267, 12.593775949050924],
           [109.435950824892, 12.595283726156504],
           [109.4330325814838, 12.5985505461365],
           [109.43406254974552, 12.605670394148442],
           [109.43517834869571, 12.609439645356796],
           [109.43577916351505, 12.61413019161688],
           [109.43697172039458, 12.61769638816276],
           [109.43748670452544, 12.623308100620454],
           [109.42495542400786, 12.646004964821062],
           [109.42881780498931, 12.670625849849037],
           [109.4163723551602, 12.685949893936582],
           [109.41070752972075, 12.695663017997843]]],
         [[[109.3380089365811, 12.633107363016626],
           [109.32590680950591, 12.638634986368675],
           [109.32058530682036, 12.640477500915793],
           [109.3156929575772, 12.639388743925773],
           [109.31251722210357, 12.635619933906215],
           [109.30427747600982, 12.631432302036686],
           [109.30221753948638, 12.625485746933702],
           [109.30281835430571, 12.61711008274657],
           [109.30599408977935, 12.61275462904446],
           [109.31955533855864, 12.60362468763471],
           [109.32504850262114, 12.607812774551784],
           [109.33603483074614, 12.609655511104835],
           [109.41225248211333, 12.55696477565883],
           [109.4119949900479, 12.562158937336033],
           [109.40770345562407, 12.564672203707666],
           [109.40366941326567, 12.570703942741915],
           [109.40049367779204, 12.573384670200696],
           [109.40057950848052, 12.57933243435128],
           [109.39800458782622, 12.583604686958294],
           [109.39594465130278, 12.585447597503245],
           [109.39688878887603, 12.588128171034604],
           [109.39783292644927, 12.591730147616822],
           [109.39731794231841, 12.594829482329265],
           [109.39319806927153, 12.598180072312847],
           [109.39105230205962, 12.599687823519513],
           [109.38985067242095, 12.602116959586873],
           [109.3859882914395, 12.606556355665171],
           [109.38761907452056, 12.609320469081245],
           [109.38590246075103, 12.616104984622995],
           [109.38684659832427, 12.620209110448187],
           [109.38590246075103, 12.625066970236231],
           [109.38066678875396, 12.627914638258142],
           [109.37603193157622, 12.62925470635596],
           [109.37139707439849, 12.63084602810089],
           [109.36676221722075, 12.632102327745683],
           [109.35972410076567, 12.632604845875063],
           [109.35749250286528, 12.628500918914995],
           [109.35577588909575, 12.627160846867271],
           [109.35242849224517, 12.62749586553751],
           [109.3471928202481, 12.629170952305568]]],
         [[[109.23020559185454, 12.596253488422223],
           [109.22951894634673, 12.525211089275617],
           [109.23501211040923, 12.526216543028628],
           [109.23312383526275, 12.551184053059039],
           [109.23930364483306, 12.572295628044104],
           [109.24548345440337, 12.572630718430153],
           [109.246856745419, 12.581677993604108],
           [109.24479680889556, 12.588547008119294],
           [109.23775869244048, 12.58988728219543],
           [109.23346715801665, 12.59558336889299]]],
         [[[109.19552999371001, 12.622386783138564],
           [109.20548635357329, 12.61183327357461],
           [109.2087479197354, 12.618031419226156],
           [109.20376973980376, 12.625066970236231]]]]),
    SRStoRS = 
    /* color: #538b5a */
    /* shown: false */
    ee.Geometry.MultiPolygon(
        [[[[99.83870481810898, 10.13141732768648],
           [99.83630155883164, 10.047251963162532],
           [99.89191984496445, 10.08916838850295]]],
         [[[100.06117796264023, 9.803484571422397],
           [100.04744505248398, 9.660687414054395],
           [100.09482359252304, 9.624132395298078],
           [100.11816953978867, 9.785892016283695]]],
         [[[100.08933042846054, 9.605176383090365],
           [99.95612119994492, 9.397268072416802],
           [100.02890562377304, 9.360684884914074],
           [100.18202757201523, 9.565229885249845]]]]),
    extraDirt = /* color: #d6b7d2 */ee.Geometry.Polygon(
        [[[103.75149345394502, 10.441107096581053],
          [103.88470268246064, 10.316831611944465],
          [103.86959648128877, 10.285755048731803],
          [103.98083305355439, 10.032976312149966],
          [104.04263114925752, 10.185748874057948],
          [104.49307060238252, 9.945065556143632],
          [104.62263372473039, 10.037365999757569],
          [104.71108055111299, 10.189127974733676],
          [104.32003593441377, 10.586932310688676]]]),
    CAtoSD = /* color: #c46dd6 */ee.Geometry({
      "type": "GeometryCollection",
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                103.08425786206787,
                10.950973559502351
              ],
              [
                103.07893635938233,
                10.942209586996238
              ],
              [
                103.07224156568115,
                10.928220401653249
              ],
              [
                103.07447316358154,
                10.917433109569764
              ],
              [
                103.08751942822998,
                10.928388949981667
              ],
              [
                103.08923604199951,
                10.949288200312036
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                103.06262852857178,
                10.984173177940688
              ],
              [
                103.07224156568115,
                10.980802828396085
              ],
              [
                103.08322789380615,
                10.978106521062445
              ],
              [
                103.08185460279053,
                10.972713832558325
              ],
              [
                103.07807805249756,
                10.972208262964873
              ],
              [
                103.07258488843506,
                10.964456087583232
              ],
              [
                103.09541585156983,
                10.9723767862588
              ],
              [
                103.09455754468506,
                10.991419299144543
              ],
              [
                103.06829335401123,
                10.992935906642817
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                100.79302464788138,
                12.934852248687504
              ],
              [
                100.79070721929251,
                12.932175346226948
              ],
              [
                100.79062138860404,
                12.924562747917836
              ],
              [
                100.79027806585013,
                12.92230402024564
              ],
              [
                100.78838979070365,
                12.918623086931632
              ],
              [
                100.78718816106498,
                12.914440142324388
              ],
              [
                100.78701649968802,
                12.913101585260046
              ],
              [
                100.78487073247611,
                12.911428378847264
              ],
              [
                100.78375493352591,
                12.909587838855694
              ],
              [
                100.78289662664115,
                12.906827003459194
              ],
              [
                100.7827249652642,
                12.904651778341696
              ],
              [
                100.78366910283744,
                12.902727524965442
              ],
              [
                100.79671536748587,
                12.923558871474917
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        }
      ],
      "coordinates": []
    }),
    SGtoCA = /* color: #72d668 */ee.Geometry.Polygon(
        [[[100.7951704150933, 12.936608950317368],
          [100.78787480657279, 12.935437817272017],
          [100.78032170598685, 12.934099372773474],
          [100.76306973760306, 12.930418613379647],
          [100.75869237249076, 12.906074043059924],
          [100.76899205510794, 12.89636901723341],
          [100.77431355779349, 12.899380962093673],
          [100.77637349431693, 12.904484452548894],
          [100.78650151555716, 12.90088692092647],
          [100.8204046375054, 12.930669575972152]]]);
/***** End of imports. If edited, may not auto-convert in the playground. *****/
///////////////////////////////
// Global coral atlas project - Southeastern ASia
// Contact: mitchell.lyons@gmail.com
// Region coordinator: Eva Kovacs (kovacsevam2@gmail.com)
// Description:
// - Developing a process to combine OBIA and supervised classification
// - This script loads the raw classification data (from *_classification script)
// - Then applied some cleanup and object-based relational rules
///////////////////////////////

// Table of contents
// 1. Setting constants
// 2. Data loads & vis
// 3. OBIA clean up rules
// 4. Export

// Load and libraries needed
var map_palettes = require('users/mitchest/global_reefs_modules:colour_pals');
var pkg_vis = require('users/mitchest/global_reefs_modules:pkg_vis');
var param_module = require('users/mitchest/global_reefs_modules:reef_params');

// ###########################################
// SENSOR GENERICS
var sensor_params = param_module.dove;         //<------------ THIS IS WHERE YOU CHOOSE THE SENSOR
// REGION AND SENSOR SPECIFIC LOAD PATHS
var region_params = param_module.nw_arabian_sea;          //<------------ THIS IS WHERE YOU CHOOSE THE REGION
//  ^^ all the data paths are in this module ^^
// ###########################################

// 1. Setting constants

// These will get written to the asset metadata 

var vars = {
  
  // analysis type
  geomorphic: true, // map geomorphic zonation (when set to true) or benthic habitat (when set to false)

  // analysis parameters
  image_data_scale: sensor_params.pixel,
  small_object_geo: ee.Number(400).int(), // smallest object szie in pixels (geomorphic)
  small_object_benthic: ee.Number(130).int(), // smallest object szie in pixels (benthic)
  smooth_radius: ee.Number(3), // radius in pixels for initial smooth 
  dist_to_land_ORF: 1000, //distance to land in meters to convert terrestrial reef flat to ORF
  dist_to_land_RC: 500, //distance to land in meters to convert reef crest to TRF - not used for Indo
  wave_height: 0.4, //cut off height for waves in metres, Hs95 threshold
  geo_depth_cutoff: 1100, //depth in centimetres
  chagos_depth_cutoff: 1500, //depth cut off for southern chagos region only
  shallowlag_depth_cutoff: 500, //depth in centimetres
  benthic_depth_cutoff: 1000, //depth in centimetres
  BRS_depth_cutoff: 500, // depth cutoff for changing BRS areas in geo to sand in benthic
  
  //############de
  // Clean-up stage selection
  cleanup_stage: 1, // set to 1, 2 or 3
  geo_refinement: false, // set to true to apply the refinement_mask (the other stage 3 masks will still run)
  
  /*
  - GEOMORPHIC 1: The first pass does a small object filter, just to generally clean noise and reduce the amount of cleaning needed
  -            2: The second pass runs the OBIA cleanup rules
  -            3: The third pass is the MANUAL cleanup stage, which includes AT LEAST the no_reef masking
                        - see below where it starts/ends (only that section is run)
                        - please put region specific stuff in here ONLY

  - BENTHIC 1: This is the main benthic stge - it does noise removal, no data reclaim and OBIA rules - review those if needed
            2: The second mas is the MANUAL stage - it's optional, but shuold include ALL region specific stuff
                        - see below where it starts/ends (only that section is run)
                        - please put region specific stuff in here ONLY
  */
  
  // DON'T TOUCH --->
  obia_2nd_pass: null,
  obia_clean: null, // run object-based relationship rules + small object clean up
  fast_clean: null, // run a faster (but less precise) version of the OBIA clean; only applies to geomorphic (`obia_clean: true` also)
  manual_clean: false, // apply manual touch ups
  // --------------<
  //############
  
  reproject_display: true,
  
  // export options
  do_export: true, // export the results?
  geomorph_output_name: region_params.sname + '_geo_clean', // DO NOT CHANGE - change in the pop up dialouge if you must
  benthic_output_name: region_params.sname + '_benthic_clean', // DO NOT CHANGE - change in the pop up dialouge if you must
  asset_output: region_params.asset // asset path

};


// Clean up stage auto-parameterisation (DON'T TOUCH) --->

if (vars.geomorphic) {
  var temp_outname = vars.geomorph_output_name;
  if (vars.cleanup_stage == 1) {
    vars.obia_2nd_pass = false;
    vars.obia_clean = false;
    vars.fast_clean = true;
    vars.manual_clean = false;
    vars.geomorph_output_name = temp_outname + '1';
  } else if (vars.cleanup_stage == 2) {
    vars.obia_2nd_pass = true;
    vars.obia_clean = true;
    vars.fast_clean = true;
    vars.manual_clean = false;
    vars.geomorph_output_name = temp_outname + '2';
  } else if (vars.cleanup_stage == 3) {
    vars.manual_clean = true;
    vars.obia_2nd_pass = false;
    vars.obia_clean = false;
    vars.fast_clean = false;
    vars.do_export = false;
    vars.geomorph_output_name = temp_outname + '3';
  }
}

if (!vars.geomorphic) {
  var temp_outname = vars.benthic_output_name;
  if (vars.cleanup_stage == 1) {
    vars.obia_2nd_pass = true,
    vars.obia_clean = true, 
    vars.fast_clean = false, 
    vars.manual_clean = false;
    vars.benthic_output_name = temp_outname + '1';
  } else if (vars.cleanup_stage == 2) {
    vars.manual_clean = true;
    vars.obia_2nd_pass = false,
    vars.obia_clean = false, 
    vars.fast_clean = false,
    vars.do_export = false;
    vars.benthic_output_name = temp_outname + '2_v2';
  }
}

//Region extent is created in map viewer and exported to GEE asset
var region_extent = ee.FeatureCollection(region_params.extent_mask).geometry();
Map.addLayer(region_extent, {}, "Manual reef outline", false);
// -----------------------------------------<

//################################################################################################
//START OF CLEAN 3 - Manual Cleanup
//Review everything in this section
//This is the section to add/remove manual cleanups
//You MUST review it for each region

//###############################################################################################

if (vars.manual_clean && vars.geomorphic) {
  
  print("Doing GEOMORPHIC manual clean ups - make sure this is what you want to do");
  print("Export the manual map, check 'manual' layer in the viewer for effects");
  
 var depth = ee.Image(region_params.pixels).select('depth');
 var extent = ee.Image().byte().paint(ee.Feature(region_extent, {zone: 1}), "zone").clip(region_extent);

  // define the manually edited map - uses the output from the second pass of cleaning
  var man_geo = ee.Image(region_params.geo_map_clean3);
 // var man_geo = ee.Image(region_params.geo_map_clean2).clip(indo_west); // use this when testing for a small area
 
 
 
 /*  
  // Depth Cutoff <------ this is what I did
      
    // deep water in depth data == deep (s2 + ls8 data should be good enough for this)
    //deeper for chagos
    man_geo = man_geo.where({
      test: extent.eq(1)
        .and(depth.gt(vars.geo_depth_cutoff)),
      value: ee.Image(2)
    });
    
    
  
  // import the mid mask from asset ****only use ee.FC if mid_mask created in map viewer****
  //var mid_mask = ee.FeatureCollection(region_params.mid_mask).geometry();
  //Map.addLayer(mid_mask, {color: 'red'}, "mid mask import", true, 0.4);
 var midmask = ee.Image().byte().paint(ee.Feature(mid_mask.dissolve(),{zone: 1}), "zone").clip(mid_mask.dissolve());
  
  // the "MID MASK" CLEAN
  man_geo = man_geo.where({
    test: midmask.eq(1),
    value: ee.Image(0)
  });
  
  
  // the "REEF MASK" CLEAN
  
  // Define a kernel for reef mask Morphological Operations
  var kernel_rm = ee.Kernel.circle({radius: vars.smooth_radius.multiply(5)});

  // Create reef mask to clean areas inside the reef - Perform an dilation of deepwater
  var reef_mask = man_geo.eq(2)
            .focal_max({kernel: kernel_rm, iterations: 2});
  
  // Reef crest, slope, sheltered slope (within reef mask) -> Inner reef flat
  man_geo = man_geo.where({
    test: reef_mask.eq(0)
                    .and(man_geo.eq(15).or(man_geo.eq(21)).or(man_geo.eq(22))),
    value: ee.Image(13)
  });
  
  // the "DEEP WATER" CLEAN
  
  // Define a kernel for deep water Morphological Operations
   var kernel_dw = ee.Kernel.circle({radius: vars.smooth_radius.multiply(5)});

   // Create mask to clean deepwater areas - Perform an dilation of deepwater followed by a erosion
   var deepwater = man_geo.eq(2)
             .focal_max({kernel: kernel_dw, iterations: 2})
             .focal_min({kernel: kernel_dw, iterations: 2});
    
  */
  /*
   // Deep lagoon (outside reef mask and global mask) -> deepwater 
   man_geo = man_geo.where({
     test: deepwater.eq(1)
                     .and(man_geo.eq(12)),
     value: ee.Image(2)
   });
  
  
   // Reef classes in deepwater -> deepwater
   man_geo = man_geo.where({
     test: deepwater.eq(1)
                     .and(man_geo.eq(15).or(man_geo.eq(21)).or(man_geo.eq(22)).or(man_geo.eq(24))),
     value: ee.Image(2)
   });
  
  
  // WAVE clean (un-comment this sectio nbased on whether you have waves or not)
  
  var waves = ee.Image(region_params.waves)
  Map.addLayer(waves.lt(vars.wave_height), {}, vars.wave_height + "m Hs95 threshold", false)
  
  man_geo = man_geo.where({
    test: waves.lte(vars.wave_height)
               .and(man_geo.eq(22)),
    value: ee.Image(21)
  })
  
  */
  
  /*
  ###################
  ###################
  
  The rest of the manual geometry paintings and rules should go here
      - make the geom, paint the layer, use it in a rule
      - consult previous regions *_cleanup script for ideas/hints/existing rules etc.
  e.g. 
  var notreefcrest = ee.Image().byte().paint(ee.Feature(not_reef_crest, {zone: 1}), "zone").clip(not_reef_crest);
  var notdeepwater = ee.Image().byte().paint(ee.Feature(not_deep_water, {zone: 1}), "zone").clip(not_deep_water);
  */

  // Define the manual variables
  //var deepH2O = ee.Image().byte().paint(ee.Feature(toDW, {zone: 1}), "zone").clip(toDW);
  //var RS = ee.Image().byte().paint(ee.Feature(DLSLBRStoRS, {zone: 1}), "zone").clip(DLSLBRStoRS);
 // var BRS = ee.Image().byte().paint(ee.Feature(DLSLRStoBRS, {zone: 1}), "zone").clip(DLSLRStoBRS);
 // var SLtoPL = ee.Image().byte().paint(ee.Feature(SLtoPlateau, {zone: 1}), "zone").clip(SLtoPlateau);
 // var IsRC = ee.Image().byte().paint(ee.Feature(thisIsRC, {zone: 1}), "zone").clip(thisIsRC);
  //var Deepmask = ee.Image(DeepMask);
 // var NotRC = ee.Image().byte().paint(ee.Feature(notRC, {zone: 1}), "zone").clip(notRC);
 // var BRS2 = ee.Image().byte().paint(ee.Feature(RSSRStoBRS, {zone: 1}), "zone").clip(RSSRStoBRS);
 // var RS2 = ee.Image().byte().paint(ee.Feature(SRStoRS, {zone: 1}), "zone").clip(SRStoRS);
  var turb = ee.Image().byte().paint(ee.Feature(extraDirt, {zone: 1}), "zone").clip(extraDirt);
  /*
    // RS, SRS to BRS
    man_geo = man_geo.where({
    test: BRS2.eq(1)
          .and(man_geo.eq(21).or(man_geo.eq(22))), //SRS, RS
    value: ee.Image(24) // BRS
  });
  
      // SRS to RS
    man_geo = man_geo.where({
    test: RS2.eq(1)
          .and(man_geo.eq(21)), //SRS
    value: ee.Image(22) // RS
  });
  
  
  
      // Plateau and TRF to DW
  man_geo = man_geo.where({
    test: deepH2O.eq(1)
          .and(man_geo.eq(23).or(man_geo.eq(16))), //plateau, TRF
    value: ee.Image(2) // deep
  });
  
  
  // DL, SL and BRS to RS
    man_geo = man_geo.where({
    test: RS.eq(1)
          .and(man_geo.eq(12).or(man_geo.eq(11).or(man_geo.eq(24)))), //DL, SL, BRS
    value: ee.Image(22) // RS
  });
  
    // DL, SL and RS to BRS
    man_geo = man_geo.where({
    test: BRS.eq(1)
          .and(man_geo.eq(12).or(man_geo.eq(11).or(man_geo.eq(22)))), //DL, SL, RS
    value: ee.Image(24) // BRS
  });
  */
  /*
    // SL to Plateau
    man_geo = man_geo.where({
    test: SLtoPL.eq(1)
          .and(man_geo.eq(11)), // SL
    value: ee.Image(23) // Plateau
  });
  
    // RC to ORF
    man_geo = man_geo.where({
    test: extent.eq(1)
          .and(IsRC.neq(1).and(man_geo.eq(15))), //RC
    value: ee.Image(14) // ORF
  });
  
    // RC to ORF
    man_geo = man_geo.where({
    test: NotRC.eq(1)
          .and(man_geo.eq(15)), //RC
    value: ee.Image(14) // ORF
  });
  */
  // mask out west vietnam
  man_geo = man_geo.where({
    test: turb.eq(1),
    value: ee.Image(2) // deep
  });
  
  /*
  var Turbid2 = ee.Image().byte().paint(ee.Feature(turbid2, {zone: 1}), "zone").clip(turbid2);
  
    
      // Mask out turbid water
  man_geo = man_geo.where({
    test: Turbid2.eq(1)
      .and(man_geo.eq(16).or(man_geo.eq(15).or(man_geo.eq(14).or(man_geo.eq(13).or(man_geo.eq(12).or(man_geo.eq(11).or(man_geo.eq(21).or(man_geo.eq(22).or(man_geo.eq(23).or(man_geo.eq(24).or(man_geo.eq(25).or(man_geo.eq(26))))))))))))),
    value: ee.Image(2) // deep
  });

  
  /*
  ////////////////
  // For post-review refinement
  var Land = ee.Image().byte().paint(ee.Feature(Station_geoLand, {zone: 1}), "zone").clip(Station_geoLand);
  var Male = ee.Image().byte().paint(ee.Feature(DLandSD, {zone: 1}), "zone").clip(DLandSD);
  
      // Mask out research station land
  man_geo = man_geo.where({
    test: Land.eq(1),
    value: ee.Image(1) // Land
  });
  
      // Seaplane runway to DL
  man_geo = man_geo.where({
    test: Male.eq(1),
    value: ee.Image(12) // DL
  });
  //////////////////////
  */
  //var Deepmask = ee.FeatureCollection("Deep Mask import", true, 0.4);
  /* blocked out for post-review refinement
   // Reef crest -> outer reef flat
  man_geo = man_geo.where({
    test: RCtoFlat.eq(1)
            .and(man_geo.eq(15)), //RC
    value: ee.Image(14) // ORF
  });
  
    // Slope -> Deep Lagoon
  man_geo = man_geo.where({
    test: StoDL.eq(1)
           .and(man_geo.eq(22)), //RS
    value: ee.Image(12) // DL
  });
  
    // reef -> Deep 1 - image
  man_geo = man_geo.where({
    test: Deepmask.eq(1),
    value: ee.Image(2) // deep
  });  
  
  // reef -> Deep 2
  man_geo = man_geo.where({
    test: eDeep.eq(1),
    value: ee.Image(2) // deep
  });  
  
  
  // Reef classes in deep water -> deep water 3
  man_geo = man_geo.where({
    test: deep.eq(1),
    value: ee.Image(2) //deep
  });  
  
  // SRS near reef crest -> RS
  man_geo = man_geo.where({
    test: RS.eq(1)
                     .and(man_geo.eq(21)), //SRS
    value: ee.Image(22) //RS
  });
  
  */
  /*
  // Reef crest -> Inner reef flat (inside the reef)
  man_geo = man_geo.where({
    test: notreefcrest.eq(1)
                     .and(man_geo.eq(15)),
    value: ee.Image(13)
  });
  
  // Deep water -> Deep lagoon (inside the reef)
  man_geo = man_geo.where({
    test: notdeepwater.eq(1)
                     .and(man_geo.eq(2)),
    value: ee.Image(12)
  });
  
  ##############
  */
  
  if (vars.geo_refinement) {
    // make the mask image layer
    var refine = ee.Image().byte().paint(ee.Feature(refinement_mask, {zone: 1}), "zone").clip(refinement_mask);
    // apply
    man_geo = man_geo.where({
      test: refine.eq(1),
      value: ee.Image(0)
    });
  }
  
  // Add data + the manual layer to the map
  var lowtide_image = ee.ImageCollection(region_params.image);
  Map.addLayer(lowtide_image, region_params.visParams, sensor_params.sname + ' low tide', false);
  var geo_clean1 = ee.Image(region_params.geo_map_clean1);
  Map.addLayer(geo_clean1, map_palettes.geo, 'Geo clean stage 1', false);
  var geo_clean2 = ee.Image(region_params.geo_map_clean2);
  Map.addLayer(geo_clean2, map_palettes.geo, 'Geo clean stage 2', false);
  var geo_clean3 = ee.Image(region_params.geo_map_clean3);
  Map.addLayer(geo_clean2, map_palettes.geo, 'Geo clean stage 2', false);
  Map.addLayer(man_geo.updateMask(man_geo), map_palettes.geo, 'Geo clean stage 3', false);
  //Map.addLayer(DeepMask, {palette: ['F8FF23'], opacity: 0.4}, 'Deep Mask', false);
  //Map.addLayer(global_reef_mask.updateMask(global_reef_mask.eq(1)), {palette: ['F8FF23'], opacity: 0.4}, 'global_reef_mask - land', false);
  //Map.addLayer(global_reef_mask.updateMask(global_reef_mask.eq(3)), {palette: ['0000ff'], opacity: 0.4}, 'global_reef_mask - reef', false);
  //Map.addLayer(global_reef_mask.updateMask(global_reef_mask.eq(2)), {palette: ['FF0000'], opacity: 0.4}, 'global_reef_mask - water', false);

  // display distance to land mask for assessing cut-off distances
  var distToLand = ee.Image(region_params.distToLand);
    
  //Map.addLayer(distToLand.lte(vars.dist_to_land_RC), {}, 'RC to TRF ' + vars.dist_to_land_RC + 'm', false);
  Map.addLayer(distToLand.unmask(100000, false).lte(vars.dist_to_land_ORF), {}, 'TRF to ORF ' + vars.dist_to_land_ORF + 'm', false);
  
  // display distance to water mask
  var distToWater = ee.Image(region_params.distToWater);
    
  Map.addLayer(distToWater.unmask(100000, false).lte(vars.dist_to_land_ORF), {}, 'distToWater ' + vars.dist_to_land_ORF + 'm', false);
  
  
  // Export
  var output_name = (vars.geomorphic) ? vars.geomorph_output_name : vars.benthic_output_name;
  Export.image.toAsset({
    image: man_geo,
    description: output_name,
    assetId: vars.asset_output + 'in_out/' + output_name,
    region: region_extent,
    scale: vars.image_data_scale,
    crs: 'EPSG:4326',
    maxPixels: 1e13,
    pyramidingPolicy: {'.default': 'mode'}
  });
  
} 

if (vars.manual_clean && !vars.geomorphic) {
  
  print("Doing BENTHIC manual clean ups - make sure this is what you want to do");
  print("Export the manual map, check 'manual' layer in the viewer for effects");
  /*
  var depth = ee.Image(region_params.segments).select('depth');
  
  // define the final geomorphic map (the manually edited geo map - stage 3)
  var geo_map = ee.Image(region_params.geo_map_clean3);
  */
  
  // Cleanup after review
  // define the clean benthic map to apply 2nd stage rules to
  var man_benthic = ee.Image(region_params.benthic_map_clean2);

  var SGtoCoral = ee.Image().byte().paint(ee.Feature(SGtoCA, {zone: 1}), "zone").clip(SGtoCA);
  var CAtoSand = ee.Image().byte().paint(ee.Feature(CAtoSD, {zone: 1}), "zone").clip(CAtoSD);
  
  // SG on little northern reef -> CA 
  man_benthic = man_benthic.where({
    test: SGtoCoral.eq(1)
            .and(man_benthic.eq(14)), //SG
    value: ee.Image(15) //CA
  });
  
  // CA on little southern chubby reefs -> SD 
  man_benthic = man_benthic.where({
    test: CAtoSand.eq(1)
            .and(man_benthic.eq(15)), //CA
    value: ee.Image(11) //SD
  });
  
   /*     
  var turb = ee.Image().byte().paint(ee.Feature(extraDirt, {zone: 1}), "zone").clip(extraDirt);
  
  **Generic benthic rules**
    - should be generally applicable, but still review
  
  
  // BMA on inner RF, outer RF,reef crest, reef slope -> rubble 
  man_benthic = man_benthic.where({
    test: man_benthic.eq(18)
                     .and(geo_map.eq(13).or(geo_map.eq(14)).or(geo_map.eq(15)).or(geo_map.eq(22))),
    value: ee.Image(12)
  });
  
  // Rubble on Outer reef flat and Reef crest -> rock 
  man_benthic = man_benthic.where({
    test: man_benthic.eq(12)
                     .and(geo_map.eq(14).or(geo_map.eq(15))),
    value: ee.Image(13)
  });
  
  // Manual rules for SEA ben 2  
  // Coral/Algae where geo is BRS
  man_benthic = man_benthic.where({
    test: geo_map.eq(24) // BRS
            .and(man_benthic.eq(15)).and(depth.gt(vars.BRS_depth_cutoff)), // C/A
    value: ee.Image(11) // SD
  });
  

  // mask out west vietnam
  man_benthic = man_benthic.where({
    test: turb.eq(1),
    value: ee.Image(0) // ignore
  });
    
    // End manual rules for SEA ben 2
    
    
  // extra depth cutoff refinement
  man_benthic = man_benthic.where({
          test: depth.gt(vars.benthic_depth_cutoff),
          value: ee.Image(0)
        });
        
*/
  
  // Seagrass on RC or ORF -> Coral/Algae
  /*
  // except for these two areas
  var sg_orf = ee.Image().byte().paint(ee.Feature(sg_on_orf, {zone: 1}), "zone").unmask(geo_map.eq(42));
  
  man_benthic = man_benthic.where({
    test: man_benthic.eq(14)
                     .and(geo_map.eq(14).or(geo_map.eq(15)))
                     .and(sg_orf.eq(0)),
    value: ee.Image(15)
  });  
  */
  /*
    **Manual polygon guided rules**
   - same as per geomorphic clean section
   - add a geometry, paint the layer, create a rule
    
  var SGtoRK = ee.Image().byte().paint(ee.Feature(SGonRC, {zone: 1}), "zone").clip(SGonRC);

    // SG and SD on RC -> RK 
  man_benthic = man_benthic.where({
    test: SGtoRK.eq(1)
          .and(man_benthic.eq(14).or(man_benthic.eq(11))), // seagrass or sand
    value: ee.Image(13) //rock
  });  
  */
  /*
  ////////////////
  // Post-review refinement
  var Male = ee.Image().byte().paint(ee.Feature(DLandSD, {zone: 1}), "zone").clip(DLandSD);
  var StatSG = ee.Image().byte().paint(ee.Feature(Station_noSG, {zone: 1}), "zone").clip(Station_noSG);
  
    man_benthic = man_benthic.where({
    test: Male.eq(1),
    value: ee.Image(11) //sand
  });
  
    man_benthic = man_benthic.where({
    test: StatSG.eq(1)
           .and(geo_map.eq(14)), //seagrass
    value: ee.Image(15) //coral/algae
  });
  ///////////////
  */
  
  // final smooth for missing data due to depth
  var ben_mask = man_benthic.gt(0);
  man_benthic = man_benthic.focal_mode(2)
                          .updateMask(ben_mask)
                           .selfMask()
  
  
  // Add the manual layer to the map

  var dove_image = ee.Image(region_params.image);
  Map.addLayer(dove_image, {bands: ['b3','b2','b1'], min:0, max:4000, gamma:1.5}, sensor_params.sname + ' low tide', true);
  
  var benthic_clean1 = ee.Image(region_params.benthic_map_clean1);
  var geo_clean1 = ee.Image(region_params.geo_map_clean1);
  var geo_clean2 = ee.Image(region_params.geo_map_clean2);
  Map.addLayer(geo_clean1, map_palettes.geo, 'Geo clean stage 1', false);
  Map.addLayer(geo_clean2.updateMask(geo_clean2.gt(2)), map_palettes.geo, 'Geo clean stage 2', false);
  //Map.addLayer(geo_map.updateMask(geo_map.gt(2)), map_palettes.geo, 'Geo clean stage 3 - MANUAL', true);
  Map.addLayer(benthic_clean1, map_palettes.benthic, 'Benthic clean stage 1', false);
  Map.addLayer(man_benthic.reproject({crs:'EPSG:4326', scale: 5}), map_palettes.benthic, 'Benthic clean stage 2 - MANUAL', true);
  
  // Export
  var output_name = (vars.geomorphic) ? vars.geomorph_output_name : vars.benthic_output_name;
  Export.image.toAsset({
    image: man_benthic,
    description: output_name,
    assetId: vars.asset_output + 'in_out/' + output_name,
    region: region_extent,
    scale: vars.image_data_scale,
    crs: 'EPSG:4326',
    maxPixels: 1e13,
    pyramidingPolicy: {'.default': 'mode'}
  });
  
}

// #################################################################################################
// END OF MANUAL SECTION
// #################################################################################################


// 2. Data loads & vis

if (!vars.manual_clean) {

  // load input data
  
  // define raw geo/benthic outputs
  // Run check to see if the region has been split into multiple areas
  
  // geo
  if (ee.List(region_params.geo_map).length().getInfo() > 1) {
    var geo_map_raw = ee.Image(region_params.geo_map[0]).unmask(0, false)
                 .add(ee.Image(region_params.geo_map[1]).unmask(0,false))
                 .selfMask();
  } else {
    var geo_map_raw = ee.Image(region_params.geo_map);
  }
  
  // benthic
  if (ee.List(region_params.benthic_map).length().getInfo() > 1) {
      var benthic_map = ee.Image(region_params.benthic_map[0]).unmask(0, false)
               .add(ee.Image(region_params.benthic_map[1]).unmask(0,false))
               .selfMask();
  } else {
      var benthic_map = ee.Image(region_params.benthic_map);
  }
  
  // set the geo map for further processing
  if (vars.geomorphic && vars.obia_2nd_pass) {
    // if it's 2nd pass, you want to make sure you're loading the latest geo clean map
    var geo_map = ee.Image(region_params.geo_map_clean1);
  } else if (vars.geomorphic) {
    var geo_map = geo_map_raw;
  }
  
  var depth = ee.Image(region_params.pixels).select('depth');
  var low_tide_image = ee.Image(region_params.image);
  
  var display_pal = (vars.geomorphic) ? map_palettes.geo : map_palettes.benthic;
  Map.addLayer(depth, {min:0, max:2500}, 'Depth data', false);
  Map.addLayer(low_tide_image, {bands: ['b3','b2','b1'], min:0, max:3000}, sensor_params.sname + ' low tide', false);
  
  // load for display purposes
  if (vars.geomorphic) {
    Map.addLayer(geo_map_raw, display_pal, 'Geomorphic map RAW', false);
    if (vars.cleanup_stage == 2) Map.addLayer(ee.Image(region_params.geo_map_clean1), display_pal, 'Geo clean stage 1', false);
  }
  if (!vars.geomorphic) {
    // Use the manually cleaned geomorphic map as input for the benthic clean
    var geo_map = ee.Image(region_params.geo_map_clean3);
    Map.addLayer(geo_map.updateMask(geo_map.gt(2)), map_palettes.geo, 'Geo clean stage 3', false);
    Map.addLayer(benthic_map, display_pal, 'Benthic map RAW', false);
  }
  
  // 3. Object-based re-classificaiton and cleaning
  
  /* OUTPUT EXTENT
    - to the mapping extent just so it doesn't balloon out
    - to the 'reef boundary' extent for noise/deep removal
  */  
  var class_extent_mask = geo_map.gt(0);
  
  /*
  
  ########
  Initial small object clean
   - this was originally at the end, but we needed to massively reduce the number of objects to 
     iterate through in the OBIA cleaning, so this happens first now
   - future collabs with google might fix this, but need to change the parallel serialisation of vector procesing
   
   - includes a possible special case for:
        - geomorphic to clean up turbid areas over size threshold; fix shallow vs. deep lagoon
        - benthic to allow breaking waves (temporal class) to grow into surrounding class
  ########
  
  */
  
  // ##############################################################################################
  // START OF CLEAN 1
  // ##############################################################################################
  
  if (vars.geomorphic && !vars.obia_2nd_pass) {
    
    var chagos = ee.Image().byte().paint(ee.Feature(chagos_extent, {zone: 1}), "zone").clip(chagos_extent);
    var maldives = ee.Image().byte().paint(ee.Feature(maldives_extent, {zone: 1}), "zone").clip(maldives_extent);
    
    // shallow lagoon > 5m == deep lagoon
    geo_map = geo_map.where({
      test: geo_map.eq(11)
                    .and(depth.gt(vars.shallowlag_depth_cutoff)),
      value: ee.Image(12)
    });
    
    // deep water in depth data == deep (s2 + ls8 data should be good enough for this)
    //deeper for chagos
    geo_map = geo_map.where({
      test: chagos.eq(1)
                    .and(depth.gt(vars.chagos_depth_cutoff)),
      value: ee.Image(2)
    });
    
    // shallower for maldives and lakedives
    geo_map = geo_map.where({
      test: maldives.eq(1)
      .and(depth.gt(vars.geo_depth_cutoff)),
      value: ee.Image(2)
    });
    
    // make a smooth map with masked area as a value - *** Change to ee.kernal*** see reef mask in clean 3
    var smooth_map = geo_map
                        .focal_mode({
                          radius: vars.smooth_radius, // relates to smoothness required
                          kernelType: 'circle', units: 'pixels', iterations: 2
                        });
    
    // replace small objects with smooth underneath
    var clean_map = geo_map.where({
      test: geo_map.connectedPixelCount(vars.small_object_geo, false).lt(vars.small_object_geo), 
      value: smooth_map
    }).updateMask(class_extent_mask);
    
    // display distance to land mask for assessing cut-off distances
    var distToLand = ee.Image(region_params.distToLand);
    
    Map.addLayer(distToLand.lte(vars.dist_to_land_RC), {}, 'RC to TRF ' + vars.dist_to_land_RC + 'm', false);
    Map.addLayer(distToLand.unmask(100000, false).lte(vars.dist_to_land_ORF), {}, 'TRF to ORF ' + vars.dist_to_land_ORF + 'm', false);

    // // reef crest close to land -> TRF - Not need when using .focal masks (reef mask) as this will take care of RC inside the reef
    // clean_map = clean_map.where({
    //   test: distToLand.lte(vars.dist_to_land_RC)
    //                 .and(clean_map.eq(15)),
    //   value: ee.Image(16)
    // });
    
    // TRF outside of specified distance from land -> ORF
    clean_map = clean_map.where({
      test: distToLand.unmask(100000, false).gt(vars.dist_to_land_ORF)
                       .and(clean_map.eq(16)),
      value: ee.Image(14)
    });
  }
  
  if (!vars.geomorphic && vars.cleanup_stage == 1) {
    
    // make a smooth map with masked area as a value, and without temporal class (basically breaking waves)
    var smooth_map = benthic_map
                        .focal_mode({
                          radius: vars.smooth_radius, // relates to smoothness required
                          kernelType: 'circle', units: 'pixels', iterations: 1
                        });
    
    //replace small objects with smooth underneath
    var clean_map = benthic_map.where({
      test: benthic_map.connectedPixelCount(vars.small_object_benthic, false).lt(vars.small_object_benthic),
      value: smooth_map
    }).updateMask(class_extent_mask);
    
  }
  
  // ##############################################################################################
  // START OF CLEAN 2
  // ##############################################################################################
  
  if (vars.geomorphic && vars.obia_2nd_pass) {
    var clean_map = ee.Image(region_params.geo_map_clean3_absentlast);//geo_map;
  }
  
  if (vars.obia_clean) {
    
    if (vars.geomorphic && !vars.fast_clean) { 
      
      // FUNCTION that maps over feature colleciton and assigns neighbour percentages
      var set_neighbour_properties = function(f) {
        // make the 1px buffer
        var diff = f.buffer(vars.image_data_scale).difference(f, ee.ErrorMargin(0.5));
        // reduce the classes in the buffer zone
        var diff_classes = ee.Dictionary(
          clean_map.unmask(ee.Image(0)).reduceRegion({
            reducer: ee.Reducer.frequencyHistogram(),
            geometry: diff.geometry(),
            scale: vars.image_data_scale,
            maxPixels: 1e11
          }).get('classification')
        );
        // calculate the percentages
        var diff_sum = diff_classes.toArray().reduce(ee.Reducer.sum(), [0]).get([0]);
        var diff_percs = diff_classes.map(function(k,v){return(ee.Number(v).divide(diff_sum).multiply(100).toUint8())});
        
        /* NOW, we can try to do the class logic right here (see /users/mitchest/global_reefs/obia_dev),
           or we can return the neighbour % and do image logic via (painted) rasters */
        
        return(f.set(diff_percs));
      };
      
      // FUNCTION to reduce the map to vectors and map the neighbour properties function
      var reduce_neighbours = function() {
        // reduce map to vectors
        var map_fc = clean_map
              .updateMask(segment_id).updateMask(clean_map.eq(classn)) // only vectorise class/es of interest
              .reduceToVectors({
                scale: vars.image_data_scale, 
                eightConnected: false,
                bestEffort: true, 
                maxPixels: 1e13,
                tileScale: 1,
                geometry: region_extent
              });
        // map the function, calculate neighbour properties
        return(map_fc.map(set_neighbour_properties));
      };
      
      // first make a make size threshold, so we're not vecortising huge objects when we don't have to
      var segment_id = clean_map.connectedComponents(ee.Kernel.plus(1),vars.small_object_geo.sqrt()).select('labels');
      //Map.addLayer(segment_id.reproject(ee.Projection('EPSG:4326').atScale(ee.Number(vars.image_data_scale))))
      Map.addLayer(clean_map.updateMask(segment_id).reproject(ee.Projection('EPSG:4326').atScale(ee.Number(vars.image_data_scale))), display_pal, 'Map objects to be iterated through (OBIA)', false);
      
      // This is where we select the single or group of classes to vectorise for cleaning up
      //var classn = ee.Number(15) // one class
      var classn = clean_map.where({
        test: clean_map.neq(16) //TRF
                .and(clean_map.neq(15)) //RR
                .and(clean_map.neq(14)) //ORF
                .and(clean_map.neq(13)) //IRF
                //.and(clean_map.neq(12)) // deep L
                .and(clean_map.neq(11)), // shallow L 
        value: ee.Image(99) // 99 ensures it's ignored in logic
      });
      
      // Minimum size of object to reclass based on neighbourhood
      var max_size = ee.Number(1000).divide(vars.image_data_scale).pow(2); // the first number is the square dimension of the desired min size;
      // calculate neighbours
      var map_fc_neighbours = reduce_neighbours();
      
      // #########
      // REEF RIM
      // #########
      
      var focus_class = ee.Number(15); //RR
      
      // start the object-based neighbourhood rules
      // paint out to rasters (only paint the layers needed)
      var objsize = ee.Image(30000).paint(map_fc_neighbours, 'count').rename('count');
      //var nb24 = ee.Image().byte().paint(map_fc_neighbours, '24').unmask(0).rename('nb24') //OCL
      var nb22 = ee.Image().byte().paint(map_fc_neighbours, '22').unmask(0).rename('nb22'); //SL ex
      var nb21 = ee.Image().byte().paint(map_fc_neighbours, '21').unmask(0).rename('nb21'); //Sl sh
      var nb16 = ee.Image().byte().paint(map_fc_neighbours, '16').unmask(0).rename('nb16'); //TRF
      var nb15 = ee.Image().byte().paint(map_fc_neighbours, '15').unmask(0).rename('nb15'); //RR
      var nb14 = ee.Image().byte().paint(map_fc_neighbours, '14').unmask(0).rename('nb14'); //ORF
      var nb13 = ee.Image().byte().paint(map_fc_neighbours, '13').unmask(0).rename('nb13'); //IRF
      //var nb3 = ee.Image().byte().paint(map_fc_neighbours, '3').unmask(0).rename('nb3') //Turbid
      
      // RR surrounded by ORF --> ORF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb14.gt(75)),
        value: ee.Image(14)
      });
      
      // RR surrounded by IRF --> IRF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb13.gt(75)),
        value: ee.Image(13)
      });
      
      // RR surrounded by IRF + ORF --> IRF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb13.add(nb14).gt(75)),
        value: ee.Image(13)
      });
      
      // RR with decent border to TRF --> TRF (often dark, probably seagrass)
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb16.gt(40)),
        value: ee.Image(16)
      });
      
      // RR surrounded by OCL --> OCL
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb24.gt(75)),
        value: ee.Image(24)
      })
      
      // small RR objects touching OCL + stuff --> ORF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(objsize.lte(max_size))
                .and(nb13.lte(75).and(nb14.lte(75))) // to ensure we're no re-writing previous rules
                .and(nb24.gt(1)),
        value: ee.Image(14)
      })
      
      // ####
      // ORF
      // ####
      
      focus_class = ee.Number(14); // ORF
      
      // ORF surrounded by IRF --> IRF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb13.gt(75)),
        value: ee.Image(13)
      });
      
      // ORF surrounded by TRF --> TRF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb16.gt(75)),
        value: ee.Image(16)
      });
      
      // ORF surrounded by RR --> RR
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb15.gt(85)),
        value: ee.Image(15)
      });
      
      // ORF touching slope and RR --> RR
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb21.gt(0).or(nb22.gt(0)))
                .and(nb15.gt(0)),
        value: ee.Image(15)
      });
      
      // ####
      // IRF
      // ####
      
      focus_class = ee.Number(13); // IRF
      
      // IRF surrounded by ORF --> ORF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb14.gt(75)),
        value: ee.Image(14)
      });
      
      // IRF surrounded by TRF --> TRF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb16.gt(75)),
        value: ee.Image(16)
      });
      
      // IRF surrounded by RR --> RR
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb15.gt(85)),
        value: ee.Image(15)
      });
      
      // ####
      // TRF
      // ####
      
      focus_class = ee.Number(16); // TRF
      
      // TRF surrounded by ORF --> ORF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb14.gt(75)),
        value: ee.Image(14)
      });
      
      // TRF surrounded by IRF --> IRF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb13.gt(75)),
        value: ee.Image(13)
      });
      
      // TRF surrounded by IRF + ORF --> IRF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb13.add(nb14).gt(75)),
        value: ee.Image(13)
      });
      
      // ####
      // LAGOONS
      // ####
      
      var nb11 = ee.Image().byte().paint(map_fc_neighbours, '11').unmask(0).rename('nb11'); // shallow lag
      
      // SL sourrounded by DL --> DL
      clean_map = clean_map.where({
        test: clean_map.eq(11)
                .and(nb12.gt(75)),
        value: ee.Image(12)
      })
      
      // DL sourrounded by SL --> SL
      clean_map = clean_map.where({
        test: clean_map.eq(12)
                .and(nb11.gt(75)),
        value: ee.Image(11)
      })
      
      // DL/SL surrounded by IRF --> IRF
      clean_map = clean_map.where({
        test: clean_map.eq(11).or(clean_map.eq(12))
                .and(objsize.lte(max_size))
                .and(nb13.gt(80)),
        value: ee.Image(13)
      })
      
      // SL surrounded by IRF --> IRF
      clean_map = clean_map.where({
        test: clean_map.eq(11)
                .and(objsize.lte(max_size))
                .and(nb13.gt(80)),
        value: ee.Image(13)
      });
      
    
    } else if (vars.geomorphic && vars.fast_clean) {
      print("Executing the fast version OBIA");
      
      /* fast version of the geo clean up
        - blanket version assigns the underlying most common in neighbourhood
        - mode OBIA version iterates through objects+buffers but take the mode instead of doing the class percs, to see if that speeds things up
      */
      
      
      // ## Blanket version
      
      
      // make a very smooth map to capture the broader neighbourhood  - *** Change to ee.kernal*** see reef mask in clean 3
      var smooth_map = clean_map
                          .focal_mode({
                            radius: vars.smooth_radius.multiply(3), // relates to smoothness required
                            kernelType: 'circle', units: 'pixels', iterations: 2
                          });
      
      // first make a make size threshold, so we're not vectorising huge objects when we don't have t
      // - the unmask(99) captures small no data values/ data gaps
      var segment_id = clean_map.unmask(0).connectedComponents(ee.Kernel.plus(1),vars.small_object_geo.sqrt().multiply(2)).select('labels').pow(2).log().int();
      Map.addLayer(clean_map.unmask(0).updateMask(segment_id.gt(0)).reproject(ee.Projection('EPSG:4326').atScale(ee.Number(vars.image_data_scale))), display_pal, 'Map objects to be iterated through (OBIA)', false);
      
      // replace small objects with smooth underneath
      var clean_map = clean_map.unmask(0).where({
        test: segment_id.gt(0), 
        value: smooth_map
      }).selfMask();
      
      
      // ## mode OBIA version
      
      /* A possible faster plan
            - vectorise one/few class/es at a time, thus only spending resources on what is actually needed to clean up
            - BUT, just assign the mode of the neighbours, so save resouces even further??
      
      // FUNCTION that maps over feature colleciton and assigns neighbour percentages
      var set_neighbour_mode = function(f) {
        // make the 1px buffer
        var diff = f.buffer(vars.image_data_scale).difference(f, ee.ErrorMargin(0.5))
        // reduce the classes in the buffer zone
        var diff_mode = ee.Number(ee.Dictionary(
          clean_map.unmask(ee.Image(0)).reduceRegion({
            reducer: ee.Reducer.mode(),
            geometry: diff.geometry(),
            scale: vars.image_data_scale,
            maxPixels: 1e11
          })).get('classification'))
        
        return(f.set('mode',diff_mode))
      }
      
      // FUNCTION to reduce the map to vectors and map the neighbour properties function
      var reduce_neighbours_mode = function() {
        // reduce map to vectors
        var map_fc = clean_map.unmask(0)
              .updateMask(classn.gt(0)) // only vectorise class/es of interest
              .reduceToVectors({
                scale: vars.image_data_scale, 
                eightConnected: false,
                bestEffort: true, 
                maxPixels: 1e13,
                tileScale: 1,
                geometry: region_extent
              })
        // map the function, calculate neighbour properties
        return(map_fc.map(set_neighbour_mode))
      }
      
      // first make a make size threshold, so we're not vecortising huge objects when we don't have to
      var segment_id = clean_map.unmask(0).connectedComponents(ee.Kernel.plus(1),vars.small_object_geo.sqrt()).select('labels')
      Map.addLayer(clean_map.unmask(0).updateMask(segment_id.gt(0)).reproject(ee.Projection('EPSG:4326').atScale(ee.Number(vars.image_data_scale))), display_pal, 'Map objects to be iterated through (OBIA)', false)
      
      // This is where we select the single or group of classes to vectorise for cleaning up
      var classn = segment_id.where({
        test: clean_map.neq(16) //TRF
                .and(clean_map.neq(15)) //RR
                .and(clean_map.neq(14)) //ORF
                .and(clean_map.neq(13)) //IRF
                //.and(clean_map.neq(12)) // deep L
                .and(clean_map.neq(11)) // shallow L 
                .and(clean_map.unmask(0).neq(0)), // no data values (want to reclaim the small gaps 
        value: ee.Image(0) // 99 ensures it's ignored in logic
      })
      
      // calculate neighbours
      var map_fc_neighbours = reduce_neighbours_mode()
      
      //print(map_fc_neighbours.limit(10))
      
      var mode_map = ee.Image().byte().paint(map_fc_neighbours, 'mode').unmask(0).rename('mode') // paint out the mode values to an image
      //Map.addLayer(mode_map, display_pal, "mode map", false)
      
      // replace small objects with mode underneath
      var clean_map = clean_map.unmask(0).where({
        test: segment_id.gt(0), 
        value: mode_map
      }).selfMask()
      
      */
      
    } else {
      
      if (vars.cleanup_stage == 1) {
        // BENTHIC CLEAN-UP RULES
        
        /*// reclaim shallow no data to surrounding class
        var smooth_map = clean_map
                            .focal_mode({
                              radius: vars.smooth_radius.multiply(3), // relates to smoothness required
                              kernelType: 'circle', units: 'pixels', iterations: 2
                            });
        
        var clean_map = clean_map.unmask(0).where({
          test: geo_map.gt(2).and(clean_map.eq(0)), 
          value: smooth_map
        }).selfMask();*/
        
        // cut benthic off to < 10 - 15 m
        clean_map = clean_map.where({
          test: depth.gt(vars.benthic_depth_cutoff),
          value: ee.Image(0)
        });
        
        // Deep (or land or missing) in geo == masked from benthic
        clean_map = clean_map.where({
          test: geo_map.unmask(0).lte(2),
          value: ee.Image(0)
        });
        
      }
    }
  }
  
  // Final clip to the classified extent and move on
  if (vars.geomorphic) {
    clean_map = clean_map.updateMask(clean_map.gt(1)); // this ignores 0/land; make it .gt(2) if you want to mask deep too
  } else {
    clean_map = clean_map.updateMask(clean_map.gt(1)); // this ignores 0/land; make it .gt(2) if you want to mask deep too
  }

  
  
  // 4. Export data
  
  var output_name = (vars.geomorphic) ? vars.geomorph_output_name : vars.benthic_output_name;
  
  if (vars.do_export) {
    print("For export, the image data scale must be set to:", vars.image_data_scale);
    
    Map.addLayer(region_extent, {}, "Export footprint", false);
    
    Export.image.toAsset({
      image: clean_map.set(vars),
      description: output_name,
      assetId: vars.asset_output + 'in_out/' + output_name,
      region: region_extent,
      scale: vars.image_data_scale,
      crs: 'EPSG:4326',
      maxPixels: 1e13,
      pyramidingPolicy: {'.default': 'mode'}
    });
    
  } else {
    if (vars.reproject_display) {
      Map.addLayer(clean_map.reproject(ee.Projection('EPSG:4326').atScale(vars.image_data_scale)), display_pal, output_name, true);
    } else {
      Map.addLayer(clean_map, display_pal, output_name, false);
    }
  }

}

//Generate title
var title = ui.Label({
  value: 'Classes',
  style: {fontWeight: 'bold', fontSize: '12px'}
});

// generate the legend
var geo_legend = pkg_vis.discrete_legend(map_palettes.geo_atlas_names, map_palettes.geo_atlas_cols, 'Geomorphic Zone', false);
var benthic_legend = pkg_vis.discrete_legend(map_palettes.benthic_atlas_names, map_palettes.benthic_atlas_cols, 'Benthic Habitat', false);
//var mask_legend = pkg_vis.discrete_legend(["Low confidence depth","Water conditions"], ["#f7f7f7","#bababa"], 'Confidence Mask reason', false)
var legend = (vars.geomorphic) ? geo_legend : benthic_legend;
pkg_vis.add_lgds([title, legend]);//, mask_legend])
// generate the legend
