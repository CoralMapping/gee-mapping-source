/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var depth_pal = {"opacity":1,"bands":["depth"],"max":5,"palette":["e4e1ff","7f89ff","3a52ff","0007ff","000258"]},
    low_rrs = ee.Image("projects/coral_atlas/workflow/mapping/northern_caribbean/north_caribbean_bahamas_low_tide_normalized_sr_jan2018_nov2019_v2_shift_mosaic/20191218T154814Z/north_caribbean_bahamas_low_tide_normalized_sr_jan2018_nov2019_v2_shift_mosaic"),
    ncab = /* color: #0b4a8b */ee.Geometry.Point([-77.64269067777371, 22.111208619903458]),
    geo = ee.Image("projects/coral_atlas/nth_cari/in_out/nth_cari_geo"),
    benthic = ee.Image("projects/coral_atlas/nth_cari/in_out/nth_cari_benthic"),
    pixels = ee.Image("projects/coral_atlas/nth_cari/in_out/nth_cari_pixels"),
    geo_train = ee.FeatureCollection("projects/coral_atlas/nth_cari/training/nth_cari_geo_training"),
    wcmc = ee.FeatureCollection("projects/coral_atlas/global_datasets/wcmc_reefs_2018v4_dissolved"),
    benthic_baha = ee.Image("projects/coral_atlas/nth_cari/in_out/nth_cari_benthic_baha"),
    benthic_cari = ee.Image("projects/coral_atlas/nth_cari/in_out/nth_cari_benthic_cari"),
    Mask_NoReef = 
    /* color: #ff2705 */
    /* shown: false */
    ee.Geometry.MultiPolygon(
        [[[[-77.6908298412265, 17.939251182238742],
           [-78.014926520914, 17.68952937580111],
           [-78.03277930411713, 17.53507699179179],
           [-77.9215427318515, 17.456491321064465],
           [-77.57858671943977, 17.474591134093934],
           [-77.28195586006477, 17.401221189510085],
           [-77.18307890693977, 17.422187041414787],
           [-77.3067247743465, 17.71316271026819],
           [-77.28686729336015, 17.7779688370626],
           [-77.25082113799874, 17.88223019866347],
           [-77.36789419708077, 17.944952557251366],
           [-77.66301925382572, 17.959616187218742]]],
         [[[-83.01690576170415, 24.88280012027823],
           [-82.65435693357915, 24.773120340500828],
           [-82.48406884764165, 24.743190828730295],
           [-82.35346593519307, 24.716159508277997],
           [-82.04447545667745, 24.650025297105987],
           [-81.90714635511495, 24.62256306267632],
           [-81.75471105238057, 24.66812210467808],
           [-81.63248815198995, 24.73175208416546],
           [-81.57137670179463, 24.777271217309117],
           [-81.48976051950895, 24.803427689862843],
           [-81.4320822968527, 24.854528085146324],
           [-81.3277121796652, 24.880693287992354],
           [-81.2672873749777, 24.8582663103129],
           [-81.2233420624777, 24.822125402353972],
           [-81.2013694062277, 24.753553339479954],
           [-81.18900978708707, 24.731103346698955],
           [-80.88551247263395, 24.840820293007475],
           [-80.8553000702902, 24.889413791286202],
           [-80.77564919138395, 24.885676508121424],
           [-80.64381325388395, 24.99525643507288],
           [-80.57926857614957, 25.15447107454967],
           [-80.5641623749777, 25.33706310272239],
           [-80.89545732346333, 26.187344644893876],
           [-81.56562333908833, 27.55928025699306],
           [-83.21357255783833, 30.156868837088904],
           [-85.32294755783833, 30.422491697404215],
           [-86.48749833908833, 29.83336269866816],
           [-86.00409990158833, 28.779561312249186],
           [-84.57587724533833, 28.760300974368253],
           [-83.67499833908833, 27.129898289111296],
           [-83.19159990158833, 25.276847798301855]]],
         [[[-79.85915135145622, 27.093741751695887],
           [-79.71083592176872, 27.8443089332789],
           [-80.21071385145622, 28.666863837682545],
           [-80.77650974989372, 28.974878094316022],
           [-81.64442967176872, 29.066144120228167],
           [-81.67189549208122, 28.541473334329403],
           [-81.34779881239372, 27.751983553925765],
           [-81.16652439833122, 26.84405635406664],
           [-80.97975682020622, 26.47095321618231],
           [-80.77101658583122, 26.06703365755045],
           [-80.22170017958122, 26.534859871299503],
           [-80.21071385145622, 26.79503360454802],
           [-80.26564549208122, 27.030149059506883],
           [-79.92506932020622, 27.088851286645333]]]]),
    geo_clean = ee.Image("projects/coral_atlas/nth_cari/in_out/nth_cari_geo-clean3"),
    benthic_clean = ee.Image("projects/coral_atlas/nth_cari/in_out/nth_cari_benthic-clean");
/***** End of imports. If edited, may not auto-convert in the playground. *****/
// little viewing script for looking at reefs and classifications for each region

// imports
var pkg_vis = require('users/mitchest/global_reefs:Modules/pkg_vis')
var map_palettes = require('users/mitchest/global_reefs:Modules/colour_pals')

// choogse where to centre (link this dynamically to map app?)
//var centre_map = ncab
//Map.centerObject(centre_map, 10)
//splitting North Cari regions


// add some background data
//Map.addLayer(any_rrs, {bands: ['b3','b2','b1'], min: 66, max: 1260}, "Any tide mosaic", false)
//Map.addLayer(high_rrs, {bands: ['b3','b2','b1'], min: 66, max: 1260}, "High tide mosaic", false)
Map.addLayer(low_rrs, {bands: ['b3','b2','b1'], min: 66, max: 1260}, "Dove low tide mosaic", false)

//Map.addLayer(any_depth, {min: -1, max: 1200, palette:['#d0d1e6','#a6bddb','#74a9cf','#3690c0','#0570b0','#045a8d','#023858']}, "Any tide depth", false)
//Map.addLayer(high_depth, {min: -1, max: 1200, palette:['#d0d1e6','#a6bddb','#74a9cf','#3690c0','#0570b0','#045a8d','#023858']}, "High tide depth", false)
//Map.addLayer(low_depth, {min: -1, max: 1200, palette:['#d0d1e6','#a6bddb','#74a9cf','#3690c0','#0570b0','#045a8d','#023858']}, "Low tide depth", false)
Map.addLayer(pixels.select('depth'), {min: -1, max: 2500, palette:['#d0d1e6','#a6bddb','#74a9cf','#3690c0','#0570b0','#045a8d','#023858']}, "Depth covariate (S2/LS8/Dove)", false)

// nth cari
//Map.addLayer(benthic.updateMask(geo.gt(2)), map_palettes.benthic, "Nth. Cari & Baha Benthic - RAW", false)
Map.addLayer(ee.ImageCollection([benthic_baha,benthic_cari]).mosaic(), map_palettes.benthic, "Nth. Cari & Baha Benthic - RAW", false)
Map.addLayer(benthic_clean, map_palettes.benthic, "Nth. Cari & Baha Benthic - FINAL", false)
Map.addLayer(geo, map_palettes.geo, "Nth. Cari & Baha Geo - RAW", false)
Map.addLayer(geo_clean, map_palettes.geo, "Nth. Cari & Baha Geo - FINAL", false)

// wave data
/*var kd1 = ee.Image('users/danleeharris/reefwave/fiji_v1_kd1')
var kd2 = ee.Image('users/danleeharris/reefwave/fiji_v1_kd2')

Map.addLayer(kd1, {}, "waves - kd1", false)
Map.addLayer(kd2, {}, "waves - kd2", false)*/

// add training data / sample point distributions
// ----> possibly - points are only intermediate in the mapping script, so will have to pull those out if we want that
//Map.addLayer(ee.Image().byte().paint(fiji_training_geo_oldmaps, 'class_num'), map_palettes.geo, "Training data - geo (old maps) ", false)
//Map.addLayer(ee.Image().byte().paint(fiji_training_geo, 'class_num'), map_palettes.geo, "Training data - geo (new maps)", false)
//Map.addLayer(ee.Image().byte().paint(fiji_training_benthic, 'class_num'), map_palettes.benthic, "Training - benthic (manual curation)", false)
Map.addLayer(geo_train, {}, "geomorphic training locations", false)

// WCMC
Map.addLayer(wcmc, {}, "WCMC layer", false)





// #############
// example confidence layers

/*// depth and nir combos
var depth_nir_flag = fiji_dove_ocean.select('b4').multiply(fiji_high_depth_ocean).gt(250000)
//Map.addLayer(depth_nir_flag, {}, "NIR flag", false)
var conf_flag = fiji_high_depth_ocean.eq(-1)
                        .or(fiji_high_depth_ocean.gt(1000))
                        .add(depth_nir_flag.eq(1))
                        .selfMask()
Map.addLayer(conf_flag, {min:1,max:2,palette:["#f7f7f7","#bababa"]}, "Confidence flag", false)

//straight depth missing/-1
var depth_flag = fiji_high_depth_ocean.gt(0).selfMask()
//Map.addLayer(depth_flag, {min:0,max:1,palette:["#ffff00"]}, "Valid depth retrievals", false)

//Map.addLayer(fiji_geo_clean.gt(0).updateMask(fiji_high_depth_ocean.lte(0)), {min:0,max:1,palette:["#ff0000"]}, "Unmapped area via original algorithm", false)
*/

////////// UI SET UP //////////

//Generate title
var title = ui.Label({
  value: 'Coral Atlas map classes',
  style: {fontWeight: 'bold', fontSize: '18px'}
})

// generate the legend
var geo_legend = pkg_vis.discrete_legend(map_palettes.geo_atlas_names, map_palettes.geo_atlas_cols, 'Geomorphic Zone', false)
var benthic_legend = pkg_vis.discrete_legend(map_palettes.benthic_atlas_names, map_palettes.benthic_atlas_cols, 'Benthic Habitat', false)
//var mask_legend = pkg_vis.discrete_legend(["Low confidence depth","Water conditions"], ["#f7f7f7","#bababa"], 'Confidence Mask reason', false)
pkg_vis.add_lgds([title, geo_legend, benthic_legend])//, mask_legend])
// generate the legend




///////// LINK TO DATA EXPORT /////////
// hopefully eventually we can link this to a download link in the app?

// // map to export 
// var export_map = gbr_geo_map10
// // extent
// var export_convhull = export_map.gt(0).reduceToVectors({scale: 1000, maxPixels: 1e13, bestEffort: true, geometry: export_map.geometry().bounds()}).geometry().convexHull({maxError: 100})
// // export
// Export.image.toDrive({
//     image: export_map,
//     description: 'gbr_sent2_geo_map',
//     folder: 'GBR Mapping',
//     region: export_convhull,
//     scale: 10,
//     maxPixels: 1e13
// })
