/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var outline1 = ee.Image("projects/coral_atlas/reefMask/maskOut/reefMask_gen3_S30_v7_gridID_a"),
    reef_boundary = 
    /* color: #98ff00 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[-178.9902899370743, 28.223543414829674],
          [-174.31670726951845, 25.35687341614974],
          [-167.09539623806367, 22.871758319961504],
          [-170.0817066799553, 16.50934233576371],
          [-169.0058019722854, 16.066622127171755],
          [-166.37097585782607, 22.507211300901893],
          [-159.72242105060639, 20.55728446862732],
          [-154.4481229628139, 17.58286698869547],
          [-153.52755471286838, 20.385834406814258],
          [-159.43420248789334, 22.893106923083444],
          [-167.4874893752415, 24.965604306992145],
          [-178.2214120255763, 29.123686786807387]]]),
    geo = ee.Image("projects/coral_atlas/nth_cari/in_out/nth_cari_geo-clean3"),
    benthic = ee.Image("projects/coral_atlas/nth_cari/in_out/nth_cari_benthic-clean"),
    pixels = ee.Image("projects/coral_atlas/nth_cari/in_out/nth_cari_pixels"),
    lowtide_sr = ee.Image("projects/coral_atlas/workflow/mapping/northern_caribbean/north_caribbean_bahamas_low_tide_normalized_sr_jan2018_nov2019_v2_shift_mosaic/20191218T154814Z/north_caribbean_bahamas_low_tide_normalized_sr_jan2018_nov2019_v2_shift_mosaic"),
    nth_cari_finalmask = ee.FeatureCollection("users/rodbio2008/nth_cari_final_mask"),
    Final_refinements_RB = /* color: #010000 */ee.Feature(
        ee.Geometry.MultiPolygon(
            [[[[-75.67606535402598, 18.603710355987985],
               [-75.86832609621348, 18.74811912620401],
               [-75.86283293215098, 18.53341305388216],
               [-75.72962370363535, 18.496951206969467]]],
             [[[-78.35398283449473, 16.82467434420116],
               [-77.98182096926035, 16.995482992191484],
               [-77.87333097902598, 17.030939178634956],
               [-77.65085783449473, 17.213366264309578],
               [-77.64536467043223, 17.294678742544118],
               [-78.30179777590098, 17.354984155749893],
               [-78.38968840090098, 17.298612307548762]]],
             [[[-80.0163543649424, 24.23619289022307],
               [-80.10218505341896, 24.2111454165192],
               [-80.06510619599709, 24.171059217113235],
               [-80.04244689423928, 24.156650162825503],
               [-79.98408202607521, 24.179202745914434],
               [-79.9669158883799, 24.204256497753125],
               [-79.97996215302834, 24.23681901393681]]],
             [[[-79.95090062204157, 24.13648027317315],
               [-79.95845372262751, 24.131467256170897],
               [-79.95845372262751, 24.126924039785113],
               [-79.95193059030329, 24.13193723486255],
               [-79.94626576486384, 24.13178057549056]]],
             [[[-79.97853810373103, 24.16044604403435],
               [-79.98729283395564, 24.153554387343846],
               [-79.96978337350642, 24.1380468006846],
               [-79.95141560617243, 24.14556586555756],
               [-79.96497685495173, 24.15794003007392]]]]),
        {
          "system:index": "0"
        });
/***** End of imports. If edited, may not auto-convert in the playground. *****/
// NCB (last export 11/07/2020) export to Vulcan bucket


// so we can visualise maps before export
var map_palettes = require('users/mitchest/global_reefs:Modules/colour_pals')

// will need to import depth mosaic from pixels now
var depth = pixels.select('depth')//.multiply(100).uint16()

//additional masks (this session was created by RB on 11/07/2020 to address an easy way to mask the stack and re-export)

// addiitonal masking 
var nth_cari_finalmask = nth_cari_finalmask.merge(Final_refinements_RB)
var add_zone = function(f) {return(f.set('zone', 1))}
var exclude_fc = nth_cari_finalmask.map(add_zone)
Map.addLayer(exclude_fc, {}, "vector mask zone", false)
print (exclude_fc)

var exclude_mask = ee.Image().byte().paint(exclude_fc, 'zone').uint8()
//print (exclude_mask)

geo = geo.where(exclude_mask.eq(1), ee.Image(0))
benthic = benthic.where(geo.eq(0), ee.Image(0)) 

// finalise layers (include 'mapped area' as zeros)
geo = geo.where(geo.lte(2), 0)
benthic = benthic.unmask(0).updateMask(geo.gte(0))

// make reef/non-reef layer 
var reef_top = geo.eq([11,13,14,15,16,25,26]).reduce(ee.Reducer.sum())
var reef_all = geo.eq([11,12,13,14,15,16,21,22,23,24,25,26]).reduce(ee.Reducer.sum())
var reef_layer = reef_top.addBands(reef_all).reduce(ee.Reducer.sum())

// check before export
Map.addLayer(reef_layer.selfMask(), {min:0, max:2}, "reef layer", false)
Map.addLayer(geo, map_palettes.geo, "geomorphic map", false)
Map.addLayer(benthic, map_palettes.benthic, "benthic map", false)
Map.addLayer(exclude_mask, {}, 'nth_cari_finalmask_11-7_2020', false)
Map.addLayer(depth, {min: -3, max: 1200, palette:['#d0d1e6','#a6bddb','#74a9cf','#3690c0','#0570b0','#045a8d','#023858']}, "depth layer", false)
Map.addLayer(lowtide_sr, {"opacity":1,"bands":["b1","b2","b3"],"min":1,"max":1514,"gamma":1}, 'lowtide_sr', false)
// combine into single stack
var export_stack = depth.updateMask(geo.gte(0)).rename('depth')
                    .addBands(reef_layer.rename('reef'))
                    .addBands(geo.rename('geomorphic'))
                    .addBands(benthic.rename('benthic'))
                    .toInt16()

Map.addLayer(export_stack, {}, "export raster stack", false)

/*
// run the export
Export.image.toCloudStorage({
  image: export_stack,
  description: 'ncb_stack',
  bucket: 'coral-atlas-data-pipeline',
  fileNamePrefix: 'coral-gee-export-bucket/ncb_updated20200711/ncb_stack',
  region: reef_boundary, 
  scale: 5,
  crs: 'EPSG:4326',
  maxPixels: 1e13, 
  skipEmptyTiles: true
});
*/
Export.table.toCloudStorage({
  collection: exclude_fc, 
  bucket: 'coral-atlas-data-pipeline',
  fileNamePrefix: 'coral-gee-export-bucket/ncb_updated20200711/nth_cari_updatedmask20200711',
  fileFormat: 'SHP'
});
