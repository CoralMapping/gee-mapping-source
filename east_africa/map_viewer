/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var depth_pal = {"opacity":1,"bands":["depth"],"max":5,"palette":["e4e1ff","7f89ff","3a52ff","0007ff","000258"]},
    eaaf = /* color: #98ff00 */ee.Geometry.Point([40.98887512457759, -15.133024788287958]),
    high_rrs = ee.Image("projects/coral_atlas/workflow/mapping/east_africa/east_africa_high_tide_normalized_sr_jan2018_nov2019_v2_shift_mosaic/20191215T174409Z/east_africa_high_tide_normalized_sr_jan2018_nov2019_v2_shift_mosaic"),
    high_depth = ee.Image("projects/coral_atlas/workflow/mapping/east_africa/east_africa_high_tide_normalized_sr_jan2018_nov2019_v2_shift_mosaic/20191215T174409Z/east_africa_high_tide_normalized_sr_jan2018_nov2019_v2_shift_mosaic_depth"),
    low_rrs = ee.Image("projects/coral_atlas/workflow/mapping/east_africa/east_africa_low_tide_normalized_sr_jan2018_nov2019_v2_shift_mosaic/20191220T152846Z/east_africa_low_tide_normalized_sr_jan2018_nov2019_v2_shift_mosaic"),
    low_depth = ee.Image("projects/coral_atlas/workflow/mapping/east_africa/east_africa_low_tide_normalized_sr_jan2018_nov2019_v2_shift_mosaic/20191220T152846Z/east_africa_low_tide_normalized_sr_jan2018_nov2019_v2_shift_mosaic_depth"),
    benthic = ee.Image("projects/coral_atlas/east_africa/in_out/east_africa_benthic"),
    geo = ee.Image("projects/coral_atlas/east_africa/in_out/east_africa_geo"),
    wcmc = ee.FeatureCollection("projects/coral_atlas/global_datasets/wcmc_reefs_2018v4_dissolved"),
    geo_clean1 = ee.Image("projects/coral_atlas/east_africa/in_out/east_africa_geo-clean1"),
    geo_clean2 = ee.Image("projects/coral_atlas/east_africa/in_out/east_africa_geo-clean2"),
    geo_clean3man = ee.Image("projects/coral_atlas/east_africa/in_out/east_africa_geo-clean3-man"),
    benthic_clean = ee.Image("projects/coral_atlas/east_africa/in_out/east_africa_benthic-clean"),
    RiverMouth = /* color: #01ffff */ee.Geometry.MultiPolygon(
        [[[[47.71868486166308, -14.481513594664204],
           [47.66375322103808, -14.532034888954438],
           [47.63903398275683, -14.553303561139657],
           [47.62255449056933, -14.603808438731365],
           [47.59646196127245, -14.655630333142572],
           [47.55663652181933, -14.652973097867937],
           [47.53466386556933, -14.671573067816666],
           [47.54565019369433, -14.716737838766415],
           [47.53191728353808, -14.822970962242374],
           [47.4948384261162, -14.829608806088324],
           [47.33279008627245, -15.027322752101238],
           [47.34926957845995, -15.133402528785336],
           [47.5827290511162, -15.071087071295722],
           [47.62255449056933, -14.960996082130272],
           [47.72417802572558, -14.809694664082164],
           [47.88210649252245, -14.98620263888992],
           [48.18972368002245, -14.991508904355882],
           [48.20757646322558, -14.645001198729437],
           [48.20482988119433, -14.437630501380449],
           [47.96587724447558, -14.44428001183031]]],
         [[[47.93630489628834, -14.006285950230149],
           [47.910212366991466, -14.092879616896072],
           [47.945917933397716, -14.14348840568382],
           [47.95553097050709, -14.224705264621116],
           [47.91982540410084, -14.343149617925258],
           [47.93630489628834, -14.412324129320726],
           [48.055781214647716, -14.413654198414925],
           [48.15053829472584, -14.084887728450047],
           [48.14229854863209, -14.016945398393709],
           [47.959650843553966, -14.011615736170912]]],
         [[[48.93421889381694, -12.752247402126663],
           [48.883407126238815, -12.758944398314812],
           [48.842208395770065, -12.728136749578667],
           [48.76350643174089, -12.744113077781266],
           [48.76487972275652, -12.81777264552586],
           [48.81174725710502, -13.081290188041338],
           [48.89963788210502, -13.110716819047466],
           [49.019114200464394, -12.900641053562603],
           [48.95456952273002, -12.772099920719029]]],
         [[[48.73484296023002, -13.443525677220036],
           [48.684031192651894, -13.410131797661831],
           [48.546702091089394, -13.400780679251469],
           [48.50962323366752, -13.406124220026228],
           [48.5212313902568, -13.45080866773035],
           [48.5706698668193, -13.478855078839924],
           [48.6585604918193, -13.480190540206657],
           [48.717612005491176, -13.460157836625266]]],
         [[[49.766806341428676, -13.273105399566585],
           [49.78740570666305, -13.282461460974925],
           [49.9000155699443, -13.237014360143167],
           [49.992026067991176, -13.231667084281398],
           [50.077170110959926, -13.224982824443904],
           [50.082663275022426, -13.147432039558907],
           [50.0263583433818, -13.075207534927332],
           [49.956320501584926, -13.093934441839446],
           [49.90276215197555, -13.128709205001414],
           [49.766806341428676, -13.245035053818956]]],
         [[[43.74357314947312, -23.55466261757073],
           [43.74168487432664, -23.55120068675082],
           [43.73533340337937, -23.542073341203],
           [43.68434997442429, -23.536879913536456],
           [43.65707558584242, -23.558792211250605],
           [43.65432900381117, -23.579089241312136],
           [43.65759056997328, -23.591203027534654],
           [43.66926354360609, -23.59214691196601],
           [43.68282479238539, -23.59057376747452],
           [43.707887353420546, -23.58412367786371],
           [43.72642678213148, -23.58947255510733],
           [43.73775643301039, -23.599540438385716],
           [43.790372966940474, -23.597319842772077],
           [43.80341923158891, -23.575294971939815],
           [43.797582744772505, -23.55515471343786],
           [43.78144657533891, -23.544296574699043],
           [43.768400310690474, -23.542880229618607],
           [43.754667400534224, -23.544296574699043],
           [43.748659252340865, -23.547129219092316],
           [43.74608433168657, -23.549647073986318],
           [43.74556934755571, -23.55153543351024],
           [43.74453937929399, -23.553581125715134]]],
         [[[39.009273304067214, -17.009242418388396],
           [39.02918602379378, -17.03747451807378],
           [39.07313133629378, -17.059138122742855],
           [39.13080955895003, -17.061763843495676],
           [39.18642784508284, -17.023687280584355],
           [39.209773792348464, -16.958676632567922],
           [39.20359398277815, -16.909411157128883],
           [39.2008474007469, -16.88641619170631],
           [39.226253284535964, -16.854218533743012],
           [39.29560448082503, -16.82201539336673],
           [39.34847618492659, -16.802296483130192],
           [39.46589256676253, -16.828587907642632],
           [39.6430501414418, -16.6888637684822],
           [39.73145315057056, -16.60294097880243],
           [39.81994136196013, -16.53329544348717],
           [39.89096851361232, -16.484646527877644],
           [39.96082724095797, -16.393148958439586],
           [40.05484387187199, -16.27423977849419],
           [40.12389666591115, -16.138921775806697],
           [40.091914589067095, -16.069221209583773],
           [39.6433885477837, -16.441238127768766],
           [39.4700124398094, -16.549714162420994],
           [39.40821434410628, -16.589860167131334],
           [39.341285913555645, -16.62052963312235],
           [39.07725120934065, -16.675389248843576],
           [39.01545311363753, -16.750360220638665],
           [38.98936058434065, -16.83516019388607],
           [38.98798729332503, -16.907440269963924],
           [39.00446678551253, -16.998079716303863]]],
         [[[40.41267977822199, -10.369510225926186],
           [40.39345370400324, -10.374238205807174],
           [40.35980807412043, -10.378290703145156],
           [40.32135592568293, -10.401253862604488],
           [40.27672396767512, -10.424215332869677],
           [40.13664828408137, -10.49308957287559],
           [40.04120455849543, -10.570048517693518],
           [40.06523715126887, -10.674654718645547],
           [40.22728549111262, -10.688824411049115],
           [40.38534242651724, -10.634911243681051],
           [40.5315979196813, -10.59104277624572],
           [40.53091127417349, -10.547168027549535],
           [40.5041320993688, -10.524215665221618],
           [40.51237184546255, -10.49315975076307],
           [40.50619203589224, -10.480331397400544],
           [40.507565326907866, -10.465476850795334],
           [40.51443178198599, -10.44859582070925],
           [40.53640443823599, -10.451296847198801],
           [40.56936342261099, -10.458049310652937],
           [40.589962787845366, -10.376334665280897],
           [40.51717836401724, -10.327025413376907],
           [40.50069887182974, -10.335807080041093],
           [40.46156007788443, -10.370931290063249],
           [40.44576723120474, -10.377010080623537],
           [40.427914448001616, -10.364176939901428]]],
         [[[39.0062808026115, -8.090346753712302],
           [39.15253629577556, -8.099184207436473],
           [39.30634488952556, -8.101223592295035],
           [39.39423551452556, -8.095785209717766],
           [39.43268766296306, -8.027119330283828],
           [39.44230070007244, -7.997201846416654],
           [39.438867472533374, -7.988362169419953],
           [39.45603361022869, -7.964562088329957],
           [39.48624601257244, -7.9407606239642625],
           [39.50890531433025, -7.922398551708424],
           [39.54255094421306, -7.8836314898232445],
           [39.55491056335369, -7.853023347924988],
           [39.5665835369865, -7.78771845122165],
           [39.55285062683025, -7.731248716211082],
           [39.47311456428426, -7.633855362257479],
           [39.43397577033895, -7.588936052367912],
           [39.40994317756551, -7.565793968812877],
           [39.38041742072957, -7.563751960601428],
           [39.375610902174884, -7.4759364994297455],
           [39.38591058479207, -7.45415007669127],
           [39.38247735725301, -7.431000814922961],
           [39.36393792854207, -7.424191976182741],
           [39.345398499831134, -7.427596408738496],
           [39.31930597053426, -7.437128679561575],
           [39.3048864148702, -7.438490415643542],
           [39.0027623914327, -7.481382935385496]]],
         [[[38.91358718879052, -6.452324446080831],
           [38.94036636359521, -6.402514389033872],
           [38.94791946418115, -6.340415599766584],
           [38.917020416329585, -6.227117274428391],
           [38.92045364386865, -6.193669099220813],
           [38.93143997199365, -6.1260836785237185],
           [38.90397415168115, -6.079656406003751],
           [38.881314849923335, -5.959473166488374],
           [38.86552180636137, -5.906540665634381],
           [38.804410553048335, -5.876148851879652],
           [38.75016555793115, -5.8570234724951895],
           [38.72613296515771, -5.848143609318621],
           [38.70416030890771, -5.83994668742067],
           [38.67326126105615, -5.831749645578546],
           [38.66639480597802, -5.781198580439933],
           [38.639615631173335, -5.776416488521175],
           [38.61352310187646, -5.77095119117545],
           [38.58056411750146, -5.766169012776189],
           [38.466441102747886, -5.775315877750342],
           [38.45957464766976, -5.978860612997736],
           [38.460947938685386, -6.355012179210117],
           [38.661448426966636, -6.47646960576254]]],
         [[[40.9325609979023, -2.2909944203033388],
           [40.89685543149605, -2.262178071660961],
           [40.9105883416523, -2.200426834590775],
           [40.837803917824175, -2.160630233362809],
           [40.250035363136675, -2.533851319053558],
           [40.09485347837105, -2.7506004911135835],
           [40.082493859230425, -2.9878818306923205],
           [40.170384484230425, -3.011195792820958],
           [40.20471675962105, -2.998853168905174],
           [40.236302452980425, -2.9906246755415364],
           [40.25964840024605, -2.96319591939188],
           [40.2843676385273, -2.950852756993189],
           [40.329686242042925, -2.732768143361721],
           [40.4216967400898, -2.6600643099311467],
           [40.4986010369648, -2.649089771184487],
           [40.564689785508705, -2.5938676134110783],
           [40.59902206089933, -2.5861507425712866],
           [40.61824813511808, -2.58597925601891],
           [40.63704505589445, -2.5895411662432255],
           [40.67961707737882, -2.550784721813428],
           [40.69558158543546, -2.534149959425237],
           [40.74004188206632, -2.5051672347426277],
           [40.76176804048657, -2.4657423784739025],
           [40.7796208236897, -2.4527081293265907],
           [40.81326645357251, -2.4252671904552927],
           [40.84416550142407, -2.423895128847498],
           [40.90871017915845, -2.395767560507544],
           [40.94853561861157, -2.360097252031308],
           [40.9389225815022, -2.3127581001629425]]]]);
/***** End of imports. If edited, may not auto-convert in the playground. *****/
// little viewing script for looking at reefs and classifications for each region/

// imports 
var pkg_vis = require('users/mitchest/global_reefs:Modules/pkg_vis')
var map_palettes = require('users/mitchest/global_reefs:Modules/colour_pals')

// choose where to centre (link this dynamically to map app?)
var centre_map = eaaf
Map.centerObject(centre_map, 10)


//ad the latest mask from Chris Roelfsema for his perusal, these masks will b eventually applied to the map
Map.addLayer(RiverMouth, {}, 'RivermouthDrwanCR', false)





// add some background data
//Map.addLayer(any_rrs, {bands: ['b3','b2','b1'], min: 66, max: 1260}, "Any tide mosaic", false)
Map.addLayer(high_rrs, {bands: ['b3','b2','b1'], min: 66, max: 1260}, "High tide mosaic", false)
Map.addLayer(low_rrs, {bands: ['b3','b2','b1'], min: 66, max: 1260}, "Low tide mosaic", false)

//Map.addLayer(any_depth, {min: -1, max: 1200, palette:['#d0d1e6','#a6bddb','#74a9cf','#3690c0','#0570b0','#045a8d','#023858']}, "Any tide depth", false)
Map.addLayer(high_depth, {min: -1, max: 1200, palette:['#d0d1e6','#a6bddb','#74a9cf','#3690c0','#0570b0','#045a8d','#023858']}, "High tide depth", false)
Map.addLayer(low_depth, {min: -1, max: 1200, palette:['#d0d1e6','#a6bddb','#74a9cf','#3690c0','#0570b0','#045a8d','#023858']}, "Low tide depth", false)

// east africa
Map.addLayer(benthic, map_palettes.benthic, "East Africa Benthic - RAW", false)
Map.addLayer(benthic_clean, map_palettes.benthic, "East Africa Benthic - CLEAN", false)
Map.addLayer(geo, map_palettes.geo, "East Africa Geo - RAW", false)
Map.addLayer(geo_clean1, map_palettes.geo, "East Africa Geo - CLEAN1", false)
Map.addLayer(geo_clean2, map_palettes.geo, "East Africa Geo - CLEAN2", false)
Map.addLayer(geo_clean3man, map_palettes.geo, "East Africa Geo - CLEAN3man", false)
Map.addLayer(wcmc, {color:'#FFFF33'}, "WCMC (UNEP)", false )

// wave data
/*var kd1 = ee.Image('users/danleeharris/reefwave/fiji_v1_kd1')
var kd2 = ee.Image('users/danleeharris/reefwave/fiji_v1_kd2')

Map.addLayer(kd1, {}, "waves - kd1", false)
Map.addLayer(kd2, {}, "waves - kd2", false)*/

// add training data / sample point distributions
// ----> possibly - points are only intermediate in the mapping script, so will have to pull those out if we want that
//Map.addLayer(ee.Image().byte().paint(fiji_training_geo_oldmaps, 'class_num'), map_palettes.geo, "Training data - geo (old maps) ", false)
//Map.addLayer(ee.Image().byte().paint(fiji_training_geo, 'class_num'), map_palettes.geo, "Training data - geo (new maps)", false)
//Map.addLayer(ee.Image().byte().paint(fiji_training_benthic, 'class_num'), map_palettes.benthic, "Training - benthic (manual curation)", false)

// #############
// example confidence layers

/*// depth and nir combos
var depth_nir_flag = fiji_dove_ocean.select('b4').multiply(fiji_high_depth_ocean).gt(250000)
//Map.addLayer(depth_nir_flag, {}, "NIR flag", false)
var conf_flag = fiji_high_depth_ocean.eq(-1)
                        .or(fiji_high_depth_ocean.gt(1000))
                        .add(depth_nir_flag.eq(1))
                        .selfMask()
Map.addLayer(conf_flag, {min:1,max:2,palette:["#f7f7f7","#bababa"]}, "Confidence flag", false)

//straight depth missing/-1
var depth_flag = fiji_high_depth_ocean.gt(0).selfMask()
//Map.addLayer(depth_flag, {min:0,max:1,palette:["#ffff00"]}, "Valid depth retrievals", false)

//Map.addLayer(fiji_geo_clean.gt(0).updateMask(fiji_high_depth_ocean.lte(0)), {min:0,max:1,palette:["#ff0000"]}, "Unmapped area via original algorithm", false)
*/

////////// UI SET UP //////////

//Generate title
var title = ui.Label({
  value: 'Coral Atlas map classes',
  style: {fontWeight: 'bold', fontSize: '18px'}
})

// generate the legend
var geo_legend = pkg_vis.discrete_legend(map_palettes.geo_atlas_names, map_palettes.geo_atlas_cols, 'Geomorphic Zone', false)
var benthic_legend = pkg_vis.discrete_legend(map_palettes.benthic_atlas_names, map_palettes.benthic_atlas_cols, 'Benthic Habitat', false)



//var mask_legend = pkg_vis.discrete_legend(["Low confidence depth","Water conditions"], ["#f7f7f7","#bababa"], 'Confidence Mask reason', false)
pkg_vis.add_lgds([title, geo_legend, benthic_legend])//, mask_legend])





///////// LINK TO DATA EXPORT /////////
// hopefully eventually we can link this to a download link in the app?

// // map to export 
// var export_map = gbr_geo_map10
// // extent
// var export_convhull = export_map.gt(0).reduceToVectors({scale: 1000, maxPixels: 1e13, bestEffort: true, geometry: export_map.geometry().bounds()}).geometry().convexHull({maxError: 100})
// // export
// Export.image.toDrive({
//     image: export_map,
//     description: 'gbr_sent2_geo_map',
//     folder: 'GBR Mapping',
//     region: export_convhull,
//     scale: 10,
//     maxPixels: 1e13
// })

