/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var west = 
    /* color: #ef3dff */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[-170.05421307096222, 16.6451400858547],
          [-169.26319744596222, 16.276379337331182],
          [-166.52210857877472, 22.956876785083164],
          [-161.24867107877472, 21.900749850607188],
          [-159.88636639127472, 23.118638908420024],
          [-168.41175701627472, 25.956563835498525],
          [-172.8005727562403, 27.17740555675168],
          [-178.03578045377466, 29.409455643699086],
          [-179.88075843416314, 29.138941969116722],
          [-179.21131756314966, 27.701525535727267],
          [-174.21253826627472, 25.084107254287407],
          [-168.27992107877472, 23.48189007138448]]]),
    east = 
    /* color: #d63000 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[-160.10125396109765, 22.64228527575897],
          [-161.24383208609765, 21.675686283465996],
          [-155.13543364859765, 17.913808970579183],
          [-153.16888091422265, 20.074384925080125],
          [-157.2369826354119, 21.54252009353632],
          [-157.34009506822335, 21.52969489770093],
          [-157.41777527583181, 21.56393141610093],
          [-157.46797781116595, 21.53684965003541],
          [-157.5244622198877, 21.53759271696512],
          [-157.61271501236476, 21.582531209884397],
          [-157.7315906851727, 21.60345516004644],
          [-159.26629302359765, 23.138220615639327]]]),
    rivermouth = 
    /* color: #d63000 */
    /* shown: false */
    ee.Geometry({
      "type": "GeometryCollection",
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -156.7842204246488,
                20.745086910963103
              ],
              [
                -156.78800447581116,
                20.787939322661675
              ],
              [
                -156.78251131174866,
                20.800296261084448
              ],
              [
                -156.77804811594788,
                20.823723520406357
              ],
              [
                -156.78096635935609,
                20.844740769075823
              ],
              [
                -156.79126604197327,
                20.848751360957856
              ],
              [
                -156.80860384104554,
                20.84907220369007
              ],
              [
                -156.81467643233253,
                20.849292792741398
              ],
              [
                -156.815009004318,
                20.845773484776423
              ],
              [
                -156.81602819559882,
                20.843457357096668
              ],
              [
                -156.82096346018616,
                20.83736100073135
              ],
              [
                -156.83160646555726,
                20.812331266893775
              ],
              [
                -156.8441377460749,
                20.76803771097934
              ],
              [
                -156.78825839604596,
                20.67098173808542
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -160.15383266963985,
                21.930907072196526
              ],
              [
                -160.1488544897082,
                21.938231881675506
              ],
              [
                -160.14941239616218,
                21.940898935968427
              ],
              [
                -160.15254520931276,
                21.946272814308763
              ],
              [
                -160.1496268679863,
                21.95502954851978
              ],
              [
                -160.15529179134396,
                21.961636896171242
              ],
              [
                -160.1599266485217,
                21.96235331541617
              ],
              [
                -160.17074131526974,
                21.95956722028372
              ],
              [
                -160.1811268285754,
                21.94953682553811
              ],
              [
                -160.19872211971315,
                21.939107648872696
              ],
              [
                -160.18387260888633,
                21.925254289863396
              ],
              [
                -160.17142796077755,
                21.92238752604182
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -159.72314033269325,
                21.971012910557082
              ],
              [
                -159.72674522160926,
                21.96169974628831
              ],
              [
                -159.63970490632178,
                21.90520942460092
              ],
              [
                -159.6308643454087,
                21.915242944362767
              ],
              [
                -159.6442191782457,
                21.948849011983118
              ],
              [
                -159.6700575351498,
                21.964451617869077
              ],
              [
                -159.7150328159115,
                21.97145631221452
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        }
      ],
      "coordinates": []
    }),
    noreefmask = 
    /* color: #0dff09 */
    /* shown: false */
    ee.Geometry({
      "type": "GeometryCollection",
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -155.75950064387715,
                20.11176724970261
              ],
              [
                -155.4326573821584,
                19.946617631774327
              ],
              [
                -155.2019444915334,
                19.817474101263812
              ],
              [
                -155.11130728450215,
                19.79938561625032
              ],
              [
                -155.08781235499967,
                19.80280229703798
              ],
              [
                -155.08229874238592,
                19.80117051860655
              ],
              [
                -155.00144400325215,
                19.812306172586883
              ],
              [
                -154.9602452727834,
                19.882059025130957
              ],
              [
                -155.30906119075215,
                20.168497274571106
              ],
              [
                -155.5919591399709,
                20.28447167295894
              ],
              [
                -155.7897130462209,
                20.390061765147262
              ],
              [
                -155.8995763274709,
                20.292200221431955
              ],
              [
                -155.87623038020527,
                20.24840002048871
              ],
              [
                -155.88584341731465,
                20.200721058243175
              ],
              [
                -155.8927199418711,
                20.17607152963346
              ],
              [
                -155.8882409884053,
                20.17248593590882
              ],
              [
                -155.87807574000755,
                20.16533495694209
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -155.3118077727834,
                19.398330895725163
              ],
              [
                -155.4985753509084,
                19.245410030276595
              ],
              [
                -155.47797598567402,
                19.146843052721884
              ],
              [
                -155.37909903254902,
                19.087155458420973
              ],
              [
                -155.24314322200215,
                19.139058936972752
              ],
              [
                -154.9767247649709,
                19.185758121592972
              ],
              [
                -154.79270376887715,
                19.362057545913377
              ],
              [
                -154.69931997981465,
                19.429415904347064
              ],
              [
                -154.76523794856465,
                19.574400508105594
              ],
              [
                -154.8833409759084,
                19.547225798504627
              ],
              [
                -154.95887198176777,
                19.595101973471603
              ],
              [
                -154.9932042571584,
                19.63002965805502
              ],
              [
                -155.08384146418965,
                19.633910043421125
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -155.76499380793965,
                19.238927176067893
              ],
              [
                -155.8654834203181,
                19.23113465897316
              ],
              [
                -155.9073606957918,
                19.219796986601683
              ],
              [
                -155.95453797490703,
                19.20541868718417
              ],
              [
                -155.9864369842092,
                19.20877854219733
              ],
              [
                -156.0094396087209,
                19.166301735508405
              ],
              [
                -156.05613150325215,
                19.074177044353597
              ],
              [
                -155.9215489837209,
                18.858587312170002
              ],
              [
                -155.68259634700215,
                18.736383172070568
              ],
              [
                -155.6876577137929,
                18.874103915829522
              ],
              [
                -155.68677917358846,
                18.90813448229739
              ],
              [
                -155.6786896092994,
                18.915369644449207
              ],
              [
                -155.68808951106465,
                19.058601605612775
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -157.0435631111516,
                20.898135832350654
              ],
              [
                -157.0569971540855,
                20.89573783662342
              ],
              [
                -157.05945440638715,
                20.89576965791902
              ],
              [
                -157.0615254409068,
                20.89708441743814
              ],
              [
                -157.0656246205808,
                20.8973483909672
              ],
              [
                -157.18501208576097,
                20.885305778496836
              ],
              [
                -157.1589195564641,
                20.823706268669046
              ],
              [
                -157.09986804279222,
                20.69914707509469
              ],
              [
                -157.0325767830266,
                20.631045665331353
              ],
              [
                -156.93507312091722,
                20.614336886412087
              ],
              [
                -156.78263781818285,
                20.669597383049346
              ],
              [
                -156.84306262287035,
                20.772354092177274
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -156.97355161060236,
                21.30925490950316
              ],
              [
                -156.97206905975014,
                21.217574425918958
              ],
              [
                -156.971964586929,
                21.216016668451047
              ],
              [
                -156.9711305629067,
                21.21453892298979
              ],
              [
                -156.97092164833512,
                21.212063516396988
              ],
              [
                -156.9776484856468,
                21.186708179551978
              ],
              [
                -156.96256689486268,
                21.126192364679536
              ],
              [
                -156.8815422777,
                21.115943641201927
              ],
              [
                -156.80566215091372,
                21.098971630466107
              ],
              [
                -156.71314235428878,
                21.150327564183744
              ],
              [
                -156.71039554049284,
                21.149826284968455
              ],
              [
                -156.70889329669706,
                21.148484462766575
              ],
              [
                -156.705588459548,
                21.147041526106342
              ],
              [
                -156.59967350113442,
                21.151164086530777
              ],
              [
                -156.5969269386981,
                21.261269578226525
              ],
              [
                -156.68619076307172,
                21.275346899948715
              ],
              [
                -156.96634184205035,
                21.32204836554511
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -157.24515661099863,
                21.16366498640197
              ],
              [
                -157.22867711881113,
                21.193757589780102
              ],
              [
                -157.25073560574964,
                21.21676309340773
              ],
              [
                -157.2519152512538,
                21.220683084875944
              ],
              [
                -157.25040221977056,
                21.222923129526915
              ],
              [
                -157.24631420780977,
                21.22380302845001
              ],
              [
                -157.26335271695567,
                21.250404685129944
              ],
              [
                -157.29459508756113,
                21.299993019564656
              ],
              [
                -157.33888372281504,
                21.301592364927615
              ],
              [
                -157.37218602994395,
                21.276000750979783
              ],
              [
                -157.4573300729127,
                21.215202833428418
              ],
              [
                -157.43123754361582,
                21.11210918563888
              ],
              [
                -157.33579381802988,
                21.102820831591774
              ],
              [
                -157.30768423533425,
                21.09173074948706
              ],
              [
                -157.3113106389335,
                21.09569450775855
              ],
              [
                -157.31213677249568,
                21.097816510541172
              ],
              [
                -157.31184709766038,
                21.099658218775748
              ],
              [
                -157.3097871508828,
                21.10155984463485
              ],
              [
                -157.3069547067018,
                21.10270071975886
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -174.05066033104603,
                25.97669596838257
              ],
              [
                -173.99371247121383,
                25.969327404219925
              ],
              [
                -174.0167581346854,
                25.981401450850147
              ],
              [
                -174.03812905052845,
                26.011412574749965
              ],
              [
                -174.03413610119904,
                26.023174845531194
              ],
              [
                -174.04355540026944,
                26.0275905595145
              ],
              [
                -174.05211698936526,
                26.031234563977815
              ],
              [
                -174.07057305077262,
                26.0470442812463
              ],
              [
                -174.0479137490148,
                26.101936010348762
              ],
              [
                -174.0214792549391,
                26.10502117554279
              ],
              [
                -173.9603664467687,
                26.100086146539056
              ],
              [
                -173.92277260521595,
                26.09654049245369
              ],
              [
                -173.88517876366325,
                26.07850224051801
              ],
              [
                -173.8281871865148,
                26.019280245918743
              ],
              [
                -173.83162041405387,
                25.973609551521907
              ],
              [
                -173.88449211815544,
                25.926068507642317
              ],
              [
                -173.92843743065544,
                25.91433464879782
              ],
              [
                -173.99572869042106,
                25.946445591300716
              ],
              [
                -174.0492870400304,
                25.967436474814935
              ],
              [
                -174.33836479881947,
                26.03408854921568
              ],
              [
                -174.3115856240148,
                25.98904082571302
              ],
              [
                -174.15503044823356,
                25.884068256400795
              ],
              [
                -173.9648296425695,
                25.78951307633869
              ],
              [
                -173.82475395897575,
                25.796931898569493
              ],
              [
                -173.71008415917106,
                25.846996799905405
              ],
              [
                -173.6132671425695,
                26.05568064059857
              ],
              [
                -173.87350579003044,
                26.28677437934696
              ],
              [
                -174.07812615135856,
                26.33539962753381
              ],
              [
                -174.18936272362419,
                26.270766671770293
              ],
              [
                -174.32531853417103,
                26.045193550025594
              ],
              [
                -174.2133953163976,
                26.014960805456116
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -170.50925149946613,
                25.38578767382481
              ],
              [
                -170.49491777449055,
                25.374698512847218
              ],
              [
                -170.49388780622883,
                25.362600085274206
              ],
              [
                -170.4863347056429,
                25.356085045673822
              ],
              [
                -170.48942461042805,
                25.349104256501754
              ],
              [
                -170.48616304426594,
                25.339485620273656
              ],
              [
                -170.49438679611072,
                25.33234083847988
              ],
              [
                -170.51059247850395,
                25.32876568847992
              ],
              [
                -170.53840162157036,
                25.32907600649127
              ],
              [
                -170.57135469362535,
                25.33950798904555
              ],
              [
                -170.58208944200493,
                25.373986143535184
              ],
              [
                -170.61112067423915,
                25.403684370037265
              ],
              [
                -170.61850211344813,
                25.406785591077345
              ],
              [
                -170.6274285050497,
                25.413297895740715
              ],
              [
                -170.63987395487877,
                25.42407343695218
              ],
              [
                -170.66004360657456,
                25.4176401589583
              ],
              [
                -170.68064353190516,
                25.42182538196226
              ],
              [
                -170.68978446619752,
                25.440661174502697
              ],
              [
                -170.71089881556276,
                25.45445676257728
              ],
              [
                -170.66420824087925,
                25.491124630046595
              ],
              [
                -170.6533711451532,
                25.50374238835138
              ],
              [
                -170.6439728915128,
                25.503858523879163
              ],
              [
                -170.64453058424007,
                25.514974592907034
              ],
              [
                -170.6434147852899,
                25.520474116719367
              ],
              [
                -170.63380174818053,
                25.523262511387482
              ],
              [
                -170.59260301771178,
                25.518305320519207
              ],
              [
                -170.61320238294616,
                25.481739716552685
              ],
              [
                -170.59998445692077,
                25.469419560493414
              ],
              [
                -170.59723787488952,
                25.468644665725538
              ],
              [
                -170.5903714198114,
                25.469497049695647
              ],
              [
                -170.5764668482782,
                25.483831693148666
              ],
              [
                -170.57063036146178,
                25.475463568354787
              ],
              [
                -170.57431938590264,
                25.45066550460045
              ],
              [
                -170.56277572919507,
                25.438963179795678
              ],
              [
                -170.54247789564147,
                25.446480562898277
              ],
              [
                -170.53844385328307,
                25.44772062048397
              ],
              [
                -170.53157739820494,
                25.464847609209826
              ],
              [
                -170.5080446566061,
                25.44282565813182
              ],
              [
                -170.5025514925436,
                25.43786514954691
              ],
              [
                -170.13038962730923,
                25.441275521145126
              ],
              [
                -170.15304892906704,
                25.819533451943013
              ],
              [
                -171.16516440758267,
                25.809643472315003
              ],
              [
                -171.15967124352017,
                25.11903639653855
              ],
              [
                -170.06927817711392,
                25.12276658723488
              ],
              [
                -170.12558310875454,
                25.41088880952317
              ],
              [
                -170.12798636803188,
                25.436935031443994
              ],
              [
                -170.4970583284811,
                25.433524536958835
              ],
              [
                -170.50049155602017,
                25.42050176096584
              ],
              [
                -170.515769418569,
                25.41003601069581
              ],
              [
                -170.5127653444723,
                25.401972887430947
              ],
              [
                -170.50907462486782,
                25.395459971387844
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -178.52679867899792,
                28.422012283979573
              ],
              [
                -178.52748532450573,
                28.21165337631796
              ],
              [
                -178.1086315647401,
                28.21528377690717
              ],
              [
                -178.1086315647401,
                28.598198557367937
              ],
              [
                -178.52885861552136,
                28.599404297251496
              ],
              [
                -178.52748532450573,
                28.438315821402362
              ],
              [
                -178.40388913309948,
                28.44073094666019
              ],
              [
                -178.38466305888073,
                28.460653625956162
              ],
              [
                -178.3228649631776,
                28.483590242115103
              ],
              [
                -178.28166623270886,
                28.46427552796416
              ],
              [
                -178.25832028544323,
                28.427447075509363
              ],
              [
                -178.2624401584901,
                28.38698138062302
              ],
              [
                -178.29814572489636,
                28.35677303278613
              ],
              [
                -178.37505002177136,
                28.374899073697343
              ],
              [
                -178.40114255106823,
                28.424427781329378
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -177.6164607454707,
                28.23428431816332
              ],
              [
                -177.45372576011914,
                28.23246945635773
              ],
              [
                -177.41390032066602,
                28.302017060154576
              ],
              [
                -177.328079862047,
                28.292343590748846
              ],
              [
                -177.27795473997668,
                28.177403985894664
              ],
              [
                -177.34387270872668,
                28.169535173818556
              ],
              [
                -177.42489687864855,
                28.16771921191455
              ],
              [
                -177.45373598997668,
                28.214924201096938
              ],
              [
                -177.613724393297,
                28.21794945083236
              ],
              [
                -177.61647097532824,
                28.04355554182848
              ],
              [
                -177.09530703489855,
                28.047797645550013
              ],
              [
                -177.1310126013048,
                28.424672779911663
              ],
              [
                -177.6253973669298,
                28.42165340660062
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -176.03649790573593,
                27.828629429026975
              ],
              [
                -176.02070505905624,
                27.835308791535123
              ],
              [
                -175.9946137798126,
                27.844115130570152
              ],
              [
                -175.97607560092527,
                27.851702963006804
              ],
              [
                -175.97607310104843,
                27.875983300622405
              ],
              [
                -175.86895640182968,
                27.95546695038755
              ],
              [
                -175.7549732475328,
                27.9815442614255
              ],
              [
                -175.6945484428453,
                27.939696217207416
              ],
              [
                -175.70896799850937,
                27.863843253941948
              ],
              [
                -175.75703318405624,
                27.76971180878053
              ],
              [
                -175.84149058151718,
                27.763636011593967
              ],
              [
                -175.92938120651718,
                27.742975764283667
              ],
              [
                -176.01383860397812,
                27.744798884957095
              ],
              [
                -176.03306467819687,
                27.80919621922884
              ],
              [
                -176.15666086960312,
                27.814662161002975
              ],
              [
                -176.15872080612655,
                27.596418838691378
              ],
              [
                -175.47550852585312,
                27.607371787961583
              ],
              [
                -175.48100168991562,
                28.12879279990094
              ],
              [
                -176.15872080612655,
                28.12879279990094
              ],
              [
                -176.15460093307968,
                27.837130364505406
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -166.03265850607545,
                23.759345151748196
              ],
              [
                -166.02304546896607,
                23.692712480008613
              ],
              [
                -166.05325787130982,
                23.626045786450952
              ],
              [
                -166.0958298927942,
                23.60591331749165
              ],
              [
                -166.1837205177942,
                23.59207045139132
              ],
              [
                -166.2771043068567,
                23.632336548592715
              ],
              [
                -166.33340923849732,
                23.673847996549
              ],
              [
                -166.3759812599817,
                23.756831329867016
              ],
              [
                -166.4034470802942,
                23.81338057261172
              ],
              [
                -166.38971417013795,
                23.862370002213982
              ],
              [
                -166.33890240255982,
                23.905063624439705
              ],
              [
                -166.15350811545045,
                23.884974262869374
              ],
              [
                -166.03128521505982,
                23.784480699642252
              ],
              [
                -165.7882127052942,
                23.808354969606075
              ],
              [
                -165.7937058693567,
                24.22606751952572
              ],
              [
                -166.6561326271692,
                24.22481516325528
              ],
              [
                -166.66437237326295,
                23.359040255995573
              ],
              [
                -165.70718853537232,
                23.365343775003755
              ],
              [
                -165.77585308615357,
                23.78950722627262
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -169.81673260501492,
                16.70954571963052
              ],
              [
                -169.81810589603054,
                16.377803174319446
              ],
              [
                -168.89113446048367,
                16.37385043212406
              ],
              [
                -168.89937420657742,
                17.017077176652208
              ],
              [
                -169.8153593139993,
                17.02626910593821
              ],
              [
                -169.81013638630816,
                16.724342307572943
              ],
              [
                -169.56775052205035,
                16.722698298925778
              ],
              [
                -169.56088406697222,
                16.739795295860546
              ],
              [
                -169.54749447956988,
                16.762479326692233
              ],
              [
                -169.52552182331988,
                16.78417456445518
              ],
              [
                -169.49084622517535,
                16.795678609692597
              ],
              [
                -169.45826165854737,
                16.79526184994137
              ],
              [
                -169.44367044150636,
                16.792468068329065
              ],
              [
                -169.4292508858423,
                16.778827250230705
              ],
              [
                -169.41843621909425,
                16.769623253410337
              ],
              [
                -169.40607659995362,
                16.761898126452518
              ],
              [
                -169.38889259554855,
                16.752494012412473
              ],
              [
                -169.3415140555095,
                16.718958384031566
              ],
              [
                -169.32984108187668,
                16.68344364433484
              ],
              [
                -169.48296303011887,
                16.657132174718583
              ],
              [
                -169.58801979281418,
                16.650553742170445
              ],
              [
                -169.57634681918137,
                16.693309512247858
              ],
              [
                -169.57016700961105,
                16.71698551626367
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -155.98101483037948,
                20.764162872425462
              ],
              [
                -155.9828387325096,
                20.763962232843166
              ],
              [
                -155.98522053411483,
                20.76330012033158
              ],
              [
                -155.98740921667098,
                20.76151440849014
              ],
              [
                -155.986872774868,
                20.75918693217253
              ],
              [
                -155.98470554998397,
                20.75527428346589
              ],
              [
                -155.98367558172225,
                20.743134395672055
              ],
              [
                -155.97946994034643,
                20.743585776562536
              ],
              [
                -155.9742985790062,
                20.755635455281197
              ],
              [
                -155.97629414251327,
                20.760069772236132
              ],
              [
                -155.98056421926498,
                20.764162872425462
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -155.98410548933288,
                19.510927126874677
              ],
              [
                -155.99200191267272,
                19.498629539776726
              ],
              [
                -155.99303188093444,
                19.430652348092252
              ],
              [
                -155.98307552107116,
                19.378841094017098
              ],
              [
                -155.94531001814147,
                19.384994543722417
              ],
              [
                -155.93260707624694,
                19.41105928393004
              ],
              [
                -155.93363704450866,
                19.437609353311192
              ],
              [
                -155.93398036726256,
                19.45929948046982
              ],
              [
                -155.9302038169696,
                19.468363151944256
              ],
              [
                -155.9353536582782,
                19.472571112863342
              ],
              [
                -155.94565334089538,
                19.47872101303081
              ],
              [
                -155.9528631187274,
                19.484547018880676
              ],
              [
                -155.95492305525084,
                19.492638345953864
              ],
              [
                -155.95698299177428,
                19.50202377865245
              ],
              [
                -155.96762599714538,
                19.51011423193349
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -157.0025948103432,
                21.079990832815582
              ],
              [
                -157.0029381330971,
                21.079270049598207
              ],
              [
                -157.00278792939227,
                21.078128802356087
              ],
              [
                -157.00242314896624,
                21.077788428675344
              ],
              [
                -157.00115714631121,
                21.077127701070328
              ],
              [
                -157.0003632124428,
                21.077107678975853
              ],
              [
                -156.99926887116473,
                21.077808450678134
              ],
              [
                -156.99860368332904,
                21.079410202164194
              ],
              [
                -157.00010572037738,
                21.08073163414683
              ],
              [
                -157.0015862997536,
                21.08087178533471
              ],
              [
                -157.0025948103432,
                21.080631526074583
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -156.98155400292052,
                21.072547909993954
              ],
              [
                -156.98159691826476,
                21.071907181897302
              ],
              [
                -156.9813179685272,
                21.070926061649008
              ],
              [
                -156.9808673574127,
                21.070165188428554
              ],
              [
                -156.9802880002655,
                21.06966461181841
              ],
              [
                -156.97925803200377,
                21.06992491186596
              ],
              [
                -156.97822806374205,
                21.07102617625662
              ],
              [
                -156.9790649129547,
                21.07280820499458
              ],
              [
                -156.98026654259337,
                21.07362913239657
              ],
              [
                -156.9812106801666,
                21.07330877102284
              ],
              [
                -156.98144671455992,
                21.073128567446794
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        }
      ],
      "coordinates": []
    }),
    imageVisParam = {"opacity":1,"bands":["depth"],"min":1500,"max":2500,"gamma":1},
    kaneohe_bay = 
    /* color: #98ff00 */
    /* shown: false */
    ee.Geometry.MultiPolygon(
        [[[[-157.83657774072572, 21.500356181228852],
           [-157.83648118044272, 21.500575794671303],
           [-157.83595546823426, 21.5009351519169],
           [-157.83539756875916, 21.50095511638224],
           [-157.83505424600526, 21.501034974216335],
           [-157.8349898729889, 21.50149415591158],
           [-157.8361056719391, 21.501693799674726],
           [-157.83670648675843, 21.50137436952216],
           [-157.8370068941681, 21.500975080844878],
           [-157.8379081163971, 21.500735507112353],
           [-157.8388093386261, 21.50069557811857],
           [-157.8402684603302, 21.502492371986854],
           [-157.84056886773988, 21.503011441638332],
           [-157.8412555132477, 21.502851728096736],
           [-157.84219965082093, 21.502731942825445],
           [-157.84297212701722, 21.50333086819535],
           [-157.84357294183656, 21.50400964729945],
           [-157.84434541803284, 21.50377007856565],
           [-157.84494623285218, 21.503730150404984],
           [-157.84563287836, 21.503650294050757],
           [-157.8461907778351, 21.503690222233356],
           [-157.84679159265443, 21.50377007856565],
           [-157.8476498995392, 21.50412943151835],
           [-157.84850820642396, 21.504169359569385],
           [-157.84880861383363, 21.503730150404984],
           [-157.8488944445221, 21.50293158488946],
           [-157.84940942865296, 21.502252800753617],
           [-157.84919485193177, 21.501693799674726],
           [-157.84893735986634, 21.501054938668027],
           [-157.84902319055482, 21.500216429338163],
           [-157.84842237573548, 21.500216429338163],
           [-157.8477786455719, 21.500575791071448],
           [-157.84683450799866, 21.500495932985217],
           [-157.84640535455628, 21.50025635846348],
           [-157.84604064078505, 21.499817314764524],
           [-157.84581537854834, 21.498958911767705],
           [-157.8449006992727, 21.499263429926085],
           [-157.8442287857026, 21.499375745572532],
           [-157.84380700228147, 21.500070762962125],
           [-157.8433386138196, 21.50033840160808],
           [-157.843190251792, 21.50119093483795],
           [-157.84272982501224, 21.501816832654285],
           [-157.8415554730941, 21.502009983073755],
           [-157.84066790288875, 21.501068399047984],
           [-157.8403957965832, 21.50007853231697],
           [-157.8398305989085, 21.499423887938587],
           [-157.83804597164894, 21.499535791006995],
           [-157.83677637693935, 21.49976751048431],
           [-157.83660871554662, 21.499859784212155],
           [-157.83646251283344, 21.49991212681393],
           [-157.83633776299928, 21.499964460198346],
           [-157.83643632669802, 21.500040535257956],
           [-157.83645341167144, 21.500218319149983]]],
         [[[-157.84016672245795, 21.49229701054916],
           [-157.83995214573676, 21.493315255249566],
           [-157.839995061081, 21.49357480668058],
           [-157.83971611134345, 21.4936945994926],
           [-157.83939424626166, 21.49361473762887],
           [-157.83892217747504, 21.4936945994926],
           [-157.83851448170478, 21.493854323088513],
           [-157.83825698963935, 21.494213700538268],
           [-157.83840719334418, 21.494433319653893],
           [-157.83879343144233, 21.494493215718823],
           [-157.83917966954047, 21.494493215718823],
           [-157.83950153462226, 21.49459304243887],
           [-157.83982339970404, 21.494712834412535],
           [-157.84005943409736, 21.49469286909045],
           [-157.84035984150702, 21.49453314641505],
           [-157.84042421452338, 21.493994081091117],
           [-157.8406602489167, 21.493794426760594],
           [-157.84098211399848, 21.493634703098916],
           [-157.84138980976874, 21.493674634030775],
           [-157.8416687595063, 21.49387428852567],
           [-157.84209791294867, 21.493954150246918],
           [-157.8419047938996, 21.493674634030775],
           [-157.8416687595063, 21.493075668902282],
           [-157.8421408282929, 21.492197182253832],
           [-157.84263435475165, 21.49205742252531],
           [-157.84349266163642, 21.492656391845298],
           [-157.84366432301337, 21.493175496594937],
           [-157.8437930690461, 21.493674634030775],
           [-157.84435096852118, 21.4936945994926],
           [-157.84501615635688, 21.49329528973568],
           [-157.845037614029, 21.492736254235023],
           [-157.8451449023896, 21.49229701054916],
           [-157.8449303256684, 21.491957594065596],
           [-157.8447157489472, 21.491558279541902],
           [-157.8445870029145, 21.49113899811272],
           [-157.8444797145539, 21.490659817857242],
           [-157.84435096852118, 21.490060840319043],
           [-157.84422222248847, 21.488609932126835],
           [-157.84394327275092, 21.48789114866091],
           [-157.8434712039643, 21.487571688203285],
           [-157.84327808491523, 21.487092496202106],
           [-157.84252706639106, 21.48627387288377],
           [-157.84199062458808, 21.48627387288377],
           [-157.84117523304755, 21.48703259709102],
           [-157.84087482563788, 21.48771145223977],
           [-157.84046712986762, 21.4882904732469],
           [-157.83982339970404, 21.488689796737248],
           [-157.8392011272126, 21.489109085222925],
           [-157.83838573567206, 21.489348678100953],
           [-157.83767763249213, 21.489488440430982],
           [-157.8381067859345, 21.489628202626793],
           [-157.83838573567206, 21.489807896681313],
           [-157.83827844731147, 21.490127352230406],
           [-157.8376347171479, 21.49028707974199],
           [-157.83735576741034, 21.49040687526062],
           [-157.83739868275458, 21.49058656835366],
           [-157.83806387059028, 21.490426841170805],
           [-157.8386646854096, 21.49032701159249],
           [-157.83907238117988, 21.490127352230406],
           [-157.83948007695014, 21.48992769259441],
           [-157.83995214573676, 21.489807896681313],
           [-157.8402310954743, 21.48996762454352],
           [-157.84042421452338, 21.49040687526062],
           [-157.84035984150702, 21.490786227085703],
           [-157.84003797642524, 21.49112564630148],
           [-157.8396731959992, 21.491365235859504],
           [-157.83941570393378, 21.491644756511953],
           [-157.83926550022895, 21.49186437950506],
           [-157.83885780445868, 21.49192427662747],
           [-157.83838573567206, 21.492044070798336],
           [-157.83806387059028, 21.49220379620606],
           [-157.8377420055085, 21.492363521438474],
           [-157.83746305577094, 21.492583143346742],
           [-157.8375274287873, 21.492742868162743],
           [-157.83823553196723, 21.492363521438474],
           [-157.8383213626557, 21.492722902570335],
           [-157.83851448170478, 21.492942523936186],
           [-157.83896509281928, 21.493182110502683],
           [-157.83941570393378, 21.493122213898044],
           [-157.8392011272126, 21.49290259280342],
           [-157.83907238117988, 21.492643040173284],
           [-157.83917966954047, 21.492263693188754],
           [-157.83941570393378, 21.491984173725225],
           [-157.83982339970404, 21.491884345215272],
           [-157.8401023494416, 21.49210396784678]]],
         [[[-157.83757034413154, 21.486753067580082],
           [-157.83817115895087, 21.486912798794922],
           [-157.83860031239325, 21.486593336189934],
           [-157.83872905842597, 21.48615407396321],
           [-157.83915821186835, 21.485714810410865],
           [-157.83980194203193, 21.485874542765096],
           [-157.8402310954743, 21.48627387288377],
           [-157.84048858753974, 21.485235612296492],
           [-157.84027401081855, 21.48459667902339],
           [-157.8401023494416, 21.483877875738973],
           [-157.83984485737616, 21.483398671577532],
           [-157.83950153462226, 21.48315906890529],
           [-157.8389865504914, 21.483718141193776],
           [-157.8382999049836, 21.484357078322954],
           [-157.83757034413154, 21.484836279329453],
           [-157.83735576741034, 21.485435278369195],
           [-157.83769909016425, 21.48595440887648],
           [-157.83791366688544, 21.486393671705756]]],
         [[[-157.80161041622864, 21.438214276502585],
           [-157.8028656837333, 21.43906313255365],
           [-157.8042067949105, 21.439672303092177],
           [-157.80448574468627, 21.439951922964873],
           [-157.80478615213704, 21.44011170550866],
           [-157.80478615213704, 21.439772167393922],
           [-157.80502218656267, 21.439512520067133],
           [-157.8053011363384, 21.43953249295481],
           [-157.80547279773884, 21.439792140246038],
           [-157.80538696703866, 21.44015165111725],
           [-157.80545134006383, 21.440311433442318],
           [-157.80553717076407, 21.440591052090117],
           [-157.80502218656272, 21.440790779367628],
           [-157.80422825258563, 21.441230178415687],
           [-157.80412096421037, 21.441589685743363],
           [-157.8036703530342, 21.441949192185163],
           [-157.80309099580765, 21.441649603545223],
           [-157.80249018090606, 21.44158968574342],
           [-157.80171770460404, 21.441609658346795],
           [-157.80118126272762, 21.441909247068775],
           [-157.80028004037524, 21.442208835175563],
           [-157.80004400594962, 21.442608285027575],
           [-157.79925007197255, 21.443067651005215],
           [-157.79873508777118, 21.443147540592808],
           [-157.7983273919451, 21.443027706195025],
           [-157.79800552681922, 21.442708147319692],
           [-157.79779095006865, 21.442288725233492],
           [-157.79768366169336, 21.442029082385375],
           [-157.79706138911672, 21.44230869774114],
           [-157.79751200029293, 21.443027706195032],
           [-157.7973832542426, 21.443427153804812],
           [-157.79701847376663, 21.44366682184566],
           [-157.7965249472403, 21.44362687719953],
           [-157.7962245397895, 21.443387209093046],
           [-157.79598850536388, 21.44368679416461],
           [-157.79568533248735, 21.443906489492733],
           [-157.795170348286, 21.44414615674603],
           [-157.79499868688555, 21.444425768043867],
           [-157.79527763666127, 21.444445740258924],
           [-157.79564241713726, 21.44426599022503],
           [-157.79609302831344, 21.4439464340623],
           [-157.7965436394897, 21.443906489492733],
           [-157.79688696229056, 21.444206073497842],
           [-157.7970157083409, 21.44470537880574],
           [-157.7968225892654, 21.445064877569138],
           [-157.79647926646447, 21.445224654512913],
           [-157.79617885901368, 21.44552423581075],
           [-157.79589990923793, 21.445903704571396],
           [-157.79549221341182, 21.44608345258711],
           [-157.79517034828598, 21.44614336854312],
           [-157.7948484831601, 21.446163340522975],
           [-157.79454807570932, 21.44618331250011],
           [-157.79351810730657, 21.445624096106606],
           [-157.7933464459061, 21.44532451501386],
           [-157.7933679035812, 21.44510482182144],
           [-157.7934751919565, 21.444785267496357],
           [-157.79368976870705, 21.44456557349177],
           [-157.79373268405718, 21.444325906927578],
           [-157.7933249882311, 21.444485684680778],
           [-157.79300312310525, 21.444425768043825],
           [-157.79281000402972, 21.44430593469609],
           [-157.7924237658787, 21.44398637862086],
           [-157.7918444086522, 21.44354698787436],
           [-157.7909135721483, 21.441332714278214],
           [-157.7867212327675, 21.439917306216415],
           [-157.77644843774237, 21.439323127571047],
           [-157.7706602967425, 21.43997709254755],
           [-157.76989320706926, 21.441310069007365],
           [-157.77220517146003, 21.44241374944967],
           [-157.77404781989938, 21.44286570417277],
           [-157.7760634928446, 21.44315158574501],
           [-157.7769425872913, 21.44323460076975],
           [-157.7776929396922, 21.444056586595213],
           [-157.7782374473108, 21.444034101239197],
           [-157.77899653469171, 21.444730614195585],
           [-157.78044228757554, 21.446895048152438],
           [-157.78159768327515, 21.44939336692871],
           [-157.78303369328512, 21.44942423885584],
           [-157.78355857082272, 21.448321262736435],
           [-157.78365429259873, 21.446159787509693],
           [-157.78418739023223, 21.445362722537492],
           [-157.78457815817393, 21.444149856662854],
           [-157.78496665768628, 21.44404273165081],
           [-157.78520382162125, 21.443669612303484],
           [-157.78500053773809, 21.44290385387658],
           [-157.78541952582364, 21.442517571319385],
           [-157.78645174041822, 21.442749975012966],
           [-157.78849247053333, 21.443102199702864],
           [-157.78890243012017, 21.4438239029305],
           [-157.78945073613377, 21.444444392816287],
           [-157.78917118672913, 21.444787748386894],
           [-157.78932079048428, 21.445210992588912],
           [-157.7897058296085, 21.445098818149607],
           [-157.79013258651582, 21.445313855727914],
           [-157.79064277884893, 21.445264598721376],
           [-157.79081444024933, 21.446223256446064],
           [-157.79077152489918, 21.446682611039567],
           [-157.789977590922, 21.447501456944188],
           [-157.78946260672063, 21.447960807511954],
           [-157.7893982336954, 21.448579929901125],
           [-157.7898488448716, 21.448759674618625],
           [-157.79109339002494, 21.44907922023603],
           [-157.79162983190136, 21.449159106530992],
           [-157.79210190075264, 21.449478651273157],
           [-157.79270271565423, 21.44995796707356],
           [-157.79293875007986, 21.450347525065634],
           [-157.79293875007986, 21.450886752017407],
           [-157.79326061520572, 21.450687038564062],
           [-157.79351810730645, 21.450367496469777],
           [-157.7937970570822, 21.449968067867268],
           [-157.79399017615773, 21.449808296119933],
           [-157.7944193296589, 21.450067925120493],
           [-157.79465536408452, 21.450447382059025],
           [-157.79474119478476, 21.450707009921736],
           [-157.79510597526075, 21.45052726760448],
           [-157.79579262086258, 21.45050729622223],
           [-157.7961359436635, 21.450667067203728],
           [-157.7965007241395, 21.45122626426041],
           [-157.7965650971647, 21.4509266946753],
           [-157.7963505204141, 21.450347525065684],
           [-157.7960501129633, 21.449948096408452],
           [-157.7950753174362, 21.449933009340047],
           [-157.79478105638537, 21.449346304726777],
           [-157.79542785593722, 21.448753391899505],
           [-157.7960516432484, 21.448976198332417],
           [-157.7963849874634, 21.449227391067264],
           [-157.7977747447793, 21.449352979174087],
           [-157.79829793962227, 21.449176098124774],
           [-157.79939637558124, 21.447789497560688],
           [-157.80000993692977, 21.446916459077062],
           [-157.80044544868645, 21.44725884945997],
           [-157.80025550511303, 21.446571247158996],
           [-157.80039656592862, 21.445867958957525],
           [-157.80065029814412, 21.44560529482014],
           [-157.80105423326088, 21.445502406436063],
           [-157.80150027372346, 21.445563304067527],
           [-157.80165663626534, 21.4457739916691],
           [-157.80180455289155, 21.44607904903583],
           [-157.8018022661031, 21.446503938295304],
           [-157.80179039772605, 21.446906108808683],
           [-157.80184290244165, 21.44698872911591],
           [-157.8031506865455, 21.44703139699072],
           [-157.8030457858142, 21.44646287187405],
           [-157.80306963143255, 21.44595426255393],
           [-157.80318615595596, 21.445625069024338],
           [-157.80357090034408, 21.445365777416775],
           [-157.8040153933275, 21.445395910676304],
           [-157.80427749666308, 21.445555861723026],
           [-157.80453192507917, 21.44599532980488],
           [-157.80461086000358, 21.446484684630526],
           [-157.80456104896933, 21.446914123645257],
           [-157.80520861521404, 21.44676436764742],
           [-157.80552166866173, 21.446579643506844],
           [-157.80567283071306, 21.446392414641966],
           [-157.80569524650312, 21.446225157678825],
           [-157.80537260748548, 21.44595555025431],
           [-157.80526454627991, 21.44550619443636],
           [-157.80543006979912, 21.445111773316295],
           [-157.80589906469774, 21.44486464123232],
           [-157.8059618929451, 21.44341291502701],
           [-157.805907466654, 21.44200799788311],
           [-157.80596607601404, 21.44122565669931],
           [-157.80620943713006, 21.44067847852689],
           [-157.80662445762798, 21.440331026937105],
           [-157.80672493638767, 21.439955688060298],
           [-157.80628212014713, 21.439005282032085],
           [-157.80626085069312, 21.438567373227183],
           [-157.80572459825316, 21.43836914008371],
           [-157.80490958798796, 21.4382123480389],
           [-157.8047816015368, 21.438897413921126],
           [-157.8043968803264, 21.439268891498603],
           [-157.8038978710671, 21.43923349886997],
           [-157.8035625382339, 21.4389361802809],
           [-157.80358799299546, 21.438408034263475],
           [-157.80364363652654, 21.43808404335197],
           [-157.80356417031786, 21.437502612868172],
           [-157.80382484586474, 21.437132005145603],
           [-157.80419121837826, 21.43686680893415],
           [-157.80453742183172, 21.436798706313258],
           [-157.80481781164337, 21.436485029318508],
           [-157.8046575993305, 21.43620835110449],
           [-157.80389657285403, 21.436251244917123],
           [-157.80338735187968, 21.436394665701613],
           [-157.80258348772222, 21.436441824381976],
           [-157.8020146645781, 21.436291160025977],
           [-157.80156367490832, 21.435630313721468],
           [-157.80168131766408, 21.43515920785959],
           [-157.8020462148863, 21.434769397352785],
           [-157.80244323943018, 21.434814173939674],
           [-157.80284026378294, 21.434699161289814],
           [-157.80296923853243, 21.434458821567976],
           [-157.80314135369076, 21.433838326424627],
           [-157.80297059739135, 21.433116651878542],
           [-157.80301531986828, 21.432512200755088],
           [-157.80263269823482, 21.43214220200512],
           [-157.8024682697895, 21.431482105658766],
           [-157.80286173767044, 21.430961828932496],
           [-157.80282605116668, 21.430761136790693],
           [-157.80212541834322, 21.431036964324612],
           [-157.80145372310847, 21.431069293353282],
           [-157.80083990292584, 21.430814369175668],
           [-157.8001487190338, 21.430044864897344],
           [-157.8001119972765, 21.429644886280705],
           [-157.79998944519005, 21.429284855905717],
           [-157.7996709057645, 21.429083140862183],
           [-157.79924841049342, 21.42931888083352],
           [-157.79853217869277, 21.429470762837497],
           [-157.79787220654518, 21.429295140920463],
           [-157.79978044872902, 21.43571979120281],
           [-157.799970580993, 21.436325101161646],
           [-157.80090873784994, 21.436137598646706],
           [-157.80162632917913, 21.43616206679965],
           [-157.80194570657508, 21.43649062876171],
           [-157.80202655668234, 21.437027907099196],
           [-157.80193075948966, 21.43774293661658]]],
         [[[-157.7653217076563, 21.434346704209297],
           [-157.76403424732916, 21.432988493538794],
           [-157.7624892949366, 21.433068388634],
           [-157.76085851185553, 21.433467863454002],
           [-157.75974271290534, 21.4335477582868],
           [-157.75828359120123, 21.434346704209297],
           [-157.7576827763819, 21.435625008587987],
           [-157.75922772877448, 21.436743515734214],
           [-157.7612876652979, 21.437622336763365],
           [-157.76343343250983, 21.438181583753444],
           [-157.76515004627936, 21.438660936610386],
           [-157.76600835316412, 21.43850115249971],
           [-157.76566503041022, 21.436104369843274]]],
         [[[-157.76815412037604, 21.432908598399848],
           [-157.77605054371588, 21.433707547821182],
           [-157.7873801945948, 21.42707613513927],
           [-157.78892514698737, 21.425957553911395],
           [-157.7891826390528, 21.424119866147397],
           [-157.7928733586573, 21.41964539923419],
           [-157.78853881198364, 21.41173491411395],
           [-157.7810287236475, 21.409896978859898],
           [-157.77982709400885, 21.414931080442067],
           [-157.77811048023932, 21.41541050964162],
           [-157.77656552784674, 21.415010985417926],
           [-157.7763080357813, 21.413652594884617],
           [-157.77682301991217, 21.41197456561207],
           [-157.77502057545416, 21.411575031992342],
           [-157.7722739934229, 21.413013347910404],
           [-157.77261731617682, 21.41405212282317],
           [-157.77313230030768, 21.415650223651383],
           [-157.77296063893073, 21.416529171655103],
           [-157.7730464696192, 21.417328210705573],
           [-157.77201650135748, 21.417967438798936],
           [-157.77098653309577, 21.41820714861274],
           [-157.76987073414557, 21.417727728591743],
           [-157.76918408863776, 21.41828705179658],
           [-157.76926991932623, 21.41916598393399],
           [-157.76858327381842, 21.419805203984566],
           [-157.7672099828028, 21.420124812960754],
           [-157.76652333729498, 21.420684126986114],
           [-157.76652333729498, 21.421483143306624],
           [-157.76618001454108, 21.422362056210027],
           [-157.76695249073737, 21.422681659590673],
           [-157.76763913624518, 21.421563044698228],
           [-157.76815412037604, 21.420764028814894],
           [-157.76926991932623, 21.42060422511363],
           [-157.77004239552252, 21.421403241871293],
           [-157.76987073414557, 21.42252185798779],
           [-157.77055737965338, 21.422841461018695],
           [-157.7712440251612, 21.423480664982048],
           [-157.76660916798346, 21.432189540181355]]]]),
    kaneohe_bay_reef = 
    /* color: #0b4a8b */
    /* shown: false */
    ee.Geometry({
      "type": "GeometryCollection",
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -157.81184507792136,
                21.45151825329566
              ],
              [
                -157.81205965464255,
                21.451098856601444
              ],
              [
                -157.81213475649497,
                21.450489730683067
              ],
              [
                -157.81190945093772,
                21.450110273906702
              ],
              [
                -157.81137300913474,
                21.449870616486567
              ],
              [
                -157.81081510965964,
                21.449990445245877
              ],
              [
                -157.8105576175942,
                21.450190159625883
              ],
              [
                -157.8103752273812,
                21.450609558933625
              ],
              [
                -157.8103752273812,
                21.45107888530021
              ],
              [
                -157.81052543108603,
                21.451348497636175
              ],
              [
                -157.81079365198752,
                21.451548210156233
              ],
              [
                -157.81119061892173,
                21.45165805192568
              ],
              [
                -157.81151248400352,
                21.45162809508767
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -157.80553648826444,
                21.448262959465758
              ],
              [
                -157.80433485862577,
                21.44418867815568
              ],
              [
                -157.80587981101834,
                21.440513738576524
              ],
              [
                -157.80399153587186,
                21.439954500525214
              ],
              [
                -157.80287573692166,
                21.438596342047926
              ],
              [
                -157.80261824485623,
                21.437238170928715
              ],
              [
                -157.80133078452909,
                21.435480518950644
              ],
              [
                -157.7986700331863,
                21.432124942754452
              ],
              [
                -157.79712508079373,
                21.430287332622605
              ],
              [
                -157.79120276328885,
                21.43076671140903
              ],
              [
                -157.78931448814237,
                21.428369801734355
              ],
              [
                -157.78304884788358,
                21.42773061917448
              ],
              [
                -157.77978728172147,
                21.432045047142815
              ],
              [
                -157.77764151450955,
                21.440114283044323
              ],
              [
                -157.77944395896756,
                21.44426856711839
              ],
              [
                -157.77841399070584,
                21.448103185872206
              ],
              [
                -157.78047392722928,
                21.448742279196154
              ],
              [
                -157.78141806480252,
                21.451218739372663
              ],
              [
                -157.77935812827909,
                21.452017588522587
              ],
              [
                -157.7778131758865,
                21.45361527369259
              ],
              [
                -157.7766973769363,
                21.454893409223345
              ],
              [
                -157.77498076316678,
                21.45553247278679
              ],
              [
                -157.7745516097244,
                21.45705023752244
              ],
              [
                -157.77472327110135,
                21.459925958947693
              ],
              [
                -157.7800447737869,
                21.458967391443103
              ],
              [
                -157.79515097495877,
                21.465677231580223
              ],
              [
                -157.80133078452909,
                21.469830787311125
              ],
              [
                -157.80811140891873,
                21.473425114957788
              ],
              [
                -157.8130037581619,
                21.47358486079463
              ],
              [
                -157.81720946189725,
                21.47182764695324
              ],
              [
                -157.8309423720535,
                21.483967964327565
              ],
              [
                -157.83413960094802,
                21.481671621289237
              ],
              [
                -157.83509443280374,
                21.478966031775087
              ],
              [
                -157.83645162131592,
                21.47555657893619
              ],
              [
                -157.83642212527658,
                21.474191320908012
              ],
              [
                -157.83657905195608,
                21.473269074572254
              ],
              [
                -157.8356275555777,
                21.470651358153617
              ],
              [
                -157.8337785400284,
                21.468583658135852
              ],
              [
                -157.8317382394575,
                21.469586606328914
              ],
              [
                -157.8297408191878,
                21.470230119133433
              ],
              [
                -157.8246767317947,
                21.460245480048297
              ],
              [
                -157.82193014976346,
                21.457849054720345
              ],
              [
                -157.81678030845487,
                21.45832834293787
              ],
              [
                -157.81274626609647,
                21.456810591509466
              ],
              [
                -157.8086263930496,
                21.452496895911807
              ],
              [
                -157.8063947951492,
                21.44946125583791
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        }
      ],
      "coordinates": []
    }),
    not_deep_water = 
    /* color: #ff0000 */
    /* shown: false */
    ee.Geometry.MultiPolygon(
        [[[[-178.3598226344293, 28.39266160992541],
           [-178.3634275233453, 28.390320895893513],
           [-178.34991415800334, 28.383222930933783],
           [-178.30656966032268, 28.376577596946724],
           [-178.27627142729045, 28.38397805617536],
           [-178.2767864114213, 28.4138012009732],
           [-178.28476866544963, 28.432596793329594],
           [-178.29318007292034, 28.446332825788264],
           [-178.30459555448772, 28.45403026183809],
           [-178.32115791192064, 28.45983224561206],
           [-178.33823821892747, 28.457870314956832],
           [-178.36064002861986, 28.449418505115062],
           [-178.37205551018724, 28.435154544199534],
           [-178.37608955254564, 28.428361505892074],
           [-178.37892196526536, 28.41839759435678],
           [-178.3784069811345, 28.41417019706797],
           [-178.37151906838426, 28.41330204995284],
           [-178.37304256310472, 28.416680234561827],
           [-178.37304256310472, 28.41958651943677],
           [-178.37259195199022, 28.42234175481036],
           [-178.37113283028611, 28.42479498623397],
           [-178.37008140435228, 28.427701048355253],
           [-178.36857936730394, 28.430474942314515],
           [-178.36368701806077, 28.436965947434768],
           [-178.3587732111455, 28.440626396814547],
           [-178.35370920052537, 28.443701831112005],
           [-178.3464003238721, 28.447975443089582],
           [-178.3350706729932, 28.45212602648959],
           [-178.3252001438184, 28.453786214232593],
           [-178.31292635536624, 28.451371387079984],
           [-178.30039507484867, 28.443975635867236],
           [-178.29284197426273, 28.434390576686894],
           [-178.2885504398389, 28.420577507696454],
           [-178.28554636574222, 28.407530143761267],
           [-178.28571802711917, 28.397639774679806],
           [-178.2893229160352, 28.390693314818765],
           [-178.29601770973636, 28.386615832883905],
           [-178.3127546939893, 28.387068894176487],
           [-178.32180983162357, 28.387446443774746],
           [-178.34664698933432, 28.38870187253161]]],
         [[[-177.3845128859075, 28.27323474413204],
           [-177.37043660802178, 28.276560705872825],
           [-177.3578194564977, 28.27550245658089],
           [-177.3497513460064, 28.27278119584386],
           [-177.34065326398763, 28.265070579620087],
           [-177.331020963439, 28.253100801428065],
           [-177.3214078957381, 28.237676163706247],
           [-177.31677302385913, 28.225349972686477],
           [-177.3154855595071, 28.214081227552807],
           [-177.3205495863185, 28.206215090030057],
           [-177.3359991594947, 28.200617677969188],
           [-177.3500754372459, 28.20008817789492],
           [-177.35303656840102, 28.20131746132522],
           [-177.35388413483847, 28.204744952552502],
           [-177.3554183764866, 28.204844239715143],
           [-177.35608356561315, 28.201336400686785],
           [-177.3616626170987, 28.201525386396376],
           [-177.3733356279167, 28.201071533175273],
           [-177.3857811173848, 28.19812144022518],
           [-177.3960808327952, 28.19456609178352],
           [-177.4050072528244, 28.194566091754314],
           [-177.41659443272007, 28.20243308694423],
           [-177.4189976997879, 28.222551804709003],
           [-177.4117020680185, 28.224744969653198],
           [-177.40895547726592, 28.231626677353585],
           [-177.41376201118098, 28.236541911147487],
           [-177.4073246890735, 28.24924485114533],
           [-177.39771162132593, 28.261341482582836],
           [-177.3856094556251, 28.27200050114612],
           [-177.3911884682215, 28.278879159697947],
           [-177.40397728164697, 28.27252964444862],
           [-177.41642277117379, 28.2620218772489],
           [-177.42766662701771, 28.229398167812274],
           [-177.4323014987876, 28.206935981095018],
           [-177.42723747194782, 28.196119169200028],
           [-177.4070710960901, 28.186901579840338],
           [-177.33917880534997, 28.18947373029764],
           [-177.31838562411178, 28.1952230191566],
           [-177.30525348690006, 28.201350210277926],
           [-177.3004469529217, 28.21360353859981],
           [-177.3138381386852, 28.2414349938472],
           [-177.32276455867415, 28.257010293534023],
           [-177.33460923143141, 28.272810092717204],
           [-177.36713916629793, 28.28565987615884],
           [-177.38130127516678, 28.283392379977272],
           [-177.38936938566286, 28.279461938881685]]],
         [[[-175.99629615060098, 27.787422921721983],
           [-175.98985884896524, 27.77519702482107],
           [-175.97003195992716, 27.756893580178907],
           [-175.9493467640043, 27.75051323293087],
           [-175.89638922921426, 27.76684313736514],
           [-175.86858008614786, 27.786207987264035],
           [-175.822317345059, 27.780664676545005],
           [-175.797896924949, 27.77519702482107],
           [-175.77309185597926, 27.783094655753583],
           [-175.7540016132682, 27.805841377108948],
           [-175.70078658641273, 27.916779833165183],
           [-175.7148628193229, 27.934980488279994],
           [-175.7461702024326, 27.972470626140723],
           [-175.78702561014745, 27.977625130923606],
           [-175.8495103513584, 27.966102956675808],
           [-175.90890518778417, 27.927889050763525],
           [-175.95662705057714, 27.89755093361501],
           [-175.95619789713476, 27.880482003910245],
           [-175.94555489176366, 27.876385060383264],
           [-175.93860260599706, 27.884958116893866],
           [-175.92246643656347, 27.89603774962104],
           [-175.89500061625097, 27.910146229930504],
           [-175.87611786478612, 27.923494495558785],
           [-175.86324326151464, 27.93259464093652],
           [-175.85036865824316, 27.93972255294349],
           [-175.81895462626073, 27.95306716613338],
           [-175.7985269224033, 27.959132354270277],
           [-175.7542382871494, 27.952915532064196],
           [-175.7370721494541, 27.938812632913262],
           [-175.73054901712987, 27.91621382765761],
           [-175.7351838743076, 27.893610298728913],
           [-175.7586417069973, 27.83021316694681],
           [-175.77865158076264, 27.792398841509065],
           [-175.79427276606538, 27.78617244387809],
           [-175.839591369581, 27.791183962655353],
           [-175.8674005126474, 27.793917420983327],
           [-175.91786895747163, 27.7679467922622],
           [-175.94928298945405, 27.757769475169997],
           [-175.96473251337983, 27.76126328830424],
           [-175.98155532832124, 27.778578793488805],
           [-175.99031005854584, 27.789057891992655]]],
         [[[-173.90074893282986, 25.96750636828009],
           [-173.92872973727322, 25.954850555904454],
           [-173.94898577975368, 25.970438618367783],
           [-173.9603154306326, 25.971055924862007],
           [-173.97250338839626, 25.98154963954889],
           [-173.97559329318142, 25.989727914807652],
           [-173.99550601290798, 25.99836849302157],
           [-174.00220080660915, 26.00669987734475],
           [-174.00254412936306, 26.01564774294948],
           [-174.01387378024197, 26.02243532401679],
           [-174.0188519601736, 26.027988507459018],
           [-174.0233151559744, 26.030302256326735],
           [-174.02417346285915, 26.036009308427268],
           [-174.02194186495876, 26.042024549222887],
           [-174.01541873263454, 26.055596266523583],
           [-174.0046040658865, 26.067778628561495],
           [-173.9723317270193, 26.081347362865095],
           [-173.9445225839529, 26.064231995652484],
           [-173.92890139865017, 26.047731030894575],
           [-173.91551181124782, 26.032615959562833],
           [-173.90452548312282, 26.012870892114783],
           [-173.89199420260525, 26.00083711294535],
           [-173.8925091867361, 25.985870308695088],
           [-173.8950841073904, 25.974142408736906],
           [-173.90298053073022, 25.964805546959514],
           [-173.88238116549584, 25.949602624803802],
           [-173.86229678439236, 25.967969359995227],
           [-173.86092349337673, 26.011945260574468],
           [-173.87414141940212, 26.040327974084697],
           [-173.8859860544119, 26.050352834748868],
           [-173.91246409776414, 26.079898315531775],
           [-173.9352950608989, 26.093465645109582],
           [-173.9711722886821, 26.099940406920773],
           [-173.98902507188524, 26.097782192806],
           [-174.02953715684617, 26.0869905249326],
           [-174.0396651780864, 26.06771721411414],
           [-174.0467032945415, 26.04967452109479],
           [-174.04653163316453, 26.034251214281014],
           [-174.03691859605516, 26.023607949934256],
           [-174.03520198228563, 26.01928866873467],
           [-174.0360602891704, 26.007101268504],
           [-174.02902217271532, 25.99414112629759],
           [-174.02438731553758, 25.988586341976234],
           [-174.01855082872117, 25.983648535508145],
           [-174.01134105088914, 25.978093255312515],
           [-173.9924582994243, 25.96713623903073],
           [-173.96773906114305, 25.942749357479606],
           [-173.93585203123962, 25.932464311775284],
           [-173.90340803099548, 25.931692425163384],
           [-173.88040540648376, 25.951142425657043]]],
         [[[-170.6340935745706, 25.454894649345054],
           [-170.66070108799835, 25.469153543576596],
           [-170.68336038975616, 25.470393367564053],
           [-170.69469004063507, 25.459389483146122],
           [-170.676665596055, 25.441874183567165],
           [-170.6685975113382, 25.43024757805773],
           [-170.67100077061554, 25.422340845451952],
           [-170.6663659134378, 25.41799967366642],
           [-170.65074472813507, 25.42203076693731],
           [-170.64130335240264, 25.423736188897045],
           [-170.63289194493194, 25.422805961728333],
           [-170.60611277012725, 25.405750524933183],
           [-170.5791619339456, 25.377681330491782],
           [-170.5791619339456, 25.368064967824374],
           [-170.56600003748576, 25.34354823205725],
           [-170.5428257515971, 25.3297399617653],
           [-170.50712018519084, 25.321826647397273],
           [-170.51175504236858, 25.328653851202507],
           [-170.50231366663616, 25.33160184291467],
           [-170.4908123543803, 25.332222463600026],
           [-170.4911556771342, 25.340600531360238],
           [-170.49424558191936, 25.348978019004658],
           [-170.48995404749553, 25.35161525614218],
           [-170.488237433726, 25.35859590035337],
           [-170.4933872750346, 25.363559668796402],
           [-170.49733548670451, 25.382016893894317],
           [-170.50454526453655, 25.39160279611581],
           [-170.51158338099162, 25.39625506355501],
           [-170.5160465767924, 25.40617930135911],
           [-170.51724820643108, 25.416412816531622],
           [-170.50162702112834, 25.426025327556655],
           [-170.53063779383342, 25.46028304029943],
           [-170.53973584681194, 25.43749732105068],
           [-170.5644550850932, 25.44478301995488],
           [-170.57492642908733, 25.464157733511552],
           [-170.57318346361953, 25.476532735598454],
           [-170.57498590807754, 25.479322150439607],
           [-170.59180872301897, 25.46645930998267],
           [-170.60073511462053, 25.46862904217005],
           [-170.61669962267717, 25.479322150439607],
           [-170.61395304064592, 25.48892963953271],
           [-170.59850351672014, 25.51542373367276],
           [-170.62476770739397, 25.518676991379984],
           [-170.63987390856585, 25.520535956194244],
           [-170.6451954112514, 25.516353244872175],
           [-170.64193384508928, 25.507057809009485],
           [-170.64656870226702, 25.49683199844296],
           [-170.6371273265346, 25.476687704787224],
           [-170.64742700915178, 25.48195653837032],
           [-170.65772669176894, 25.46576188775449],
           [-170.63249246935683, 25.451735093684928],
           [-170.62202112536272, 25.46428953866264],
           [-170.61609880785784, 25.466304327614672],
           [-170.60657160143694, 25.46304965176811],
           [-170.6012500987514, 25.46018236438923],
           [-170.595413611935, 25.455300069221426],
           [-170.59326784472307, 25.454215087843558],
           [-170.59000627856096, 25.45638504081924],
           [-170.5865730510219, 25.457237511642024],
           [-170.5843414531215, 25.456927522950522],
           [-170.58356897692522, 25.454990075539985],
           [-170.58631555895647, 25.4540600897055],
           [-170.58846132616839, 25.448712531727235],
           [-170.58571474413714, 25.445612389356427],
           [-170.58442728381, 25.44328723019912],
           [-170.5778183207973, 25.442434660593065],
           [-170.57275431017717, 25.43840424984516],
           [-170.57017938952288, 25.435226330899997],
           [-170.56520120959124, 25.432048328123606],
           [-170.56417124132952, 25.427319924961566],
           [-170.56726114611467, 25.42592462300411],
           [-170.58013574938616, 25.429257817547747],
           [-170.58125154833635, 25.431583247515366],
           [-170.5778183207973, 25.435381353281333],
           [-170.58065073351702, 25.436388993897626],
           [-170.5865730510219, 25.435536375463187],
           [-170.58554308276018, 25.43336604676481],
           [-170.58717386584124, 25.432435893925813],
           [-170.58897631029924, 25.43352107153986],
           [-170.5924095378383, 25.432978483954567],
           [-170.59446947436174, 25.43600144081186],
           [-170.59695856432756, 25.435923930045085],
           [-170.60022013048967, 25.433753608328384],
           [-170.60348169665178, 25.43321102179033],
           [-170.6045116649135, 25.436388993897626],
           [-170.60691492419085, 25.438636777208075],
           [-170.61721460680803, 25.438714286229285],
           [-170.62310595798965, 25.437438977875217],
           [-170.62851329136367, 25.43588877156302],
           [-170.62945742893692, 25.436896407935134],
           [-170.629114106183, 25.44038431490765],
           [-170.6305732278871, 25.4427870365118],
           [-170.63400645542617, 25.44286454286226],
           [-170.63829798985, 25.44046182280434],
           [-170.64250369358535, 25.440616838448097],
           [-170.6471385507631, 25.444879690465495],
           [-170.6419887094545, 25.447282322381746],
           [-170.63555140781875, 25.44937489821517],
           [-170.64319033909317, 25.451467437678872],
           [-170.64645190525528, 25.455187418028057],
           [-170.6416453867006, 25.455187418028057],
           [-170.63872714329239, 25.45580740357606]]],
         [[[-171.73526699959257, 25.791296203425873],
           [-171.75329144417265, 25.783722457484483],
           [-171.75483639656522, 25.766563815815555],
           [-171.74496586739042, 25.74808845117135],
           [-171.72848637520292, 25.74128508251104],
           [-171.71303685127714, 25.761230219085007],
           [-171.70745785652616, 25.783181457123117]]],
         [[[-169.46920901398317, 16.80338012541668],
           [-169.5255139456238, 16.78102967725693],
           [-169.56705599884646, 16.727772432973662],
           [-169.57220584015505, 16.687984162673906],
           [-169.54757195819263, 16.703058367918356],
           [-169.54946023333912, 16.71432070259388],
           [-169.55564004290943, 16.712923222728847],
           [-169.55709916461353, 16.71777325602501],
           [-169.5473144661272, 16.735199476528322],
           [-169.54319459308033, 16.73947358919103],
           [-169.53473614230143, 16.74911107384594],
           [-169.52847050204264, 16.758398248678095],
           [-169.51962994112955, 16.766452245677115],
           [-169.51345013155924, 16.769410771167692],
           [-169.50392292513834, 16.772122712428658],
           [-169.49551151766764, 16.777217770173646],
           [-169.48804424777018, 16.782312691325714],
           [-169.48289440646158, 16.78350422575409],
           [-169.4731526233195, 16.78436705636447],
           [-169.4692044116496, 16.78428488218949],
           [-169.46710155978192, 16.784243795088642],
           [-169.46495579257, 16.784079446596476],
           [-169.4634966708659, 16.784243795088706],
           [-169.46199463381757, 16.784284882189464],
           [-169.46075008883466, 16.78416162086032],
           [-169.4596772052287, 16.783915097962087],
           [-169.45886181368817, 16.783750749185526],
           [-169.4578747607707, 16.78346313848442],
           [-169.45705936923014, 16.783339876622087],
           [-169.45448444857584, 16.782066166028187],
           [-169.4524245120524, 16.781490939089938],
           [-169.4468026019572, 16.779724159747815],
           [-169.44238232150065, 16.779148925719284],
           [-169.43912075533854, 16.778203894606364],
           [-169.43736122622477, 16.778203894606364],
           [-169.4361595965861, 16.777751921543224],
           [-169.43367050662027, 16.776354907097538],
           [-169.4322543002604, 16.775245505957756],
           [-169.4295506335734, 16.772615788501728],
           [-169.42852066531168, 16.77060238648612],
           [-169.42693279757486, 16.768424601118614],
           [-169.42307041659342, 16.766123517781352],
           [-169.41955135836588, 16.77015039534793]]]]),
    back_reef_slope = 
    /* color: #f04bff */
    /* shown: false */
    ee.Geometry({
      "type": "GeometryCollection",
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -178.37205282418523,
                28.41368511029238
              ],
              [
                -178.3771597501496,
                28.414289037289233
              ],
              [
                -178.3778463956574,
                28.40783438923465
              ],
              [
                -178.37351194588933,
                28.39764203889437
              ],
              [
                -178.36703172890935,
                28.390771086625854
              ],
              [
                -178.36364141671453,
                28.389864993746716
              ],
              [
                -178.35986486642156,
                28.39220571784537
              ],
              [
                -178.35896364419256,
                28.39296077910953
              ],
              [
                -178.3591353055695,
                28.394017855843366
              ],
              [
                -178.35690370766912,
                28.395225930630314
              ],
              [
                -178.3558737394074,
                28.397981799701466
              ],
              [
                -178.3551870938996,
                28.400850847523643
              ],
              [
                -178.35793367593084,
                28.40587149429102
              ],
              [
                -178.36444098117,
                28.409405856793395
              ],
              [
                -178.3660288489068,
                28.41287853030311
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -169.49980431716665,
                16.68886262774245
              ],
              [
                -169.3864665385762,
                16.756967473323435
              ],
              [
                -169.42835191455276,
                16.782854301630753
              ],
              [
                -169.43684915271194,
                16.77825245645216
              ],
              [
                -169.4391665813008,
                16.776773268262204
              ],
              [
                -169.4406257030049,
                16.775458424650516
              ],
              [
                -169.4417415019551,
                16.77381485734489
              ],
              [
                -169.44225648608597,
                16.772171275828192
              ],
              [
                -169.44199899402054,
                16.770856400383682
              ],
              [
                -169.4431147929707,
                16.76756917198897
              ],
              [
                -169.44629052844437,
                16.764774983173925
              ],
              [
                -169.44766381945996,
                16.764035338086604
              ],
              [
                -169.44929460254104,
                16.76230948836423
              ],
              [
                -169.44998124804883,
                16.760830176139475
              ],
              [
                -169.45350030627637,
                16.760254884945514
              ],
              [
                -169.4564185496846,
                16.758364630202873
              ],
              [
                -169.4592509624043,
                16.756967473323474
              ],
              [
                -169.46178298277272,
                16.75659765193349
              ],
              [
                -169.46457246508984,
                16.754255315979705
              ],
              [
                -169.4684348991935,
                16.751912989858237
              ],
              [
                -169.47015149875105,
                16.75002264485227
              ],
              [
                -169.47212556567578,
                16.749365116438973
              ],
              [
                -169.4747863112797,
                16.749221300089406
              ],
              [
                -169.47718957629593,
                16.750228101957145
              ],
              [
                -169.47959283557327,
                16.75146093162544
              ],
              [
                -169.48400049733982,
                16.75433750313374
              ],
              [
                -169.49498682546482,
                16.754994999088524
              ],
              [
                -169.49387102651463,
                16.740693949624248
              ],
              [
                -169.51112299489841,
                16.73641986433949
              ],
              [
                -169.51747446584568,
                16.7336252182743
              ],
              [
                -169.51764612722263,
                16.722035219323605
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -175.99736759624233,
                27.83857574866536
              ],
              [
                -175.9898144956564,
                27.83857574866536
              ],
              [
                -175.9843213315939,
                27.839486511549346
              ],
              [
                -175.9814030881857,
                27.842066964866298
              ],
              [
                -175.97754070720424,
                27.84282591004272
              ],
              [
                -175.97067425212612,
                27.842066964866298
              ],
              [
                -175.95556805095424,
                27.8387275430103
              ],
              [
                -175.94930241069545,
                27.84168749028688
              ],
              [
                -175.9553963895773,
                27.84495092828748
              ],
              [
                -175.9652669187521,
                27.848897280287996
              ],
              [
                -175.97196171245326,
                27.85830723245134
              ],
              [
                -175.9861237760519,
                27.865743552309002
              ],
              [
                -175.99805424175014,
                27.868778638274605
              ],
              [
                -176.01401874980678,
                27.86984089827887
              ],
              [
                -176.0201985593771,
                27.866426454062896
              ],
              [
                -176.02243015727748,
                27.847758924255263
              ],
              [
                -176.02191517314662,
                27.824685667451106
              ],
              [
                -176.0157353635763,
                27.819372051607004
              ],
              [
                -176.00740978679408,
                27.820358885641397
              ],
              [
                -176.0066373105978,
                27.821725256420596
              ],
              [
                -176.0062939878439,
                27.824154317569516
              ],
              [
                -176.00534985027065,
                27.823622965087203
              ],
              [
                -176.00534985027065,
                27.824533853464608
              ],
              [
                -176.00500652751674,
                27.825900171700027
              ],
              [
                -176.00431988200893,
                27.82605198377575
              ],
              [
                -176.00320408305873,
                27.828480948112173
              ],
              [
                -176.00243160686244,
                27.836374706798267
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        }
      ],
      "coordinates": []
    }),
    reef_flat = 
    /* color: #ff0000 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[-166.21780233001004, 23.855147756689785],
          [-166.21787428737028, 23.85356607704976],
          [-166.21820372712935, 23.85210214646867],
          [-166.21956311607173, 23.850638211284984],
          [-166.221094207767, 23.849704175091592],
          [-166.22202446317706, 23.848377621118438],
          [-166.2218243993981, 23.846821376792228],
          [-166.22042272957611, 23.844558597776892],
          [-166.2171473785781, 23.842388019903932],
          [-166.2142475123033, 23.840488872851846],
          [-166.2114580149278, 23.838172892063877],
          [-166.21173696466536, 23.8367401035776],
          [-166.2108679310645, 23.835292608853802],
          [-166.20901183802087, 23.83525826956975],
          [-166.20725230292396, 23.834973661216825],
          [-166.20643691965194, 23.83411001228068],
          [-166.20569661220307, 23.832431828040924],
          [-166.2033684725389, 23.83110693237556],
          [-166.2001069063768, 23.832402387136607],
          [-166.1973388530914, 23.833560442710514],
          [-166.1943991655931, 23.833383783645075],
          [-166.19160964976197, 23.83275568146844],
          [-166.18965701269082, 23.832088324139796],
          [-166.18714647241683, 23.830714367772465],
          [-166.18570880708629, 23.829811455210407],
          [-166.18414239832015, 23.828005639632632],
          [-166.18182496973128, 23.824040587765925],
          [-166.1816103930101, 23.820036154991005],
          [-166.17980794855208, 23.818465755467923],
          [-166.17620305963607, 23.817366464496235],
          [-166.17268400140853, 23.815796032672335],
          [-166.17088155695052, 23.814461150683854],
          [-166.16864995905013, 23.81501080963561],
          [-166.16598920770736, 23.815953076709707],
          [-166.16195516534896, 23.815953076709707],
          [-166.15903692194075, 23.81461819633612],
          [-166.15586118646712, 23.81312625496903],
          [-166.15954374945983, 23.81089891082814],
          [-166.16280531562194, 23.808071979041205],
          [-166.16460776007995, 23.804302640927144],
          [-166.16538023627623, 23.80092584930376],
          [-166.16752600348815, 23.797470436774574],
          [-166.16821264899596, 23.79370079101963],
          [-166.16855597174987, 23.787417805082598],
          [-166.1676976648651, 23.78388349202174],
          [-166.16615271247252, 23.782077028239843],
          [-166.16465063810347, 23.776185993866573],
          [-166.1600372610487, 23.774418724196266],
          [-166.15722632087096, 23.768724126362446],
          [-166.15692604643883, 23.764796503738722],
          [-166.15688314686727, 23.76365749720271],
          [-166.1581276959217, 23.76316654889828],
          [-166.15795603225763, 23.7622140847806],
          [-166.15797748514942, 23.76106522765793],
          [-166.1598657175723, 23.76045644501416],
          [-166.15988707221373, 23.758944219909385],
          [-166.15852433283015, 23.758060466390507],
          [-166.15784824849052, 23.757726604256728],
          [-166.15657142237112, 23.758256855414924],
          [-166.14904511307486, 23.75007682828726],
          [-166.14828625852, 23.7478918247218],
          [-166.14555334723815, 23.74641386836288],
          [-166.13679861701354, 23.736121580650757],
          [-166.13061867391187, 23.733135494659347],
          [-166.12220739997252, 23.726457089506585],
          [-166.0882184473358, 23.72960009208868],
          [-166.0904500452362, 23.71529881837216],
          [-166.08598684943541, 23.707911832018677],
          [-166.09422659552916, 23.69439413593767],
          [-166.10813116706237, 23.675372681909728],
          [-166.12495398200377, 23.662637764397033],
          [-166.157054659494, 23.661537157731388],
          [-166.16821264899596, 23.66310945013209],
          [-166.17885565436706, 23.66499617605618],
          [-166.2039182154022, 23.662008847436727],
          [-166.24322867072448, 23.67112784726367],
          [-166.25833487189635, 23.650058850521575],
          [-166.21318792975768, 23.63291813380856],
          [-166.18761038459166, 23.626155582357534],
          [-166.12581228888854, 23.615932458055635],
          [-166.10555624640807, 23.617662581319582],
          [-166.08324026740416, 23.64329718450811],
          [-166.0610959497772, 23.680560625893023],
          [-166.04594025105064, 23.71791419935658],
          [-166.0442236372811, 23.757198858308698],
          [-166.05761322468345, 23.79057860593184],
          [-166.0830191084725, 23.816022203468027],
          [-166.13074097126548, 23.84821220091113],
          [-166.1951139876229, 23.87207474660744],
          [-166.2179878661019, 23.856729436309]]]),
    not_deep_lagoon = 
    /* color: #00ff00 */
    /* shown: false */
    ee.Geometry({
      "type": "GeometryCollection",
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -166.31452254525834,
                23.875988258700826
              ],
              [
                -166.35245942730197,
                23.851066652387193
              ],
              [
                -166.3261107766477,
                23.841118174829557
              ],
              [
                -166.30250624887162,
                23.863822417162726
              ],
              [
                -166.2996738361519,
                23.868217949865187
              ],
              [
                -166.29460982553178,
                23.871200547798832
              ],
              [
                -166.2875717090767,
                23.874340050343502
              ],
              [
                -166.27873114816362,
                23.87653765682294
              ],
              [
                -166.26946143380815,
                23.877479476749876
              ],
              [
                -166.26130751840287,
                23.877479476749876
              ],
              [
                -166.2568443226021,
                23.87802886854247
              ],
              [
                -166.244398872773,
                23.87810735289389
              ],
              [
                -166.23607329599076,
                23.876459171519688
              ],
              [
                -166.2238853382271,
                23.875988258700826
              ],
              [
                -166.21513060800248,
                23.872299382349716
              ],
              [
                -166.20980910531694,
                23.88375810111742
              ],
              [
                -166.2520378040474,
                23.886426424227082
              ],
              [
                -166.279160301606,
                23.883836581994302
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -169.49276325618985,
                16.78186621585038
              ],
              [
                -169.4956385842538,
                16.77981182376929
              ],
              [
                -169.49568149959805,
                16.778250470932264
              ],
              [
                -169.49411508953335,
                16.778517545353388
              ],
              [
                -169.491711830256,
                16.779791279736298
              ],
              [
                -169.4895875207162,
                16.781188268919273
              ],
              [
                -169.48870775615933,
                16.78147588306427
              ],
              [
                -169.4861972085214,
                16.783324820742937
              ],
              [
                -169.48780653393032,
                16.785358631405295
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -170.69409197012726,
                25.461018999630905
              ],
              [
                -170.68868463675324,
                25.45210678628612
              ],
              [
                -170.66877191702667,
                25.41683895208338
              ],
              [
                -170.65460985342804,
                25.42218792503188
              ],
              [
                -170.6489450279886,
                25.42412590013539
              ],
              [
                -170.6478292290384,
                25.429552064654754
              ],
              [
                -170.64937418143097,
                25.437380814298248
              ],
              [
                -170.65375154654328,
                25.441876301958565
              ],
              [
                -170.65701311270539,
                25.443658948879744
              ],
              [
                -170.6558973137552,
                25.44854171618229
              ],
              [
                -170.6499749962503,
                25.453734283190435
              ],
              [
                -170.65752809683624,
                25.457221702459826
              ],
              [
                -170.66345041434113,
                25.45815166386597
              ],
              [
                -170.66714113394562,
                25.463808774257682
              ],
              [
                -170.68525140921417,
                25.465668588073786
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -170.64653213122244,
                25.521341320894127
              ],
              [
                -170.66078002550955,
                25.503215307520637
              ],
              [
                -170.64018066027518,
                25.484466723557176
              ],
              [
                -170.6118565330779,
                25.48369192574818
              ],
              [
                -170.59881026842947,
                25.511116726726797
              ],
              [
                -170.63623244860526,
                25.525523858373617
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -173.97835005218792,
                25.945741639533257
              ],
              [
                -173.9579223483305,
                25.928915261322516
              ],
              [
                -173.9081405490141,
                25.923511786128117
              ],
              [
                -173.86793141699616,
                25.951416500301598
              ],
              [
                -173.85660176611725,
                25.9850604210575
              ],
              [
                -173.8699913535196,
                26.040135405527472
              ],
              [
                -173.89942931685886,
                26.072367888762525
              ],
              [
                -173.9565512612217,
                26.10173755751811
              ],
              [
                -174.01669186049577,
                26.079466076247087
              ],
              [
                -174.0278763900904,
                26.034708599718673
              ],
              [
                -174.04132195925436,
                26.014710039995126
              ],
              [
                -174.02936145015352,
                26.003967427935134
              ],
              [
                -174.0129935954736,
                26.036781873485097
              ],
              [
                -174.00143181320396,
                26.039051992027826
              ],
              [
                -174.00222907350894,
                26.0493420926607
              ],
              [
                -173.99648964932712,
                26.07075961924741
              ],
              [
                -173.98286667396005,
                26.07493434765432
              ],
              [
                -173.97072837203052,
                26.07588328780815
              ],
              [
                -173.95743954118413,
                26.069764303254583
              ],
              [
                -173.94734252890635,
                26.075411822095376
              ],
              [
                -173.91685514512776,
                26.05833453168616
              ],
              [
                -173.89986043310944,
                26.036433695765066
              ],
              [
                -173.90346496456542,
                26.029646541173598
              ],
              [
                -173.89857245154806,
                26.023862167157628
              ],
              [
                -173.8916206870157,
                26.016072203936886
              ],
              [
                -173.88698582983795,
                26.00805004022428
              ],
              [
                -173.88183598852936,
                26.00110734080258
              ],
              [
                -173.88097768164462,
                25.99416423102294
              ],
              [
                -173.87989823215094,
                25.982481638588027
              ],
              [
                -173.88204425125414,
                25.97032857371264
              ],
              [
                -173.88710800998297,
                25.96604597368862
              ],
              [
                -173.9078790365943,
                25.949839914762347
              ],
              [
                -173.91976638662854,
                25.94991777120517
              ],
              [
                -173.92890760962038,
                25.954934142750044
              ],
              [
                -173.93551651828375,
                25.94891378685627
              ],
              [
                -173.9437562643775,
                25.95138344508345
              ],
              [
                -173.95560089938726,
                25.967897952606116
              ],
              [
                -173.96927113018407,
                25.96706711082113
              ],
              [
                -173.98156727340154,
                25.960679113155436
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -157.34874577962864,
                21.334314588369352
              ],
              [
                -157.48607488119114,
                20.600813427215538
              ],
              [
                -157.14549870931614,
                19.82759702739309
              ],
              [
                -155.99261297743814,
                18.66128181649099
              ],
              [
                -154.26291778642724,
                19.283933781677522
              ],
              [
                -155.67333074056614,
                20.65222376015898
              ],
              [
                -156.60167546712864,
                21.211461585374657
              ],
              [
                -157.12901921712864,
                21.32919776233821
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        }
      ],
      "coordinates": []
    }),
    not_reef_slope = 
    /* color: #d63000 */
    /* shown: false */
    ee.Geometry.MultiPoint(),
    not_DL_outer_reef = 
    /* color: #0000ff */
    /* shown: false */
    ee.Geometry.MultiPoint(),
    not_DL_shallow_lagoon = 
    /* color: #999900 */
    /* shown: false */
    ee.Geometry.MultiPolygon(
        [[[[-177.4310500712857, 28.21722313127527],
           [-177.43156505541657, 28.203306178253293],
           [-177.41851879076813, 28.19135430433159],
           [-177.39783359484528, 28.186588311002673],
           [-177.38770557360505, 28.189765663497028],
           [-177.3809249492154, 28.216920608100818],
           [-177.38581729845856, 28.225617807443367],
           [-177.3930270762906, 28.227735279154103],
           [-177.4025542827115, 28.22149617955609],
           [-177.40637371080072, 28.22289530071747],
           [-177.40770412402009, 28.225390932982908],
           [-177.40942073778962, 28.223727172205514],
           [-177.4109656901822, 28.22455905583567],
           [-177.41396976427887, 28.226071554917674],
           [-177.4149997325406, 28.22516405804022],
           [-177.42366863207673, 28.22569343215636],
           [-177.4289043040738, 28.221307110239405]]],
         [[[-177.41173784860962, 28.266008897470282],
           [-177.4243760407788, 28.23722014845908],
           [-177.41143673085955, 28.235500395419553],
           [-177.40959098570826, 28.233724690187074],
           [-177.402553755867, 28.241475635467733],
           [-177.38598864206665, 28.247864288082507],
           [-177.38298456796997, 28.24960328027776],
           [-177.3799804938733, 28.25141785059401],
           [-177.37491648325317, 28.253459205288582],
           [-177.37199848591712, 28.253005386946942],
           [-177.3675350440442, 28.267671998791645],
           [-177.36427347788208, 28.28399925125879],
           [-177.39517252573364, 28.283243415194388]]],
         [[[-178.37319011968884, 28.448887577928982],
           [-178.386449253587, 28.41012456759929],
           [-178.36387578251765, 28.4036696657697],
           [-178.35705224278377, 28.40472663568716],
           [-178.35499230626033, 28.40567034991711],
           [-178.35374776127742, 28.4070670315499],
           [-178.35288945439265, 28.407859734555412],
           [-178.35211697819636, 28.40872792627909],
           [-178.35189068041848, 28.40940894922727],
           [-178.3516975613694, 28.410126141107856],
           [-178.35161173068093, 28.41082445485188],
           [-178.3515902730088, 28.411598256596207],
           [-178.35193359576272, 28.412650525583565],
           [-178.35223400317238, 28.413348822684075],
           [-178.35253441058205, 28.41417922405372],
           [-178.35255586825417, 28.414896383633018],
           [-178.3519121380906, 28.41570790045771],
           [-178.34667646609353, 28.425162556729678],
           [-178.33388769351052, 28.443201434034624],
           [-178.34289991580056, 28.456407866453173]]],
         [[[-178.32508201879773, 28.41046841840205],
           [-178.33160515112195, 28.408581067021693],
           [-178.33370800298962, 28.40725990104673],
           [-178.33516712469373, 28.406995665874454],
           [-178.3365833310536, 28.40673143004309],
           [-178.33825702947888, 28.406014215178523],
           [-178.33958740515027, 28.405334743985744],
           [-178.34014530462537, 28.405561234867545],
           [-178.34113235754285, 28.405259246917552],
           [-178.34291325286756, 28.405334743985744],
           [-178.3447586126698, 28.404844012080748],
           [-178.34488735870252, 28.40442877561647],
           [-178.3455310888661, 28.403711545163183],
           [-178.34570275024305, 28.40306980853673],
           [-178.3462177343739, 28.402088321472124],
           [-178.3481060095204, 28.400804824669496],
           [-178.35072384551893, 28.400767074528204],
           [-178.35166798309217, 28.39933255919275],
           [-178.35368500427137, 28.399106054996157],
           [-178.3552728720082, 28.39899280271633],
           [-178.3566461630238, 28.39842653950159],
           [-178.35784779266248, 28.397482760753014],
           [-178.35947857574354, 28.39601044912248],
           [-178.36098061279188, 28.394651374078837],
           [-178.3704647315434, 28.384212417597492],
           [-178.3035597098759, 28.370808174873666]]]]),
    not_RS_plateau = 
    /* color: #009999 */
    /* shown: false */
    ee.Geometry.MultiPoint(),
    gradual_reef_slope = 
    /* color: #d63000 */
    /* shown: false */
    ee.Geometry.MultiPoint(),
    steep_slope = 
    /* color: #98ff00 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[-179.5463281908895, 29.271216909487254],
          [179.83843743411046, 28.076010056289288],
          [-174.5805078783895, 24.451307168012036],
          [-168.1205469408895, 21.702508944676243],
          [-170.2299219408895, 16.3877727492622],
          [-169.0433985033895, 15.881201909553383],
          [-166.2089258471395, 22.96259860288609],
          [-161.7265039721395, 21.947281728146223],
          [-160.2543360033895, 23.608446782108963],
          [-167.38160548584972, 24.810826989087744],
          [-171.46851954834972, 24.85070964850898],
          [-171.00709376709972, 26.51399137830625],
          [-172.10572657959972, 26.592611192864478],
          [-173.33619532959972, 24.810826989087744],
          [-175.66529689209972, 25.68525324259878],
          [-174.12721095459972, 28.19226902675772]]]),
    SD_RC_on_ORF = 
    /* color: #d63000 */
    /* shown: false */
    ee.Geometry({
      "type": "GeometryCollection",
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -158.3129233200995,
                21.584018988447863
              ],
              [
                -158.252498515412,
                21.54793939867899
              ],
              [
                -157.88926304177917,
                21.578910919772266
              ],
              [
                -157.86488712625183,
                21.593915358818872
              ],
              [
                -157.94659794168152,
                21.734625822618856
              ],
              [
                -158.0121725876776,
                21.724739099677915
              ],
              [
                -158.11139286355652,
                21.62519620769203
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -157.2516402582385,
                21.217923216952528
              ],
              [
                -157.17885583441037,
                21.195838175789596
              ],
              [
                -156.96805566351193,
                21.17278939535047
              ],
              [
                -156.96908563177365,
                21.22624425949223
              ],
              [
                -157.246147094176,
                21.240964954143397
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -156.64365241829847,
                21.012501129113616
              ],
              [
                -156.49945686165785,
                20.882966036541568
              ],
              [
                -156.19389961068129,
                20.7841364048216
              ],
              [
                -156.02292487923597,
                20.702585322560143
              ],
              [
                -155.9370941907594,
                20.785420322035716
              ],
              [
                -156.10542175848818,
                20.870205295024405
              ],
              [
                -156.25854370673036,
                20.970260677941173
              ],
              [
                -156.45698425848818,
                20.944611821005456
              ],
              [
                -156.59362671454286,
                21.06512315725636
              ],
              [
                -156.65130493719911,
                21.037567982239455
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -159.7285150728244,
                21.951112286289824
              ],
              [
                -159.2787622652072,
                22.105150127761288
              ],
              [
                -159.2787622652072,
                22.18655681002802
              ],
              [
                -159.38299574150423,
                22.295170354310407
              ],
              [
                -159.75378431572298,
                22.20492680949345
              ],
              [
                -159.81695570244173,
                22.075179587146838
              ],
              [
                -159.79772962822298,
                21.980974566663665
              ],
              [
                -159.76339735283236,
                21.966965771459282
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -160.33715778206545,
                21.828816450887675
              ],
              [
                -160.19914203499513,
                21.736999664469145
              ],
              [
                -159.99314838265138,
                21.986807183105935
              ],
              [
                -160.11399799202638,
                22.045372021889694
              ],
              [
                -160.31381183479982,
                21.85494796674829
              ]
            ]
          ],
          "evenOdd": true
        }
      ],
      "coordinates": []
    }),
    global_not_applied = 
    /* color: #98ff00 */
    /* shown: false */
    ee.Geometry.MultiPolygon(
        [[[[-170.68934824512408, 25.48022058708533],
           [-170.71406748340533, 25.39464975808934],
           [-170.64265635059283, 25.328880205337754],
           [-170.48335459278033, 25.289152972262652],
           [-170.45039560840533, 25.38348386651409],
           [-170.52180674121783, 25.48269999408972],
           [-170.6028309111397, 25.537234004551493],
           [-170.6632557158272, 25.544668540836174],
           [-170.68110849903033, 25.502533408945066]]],
         [[[-166.37283231390228, 23.862790332759445],
           [-166.2478628314804, 23.566060393607664],
           [-166.00891019476165, 23.612626184649947],
           [-166.0391225971054, 23.9255699909091],
           [-166.30966092718353, 23.928080543139345]]]]),
    TRF_to_ORF = 
    /* color: #00932a */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[-157.869381860594, 21.841853536987728],
          [-160.31270437968163, 22.781377189936485],
          [-160.9510468996565, 21.540706978107163],
          [-158.133053735594, 21.233814185109296],
          [-157.770504907469, 21.20052890754667],
          [-157.31327803250514, 21.068767821098035],
          [-157.2557765522611, 21.076005174237434],
          [-157.24607808103647, 21.090825621257178],
          [-157.1720054859157, 21.09378162504505],
          [-157.1429034919613, 21.096086377427078],
          [-157.1040155401172, 21.1051180674999],
          [-157.04546006119642, 21.10844002247535],
          [-156.8846389380945, 21.062789471428186],
          [-156.8013328434283, 21.077084902558223],
          [-156.79436075213616, 21.034565206256378],
          [-157.1094806486466, 20.91327944339016],
          [-156.98967416279257, 20.674189644341816],
          [-156.68539640814024, 20.432175355430143],
          [-156.16818377679678, 18.59700020932272],
          [-155.02244732170274, 18.751289925981716],
          [-154.2971730193249, 19.67576772340799],
          [-155.77390807311735, 20.764936762981783],
          [-156.6435008305671, 21.16609623521782],
          [-157.70162155810615, 21.522324249096783],
          [-157.7538066166999, 21.48166891178141],
          [-157.76650955859444, 21.473841594221653],
          [-157.78144409838936, 21.453552507233198],
          [-157.77972748461983, 21.448439850867754],
          [-157.77595093432686, 21.44668233384354],
          [-157.76788284961006, 21.443007457085894],
          [-157.75003006640694, 21.433739965511425],
          [-157.7641629082898, 21.41162117910907],
          [-157.78407562801635, 21.395638943706956],
          [-157.82939423153198, 21.419931250785872],
          [-157.87059296200073, 21.464030636247646],
          [-157.8578900201062, 21.510671983183414],
          [-157.84450043270385, 21.503964216786386],
          [-157.8311108453015, 21.501089365036222],
          [-157.82424439022338, 21.503325365753014],
          [-157.69323540430875, 21.5863682662884]]]),
    SD_RU = 
    /* color: #d63000 */
    /* shown: false */
    ee.Geometry.MultiPoint(),
    kaneohe_bay_deep_ca_sd = 
    /* color: #d63000 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[-157.86135077941887, 21.495305701818573],
          [-157.8459012554931, 21.461760234888594],
          [-157.81671882141106, 21.417340548680436],
          [-157.77071357238762, 21.401358938729743],
          [-157.75045752990715, 21.44035099523842],
          [-157.7971494244384, 21.462718784024933],
          [-157.81534553039543, 21.474220881821477],
          [-157.82324195373528, 21.492750128735796],
          [-157.83834815490715, 21.512554645785162],
          [-157.86100745666496, 21.50361100430096]]]);
/***** End of imports. If edited, may not auto-convert in the playground. *****/
///////////////////////////////
// Global coral atlas project - Hawaii
// Contact: mitchell.lyons@gmail.com
// Region coordinator: V1: Paul Tudman (tuddy117@gmail.com); V1+: v2 Chris Roelfsema
// Description:
// - Developing a process to combine OBIA and supervised classification
// - This script loads the raw classification data (from *_classification script)
// - Then applied some cleanup and object-based relational rules
///////////////////////////////

// Table of contents
// 1. Setting constants
// 2. Data loads & vis
// 3. OBIA clean up rules
// 4. Export

// Load and libraries needed
var map_palettes = require('users/mitchest/global_reefs_modules:colour_pals');
var pkg_vis = require('users/mitchest/global_reefs_modules:pkg_vis');
var param_module = require('users/mitchest/global_reefs_modules:reef_params');

// ###########################################
// SENSOR GENERICS
var sensor_params = param_module.dove;         //<------------ THIS IS WHERE YOU CHOOSE THE SENSOR
// REGION AND SENSOR SPECIFIC LOAD PATHS
var region_params = param_module.hawaii;  //<------------ THIS IS WHERE YOU CHOOSE THE REGION
//  ^^ all the data paths are in this module ^^
// ###########################################

// 1. Setting constants

// These will get written to the asset metadata 

var vars = {
  
  // analysis type
  geomorphic: false, // map geomorphic zonation (when set to true) or benthic habitat (when set to false)

  // analysis parameters
  image_data_scale: sensor_params.pixel,
  small_object_geo: ee.Number(400).int(), // smallest object szie in pixels (geomorphic)
  small_object_benthic: ee.Number(130).int(), // smallest object szie in pixels (benthic)
  smooth_radius: ee.Number(3), // radius in pixels for initial smooth 
  dist_to_land_ORF: 1000, //distance to land in meters to convert terrestrial reef flat to ORF
  dist_to_land_RC: 200, //distance to land in meters to convert reef crest to TRF
  wave_height: 0.4, //cut off height for waves in metres, Hs95 threshold
  geo_depth_cutoff: 1400, //depth in centimetres
  shallowlag_depth_cutoff: 500, //depth in centimetres
  benthic_depth_cutoff: 1000, //depth in centimetres
  lagoon_region: "Hawaiian Islands",
  
  //############
  // Clean-up stage selection
  cleanup_stage: 2, // set to 1, 2 or 3
  geo_refinement: false, // set to true to apply the refinement_mask (the other stage 3 masks will still run)
  
  // should the global extent + depth cleanup be applied?
  global_extent_clean: true,
  global_depth_thresh: 500, // this is the depth limit for ADDING to the global extent (i.e. 5 = everything <5m will be added to the global extent layer)
  global_land_dist: -1, // [-1 (don't apply) OR +ve distance in meters] WITHIN this distance, the global extent/depth mask will be applied
  global_not_applied: true, // true = EXCLUDE reefs within 'global_not_applied' geometry polygons - mutually exclusive to land distance rule
 
  /*
  - GEOMORPHIC 1: The first pass does a small object filter, just to generally clean noise and reduce the amount of cleaning needed
  -            2: The second pass runs the OBIA cleanup rules
  -            3: The third pass is the MANUAL cleanup stage, which includes AT LEAST the no_reef masking
                        - see below where it starts/ends (only that section is run)
                        - please put region specific stuff in here ONLY

  - BENTHIC 1: This is the main benthic stge - it does noise removal, no data reclaim and OBIA rules - review those if needed
            2: The second mas is the MANUAL stage - it's optional, but shuold include ALL region specific stuff
                        - see below where it starts/ends (only that section is run)
                        - please put region specific stuff in here ONLY
  */
  
  // DON'T TOUCH --->
  obia_2nd_pass: null,
  obia_clean: null, // run object-based relationship rules + small object clean up
  fast_clean: null, // run a faster (but less precise) version of the OBIA clean; only applies to geomorphic (`obia_clean: true` also)
  manual_clean: false,// apply manual touch ups
  // --------------<
  //############
  
  reproject_display: true,
  
  // export options
  do_export: true, // export the results?
  geomorph_output_name: region_params.sname + '_geo_clean', // DO NOT CHANGE - change in the pop up dialouge if you must
  benthic_output_name: region_params.sname + '_benthic_clean', // DO NOT CHANGE - change in the pop up dialouge if you must
  asset_output: region_params.asset, // asset path
  local_epsg: region_params.epsg

};


// Clean up stage auto-parameterisation (DON'T TOUCH) --->

if (vars.geomorphic) {
  var temp_outname = vars.geomorph_output_name;
  if (vars.cleanup_stage == 1) {
    vars.obia_2nd_pass = false;
    vars.obia_clean = false;
    vars.fast_clean = true;
    vars.manual_clean = false;
    vars.geomorph_output_name = temp_outname + '1';
  } else if (vars.cleanup_stage == 2) {
    vars.obia_2nd_pass = true;
    vars.obia_clean = true;
    vars.fast_clean = true;
    vars.manual_clean = false;
    vars.geomorph_output_name = temp_outname + '2';
  } else if (vars.cleanup_stage == 3) {
    vars.manual_clean = true;
    vars.obia_2nd_pass = false;
    vars.obia_clean = false;
    vars.fast_clean = false;
    vars.do_export = false;
    vars.geomorph_output_name = temp_outname + '3';
  }
}

if (!vars.geomorphic) {
  var temp_outname = vars.benthic_output_name;
  if (vars.cleanup_stage == 1) {
    vars.obia_2nd_pass = true,
    vars.obia_clean = true, 
    vars.fast_clean = false, 
    vars.manual_clean = false;
    vars.benthic_output_name = temp_outname + '1';
  } else if (vars.cleanup_stage == 2) {
    vars.manual_clean = true;
    vars.obia_2nd_pass = false,
    vars.obia_clean = false, 
    vars.fast_clean = false,
    vars.do_export = false;
    vars.benthic_output_name = temp_outname + '2';
  }
}

//Region extent is created in map viewer and exported to GEE asset
var region_extent = ee.FeatureCollection(region_params.extent_mask).geometry();
Map.addLayer(region_extent, {}, "Manual reef outline", false);
// -----------------------------------------<

//################################################################################################
//START OF CLEAN 3 - Manual Cleanup
//Review everything in this section
//This is the section to add/remove manual cleanups
//You MUST review it for each region

//###############################################################################################

if (vars.manual_clean && vars.geomorphic) {
  
  print("Doing GEOMORPHIC manual clean ups - make sure this is what you want to do");
  print("Export the manual map, check 'manual' layer in the viewer for effects");
  
  var depth = ee.Image(region_params.segments).select('depth');
  var distToLand = ee.Image(region_params.distToLand);
  
  // define the manually edited map - uses the output from the second pass of cleaning
  var man_geo = ee.Image(region_params.geo_map_clean2);

  // the "GLOBAL MASK" clean
  // currently uses GCRMN extent + bathymetry threhold < vars.global_depth_thresh
  if (vars.global_extent_clean) {
    var blanket_mask = ee.Image([param_module.global_extent_mask.gcrmn]).unmask(0, false)
              .eq(1) // extent according to global extent layer
              .add(depth.lt(vars.global_depth_thresh)) // combine with areas less than depth thrshold
              .eq(0) // get leftovers
              .selfMask().connectedPixelCount(100, false).gte(100).unmask(0, false);
    
    blanket_mask = blanket_mask.where({
      test: blanket_mask.eq(0).connectedPixelCount(100,false).lt(100),
      value: ee.Image(1)
    });
    
    Map.addLayer(blanket_mask.selfMask(), {min:0,max:1}, "Global clean mask", false);
    
    if (vars.global_land_dist > 0) {
      man_geo = man_geo.where({
        test: blanket_mask.eq(1)
                          .and(distToLand.lte(vars.global_land_dist)),
        value: ee.Image(0)
      });
    } else if (vars.global_not_applied) {
      var global_not_applied_i = ee.Image().byte().paint(ee.Feature(global_not_applied, {zone: 1}), 'zone').unmask(0, false);
      man_geo = man_geo.where({
        test: blanket_mask.eq(1)
                          .and(global_not_applied_i.eq(0)),
        value: ee.Image(0)
      });
    } else {
      man_geo = man_geo.where({
        test: blanket_mask.eq(1),
        value: ee.Image(0)
      });
    }
  }
  
  /*/ the "MID MASK" CLEAN
  //  - import the mid mask from asset ****only use ee.FC if mid_mask created in map viewer****
  var mid_mask = ee.FeatureCollection(region_params.mid_mask).geometry();
  Map.addLayer(mid_mask, {color: 'red'}, "mid mask import", false, 0.4);
  
  var midmask = ee.Image().byte().paint(ee.Feature(midmask.dissolve(),{zone: 1}), "zone");

  man_geo = man_geo.where({
    test: midmask.eq(1),
    value: ee.Image(0)
  });
  */
  
  
  // the "LAGOONS MASK" CLEAN
  // - import the global lagoon mask from asset
  
  // LAGOON clean stage 1 - clean inside the lagoon extent
  var lagoons_mask = ee.FeatureCollection(region_params.lagoons_mask).filterBounds(region_extent).geometry();
  var lagoons_mask_i = ee.Image().byte().paint(ee.Feature(lagoons_mask,{zone: 1}), "zone");
  Map.addLayer(lagoons_mask, {}, "lagoon mask", false);
  
  var ocean_lagoon_mask = ee.FeatureCollection(region_params.lagoons_mask)
                                    .filterBounds(region_extent).filter(ee.Filter.neq("LagoonType", "ClosedTerrestrial"))
                                    .geometry();
  var ocean_lagoon_mask_i = ee.Image().byte().paint(ee.Feature(ocean_lagoon_mask,{zone: 1}), "zone");
  Map.addLayer(ocean_lagoon_mask, {}, "ocean lagoon mask", false);
  
  // RC within Lagoon -> ORF
  man_geo = man_geo.where({
    test: lagoons_mask_i.eq(1)
                        .and(man_geo.eq(15)),
    value: ee.Image(14)
  });
  // Reef slope, sheltered slope (within lagoon mask) -> Back Reef Slope
  man_geo = man_geo.where({
    test: lagoons_mask_i.eq(1)
                        .and(man_geo.eq(21).or(man_geo.eq(22))),
    value: ee.Image(24)
  });
  /*// Plateau within lagoon mask -> Deep
  man_geo = man_geo.where({
    test: lagoons_mask_i.eq(1)
                        .and(man_geo.eq(23)),
    value: ee.Image(2)
  });*/
  // TRF within oceanic/closed lagoons -> ORF
  man_geo = man_geo.where({
    test: ocean_lagoon_mask_i.eq(1)
                             .and(man_geo.eq(16)),
    value: ee.Image(14)
  });
  

  // LAGOON clean stage 2 - buffer the lagoon mask, and clean inside buffer
  var lagoon_buffered = lagoons_mask.buffer(1000); // buffer 1000 m wide around reef mask
  var reef_band_mask = lagoon_buffered.difference(lagoons_mask);//substract buffered lagoon mask - lagoon mask resulting in band around reef of 1000 m
  var reef_band_mask_i = ee.Image().byte().paint(ee.Feature(reef_band_mask.dissolve(),{zone: 1}), "zone");

  // BRS, DL and SL should not be present on outside of reef on within reef_band_mask_i  -> Reef Slope
  man_geo = man_geo.where({
   test: reef_band_mask_i.eq(1)
                         .and(man_geo.eq(24).or(man_geo.eq(12)).or(man_geo.eq(11))),
    value: ee.Image(22)
  });    
  // IRF or TRF on within reef_band_mask_i  -> ORF as RC would get artefacts
  man_geo = man_geo.where({
    test: reef_band_mask_i.eq(1)
                          .and(man_geo.eq(13).or(man_geo.eq(16))),
    value: ee.Image(14)
  });   
  
  
  // The 'TURBID WATER' clean
  var turbid_mask = ee.FeatureCollection(region_params.turbid_mask).filterBounds(region_extent).geometry();
  var turbid_mask_i = ee.Image().byte().paint(ee.Feature(turbid_mask,{zone: 1}), "zone");
  Map.addLayer(turbid_mask, {}, "turbid mask", false);
  
  // leave only TRF within turbid mask (after changing IRF and ORF to TRF)
  man_geo = man_geo.where({
    test: turbid_mask_i.eq(1)
                       .and((man_geo.eq(13)).or(man_geo.eq(14))),
    value: ee.Image(16)
  });
  
  man_geo = man_geo.where({
    test: turbid_mask_i.eq(1)
                       .and(man_geo.neq(16)),
    value: ee.Image(2)
  });
  
  
  // The 'HARBOUR & SHIPPING' clean
  var harbour_mask = ee.FeatureCollection(region_params.harbour_mask).filterBounds(region_extent).geometry();
  var harbour_mask_i = ee.Image().byte().paint(ee.Feature(harbour_mask,{zone: 1}), "zone");
  Map.addLayer(harbour_mask, {}, "harbour mask", false);
  
  // remove mapping within harbour mask
  man_geo = man_geo.where({
    test: harbour_mask_i.eq(1)
                        .and(man_geo.gt(2)),
    value: ee.Image(2)
  });
  
  // Remove "Rivermouth" CLEAN Adopted from v1 with adjustments of geometries for v2
  var river = ee.Image().byte().paint(ee.Feature(rivermouth, {zone: 1}), "zone");
  
  man_geo = man_geo.where({
    test: river.eq(1),
    value: ee.Image(0)
  });
  // "NOT REEF" CLEAN Adopted from v1 with adjustments of geometries for v2
  // remove
   var not_reef = ee.Image().byte().paint(ee.Feature(noreefmask, {zone: 1}), "zone");
  man_geo = man_geo.where({
    test: not_reef.eq(1),
    value: ee.Image(0)
  });
    
    // Kaneohe Bay -> Deep lagoon CLEAN Adopted from v1 with adjustments of geometries for v2
    var kaneohebay = ee.Image().byte().paint(ee.Feature(kaneohe_bay, {zone: 1}), "zone");
    man_geo = man_geo.where({
    test: kaneohebay.eq(1),
    value: ee.Image(24)
  });
  
  // Kaneohe Bay Reefs -> Outer reef flat CLEAN Adopted from v1 with adjustments of geometries for v2
  var kaneohebayreef = ee.Image().byte().paint(ee.Feature(kaneohe_bay_reef, {zone: 1}), "zone");
  man_geo = man_geo.where({
    test: kaneohebayreef.eq(1)
                     .and(man_geo.eq(16)),
    value: ee.Image(14)
  });
  
  // Deep lagoon -> Reef slope (around the reef edge) CLEAN Adopted from v1 with adjustments of geometries for v2
  var notdeeplagoon = ee.Image().byte().paint(ee.Feature(not_deep_lagoon, {zone: 1}), "zone");
  man_geo = man_geo.where({
    test: notdeeplagoon.eq(1)
                     .and(man_geo.eq(12)),
    value: ee.Image(22)
  });
  
  // Deep lagoon -> Shallow lagoon (insided the reef)
  var notDLshallowlagoon = ee.Image().byte().paint(ee.Feature(not_DL_shallow_lagoon, {zone: 1}), "zone");
  man_geo = man_geo.where({
    test: notDLshallowlagoon.eq(1)
                     .and(man_geo.eq(12)),
    value: ee.Image(11)
  });
  
    
  // TRF -> Outer reef flat CLEAN Adopted from v1 with adjustments of geometries for v2
  var TRtoORF = ee.Image().byte().paint(ee.Feature(TRF_to_ORF, {zone: 1}), "zone");
  man_geo = man_geo.where({
    test: TRtoORF.eq(1)
                     .and(man_geo.eq(16)),
    value: ee.Image(14)
  });
  
  // the 'WAVE' clean (un-comment this sectio nbased on whether you have waves or not)
  var waves = ee.Image(region_params.waves);
  Map.addLayer(waves.lt(vars.wave_height), {}, vars.wave_height + "m Hs95 threshold", false);
  
  man_geo = man_geo.where({
    test: waves.lte(vars.wave_height)
               .and(man_geo.eq(22)),
    value: ee.Image(21)
  });
 man_geo = man_geo.where({
    test: waves.gte(vars.wave_height)
               .and(man_geo.eq(21)),
    value: ee.Image(22)
  }); 
  
  // REMOVE NOISE from areas that have missing dove data, that should not have been filled 
  man_geo = man_geo.where({
    test: man_geo.eq(12) // may need to add classes here
                 .and(distToLand.unmask(8000,false).gt(1000))
                 .and(depth.unmask(0,false).eq(0)),
    value: ee.Image(0)
  });
  
  
  /*// the "DISTANCE TO DEEP WATER" CLEAN
  // use a distance to deepwater to cut out RC/slope
  var dist_to_deep = man_geo.eq(2).fastDistanceTransform(256).sqrt()
                                  .multiply(ee.Image.pixelArea().sqrt())
                                  .uint16()
                                  .selfMask();
  Map.addLayer(dist_to_deep, {}, "distance to deepwater", false);
  
  // reef crest too far from deep water -> ORF
  man_geo = man_geo.where({
    test: man_geo.eq(15)
                 .and(dist_to_deep.gte(300)),
    value: ee.Image(14)
  });
  // reef slope too far from deep wter -> BRS
  man_geo = man_geo.where({
    test: man_geo.eq(21).or(man_geo.eq(22))
                 .and(dist_to_deep.gte(1500)),
    value: ee.Image(24)
  });*/
  
  
  /*
  ##############
  
  The rest of the manual geometry paintings and rules should go here
      - make the geom, paint the layer, use it in a rule
      - consult previous regions *_cleanup script for ideas/hints/existing rules etc.
  e.g. 

  var notdeepwater = ee.Image().byte().paint(ee.Feature(not_deep_water, {zone: 1}), "zone");
  
  

  // Deep water -> Deep lagoon (inside the reef)
  man_geo = man_geo.where({
    test: notdeepwater.eq(1)
                     .and(man_geo.eq(2)),
    value: ee.Image(12)
  });
  
  ##############
  */
  
  /*// attempt to gain back missing reef crest
  var reef_crest_smooth = man_geo.eq(15).selfMask().focalMode(10);
  Map.addLayer(reef_crest_smooth, {colour: 'red'}, "reef crest smooth", false);
  //var reef_crest_holes = man_geo.gt(2).unmask(0,false).connectedComponents(ee.Kernel.plus(1), 512);
  //Map.addLayer(reef_crest_holes, {}, "reef crest holes", false);
  
  man_geo = man_geo.unmask(0, false).where({
    test: reef_crest_smooth.eq(1)
                           //.and(reef_crest_holes.select('labels').gt(1))
                           .and(man_geo.unmask(0, false).eq(0)),
    value: ee.Image(15)
  }).selfMask();*/
  
  /* START Chris taking out v1 manual
  var not_reef = ee.Image().byte().paint(ee.Feature(noreefmask, {zone: 1}), "zone");
  var river = ee.Image().byte().paint(ee.Feature(rivermouth, {zone: 1}), "zone");
  var west_extent = ee.Image().byte().paint(ee.Feature(west, {zone: 1}), "zone");
  var east_extent = ee.Image().byte().paint(ee.Feature(east, {zone: 1}), "zone");
 //CR var notreefcrest = ee.Image().byte().paint(ee.Feature(not_reef_crest, {zone: 1}), "zone");
  var kaneohebay = ee.Image().byte().paint(ee.Feature(kaneohe_bay, {zone: 1}), "zone");
  var kaneohebayreef = ee.Image().byte().paint(ee.Feature(kaneohe_bay_reef, {zone: 1}), "zone");
  var notdeepwater = ee.Image().byte().paint(ee.Feature(not_deep_water, {zone: 1}), "zone");
  //CR var backreefslope = ee.Image().byte().paint(ee.Feature(back_reef_slope, {zone: 1}), "zone");
  var reefflat = ee.Image().byte().paint(ee.Feature(reef_flat, {zone: 1}), "zone");
  var notdeeplagoon = ee.Image().byte().paint(ee.Feature(not_deep_lagoon, {zone: 1}), "zone");
  //CR var notreefslope = ee.Image().byte().paint(ee.Feature(not_reef_slope, {zone: 1}), "zone");
  //CR var notDLouterreef = ee.Image().byte().paint(ee.Feature(not_DL_outer_reef, {zone: 1}), "zone");
  var notDLshallowlagoon = ee.Image().byte().paint(ee.Feature(not_DL_shallow_lagoon, {zone: 1}), "zone");
  //CR var notRSplateau = ee.Image().byte().paint(ee.Feature(not_RS_plateau, {zone: 1}), "zone");

  // define the manually edited map - uses the output from the second pass of cleaning
  var man_geo = ee.Image(region_params.geo_map_clean2);
  
  
  // mask to deep and anything removed to this point + re-do land
  man_geo = man_geo.where({
    test: distToLand.eq(0),
    value: ee.Image(0)
  });
    
    */// END Chris taking out v1 manual
    
  man_geo = man_geo.updateMask(man_geo.gt(2)).selfMask();
  
  if (vars.geo_refinement) {
    // make the mask image layer
    var refine = ee.Image().byte().paint(ee.Feature(refinement_mask, {zone: 1}), "zone");
    // apply
    man_geo = man_geo.where({
      test: refine.eq(1),
      value: ee.Image(0)
    });
  }
  
  // Add data + the manual layer to the map
  var lowtide_image = ee.Image(region_params.pixels).select(['b1','b2','b3']);
  Map.addLayer(lowtide_image, region_params.visParams, sensor_params.sname + ' low tide', false);
  var geo_clean1 = ee.Image(region_params.geo_map_clean1);
  Map.addLayer(geo_clean1, map_palettes.geo, 'Geo clean stage 1', false);
  var geo_clean2 = ee.Image(region_params.geo_map_clean2);
  Map.addLayer(geo_clean2, map_palettes.geo, 'Geo clean stage 2', false);
  Map.addLayer(man_geo.updateMask(man_geo), map_palettes.geo, 'Geo clean stage 3', false);

  // display distance to land mask for assessing cut-off distances
  Map.addLayer(distToLand, {}, 'Distance to land mask', false);
  
  // Export
  var output_name = (vars.geomorphic) ? vars.geomorph_output_name : vars.benthic_output_name;
  Export.image.toAsset({
    image: man_geo,
    description: output_name,
    assetId: vars.asset_output + 'in_out/' + output_name,
    region: region_extent,
    scale: vars.image_data_scale,
    crs: vars.local_epsg,
    maxPixels: 1e13,
    shardSize: 256, // SWP specific cuase of size?
    pyramidingPolicy: {'.default': 'mode'}
  });
  
} 

if (vars.manual_clean && !vars.geomorphic) {
  
  print("Doing BENTHIC manual clean ups - make sure this is what you want to do");
  print("Export the manual map, check 'manual' layer in the viewer for effects");
  
  var depth = ee.Image(region_params.segments).select('depth');
  var dove_b1 = ee.Image(region_params.pixels).select('b1');
  
  // define the final geomorphic map (the manually edited geo map - stage 3)
  var geo_map = ee.Image(region_params.geo_map_clean3);
  
  // define the clean benthic map to apply 2nd stage rules to
  var man_benthic = ee.Image(region_params.benthic_map_clean1);
  
  // Deep (or land or missing) in geo == masked from benthic
  man_benthic = man_benthic.where({
    test: geo_map.unmask(0).lte(2),
    value: ee.Image(0)
  });
  
  
  /*
  ** Generic benthic rules **
    - should be generally applicable, but still review
  */
  
  // BMA on inner RF, outer RF,reef crest, reef slope -> rubble 
  man_benthic = man_benthic.where({
    test: man_benthic.eq(18)
                     .and(geo_map.eq(13).or(geo_map.eq(14)).or(geo_map.eq(15)).or(geo_map.eq(22))),
    value: ee.Image(12)
  });
  
  /*// Rubble on Outer reef flat and Reef crest -> rock 
  man_benthic = man_benthic.where({
    test: man_benthic.eq(12)
                     .and(geo_map.eq(14).or(geo_map.eq(15))),
    value: ee.Image(13)
  });*/
  // Rubble on Reef crest -> rock 
  man_benthic = man_benthic.where({
    test: man_benthic.eq(12)
                     .and(geo_map.eq(15)),
    value: ee.Image(13)
  });
  
  // Sand in benthic and reef crest in geo --> rock, Hawii less coral algae
  man_benthic = man_benthic.where({
    test: man_benthic.eq(11)
                     .and(geo_map.eq(15)),
    value: ee.Image(13)
  });
  
  // START CHRIS ADD Sand in ORF breaking waves -> Rock Chris added for ORF that should have been RC
  var SDRConORF = ee.Image().byte().paint(ee.Feature(SD_RC_on_ORF, {zone: 1}), "zone");
  man_benthic = man_benthic.where({
    test: man_benthic.eq(11)
                     .and(geo_map.eq(14))
                     .and(SDRConORF.eq(1)),
    value: ee.Image(13)
  });
  // END CHRIS ADD
  // START CHRIS ADD CA in BRS or DL in Kanoehe Bay, change to sand 
  var kbay_deep_CASD = ee.Image().byte().paint(ee.Feature(kaneohe_bay_deep_ca_sd, {zone: 1}), "zone");
  man_benthic = man_benthic.where({
    test: man_benthic.eq(15)
                     .and((geo_map.eq(12)).or(geo_map.eq(24)))
                     .and(kbay_deep_CASD.eq(1)),
    value: ee.Image(11)
  });
   // END CHRIS ADD
   
  // Seagrass on RC or ORF -> Coral/Algae
  // except for these two areas (use if there are exceptions, e.g. in Indonesia this can occur)
  //var sg_orf = ee.Image().byte().paint(ee.Feature(sg_on_orf, {zone: 1}), "zone").unmask(geo_map.eq(42));
  
  man_benthic = man_benthic.where({
    test: man_benthic.eq(14)
                     .and(geo_map.eq(14).or(geo_map.eq(15))),
                     //.and(sg_orf.eq(0)),
    value: ee.Image(15)
  });  
  
  // Rubble on slope --> rock
  man_benthic = man_benthic.where({
    test: man_benthic.eq(12)
                     .and(geo_map.eq(21).or(geo_map.eq(22))),
    value: ee.Image(13)
  });  
  
  // Sand on slope --> rubble
  man_benthic = man_benthic.where({
    test: man_benthic.eq(11)
                     .and(geo_map.eq(21).or(geo_map.eq(22))),
    value: ee.Image(12)
  });  
  
  
  /*
  ** Manual polygon guided rules **
   - same as per geomorphic clean section (add a geometry, paint the layer, create a rule)
          - OR -
  ** Region-specific clean-up rules **
  */
  
  /*// Seagrass in turbid water & TRF --> rubble
  var turbid_mask = ee.FeatureCollection(region_params.turbid_mask).filterBounds(region_extent).geometry();
  var turbid_mask_i = ee.Image().byte().paint(ee.Feature(turbid_mask,{zone: 1}), "zone");
  Map.addLayer(turbid_mask, {}, "turbid mask", false);
  
  man_benthic = man_benthic.where({
    test: turbid_mask_i.eq(1)
                       .and(man_benthic.eq(14))
                       .and(geo_map.neq(16)),
    value: ee.Image(12)
  });*/
  
  /*// Rubble on Outer reef (and dark) -> rock 
  man_benthic = man_benthic.where({
    test: man_benthic.eq(12)
                     .and(geo_map.eq(14))
                     .and(dove_b1.lt(750)),
    value: ee.Image(13)
  });*/
  
  
    
  // WEST SIDE CLEAN
    
  var west_extent = ee.Image().byte().paint(ee.Feature(west, {zone: 1}), "zone");
  var east_extent = ee.Image().byte().paint(ee.Feature(east, {zone: 1}), "zone");
  var steepslope = ee.Image().byte().paint(ee.Feature(steep_slope, {zone: 1}), "zone");
    
  // Sand or BMA on Reef slope == coral/algae (on the steeper reef slope areas)
  man_benthic = man_benthic.where({
   test: steepslope.eq(1)
                   .and(geo_map.eq(22))
                   .and(man_benthic.eq(11).or(man_benthic.eq(18))),
   value: ee.Image(15)
  });
    
  // BMA on Reef Crest == coral/algae
  man_benthic = man_benthic.where({
    test: west_extent.eq(1)
                     .and(geo_map.eq(15))
                     .and(man_benthic.eq(18)),
    value: ee.Image(15)
  });
    
  // EAST & WEST SIDE CLEAN
    
  // BMA on DW/DL/SRS/RS/plateau/BRS == sand
  man_benthic = man_benthic.where({
    test: man_benthic.eq(18)
                     .and(geo_map.eq(2).or(geo_map.eq(12)).or(geo_map.eq(21)).or(geo_map.eq(22)).or(geo_map.eq(23)).or(geo_map.eq(24))),
    value: ee.Image(11)
  });
    
  // EAST SIDE CLEAN
  /*  
  // Sand on RS and plateau == rock
  man_benthic = man_benthic.where({
    test: east_extent.eq(1)
                     .and(man_benthic.eq(11))
                     .and(geo_map.eq(14).or(geo_map.eq(22)).or(geo_map.eq(23))),
    value: ee.Image(13)
  });
  */
  
  
  // Add the manual layer to the map
  var dove_image = ee.Image(region_params.pixels).select(['b1','b2','b3']);
  Map.addLayer(dove_image, {bands: ['b3','b2','b1'], min:0, max:4000, gamma:1.5}, sensor_params.sname + ' low tide', true);
  
  var benthic_clean1 = ee.Image(region_params.benthic_map_clean1);
  var geo_clean1 = ee.Image(region_params.geo_map_clean1);
  var geo_clean2 = ee.Image(region_params.geo_map_clean2);
  Map.addLayer(geo_clean1, map_palettes.geo, 'Geo clean stage 1', false);
  Map.addLayer(geo_clean2.updateMask(geo_clean2.gt(2)), map_palettes.geo, 'Geo clean stage 2', false);
  Map.addLayer(geo_map.updateMask(geo_map.gt(2)), map_palettes.geo, 'Geo clean stage 3 - MANUAL', true);
  Map.addLayer(benthic_clean1, map_palettes.benthic, 'Benthic clean stage 1', false);
  Map.addLayer(man_benthic.reproject({crs:'EPSG:4326', scale: 5}), map_palettes.benthic, 'Benthic clean stage 2 - MANUAL', true);
  
  // Export
  var output_name = (vars.geomorphic) ? vars.geomorph_output_name : vars.benthic_output_name;
  Export.image.toAsset({
    image: man_benthic,
    description: output_name,
    assetId: vars.asset_output + 'in_out/' + output_name,
    region: region_extent,
    scale: vars.image_data_scale,
    crs: vars.local_epsg,
    maxPixels: 1e13,
    pyramidingPolicy: {'.default': 'mode'}
  });
  
}

// #################################################################################################
// END OF MANUAL SECTION
// #################################################################################################


// 2. Data loads & vis

if (!vars.manual_clean) {

  // load input data
  
  // define raw geo/benthic outputs
  // Run check to see if the region has been split into multiple areas
  
  // geo
  if (ee.List(region_params.geo_map).length().getInfo() > 1) {
    var geo_map_raw = ee.Image(region_params.geo_map[0]).unmask(0, false)
                 .add(ee.Image(region_params.geo_map[1]).unmask(0,false))
                 .selfMask();
  } else {
    var geo_map_raw = ee.Image(region_params.geo_map);
  }
  
  // benthic
  if (ee.List(region_params.benthic_map).length().getInfo() > 1) {
      var benthic_map = ee.Image(region_params.benthic_map[0]).unmask(0, false)
               .add(ee.Image(region_params.benthic_map[1]).unmask(0,false))
               .selfMask();
  } else {
      var benthic_map = ee.Image(region_params.benthic_map);
  }
  
  // set the geo map for further processing
  if (vars.geomorphic && vars.obia_2nd_pass) {
    // if it's 2nd pass, you want to make sure you're loading the latest geo clean map
    var geo_map = ee.Image(region_params.geo_map_clean1);
  } else if (vars.geomorphic) {
    var geo_map = geo_map_raw;
  }
  
  var depth = ee.Image(region_params.segments).select('depth');
  var image = ee.Image(region_params.pixels).select('b3','b2','b1');
  
  var display_pal = (vars.geomorphic) ? map_palettes.geo : map_palettes.benthic;
  Map.addLayer(depth, {min:0, max:2500}, 'Depth data', false);
  Map.addLayer(image, {bands: ['b3','b2','b1'], min:200, max:1200}, 'Dove low tide', false);
  
  // load for display purposes
  if (vars.geomorphic) {
    Map.addLayer(geo_map_raw, display_pal, 'Geomorphic map RAW', false);
    if (vars.cleanup_stage == 2) Map.addLayer(ee.Image(region_params.geo_map_clean1), display_pal, 'Geomorphic map - stage 1 clean', false);
  }
  if (!vars.geomorphic) {
    // Use the manually cleaned geomorphic map as input for the benthic clean
    var geo_map = ee.Image(region_params.geo_map_clean3);
    if (!vars.manual_clean) Map.addLayer(geo_map, map_palettes.geo, 'Final geo map (manual clean - stage 3)', false);
    Map.addLayer(benthic_map, display_pal, 'Benthic map RAW', false);
  }
  
    // 3. Object-based re-classificaiton and cleaning
    
    /* OUTPUT EXTENT
      - to the mapping extent just so it doesn't balloon out
      - to the 'reef boundary' extent for noise/deep removal
    */  
    var class_extent_mask = geo_map.gt(0);
    
    /*
    
    ########
    Initial small object clean
     - this was originally at the end, but we needed to massively reduce the number of objects to 
       iterate through in the OBIA cleaning, so this happens first now
     - future collabs with google might fix this, but need to change the parallel serialisation of vector procesing
     
     - includes a possible special case for:
          - geomorphic to clean up turbid areas over size threshold; fix shallow vs. deep lagoon
          - benthic to allow breaking waves (temporal class) to grow into surrounding class
    ########
    
    */
    
    // ##############################################################################################
    // START OF CLEAN 1
    // ##############################################################################################
    
    if (vars.geomorphic && !vars.obia_2nd_pass) {
      
      // deep water in depth data == deep (s2 + ls8 data should be good enough for this)
      clean_map = geo_map.where({
        test: depth.gt(vars.geo_depth_cutoff),
        value: ee.Image(2)
      });
      
      // shallow lagoon > 5m == deep lagoon
      clean_map = clean_map.where({
        test: clean_map.eq(11)
                      .and(depth.gt(vars.shallowlag_depth_cutoff)),
        value: ee.Image(12)
      });
      
      // the "LAND MASK" CLEAN
      var distToLand = ee.Image(region_params.distToLand);
      
      // display distance to land mask for assessing cut-off distances
      Map.addLayer(distToLand.unmask(8000, false).lte(vars.dist_to_land_RC).selfMask(), {}, 'RC to TRF ' + vars.dist_to_land_RC + 'm', false);
      Map.addLayer(distToLand.unmask(8000, false).gte(vars.dist_to_land_ORF).selfMask(), {}, 'TRF to ORF ' + vars.dist_to_land_ORF + 'm', false);
      // only apply RC distance rules to non-terrestrial lagoons
      var ocean_lagoon_mask = ee.FeatureCollection(region_params.lagoons_mask)
                                    .filter(ee.Filter.eq("MappingReg", vars.lagoon_region))
                                    .filter(ee.Filter.neq("LagoonType", "ClosedTerrestrial"))
                                    .geometry().buffer(1000);
      // add in manual areas for not applying land distance rules 
      var skip_rc_dist = ee.FeatureCollection(ocean_lagoon_mask).merge(SD_RU).geometry().dissolve();
      var skip_rc_dist_i = ee.Image().byte().paint(ee.Feature(skip_rc_dist,{zone: 1}), "zone").unmask(0, false);
      Map.addLayer(skip_rc_dist_i, {min:0,max:1}, "Skip RC landDist rule", false);
      
      
      // reef crest close to land -> TRF (check if needed or not)
      clean_map = clean_map.where({
        test: clean_map.eq(15)
                       .and(distToLand.unmask(8000, false).lte(vars.dist_to_land_RC))
                       .and(skip_rc_dist_i.eq(0)),
        value: ee.Image(16)
      });
      
      // TRF outside of specified distance from land -> ORF
      clean_map = clean_map.where({
        test: clean_map.eq(16)
                       .and(distToLand.unmask(8000, false).gt(vars.dist_to_land_ORF)),
        value: ee.Image(14)
      });
      
      // mask out land areas
      clean_map = clean_map.updateMask(distToLand.unmask(8000, false));
      
      
      // the "DISTANCE TO DEEP WATER" CLEAN
      // use a distance to deepwater to cut out RC/slope
      var dist_to_deep = clean_map.eq(2).or(clean_map.eq(22))
                                  .fastDistanceTransform(50).sqrt()
                                  .multiply(ee.Image.pixelArea().sqrt())
                                  .uint8()
                                  //.selfMask();
      Map.addLayer(dist_to_deep, {}, "distance to deepwater", false);
  
      // reef crest too far from deep water -> ORF
      clean_map = clean_map.where({
        test: clean_map.eq(15)
                       .and(dist_to_deep.gte(250)),
        value: ee.Image(14)
      });
      
    }
    
    if (!vars.geomorphic && vars.cleanup_stage == 1) {
      // BENTHIC CLEAN 1 rules (pre-manual)
      
      // make a smooth map with masked area as a value, and without temporal class (basically breaking waves)
      var smooth_map = benthic_map
                        .focal_mode({
                          radius: vars.smooth_radius, // relates to smoothness required
                          kernelType: 'circle', units: 'pixels', iterations: 1
                        });
    
      // replace small objects with smooth underneath
      var clean_map = benthic_map.where({
        test: benthic_map.connectedPixelCount(vars.small_object_benthic, false).lt(vars.small_object_benthic),
        value: smooth_map
      }).updateMask(class_extent_mask);
      
      // replace small missing 
      var clean_map = benthic_map.unmask(0, false).where({
        test: geo_map.gt(2),
        value: smooth_map
      }).selfMask();
      
      // Deep (or land or missing) in geo == masked from benthic
      clean_map = clean_map.where({
        test: geo_map.unmask(0).lte(2),
        value: ee.Image(0)
      });
        
      // cut benthic off to < 10 - 15 m
      clean_map = clean_map.where({
        test: depth.gt(vars.benthic_depth_cutoff),
        value: ee.Image(0)
      });
     
     
     
      // #####################
      // special case for SWP, remap separate coral (16) & algae (17) classes back to coral/algae (15)
      clean_map = clean_map.where({
        test: clean_map.eq(16), 
        value: ee.Image(15)
      });
      clean_map = clean_map.where({
        test: clean_map.eq(17), 
        value: ee.Image(15)
      });
    
    }
  
  
  // ##############################################################################################
  // START OF CLEAN 2
  // ##############################################################################################
  
  if (vars.geomorphic && vars.obia_2nd_pass) {
    var clean_map = geo_map;
  }
  
  if (vars.obia_clean) {
    
    if (vars.geomorphic && !vars.fast_clean) { 
      
      // FUNCTION that maps over feature colleciton and assigns neighbour percentages
      var set_neighbour_properties = function(f) {
        // make the 1px buffer
        var diff = f.buffer(vars.image_data_scale).difference(f, ee.ErrorMargin(0.5));
        // reduce the classes in the buffer zone
        var diff_classes = ee.Dictionary(
          clean_map.unmask(ee.Image(0)).reduceRegion({
            reducer: ee.Reducer.frequencyHistogram(),
            geometry: diff.geometry(),
            scale: vars.image_data_scale,
            maxPixels: 1e11
          }).get('classification')
        );
        // calculate the percentages
        var diff_sum = diff_classes.toArray().reduce(ee.Reducer.sum(), [0]).get([0]);
        var diff_percs = diff_classes.map(function(k,v){return(ee.Number(v).divide(diff_sum).multiply(100).toUint8())});
        
        /* NOW, we can try to do the class logic right here (see /users/mitchest/global_reefs/obia_dev),
           or we can return the neighbour % and do image logic via (painted) rasters */
        
        return(f.set(diff_percs));
      };
      
      // FUNCTION to reduce the map to vectors and map the neighbour properties function
      var reduce_neighbours = function() {
        // reduce map to vectors
        var map_fc = clean_map
              .updateMask(segment_id).updateMask(clean_map.eq(classn)) // only vectorise class/es of interest
              .reduceToVectors({
                scale: vars.image_data_scale, 
                eightConnected: false,
                bestEffort: true, 
                maxPixels: 1e13,
                tileScale: 1,
                geometry: region_extent
              });
        // map the function, calculate neighbour properties
        return(map_fc.map(set_neighbour_properties));
      };
      
      // first make a make size threshold, so we're not vecortising huge objects when we don't have to
      var segment_id = clean_map.connectedComponents(ee.Kernel.plus(1),vars.small_object_geo.sqrt()).select('labels');
      //Map.addLayer(segment_id.reproject(ee.Projection('EPSG:4326').atScale(ee.Number(vars.image_data_scale))))
      Map.addLayer(clean_map.updateMask(segment_id).reproject(ee.Projection('EPSG:4326').atScale(ee.Number(vars.image_data_scale))), display_pal, 'Map objects to be iterated through (OBIA)', false);
      
      // This is where we select the single or group of classes to vectorise for cleaning up
      //var classn = ee.Number(15) // one class
      var classn = clean_map.where({
        test: clean_map.neq(16) //TRF
                .and(clean_map.neq(15)) //RR
                .and(clean_map.neq(14)) //ORF
                .and(clean_map.neq(13)) //IRF
                //.and(clean_map.neq(12)) // deep L
                .and(clean_map.neq(11)), // shallow L 
        value: ee.Image(99) // 99 ensures it's ignored in logic
      });
      
      // Minimum size of object to reclass based on neighbourhood
      var max_size = ee.Number(1000).divide(vars.image_data_scale).pow(2); // the first number is the square dimension of the desired min size;
      // calculate neighbours
      var map_fc_neighbours = reduce_neighbours();
      
      // #########
      // REEF RIM
      // #########
      
      var focus_class = ee.Number(15); //RR
      
      // start the object-based neighbourhood rules
      // paint out to rasters (only paint the layers needed)
      var objsize = ee.Image(30000).paint(map_fc_neighbours, 'count').rename('count');
      //var nb24 = ee.Image().byte().paint(map_fc_neighbours, '24').unmask(0).rename('nb24') //OCL
      var nb22 = ee.Image().byte().paint(map_fc_neighbours, '22').unmask(0).rename('nb22'); //SL ex
      var nb21 = ee.Image().byte().paint(map_fc_neighbours, '21').unmask(0).rename('nb21'); //Sl sh
      var nb16 = ee.Image().byte().paint(map_fc_neighbours, '16').unmask(0).rename('nb16'); //TRF
      var nb15 = ee.Image().byte().paint(map_fc_neighbours, '15').unmask(0).rename('nb15'); //RR
      var nb14 = ee.Image().byte().paint(map_fc_neighbours, '14').unmask(0).rename('nb14'); //ORF
      var nb13 = ee.Image().byte().paint(map_fc_neighbours, '13').unmask(0).rename('nb13'); //IRF
      //var nb3 = ee.Image().byte().paint(map_fc_neighbours, '3').unmask(0).rename('nb3') //Turbid
      
      // RR surrounded by ORF --> ORF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb14.gt(75)),
        value: ee.Image(14)
      });
      
      // RR surrounded by IRF --> IRF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb13.gt(75)),
        value: ee.Image(13)
      });
      
      // RR surrounded by IRF + ORF --> IRF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb13.add(nb14).gt(75)),
        value: ee.Image(13)
      });
      
      // RR with decent border to TRF --> TRF (often dark, probably seagrass)
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb16.gt(40)),
        value: ee.Image(16)
      });
      
      // RR surrounded by OCL --> OCL
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb24.gt(75)),
        value: ee.Image(24)
      })
      
      // small RR objects touching OCL + stuff --> ORF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(objsize.lte(max_size))
                .and(nb13.lte(75).and(nb14.lte(75))) // to ensure we're no re-writing previous rules
                .and(nb24.gt(1)),
        value: ee.Image(14)
      })
      
      // ####
      // ORF
      // ####
      
      focus_class = ee.Number(14); // ORF
      
      // ORF surrounded by IRF --> IRF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb13.gt(75)),
        value: ee.Image(13)
      });
      
      // ORF surrounded by TRF --> TRF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb16.gt(75)),
        value: ee.Image(16)
      });
      
      // ORF surrounded by RR --> RR
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb15.gt(85)),
        value: ee.Image(15)
      });
      
      // ORF touching slope and RR --> RR
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb21.gt(0).or(nb22.gt(0)))
                .and(nb15.gt(0)),
        value: ee.Image(15)
      });
      
      // ####
      // IRF
      // ####
      
      focus_class = ee.Number(13); // IRF
      
      // IRF surrounded by ORF --> ORF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb14.gt(75)),
        value: ee.Image(14)
      });
      
      // IRF surrounded by TRF --> TRF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb16.gt(75)),
        value: ee.Image(16)
      });
      
      // IRF surrounded by RR --> RR
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb15.gt(85)),
        value: ee.Image(15)
      });
      
      // ####
      // TRF
      // ####
      
      focus_class = ee.Number(16); // TRF
      
      // TRF surrounded by ORF --> ORF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb14.gt(75)),
        value: ee.Image(14)
      });
      
      // TRF surrounded by IRF --> IRF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb13.gt(75)),
        value: ee.Image(13)
      });
      
      // TRF surrounded by IRF + ORF --> IRF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb13.add(nb14).gt(75)),
        value: ee.Image(13)
      });
      
      // ####
      // LAGOONS
      // ####
      
      var nb11 = ee.Image().byte().paint(map_fc_neighbours, '11').unmask(0).rename('nb11'); // shallow lag
      
      // SL sourrounded by DL --> DL
      clean_map = clean_map.where({
        test: clean_map.eq(11)
                .and(nb12.gt(75)),
        value: ee.Image(12)
      })
      
      // DL sourrounded by SL --> SL
      clean_map = clean_map.where({
        test: clean_map.eq(12)
                .and(nb11.gt(75)),
        value: ee.Image(11)
      })
      
      // DL/SL surrounded by IRF --> IRF
      clean_map = clean_map.where({
        test: clean_map.eq(11).or(clean_map.eq(12))
                .and(objsize.lte(max_size))
                .and(nb13.gt(80)),
        value: ee.Image(13)
      })
      
      // SL surrounded by IRF --> IRF
      clean_map = clean_map.where({
        test: clean_map.eq(11)
                .and(objsize.lte(max_size))
                .and(nb13.gt(80)),
        value: ee.Image(13)
      });
      
    
    } else if (vars.geomorphic && vars.fast_clean) {
      print("Executing the fast version OBIA");
      
      /* fast version of the geo clean up
        - blanket version assigns the underlying most common in neighbourhood
        - mode OBIA version iterates through objects+buffers but take the mode instead of doing the class percs, to see if that speeds things up
      */
      
      
      // ## Blanket version
      
      // make a very smooth map to capture the broader neighbourhood  - *** Change to ee.kernal*** see reef mask in clean 3
      var smooth_map = clean_map
                          .focal_mode({
                            radius: vars.smooth_radius.multiply(3), // relates to smoothness required
                            kernelType: 'circle', units: 'pixels', iterations: 2
                          });
      
      // first make a make size threshold, so we're not vectorising huge objects when we don't have t
      // - the unmask(99) captures small no data values/ data gaps
      var segment_id = clean_map.unmask(0).connectedComponents(ee.Kernel.plus(1),vars.small_object_geo.sqrt().multiply(2)).select('labels').pow(2).log().int();
      Map.addLayer(clean_map.unmask(0).updateMask(segment_id.gt(0)).reproject(ee.Projection('EPSG:4326').atScale(ee.Number(vars.image_data_scale))), display_pal, 'Map objects to be iterated through (OBIA)', false);
      
      // replace small objects with smooth underneath
      var clean_map = clean_map.unmask(0).where({
        test: segment_id.gt(0), 
        value: smooth_map
      }).selfMask();
      
      // get rid of patch reef
      geo_map = geo_map.where({
        test: geo_map.eq(25),
        value: smooth_map
      });
      
      // ## mode OBIA version
      
      /* A possible faster plan
            - vectorise one/few class/es at a time, thus only spending resources on what is actually needed to clean up
            - BUT, just assign the mode of the neighbours, so save resouces even further??
      
      // FUNCTION that maps over feature colleciton and assigns neighbour percentages
      var set_neighbour_mode = function(f) {
        // make the 1px buffer
        var diff = f.buffer(vars.image_data_scale).difference(f, ee.ErrorMargin(0.5))
        // reduce the classes in the buffer zone
        var diff_mode = ee.Number(ee.Dictionary(
          clean_map.unmask(ee.Image(0)).reduceRegion({
            reducer: ee.Reducer.mode(),
            geometry: diff.geometry(),
            scale: vars.image_data_scale,
            maxPixels: 1e11
          })).get('classification'))
        
        return(f.set('mode',diff_mode))
      }
      
      // FUNCTION to reduce the map to vectors and map the neighbour properties function
      var reduce_neighbours_mode = function() {
        // reduce map to vectors
        var map_fc = clean_map.unmask(0)
              .updateMask(classn.gt(0)) // only vectorise class/es of interest
              .reduceToVectors({
                scale: vars.image_data_scale, 
                eightConnected: false,
                bestEffort: true, 
                maxPixels: 1e13,
                tileScale: 1,
                geometry: region_extent
              })
        // map the function, calculate neighbour properties
        return(map_fc.map(set_neighbour_mode))
      }
      
      // first make a make size threshold, so we're not vecortising huge objects when we don't have to
      var segment_id = clean_map.unmask(0).connectedComponents(ee.Kernel.plus(1),vars.small_object_geo.sqrt()).select('labels')
      Map.addLayer(clean_map.unmask(0).updateMask(segment_id.gt(0)).reproject(ee.Projection('EPSG:4326').atScale(ee.Number(vars.image_data_scale))), display_pal, 'Map objects to be iterated through (OBIA)', false)
      
      // This is where we select the single or group of classes to vectorise for cleaning up
      var classn = segment_id.where({
        test: clean_map.neq(16) //TRF
                .and(clean_map.neq(15)) //RR
                .and(clean_map.neq(14)) //ORF
                .and(clean_map.neq(13)) //IRF
                //.and(clean_map.neq(12)) // deep L
                .and(clean_map.neq(11)) // shallow L 
                .and(clean_map.unmask(0).neq(0)), // no data values (want to reclaim the small gaps 
        value: ee.Image(0) // 99 ensures it's ignored in logic
      })
      
      // calculate neighbours
      var map_fc_neighbours = reduce_neighbours_mode()
      
      //print(map_fc_neighbours.limit(10))
      
      var mode_map = ee.Image().byte().paint(map_fc_neighbours, 'mode').unmask(0).rename('mode') // paint out the mode values to an image
      //Map.addLayer(mode_map, display_pal, "mode map", false)
      
      // replace small objects with mode underneath
      var clean_map = clean_map.unmask(0).where({
        test: segment_id.gt(0), 
        value: mode_map
      }).selfMask()
      
      */
      
    }
  }
  
  // Final clip to the classified extent and move on
  if (vars.geomorphic) {
    clean_map = clean_map.updateMask(clean_map.gt(1)); // this ignores 0/land; make it .gt(2) if you want to mask deep too
  } else {
    clean_map = clean_map.updateMask(clean_map.gt(1)); // this ignores 0/land; make it .gt(2) if you want to mask deep too
  }
  
  
  // 4. Export data
  
  var output_name = (vars.geomorphic) ? vars.geomorph_output_name : vars.benthic_output_name;
  
  if (vars.do_export) {
    print("For export, the image data scale must be set to:", vars.image_data_scale);
    
    Map.addLayer(region_extent, {}, "Export footprint", false);
    
    Export.image.toAsset({
      image: clean_map.set(vars),
      description: output_name,
      assetId: vars.asset_output + 'in_out/' + output_name,
      region: region_extent,
      scale: vars.image_data_scale,
      crs: vars.local_epsg,
      maxPixels: 1e13,
      pyramidingPolicy: {'.default': 'mode'}
    });
    
  } else {
    if (vars.reproject_display) {
      Map.addLayer(clean_map.reproject(ee.Projection('EPSG:4326').atScale(vars.image_data_scale)), display_pal, output_name, true);
    } else {
      Map.addLayer(clean_map, display_pal, output_name, false);
    }
  }

}

//Generate title
var title = ui.Label({
  value: 'Classes',
  style: {fontWeight: 'bold', fontSize: '12px'}
});

// generate the legend
var geo_legend = pkg_vis.discrete_legend(map_palettes.geo_atlas_names, map_palettes.geo_atlas_cols, 'Geomorphic Zone', false);
var benthic_legend = pkg_vis.discrete_legend(map_palettes.benthic_atlas_names, map_palettes.benthic_atlas_cols, 'Benthic Habitat', false);
//var mask_legend = pkg_vis.discrete_legend(["Low confidence depth","Water conditions"], ["#f7f7f7","#bababa"], 'Confidence Mask reason', false)
var legend = (vars.geomorphic) ? geo_legend : benthic_legend;
pkg_vis.add_lgds([title, legend]);//, mask_legend])
// generate the legend