/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var eg_area = /* color: #d63000 */ee.Geometry.Polygon(
        [[[178.11792537642418, -19.163235696114032],
          [178.11912700606285, -19.160641289483575],
          [178.1160371012777, -19.1590197646103],
          [178.1149213023275, -19.161452045940777]]]),
    export_small = 
    /* color: #d63000 */
    /* shown: false */
    /* displayProperties: [
      {
        "type": "rectangle"
      }
    ] */
    ee.Geometry.Polygon(
        [[[179.95512054878452, -16.51030303799518],
          [179.95512054878452, -16.56691147805663],
          [180.05640076118686, -16.56691147805663],
          [180.05640076118686, -16.51030303799518]]], null, false),
    soa_extent = 
    /* color: #d63000 */
    /* shown: false */
    /* displayProperties: [
      {
        "type": "rectangle"
      }
    ] */
    ee.Geometry.Polygon(
        [[[75.45116565958854, 11.212962704552769],
          [75.45116565958854, 4.907150775723321],
          [84.52587269083854, 4.907150775723321],
          [84.52587269083854, 11.212962704552769]]], null, false),
    land_dist = ee.Image("projects/coral_atlas/global_datasets/mod44w6_global_distToLand"),
    trf_to_rc = 
    /* color: #d63000 */
    /* shown: false */
    ee.Geometry.MultiPolygon(
        [[[[179.36986549251998, -18.071890049428163],
           [179.36729057186568, -18.07352197168958],
           [179.3705521380278, -18.08070224942271],
           [179.37278373592818, -18.093267028530427],
           [179.3683205401274, -18.10436244860061],
           [179.36179740780318, -18.118230735863353],
           [179.35098274105513, -18.13177165068772],
           [179.3466912066313, -18.136665699465752],
           [179.3518410479399, -18.14009145214032],
           [179.37003715389693, -18.116599229645086],
           [179.3789635454985, -18.092287987166024]]],
         [[[179.29446042132824, -17.92593261034595],
           [179.29943860125988, -17.92315601073556],
           [179.3037301356837, -17.921849360565172],
           [179.31085408282726, -17.922339355508477],
           [179.3205529506251, -17.93360886508237],
           [179.32364285541027, -17.94610248280564],
           [179.3305093104884, -17.953696211497995],
           [179.33239758563488, -17.96447384713343],
           [179.3370324428126, -17.97443441074447],
           [179.33823407245129, -17.973454708081082],
           [179.33214009356945, -17.950021867359435],
           [179.32982266498058, -17.940304900603877],
           [179.32158291888683, -17.92821918910709],
           [179.31016743731945, -17.91678600013307],
           [179.29909527850597, -17.918419358016987],
           [179.29265797687023, -17.923890997221005]]],
         [[[179.45827660156988, -17.837230802203596],
           [179.44969353272222, -17.829713796938147],
           [179.4486635644605, -17.815659414545834],
           [179.46273979737066, -17.79833504675384],
           [179.46857628418707, -17.784932023500925],
           [179.4589632470777, -17.773489622467444],
           [179.41810783936285, -17.726731634660265],
           [179.40677818848394, -17.732290916113918],
           [179.4150179345777, -17.742427985299347],
           [179.43561729981207, -17.765316030343882],
           [179.45106682373785, -17.777249349346835],
           [179.45655998780035, -17.78689350437935],
           [179.44729027344488, -17.794902661034683],
           [179.43887886597417, -17.806834003460747],
           [179.44042381836675, -17.82775278686881],
           [179.45209679199957, -17.84147940394883],
           [179.45793327881597, -17.84311345454474]]],
         [[[179.1245384000997, -17.765528168813464],
           [179.12728498213096, -17.778442257799185],
           [179.1330356382589, -17.797893364128107],
           [179.14170453779502, -17.81325660523809],
           [179.15260503523155, -17.81456405401871],
           [179.16977117292686, -17.812276012361345],
           [179.1794700407247, -17.803123552186804],
           [179.18625066511436, -17.78955743512865],
           [179.18401906721397, -17.777706670196114],
           [179.17114446394248, -17.765855119284744],
           [179.16968534223838, -17.764220360950713],
           [179.1663379453878, -17.765773381722965],
           [179.17131612531944, -17.76928806314023],
           [179.18041417829795, -17.779831692787383],
           [179.1817016386251, -17.78898534729817],
           [179.17157361738487, -17.80181601954351],
           [179.16650960676475, -17.808108432481035],
           [179.16015813581748, -17.811050263682592],
           [179.1531200193624, -17.811131980523285],
           [179.1458244108419, -17.811131980523285],
           [179.1435928129415, -17.809252483714218],
           [179.14024541609092, -17.80148913488558],
           [179.13612554304405, -17.795932004088584],
           [179.1344089292745, -17.78988434163746],
           [179.1319198393087, -17.780403809936193],
           [179.12882993452354, -17.77394695293761],
           [179.12625501386924, -17.7646290519352]]],
         [[[177.88589804613295, -18.290381872706714],
           [177.88658469164076, -18.295434449713685],
           [177.90460913622084, -18.291522790066573],
           [177.91233389818373, -18.29478251257026],
           [177.9157671257228, -18.291196814444323],
           [177.9080423637599, -18.286633091368802],
           [177.88967459642592, -18.28972991655808]]],
         [[[178.4376093556064, -19.060479248012197],
           [178.4424158741611, -19.060560372961113],
           [178.44842402235446, -19.05885674069992],
           [178.45022646681247, -19.05553055108632],
           [178.45589129225192, -19.051960907547272],
           [178.46284357801852, -19.05123074372492],
           [178.46713511244235, -19.04839118720381],
           [178.46481768385348, -19.04457799201276],
           [178.46018282667575, -19.045308185108023],
           [178.45468966261325, -19.047093088038864],
           [178.4464499165195, -19.05350235395279],
           [178.44404665724215, -19.05447589167163],
           [178.44044176832614, -19.055124913643446],
           [178.4376093556064, -19.058045481091124]]],
         [[[178.3262007135199, -19.06770013576685],
           [178.32817481935487, -19.068430227079553],
           [178.3427660363959, -19.07208063540454],
           [178.38035987794862, -19.073135182840474],
           [178.3819048303412, -19.069079194435634],
           [178.3716909784125, -19.068430227079553],
           [178.35907386720643, -19.068754711075204],
           [178.34920333803163, -19.067619014311386],
           [178.33547042787538, -19.064536369587753],
           [178.32645820558534, -19.0646174925517]]],
         [[[177.9965495260714, -19.171743577147854],
           [178.02624694428428, -19.172878558625765],
           [178.02933684906944, -19.15990687597673],
           [178.04392806611045, -19.174175670742404],
           [178.05233947358116, -19.171419295289784],
           [178.06693069062217, -19.18130960484462],
           [178.07877532563194, -19.172229998738455],
           [178.0909632833956, -19.191361442069788],
           [178.104181209421, -19.18941597307992],
           [178.1180857809542, -19.174662085153617],
           [178.1349085958956, -19.16444708101208],
           [178.1613444479464, -19.166068552510506],
           [178.19293014130577, -19.144988179412604],
           [178.19653503022178, -19.13687962642478],
           [178.2023715170382, -19.138014847818877],
           [178.2059764059542, -19.13671745130276],
           [178.2059764059542, -19.13233866280219],
           [178.19807998261436, -19.129905952357674],
           [178.1869219931124, -19.14158263566945],
           [178.1730174215792, -19.152772015507786],
           [178.1623744162081, -19.159096111922363],
           [178.15602294526084, -19.16152839212671],
           [178.13508025727256, -19.15893395863316],
           [178.1313037069796, -19.160393332495982],
           [178.12752715668663, -19.16428493298508],
           [178.12237731537803, -19.16736571822589],
           [178.11654082856163, -19.169797876427925],
           [178.11242095551475, -19.17433780903902],
           [178.11070434174522, -19.178391214597966],
           [178.10555450043663, -19.18130960484462],
           [178.1016062887667, -19.183255169615013],
           [178.09662810883506, -19.18763260630937],
           [178.09491149506553, -19.18471432810952],
           [178.09405318818077, -19.181958128988423],
           [178.09147826752647, -19.177256271094127],
           [178.08529845795616, -19.171095012793625],
           [178.08186518186477, -19.165987518615356],
           [178.0767153891085, -19.16736571822589],
           [178.06916228852256, -19.173202837612173],
           [178.05577270112022, -19.165257818754863],
           [178.05079452118858, -19.16590640607835],
           [178.04753295502647, -19.167041427754015],
           [178.04495803437217, -19.16639284489631],
           [178.04135314545616, -19.16460922887961],
           [178.03723327240928, -19.15877180518452],
           [178.03071014008506, -19.154717917153263],
           [178.02521697602256, -19.15877180518452],
           [178.02229873261436, -19.16623069878315],
           [178.01972381196006, -19.166554990849995],
           [178.0137156637667, -19.165419965824963],
           [178.00684920868858, -19.16460922887961],
           [177.99929610810264, -19.165257818754863],
           [177.9939746054171, -19.167527863222563]]],
         [[[-179.11989031880796, -17.292816963607127],
           [-179.12916003316343, -17.28986670482599],
           [-179.14272128194273, -17.289702800173792],
           [-179.15937243550718, -17.289047180105566],
           [-179.16898547261655, -17.27855694149665],
           [-179.17585192769468, -17.26757433283162],
           [-179.17516528218687, -17.253804167602713],
           [-179.16898547261655, -17.240524820464266],
           [-179.16211901753843, -17.234130720026315],
           [-179.15611086934507, -17.235278395381382],
           [-179.15147601216734, -17.237901626555004],
           [-179.14769946187437, -17.242820084562542],
           [-179.14306460469663, -17.24741052714283],
           [-179.13860140889585, -17.24741052714283],
           [-179.13722811788023, -17.242984030906175],
           [-179.15147601216734, -17.23003182126099],
           [-179.1633206471771, -17.228392236290315],
           [-179.16967211812437, -17.234786535388167],
           [-179.174650298056, -17.242820084562542],
           [-179.18031512349546, -17.25560746203211],
           [-179.17877017110285, -17.268066105426488],
           [-179.17705355733335, -17.275770371425327],
           [-179.16606722920835, -17.29035841790685],
           [-179.15593920796812, -17.29461987624718],
           [-179.13156329244077, -17.29412817455162],
           [-179.12349520772398, -17.295439376153436]]],
         [[[-179.02873812764585, -17.316089568537606],
           [-179.00934039205015, -17.328380248329207],
           [-178.99354754537046, -17.36147905331728],
           [-178.95114718526304, -17.36688571613481],
           [-178.91012011617124, -17.378353866591706],
           [-178.8993054494232, -17.390476558830798],
           [-178.87063799947202, -17.39719283981964],
           [-178.87098132222593, -17.392769950799643],
           [-178.89501391499937, -17.386053507414704],
           [-178.8989621266693, -17.379664466626334],
           [-178.90788851827085, -17.3739305222092],
           [-178.93432437032163, -17.363445130982033],
           [-178.97964297383726, -17.357710678837964],
           [-178.98650942891538, -17.354597615399456],
           [-178.9933758839935, -17.339850807347492],
           [-179.00934039205015, -17.319531041763682],
           [-179.0204983815521, -17.31199249257116]]],
         [[[-179.01311694234312, -17.26388140511586],
           [-179.01397524922788, -17.26896309380087],
           [-179.01655016988218, -17.282732126596148],
           [-179.03096972554624, -17.295680634771298],
           [-179.03611956685484, -17.305678226593404],
           [-179.03611956685484, -17.31321703474592],
           [-179.0307980641693, -17.313708685408578],
           [-179.03062640279234, -17.310103216677902],
           [-179.02616320699155, -17.30059755111135],
           [-179.01672183125913, -17.293713831443664],
           [-179.01260195821226, -17.28601031603352],
           [-179.01122866719663, -17.27765081764139],
           [-179.00607882588804, -17.27011055250177],
           [-179.00607882588804, -17.26371747734211],
           [-179.0117436513275, -17.25814384631866]]],
         [[[-178.77396733599824, -18.26114812400987],
           [-178.7883868916623, -18.26114812400987],
           [-178.80495221453828, -18.265875529358755],
           [-178.8150802357785, -18.242481766564886],
           [-178.8191142781369, -18.24566089488234],
           [-178.81542355853242, -18.25585001679535],
           [-178.8132777913205, -18.26106661589233],
           [-178.81568105059785, -18.264326910749265],
           [-178.81310612994355, -18.270439798576305],
           [-178.80623967486542, -18.273781419569534],
           [-178.7883868916623, -18.265549505536374],
           [-178.7865844472043, -18.26506046865475],
           [-178.7767139180295, -18.26391937724023]]],
         [[[-178.83376073467105, -17.65049218777787],
           [-178.8277525864777, -17.650001446457388],
           [-178.81882619487612, -17.651146507458094],
           [-178.81144475566714, -17.65474522319575],
           [-178.8013167344269, -17.661124587923737],
           [-178.79170369731753, -17.678462231298937],
           [-178.79084539043276, -17.69040133431178],
           [-178.79668187724917, -17.702993774878063],
           [-178.8097281418976, -17.706100864618097],
           [-178.8236327134308, -17.70315730725795],
           [-178.8255209885773, -17.69596174161752],
           [-178.83255910503237, -17.688602342153462],
           [-178.8390822373566, -17.677971566262787],
           [-178.84114217388003, -17.676826675970375],
           [-178.84182881938784, -17.687784612489807],
           [-178.83307408916323, -17.70086784038211],
           [-178.8291258774933, -17.70626439416702],
           [-178.8203711472687, -17.709044373699353],
           [-178.79633855449526, -17.709534953851957],
           [-178.78552388774722, -17.69694297209477],
           [-178.78260564433901, -17.685004303794674],
           [-178.7874121628937, -17.671429237822817],
           [-178.8006300889191, -17.654908799474644],
           [-178.8167662583527, -17.647874885281503],
           [-178.82723760234683, -17.646402635911443],
           [-178.8342757188019, -17.648365632397084]]],
         [[[-178.72815802004914, -17.515245595217802],
           [-178.73004629519562, -17.523757932067568],
           [-178.7206049194632, -17.537998833429583],
           [-178.71425344851593, -17.54094508719217],
           [-178.70807363894562, -17.539471966296276],
           [-178.70755865481476, -17.536689371943712],
           [-178.71940328982453, -17.53308830409632],
           [-178.7257547607718, -17.52834133268188],
           [-178.72626974490265, -17.515409297767963]]],
         [[[168.4762438377859, -17.501144523639347],
           [168.48379693837182, -17.50638333879209],
           [168.4911783775808, -17.503763950098907],
           [168.50637040944116, -17.491321338143393],
           [168.50714288563745, -17.480105885844353],
           [168.5036238274099, -17.48067895491605],
           [168.50233636708276, -17.484526657646537],
           [168.50079141469018, -17.48886545882796],
           [168.49752984852807, -17.49148506225166],
           [168.49366746754663, -17.493367878899647],
           [168.4872301659109, -17.500244087072357],
           [168.48190866322534, -17.49967107966114],
           [168.47538553090112, -17.497379031948707]]]]),
    rc_to_trf = 
    /* color: #a1ff76 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[-175.28009442487297, -21.10471936267742],
          [-175.23614911237297, -21.10375847758139],
          [-175.1712611118847, -21.10728169252593],
          [-175.1441386143261, -21.104399068336456],
          [-175.10053662458, -21.092868011883343],
          [-175.09950665631828, -21.08614114884535],
          [-175.10877637067375, -21.076851170667954],
          [-175.12388257184563, -21.067560611926883],
          [-175.13486889997063, -21.067880985683693],
          [-175.15169171491203, -21.07781222981944],
          [-175.1606181065136, -21.09799303640641],
          [-175.20765332379875, -21.06499759703034],
          [-175.24644879499016, -21.03904458481073],
          [-175.29108075299797, -21.053463483571132],
          [-175.32403973737297, -21.081015715450285]]]),
    newcal_lagoon = 
    /* color: #00d678 */
    /* shown: false */
    ee.Geometry.MultiPolygon(
        [[[[163.8764204672719, -20.067383829300468],
           [163.89530321873676, -20.1005957029803],
           [163.93787524022113, -20.139602594942268],
           [163.9588179282094, -20.165709207083406],
           [163.93409868992816, -20.251733382249206],
           [163.9746107748891, -20.29199051477236],
           [164.03881212986957, -20.34640153037823],
           [164.13803240574848, -20.462564398809928],
           [164.11983629979144, -20.523345974242794],
           [164.0683378867055, -20.470284029486045],
           [164.09271380223285, -20.531705574211113],
           [164.1782011679555, -20.62491627096434],
           [164.21939989842426, -20.65222584807867],
           [164.2499556235219, -20.666360643833762],
           [164.25338885106098, -20.675997250566283],
           [164.26849505223285, -20.681136524083406],
           [164.2763914755727, -20.69334160122192],
           [164.27845141209613, -20.707151425221184],
           [164.27467486180316, -20.722244444882758],
           [164.26746508397113, -20.729950938738614],
           [164.2540754965688, -20.729629842659097],
           [164.2595686606313, -20.753710158150405],
           [164.30694720067035, -20.80988264291882],
           [164.35569903172504, -20.861222034966477],
           [164.39312121190082, -20.890413498365188],
           [164.4298567465688, -20.926012983926118],
           [164.4964613608266, -21.012571003945013],
           [164.5184340170766, -20.998789194211472],
           [164.5561995200063, -20.98212111974831],
           [164.59842821873676, -20.991096467944423],
           [164.62383410252582, -21.047500583058955],
           [164.64786669529926, -21.048461831829076],
           [164.6883787802602, -21.071529939944128],
           [164.69078203953754, -21.105164516541418],
           [164.70760485447894, -21.130465509091415],
           [164.74674364842426, -21.179774016752546],
           [164.765969722643, -21.20826299954015],
           [164.7824492148305, -21.240906535600114],
           [164.82811114110004, -21.314168132757946],
           [164.9139418295766, -21.376203963678112],
           [164.93419787205707, -21.380360065075795],
           [164.94793078221332, -21.392827661052237],
           [164.9575438193227, -21.406253114380164],
           [164.97127672947894, -21.404015624442003],
           [164.98672625340473, -21.420636160257654],
           [165.00080248631488, -21.42766735614577],
           [165.0231184653188, -21.421275373873726],
           [165.04715105809223, -21.43278074047849],
           [165.0560774496938, -21.449398002230218],
           [165.09349962986957, -21.45035663265441],
           [165.21263262547504, -21.535330119231023],
           [165.23529192723285, -21.536926889810033],
           [165.2438749960805, -21.524471613629405],
           [165.25898119725238, -21.568446939088318],
           [165.29400011815082, -21.589518083321458],
           [165.34549853123676, -21.61058616153833],
           [165.35442492283832, -21.61888486515907],
           [165.3815474203969, -21.622395711768938],
           [165.40146014012348, -21.630693737492358],
           [165.42892596043598, -21.63962953994955],
           [165.43750902928363, -21.65335130292942],
           [165.4639448813344, -21.653670398177287],
           [165.51956316746723, -21.725129938527054],
           [165.56803387633826, -21.75383137063159],
           [165.6246821307328, -21.77232481009473],
           [165.6308619403031, -21.790178282811368],
           [165.6586710833695, -21.79432252100101],
           [165.69883984557654, -21.82715340068986],
           [165.74450177184607, -21.83607699815571],
           [165.7455317401078, -21.851373298141887],
           [165.75411480895545, -21.862844448622596],
           [165.81453961364295, -21.90935688651281],
           [165.8560816668656, -21.931333510987944],
           [165.87359112731482, -21.948848679827197],
           [165.88217419616248, -21.963177667845937],
           [165.89007061950232, -21.974958197743497],
           [165.9048334979203, -21.98355418386582],
           [165.92577618590857, -21.984190902871347],
           [165.93126934997107, -21.99055793580797],
           [165.9443156146195, -22.000107949473634],
           [165.96285504333045, -22.002017875043727],
           [165.96903485290076, -22.020479162348952],
           [166.0088602923539, -22.064394620723004],
           [166.10430401793982, -22.10511560743664],
           [166.1200968646195, -22.147096816865066],
           [166.1798350237992, -22.167446838474667],
           [166.27459210387732, -22.23419965419644],
           [166.3006846331742, -22.274553799373084],
           [166.38720196715857, -22.363482428256766],
           [166.43011731139686, -22.381896269073117],
           [166.44453686706092, -22.449815898788316],
           [166.42601910584162, -22.474550373227114],
           [166.45623150818537, -22.492315076297135],
           [166.45897809021662, -22.51895785484783],
           [166.48644391052912, -22.562082891733986],
           [166.60866681091974, -22.62801274596515],
           [166.644372377326, -22.663500349256516],
           [166.74050274841974, -22.63561800426364],
           [166.87920514099787, -22.61660406952245],
           [166.951989564826, -22.579836342370598],
           [166.93825665466974, -22.537985267045787],
           [166.932419549551, -22.379675845991294],
           [166.8713080993557, -22.283133336463663],
           [166.75938488158226, -22.299651922410366],
           [166.6076362243557, -22.238014951327834],
           [166.4703071227932, -22.16681275536386],
           [166.34671093138695, -22.13628648191866],
           [166.2176215759182, -22.10257270119968],
           [166.19770885619164, -21.973368104332835],
           [166.0466468444729, -21.861890369011295],
           [165.9972083679104, -21.933246174978798],
           [165.93060375365258, -21.872086241813317],
           [165.85232616576195, -21.83576012257286],
           [165.8331000915432, -21.763717907288232],
           [165.7225501647854, -21.7005715368061],
           [165.5975806823635, -21.69801958549512],
           [165.51358619539363, -21.618886682637264],
           [165.3247586807452, -21.525019772268912],
           [165.17850318758113, -21.443235879510997],
           [165.1544705948077, -21.341581078009654],
           [164.9622098526202, -21.292326662232195],
           [164.90659156648738, -21.179683203565947],
           [164.8145810684405, -21.03619465456579],
           [164.72737708894832, -21.039399036255773],
           [164.7040311416827, -20.950932827672073],
           [164.62438026277644, -20.901548490521414],
           [164.5007840713702, -20.848939500071126],
           [164.424566420003, -20.778979553355654],
           [164.43280616609675, -20.714767591232192],
           [164.37306800691707, -20.665948288045733],
           [164.2920438369952, -20.550904021354135],
           [164.18355384676082, -20.44349406601218],
           [164.19248023836238, -20.395875200981656],
           [164.1883603653155, -20.31798022268133],
           [164.11351600496394, -20.273543199878755],
           [164.08261695711238, -20.232959144045832],
           [164.06957069246394, -20.18656438949451],
           [164.07643714754207, -20.142734434550132],
           [164.12587562410457, -20.22136175212975],
           [164.2755643448077, -20.304457260821565],
           [164.32706275789363, -20.29415325904261],
           [164.3250028213702, -20.242622976436166],
           [164.51108375398738, -20.327638757713956],
           [164.60927406160457, -20.435773089022966],
           [164.71845069734675, -20.484666057156677],
           [164.83518043367488, -20.601898287573555],
           [164.84479347078425, -20.595470821360557],
           [164.83792701570613, -20.572972556213763],
           [164.83174720613582, -20.562043630649246],
           [164.82282081453425, -20.549828023684267],
           [164.81183448640925, -20.5388974424244],
           [164.81183448640925, -20.53182429700725],
           [164.82213416902644, -20.53182429700725],
           [164.81114784090144, -20.50931665903129],
           [164.7919217666827, -20.47973016172688],
           [164.76239600984675, -20.448207832845913],
           [164.72463050691707, -20.424400971842406],
           [164.7095243057452, -20.40638251980824],
           [164.688238295003, -20.39479811580408],
           [164.6436063369952, -20.368408167422132],
           [164.62644019929988, -20.366477018318463],
           [164.62506690828425, -20.35231452002019],
           [164.60927406160457, -20.353602073542366],
           [164.60790077058894, -20.324629524144374],
           [164.59760108797175, -20.31239503998194],
           [164.56876197664363, -20.288567216937015],
           [164.5289365371905, -20.267956415175583],
           [164.490484388753, -20.231880924530294],
           [164.43417945711238, -20.2267265991637],
           [164.4190732559405, -20.176462978569244],
           [164.40946021883113, -20.150680473528865],
           [164.38336768953425, -20.10168198684079],
           [164.259771498128, -20.02944573838299],
           [164.11282935945613, -19.990734078326685],
           [164.04279151765925, -19.99202462041507],
           [164.01669898836238, -19.95588544652407],
           [163.886236341878, -19.931357720108522],
           [163.87936988679988, -20.057828231424065]]],
         [[[165.1883161385535, -20.802774268703608],
           [165.237754615116, -20.913137510241537],
           [165.28444650964724, -20.99649774578352],
           [165.75685861902224, -21.422825755890056],
           [166.08782175378786, -21.558274325301284],
           [166.7552411873816, -22.040255632825165],
           [166.9310224373816, -22.374639064972275],
           [166.97222116785036, -22.37717884634963],
           [166.9914472420691, -22.35785536303566],
           [167.05324533777224, -22.34261386522065],
           [167.0683515389441, -22.26002681274817],
           [166.973594458866, -22.145595051310945],
           [166.95024851160036, -22.069255470235287],
           [166.885703833866, -22.03743512747934],
           [166.82939890222536, -21.995421320620856],
           [166.70854929285036, -21.911356381823012],
           [166.567100318241, -21.77113791353694],
           [166.50392893152224, -21.704805022192932],
           [166.41054514245974, -21.6537589068973],
           [166.28420236902224, -21.58737195967415],
           [166.1660993416785, -21.466009538416163],
           [166.07683542566286, -21.459619236052866],
           [165.9916913826941, -21.38163500727727],
           [165.79119089441286, -21.283136544657808],
           [165.7156598885535, -21.260101402401848],
           [165.655235083866, -21.189693929462642],
           [165.589317115116, -21.123096001417483],
           [165.54811838464724, -21.120533944652585],
           [165.50005319910036, -21.091067112111045],
           [165.457481177616, -21.04108825600053],
           [165.42864206628786, -20.93081923074455],
           [165.347617896366, -20.921840265344844],
           [165.27895334558474, -20.84998919097133],
           [165.27483347253786, -20.788375225332327],
           [165.24050119714724, -20.752422120683313],
           [165.0853193123816, -20.70233033559629],
           [164.9864423592566, -20.667641707166293],
           [164.94936350183474, -20.697191779968414]]],
         [[[166.28826881513365, -20.615595850056536],
           [166.32534767255552, -20.61752386372529],
           [166.3624265299774, -20.645798592301052],
           [166.4173581706024, -20.70618607666141],
           [166.4510038004852, -20.696551387026787],
           [166.4887693034149, -20.664431335301288],
           [166.53408790693052, -20.637445242047995],
           [166.54232765302427, -20.595671613350707],
           [166.54782081708677, -20.530739112802344],
           [166.56773353681334, -20.484433761226395],
           [166.5491941081024, -20.4496955687545],
           [166.27659584150084, -20.517877919413092]]]]),
    refinement_mask = 
    /* color: #efff04 */
    /* shown: false */
    ee.Geometry({
      "type": "GeometryCollection",
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                178.323780044116,
                -18.1711963957519
              ],
              [
                178.31622694353007,
                -18.179351227410773
              ],
              [
                178.30386732438944,
                -18.22044577490316
              ],
              [
                178.26987837175272,
                -18.238706905749286
              ],
              [
                178.22593305925272,
                -18.25696611887753
              ],
              [
                178.21632002214335,
                -18.264138856135446
              ],
              [
                178.20464704851054,
                -18.263486801355512
              ],
              [
                178.19434736589335,
                -18.267725113647067
              ],
              [
                178.23794935563944,
                -18.34725575265726
              ],
              [
                178.4765586696043,
                -18.30195384067824
              ],
              [
                178.49166487077616,
                -18.197616667074172
              ],
              [
                178.47072218278788,
                -18.189136522301613
              ],
              [
                178.4604225001707,
                -18.189462689343063
              ],
              [
                178.41956709245585,
                -18.19011502159567
              ],
              [
                178.4004604762904,
                -18.172509187969165
              ],
              [
                178.39874386252086,
                -18.169654928339455
              ],
              [
                178.39977383078258,
                -18.163701608091095
              ],
              [
                178.3990013545863,
                -18.162396743658324
              ],
              [
                178.39977383078258,
                -18.159460763040784
              ],
              [
                178.39548229635875,
                -18.143719803463036
              ],
              [
                178.39325069845836,
                -18.14420918106986
              ],
              [
                178.39067577780406,
                -18.144616994695895
              ],
              [
                178.3880150264613,
                -18.143719803463036
              ],
              [
                178.38132023276012,
                -18.149510684005676
              ],
              [
                178.36844562948863,
                -18.156361618853264
              ],
              [
                178.36192249716441,
                -18.160847204482206
              ],
              [
                178.3549702113978,
                -18.164598696733126
              ],
              [
                178.34861874045055,
                -18.16419092973984
              ],
              [
                178.34501385153453,
                -18.164027822675937
              ],
              [
                178.34338306845348,
                -18.16476180326384
              ],
              [
                178.3403789943568,
                -18.1663928601918
              ],
              [
                178.33728908957164,
                -18.167289935008036
              ],
              [
                178.33445667685191,
                -18.167289935008036
              ],
              [
                178.33093761862438,
                -18.16949182637962
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                178.61370831190243,
                -18.209683854024178
              ],
              [
                178.68992596326962,
                -18.295760571807815
              ],
              [
                178.84442120252743,
                -18.200552005684536
              ],
              [
                178.919265562879,
                -17.845999520098438
              ],
              [
                178.7932661121954,
                -17.814950498033877
              ],
              [
                178.78639965711727,
                -17.828024430092196
              ],
              [
                178.7829664295782,
                -17.858090832064796
              ],
              [
                178.77541332899227,
                -17.887171971439795
              ],
              [
                178.7716367786993,
                -17.901220703426763
              ],
              [
                178.7661436146368,
                -17.933234585202502
              ],
              [
                178.7712934559454,
                -17.971774231091832
              ],
              [
                178.75241070448055,
                -18.004754878161485
              ],
              [
                178.74520092664852,
                -18.013896936096234
              ],
              [
                178.7489774769415,
                -18.02010020528577
              ],
              [
                178.75378399549618,
                -18.03609710163658
              ],
              [
                178.73970776258602,
                -18.046543269499622
              ],
              [
                178.72288494764462,
                -18.05764164296494
              ],
              [
                178.71430187879696,
                -18.072329588949184
              ],
              [
                178.70365887342587,
                -18.089627149656405
              ],
              [
                178.70228558241024,
                -18.103007111513467
              ],
              [
                178.7108686512579,
                -18.126174873199766
              ],
              [
                178.69370251356258,
                -18.14346711927113
              ],
              [
                178.666580016004,
                -18.156842966801207
              ],
              [
                178.64151745496883,
                -18.156842966801207
              ],
              [
                178.6284711903204,
                -18.158474097680152
              ],
              [
                178.62606793104305,
                -18.165324681046805
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                179.48231487928524,
                -18.19076735140784
              ],
              [
                179.4308164661993,
                -18.155538051133274
              ],
              [
                179.37280402864778,
                -18.183263213642643
              ],
              [
                179.358718687879,
                -18.24359795451868
              ],
              [
                179.4308164661993,
                -18.263160773047197
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                177.73463310386592,
                -17.294224100320882
              ],
              [
                177.73634971763545,
                -17.31159675402703
              ],
              [
                177.73531974937373,
                -17.32142960406758
              ],
              [
                177.72982658531123,
                -17.32798454508141
              ],
              [
                177.7226168074792,
                -17.33847196401872
              ],
              [
                177.72399009849482,
                -17.346009426241128
              ],
              [
                177.7387529769128,
                -17.34797566980443
              ],
              [
                177.7823549666589,
                -17.340438288362947
              ],
              [
                177.8211504378503,
                -17.32667357559357
              ],
              [
                177.82973350669795,
                -17.320446342740592
              ],
              [
                177.83419670249873,
                -17.32142960406758
              ],
              [
                177.8383165755456,
                -17.31258006270502
              ],
              [
                177.84586967613154,
                -17.30930234665698
              ],
              [
                177.86818565513545,
                -17.309957894541817
              ],
              [
                177.8874117293542,
                -17.315202193462508
              ],
              [
                177.96671928550654,
                -17.313563366122818
              ],
              [
                177.9753023543542,
                -17.306680131743633
              ],
              [
                177.9811388411706,
                -17.299468847931337
              ],
              [
                177.99006523277217,
                -17.298485469142662
              ],
              [
                177.997961656112,
                -17.30700791065292
              ],
              [
                178.01203788902217,
                -17.320446342740592
              ],
              [
                178.03881706382685,
                -17.315202193462508
              ],
              [
                178.06525291587764,
                -17.300780011472437
              ],
              [
                178.0745226302331,
                -17.29356849635818
              ],
              [
                178.0803591170495,
                -17.281439401844317
              ],
              [
                178.1071382918542,
                -17.285701066650425
              ],
              [
                178.1133181014245,
                -17.281439401844317
              ],
              [
                178.13700737144404,
                -17.257834550166262
              ],
              [
                178.1352907576745,
                -17.244391548122895
              ],
              [
                178.13014091636592,
                -17.234882492039276
              ],
              [
                178.13151420738154,
                -17.197169348159573
              ],
              [
                178.12018455650264,
                -17.18536191443614
              ],
              [
                178.0796724715417,
                -17.207008301042908
              ],
              [
                178.07211937095576,
                -17.21422320064527
              ],
              [
                178.05666984702998,
                -17.22635671515687
              ],
              [
                178.03916038658076,
                -17.221437818775286
              ],
              [
                178.019934312362,
                -17.22406124647039
              ],
              [
                178.02233757163935,
                -17.246358877887566
              ],
              [
                178.03263725425654,
                -17.255211602291972
              ],
              [
                178.06593956138545,
                -17.242096303562892
              ],
              [
                178.08344902183467,
                -17.258490281306567
              ],
              [
                178.0738359847253,
                -17.265703169956616
              ],
              [
                178.05014671470576,
                -17.264063901858727
              ],
              [
                178.02233757163935,
                -17.264063901858727
              ],
              [
                177.9753023543542,
                -17.25619521211586
              ],
              [
                177.91865409995967,
                -17.240128928369963
              ],
              [
                177.84792961265498,
                -17.250293474504176
              ],
              [
                177.80707420494014,
                -17.223077465448302
              ],
              [
                177.76999534751826,
                -17.2061884082826
              ],
              [
                177.7581507125085,
                -17.21077976094005
              ],
              [
                177.74802269126826,
                -17.216026881569846
              ],
              [
                177.72862495567256,
                -17.229635906674062
              ],
              [
                177.70991386558467,
                -17.25373617772204
              ],
              [
                177.7171236434167,
                -17.263080334003543
              ],
              [
                177.73051323081904,
                -17.271440493497817
              ],
              [
                177.734289781112,
                -17.282422871707347
              ],
              [
                177.73446144248896,
                -17.290618249623957
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                177.8157641626067,
                -17.117634408215135
              ],
              [
                177.85696289307546,
                -17.13732023046151
              ],
              [
                177.8693225122161,
                -17.155035687535456
              ],
              [
                177.88442871338796,
                -17.19046152805896
              ],
              [
                177.90090820557546,
                -17.193741355963375
              ],
              [
                177.92288086182546,
                -17.170125298969328
              ],
              [
                177.9366137719817,
                -17.133383232776065
              ],
              [
                177.9414202905364,
                -17.098602799742434
              ],
              [
                177.89472839600515,
                -17.091383404916698
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                177.41132995850515,
                -17.170781341186622
              ],
              [
                177.3872973657317,
                -17.1871816420695
              ],
              [
                177.36326477295827,
                -17.2173544013248
              ],
              [
                177.3694445825286,
                -17.243587581821128
              ],
              [
                177.4092700219817,
                -17.268505650761472
              ],
              [
                177.4422290063567,
                -17.282274717743704
              ],
              [
                177.46076843506765,
                -17.277685143093525
              ],
              [
                177.4580218530364,
                -17.249489533911937
              ],
              [
                177.4525286889739,
                -17.22588059354325
              ],
              [
                177.42780945069265,
                -17.1799656884812
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                177.40882623776224,
                -16.96447824750141
              ],
              [
                177.41637933834818,
                -16.971702542258647
              ],
              [
                177.44178522213724,
                -16.962507937063076
              ],
              [
                177.4836705981138,
                -16.92375430116624
              ],
              [
                177.51731622799662,
                -16.879079199197456
              ],
              [
                177.5434087572935,
                -16.827163968440875
              ],
              [
                177.54272211178568,
                -16.80876021581802
              ],
              [
                177.5214361010435,
                -16.81533318971733
              ],
              [
                177.51250970944193,
                -16.824534970330493
              ],
              [
                177.49809015377787,
                -16.843594379875498
              ],
              [
                177.50426996334818,
                -16.8580519621235
              ],
              [
                177.46993768795755,
                -16.888934910791782
              ],
              [
                177.41569269284037,
                -16.948715185443255
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                177.78630960568216,
                -16.775809753123372
              ],
              [
                177.82630468948042,
                -16.798448707435085
              ],
              [
                177.85995233639505,
                -16.80802074199788
              ],
              [
                177.88501596221263,
                -16.816850728741116
              ],
              [
                177.88332324447052,
                -16.823393785774474
              ],
              [
                177.86591151347125,
                -16.826501060812603
              ],
              [
                177.87265492852785,
                -16.833723527990838
              ],
              [
                177.88283204021707,
                -16.83700229516789
              ],
              [
                177.8941855812894,
                -16.85118569569023
              ],
              [
                177.91292139857757,
                -16.854935333032234
              ],
              [
                177.9374316317858,
                -16.845840735058967
              ],
              [
                177.94445017187374,
                -16.818988729339804
              ],
              [
                177.93354067187755,
                -16.813531757274653
              ],
              [
                177.92555393768546,
                -16.817622255844324
              ],
              [
                177.91688037181842,
                -16.817768730153094
              ],
              [
                177.91212736730884,
                -16.818063366482733
              ],
              [
                177.91046432156736,
                -16.81457859417645
              ],
              [
                177.92489452320265,
                -16.809615012809672
              ],
              [
                177.93400245319037,
                -16.802185857415953
              ],
              [
                177.95197634415513,
                -16.796826153178685
              ],
              [
                177.95561485156378,
                -16.770676097091087
              ],
              [
                177.9306212571677,
                -16.771625698668007
              ],
              [
                177.91815948286055,
                -16.771753878504366
              ],
              [
                177.91496791290635,
                -16.75971898603684
              ],
              [
                177.9161268170735,
                -16.72391668342429
              ],
              [
                177.88621652706888,
                -16.724523858364968
              ],
              [
                177.8729986010435,
                -16.71441299039149
              ],
              [
                177.87746179684427,
                -16.684817128024356
              ],
              [
                177.89256799801615,
                -16.667386309046027
              ],
              [
                177.9066442309263,
                -16.64830925368215
              ],
              [
                177.92003381832865,
                -16.62462474935527
              ],
              [
                177.92621362789896,
                -16.609162453878056
              ],
              [
                177.9063009081724,
                -16.589092512219942
              ],
              [
                177.84793604000834,
                -16.57033673922085
              ],
              [
                177.80296075924662,
                -16.558490046380218
              ],
              [
                177.78716791256693,
                -16.54236421088339
              ],
              [
                177.73910272702005,
                -16.54631351978407
              ],
              [
                177.72056329830912,
                -16.526566166893833
              ],
              [
                177.69962061032084,
                -16.528870128841863
              ],
              [
                177.67490137203959,
                -16.57329829857523
              ],
              [
                177.65086877926615,
                -16.625611662098773
              ],
              [
                177.66631830319193,
                -16.71507062411536
              ],
              [
                177.70065057858255,
                -16.7292092007813
              ],
              [
                177.746655827606,
                -16.7311819420854
              ],
              [
                177.8070806322935,
                -16.762085555475288
              ],
              [
                177.81463373287943,
                -16.769317591471836
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                178.06791201626092,
                -16.868701826737137
              ],
              [
                178.14550289115448,
                -16.872480114623553
              ],
              [
                178.2091892066119,
                -16.87067311701119
              ],
              [
                178.21502568841888,
                -16.859009351698475
              ],
              [
                178.2189738967602,
                -16.84175880241366
              ],
              [
                178.19614295350175,
                -16.83042187080781
              ],
              [
                178.18258171652255,
                -16.821877647856866
              ],
              [
                178.17571526740463,
                -16.820234483873655
              ],
              [
                178.16867715704618,
                -16.82204196342327
              ],
              [
                178.14636119738364,
                -16.82713567668036
              ],
              [
                178.1362331849241,
                -16.83042187063815
              ],
              [
                178.12713513983624,
                -16.833543702094143
              ],
              [
                178.11031233949356,
                -16.833872312931422
              ],
              [
                178.09451950651686,
                -16.831243410211542
              ],
              [
                178.0770100612603,
                -16.83140771772189
              ],
              [
                178.0459393789613,
                -16.822863539362146
              ],
              [
                178.03838628491846,
                -16.821056067651778
              ],
              [
                178.02636999894068,
                -16.818755624194104
              ],
              [
                178.02498044738397,
                -16.811525477153214
              ],
              [
                178.03854168440364,
                -16.809553570966127
              ],
              [
                178.05055797040546,
                -16.81793403037572
              ],
              [
                178.05931269304344,
                -16.81908426057974
              ],
              [
                178.08231529761528,
                -16.821384700050373
              ],
              [
                178.09810813059994,
                -16.820398800804643
              ],
              [
                178.10497457972517,
                -16.823685111623888
              ],
              [
                178.13123909574904,
                -16.821055919505667
              ],
              [
                178.1550996583615,
                -16.80873193728426
              ],
              [
                178.16196610748136,
                -16.81185412607144
              ],
              [
                178.17503469935022,
                -16.810170361023015
              ],
              [
                178.18312466481257,
                -16.817852289423584
              ],
              [
                178.18374700839857,
                -16.82052173585328
              ],
              [
                178.1928129424029,
                -16.82432103861871
              ],
              [
                178.2014654114563,
                -16.81849752666516
              ],
              [
                178.22175573146964,
                -16.814107043657405
              ],
              [
                178.2001607859152,
                -16.786382037026847
              ],
              [
                178.12694721695982,
                -16.780958628992888
              ],
              [
                178.13432864981036,
                -16.761728575133947
              ],
              [
                178.14926317678885,
                -16.72244063049779
              ],
              [
                178.13055210284335,
                -16.706164172403078
              ],
              [
                178.11596089836362,
                -16.704191174052003
              ],
              [
                178.0967348407132,
                -16.73246886761636
              ],
              [
                178.0649775133916,
                -16.745291090683075
              ],
              [
                178.04849803550877,
                -16.770275505953137
              ],
              [
                178.0160540635347,
                -16.814811941849666
              ],
              [
                178.00867263078626,
                -16.826149807593186
              ],
              [
                178.00352279402648,
                -16.840280110699986
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                178.24008827788825,
                -16.78999771688718
              ],
              [
                178.23099022490973,
                -16.814647632411788
              ],
              [
                178.22841530425544,
                -16.83009327984228
              ],
              [
                178.23356514556403,
                -16.83863713956409
              ],
              [
                178.24214821441169,
                -16.84192313679786
              ],
              [
                178.251932912898,
                -16.847673494679395
              ],
              [
                178.25982933623786,
                -16.845373372495274
              ],
              [
                178.26909905059333,
                -16.827628633292832
              ],
              [
                178.2680690823316,
                -16.807581650741195
              ],
              [
                178.26789742095465,
                -16.80232307493567
              ],
              [
                178.2644641934156,
                -16.79147680210608
              ],
              [
                178.26412087066169,
                -16.787532549254426
              ],
              [
                178.26892738921637,
                -16.787368203607812
              ],
              [
                178.28042870147223,
                -16.778822034044858
              ],
              [
                178.28300362212653,
                -16.772576513204005
              ],
              [
                178.28214531524176,
                -16.764851506218353
              ],
              [
                178.28025704009528,
                -16.752194965651984
              ],
              [
                178.27270393950934,
                -16.74463351383385
              ],
              [
                178.26206093413825,
                -16.73937319634974
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                178.31802254302497,
                -16.855230842105872
              ],
              [
                178.306864553523,
                -16.857366559476983
              ],
              [
                178.29072838408942,
                -16.854245118260962
              ],
              [
                178.2864368496656,
                -16.84833066731058
              ],
              [
                178.28300362212653,
                -16.848659252770165
              ],
              [
                178.28248863799567,
                -16.854902268061757
              ],
              [
                178.2864368496656,
                -16.86229504595699
              ],
              [
                178.35750465972419,
                -16.879379470708106
              ],
              [
                178.36746101958747,
                -16.87543704828351
              ],
              [
                178.37552910430426,
                -16.850795044346686
              ],
              [
                178.35990791900153,
                -16.839458644220233
              ],
              [
                178.34737663848395,
                -16.830257588472048
              ],
              [
                178.33862190825934,
                -16.82549258034577
              ],
              [
                178.3336437283277,
                -16.828778805673203
              ],
              [
                178.33673363311286,
                -16.83535108529218
              ],
              [
                178.3339870510816,
                -16.843237519718485
              ],
              [
                178.32969551665778,
                -16.850959335007655
              ],
              [
                178.32162743194098,
                -16.853916542504283
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                162.91425584708546,
                -17.981140885712094
              ],
              [
                162.8998362914214,
                -17.982120545729877
              ],
              [
                162.87099718009327,
                -17.973303409877076
              ],
              [
                162.84730791007374,
                -17.957954012333698
              ],
              [
                162.83014177237843,
                -17.964159248491608
              ],
              [
                162.81949876700733,
                -17.991916846843466
              ],
              [
                162.8184687987456,
                -18.01673170801183
              ],
              [
                162.83220170890186,
                -18.048398229568836
              ],
              [
                162.83563493644093,
                -18.06373975166846
              ],
              [
                162.83288835440968,
                -18.076142556115858
              ],
              [
                162.83151506339405,
                -18.085933624912986
              ],
              [
                162.82430528556202,
                -18.106493090589264
              ],
              [
                162.82533525382374,
                -18.11465094038362
              ],
              [
                162.8287684813628,
                -18.12313470111018
              ],
              [
                162.83185838614796,
                -18.14695229266538
              ],
              [
                162.83906816398,
                -18.156739403502133
              ],
              [
                162.84730791007374,
                -18.164894910420855
              ],
              [
                162.85383104239796,
                -18.192946944715167
              ],
              [
                162.8613841429839,
                -18.203383759236
              ],
              [
                162.87511705314014,
                -18.213819948607977
              ],
              [
                162.8885066405425,
                -18.220994466005596
              ],
              [
                162.9104792967925,
                -18.198165430099895
              ],
              [
                162.91906236564014,
                -18.168809418467628
              ],
              [
                162.92592882071827,
                -18.113019400816512
              ],
              [
                162.93416856681202,
                -18.085933624912986
              ],
              [
                162.94309495841358,
                -18.066024544619214
              ],
              [
                162.95064805899952,
                -18.04513390318467
              ],
              [
                162.95064805899952,
                -18.02619961559185
              ],
              [
                162.94309495841358,
                -18.008242806500686
              ],
              [
                162.9276454344878,
                -17.982120545729877
              ],
              [
                162.91940568839405,
                -17.978854991195732
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                163.07545379815645,
                -18.320244332557873
              ],
              [
                163.06378082452363,
                -18.302317735041793
              ],
              [
                163.0517645281369,
                -18.29547254463199
              ],
              [
                163.04764465509004,
                -18.29384269753323
              ],
              [
                163.02601532159395,
                -18.301991779726546
              ],
              [
                163.0071325701291,
                -18.315355444602943
              ],
              [
                162.98241333184785,
                -18.32969579092783
              ],
              [
                162.99168304620332,
                -18.346316068176428
              ],
              [
                162.98241333184785,
                -18.395189966497465
              ],
              [
                163.01761426569843,
                -18.417341569651
              ],
              [
                163.02997388483905,
                -18.43851323071097
              ],
              [
                163.0437067949953,
                -18.45968228380134
              ],
              [
                163.05297650935077,
                -18.465869667905665
              ],
              [
                163.09383191706561,
                -18.456425676255208
              ],
              [
                163.11271466853046,
                -18.458705308024804
              ],
              [
                163.1147746050539,
                -18.437536134510072
              ],
              [
                163.11820783259296,
                -18.39453840562141
              ],
              [
                163.11717786433124,
                -18.35804706616624
              ],
              [
                163.10859479548358,
                -18.342079678678594
              ],
              [
                163.09005536677265,
                -18.331651200596077
              ],
              [
                163.08524884821796,
                -18.32382942927671
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                167.91362718518263,
                -16.22298854632592
              ],
              [
                167.9235835367125,
                -16.213675658848263
              ],
              [
                167.93714477416134,
                -16.21367565883965
              ],
              [
                167.9417796274667,
                -16.21482949180016
              ],
              [
                167.9458994970716,
                -16.21202731431614
              ],
              [
                167.95602750985103,
                -16.21169764376097
              ],
              [
                167.97096203717595,
                -16.207576715255172
              ],
              [
                167.9817766949145,
                -16.19686189796036
              ],
              [
                167.99070307908028,
                -16.19142184486044
              ],
              [
                168.00065943062214,
                -16.196202505617514
              ],
              [
                168.00864170084307,
                -16.193482630495875
              ],
              [
                168.01628060289275,
                -16.195048563685123
              ],
              [
                168.02194542363392,
                -16.18828962512416
              ],
              [
                167.99156138533908,
                -16.157294455983248
              ],
              [
                167.93577148427482,
                -16.167516804347066
              ],
              [
                167.89766269037304,
                -16.182684475986772
              ],
              [
                167.8834148079917,
                -16.19059758133486
              ],
              [
                167.84889538956676,
                -16.21274514863598
              ],
              [
                167.84460385889065,
                -16.2430723687884
              ],
              [
                167.85833675773867,
                -16.283776012144422
              ],
              [
                167.89181069821083,
                -16.305854618180195
              ],
              [
                167.96819994671887,
                -16.32743652153266
              ],
              [
                168.13595553664584,
                -16.390316142178744
              ],
              [
                168.14807010690097,
                -16.382891752437178
              ],
              [
                168.15886771595527,
                -16.36944585423019
              ],
              [
                168.15335723190026,
                -16.365058493470077
              ],
              [
                168.1423366306559,
                -16.374400886735504
              ],
              [
                168.1278488668683,
                -16.374144401740892
              ],
              [
                168.1201598808235,
                -16.36951359027002
              ],
              [
                168.09980569927885,
                -16.35810897146423
              ],
              [
                168.08816166510815,
                -16.354002832533176
              ],
              [
                168.07418598667226,
                -16.350960979643975
              ],
              [
                168.0596097075045,
                -16.348247588839907
              ],
              [
                168.0490403211828,
                -16.339855605092986
              ],
              [
                168.04255429375453,
                -16.339695212784875
              ],
              [
                168.03624003530737,
                -16.336569510817355
              ],
              [
                168.0357355541102,
                -16.333901136898014
              ],
              [
                168.03729098793588,
                -16.33156222560666
              ],
              [
                168.02272118269053,
                -16.323754250089017
              ],
              [
                168.0182105238846,
                -16.32498374489776
              ],
              [
                168.01593136311445,
                -16.329507981039228
              ],
              [
                168.00914115064947,
                -16.330978362344265
              ],
              [
                168.0064911328985,
                -16.327261438367497
              ],
              [
                168.00624444209117,
                -16.321567638525337
              ],
              [
                168.00360510823458,
                -16.31948769870944
              ],
              [
                167.99987141089917,
                -16.316975332049157
              ],
              [
                167.99154587436138,
                -16.31722248224103
              ],
              [
                167.98382111890447,
                -16.313433267541814
              ],
              [
                167.97437975111856,
                -16.30931447272467
              ],
              [
                167.95910190142797,
                -16.293332728853468
              ],
              [
                167.95395206445025,
                -16.283446461699217
              ],
              [
                167.94605564773917,
                -16.275537089170818
              ],
              [
                167.9398758188506,
                -16.27619629287522
              ],
              [
                167.93472600650756,
                -16.27355969594845
              ],
              [
                167.93300937500933,
                -16.271005548588167
              ],
              [
                167.92888952444068,
                -16.2712527126102
              ],
              [
                167.91695906874074,
                -16.266309085004277
              ],
              [
                167.91747405243345,
                -16.261694920265427
              ],
              [
                167.91824652796643,
                -16.249911829284684
              ],
              [
                167.9122383847949,
                -16.24406122097589
              ],
              [
                167.90889099073576,
                -16.2382104385924
              ],
              [
                167.91017844997944,
                -16.234831738512323
              ],
              [
                167.91163757044788,
                -16.22609629382864
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                168.2627194807701,
                -16.253873081061045
              ],
              [
                168.27765399869426,
                -16.264420001246503
              ],
              [
                168.29327514827116,
                -16.274966347888395
              ],
              [
                168.3032314977312,
                -16.281557522480632
              ],
              [
                168.31524777388432,
                -16.293421087598563
              ],
              [
                168.31971096212814,
                -16.304295391553495
              ],
              [
                168.3197109620921,
                -16.311215088867254
              ],
              [
                168.31868099549604,
                -16.324394788086646
              ],
              [
                168.3152477736914,
                -16.33427897984244
              ],
              [
                168.30889631340804,
                -16.343668499147025
              ],
              [
                168.30185820881195,
                -16.345809905262485
              ],
              [
                168.29361847660104,
                -16.350422084888038
              ],
              [
                168.2743924348075,
                -16.362281475170157
              ],
              [
                168.26735433573822,
                -16.36178744859762
              ],
              [
                168.26134619218138,
                -16.362610892398582
              ],
              [
                168.2467549994853,
                -16.363105015269984
              ],
              [
                168.23954523411174,
                -16.363434433070502
              ],
              [
                168.23388041823853,
                -16.36425797023977
              ],
              [
                168.22152081994534,
                -16.360963800843876
              ],
              [
                168.21139281577246,
                -16.356846010894877
              ],
              [
                168.20607132205802,
                -16.35569301416064
              ],
              [
                168.19542833466102,
                -16.35766957595525
              ],
              [
                168.19113680753412,
                -16.36392855605192
              ],
              [
                168.18195299277212,
                -16.364752003253134
              ],
              [
                168.17826221161747,
                -16.373646044701946
              ],
              [
                168.16864920564998,
                -16.41135850513421
              ],
              [
                168.21843092086706,
                -16.445277002441955
              ],
              [
                168.232163807621,
                -16.42288487182221
              ],
              [
                168.24383676144268,
                -16.41300517034353
              ],
              [
                168.2675259913435,
                -16.411687838856373
              ],
              [
                168.30494810820184,
                -16.39719660431997
              ],
              [
                168.35232656841848,
                -16.35931669546355
              ],
              [
                168.37601579904538,
                -16.307590516435237
              ],
              [
                168.36949267821157,
                -16.25881701802517
              ],
              [
                168.36228291281523,
                -16.22354755136442
              ],
              [
                168.31593441855583,
                -16.22717367566755
              ],
              [
                168.2699292465095,
                -16.21761374845745
              ],
              [
                168.24692666050726,
                -16.233766458321295
              ],
              [
                168.25173317104125,
                -16.24530329653672
              ],
              [
                168.2561963593719,
                -16.249258628125357
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                168.22715749015464,
                -15.699245572125028
              ],
              [
                168.2254408763851,
                -15.7081692872877
              ],
              [
                168.22853078117026,
                -15.71742309756717
              ],
              [
                168.23814381827964,
                -15.736590366411365
              ],
              [
                168.24466695060386,
                -15.748816818332013
              ],
              [
                168.2463835643734,
                -15.761372949080485
              ],
              [
                168.24569691886558,
                -15.77491948232951
              ],
              [
                168.247756855389,
                -15.780205688942795
              ],
              [
                168.25084676017417,
                -15.785161382471598
              ],
              [
                168.2525633739437,
                -15.796063481674729
              ],
              [
                168.25496663322104,
                -15.803331221822877
              ],
              [
                168.25530995597495,
                -15.809277360606965
              ],
              [
                168.25599660148276,
                -15.813241356065971
              ],
              [
                168.26045979728354,
                -15.81951752335379
              ],
              [
                168.26732625236167,
                -15.826123804799714
              ],
              [
                168.27316273917808,
                -15.834711647880042
              ],
              [
                168.2752226757015,
                -15.845611076806572
              ],
              [
                168.2752226757015,
                -15.860803238220493
              ],
              [
                168.27693928947104,
                -15.872361724885321
              ],
              [
                168.27693928947104,
                -15.88722166210797
              ],
              [
                168.2800291942562,
                -15.900429574428133
              ],
              [
                168.27865590324058,
                -15.910665109986391
              ],
              [
                168.2858656810726,
                -15.917268404729718
              ],
              [
                168.2862090038265,
                -15.925192071942352
              ],
              [
                168.27659596671714,
                -15.947640764029112
              ],
              [
                168.27762593497886,
                -15.965135796213225
              ],
              [
                168.27693928947104,
                -15.978008523252578
              ],
              [
                168.27693928947104,
                -15.999131203733631
              ],
              [
                168.29959859122886,
                -16.024541469614345
              ],
              [
                168.34217061271323,
                -16.028831195318336
              ],
              [
                168.4012221263851,
                -15.966456114001085
              ],
              [
                168.4001921581234,
                -15.857500691751731
              ],
              [
                168.37444295158042,
                -15.765998696258942
              ],
              [
                168.3236311840023,
                -15.692635160863606
              ],
              [
                168.24810017814292,
                -15.686024535325311
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                169.45816322446655,
                -19.24469213491048
              ],
              [
                169.44786354184936,
                -19.202548824238495
              ],
              [
                169.16771217466186,
                -19.198658127756357
              ],
              [
                169.0708951580603,
                -19.38077340414612
              ],
              [
                169.08050819516967,
                -19.585329017191363
              ],
              [
                169.34967323423217,
                -19.82128056419171
              ],
              [
                169.5762662518103,
                -19.790917305460574
              ],
              [
                169.66827674985717,
                -19.626079720815994
              ],
              [
                169.62227150083373,
                -19.474668021760245
              ],
              [
                169.54056068540405,
                -19.4960295530647
              ],
              [
                169.5158414471228,
                -19.526448684488937
              ],
              [
                169.50760170102905,
                -19.544567998835387
              ],
              [
                169.49180885434936,
                -19.552332796734003
              ],
              [
                169.47876258970092,
                -19.565273296055956
              ],
              [
                169.46983619809936,
                -19.57885970250149
              ],
              [
                169.4828824627478,
                -19.602794868537444
              ],
              [
                169.47464271665405,
                -19.633840588640552
              ],
              [
                169.45404335141967,
                -19.66100067202345
              ],
              [
                169.41078468442748,
                -19.65776756982922
              ],
              [
                169.34829994321655,
                -19.64289446045874
              ],
              [
                169.30435463071655,
                -19.601501166772877
              ],
              [
                169.25697609067748,
                -19.548450444489585
              ],
              [
                169.21852394223998,
                -19.474668021760245
              ],
              [
                169.2089109051306,
                -19.441649206790512
              ],
              [
                169.22401710630248,
                -19.423518372761194
              ],
              [
                169.24324318052123,
                -19.381421138957798
              ],
              [
                169.2418698895056,
                -19.343848264022085
              ],
              [
                169.2638425457556,
                -19.330890093495103
              ],
              [
                169.29954811216186,
                -19.312746927584488
              ],
              [
                169.34829994321655,
                -19.3101548823281
              ],
              [
                169.4561032879431,
                -19.284232170634507
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                169.75794937118667,
                -20.13421015366841
              ],
              [
                169.78266860946792,
                -20.12937495007363
              ],
              [
                169.81700088485854,
                -20.120026465717487
              ],
              [
                169.82695724472183,
                -20.122283047596966
              ],
              [
                169.84034683212417,
                -20.11905934923039
              ],
              [
                169.85030319198745,
                -20.120671206719848
              ],
              [
                169.86060287460464,
                -20.126796113665808
              ],
              [
                169.86575271591323,
                -20.136144193221522
              ],
              [
                169.8691859434523,
                -20.14452475465476
              ],
              [
                169.8750224302687,
                -20.149037178425928
              ],
              [
                169.89253189071792,
                -20.155805569588065
              ],
              [
                169.9024882505812,
                -20.168052388515747
              ],
              [
                169.90901138290542,
                -20.19125425060688
              ],
              [
                169.90386154159683,
                -20.20768681286922
              ],
              [
                169.90042831405776,
                -20.21864089081444
              ],
              [
                169.88223220810073,
                -20.238291861994284
              ],
              [
                169.8746791075148,
                -20.252142693055212
              ],
              [
                169.8647227476515,
                -20.25085429575447
              ],
              [
                169.8523631285109,
                -20.25761826232249
              ],
              [
                169.83485366806167,
                -20.258262434246447
              ],
              [
                169.81288101181167,
                -20.247955362747447
              ],
              [
                169.80498458847183,
                -20.24892167976188
              ],
              [
                169.7929682920851,
                -20.24698903972124
              ],
              [
                169.7929682920851,
                -20.253753174649045
              ],
              [
                169.78335525497573,
                -20.260194933979896
              ],
              [
                169.77339889511245,
                -20.26341571340323
              ],
              [
                169.75863601669448,
                -20.26405986126741
              ],
              [
                169.7534861753859,
                -20.258906603497376
              ],
              [
                169.7541728208937,
                -20.246022710683462
              ],
              [
                169.75657608017104,
                -20.231527053893274
              ],
              [
                169.75176956161636,
                -20.217996554634468
              ],
              [
                169.75005294784683,
                -20.20897556794083
              ],
              [
                169.7428431700148,
                -20.202209484784444
              ],
              [
                169.71709396347183,
                -20.195443107601967
              ],
              [
                169.66387893661636,
                -20.188998665573852
              ],
              [
                169.61547042831558,
                -20.22282901093156
              ],
              [
                169.62474014267104,
                -20.324919759985953
              ],
              [
                169.70198776229995,
                -20.426621439725704
              ],
              [
                169.90111495956558,
                -20.40892501955222
              ],
              [
                170.0405039976515,
                -20.303347822430208
              ],
              [
                170.0624766539015,
                -20.151293341415617
              ],
              [
                170.0226512144484,
                -20.014575620205772
              ],
              [
                169.88360549911636,
                -19.97489229733551
              ],
              [
                169.7486796568312,
                -19.973278942660954
              ],
              [
                169.6559825132765,
                -20.015543381157634
              ],
              [
                169.62405349716323,
                -20.085528949003017
              ],
              [
                169.6168437193312,
                -20.147747927795653
              ],
              [
                169.66868545517104,
                -20.165151913005882
              ],
              [
                169.71709396347183,
                -20.180620492461845
              ],
              [
                169.73357345565933,
                -20.165151913005882
              ],
              [
                169.7438731382765,
                -20.13775587456396
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                163.66989828316053,
                -19.436129418286434
              ],
              [
                163.6839745160707,
                -19.463970203143067
              ],
              [
                163.72551656929335,
                -19.458143457483782
              ],
              [
                163.7718651410707,
                -19.40601715002449
              ],
              [
                163.77976156441053,
                -19.357113314107103
              ],
              [
                163.77667165962538,
                -19.349663097373988
              ],
              [
                163.76465536323866,
                -19.350958811682442
              ],
              [
                163.76225210396132,
                -19.342860428448084
              ],
              [
                163.72551656929335,
                -19.318886859552553
              ],
              [
                163.6674950238832,
                -19.406064575049246
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                166.47503639325865,
                -20.321289213454524
              ],
              [
                166.52481819257505,
                -20.394999170835643
              ],
              [
                166.54850746259459,
                -20.39789534971897
              ],
              [
                166.5608670817352,
                -20.39950431446578
              ],
              [
                166.576316605661,
                -20.397251759115754
              ],
              [
                166.59004951581724,
                -20.38856302289616
              ],
              [
                166.6048123942352,
                -20.38791939332129
              ],
              [
                166.61682869062193,
                -20.40272219355047
              ],
              [
                166.62541175946959,
                -20.417201817468086
              ],
              [
                166.6370847331024,
                -20.432323526084737
              ],
              [
                166.66077400312193,
                -20.444548501524526
              ],
              [
                166.67347694501646,
                -20.31066435574933
              ],
              [
                166.56876350507505,
                -20.289412452789108
              ],
              [
                166.477439652536,
                -20.32032334744368
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                167.96037711648694,
                -14.364135827991445
              ],
              [
                168.0125621750807,
                -14.433968813689685
              ],
              [
                168.06955375222913,
                -14.433968813689685
              ],
              [
                168.09289969949475,
                -14.43729364846014
              ],
              [
                168.0400279953932,
                -14.516410033605629
              ],
              [
                168.03865470437756,
                -14.562271297973608
              ],
              [
                168.14165153054944,
                -14.55828374002868
              ],
              [
                168.1787303879713,
                -14.498461732108586
              ],
              [
                168.18216361551038,
                -14.423329008755738
              ],
              [
                168.1670574143385,
                -14.392071644116205
              ],
              [
                168.1004528000807,
                -14.332870183530268
              ],
              [
                168.04277457742444,
                -14.31756838516983
              ],
              [
                167.97273673562756,
                -14.34218381053938
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                167.7049449875807,
                -14.178473931289005
              ],
              [
                167.51611747293225,
                -14.071266368856758
              ],
              [
                167.53328361062756,
                -14.001321270195323
              ],
              [
                167.48865165261975,
                -13.965341205840941
              ],
              [
                167.46599235086194,
                -13.970005605568378
              ],
              [
                167.44333304910413,
                -13.96734024586059
              ],
              [
                167.4371532395338,
                -13.93135487358257
              ],
              [
                167.33552970437756,
                -13.936686393983168
              ],
              [
                167.36642875222913,
                -14.092578720945673
              ],
              [
                167.29707755594006,
                -14.15583803227233
              ],
              [
                167.2833446457838,
                -14.313576440098993
              ],
              [
                167.3259166672682,
                -14.477187788365335
              ],
              [
                167.43921317605725,
                -14.51574530764646
              ],
              [
                167.69189872293225,
                -14.419338950871143
              ],
              [
                167.7722362473463,
                -14.316903065920298
              ],
              [
                167.8045085862135,
                -14.300269444101406
              ],
              [
                167.79626884011975,
                -14.20709845030668
              ],
              [
                167.75369681863538,
                -14.202438891395438
              ],
              [
                167.64795341043225,
                -14.217082896322898
              ],
              [
                167.62529410867444,
                -14.293615650621998
              ],
              [
                167.57585563211194,
                -14.383425217045811
              ],
              [
                167.5195507004713,
                -14.382760093408354
              ],
              [
                167.46118583230725,
                -14.373448154623498
              ],
              [
                167.42273368386975,
                -14.36812687259621
              ],
              [
                167.41037406472913,
                -14.386750805530454
              ],
              [
                167.4090007737135,
                -14.278311178615986
              ],
              [
                167.4247936203932,
                -14.199776243242091
              ],
              [
                167.5566295578932,
                -14.18646253292532
              ],
              [
                167.62735404519788,
                -14.211757913284135
              ],
              [
                167.74271049051038,
                -14.189125337577403
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                166.4923290207838,
                -12.681158457427639
              ],
              [
                166.51704825906506,
                -12.812424115866028
              ],
              [
                166.6021923020338,
                -12.825814738283562
              ],
              [
                166.7010692551588,
                -12.836526723282224
              ],
              [
                166.73677482156506,
                -12.713311434399063
              ],
              [
                166.73677482156506,
                -12.632921381450513
              ],
              [
                166.66536368875256,
                -12.579313954522894
              ],
              [
                166.53902091531506,
                -12.598077829620014
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                166.48958243875256,
                -13.110864678199425
              ],
              [
                166.54314078836194,
                -13.04933229943343
              ],
              [
                166.6557506516432,
                -13.085450991839792
              ],
              [
                166.69282950906506,
                -13.078762743923182
              ],
              [
                166.6942028000807,
                -13.002503918731442
              ],
              [
                166.62553824929944,
                -12.924883155073026
              ],
              [
                166.5362743332838,
                -12.916852040840798
              ],
              [
                166.45525016336194,
                -12.928898615324833
              ],
              [
                166.40031852273694,
                -13.002503918731442
              ],
              [
                166.40581168679944,
                -13.076087393964748
              ],
              [
                166.42229117898694,
                -13.109527181164534
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                166.43465079812756,
                -13.161684170803687
              ],
              [
                166.43327750711194,
                -13.251261266264184
              ],
              [
                166.46074332742444,
                -13.424973345213894
              ],
              [
                166.49370231179944,
                -13.491752315819163
              ],
              [
                166.6337779953932,
                -13.447680284538695
              ],
              [
                166.65437736062756,
                -13.399592459241214
              ],
              [
                166.63240470437756,
                -13.37020071873079
              ],
              [
                166.51704825906506,
                -13.168370162425076
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                167.51327472715886,
                -13.189843559270463
              ],
              [
                167.52699920372018,
                -13.279397369975895
              ],
              [
                167.56271320372136,
                -13.355582900508992
              ],
              [
                167.6203914263776,
                -13.372952234165885
              ],
              [
                167.70553546934636,
                -13.370948144135669
              ],
              [
                167.7735133746198,
                -13.326185796236523
              ],
              [
                167.76184040098698,
                -13.162432237800985
              ],
              [
                167.6698299029401,
                -13.12164386546672
              ],
              [
                167.56339984922917,
                -13.139698571427573
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                166.92176327399642,
                -11.463289741685113
              ],
              [
                166.83558926276595,
                -11.54201371849999
              ],
              [
                166.88983425788314,
                -11.558159501695698
              ],
              [
                166.9866512744847,
                -11.55681405528308
              ],
              [
                167.01034054450423,
                -11.583049094119064
              ],
              [
                167.1844051807347,
                -11.607263868028797
              ],
              [
                167.18097195319564,
                -11.529903771246758
              ],
              [
                167.12672695807845,
                -11.483813924071104
              ],
              [
                167.0532558887425,
                -11.462953267250253
              ],
              [
                166.98390469245345,
                -11.448147995594212
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                166.70046884838635,
                -11.063868784453076
              ],
              [
                166.61429483715588,
                -11.12046951588446
              ],
              [
                166.6215046149879,
                -11.192552146038915
              ],
              [
                166.6314609748512,
                -11.23936256859146
              ],
              [
                166.69669229809338,
                -11.253168509557373
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                166.4505298835426,
                -11.087116839795724
              ],
              [
                166.61704141918713,
                -10.984002741682174
              ],
              [
                166.53704721752698,
                -10.970858153373536
              ],
              [
                166.49825174633557,
                -10.980295352927007
              ],
              [
                166.46048624340588,
                -11.008942146028849
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                165.86186311188973,
                -10.989021195825632
              ],
              [
                165.95593354646005,
                -10.921608012719425
              ],
              [
                166.16604707185067,
                -10.873061036620056
              ],
              [
                166.35830781403817,
                -10.920933803430295
              ],
              [
                166.43864533845223,
                -10.844063932483186
              ],
              [
                166.45649812165536,
                -10.735468468050616
              ],
              [
                166.33152863923348,
                -10.611311587059005
              ],
              [
                166.10287568513192,
                -10.81641291243441
              ],
              [
                165.91061494294442,
                -10.902729574287836
              ],
              [
                165.80693147126473,
                -10.981606497809548
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        }
      ],
      "coordinates": []
    }),
    mid_mask = /* color: #ffc82d */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[78.99796411338423, 9.393414593413416],
                  [78.97307661480257, 9.360386662672044],
                  [79.01822489512847, 9.32261590936332],
                  [79.05838891807173, 9.304658850416168],
                  [79.21219751182173, 9.310757296404894],
                  [79.28360864463423, 9.329729558625655],
                  [79.32755395713423, 9.347345735196285],
                  [79.3646328145561, 9.308046889099547],
                  [79.34678003135298, 9.267388261020882],
                  [79.43879052939985, 9.188768246572351],
                  [79.51569482627485, 9.142672527409319],
                  [79.5898525411186, 9.116910553183189],
                  [79.68598291221235, 9.111486742610936],
                  [79.7546474629936, 9.125046114539263],
                  [79.87275049033735, 9.084366455507446],
                  [79.96476098838423, 9.028763456083354],
                  [80.02793237510298, 9.085722518664145],
                  [80.06089135947798, 9.23214697401912],
                  [80.04166528525923, 9.251123490305732],
                  [80.00321313682173, 9.245701732876089],
                  [79.91257592979048, 9.236213456440206],
                  [79.8645107442436, 9.214525008358972],
                  [79.83292505088423, 9.183345531553162],
                  [79.80477329349567, 9.195548002690526],
                  [79.7656337911186, 9.198257798059709],
                  [79.5155231648979, 9.384099692555669],
                  [79.52118799033735, 9.402559888711892],
                  [79.64203759971235, 9.557315627011468],
                  [79.72031518760298, 9.642621375060175],
                  [79.92834722574344, 9.851961067124606],
                  [79.87203871202122, 9.83775694173754],
                  [79.82535039957156, 9.805954529333654]]]),
            {
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[80.99884608638285, 9.012002805643293],
                  [80.98959213874751, 8.951636756224415],
                  [81.01019448322974, 8.949097887456771],
                  [81.02993725044631, 8.909712205702972],
                  [81.05053462552549, 8.881178791442442],
                  [81.08185585648305, 8.87299635292245],
                  [81.1030445421934, 8.827493988173106],
                  [81.13558691394444, 8.785762658094573],
                  [81.18772941565129, 8.741991635979058],
                  [81.2132808265173, 8.726042441983976],
                  [81.21566914246807, 8.709328967028295],
                  [81.18870356929301, 8.696178649225109],
                  [81.20021093274909, 8.681583693066433],
                  [81.21591943989726, 8.68226209885661],
                  [81.2352740637073, 8.659860895798838],
                  [81.23705318090738, 8.621166490909776],
                  [81.23728373897075, 8.59961380532489],
                  [81.25557041714035, 8.579332865506515],
                  [81.25681531639422, 8.55730919329836],
                  [81.26704945093564, 8.524398237705194],
                  [81.32586100947856, 8.538335806791341],
                  [81.3625173023139, 8.505229517601785],
                  [81.37993434321879, 8.429504959961715],
                  [81.38621519010293, 8.39522511909162],
                  [81.3771668851042, 8.384198916791563],
                  [81.37950916695088, 8.373251485504897],
                  [81.40030409861873, 8.36680412465947],
                  [81.40630284056796, 8.360390631866096],
                  [81.38500760374619, 8.344296342467326],
                  [81.38868918060756, 8.3209827530177],
                  [81.40735251308406, 8.320026848028997],
                  [81.39239399532305, 8.303412139789016],
                  [81.39384122930866, 8.29850212943608],
                  [81.40743986982937, 8.294603133603793],
                  [81.40926019975002, 8.287387305040834],
                  [81.39769144445424, 8.254011185918538],
                  [81.41222782348069, 8.223947607280106],
                  [81.43176924552034, 8.212737595683752],
                  [81.43038138813824, 8.202715240627711],
                  [81.42041074346783, 8.193032616382073],
                  [81.44275094288345, 8.184633817143197],
                  [81.44576006088478, 8.17046959472464],
                  [81.42988638235451, 8.164631657704044],
                  [81.43701539778698, 8.141377636399007],
                  [81.44798129764933, 8.116021718096981],
                  [81.46993263005696, 8.119554767422091],
                  [81.47206692237216, 8.111719345714725],
                  [81.4674691841214, 8.105507614236085],
                  [81.45531858267913, 8.100315390244331],
                  [81.4553929244679, 8.079819093854788],
                  [81.46263941663294, 8.06277164294919],
                  [81.48155787837504, 8.048783132428493],
                  [81.49632581155629, 8.031617738413876],
                  [81.51005956048891, 8.015725288635899],
                  [81.52070222886789, 8.007587391451091],
                  [81.53323298109666, 7.999959074220243],
                  [81.55048335917024, 8.00074468607576],
                  [81.56743363548675, 7.989662131331589],
                  [81.56114531923795, 7.976810593175631],
                  [81.55010486017346, 7.966984741172413],
                  [81.55279734981059, 7.952398511538996],
                  [81.5662745608551, 7.945003562068006],
                  [81.56766944983548, 7.937799123177133],
                  [81.56563112202598, 7.931274750221734],
                  [81.57750267287082, 7.9320664332271225],
                  [81.58405256583154, 7.924867074338836],
                  [81.58729789382437, 7.921153143111712],
                  [81.58462088138225, 7.917609233028913],
                  [81.56515696895121, 7.915249522345621],
                  [81.56331208002867, 7.9021995955550075],
                  [81.56060874427389, 7.890594761077233],
                  [81.57412703458608, 7.848466324480517],
                  [81.58747294795512, 7.830652969745313],
                  [81.60279515264163, 7.822703935967803],
                  [81.62137928954307, 7.836862054363534],
                  [81.62974851673482, 7.835203114450604],
                  [81.6282356278356, 7.8264551822327295],
                  [81.62765090801479, 7.816639139387493],
                  [81.61985653578843, 7.813965812040496],
                  [81.63997262249069, 7.788721299102294],
                  [81.65758261994735, 7.773036699413841],
                  [81.66717770974972, 7.771794188057835],
                  [81.6717945545288, 7.7691908808341275],
                  [81.67571232946966, 7.767017475513839],
                  [81.68057421784316, 7.76680002935566],
                  [81.6896972979307, 7.767640746704096],
                  [81.70098344787496, 7.758244866256105],
                  [81.70894369911736, 7.745892093841737],
                  [81.71584178455966, 7.734782232187239],
                  [81.72349636900391, 7.725314361133344],
                  [81.76239589107035, 7.781162387318574],
                  [81.42731288325785, 8.588581100193108],
                  [81.10321620357035, 9.009290118479278]]]),
            {
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[78.24418708721412, 8.784981929993236],
                  [78.45567390362037, 8.961373100678015],
                  [79.16978523174537, 9.042755640482724],
                  [79.11073371807349, 9.170217912456746],
                  [79.00120969477, 9.162799526034892],
                  [78.87108962110581, 9.149915240936519],
                  [78.80448982158912, 9.137678679291502],
                  [78.69359697295134, 9.128536176901132],
                  [78.61291572490943, 9.154626568152395],
                  [78.6043261271297, 9.096327986140214],
                  [78.4742133323313, 9.068522951304583],
                  [78.42902260537375, 9.132454697864064],
                  [78.37902721081996, 9.105530960358337],
                  [78.3551257638951, 9.080976934409728],
                  [78.32161525142192, 9.054385893216107],
                  [78.26736069586697, 9.014547099185943],
                  [78.28384038385764, 8.937651076285379],
                  [78.27353838363439, 8.916372695670676],
                  [78.19937897052411, 8.947907812913426],
                  [78.16505384877468, 8.894823771336144],
                  [78.18290921798142, 8.871674330998811],
                  [78.23097442664852, 8.883165108410926],
                  [78.24333383841527, 8.868873448919178],
                  [78.21913007416447, 8.859504667966222],
                  [78.17844559523468, 8.882698114191596],
                  [78.17424121016941, 8.846465679882126],
                  [78.21123456138606, 8.860438127529058],
                  [78.22204823045193, 8.838176878372945],
                  [78.19252589595321, 8.82511918820609],
                  [78.17934920261939, 8.867160189398506],
                  [78.17413302622833, 8.908529417295405],
                  [78.14282656544566, 8.825068312937358],
                  [78.18870342602378, 8.799601026368249]]]),
            {
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[79.15548688516184, 9.05229731659115],
                  [79.3805854026438, 9.091576346079124],
                  [79.6827094260813, 8.855548565017957],
                  [79.64631721416724, 8.610543522432451],
                  [79.78570625225318, 8.575238754208875],
                  [79.83995124737037, 8.542646825216357],
                  [79.88183662334693, 8.556906137455094],
                  [79.9134223167063, 8.617332523722622],
                  [79.93196174541724, 8.71372314178603],
                  [79.89556953350318, 8.787696280415473],
                  [79.89282295147193, 8.86436844462754],
                  [79.87153694072974, 8.914569874025961],
                  [79.80081245342505, 9.005457583212918],
                  [79.75412351358294, 9.034958751141648],
                  [79.71704170147193, 9.056317613252341],
                  [79.6332709495188, 9.042077528426749],
                  [79.57594074482893, 9.05225218558793],
                  [79.51379463115951, 9.07326935961852],
                  [79.48959176022119, 9.092593383921454],
                  [79.46332618633521, 9.108526424948217],
                  [79.44169685283912, 9.128187509204526],
                  [79.4080512229563, 9.170217912456746],
                  [79.29406806865943, 9.229187662595926],
                  [79.23638984600318, 9.222410030786433],
                  [79.14643928447974, 9.198009479062732],
                  [79.10867378155005, 9.16750642348255]]]),
            {
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[79.52104026133948, 9.42532130043724],
                  [79.51932413985695, 9.40508371831069],
                  [79.53923636729651, 9.387894265776762],
                  [79.52704832100294, 9.374937244292077],
                  [79.53614646251135, 9.348091853347311],
                  [79.7860854273551, 9.171890611790655],
                  [79.80668318111476, 9.202391974120417],
                  [79.8190444117301, 9.241026238284762],
                  [79.89869529063635, 9.228149058864568],
                  [79.96804648692542, 9.23560432535584],
                  [79.96289664561682, 9.278299627441584],
                  [79.96015006358557, 9.29964533106315],
                  [79.99379569346839, 9.327426677006374],
                  [80.02126151378089, 9.35859335818955],
                  [80.03224784190589, 9.408047787754402],
                  [80.00272208506995, 9.437175171795445],
                  [79.95328360850745, 9.447335308546698],
                  [79.90590506846839, 9.453431246720056],
                  [79.9010985499137, 9.401951047764353],
                  [79.87019950206214, 9.440561917336247],
                  [79.74454337413245, 9.452753925587968],
                  [79.59279471690589, 9.45546320211669],
                  [79.55640250499182, 9.462913602540349]]]),
            {
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[79.54335624034339, 9.470363841489638],
                  [79.55983573253089, 9.445980640960727],
                  [79.65321952159339, 9.443271289803116],
                  [79.62575370128089, 9.55569138495518]]]),
            {
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[79.65323188752893, 9.58056070605285],
                  [79.68207099885706, 9.558216708730082],
                  [79.69717720002893, 9.54602845514138],
                  [79.733569411943, 9.529099601912892],
                  [79.74386909456018, 9.494562139192986],
                  [79.7232697293258, 9.436314615641372],
                  [79.85647895784143, 9.428186270320548],
                  [79.89218452424768, 9.466794202436368],
                  [79.90797737092737, 9.449184103723857],
                  [79.95913263550906, 9.441058830969702],
                  [79.9917481228805, 9.434282547271883],
                  [80.03294685334924, 9.4092193868369],
                  [80.05079963655237, 9.408541978884614],
                  [80.129077224443, 9.450538758705557],
                  [80.1572296902633, 9.478308009897285],
                  [80.14607746942818, 9.504381632993677],
                  [80.11294886716072, 9.535871600207118],
                  [80.05079963655237, 9.578529494290537],
                  [80.0418732449508, 9.595455887437],
                  [80.0473664090133, 9.616443440816731],
                  [80.03912666291956, 9.627952191480059],
                  [80.02676704377893, 9.62592126396267],
                  [80.01578071565393, 9.604934298460815],
                  [80.00616767854456, 9.59477884793149],
                  [79.96908882112268, 9.576498270376469],
                  [79.93818977327112, 9.556185363434867],
                  [80.00136115998987, 9.518941886837755],
                  [80.00960090608362, 9.497271085803927],
                  [80.0308869168258, 9.487789678962644],
                  [80.03157356233362, 9.463407715030607],
                  [80.02127387971643, 9.453925372833902],
                  [80.00067451448206, 9.461375806571608],
                  [79.98900154084924, 9.469503368331058],
                  [79.9484894558883, 9.506752230168766],
                  [79.93544319123987, 9.54602845514138],
                  [79.92308357209924, 9.554154006015198],
                  [79.89973762483362, 9.550768383379188],
                  [79.83519294709924, 9.550091254812347],
                  [79.79674079866174, 9.561602257272106],
                  [79.77064826936487, 9.56837325325226],
                  [79.744555740068, 9.575821193038491],
                  [79.72738960237268, 9.597486997838216],
                  [79.69168403596643, 9.623213341613843]]]),
            {
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[79.98350837678674, 9.465439611478496],
                  [79.99998786897424, 9.496593851159709],
                  [80.01509407014612, 9.508106657922378],
                  [79.99106147737268, 9.536548400866877],
                  [79.9484894558883, 9.56092515025912],
                  [79.93269660920862, 9.564310671844083],
                  [79.91209724397424, 9.554154006015198],
                  [79.94024970979456, 9.509461080313432],
                  [79.96359565706018, 9.473567077109447]]]),
            {
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[79.63743904084924, 8.651070094507363],
                  [79.60585334748987, 8.433781282917565],
                  [79.61958625764612, 7.86146402689647],
                  [79.744555740068, 7.862824409055823],
                  [79.7280762478805, 7.919956422555794],
                  [79.689624099443, 8.019238414682487],
                  [79.68687751741174, 8.110338924637974],
                  [79.667651443193, 8.212292616228185],
                  [79.7170899197555, 8.24627137882453],
                  [79.744555740068, 8.307425784890135],
                  [79.755542068193, 8.35498373817725],
                  [79.77339485139612, 8.437856582293373],
                  [79.75828865022424, 8.490831553944115],
                  [79.7720215603805, 8.596759519727389]]]),
            {
              "system:index": "8"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[154.85009913314286, -6.116324767588611],
                  [154.66333155501786, -6.127248445782037],
                  [154.58642725814286, -6.4439362691727196],
                  [154.93249659408036, -6.520348917953579],
                  [155.02038721908036, -6.170940918953962]]]),
            {
              "system:index": "9"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[78.64062148358363, 9.165636561996289],
                  [78.82944899823207, 9.185972331329388],
                  [78.93999892498988, 9.207662532118901],
                  [79.023769676943, 9.217151576617294],
                  [79.09174758221644, 9.217151576617294],
                  [79.15629225995082, 9.25307207576648],
                  [79.1940577628805, 9.270014434974795],
                  [79.18444472577113, 9.26798139501403],
                  [79.03612929608363, 9.278824138713583],
                  [78.89399367596644, 9.273402808742958],
                  [78.62551528241175, 9.181905270753447]]]),
            {
              "system:index": "10"
            })]),
    wcmc = ee.FeatureCollection("projects/coral_atlas/global_datasets/wcmc_reefs_2018v4_dissolved");
/***** End of imports. If edited, may not auto-convert in the playground. *****/
///////////////////////////////
// Global coral atlas project - South West Pacific
// Contact: mitchell.lyons@gmail.com
// Region coordinator: Rodney Borrego (guiding JW) (rodbio2008@gmail.com)
// Description:
// - Developing a process to combine OBIA and supervised classification
// - This script loads the raw classification data (from *_classification script)
// - Then applied some cleanup and object-based relational rules
///////////////////////////////

// Table of contents
// 1. Setting constants
// 2. Data loads & vis
// 3. OBIA clean up rules
// 4. Export

// Load and libraries needed
var map_palettes = require('users/mitchest/global_reefs:Modules/colour_pals');
var pkg_vis = require('users/mitchest/global_reefs:Modules/pkg_vis');
var param_module = require('users/mitchest/global_reefs:Modules/reef_params');

// ###########################################
// SENSOR GENERICS
var sensor_params = param_module.dove;         //<------------ THIS IS WHERE YOU CHOOSE THE SENSOR
// REGION AND SENSOR SPECIFIC LOAD PATHS
var region_params = param_module.south_asia;  //<------------ THIS IS WHERE YOU CHOOSE THE REGION
//  ^^ all the data paths are in this module ^^
// ###########################################

// 1. Setting constants

// These will get written to the asset metadata 

var vars = {
  
  // analysis type
  geomorphic: true, // map geomorphic zonation (when set to true) or benthic habitat (when set to false)

  // analysis parameters
  image_data_scale: sensor_params.pixel,
  small_object_geo: ee.Number(400).int(), // smallest object szie in pixels (geomorphic)
  small_object_benthic: ee.Number(130).int(), // smallest object szie in pixels (benthic)
  smooth_radius: ee.Number(3), // radius in pixels for initial smooth 
  dist_to_land: 2000, //distance to land in meters to disallow reef crest, and convert to terrestrial reef flat
  wave_height: 0.4, //cut off height for waves in metres, Hs95 threshold
  geo_depth_cutoff: 1500,
  shallowlag_depth_cutoff: 500,
  benthic_depth_cutoff: 1000,
  
  //############
  // Clean-up stage selection
  cleanup_stage: 2, // set to 1, 2 or 3
  geo_refinement: false, // set to true to apply the refinement_mask (the other stage 3 masks will still run)
  
  /*
  - GEOMORPHIC 1: The first pass does a small object filter, just to generally clean noise and reduce the amount of cleaning needed
  -            2: The second pass runs the OBIA cleanup rules
  -            3: The third pass is the MANUAL cleanup stage, which includes AT LEAST the no_reef masking
                        - see below where it starts/ends (only that section is run)
                        - please put region specific stuff in here ONLY

  - BENTHIC 1: This is the main benthic stge - it does noise removal, no data reclaim and OBIA rules - review those if needed
            2: The second mas is the MANUAL stage - it's optional, but shuold include ALL region specific stuff
                        - see below where it starts/ends (only that section is run)
                        - please put region specific stuff in here ONLY
  */
  
  // DON'T TOUCH --->
  obia_2nd_pass: null,
  obia_clean: null, // run object-based relationship rules + small object clean up
  fast_clean: null, // run a faster (but less precise) version of the OBIA clean; only applies to geomorphic (`obia_clean: true` also)
  manual_clean: false, // apply manual touch ups
  // --------------<
  //############
  
  smooth_output: false, // run smoother over final output (includes noise removal) (should be false for second pass)
  
  // results/layers to show
  export_small_area: false,
  show_eg_area: false, // constrain the map add to the corresponding example_area polygon geomtery (you can change that)
                              // - you can either set this, or have it false and just navigate to the area you want to see (keeping in mind ALL tiles in the zoom area will calcualte)
  reproject_display: true,
  //reproject_res: ee.Number(sensor_params.pixel).pow(2),
  
  // export options
  do_export: true, // export the results?
  local_epsg: region_params.local_epsg,
  geomorph_output_name: region_params.sname + '_geo_clean', // DO NOT CHANGE - change in the pop up dialouge if you must
  benthic_output_name: region_params.sname + '_benthic_clean', // DO NOT CHANGE - change in the pop up dialouge if you must
  asset_output: region_params.asset // asset path

};


// Clean up stage auto-parameterisation (DON'T TOUCH) --->

if (vars.geomorphic) {
  var temp_outname = vars.geomorph_output_name;
  if (vars.cleanup_stage == 1) {
    vars.obia_2nd_pass = false;
    vars.obia_clean = false;
    vars.fast_clean = true;
    vars.manual_clean = false;
    vars.geomorph_output_name = temp_outname + '1';
  } else if (vars.cleanup_stage == 2) {
    vars.obia_2nd_pass = true;
    vars.obia_clean = true;
    vars.fast_clean = true;
    vars.manual_clean = false;
    vars.geomorph_output_name = temp_outname + '2';
  } else if (vars.cleanup_stage == 3) {
    vars.manual_clean = true;
    vars.obia_2nd_pass = false;
    vars.obia_clean = false;
    vars.fast_clean = false;
    vars.smooth_output = false;
    vars.do_export = false;
    vars.geomorph_output_name = temp_outname + '3';
  }
}

if (!vars.geomorphic) {
  var temp_outname = vars.benthic_output_name;
  if (vars.cleanup_stage == 1) {
    vars.obia_2nd_pass = true,
    vars.obia_clean = true, 
    vars.fast_clean = false, 
    vars.manual_clean = false;
    vars.benthic_output_name = temp_outname + '1';
  } else if (vars.cleanup_stage == 2) {
    vars.manual_clean = true;
    vars.obia_2nd_pass = false,
    vars.obia_clean = false, 
    vars.fast_clean = false,
    vars.smooth_output = false,
    vars.do_export = false;
    vars.benthic_output_name = temp_outname + '2';
  }
}
// -----------------------------------------<

/*
############################
MANUAL ADDITION
- review everything in there
- first review the reef_boundary object - as it is required for all cleanup stages
############################
*/

// This can be hand drawn or imported from elsewhere, or could just be a big box
// Reef_boundary defines export extent and can be used to clip out unwanted areas
var reef_boundary = soa_extent
Map.addLayer(reef_boundary, {}, "Manual reef outline", false);

var midMask = mid_mask
print(midMask)
Map.addLayer(midMask, {}, "midMask", false);
Map.addLayer(wcmc, {}, 'Unep layer', false)

// ############################
// This is the section to add/remove manual cleanups
// You MUST review it for each region
// ############################

if (vars.manual_clean && vars.geomorphic) {
  
  print("Doing GEOMORPHIC manual clean ups - make sure this is what you want to do");
  print("Export the manual map, check 'manual' layer in the viewer for effects");
  
  var depth = ee.ImageCollection(region_params.pixels).mosaic().select('depth');
  var depth_cont = depth.lt(900);
  Map.addLayer(depth_cont, {}, "depth contour", false);
  
  // update these values based on inspection of the layer
  var waves = ee.Image(region_params.waves)
  Map.addLayer(waves.lt(vars.wave_height), {}, vars.wave_height + "m Hs95 threshold", false)
  
  // make the image layers for the manual masking
  var not_reef = ee.Image().byte().paint(ee.Feature(mid_mask, {zone: 1}), "zone").clip(mid_mask);
  //var river = ee.Image().byte().paint(ee.Feature(rivermouth, {zone: 1}), "zone").clip(rivermouth);
  var trf_to_rc_i = ee.Image().byte().paint(ee.Feature(trf_to_rc, {zone: 1}), "zone").clip(trf_to_rc);
  var rc_to_trf_i = ee.Image().byte().paint(ee.Feature(rc_to_trf, {zone: 1}), "zone").clip(rc_to_trf);
  
  // define the manually edited map - uses the output from the second pass of cleaning
  var man_geo = ee.Image(region_params.geo_map_clean2);
  
  // "NOT REEF" CLEAN
  // remove
  man_geo = man_geo.where({
    test: not_reef.eq(1),
    value: ee.Image(0)
  });
  
   /*// "Rivermouth" CLEAN
  // remove
  man_geo = man_geo.where({
    test: river.eq(1),
    value: ee.Image(0)
  });*/
  
  // RC -> TRF
  man_geo = man_geo.where({
    test: rc_to_trf_i.eq(1)
                     .and(man_geo.eq(15)),
    value: ee.Image(16)
  });
  
  // TRF -> RC
  man_geo = man_geo.where({
    test: trf_to_rc_i.eq(1)
                     .and(man_geo.eq(16)),
    value: ee.Image(15)
  });
  
  
  // WAVE clean ############# ---> (to be integrated into RF classifier when feasible)
  // remove
  man_geo = man_geo.where({
    test: waves.lte(vars.wave_height)
               .and(man_geo.eq(22)),
    value: ee.Image(21)
  })
  
  
  if (vars.geo_refinement) {
    // make the mask image layer
    var refine = ee.Image().byte().paint(ee.Feature(refinement_mask, {zone: 1}), "zone").clip(refinement_mask);
    // apply
    man_geo = man_geo.where({
      test: refine.eq(1),
      value: ee.Image(0)
    });
  }
  
  // Add the manual layer to the map
  //var image = ee.Image(region_params.image);
  //Map.addLayer(image, {bands: ['b3','b2','b1'], min:200, max:1200}, 'Dove low tide', false);
  
  var geo_clean1 = ee.Image(region_params.geo_map_clean1);
  Map.addLayer(geo_clean1, map_palettes.geo, 'Geo clean stage 1', false);
  var geo_clean2 = ee.Image(region_params.geo_map_clean2);
  Map.addLayer(geo_clean2, map_palettes.geo, 'Geo clean stage 2', false);
  Map.addLayer(man_geo, map_palettes.geo, 'Geo clean stage 3 - MANUAL', true);
  
  // Export
  var output_name = (vars.geomorphic) ? vars.geomorph_output_name : vars.benthic_output_name;
  Export.image.toAsset({
    image: man_geo,
    description: output_name,
    assetId: vars.asset_output + 'in_out/' + output_name,
    region: reef_boundary,
    scale: vars.image_data_scale,
    crs: vars.local_epsg,
    maxPixels: 1e13,
    pyramidingPolicy: {'.default': 'mode'}
  });
  
} 

if (vars.manual_clean && !vars.geomorphic) {
  
  print("Doing BENTHIC manual clean ups - make sure this is what you want to do");
  print("Export the manual map, check 'manual' layer in the viewer for effects");
  
  var depth = ee.ImageCollection(region_params.pixels).mosaic().select('depth');
  var depth_cont = depth.lt(900);
  Map.addLayer(depth_cont, {}, "depth contour", false);
  
  // define the final geomorphic map (the manually edited geo map - stage 3)
  var geo_map = ee.Image(region_params.geo_map_clean3);
  
  var man_benthic = ee.Image(region_params.benthic_map_clean1);
  
  // define any image mask layers
  var newcal_lagoon_i = ee.Image().byte().paint(ee.Feature(newcal_lagoon, {zone: 1}), "zone").clip(newcal_lagoon);
  
  // Deep (or land or missing) in geo == masked from benthic
  man_benthic = man_benthic.where({
    test: geo_map.unmask(0).lte(2),
    value: ee.Image(0)
  });
  
  
  // Generic benthic rules
  // Coral in benthic && Deep lagoon in geo == sand
  man_benthic = man_benthic.where({
    test: man_benthic.eq(15)
                     .and(geo_map.eq(12)),
    value: ee.Image(11)
  });
    
  // BMA in benthic && inner/outer RF in geo == rubble 
  man_benthic = man_benthic.where({
    test: man_benthic.eq(18)
                     .and(geo_map.eq(13).or(geo_map.eq(14))),
    value: ee.Image(12)
  });
  
  // Sand in benthic and reef crest in geo == coral/aglae
  man_benthic = man_benthic.where({
    test: man_benthic.eq(11)
                     .and(geo_map.eq(15)),
    value: ee.Image(15)
  });
    
  // within New Caledonia: CA in benthic && BRS/PL/DL == sand
  man_benthic = man_benthic.where({
    test: man_benthic.eq(15)
                     .and(newcal_lagoon_i.eq(1))
                     .and(geo_map.gte(23).or(geo_map.eq(12))),
    value: ee.Image(11)
  });
  
  // Add the manual layer to the map
  //var image = ee.Image(region_params.image);
  //Map.addLayer(image, {bands: ['b3','b2','b1'], min:200, max:1200}, 'Dove low tide', false);
  
  var benthic_clean1 = ee.Image(region_params.benthic_map_clean1);
  Map.addLayer(geo_map, map_palettes.geo, 'Geo clean stage 3 - MANUAL', false);
  Map.addLayer(benthic_clean1, map_palettes.benthic, 'Benthic clean stage 1', false);
  Map.addLayer(man_benthic, map_palettes.benthic, 'Benthic clean stage 2 - MANUAL', true);
  
  // Export
  var output_name = (vars.geomorphic) ? vars.geomorph_output_name : vars.benthic_output_name;
  Export.image.toAsset({
    image: man_benthic,
    description: output_name,
    assetId: vars.asset_output + 'in_out/' + output_name,
    region: reef_boundary,
    scale: vars.image_data_scale,
    crs: vars.local_epsg,
    maxPixels: 1e13,
    pyramidingPolicy: {'.default': 'mode'}
  });
  
}

// ############################
// END OF MANUAL SECTION
// ############################


// 2. Data loads & vis

// load input data

// define raw geo/benthic outputs
// Run check to see if the region has been split into multiple areas

// geo
if (ee.List(region_params.geo_map).length().getInfo() > 1) {
  var geo_map_raw = ee.Image(region_params.geo_map[0]).unmask(0, false)
               .add(ee.Image(region_params.geo_map[1]).unmask(0,false))
               .selfMask();
} else {
  var geo_map_raw = ee.Image(region_params.geo_map);
}

// benthic
if (ee.List(region_params.benthic_map).length().getInfo() > 1) {
    var benthic_map = ee.Image(region_params.benthic_map[0]).unmask(0, false)
             .add(ee.Image(region_params.benthic_map[1]).unmask(0,false))
             .selfMask();
} else {
    var benthic_map = ee.Image(region_params.benthic_map);
}

// set the geo map for further processing
if (vars.geomorphic && vars.obia_2nd_pass) {
  // if it's 2nd pass, you want to make sure you're loading the latest geo clean map
  var geo_map = ee.Image(region_params.geo_map_clean1);
} else if (vars.geomorphic) {
  var geo_map = geo_map_raw;
}

var depth = ee.ImageCollection(region_params.pixels).mosaic().select('depth');
var image = ee.ImageCollection(region_params.pixels).mosaic().select('b3','b2','b1');

var display_pal = (vars.geomorphic) ? map_palettes.geo : map_palettes.benthic;
//Map.centerObject(eg_area, 11)
Map.addLayer(depth, {min:0, max:2500}, 'Depth data', false);
Map.addLayer(image, {bands: ['b3','b2','b1'], min:200, max:1200}, 'Dove low tide', false);

// load for display purposes
if (vars.geomorphic) {
  Map.addLayer(geo_map_raw, display_pal, 'Geomorphic map RAW', false);
  if (vars.cleanup_stage == 2) Map.addLayer(ee.Image(region_params.geo_map_clean1), display_pal, 'Geomorphic map - stage 1 clean', false);
}
if (!vars.geomorphic) {
  // Use the manually cleaned geomorphic map as input for the benthic clean
  var geo_map = ee.Image(region_params.geo_map_clean3);
  if (!vars.manual_clean) Map.addLayer(geo_map, map_palettes.geo, 'Final geo map (manual clean - stage 3)', false);
  Map.addLayer(benthic_map, display_pal, 'Benthic map RAW', false);
}

// 3. Object-based re-classificaiton and cleaning

/*

// if we want to retain the land/waves flags, need to add them in before makign the mask

######## Not that straight forwards - the land and bright masks are a LOT of not land and not breakign waves... =(

// add in land, for geomorphic clean up rules
  geo_map = geo_map.unmask(0).where({
    test: depth.eq(-2).and(globcover.select('landcover').neq(210)),
    value: ee.Image(1)
  })
  
  // change -3 to reef rim, hope that clouds have been handleded by masking
  geo_map = geo_map.unmask(0).where({
    test: depth.eq(-3),
    value: ee.Image(15)
  })
  
  // remask
  geo_map = geo_map.updateMask(geo_map.gt(0))

*/


/* OUTPUT EXTENT
  - to the mapping extent just so it doesn't balloon out
  - to the 'reef boundary' extent for noise/deep removal
*/  
var class_extent_mask = geo_map.gt(0);

/*

########
Initial small object clean
 - this was originally at the end, but we needed to massively reduce the number of objects to 
   iterate through in the OBIA cleaning, so this happens first now
 - future collabs with google might fix this, but need to change the parallel serialisation of vector procesing
 
 - includes a possible special case for:
      - geomorphic to clean up turbid areas over size threshold; fix shallow vs. deep lagoon
      - benthic to allow breaking waves (temporal class) to grow into surrounding class
########

*/

if (vars.geomorphic && !vars.obia_2nd_pass) {
  
  // make a smooth map with masked area as a value
  var smooth_map = geo_map
                      //.unmask(99)
                      .focal_mode({
                        radius: vars.smooth_radius, // relates to smoothness required
                        kernelType: 'circle', units: 'pixels', iterations: 2
                      });
  //smooth_map = smooth_map.updateMask(smooth_map.neq(99)).updateMask(class_extent_mask)
  
  //replace small objects with smooth underneath
  var clean_map = geo_map.where({
    test: geo_map.connectedPixelCount(vars.small_object_geo, false).lt(vars.small_object_geo), 
    value: smooth_map
  //}).updateMask(smooth_map.neq(99)).updateMask(class_extent_mask)
  }).updateMask(class_extent_mask);
  
  // shallow lagoon > 5m == deep lagoon
  clean_map = clean_map.where({
    test: clean_map.eq(11)
                   .and(depth.gt(vars.shallowlag_depth_cutoff)),
    value: ee.Image(12)
  });
  
  /*// deep lagoon == deep (to hard to differentiate deep water vs. deep lagoon effectively over large areas)
  clean_map = clean_map.where({
    test: clean_map.eq(12),
    value: ee.Image(2)
  })*/
  
  // deep water in depth data == deep (s2 + ls8 data should be good enough for this)
  clean_map = clean_map.where({
    test: depth.gt(vars.geo_depth_cutoff),
    value: ee.Image(2)
  });
  
  
  // LAND mask cleaning
  Map.addLayer(land_dist.lte(vars.dist_to_land), {}, "Land mask (dist to land)", false);
  
  // reef crest close to land -> TRF
  clean_map = clean_map.where({
    test: land_dist.lte(vars.dist_to_land)
                   .and(clean_map.eq(15)),
    value: ee.Image(16)
  });
  
  // TRF far from land -> ORF
  clean_map = clean_map.where({
    test: land_dist.gt(vars.dist_to_land)
                   .and(clean_map.eq(16)),
    value: ee.Image(14)
  });
  
  
  
  /*//CLEAN UP SMALL (but slightly larger) TURBID AREAS
  var smooth_noturbid = clean_map
                          .updateMask(clean_map.neq(3))
                          .focal_mode({
                            radius: vars.smooth_radius.multiply(1.5),
                            kernelType: 'circle', units: 'pixels', iterations: 2
                          })
  
  clean_map = clean_map.where({
    test: clean_map.eq(3).connectedPixelCount(vars.small_object_geo.multiply(10), false).lt(vars.small_object_geo.multiply(10)), 
    value: smooth_noturbid
  }).updateMask(class_extent_mask)*/
}


if (!vars.geomorphic && vars.cleanup_stage == 1) {
  
  // make a smooth map with masked area as a value, and without temporal class (basically breaking waves)
  var smooth_map = benthic_map
                      //.unmask(99)
                      .focal_mode({
                        radius: vars.smooth_radius, // relates to smoothness required
                        kernelType: 'circle', units: 'pixels', iterations: 1
                      });
  //smooth_map = smooth_map.updateMask(smooth_map.neq(99)).updateMask(class_extent_mask)
  
  //replace small objects with smooth underneath
  var clean_map = benthic_map.where({
    test: benthic_map.connectedPixelCount(vars.small_object_benthic, false).lt(vars.small_object_benthic),
    value: smooth_map
  //}).updateMask(smooth_map.neq(99)).updateMask(class_extent_mask)
  }).updateMask(class_extent_mask);
  
  
  // special case for SWP, remap separate coral (16) & algae (17) classes back to coral/algae (15)
  clean_map = clean_map.where({
    test: clean_map.eq(16), 
    value: ee.Image(15)
  });
  clean_map = clean_map.where({
    test: clean_map.eq(17), 
    value: ee.Image(15)
  });
  
  
  /*// CLEAN UP ALL TEMPORAL AREAS
  var smooth_notemp = benthic_map
                          .updateMask(benthic_map.neq(2))
                          .focal_mode({
                            radius: vars.smooth_radius.multiply(2),
                            kernelType: 'circle', units: 'pixels', iterations: 3
                          })
  
  
  clean_map = clean_map1.where({
    test: benthic_map.eq(2), 
    value: smooth_notemp
  }).updateMask(clean_map1.gte(0))
  
  // this catches any left over unmasked temporal, and assigned it back to temporal
  clean_map = clean_map.where({
    test: clean_map.unmask(99).eq(99).and(clean_map1.eq(2)),
    value: ee.Image(2)
  })*/
  
}



if (vars.geomorphic && vars.obia_2nd_pass) {
  var clean_map = geo_map;
}

if (vars.obia_clean) {
  
  if (vars.geomorphic && !vars.fast_clean) { // SHOULD TRY TO PUT THIS OUT TO A MODULE TO KEEP THE RULES THE SAME EVERYWEHRE?
    
    // #########
    // THE PLAN - vectorise one/few class/es at a time, thus only spending resources on what is actually needed to clean up
    // #########
    
    // FUNCTION that maps over feature colleciton and assigns neighbour percentages
    var set_neighbour_properties = function(f) {
      // make the 1px buffer
      var diff = f.buffer(vars.image_data_scale).difference(f, ee.ErrorMargin(0.5));
      // reduce the classes in the buffer zone
      var diff_classes = ee.Dictionary(
        clean_map.unmask(ee.Image(0)).reduceRegion({
          reducer: ee.Reducer.frequencyHistogram(),
          geometry: diff.geometry(),
          scale: vars.image_data_scale,
          maxPixels: 1e11
        }).get('classification')
      );
      // calculate the percentages
      var diff_sum = diff_classes.toArray().reduce(ee.Reducer.sum(), [0]).get([0]);
      var diff_percs = diff_classes.map(function(k,v){return(ee.Number(v).divide(diff_sum).multiply(100).toUint8())});
      
      /* NOW, we can try to do the class logic right here (see /users/mitchest/global_reefs/obia_dev),
         or we can return the neighbour % and do image logic via (painted) rasters */
      
      return(f.set(diff_percs));
    };
    
    // FUNCTION to reduce the map to vectors and map the neighbour properties function
    var reduce_neighbours = function() {
      // reduce map to vectors
      var map_fc = clean_map
            .updateMask(segment_id).updateMask(clean_map.eq(classn)) // only vectorise class/es of interest
            .reduceToVectors({
              scale: vars.image_data_scale, 
              eightConnected: false,
              bestEffort: true, 
              maxPixels: 1e13,
              tileScale: 1,
              geometry: reef_boundary
            });
      // map the function, calculate neighbour properties
      return(map_fc.map(set_neighbour_properties));
    };
    
    // first make a make size threshold, so we're not vecortising huge objects when we don't have to
    var segment_id = clean_map.connectedComponents(ee.Kernel.plus(1),vars.small_object_geo.sqrt()).select('labels');
    //Map.addLayer(segment_id.reproject(ee.Projection('EPSG:4326').atScale(ee.Number(vars.image_data_scale))))
    Map.addLayer(clean_map.updateMask(segment_id).reproject(ee.Projection('EPSG:4326').atScale(ee.Number(vars.image_data_scale))), display_pal, 'Map objects to be iterated through (OBIA)', false);
    
    // This is where we select the single or group of classes to vectorise for cleaning up
    //var classn = ee.Number(15) // one class
    var classn = clean_map.where({
      test: clean_map.neq(16) //TRF
              .and(clean_map.neq(15)) //RR
              .and(clean_map.neq(14)) //ORF
              .and(clean_map.neq(13)) //IRF
              //.and(clean_map.neq(12)) // deep L
              .and(clean_map.neq(11)), // shallow L 
      value: ee.Image(99) // 99 ensures it's ignored in logic
    });
    
    // Minimum size of object to reclass based on neighbourhood
    var max_size = ee.Number(1000).divide(vars.image_data_scale).pow(2); // the first number is the square dimension of the desired min size;
    // calculate neighbours
    var map_fc_neighbours = reduce_neighbours();
    
    // #########
    // REEF RIM
    // #########
    
    var focus_class = ee.Number(15); //RR
    
    // start the object-based neighbourhood rules
    // paint out to rasters (only paint the layers needed)
    var objsize = ee.Image(30000).paint(map_fc_neighbours, 'count').rename('count');
    //var nb24 = ee.Image().byte().paint(map_fc_neighbours, '24').unmask(0).rename('nb24') //OCL
    var nb22 = ee.Image().byte().paint(map_fc_neighbours, '22').unmask(0).rename('nb22'); //SL ex
    var nb21 = ee.Image().byte().paint(map_fc_neighbours, '21').unmask(0).rename('nb21'); //Sl sh
    var nb16 = ee.Image().byte().paint(map_fc_neighbours, '16').unmask(0).rename('nb16'); //TRF
    var nb15 = ee.Image().byte().paint(map_fc_neighbours, '15').unmask(0).rename('nb15'); //RR
    var nb14 = ee.Image().byte().paint(map_fc_neighbours, '14').unmask(0).rename('nb14'); //ORF
    var nb13 = ee.Image().byte().paint(map_fc_neighbours, '13').unmask(0).rename('nb13'); //IRF
    //var nb3 = ee.Image().byte().paint(map_fc_neighbours, '3').unmask(0).rename('nb3') //Turbid
    
    // RR surrounded by ORF --> ORF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb14.gt(75)),
      value: ee.Image(14)
    });
    
    // RR surrounded by IRF --> IRF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb13.gt(75)),
      value: ee.Image(13)
    });
    
    // RR surrounded by IRF + ORF --> IRF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb13.add(nb14).gt(75)),
      value: ee.Image(13)
    });
    
    // RR with decent border to TRF --> TRF (often dark, probably seagrass)
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb16.gt(40)),
      value: ee.Image(16)
    });
    
    /*// RR surrounded by OCL --> OCL
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb24.gt(75)),
      value: ee.Image(24)
    })*/
    
    /* with 2nd/3rd pass method, we don't really need this
    // RR surrounded by IRF + ORF --> IRF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb13.lte(75).and(nb14.lte(75))) // to ensure we're no re-writing previous rules
              .and(nb13.add(nb14).gt(75))
              .and(nb21.add(nb22).lte(0)), // to not get rid of complex reef rims (if touching slope, it's probably RR)
      value: ee.Image(13) // could try assigning to a place-holder, then deal with at the end?
    })*/
    
    /*// small RR objects touching OCL + stuff --> ORF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(objsize.lte(max_size))
              .and(nb13.lte(75).and(nb14.lte(75))) // to ensure we're no re-writing previous rules
              .and(nb24.gt(1)),
      value: ee.Image(14)
    })*/
    
    // ####
    // ORF
    // ####
    
    focus_class = ee.Number(14); // ORF
    
    //classn = ee.Number(14)
    //map_fc_neighbours = reduce_neighbours()
    //var nb22 = ee.Image().byte().paint(map_fc_neighbours, '22').unmask(0).rename('nb22') //SL ex
    //var nb21 = ee.Image().byte().paint(map_fc_neighbours, '21').unmask(0).rename('nb21') //Sl sh
    //nb15 = ee.Image().byte().paint(map_fc_neighbours, '15').unmask(0).rename('nb15') //RR
    //nb13 = ee.Image().byte().paint(map_fc_neighbours, '13').unmask(0).rename('nb13') //IRF
    //var nb1 = ee.Image().byte().paint(map_fc_neighbours, '1').unmask(0).rename('nb1') //Land
    
    // ORF surrounded by IRF --> IRF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb13.gt(75)),
      value: ee.Image(13)
    });
    
    // ORF surrounded by TRF --> TRF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb16.gt(75)),
      value: ee.Image(16)
    });
    
    // ORF surrounded by RR --> RR
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb15.gt(85)),
      value: ee.Image(15)
    });
    
    // ORF touching slope and RR --> RR
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb21.gt(0).or(nb22.gt(0)))
              .and(nb15.gt(0)),
      value: ee.Image(15)
    });
    
    /*// ORF touching land --> TRF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb1.gt(10)),
      value: ee.Image(16)
    })*/
    
    // ####
    // IRF
    // ####
    
    focus_class = ee.Number(13); // IRF
    
    //classn = ee.Number(13)
    //map_fc_neighbours = reduce_neighbours()
    //nb15 = ee.Image().byte().paint(map_fc_neighbours, '15').unmask(0).rename('nb15') //RR
    //nb14 = ee.Image().byte().paint(map_fc_neighbours, '14').unmask(0).rename('nb14') //ORF
    
    // IRF surrounded by ORF --> ORF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb14.gt(75)),
      value: ee.Image(14)
    });
    
    // IRF surrounded by TRF --> TRF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb16.gt(75)),
      value: ee.Image(16)
    });
    
    // IRF surrounded by RR --> RR
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb15.gt(85)),
      value: ee.Image(15)
    });
    
    /*// IRF touching land --> TRF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb1.gt(10)),
      value: ee.Image(16)
    })*/
    
    // ####
    // TRF
    // ####
    
    focus_class = ee.Number(16); // TRF
    
    //classn = ee.Number(16)
    //map_fc_neighbours = reduce_neighbours()
    //nb15 = ee.Image().byte().paint(map_fc_neighbours, '15').unmask(0).rename('nb15') //RR
    //nb14 = ee.Image().byte().paint(map_fc_neighbours, '14').unmask(0).rename('nb14') //ORF
    //nb13 = ee.Image().byte().paint(map_fc_neighbours, '13').unmask(0).rename('nb13') //IRF
    
    // TRF surrounded by ORF --> ORF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb14.gt(75)),
      value: ee.Image(14)
    });
    
    // TRF surrounded by IRF --> IRF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb13.gt(75)),
      value: ee.Image(13)
    });
    
    // TRF surrounded by IRF + ORF --> IRF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb13.add(nb14).gt(75)),
      value: ee.Image(13)
    });
    
    /*// TRF not touching land --> IRF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb1.lt(10)),
      value: ee.Image(13)
    })*/
    
    
    // ####
    // LAGOONS
    // ####
    
    var nb11 = ee.Image().byte().paint(map_fc_neighbours, '11').unmask(0).rename('nb11'); // shallow lag
    //var nb12 = ee.Image().byte().paint(map_fc_neighbours, '12').unmask(0).rename('nb12') //deep lag
    
    // DL touching SL --> SL
    /* 
    This is a stop-gap until we have better depth product - below are the rules we want,
    but too much band-aiding is required to make it work, so for the moment just err on the side
    of shallow lagoon when it's mixed.
    */
    /*clean_map = clean_map.where({
      test: clean_map.eq(12)
              .and(nb11.gt(0)),
      value: ee.Image(11)
    })*/
    
    /*// SL sourrounded by DL --> DL
    clean_map = clean_map.where({
      test: clean_map.eq(11)
              .and(nb12.gt(75)),
      value: ee.Image(12)
    })*/
    
    /*// DL sourrounded by SL --> SL
    clean_map = clean_map.where({
      test: clean_map.eq(12)
              .and(nb11.gt(75)),
      value: ee.Image(11)
    })*/
    
    /*// DL/SL surrounded by IRF --> IRF
    clean_map = clean_map.where({
      test: clean_map.eq(11).or(clean_map.eq(12))
              .and(objsize.lte(max_size))
              .and(nb13.gt(80)),
      value: ee.Image(13)
    })*/
    
    // SL surrounded by IRF --> IRF
    clean_map = clean_map.where({
      test: clean_map.eq(11)
              .and(objsize.lte(max_size))
              .and(nb13.gt(80)),
      value: ee.Image(13)
    });
    
    /*// DL/SL touching OCL --> OCL
    clean_map = clean_map.where({
      test: clean_map.eq(11).or(clean_map.eq(12))
              .and(nb24.gt(0)),
      value: ee.Image(24)
    })*/
    
    
    /*// ####
    // Turbid
    // ####
    
    focus_class = ee.Number(3) // turbid
    
    // Turb surrounded by IRF --> IRF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb13.gt(75)),
      value: ee.Image(13)
    })
    
    // Turb surrounded by ORF --> ORF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb14.gt(75)),
      value: ee.Image(14)
    })
    
    // Turb surrounded by TRF --> TRF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb16.gt(75)),
      value: ee.Image(16)
    })*/
  
  } else if (vars.geomorphic && vars.fast_clean) {
    print("Executing the fast version OBIA");
    
    /* fast version of the geo clean up
      - blanket version assigns the underlying most common in neighbourhood
      - mode OBIA version iterates through objects+buffers but take the mode instead of doing the class percs, to see if that speeds things up
    */
    
    
    //############
    //# blanket version
    //############
    // make a very smooth map to capture the broader neighbourhood
    var smooth_map = clean_map
                        .focal_mode({
                          radius: vars.smooth_radius.multiply(3), // relates to smoothness required
                          kernelType: 'circle', units: 'pixels', iterations: 2
                        });
    
    
    // first make a make size threshold, so we're not vectorising huge objects when we don't have t
    // - the unmask(99) captures small no data values/ data gaps
    var segment_id = clean_map.unmask(0).connectedComponents(ee.Kernel.plus(1),vars.small_object_geo.sqrt().multiply(2)).select('labels').pow(2).log().int();
    Map.addLayer(clean_map.unmask(0).updateMask(segment_id.gt(0)).reproject(ee.Projection('EPSG:4326').atScale(ee.Number(vars.image_data_scale))), display_pal, 'Map objects to be iterated through (OBIA)', false);
    
    
    // replace small objects with smooth underneath
    var clean_map = clean_map.unmask(0).where({
      test: segment_id.gt(0), 
      value: smooth_map
    }).selfMask();
    //############
    //############
    
    
    /*    
    //############
    //# mode OBIA version
    //############
    
    // #########
    // THE FASTER PLAN - vectorise one/few class/es at a time, thus only spending resources on what is actually needed to clean up
    //                 - BUT, just assign the mode of the neighbours, so save resouces even further??
    // #########
    
    // FUNCTION that maps over feature colleciton and assigns neighbour percentages
    var set_neighbour_mode = function(f) {
      // make the 1px buffer
      var diff = f.buffer(vars.image_data_scale).difference(f, ee.ErrorMargin(0.5))
      // reduce the classes in the buffer zone
      var diff_mode = ee.Number(ee.Dictionary(
        clean_map.unmask(ee.Image(0)).reduceRegion({
          reducer: ee.Reducer.mode(),
          geometry: diff.geometry(),
          scale: vars.image_data_scale,
          maxPixels: 1e11
        })).get('classification'))
      
      return(f.set('mode',diff_mode))
    }
    
    // FUNCTION to reduce the map to vectors and map the neighbour properties function
    var reduce_neighbours_mode = function() {
      // reduce map to vectors
      var map_fc = clean_map.unmask(0)
            .updateMask(classn.gt(0)) // only vectorise class/es of interest
            .reduceToVectors({
              scale: vars.image_data_scale, 
              eightConnected: false,
              bestEffort: true, 
              maxPixels: 1e13,
              tileScale: 1,
              geometry: reef_boundary
            })
      // map the function, calculate neighbour properties
      return(map_fc.map(set_neighbour_mode))
    }
    
    // first make a make size threshold, so we're not vecortising huge objects when we don't have to
    var segment_id = clean_map.unmask(0).connectedComponents(ee.Kernel.plus(1),vars.small_object_geo.sqrt()).select('labels')
    Map.addLayer(clean_map.unmask(0).updateMask(segment_id.gt(0)).reproject(ee.Projection('EPSG:4326').atScale(ee.Number(vars.image_data_scale))), display_pal, 'Map objects to be iterated through (OBIA)', false)
    
    // This is where we select the single or group of classes to vectorise for cleaning up
    var classn = segment_id.where({
      test: clean_map.neq(16) //TRF
              .and(clean_map.neq(15)) //RR
              .and(clean_map.neq(14)) //ORF
              .and(clean_map.neq(13)) //IRF
              //.and(clean_map.neq(12)) // deep L
              .and(clean_map.neq(11)) // shallow L 
              .and(clean_map.unmask(0).neq(0)), // no data values (want to reclaim the small gaps 
      value: ee.Image(0) // 99 ensures it's ignored in logic
    })
    
    // calculate neighbours
    var map_fc_neighbours = reduce_neighbours_mode()
    
    //print(map_fc_neighbours.limit(10))
    
    var mode_map = ee.Image().byte().paint(map_fc_neighbours, 'mode').unmask(0).rename('mode') // paint out the mode values to an image
    //Map.addLayer(mode_map, display_pal, "mode map", false)
    
    // replace small objects with mode underneath
    var clean_map = clean_map.unmask(0).where({
      test: segment_id.gt(0), 
      value: mode_map
    }).selfMask()
    
    //############
    //############
    */
    
  } else {
    
    if (vars.cleanup_stage == 1) {
      // BENTHIC CLEAN-UP RULES
      
      // reclaim shallow no data to surrounding class
      var smooth_map = clean_map
                          .focal_mode({
                            radius: vars.smooth_radius.multiply(3), // relates to smoothness required
                            kernelType: 'circle', units: 'pixels', iterations: 2
                          });
      
      var clean_map = clean_map.unmask(0).where({
        test: geo_map.gt(2).and(clean_map.eq(0)), 
        value: smooth_map
      }).selfMask();
      
      // cut benthic off to < 10 - 15 m
      clean_map = clean_map.where({
        test: depth.gt(vars.benthic_depth_cutoff),
        value: ee.Image(0)
      })
      
      // Deep (or land or missing) in geo == masked from benthic
      clean_map = clean_map.where({
        test: geo_map.unmask(0).lte(2),
        value: ee.Image(0)
      })
      
      // Deep lagoon in geo == masked from benthic
      clean_map = clean_map.where({
        test: geo_map.eq(12),
        value: ee.Image(0)
      })
      
      
      /*// turbid in geo == turbid (temporal - class num 2)
      // ############## ---> need to decide here whether to push geo turbid through regardless of benthic class
      clean_map = clean_map.where({
        test: geo_map.eq(3),
        value: ee.Image(2)
      })*/
      
      /*
      // Ignore in benthic + ORF in geo == rock
      clean_map = clean_map.where({
        test: clean_map.eq(0)
                       .and(geo_map.eq(14)),
        value: ee.Image(13)
      })
      
      // Ignore in benthic + IRF in geo == sand
      clean_map = clean_map.where({
        test: clean_map.eq(0)
                       .and(geo_map.eq(13)),
        value: ee.Image(11)
      })
      
      // Ignore in benthic + TRF in geo == sand
      clean_map = clean_map.where({
        test: clean_map.eq(0)
                       .and(geo_map.eq(16)),
        value: ee.Image(11)
      })
      
      // Ignore in benthic + RR in geo == rock
      */
      
      // seagrass in benthic + ORF/RR/slope in geo == coral/algae
      clean_map = clean_map.where({
        test: clean_map.eq(14)
                       .and(geo_map.eq(14).or(geo_map.eq(15)).or(geo_map.eq(21)).or(geo_map.eq(22))),
        value: ee.Image(15)
      })
      
      // ####--> CR: "Seagrass neighbouring deep water or no data not shallow a rock or coral algae class"
      
      /*// rock in benthic + TRF in geo == sand
      clean_map = clean_map.where({
        test: clean_map.eq(13)
                       .and(geo_map.eq(16)),
        value: ee.Image(11)
      })*/
    }
  }
}

// final smooth
if (!vars.manual_clean) {
  if (vars.smooth_output) {
    // smooth the output lightly to make nice edges, and get rid of noise
    var noise_smooth = clean_map.unmask(99) // unmasking to a value allows us to include masked areas in the smooth, then re-mask after
                          .focal_mode({
                            radius: 2, // relates to smoothness required
                            kernelType: 'circle', units: 'pixels', iterations: 2
                          });
    clean_map = clean_map.updateMask(noise_smooth.neq(99)).updateMask(clean_map.gt(1)); // this ignores 0/land; make it .gt(2) if you want to mask deep too;
  } else {
    // just clip to the classified extent and move on
    if (vars.geomorphic) {
      clean_map = clean_map.updateMask(clean_map.gt(1)); // this ignores 0/land; make it .gt(2) if you want to mask deep too
    } else {
      clean_map = clean_map.updateMask(clean_map.gt(1)); // this ignores 0/land; make it .gt(2) if you want to mask deep too
    }
  }
}

// 4. Export data

var output_name = (vars.geomorphic) ? vars.geomorph_output_name : vars.benthic_output_name;

if (vars.do_export) {
  print("For export, the image data scale must be set to:", vars.image_data_scale);
  
  if (vars.export_small_area) {
    var export_convhull = export_small;
  } else {
    //var export_convhull = clean_map.gt(2).reduceToVectors({scale: 1000, maxPixels: 1e13, bestEffort: true, geometry: region_extent, crs: "EPSG:4326"}).geometry().convexHull({maxError: 100})
    var export_convhull = reef_boundary;
  }
  Map.addLayer(export_convhull, {}, "Export footprint", false);
  
  Export.image.toAsset({
    image: clean_map.set(vars),
    description: output_name,
    assetId: vars.asset_output + 'in_out/' + output_name,
    region: export_convhull,
    scale: vars.image_data_scale,
    crs: vars.local_epsg,
    maxPixels: 1e13,
    pyramidingPolicy: {'.default': 'mode'}
  });
  /*Export.image.toCloudStorage({
    image: clean_map,//.set(vars),
    description: 'swp_geo_clean',
    bucket: 'mitchest_unet_bucket',
    fileNamePrefix: 'swp_geo_clean',
    region: export_convhull,
    scale: 25,
    crs: 'EPSG:4326',
    maxPixels: 1e13
  })*/
  
} else {
  if (!vars.manual_clean) {
    if (vars.show_eg_area) {
      if (vars.reproject_display) {
        Map.addLayer(clean_map.clip(eg_area).reproject(ee.Projection('EPSG:4326').atScale(vars.image_data_scale)), display_pal, output_name + '_final', false);
      } else {
        Map.addLayer(clean_map.clip(eg_area), display_pal, output_name + '_final', false);
      }
    } else {
      if (vars.reproject_display) {
        Map.addLayer(clean_map.reproject(ee.Projection('EPSG:4326').atScale(vars.image_data_scale)), display_pal, output_name + '_final', true);
      } else {
        Map.addLayer(clean_map, display_pal, output_name + '_final', false);
      }
    }
  }
}

//Generate title
var title = ui.Label({
  value: 'Classes',
  style: {fontWeight: 'bold', fontSize: '12px'}
});

// generate the legend
var geo_legend = pkg_vis.discrete_legend(map_palettes.geo_atlas_names, map_palettes.geo_atlas_cols, 'Geomorphic Zone', false);
var benthic_legend = pkg_vis.discrete_legend(map_palettes.benthic_atlas_names, map_palettes.benthic_atlas_cols, 'Benthic Habitat', false);
//var mask_legend = pkg_vis.discrete_legend(["Low confidence depth","Water conditions"], ["#f7f7f7","#bababa"], 'Confidence Mask reason', false)
var legend = (vars.geomorphic) ? geo_legend : benthic_legend;
pkg_vis.add_lgds([title, legend]);//, mask_legend])
// generate the legend

Export.table.toAsset({
  collection: ee.FeatureCollection(mid_mask),
  description: "soa_mid_mask",
})