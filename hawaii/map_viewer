/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var depth_pal = {"opacity":1,"bands":["depth"],"max":5,"palette":["e4e1ff","7f89ff","3a52ff","0007ff","000258"]},
    geo = ee.Image("projects/coral_atlas/nth_cari/in_out/nth_cari_geo"),
    benthic = ee.Image("projects/coral_atlas/nth_cari/in_out/nth_cari_benthic"),
    pixels = ee.Image("projects/coral_atlas/nth_cari/in_out/nth_cari_pixels"),
    geo_train = ee.FeatureCollection("projects/coral_atlas/nth_cari/training/nth_cari_geo_training"),
    wcmc = ee.FeatureCollection("projects/coral_atlas/global_datasets/wcmc_reefs_2018v4_dissolved"),
    benthic_baha = ee.Image("projects/coral_atlas/nth_cari/in_out/nth_cari_benthic_baha"),
    benthic_cari = ee.Image("projects/coral_atlas/nth_cari/in_out/nth_cari_benthic_cari"),
    geo_clean = ee.Image("projects/coral_atlas/nth_cari/in_out/nth_cari_geo-clean3"),
    benthic_clean = ee.Image("projects/coral_atlas/nth_cari/in_out/nth_cari_benthic-clean"),
    BondariesWCMCForHI = 
    /* color: #00ffff */
    /* shown: false */
    /* locked: true */
    ee.Geometry.Polygon(
        [[[-178.98452301460918, 29.245682688458757],
          [-178.9896008920856, 28.09183309274485],
          [-178.5062024545856, 27.411255440594505],
          [-176.2210462045856, 27.11828381981855],
          [-174.4852063608356, 26.84414952724335],
          [-174.5511243295856, 25.463592275178765],
          [-173.5623547983356, 24.847045514492123],
          [-172.9910657358356, 25.721211852601478],
          [-172.5296399545856, 25.622193074195295],
          [-172.0901868295856, 24.647498100361688],
          [-170.2005383920856, 24.287509180079482],
          [-167.3221204233356, 23.46373172551175],
          [-164.67846669903568, 22.64306485701608],
          [-166.78442411354348, 21.659670946601192],
          [-168.68984316095035, 19.689403197458088],
          [-170.5960462045856, 15.982962215730796],
          [-168.9866169009752, 15.85814285567876],
          [-168.07873304700556, 20.291800334858316],
          [-163.4549329233356, 22.533342458570626],
          [-161.6092297983356, 22.39120316943024],
          [-161.0818860483356, 21.33080797247133],
          [-159.9612805795856, 20.920891177438953],
          [-159.1702649545856, 21.08499380379387],
          [-156.8191907358356, 19.705155740417748],
          [-156.4896008920856, 19.14566807569612],
          [-156.0501477670856, 18.0837039133581],
          [-154.6658704233356, 18.792418684173427],
          [-154.0945813608356, 19.994495723204004],
          [-156.0281751108356, 21.69875714966666],
          [-158.2034680795856, 22.634781085064407],
          [-162.5101087045856, 23.986736050416525],
          [-167.1683118295856, 24.587571507481186],
          [-169.3436047983356, 25.93876291772303],
          [-171.8704602670856, 26.90294876694871],
          [-173.0130383920856, 26.804933056111935],
          [-175.1224133920856, 28.710324938451418]]]),
    turbidity = ee.Image("projects/coral_atlas/hawaii/hawaii_accturb"),
    low_rrs = ee.Image("projects/coral_atlas/workflow/mapping/hawaii/hawaii_islands_low_tide_normalized_sr_jan2018_jan2020_v2_shift_mosaic/20200224T183448Z/hawaii_islands_low_tide_normalized_sr_jan2018_jan2020_v2_shift_mosaic"),
    rivermouth = /* color: #d63000 */ee.Geometry.MultiPolygon(
        [[[[-157.24561225226518, 21.08670903118609],
           [-157.24355231574174, 21.083505668270888],
           [-157.23720084479447, 21.081903960918915],
           [-157.22672950080033, 21.081583617377095],
           [-157.21763144782182, 21.082224303770264],
           [-157.20366534239312, 21.08526752641976],
           [-157.19336565977594, 21.08686919751912],
           [-157.1803193951275, 21.08462685314612],
           [-157.1696763897564, 21.085587862020766],
           [-157.15302523619195, 21.08670903118609],
           [-157.13809069639703, 21.08799035701618],
           [-157.1279626751568, 21.091674107224158],
           [-157.11337145811578, 21.09455697845126],
           [-157.10616168028375, 21.09920148662003],
           [-157.1037584210064, 21.106087903752318],
           [-157.10736330992242, 21.111372611871857],
           [-157.14942034727594, 21.10448643990089],
           [-157.18855914122125, 21.100963158615865],
           [-157.22821291929742, 21.09615854939994],
           [-157.24675234800836, 21.09135378474521],
           [-157.24675234800836, 21.089431835366884]]],
         [[[-156.99570724105507, 20.91916342061558],
           [-156.9318492088285, 20.906976603823075],
           [-156.8927104148832, 20.894628424266415],
           [-156.85082503890663, 20.871853792575678],
           [-156.84498855209023, 20.88163768427958],
           [-156.8139178428617, 20.88548690960389],
           [-156.81597777938515, 20.896873623408602],
           [-156.82284423446328, 20.917078903760917],
           [-156.82662078475624, 20.932631907531576],
           [-156.83074065780312, 20.949946754127104],
           [-156.8355471763578, 20.955878231701035],
           [-156.8633563194242, 20.957000376682267],
           [-156.8901354942289, 20.951389567610114],
           [-156.911764827725, 20.945778548150578],
           [-156.93717071151406, 20.942572156874576],
           [-156.98300429916054, 20.941449903703226],
           [-156.99793883895546, 20.938243419718876],
           [-157.0080668601957, 20.931509579864603],
           [-157.00532027816445, 20.92429441552101]]],
         [[[-156.82850905990273, 20.7749428799643],
           [-156.78800447581116, 20.787939322661675],
           [-156.78251131174866, 20.800296261084448],
           [-156.77804811594788, 20.823723520406357],
           [-156.78096635935609, 20.844740769075823],
           [-156.79126604197327, 20.848751360957856],
           [-156.80860384104554, 20.84907220369007],
           [-156.81478365061585, 20.84329692982963],
           [-156.82096346018616, 20.83736100073135],
           [-156.83160646555726, 20.812331266893775],
           [-156.83555467722718, 20.78376662142259]]],
         [[[-157.9354798103508, 21.633825912798965],
           [-157.92432182084886, 21.63063449001586],
           [-157.91659705888597, 21.630315343860264],
           [-157.89719932329027, 21.63669813302479],
           [-157.89805763017503, 21.65329206474841],
           [-157.90131919633714, 21.671638902725718],
           [-157.90595405351488, 21.688388324930262],
           [-157.92775504838792, 21.721721854704157],
           [-157.94783942949144, 21.73160878512591],
           [-157.96878211747972, 21.733043928191787],
           [-157.99573295366136, 21.731289862498738],
           [-158.00774925004808, 21.72682487142811],
           [-158.0391632820305, 21.70226494260899],
           [-158.06805544037596, 21.672448173661273],
           [-158.08590822357908, 21.644528302898415],
           [-158.07475023407713, 21.63782673019225],
           [-158.0646222128369, 21.635433236004445]]],
         [[[-159.7371470529943, 21.99324243229499],
           [-159.77800246070913, 21.9868755198193],
           [-159.7975718576818, 21.980189954259444],
           [-159.81061812233023, 21.969365037678955],
           [-159.81748457740835, 21.94834960925195],
           [-159.6887385446935, 21.87668276916244],
           [-159.63655348609976, 21.862026444978387],
           [-159.59226485084585, 21.869036179071152],
           [-159.58848830055288, 21.887514737046253],
           [-159.59157820533804, 21.90758356174716]]],
         [[[-160.15383266963985, 21.930907072196526],
           [-160.15314602413204, 21.93966495246362],
           [-160.15168690242794, 21.94619320334275],
           [-160.15529179134396, 21.961636896171242],
           [-160.1599266485217, 21.96235331541617],
           [-160.17074131526974, 21.95956722028372],
           [-160.1811268285754, 21.94953682553811],
           [-160.18859409847286, 21.936878412674925],
           [-160.17142796077755, 21.92238752604182]]]]),
    noreefmask = /* color: #0dff09 */ee.Geometry.MultiPolygon(
        [[[[-155.75950064387715, 20.11176724970261],
           [-155.4326573821584, 19.946617631774327],
           [-155.2019444915334, 19.817474101263812],
           [-155.11130728450215, 19.79938561625032],
           [-155.00144400325215, 19.812306172586883],
           [-154.9602452727834, 19.882059025130957],
           [-155.30906119075215, 20.168497274571106],
           [-155.5919591399709, 20.28447167295894],
           [-155.7897130462209, 20.390061765147262],
           [-155.8995763274709, 20.292200221431955],
           [-155.92978872981465, 20.258707062473384],
           [-155.9380284759084, 20.17623159019767],
           [-155.8885899993459, 20.16334085108873]]],
         [[[-155.3118077727834, 19.398330895725163],
           [-155.63315787043965, 19.107918804938297],
           [-155.58921255793965, 19.030042835869057],
           [-155.4546300384084, 18.985896898558423],
           [-155.24314322200215, 19.139058936972752],
           [-154.9767247649709, 19.185758121592972],
           [-154.79270376887715, 19.362057545913377],
           [-154.69931997981465, 19.429415904347064],
           [-154.72129263606465, 19.600276923919328],
           [-154.8723546477834, 19.719254774662904],
           [-154.9602452727834, 19.690811582904196],
           [-154.97947134700215, 19.732181825783826],
           [-155.08384146418965, 19.633910043421125]]],
         [[[-155.7128087493459, 19.496746342096507],
           [-156.0423985930959, 19.406102705030435],
           [-156.0423985930959, 19.30763239073769],
           [-156.05613150325215, 19.074177044353597],
           [-155.9215489837209, 18.858587312170002],
           [-155.68259634700215, 18.736383172070568],
           [-155.68808951106465, 19.058601605612775]]],
         [[[-156.41981433622445, 20.61019750052318],
           [-156.4500267385682, 20.44943843829302],
           [-156.26463245145882, 20.424988293163704],
           [-156.09983752958382, 20.509903655565786],
           [-155.7908470510682, 20.6885864665451],
           [-155.85951160184945, 20.832408263229773],
           [-156.02567981474007, 20.977375097482916],
           [-156.1863548635682, 21.067107138843895],
           [-156.28111194364632, 21.063262588218304],
           [-156.35526965849007, 21.056854783061258],
           [-156.34291003934945, 20.911964936182187]]],
         [[[-156.54947901523835, 20.620597381453944],
           [-156.6875052826296, 20.68122245561185],
           [-156.8921256439577, 20.484521719681513],
           [-156.81796792911396, 20.390581907708473],
           [-156.6394400970827, 20.37384688471071],
           [-156.48700479434834, 20.42018557413537],
           [-156.4622855560671, 20.449783547115807],
           [-156.5007377045046, 20.582260972436806]]],
         [[[-157.0435631111516, 20.898135832350654],
           [-157.18501208576097, 20.885305778496836],
           [-157.1589195564641, 20.823706268669046],
           [-157.09986804279222, 20.69914707509469],
           [-157.0325767830266, 20.631045665331353],
           [-156.93507312091722, 20.614336886412087],
           [-156.78263781818285, 20.669597383049346],
           [-156.84306262287035, 20.772354092177274]]],
         [[[-156.972495301093, 21.315166733973502],
           [-156.97043536456957, 21.156441677113254],
           [-156.88666461261644, 21.143633832499944],
           [-156.77886126788988, 21.14427425103497],
           [-156.70470355304613, 21.1506782841081],
           [-156.598960144843, 21.15131867218619],
           [-156.59621356281176, 21.261424163519425],
           [-156.68547747882738, 21.27550149684102],
           [-156.96562884601488, 21.32220299640468]]],
         [[[-157.24515661099863, 21.16366498640197],
           [-157.22867711881113, 21.193757589780102],
           [-157.24618657926035, 21.21200224852229],
           [-157.26335271695567, 21.250404685129944],
           [-157.29459508756113, 21.299993019564656],
           [-157.33888372281504, 21.301592364927615],
           [-157.37218602994395, 21.276000750979783],
           [-157.4573300729127, 21.215202833428418],
           [-157.43123754361582, 21.11210918563888],
           [-157.33579381802988, 21.102820831591774],
           [-157.30592473844004, 21.102180234026704]]]]);
/***** End of imports. If edited, may not auto-convert in the playground. *****/
// little viewing script for looking at reefs and classifications for each region. 
//From this region Hawaii onwards the map_viewer script is going to be used from the very beginning
//in the workflow 

// imports
//var pkg_vis = require('users/mitchest/global_reefs:Modules/pkg_vis')
//var map_palettes = require('users/mitchest/global_reefs:Modules/colour_pals')

// choogse where to centre (link this dynamically to map app?)
var centre_map = ee.Geometry.Point([-157.2904165142968, 20.910911768679238])
Map.centerObject(centre_map, 5)
//splitting North Cari regions


//4. add turbidity for reference
Map.addLayer(turbidity.focal_mode(5), {min:5, max:20, palette: ['#ffffe5','#fff7bc','#fee391','#fec44f','#fe9929','#ec7014','#cc4c02','#993404','#662506']}, "Accumulative turbidity (smooth)", false)
Map.addLayer(turbidity, {min:5, max:20, palette: ['#ffffe5','#fff7bc','#fee391','#fec44f','#fe9929','#ec7014','#cc4c02','#993404','#662506']}, "Accumulative turbidity", false)



// add some background data
//Map.addLayer(any_rrs, {bands: ['b3','b2','b1'], min: 66, max: 1260}, "Any tide mosaic", false)
//Map.addLayer(high_rrs, {bands: ['b3','b2','b1'], min: 66, max: 1260}, "High tide mosaic", false)

var imageVisParam = {"opacity":1,"bands":["b3","b2","b1"],"max":1536,"gamma":1};
Map.addLayer(low_rrs, imageVisParam, 'Dove sr lowtide', false)
//Map.addLayer(Artifact_layer, {color: 'ffff00'}, 'Artifact Layer', false)

//Map.addLayer(any_depth, {min: -1, max: 1200, palette:['#d0d1e6','#a6bddb','#74a9cf','#3690c0','#0570b0','#045a8d','#023858']}, "Any tide depth", false)
//Map.addLayer(high_depth, {min: -1, max: 1200, palette:['#d0d1e6','#a6bddb','#74a9cf','#3690c0','#0570b0','#045a8d','#023858']}, "High tide depth", false)
//Map.addLayer(low_depth, {min: -1, max: 1200, palette:['#d0d1e6','#a6bddb','#74a9cf','#3690c0','#0570b0','#045a8d','#023858']}, "Low tide depth", false)
//Map.addLayer(pixels.select('depth'), {min: -1, max: 2500, palette:['#d0d1e6','#a6bddb','#74a9cf','#3690c0','#0570b0','#045a8d','#023858']}, "Depth covariate (S2/LS8/Dove)", false)

/*

// nth cari
//Map.addLayer(benthic.updateMask(geo.gt(2)), map_palettes.benthic, "Nth. Cari & Baha Benthic - RAW", false)
Map.addLayer(ee.ImageCollection([benthic_baha,benthic_cari]).mosaic(), map_palettes.benthic, "Nth. Cari & Baha Benthic - RAW", false)
Map.addLayer(benthic_clean, map_palettes.benthic, "Nth. Cari & Baha Benthic - FINAL", false)
Map.addLayer(geo, map_palettes.geo, "Nth. Cari & Baha Geo - RAW", false)
Map.addLayer(geo_clean, map_palettes.geo, "Nth. Cari & Baha Geo - FINAL", false)

// wave data
var kd1 = ee.Image('users/danleeharris/reefwave/fiji_v1_kd1')
var kd2 = ee.Image('users/danleeharris/reefwave/fiji_v1_kd2')

Map.addLayer(kd1, {}, "waves - kd1", false)
Map.addLayer(kd2, {}, "waves - kd2", false)*/

// add training data / sample point distributions
// ----> possibly - points are only intermediate in the mapping script, so will have to pull those out if we want that
//Map.addLayer(ee.Image().byte().paint(fiji_training_geo_oldmaps, 'class_num'), map_palettes.geo, "Training data - geo (old maps) ", false)
//Map.addLayer(ee.Image().byte().paint(fiji_training_geo, 'class_num'), map_palettes.geo, "Training data - geo (new maps)", false)
//Map.addLayer(ee.Image().byte().paint(fiji_training_benthic, 'class_num'), map_palettes.benthic, "Training - benthic (manual curation)", false)
//Map.addLayer(geo_train, {}, "geomorphic training locations", false)

// WCMC

//Map.addLayer(Artifact_layer, {color: 'ffff00'}, 'Artifact Layer', false)
//Map.addLayer(any_depth, {min: -1, max: 1200, palette:['#d0d1e6','#a6bddb','#74a9cf','#3690c0','#0570b0','#045a8d','#023858']}, "Any tide depth", false)
//Map.addLayer(high_depth, {min: -1, max: 1200, palette:['#d0d1e6','#a6bddb','#74a9cf','#3690c0','#0570b0','#045a8d','#023858']}, "High tide depth", false)
//Map.addLayer(low_depth, {min: -1, max: 1200, palette:['#d0d1e6','#a6bddb','#74a9cf','#3690c0','#0570b0','#045a8d','#023858']}, "Low tide depth", false)
//Map.addLayer(pixels.select('depth'), {min: -1, max: 2500, palette:['#d0d1e6','#a6bddb','#74a9cf','#3690c0','#0570b0','#045a8d','#023858']}, "Depth covariate (S2/LS8/Dove)", false)
/*

// nth cari
//Map.addLayer(benthic.updateMask(geo.gt(2)), map_palettes.benthic, "Nth. Cari & Baha Benthic - RAW", false)
Map.addLayer(ee.ImageCollection([benthic_baha,benthic_cari]).mosaic(), map_palettes.benthic, "Nth. Cari & Baha Benthic - RAW", false)
Map.addLayer(benthic_clean, map_palettes.benthic, "Nth. Cari & Baha Benthic - FINAL", false)
Map.addLayer(geo, map_palettes.geo, "Nth. Cari & Baha Geo - RAW", false)
Map.addLayer(geo_clean, map_palettes.geo, "Nth. Cari & Baha Geo - FINAL", false)

// wave data
var kd1 = ee.Image('users/danleeharris/reefwave/fiji_v1_kd1')
var kd2 = ee.Image('users/danleeharris/reefwave/fiji_v1_kd2')

Map.addLayer(kd1, {}, "waves - kd1", false)
Map.addLayer(kd2, {}, "waves - kd2", false)*/
// add training data / sample point distributions
// ----> possibly - points are only intermediate in the mapping script, so will have to pull those out if we want that
//Map.addLayer(ee.Image().byte().paint(fiji_training_geo_oldmaps, 'class_num'), map_palettes.geo, "Training data - geo (old maps) ", false)
//Map.addLayer(ee.Image().byte().paint(fiji_training_geo, 'class_num'), map_palettes.geo, "Training data - geo (new maps)", false)
//Map.addLayer(ee.Image().byte().paint(fiji_training_benthic, 'class_num'), map_palettes.benthic, "Training - benthic (manual curation)", false)
//Map.addLayer(geo_train, {}, "geomorphic training locations", false)
// WCMC
//filter wcmc by hawaii extent

var wcmc=wcmc.filterBounds(BondariesWCMCForHI)

Map.addLayer(wcmc, {color:'#ffff00'}, "WCMC layer", false)

// #############
// example confidence layers

/*
// depth and nir combos
var depth_nir_flag = fiji_dove_ocean.select('b4').multiply(fiji_high_depth_ocean).gt(250000)
//Map.addLayer(depth_nir_flag, {}, "NIR flag", false)
var conf_flag = fiji_high_depth_ocean.eq(-1)
                        .or(fiji_high_depth_ocean.gt(1000))
                        .add(depth_nir_flag.eq(1))
                        .selfMask()
Map.addLayer(conf_flag, {min:1,max:2,palette:["#f7f7f7","#bababa"]}, "Confidence flag", false)

//straight depth missing/-1
var depth_flag = fiji_high_depth_ocean.gt(0).selfMask()
//Map.addLayer(depth_flag, {min:0,max:1,palette:["#ffff00"]}, "Valid depth retrievals", false)

//Map.addLayer(fiji_geo_clean.gt(0).updateMask(fiji_high_depth_ocean.lte(0)), {min:0,max:1,palette:["#ff0000"]}, "Unmapped area via original algorithm", false)
*/


/*

////////// UI SET UP //////////


//Generate title
var title = ui.Label({
  value: 'Coral Atlas map classes',
  style: {fontWeight: 'bold', fontSize: '18px'}
})

// generate the legend
var geo_legend = pkg_vis.discrete_legend(map_palettes.geo_atlas_names, map_palettes.geo_atlas_cols, 'Geomorphic Zone', false)
var benthic_legend = pkg_vis.discrete_legend(map_palettes.benthic_atlas_names, map_palettes.benthic_atlas_cols, 'Benthic Habitat', false)
//var mask_legend = pkg_vis.discrete_legend(["Low confidence depth","Water conditions"], ["#f7f7f7","#bababa"], 'Confidence Mask reason', false)
pkg_vis.add_lgds([title, geo_legend, benthic_legend])//, mask_legend])
// generate the legend




///////// LINK TO DATA EXPORT /////////
// hopefully eventually we can link this to a download link in the app?

// // map to export 
// var export_map = gbr_geo_map10
// // extent
// var export_convhull = export_map.gt(0).reduceToVectors({scale: 1000, maxPixels: 1e13, bestEffort: true, geometry: export_map.geometry().bounds()}).geometry().convexHull({maxError: 100})
// // export
// Export.image.toDrive({
//     image: export_map,
//     description: 'gbr_sent2_geo_map',
//     folder: 'GBR Mapping',
//     region: export_convhull,
//     scale: 10,
//     maxPixels: 1e13
// })

*/