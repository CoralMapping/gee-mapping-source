/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var imageVisParam = {"opacity":1,"bands":["depth"],"min":1500,"max":2500,"gamma":1},
    imageVisParam2 = {"opacity":1,"bands":["b3","b2","b1"],"min":44.94,"max":2202.06,"gamma":1},
    waves = ee.Image("projects/coral_atlas/coral_sea/in_out/cosea_waves"),
    wavespng = ee.Image("projects/coral_atlas/png_solomons/in_out/pns_waves"),
    wcmc = ee.FeatureCollection("projects/coral_atlas/global_datasets/wcmc_reefs_2018v4_dissolved"),
    midMask = /* color: #15d623 */ee.Geometry({
      "type": "GeometryCollection",
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                114.1836661868681,
                -28.06032233118577
              ],
              [
                113.98592109753788,
                -28.149958979225445
              ],
              [
                113.93099201841366,
                -28.29757442089106
              ],
              [
                113.89803477459687,
                -28.59942534714115
              ],
              [
                113.94197816380685,
                -28.681379425637143
              ],
              [
                114.04359722536742,
                -28.912432857086305
              ],
              [
                113.98866817328616,
                -29.00855374403404
              ],
              [
                113.74972660573967,
                -29.0661835563608
              ],
              [
                114.36493259739895,
                -30.021905267375896
              ],
              [
                114.88401168509729,
                -30.031416884215687
              ],
              [
                114.99974312829477,
                -30.026070516607547
              ],
              [
                115.00760720732957,
                -29.928526985624377
              ],
              [
                115.00120255843638,
                -29.867675270621586
              ],
              [
                114.97825897857251,
                -29.75975361075793
              ],
              [
                114.93240702685796,
                -29.76077813970033
              ],
              [
                114.89909283248286,
                -29.82535815480512
              ],
              [
                114.84828401828509,
                -29.80793695001803
              ],
              [
                114.84144409526559,
                -29.772500592397247
              ],
              [
                114.86654842118445,
                -29.752539798010364
              ],
              [
                114.89488672415692,
                -29.767893620567243
              ],
              [
                114.96853273611804,
                -29.762985915759927
              ],
              [
                115.00284250400888,
                -29.695903064880497
              ],
              [
                115.00025273751571,
                -29.66532559945509
              ],
              [
                114.99936306124128,
                -29.645476019369674
              ],
              [
                115.0172722702817,
                -29.49854766913029
              ],
              [
                114.86752847021478,
                -29.06256786138556
              ],
              [
                114.29627107023296,
                -28.091824773631906
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                113.50234545982664,
                -28.396491874993792
              ],
              [
                113.50234545982664,
                -28.595632967130076
              ],
              [
                113.61083545006102,
                -28.713732555400057
              ],
              [
                113.69460620201414,
                -28.699278530764694
              ],
              [
                113.70833911217039,
                -28.67879857836598
              ],
              [
                113.73992480552977,
                -28.657109557537577
              ],
              [
                113.73168505943602,
                -28.57754476767505
              ],
              [
                113.67812670982664,
                -28.53412039829782
              ],
              [
                113.63555468834227,
                -28.43876530955035
              ],
              [
                113.61770190513914,
                -28.417026793914967
              ],
              [
                113.59435595787352,
                -28.420650189889194
              ],
              [
                113.58336962974852,
                -28.36145253546554
              ],
              [
                113.55590380943602,
                -28.337280731161993
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                113.60122241295164,
                -28.72457176327375
              ],
              [
                113.58611621177977,
                -28.767917355301694
              ],
              [
                113.57238330162352,
                -28.884620025231996
              ],
              [
                113.74129809654539,
                -28.907463979857145
              ],
              [
                113.75640429771727,
                -28.828089708010445
              ],
              [
                113.69872607506102,
                -28.78837985254611
              ],
              [
                113.66302050865477,
                -28.716141365354744
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                113.05165387368004,
                -26.015688107377912
              ],
              [
                112.97474957680504,
                -25.865026492915984
              ],
              [
                112.89784527993004,
                -25.706748568512428
              ],
              [
                112.88411236977379,
                -25.64733995719617
              ],
              [
                112.87312604164879,
                -25.580469901665214
              ],
              [
                112.94179059243004,
                -25.459017705866607
              ],
              [
                113.05714703774254,
                -25.48629317966306
              ],
              [
                113.02418805336754,
                -25.255496922762518
              ],
              [
                113.08461285805504,
                -24.967006504908632
              ],
              [
                113.10933209633629,
                -24.687820712205422
              ],
              [
                113.11207867836754,
                -24.64538938075783
              ],
              [
                112.68635846352379,
                -24.67284659608503
              ],
              [
                112.63417340493004,
                -25.620101118087888
              ],
              [
                113.05989361977376,
                -26.245013416791
              ],
              [
                113.15327740883626,
                -26.17601663135097
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                113.16289044594566,
                -24.732732264771016
              ],
              [
                113.14778424477379,
                -24.80879537857701
              ],
              [
                113.13130475258629,
                -24.864877617980873
              ],
              [
                113.13679791664879,
                -24.937123878316612
              ],
              [
                113.1210050699691,
                -24.978833040738607
              ],
              [
                113.11757184243004,
                -24.996259547107453
              ],
              [
                113.10795880532066,
                -25.0839768797355
              ],
              [
                113.07911969399254,
                -25.243076048594684
              ],
              [
                113.07225323891441,
                -25.27660949366275
              ],
              [
                113.07431166158666,
                -25.317570503752627
              ],
              [
                113.03139642039015,
                -25.361012710144717
              ],
              [
                113.04426952243102,
                -25.4422736735502
              ],
              [
                113.04135419106282,
                -25.436386768222327
              ],
              [
                113.03517438149254,
                -25.439177113685474
              ],
              [
                112.96650983071129,
                -25.491251692027685
              ],
              [
                113.07796605718215,
                -25.903525204798587
              ],
              [
                113.2180417407759,
                -26.14539847570156
              ],
              [
                113.21306311443627,
                -26.1629614612458
              ],
              [
                113.21812670478928,
                -26.167891978339977
              ],
              [
                113.22271883724854,
                -26.170049295806194
              ],
              [
                113.21866370618392,
                -26.174979556370392
              ],
              [
                113.22216161382278,
                -26.195931265470545
              ],
              [
                113.57372411382278,
                -26.616591966350505
              ],
              [
                113.68770726811965,
                -26.712316784494284
              ],
              [
                113.9706052173384,
                -26.477771482367896
              ],
              [
                114.2727292407759,
                -26.394152613214064
              ],
              [
                114.30431493413528,
                -25.85286631221671
              ],
              [
                113.97884496343215,
                -25.419531642296313
              ],
              [
                113.76049169194778,
                -24.988092075520207
              ],
              [
                113.64376195561965,
                -24.609109417692817
              ],
              [
                113.47210057866653,
                -24.479192404774693
              ],
              [
                113.35674413335403,
                -24.535423006236403
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                113.42268414166244,
                -24.50350706509602
              ],
              [
                113.42182583477768,
                -24.499133365294387
              ],
              [
                113.42045254376205,
                -24.49554056949086
              ],
              [
                113.41804928448471,
                -24.492884958788878
              ],
              [
                113.41495937969955,
                -24.49147902453846
              ],
              [
                113.41135449078354,
                -24.489916856938887
              ],
              [
                113.40689129498276,
                -24.486480019927182
              ],
              [
                113.40586132672104,
                -24.48429289294106
              ],
              [
                113.4063763108519,
                -24.482105727934115
              ],
              [
                113.40551800396713,
                -24.479137371758192
              ],
              [
                113.40551800396713,
                -24.474606587868674
              ],
              [
                113.4038013901976,
                -24.471325573584185
              ],
              [
                113.40277142193588,
                -24.452106487238
              ],
              [
                113.40242809918198,
                -24.439760974821027
              ],
              [
                113.40156979229721,
                -24.432415602657215
              ],
              [
                113.40071148541244,
                -24.426632774654685
              ],
              [
                113.40071148541244,
                -24.422725308360153
              ],
              [
                113.39968151715073,
                -24.41928663791867
              ],
              [
                113.39916653301987,
                -24.417098344304428
              ],
              [
                113.39899487164291,
                -24.413346895548468
              ],
              [
                113.39899487164291,
                -24.41022060308267
              ],
              [
                113.3983082261351,
                -24.40725055353103
              ],
              [
                113.39950985577377,
                -24.40115391715592
              ],
              [
                113.40105480816635,
                -24.398808978643995
              ],
              [
                113.40174145367416,
                -24.397245662117612
              ],
              [
                113.40208477642807,
                -24.393806297659495
              ],
              [
                113.40109665241897,
                -24.390362937571673
              ],
              [
                113.40109665241897,
                -24.387548765778064
              ],
              [
                113.40212662068069,
                -24.384734531318784
              ],
              [
                113.40092499104202,
                -24.38207658568299
              ],
              [
                113.40212662068069,
                -24.380356708726044
              ],
              [
                113.40195495930374,
                -24.3775423141457
              ],
              [
                113.40143997517288,
                -24.37488421729711
              ],
              [
                113.40349991169631,
                -24.372226064573933
              ],
              [
                113.40367157307327,
                -24.370193321852337
              ],
              [
                113.4024699434346,
                -24.367691439808848
              ],
              [
                113.40349991169631,
                -24.36597136719941
              ],
              [
                113.40555984821975,
                -24.363938523963203
              ],
              [
                113.40693313923538,
                -24.35940360212072
              ],
              [
                113.40641815510452,
                -24.35596320817287
              ],
              [
                113.4057315095967,
                -24.348925747457216
              ],
              [
                113.40435821858108,
                -24.341887895544193
              ],
              [
                113.4028132661885,
                -24.336257332408415
              ],
              [
                113.40212662068069,
                -24.33156500528237
              ],
              [
                113.40212662068069,
                -24.327967436801554
              ],
              [
                113.4024699434346,
                -24.3248390333674
              ],
              [
                113.40349991169631,
                -24.322023404256385
              ],
              [
                113.40418655720413,
                -24.314827623520156
              ],
              [
                113.40555984821975,
                -24.30700565956673
              ],
              [
                113.40450916045461,
                -24.30167030230899
              ],
              [
                113.40347919219289,
                -24.298228340623712
              ],
              [
                113.40485248320851,
                -24.295881495039865
              ],
              [
                113.40365085356984,
                -24.29353460606044
              ],
              [
                113.40038928740773,
                -24.286963086080203
              ],
              [
                113.40038928740773,
                -24.284146616249544
              ],
              [
                113.39918765776906,
                -24.27866996831764
              ],
              [
                113.39695605986867,
                -24.27147172905988
              ],
              [
                113.39575443023,
                -24.263490595791783
              ],
              [
                113.39558276885305,
                -24.260986607564323
              ],
              [
                113.39386615508351,
                -24.255665468823025
              ],
              [
                113.3931795095757,
                -24.25284830521843
              ],
              [
                113.39403781646047,
                -24.250500621209184
              ],
              [
                113.3928361868218,
                -24.245335563854365
              ],
              [
                113.39180621856008,
                -24.240326823117115
              ],
              [
                113.39111957305226,
                -24.234378687417127
              ],
              [
                113.3899179434136,
                -24.229682594455575
              ],
              [
                113.3899179434136,
                -24.22670831264754
              ],
              [
                113.38940295928273,
                -24.222638130218286
              ],
              [
                113.39094791167531,
                -24.219663683868998
              ],
              [
                113.3928361868218,
                -24.222951225793004
              ],
              [
                113.39472446196828,
                -24.223107773291712
              ],
              [
                113.39747104399953,
                -24.222481582142287
              ],
              [
                113.39953098052297,
                -24.223264320597977
              ],
              [
                113.40244922393117,
                -24.223264320597977
              ],
              [
                113.40433749907766,
                -24.223107773291712
              ],
              [
                113.40605411284719,
                -24.223107773291712
              ],
              [
                113.40811404937062,
                -24.222951225793004
              ],
              [
                113.4096590017632,
                -24.221385740222157
              ],
              [
                113.41051730864797,
                -24.21982023540865
              ],
              [
                113.4125772451714,
                -24.218880923284487
              ],
              [
                113.41377887481008,
                -24.2170022782559
              ],
              [
                113.41618213408742,
                -24.215436719567993
              ],
              [
                113.41789874785695,
                -24.213401464511406
              ],
              [
                113.41978702300344,
                -24.21152273867924
              ],
              [
                113.42150363677297,
                -24.21011367612627
              ],
              [
                113.4235635732964,
                -24.207921770074314
              ],
              [
                113.42648181670461,
                -24.206356099812652
              ],
              [
                113.42819843047414,
                -24.203850987388318
              ],
              [
                113.42957172148976,
                -24.20118925149127
              ],
              [
                113.4316316580132,
                -24.199466922177752
              ],
              [
                113.43266162627492,
                -24.197587990935332
              ],
              [
                113.43489322417531,
                -24.194926124277487
              ],
              [
                113.43643817656789,
                -24.19273395707202
              ],
              [
                113.4371248220757,
                -24.190228576981735
              ],
              [
                113.43763980620656,
                -24.188036329032048
              ],
              [
                113.44021472686086,
                -24.184747886464663
              ],
              [
                113.44158801787648,
                -24.18020656452259
              ],
              [
                113.44210300200734,
                -24.176917920151006
              ],
              [
                113.44175967925344,
                -24.17362919103627
              ],
              [
                113.44090137236867,
                -24.1650154513246
              ],
              [
                113.44107303374562,
                -24.158750548372023
              ],
              [
                113.4389151340257,
                -24.149039341545866
              ],
              [
                113.4330786472093,
                -24.132747918069647
              ],
              [
                113.46251492082399,
                -24.010496156202013
              ],
              [
                113.4577084022693,
                -24.00877126018026
              ],
              [
                113.45753674089235,
                -24.00406688074608
              ],
              [
                113.45959667741579,
                -23.99748046056028
              ],
              [
                113.46131329118532,
                -23.994500778784605
              ],
              [
                113.46062664567751,
                -23.98948221146373
              ],
              [
                113.46062664567751,
                -23.984777126933423
              ],
              [
                113.46114162980837,
                -23.977876025330403
              ],
              [
                113.4654331642322,
                -23.971915685503628
              ],
              [
                113.46646313249391,
                -23.968778553797403
              ],
              [
                113.4654331642322,
                -23.965013894947642
              ],
              [
                113.46440319597048,
                -23.959994178777603
              ],
              [
                113.46371655046266,
                -23.956072389529112
              ],
              [
                113.46440319597048,
                -23.953719258727585
              ],
              [
                113.46491818010134,
                -23.948699102855294
              ],
              [
                113.46371655046266,
                -23.945561406220307
              ],
              [
                113.46457485734743,
                -23.9414822865125
              ],
              [
                113.46337322770876,
                -23.93630475657455
              ],
              [
                113.46217159807009,
                -23.924536870719614
              ],
              [
                113.4657764869861,
                -23.91622025134583
              ],
              [
                113.4683514076404,
                -23.910570921518445
              ],
              [
                113.46886639177126,
                -23.90350891193601
              ],
              [
                113.46783642350954,
                -23.896603462857744
              ],
              [
                113.47058300554079,
                -23.891267181443773
              ],
              [
                113.47607616960329,
                -23.882477532144915
              ],
              [
                113.48405929642053,
                -23.875883307130206
              ],
              [
                113.48371597366662,
                -23.86944732169806
              ],
              [
                113.48680587845178,
                -23.867092612945168
              ],
              [
                113.49264236526818,
                -23.86410992039102
              ],
              [
                113.50204384764822,
                -23.857640458799615
              ],
              [
                113.5087386413494,
                -23.849633544585046
              ],
              [
                113.51251519164236,
                -23.8422541856166
              ],
              [
                113.51320183715018,
                -23.829692608687495
              ],
              [
                113.51440346678885,
                -23.818386149341343
              ],
              [
                113.51612008055838,
                -23.809748607053557
              ],
              [
                113.51612008055838,
                -23.80268109959309
              ],
              [
                113.51577675780447,
                -23.79545613892475
              ],
              [
                113.5171500488201,
                -23.78901616143415
              ],
              [
                113.51920998534354,
                -23.783518367197548
              ],
              [
                113.51835167845877,
                -23.777391979744905
              ],
              [
                113.52229989012869,
                -23.77267917760803
              ],
              [
                113.52659142455252,
                -23.764509916079252
              ],
              [
                113.53431618651541,
                -23.754297617920194
              ],
              [
                113.5475341125408,
                -23.74581294557535
              ],
              [
                113.55646050414236,
                -23.737799136345174
              ],
              [
                113.56452858885916,
                -23.72051277174128
              ],
              [
                113.57585823973807,
                -23.70133794136689
              ],
              [
                113.58100808104666,
                -23.69127788714512
              ],
              [
                113.5856429382244,
                -23.671941544333787
              ],
              [
                113.59010545931471,
                -23.65559050184579
              ],
              [
                113.59680025301589,
                -23.643168162632527
              ],
              [
                113.60538332186354,
                -23.624925628986446
              ],
              [
                113.61224977694167,
                -23.609354560383785
              ],
              [
                113.61705629549635,
                -23.59975934448608
              ],
              [
                113.62392275057448,
                -23.59362433031709
              ],
              [
                113.63147585116042,
                -23.580094823662318
              ],
              [
                113.63902895174635,
                -23.577577552262074
              ],
              [
                113.65705339632643,
                -23.562315561222366
              ],
              [
                113.67353288851393,
                -23.55964059665347
              ],
              [
                113.70180909799603,
                -23.549412288810842
              ],
              [
                113.71125047372846,
                -23.536350369540692
              ],
              [
                113.71159379648236,
                -23.519509595842766
              ],
              [
                113.72944657968549,
                -23.518565189585157
              ],
              [
                113.73511140512494,
                -23.525490678139235
              ],
              [
                113.74815766977338,
                -23.5190373935608
              ],
              [
                113.7524492041972,
                -23.50392602641646
              ],
              [
                113.7524492041972,
                -23.49022985259466
              ],
              [
                113.75588243173627,
                -23.48424716919088
              ],
              [
                113.76549546884564,
                -23.47596792288033
              ],
              [
                113.77133195566205,
                -23.46966967288093
              ],
              [
                113.77184693979291,
                -23.457859643928995
              ],
              [
                113.771503617039,
                -23.435653929821296
              ],
              [
                113.76644089809076,
                -23.407535904013045
              ],
              [
                113.31193014340488,
                -23.285717679191002
              ],
              [
                113.00705953793613,
                -23.993882502655083
              ],
              [
                112.74613424496738,
                -24.330449090254863
              ],
              [
                112.71729513363925,
                -24.69780155229369
              ],
              [
                113.18009420590488,
                -24.753933959997397
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                113.76038251924649,
                -23.413195539362984
              ],
              [
                113.76175581026212,
                -23.27449899532824
              ],
              [
                113.74664960909024,
                -23.231599875445937
              ],
              [
                113.73291669893399,
                -23.18868696355258
              ],
              [
                113.73978315401212,
                -23.172275444736425
              ],
              [
                113.73017011690274,
                -23.141971970124082
              ],
              [
                113.71506391573087,
                -23.08134447278899
              ],
              [
                113.73428998994962,
                -23.058602106820615
              ],
              [
                113.75488935518399,
                -23.058602106820615
              ],
              [
                113.75763593721524,
                -22.982766479368728
              ],
              [
                113.74939619112149,
                -22.92080244829244
              ],
              [
                113.74115644502774,
                -22.88411650080666
              ],
              [
                113.70819746065274,
                -22.841092761177965
              ],
              [
                113.66699873018399,
                -22.765135321216576
              ],
              [
                113.59970747041837,
                -22.64478294854473
              ],
              [
                113.63541303682462,
                -22.55222990818885
              ],
              [
                113.64502607393399,
                -22.509101793470947
              ],
              [
                113.67523847627774,
                -22.479919260334814
              ],
              [
                113.76999555635587,
                -22.298342250007117
              ],
              [
                113.81119428682462,
                -22.23098437824748
              ],
              [
                113.84415327119962,
                -22.145787529776346
              ],
              [
                113.86475263643399,
                -22.0579935698916
              ],
              [
                113.89359174776212,
                -21.95104036397041
              ],
              [
                113.92929731416837,
                -21.8745958974998
              ],
              [
                114.00208173799649,
                -21.824885016842302
              ],
              [
                114.11881147432462,
                -21.780257975950843
              ],
              [
                114.17648969698087,
                -21.76750484002361
              ],
              [
                113.84415327119962,
                -21.569686601539157
              ],
              [
                113.20969282198087,
                -22.648585166156078
              ],
              [
                113.33740888643399,
                -23.317384303590728
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                114.19336839038306,
                -21.815819562970315
              ],
              [
                114.17002244311743,
                -21.85406266180376
              ],
              [
                114.15354295092993,
                -21.906311675280897
              ],
              [
                114.15079636889868,
                -21.952173067277574
              ],
              [
                114.13157029467993,
                -22.019664303622747
              ],
              [
                114.12607713061743,
                -22.052761467292566
              ],
              [
                114.10410447436743,
                -22.10239269152493
              ],
              [
                114.09037156421118,
                -22.160909648575544
              ],
              [
                114.0917448552268,
                -22.191430579023628
              ],
              [
                114.13843674975806,
                -22.233386030426864
              ],
              [
                114.12882371264868,
                -22.24228405825737
              ],
              [
                114.14255662280493,
                -22.258807467753343
              ],
              [
                114.1356901677268,
                -22.28803641436028
              ],
              [
                114.19199509936743,
                -22.295660352271124
              ],
              [
                114.18771077483291,
                -22.32345910528002
              ],
              [
                114.21243001311416,
                -22.353944622674295
              ],
              [
                114.19457722991103,
                -22.375534496331582
              ],
              [
                114.20007039397353,
                -22.416165172451514
              ],
              [
                114.19457722991103,
                -22.459322246501184
              ],
              [
                114.22616292327041,
                -22.423782101954867
              ],
              [
                114.27148152678603,
                -22.399660392331253
              ],
              [
                114.31130696623916,
                -22.38569327835451
              ],
              [
                114.33739949553603,
                -22.367914923155492
              ],
              [
                114.32503987639541,
                -22.301861166124866
              ],
              [
                114.34426595061416,
                -22.25865527073165
              ],
              [
                114.38546468108291,
                -22.23958960450348
              ],
              [
                114.38683797209853,
                -22.2154360362686
              ],
              [
                114.35525227873916,
                -22.202721961123043
              ],
              [
                114.39095784514541,
                -22.14676635643785
              ],
              [
                114.45000935881728,
                -22.13913432175446
              ],
              [
                114.48159505217666,
                -22.10478504854739
              ],
              [
                114.49532796233291,
                -22.07297270645596
              ],
              [
                114.49532796233291,
                -22.043699024136195
              ],
              [
                114.47198201506728,
                -22.01569244247311
              ],
              [
                114.50082112639541,
                -21.981313162262033
              ],
              [
                114.53240681975478,
                -21.98258661752336
              ],
              [
                114.44314290373916,
                -21.980039695575865
              ],
              [
                114.39095784514541,
                -21.95838901442042
              ],
              [
                114.36211873381728,
                -21.925269827645486
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        }
      ],
      "coordinates": []
    });
/***** End of imports. If edited, may not auto-convert in the playground. *****/
///////////////////////////////
// Global coral atlas project - WEA
// Contact: mitchell.lyons@gmail.com
// Region coordinator: Rodney Borrego (rodbio2008@gmail.com)
// Description:
// - Developing a process to combine OBIA and supervised classification
// - This script loads the raw classification data (from *_classification script)
// - Then applied some cleanup and object-based relational rules
///////////////////////////////

// Table of contents
// 1. Setting constants
// 2. Data loads & vis
// 3. OBIA clean up rules
// 4. Export

// Load and libraries needed
var map_palettes = require('users/mitchest/global_reefs:Modules/colour_pals');
var pkg_vis = require('users/mitchest/global_reefs:Modules/pkg_vis');
var param_module = require('users/mitchest/global_reefs:Modules/reef_params');

// ###########################################
// SENSOR GENERICS
var sensor_params = param_module.dove;         //<------------ THIS IS WHERE YOU CHOOSE THE SENSOR
// REGION AND SENSOR SPECIFIC LOAD PATHS
var region_params = param_module.west_australia;  //<------------ THIS IS WHERE YOU CHOOSE THE REGION
//  ^^ all the data paths are in this module ^^
// ###########################################

// 1. Setting constants

// These will get written to the asset metadata 

//Map.centerObject(geometry, 7)

var vars = {
  
  // analysis type
  geomorphic: true, // map geomorphic zonation (when set to true) or benthic habitat (when set to false)

  // analysis parameters
  image_data_scale: sensor_params.pixel,
  small_object_geo: ee.Number(400).int(), // smallest object szie in pixels (geomorphic)
  small_object_benthic: ee.Number(130).int(), // smallest object szie in pixels (benthic)
  smooth_radius: ee.Number(3), // radius in pixels for initial smooth 
  dist_to_land_ORF: 1000, //distance to land in meters to convert terrestrial reef flat to ORF
  dist_to_land_RC: 500, //distance to land in meters to convert reef crest to TRF - not used for Indo
  wave_height: 0.4, //cut off height for waves in metres, Hs95 threshold
  geo_depth_cutoff: 1200, //depth in centimetres
  shallowlag_depth_cutoff: 500, //depth in centimetres
  benthic_depth_cutoff: 750, //depth in centimetres
  
  //############
  // Clean-up stage selection
  cleanup_stage: 3, // set to 1, 2 or 3
  geo_refinement: false, // set to true to apply the refinement_mask (the other stage 3 masks will still run)
  
  /*
  - GEOMORPHIC 1: The first pass does a small object filter, just to generally clean noise and reduce the amount of cleaning needed
  -            2: The second pass runs the OBIA cleanup rules
  -            3: The third pass is the MANUAL cleanup stage, which includes AT LEAST the no_reef masking
                        - see below where it starts/ends (only that section is run)
                        - please put region specific stuff in here ONLY

  - BENTHIC 1: This is the main benthic stge - it does noise removal, no data reclaim and OBIA rules - review those if needed
            2: The second mas is the MANUAL stage - it's optional, but shuold include ALL region specific stuff
                        - see below where it starts/ends (only that section is run)
                        - please put region specific stuff in here ONLY
  */
  
  // DON'T TOUCH --->
  obia_2nd_pass: null,
  obia_clean: null, // run object-based relationship rules + small object clean up
  fast_clean: null, // run a faster (but less precise) version of the OBIA clean; only applies to geomorphic (`obia_clean: true` also)
  manual_clean: false, // apply manual touch ups
  // --------------<
  //############
  
  reproject_display: false,
  
  // export options
  do_export: false, // export the results?
  geomorph_output_name: region_params.sname + '_geo_clean', // DO NOT CHANGE - change in the pop up dialouge if you must
  benthic_output_name: region_params.sname + '_benthic_clean', // DO NOT CHANGE - change in the pop up dialouge if you must
  asset_output: region_params.asset // asset path

};


// Clean up stage auto-parameterisation (DON'T TOUCH) --->

if (vars.geomorphic) {
  var temp_outname = vars.geomorph_output_name;
  if (vars.cleanup_stage == 1) {
    vars.obia_2nd_pass = false;
    vars.obia_clean = false;
    vars.fast_clean = true;
    vars.manual_clean = false;
    vars.geomorph_output_name = temp_outname + '1';
  } else if (vars.cleanup_stage == 2) {
    vars.obia_2nd_pass = true;
    vars.obia_clean = true;
    vars.fast_clean = true;
    vars.manual_clean = false;
    vars.geomorph_output_name = temp_outname + '2';
  } else if (vars.cleanup_stage == 3) {
    vars.manual_clean = true;
    vars.obia_2nd_pass = false;
    vars.obia_clean = false;
    vars.fast_clean = false;
    vars.do_export = false;
    vars.geomorph_output_name = temp_outname + '3';
  }
}

if (!vars.geomorphic) {
  var temp_outname = vars.benthic_output_name;
  if (vars.cleanup_stage == 1) {
    vars.obia_2nd_pass = true,
    vars.obia_clean = true, 
    vars.fast_clean = false, 
    vars.manual_clean = false;
    vars.benthic_output_name = temp_outname + '1';
  } else if (vars.cleanup_stage == 2) {
    vars.manual_clean = true;
    vars.obia_2nd_pass = false,
    vars.obia_clean = false, 
    vars.fast_clean = false,
    vars.do_export = false;
    vars.benthic_output_name = temp_outname + '2';
  }
}

//Region extent is created in map viewer and exported to GEE asset
var region_extent = ee.FeatureCollection(region_params.extent_mask).geometry();
Map.addLayer(region_extent, {}, "Manual reef outline", false);
// -----------------------------------------<

//################################################################################################
//START OF CLEAN 3 - Manual Cleanup
//Review everything in this section
//This is the section to add/remove manual cleanups
//You MUST review it for each region

//###############################################################################################

if (vars.manual_clean && vars.geomorphic) {
  
  print("Doing GEOMORPHIC manual clean ups - make sure this is what you want to do");
  print("Export the manual map, check 'manual' layer in the viewer for effects");
  
  var depth = ee.Image(region_params.pixels).select('depth');
  
  // define the manually edited map - uses the output from the second pass of cleaning
  //var man_geo = ee.Image(region_params.geo_map_clean2);
  var man_geo = ee.Image(region_params.geo_map_clean2); // use this when testing for a small area
  
  // import the mid mask from asset ****only use ee.FC if mid_mask created in map viewer****
  //var mid_mask = ee.FeatureCollection(region_params.mid_mask).geometry();
  //Map.addLayer(mid_mask, {color: 'red'}, "mid mask import", true, 0.4);
  //var midmask = ee.Image().byte().paint(ee.Feature(mid_mask.dissolve(),{zone: 1}), "zone").clip(mid_mask.dissolve());
  
  // the "MID MASK" CLEAN
 // man_geo = man_geo.where({
  //  test: midmask.eq(1),
  //  value: ee.Image(0)
  //});
  
  /*
  // the "REEF MASK" CLEAN
  
  // Define a kernel for reef mask Morphological Operations
  var kernel_rm = ee.Kernel.circle({radius: vars.smooth_radius.multiply(5)});

  // Create reef mask to clean areas inside the reef - Perform an dilation of deepwater
  var reef_mask = man_geo.eq(2)
            .focal_max({kernel: kernel_rm, iterations: 2});
  var global_reef_mask = ee.Image(region_params.global_reef_mask);
  

  // Reef crest, slope, sheltered slope (within reef mask) -> Inner reef flat
  man_geo = man_geo.where({
    test: reef_mask.eq(0)
                    .and(man_geo.eq(15).or(man_geo.eq(21)).or(man_geo.eq(22))),
    value: ee.Image(13)
  });
  
  // the "DEEP WATER" CLEAN
  
  // Define a kernel for deep water Morphological Operations
  var kernel_dw = ee.Kernel.circle({radius: vars.smooth_radius.multiply(5)});

  // Create mask to clean deepwater areas - Perform an dilation of deepwater followed by a erosion
  var deepwater = man_geo.eq(2)
            .focal_max({kernel: kernel_dw, iterations: 2})
            .focal_min({kernel: kernel_dw, iterations: 2});
    
  
    // Deep lagoon (outside reef mask and global mask) -> deepwater 
  man_geo = man_geo.where({
    test: deepwater.eq(1)
                    .and(man_geo.eq(12)),
                    //.and(global_reef_mask.eq(2)),
    value: ee.Image(2)
  });
  
 
  // Reef classes in deepwater -> deepwater
  man_geo = man_geo.where({
    test: deepwater.eq(1)
                    .and(man_geo.eq(15).or(man_geo.eq(21)).or(man_geo.eq(22)).or(man_geo.eq(24))),
    value: ee.Image(2)
  });
  
  */
  
  /*
  // WAVE clean (un-comment this sectio nbased on whether you have waves or not)
  
  var waves = ee.Image(region_params.waves)
  Map.addLayer(waves.lt(vars.wave_height), {}, vars.wave_height + "m Hs95 threshold", false)
  
  man_geo = man_geo.where({
    test: waves.lte(vars.wave_height)
               .and(man_geo.eq(22)),
    value: ee.Image(21)
  })
  */
  
  
  
/*
  ##############
  
  The rest of the manual geometry paintings and rules should go here
      - make the geom, paint the layer, use it in a rule
      - consult previous regions *_cleanup script for ideas/hints/existing rules etc.
  e.g. 
  var notreefcrest = ee.Image().byte().paint(ee.Feature(not_reef_crest, {zone: 1}), "zone").clip(not_reef_crest);
  var notdeepwater = ee.Image().byte().paint(ee.Feature(not_deep_water, {zone: 1}), "zone").clip(not_deep_water);


var Brs_Sl = ee.Image().byte().paint(ee.Feature(brs_sl, {zone: 1}), "zone").clip(brs_sl);
var Sl_Brs = ee.Image().byte().paint(ee.Feature(sl_brs, {zone: 1}), "zone").clip(sl_brs);
 // var Rs_Brs = ee.Image().byte().paint(ee.Feature(rs_brs, {zone: 1}), "zone").clip(rs_brs);
var Brs_Rs = ee.Image().byte().paint(ee.Feature(brs_rs, {zone: 1}), "zone").clip(brs_rs);
 // var Rc_Brs = ee.Image().byte().paint(ee.Feature(rc_brs, {zone: 1}), "zone").clip(rc_brs)
 var Srs_Brs = ee.Image().byte().paint(ee.Feature(srs_brs, {zone: 1}), "zone").clip(srs_brs)
 var All_Brs = ee.Image().byte().paint(ee.Feature(all_brs, {zone:1}), "zone").clip(all_brs)
 // var Srs_Orf = ee.Image().byte().paint(ee.Feature(srs_orf, {zone: 1}), "zone").clip(srs_orf)  
  // Back reef slope -> shallow lagoon (inside the reef)

  man_geo = man_geo.where({
    test: Brs_Sl.eq(1)
                     .and(man_geo.eq(24)).or(man_geo.eq(12)),
    value: ee.Image(11)
  });
  

 // Shallow lagoon and deep lagoon > back reef slope (inside the reef)
  man_geo = man_geo.where({
    test:  Sl_Brs.eq(1)
                     .and(man_geo.eq(11).or(man_geo.eq(12))),
    value: ee.Image(24)
  });
  
  /*
  
// reef slope > back reef slope (outside the reef)
  man_geo = man_geo.where({
    test: Rs_Brs.eq(1)
                     .and(man_geo.eq(22)),
    value: ee.Image(24)
  });
  

 //Back reef slope > reef slope (outside the reef)
  man_geo = man_geo.where({
    test:  Brs_Rs.eq(1)
                     .and(man_geo.eq(24)),
    value: ee.Image(22)
  });
  
  //reef crest > Back reef slope (outside the reef)
 // man_geo = man_geo.where({
   // test:  Rc_Brs.eq(1)
   //                  .and(man_geo.eq(15)),
  //  value: ee.Image(24)
  //});
   
  //sheltered reef slope > Back reef slope (outside the reef)
  man_geo = man_geo.where({
    test:  Srs_Brs.eq(1)
                     .and(man_geo.eq(21)),
    value: ee.Image(24)
  });
    
  //sheltered reef slope > outer reef falt (inside the reef)
 // man_geo = man_geo.where({
   // test:  Srs_Orf.eq(1)
     //                .and(man_geo.eq(21)),
   // value: ee.Image(14)
  //}); 
  
  man_geo = man_geo.where({
    test: All_Brs.eq(1)
            .and(man_geo.eq(11)).or(man_geo.eq(12))
            .or(man_geo.eq(13)).or(man_geo.eq(15))
            .or(man_geo.eq(16)).or(man_geo.eq(21)).or(man_geo.eq(22))
            .or(man_geo.eq(23)),
    
    value: ee.Image(24)
  });
*/
  
  if (vars.geo_refinement) {
    // make the mask image layer
    var refine = ee.Image().byte().paint(ee.Feature(refinement_mask, {zone: 1}), "zone").clip(refinement_mask);
    // apply
    man_geo = man_geo.where({
      test: refine.eq(1),
      value: ee.Image(0)
    });
  }
  
  // Add data + the manual layer to the map
  var lowtide_image = ee.ImageCollection(region_params.image);
  Map.addLayer(lowtide_image, imageVisParam2, sensor_params.sname + ' low tide', false);
  var notreef_mask = ee.FeatureCollection(region_params.notreef_mask).geometry();
  Map.addLayer(notreef_mask, {}, "noReefmask", false);
  var geo_clean1 = ee.Image(region_params.geo_map_clean1);
  Map.addLayer(geo_clean1, map_palettes.geo, 'Geo clean stage 1', false);
  var geo_clean2 = ee.Image(region_params.geo_map_clean2);
  Map.addLayer(geo_clean2.updateMask(geo_clean2.gt(2)), map_palettes.geo, 'Geo clean stage 2', false);
  Map.addLayer(man_geo.updateMask(man_geo.gt(2)), map_palettes.geo, 'Geo clean stage 3', false);
  var unepClipped= wcmc.filterBounds(region_extent)
  Map.addLayer(unepClipped, {color:'#FFFF33'}, 'UNEP_layer', false)
  
 // Map.addLayer(waves, {}, 'waves', false);
 // Map.addLayer(wavespng, {}, 'wavespng', false);
  
  //Map.addLayer(man_geo.updateMask(man_geo.gt(2)), map_palettes.geo, 'Geo clean stage 3 - no DW', false);
 // Map.addLayer(global_reef_mask.updateMask(global_reef_mask.eq(1)), {palette: ['F8FF23'], opacity: 0.4}, 'global_reef_mask - land', false);
  //Map.addLayer(global_reef_mask.updateMask(global_reef_mask.eq(3)), {palette: ['0000ff'], opacity: 0.4}, 'global_reef_mask - reef', false);
  //Map.addLayer(global_reef_mask.updateMask(global_reef_mask.eq(2)), {palette: ['FF0000'], opacity: 0.4}, 'global_reef_mask - water', false);

  // display distance to land mask for assessing cut-off distances
  var distToLand = ee.Image(region_params.distToLand);
    
  //Map.addLayer(distToLand.lte(vars.dist_to_land_RC), {}, 'RC to TRF ' + vars.dist_to_land_RC + 'm', false);
 // Map.addLayer(distToLand.unmask(100000, false).lte(vars.dist_to_land_ORF), {}, 'TRF to ORF ' + vars.dist_to_land_ORF + 'm', false);
  
  // display distance to water mask
  var distToWater = ee.Image(region_params.distToWater);
    
  //Map.addLayer(distToWater.unmask(100000, false).lte(vars.dist_to_land_ORF), {}, 'distToWater ' + vars.dist_to_land_ORF + 'm', false);
  
  
  // Export
  var output_name = (vars.geomorphic) ? vars.geomorph_output_name : vars.benthic_output_name;
  Export.image.toAsset({
    image: man_geo,
    description: output_name,
    assetId: vars.asset_output + 'in_out/' + output_name,
    region: region_extent,
    scale: vars.image_data_scale,
    crs: 'EPSG:4326',
    maxPixels: 1e13,
    pyramidingPolicy: {'.default': 'mode'}
  });
  
} 

if (vars.manual_clean && !vars.geomorphic) {
  
  print("Doing BENTHIC manual clean ups - make sure this is what you want to do");
  print("Export the manual map, check 'manual' layer in the viewer for effects");
  
  var depth = ee.Image(region_params.pixels).select('depth');
  
  // define the final geomorphic map (the manually edited geo map - stage 3)
  var geo_map = ee.Image(region_params.geo_map_clean3);
  
  // define the clean benthic map to apply 2nd stage rules to
  var man_benthic = ee.Image(region_params.benthic_map_clean1);
  
  
  /*
  **Generic benthic rules**
    - should be generally applicable, but still review
  */
  
  // BMA on inner RF, outer RF,reef crest, reef slope -> rubble 
  man_benthic = man_benthic.where({
    test: man_benthic.eq(18)
                     .and(geo_map.eq(13).or(geo_map.eq(14)).or(geo_map.eq(15)).or(geo_map.eq(22))),
    value: ee.Image(12)
  });
  
  // Rubble on Outer reef flat and Reef crest -> rock 
  man_benthic = man_benthic.where({
    test: man_benthic.eq(12)
                     .and(geo_map.eq(14).or(geo_map.eq(15))),
    value: ee.Image(13)
  });
    
  // Seagrass on Back reef slope -> Sand 
  man_benthic = man_benthic.where({
    test: man_benthic.eq(14)
                     .and(geo_map.eq(24)),
    value: ee.Image(11)
  });  
  
    
  /*
  
  **Manual polygon guided rules**
   - same as per geomorphic clean section
   - add a geometry, paint the layer, create a rule
  
  */
  
  
  
     
  // Add the manual layer to the map

  var dove_image = ee.Image(region_params.image);
  Map.addLayer(dove_image, {bands: ['b3','b2','b1'], min:0, max:4000, gamma:1.5}, sensor_params.sname + ' low tide', true);
  
  var benthic_clean1 = ee.Image(region_params.benthic_map_clean1);
  var geo_clean1 = ee.Image(region_params.geo_map_clean1);
  var geo_clean2 = ee.Image(region_params.geo_map_clean2);
  Map.addLayer(geo_clean1, map_palettes.geo, 'Geo clean stage 1', false);
   Map.addLayer(geo_clean2.updateMask(geo_clean2.gt(2)), map_palettes.geo, 'Geo clean stage 2', false);
  // Map.addLayer(geo_clean2, map_palettes.geo, 'Geo clean stage 2', false);
  //Map.addLayer(geo_map.updateMask(geo_map.gt(2)), map_palettes.geo, 'Geo clean stage 3 - MANUAL', true);
  Map.addLayer(geo_map.updateMask(geo_map.gt(2)), map_palettes.geo, 'Geo clean stage 3 - MANUAL', true);
  Map.addLayer(benthic_clean1, map_palettes.benthic, 'Benthic clean stage 1', false);
  Map.addLayer(man_benthic, map_palettes.benthic, 'Benthic clean stage 2 - MANUAL', true);
  
  // Export
  var output_name = (vars.geomorphic) ? vars.geomorph_output_name : vars.benthic_output_name;
  Export.image.toAsset({
    image: man_benthic,
    description: output_name,
    assetId: vars.asset_output + 'in_out/' + output_name,
    region: region_extent,
    scale: vars.image_data_scale,
    crs: 'EPSG:4326',
    maxPixels: 1e13,
    pyramidingPolicy: {'.default': 'mode'}
  });
  
}

// #################################################################################################
// END OF MANUAL SECTION
// #################################################################################################


// 2. Data loads & vis

if (!vars.manual_clean) {

  // load input data
  
  // define raw geo/benthic outputs
  // Run check to see if the region has been split into multiple areas
  
  // geo
  if (ee.List(region_params.geo_map).length().getInfo() > 1) {
    var geo_map_raw = ee.Image(region_params.geo_map[0]).unmask(0, false)
                 .add(ee.Image(region_params.geo_map[1]).unmask(0,false))
                 .selfMask();
  } else {
    var geo_map_raw = ee.Image(region_params.geo_map);
  }
  
  // benthic
  if (ee.List(region_params.benthic_map).length().getInfo() > 1) {
      var benthic_map = ee.Image(region_params.benthic_map[0]).unmask(0, false)
               .add(ee.Image(region_params.benthic_map[1]).unmask(0,false))
               .selfMask();
  } else {
      var benthic_map = ee.Image(region_params.benthic_map);
  }
  
  // set the geo map for further processing
  if (vars.geomorphic && vars.obia_2nd_pass) {
    // if it's 2nd pass, you want to make sure you're loading the latest geo clean map
    var geo_map = ee.Image(region_params.geo_map_clean1);
  } else if (vars.geomorphic) {
    var geo_map = geo_map_raw;
  }
  
  var depth = ee.Image(region_params.pixels).select('depth');
  var low_tide_image = ee.Image(region_params.image);
  
  var display_pal = (vars.geomorphic) ? map_palettes.geo : map_palettes.benthic;
  Map.addLayer(depth, {min:0, max:2500}, 'Depth data', false);
  Map.addLayer(low_tide_image, {bands: ['b3','b2','b1'], min:0, max:3000}, sensor_params.sname + ' low tide', false);
  
  // load for display purposes
  if (vars.geomorphic) {
    Map.addLayer(geo_map_raw, display_pal, 'Geomorphic map RAW', false);
    if (vars.cleanup_stage == 2) Map.addLayer(ee.Image(region_params.geo_map_clean1), display_pal, 'Geo clean stage 1', false);
  }
  if (!vars.geomorphic) {
    // Use the manually cleaned geomorphic map as input for the benthic clean
    var geo_map = ee.Image(region_params.geo_map_clean3);
    Map.addLayer(geo_map.updateMask(geo_map.gt(2)), map_palettes.geo, 'Geo clean stage 3', false);
    Map.addLayer(benthic_map, display_pal, 'Benthic map RAW', false);
  }
  
  // 3. Object-based re-classificaiton and cleaning
  
  /* OUTPUT EXTENT
    - to the mapping extent just so it doesn't balloon out
    - to the 'reef boundary' extent for noise/deep removal
  */  
  var class_extent_mask = geo_map.gt(0);
  
  /*
  
  ########
  Initial small object clean
   - this was originally at the end, but we needed to massively reduce the number of objects to 
     iterate through in the OBIA cleaning, so this happens first now
   - future collabs with google might fix this, but need to change the parallel serialisation of vector procesing
   
   - includes a possible special case for:
        - geomorphic to clean up turbid areas over size threshold; fix shallow vs. deep lagoon
        - benthic to allow breaking waves (temporal class) to grow into surrounding class
  ########
  
  */
  
  // ##############################################################################################
  // START OF CLEAN 1
  // ##############################################################################################
  
  if (vars.geomorphic && !vars.obia_2nd_pass) {
    
    // shallow lagoon > 5m == deep lagoon//this rule is making mini deep laggoons witin BRS 
    //so I will generate another clean up1 with shallow lagoons instead (comenting this up)
    
    // = geo_map.where({
     // test: geo_map.eq(11)
                    //.and(depth.gt(vars.shallowlag_depth_cutoff)),
      //value: ee.Image(12)
    //});
    
    // deep water in depth data == deep (s2 + ls8 data should be good enough for this)
    geo_map = geo_map.where({
      test: depth.gt(vars.geo_depth_cutoff),
      value: ee.Image(2)
    });
    
    // make a smooth map with masked area as a value - *** Change to ee.kernal*** see reef mask in clean 3
    var smooth_map = geo_map
                        .focal_mode({
                          radius: vars.smooth_radius, // relates to smoothness required
                          kernelType: 'circle', units: 'pixels', iterations: 2
                        });
    
    // replace small objects with smooth underneath
    var clean_map = geo_map.where({
      test: geo_map.connectedPixelCount(vars.small_object_geo, false).lt(vars.small_object_geo), 
      value: smooth_map
    }).updateMask(class_extent_mask);
    
    // display distance to land mask for assessing cut-off distances
    var distToLand = ee.Image(region_params.distToLand);
    
    Map.addLayer(distToLand.lte(vars.dist_to_land_RC), {}, 'RC to TRF ' + vars.dist_to_land_RC + 'm', false);
    Map.addLayer(distToLand.unmask(100000, false).lte(vars.dist_to_land_ORF), {}, 'TRF to ORF ' + vars.dist_to_land_ORF + 'm', false);

    // // reef crest close to land -> TRF - Not need when using .focal masks (reef mask) as this will take care of RC inside the reef
    // clean_map = clean_map.where({
    //   test: distToLand.lte(vars.dist_to_land_RC)
    //                 .and(clean_map.eq(15)),
    //   value: ee.Image(16)
    // });
    
    // TRF outside of specified distance from land -> ORF
    clean_map = clean_map.where({
      test: distToLand.unmask(100000, false).gt(vars.dist_to_land_ORF)
                       .and(clean_map.eq(16)),
      value: ee.Image(14)
    });
  }
  
  if (!vars.geomorphic && vars.cleanup_stage == 1) {
    
    // make a smooth map with masked area as a value, and without temporal class (basically breaking waves)
    var smooth_map = benthic_map
                        .focal_mode({
                          radius: vars.smooth_radius, // relates to smoothness required
                          kernelType: 'circle', units: 'pixels', iterations: 1
                        });
    
    //replace small objects with smooth underneath
    var clean_map = benthic_map.where({
      test: benthic_map.connectedPixelCount(vars.small_object_benthic, false).lt(vars.small_object_benthic),
      value: smooth_map
    }).updateMask(class_extent_mask);
    
  }
  
  // ##############################################################################################
  // START OF CLEAN 2
  // ##############################################################################################
  
  if (vars.geomorphic && vars.obia_2nd_pass) {
    var clean_map = geo_map;
  }
  
  if (vars.obia_clean) {
    
    if (vars.geomorphic && !vars.fast_clean) { 
      
      // FUNCTION that maps over feature colleciton and assigns neighbour percentages
      var set_neighbour_properties = function(f) {
        // make the 1px buffer
        var diff = f.buffer(vars.image_data_scale).difference(f, ee.ErrorMargin(0.5));
        // reduce the classes in the buffer zone
        var diff_classes = ee.Dictionary(
          clean_map.unmask(ee.Image(0)).reduceRegion({
            reducer: ee.Reducer.frequencyHistogram(),
            geometry: diff.geometry(),
            scale: vars.image_data_scale,
            maxPixels: 1e11
          }).get('classification')
        );
        // calculate the percentages
        var diff_sum = diff_classes.toArray().reduce(ee.Reducer.sum(), [0]).get([0]);
        var diff_percs = diff_classes.map(function(k,v){return(ee.Number(v).divide(diff_sum).multiply(100).toUint8())});
        
        /* NOW, we can try to do the class logic right here (see /users/mitchest/global_reefs/obia_dev),
           or we can return the neighbour % and do image logic via (painted) rasters */
        
        return(f.set(diff_percs));
      };
      
      // FUNCTION to reduce the map to vectors and map the neighbour properties function
      var reduce_neighbours = function() {
        // reduce map to vectors
        var map_fc = clean_map
              .updateMask(segment_id).updateMask(clean_map.eq(classn)) // only vectorise class/es of interest
              .reduceToVectors({
                scale: vars.image_data_scale, 
                eightConnected: false,
                bestEffort: true, 
                maxPixels: 1e13,
                tileScale: 1,
                geometry: region_extent
              });
        // map the function, calculate neighbour properties
        return(map_fc.map(set_neighbour_properties));
      };
      
      // first make a make size threshold, so we're not vecortising huge objects when we don't have to
      var segment_id = clean_map.connectedComponents(ee.Kernel.plus(1),vars.small_object_geo.sqrt()).select('labels');
      //Map.addLayer(segment_id.reproject(ee.Projection('EPSG:4326').atScale(ee.Number(vars.image_data_scale))))
      Map.addLayer(clean_map.updateMask(segment_id).reproject(ee.Projection('EPSG:4326').atScale(ee.Number(vars.image_data_scale))), display_pal, 'Map objects to be iterated through (OBIA)', false);
      
      // This is where we select the single or group of classes to vectorise for cleaning up
      //var classn = ee.Number(15) // one class
      var classn = clean_map.where({
        test: clean_map.neq(16) //TRF
                .and(clean_map.neq(15)) //RR
                .and(clean_map.neq(14)) //ORF
                .and(clean_map.neq(13)) //IRF
                //.and(clean_map.neq(12)) // deep L
                .and(clean_map.neq(11)), // shallow L 
        value: ee.Image(99) // 99 ensures it's ignored in logic
      });
      
      // Minimum size of object to reclass based on neighbourhood
      var max_size = ee.Number(1000).divide(vars.image_data_scale).pow(2); // the first number is the square dimension of the desired min size;
      // calculate neighbours
      var map_fc_neighbours = reduce_neighbours();
      
      // #########
      // REEF RIM
      // #########
      
      var focus_class = ee.Number(15); //RR
      
      // start the object-based neighbourhood rules
      // paint out to rasters (only paint the layers needed)
      var objsize = ee.Image(30000).paint(map_fc_neighbours, 'count').rename('count');
      //var nb24 = ee.Image().byte().paint(map_fc_neighbours, '24').unmask(0).rename('nb24') //OCL
      var nb22 = ee.Image().byte().paint(map_fc_neighbours, '22').unmask(0).rename('nb22'); //SL ex
      var nb21 = ee.Image().byte().paint(map_fc_neighbours, '21').unmask(0).rename('nb21'); //Sl sh
      var nb16 = ee.Image().byte().paint(map_fc_neighbours, '16').unmask(0).rename('nb16'); //TRF
      var nb15 = ee.Image().byte().paint(map_fc_neighbours, '15').unmask(0).rename('nb15'); //RR
      var nb14 = ee.Image().byte().paint(map_fc_neighbours, '14').unmask(0).rename('nb14'); //ORF
      var nb13 = ee.Image().byte().paint(map_fc_neighbours, '13').unmask(0).rename('nb13'); //IRF
      //var nb3 = ee.Image().byte().paint(map_fc_neighbours, '3').unmask(0).rename('nb3') //Turbid
      
      // RR surrounded by ORF --> ORF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb14.gt(75)),
        value: ee.Image(14)
      });
      
      // RR surrounded by IRF --> IRF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb13.gt(75)),
        value: ee.Image(13)
      });
      
      // RR surrounded by IRF + ORF --> IRF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb13.add(nb14).gt(75)),
        value: ee.Image(13)
      });
      
      // RR with decent border to TRF --> TRF (often dark, probably seagrass)
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb16.gt(40)),
        value: ee.Image(16)
      });
      
      // RR surrounded by OCL --> OCL
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb24.gt(75)),
        value: ee.Image(24)
      })
      
      // small RR objects touching OCL + stuff --> ORF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(objsize.lte(max_size))
                .and(nb13.lte(75).and(nb14.lte(75))) // to ensure we're no re-writing previous rules
                .and(nb24.gt(1)),
        value: ee.Image(14)
      })
      
      // ####
      // ORF
      // ####
      
      focus_class = ee.Number(14); // ORF
      
      // ORF surrounded by IRF --> IRF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb13.gt(75)),
        value: ee.Image(13)
      });
      
      // ORF surrounded by TRF --> TRF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb16.gt(75)),
        value: ee.Image(16)
      });
      
      // ORF surrounded by RR --> RR
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb15.gt(85)),
        value: ee.Image(15)
      });
      
      // ORF touching slope and RR --> RR
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb21.gt(0).or(nb22.gt(0)))
                .and(nb15.gt(0)),
        value: ee.Image(15)
      });
      
      // ####
      // IRF
      // ####
      
      focus_class = ee.Number(13); // IRF
      
      // IRF surrounded by ORF --> ORF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb14.gt(75)),
        value: ee.Image(14)
      });
      
      // IRF surrounded by TRF --> TRF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb16.gt(75)),
        value: ee.Image(16)
      });
      
      // IRF surrounded by RR --> RR
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb15.gt(85)),
        value: ee.Image(15)
      });
      
      // ####
      // TRF
      // ####
      
      focus_class = ee.Number(16); // TRF
      
      // TRF surrounded by ORF --> ORF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb14.gt(75)),
        value: ee.Image(14)
      });
      
      // TRF surrounded by IRF --> IRF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb13.gt(75)),
        value: ee.Image(13)
      });
      
      // TRF surrounded by IRF + ORF --> IRF
      clean_map = clean_map.where({
        test: clean_map.eq(focus_class)
                .and(nb13.add(nb14).gt(75)),
        value: ee.Image(13)
      });
      
      // ####
      // LAGOONS
      // ####
      
      var nb11 = ee.Image().byte().paint(map_fc_neighbours, '11').unmask(0).rename('nb11'); // shallow lag
      
      // SL sourrounded by DL --> DL
      clean_map = clean_map.where({
        test: clean_map.eq(11)
                .and(nb12.gt(75)),
        value: ee.Image(12)
      })
      
      // DL sourrounded by SL --> SL
      clean_map = clean_map.where({
        test: clean_map.eq(12)
                .and(nb11.gt(75)),
        value: ee.Image(11)
      })
      
      // DL/SL surrounded by IRF --> IRF
      clean_map = clean_map.where({
        test: clean_map.eq(11).or(clean_map.eq(12))
                .and(objsize.lte(max_size))
                .and(nb13.gt(80)),
        value: ee.Image(13)
      })
      
      // SL surrounded by IRF --> IRF
      clean_map = clean_map.where({
        test: clean_map.eq(11)
                .and(objsize.lte(max_size))
                .and(nb13.gt(80)),
        value: ee.Image(13)
      });
      
    
    } else if (vars.geomorphic && vars.fast_clean) {
      print("Executing the fast version OBIA");
      
      /* fast version of the geo clean up
        - blanket version assigns the underlying most common in neighbourhood
        - mode OBIA version iterates through objects+buffers but take the mode instead of doing the class percs, to see if that speeds things up
      */
      
      
      // ## Blanket version
      
      // the "LAND MASK" CLEAN  ****to be moved to datagen for next region****
      var global_reef_mask = ee.Image(region_params.global_reef_mask);
  
      clean_map = clean_map.where({
        test: global_reef_mask.eq(1),
        value: ee.Image(0)
      });
      
      // make a very smooth map to capture the broader neighbourhood  - *** Change to ee.kernal*** see reef mask in clean 3
      var smooth_map = clean_map
                          .focal_mode({
                            radius: vars.smooth_radius.multiply(3), // relates to smoothness required
                            kernelType: 'circle', units: 'pixels', iterations: 2
                          });
      
      // first make a make size threshold, so we're not vectorising huge objects when we don't have t
      // - the unmask(99) captures small no data values/ data gaps
      var segment_id = clean_map.unmask(0).connectedComponents(ee.Kernel.plus(1),vars.small_object_geo.sqrt().multiply(2)).select('labels').pow(2).log().int();
      Map.addLayer(clean_map.unmask(0).updateMask(segment_id.gt(0)).reproject(ee.Projection('EPSG:4326').atScale(ee.Number(vars.image_data_scale))), display_pal, 'Map objects to be iterated through (OBIA)', false);
      
      // replace small objects with smooth underneath
      var clean_map = clean_map.unmask(0).where({
        test: segment_id.gt(0), 
        value: smooth_map
      }).selfMask();
      
      
      // ## mode OBIA version
      
      /* A possible faster plan
            - vectorise one/few class/es at a time, thus only spending resources on what is actually needed to clean up
            - BUT, just assign the mode of the neighbours, so save resouces even further??
      
      // FUNCTION that maps over feature colleciton and assigns neighbour percentages
      var set_neighbour_mode = function(f) {
        // make the 1px buffer
        var diff = f.buffer(vars.image_data_scale).difference(f, ee.ErrorMargin(0.5))
        // reduce the classes in the buffer zone
        var diff_mode = ee.Number(ee.Dictionary(
          clean_map.unmask(ee.Image(0)).reduceRegion({
            reducer: ee.Reducer.mode(),
            geometry: diff.geometry(),
            scale: vars.image_data_scale,
            maxPixels: 1e11
          })).get('classification'))
        
        return(f.set('mode',diff_mode))
      }
      
      // FUNCTION to reduce the map to vectors and map the neighbour properties function
      var reduce_neighbours_mode = function() {
        // reduce map to vectors
        var map_fc = clean_map.unmask(0)
              .updateMask(classn.gt(0)) // only vectorise class/es of interest
              .reduceToVectors({
                scale: vars.image_data_scale, 
                eightConnected: false,
                bestEffort: true, 
                maxPixels: 1e13,
                tileScale: 1,
                geometry: region_extent
              })
        // map the function, calculate neighbour properties
        return(map_fc.map(set_neighbour_mode))
      }
      
      // first make a make size threshold, so we're not vecortising huge objects when we don't have to
      var segment_id = clean_map.unmask(0).connectedComponents(ee.Kernel.plus(1),vars.small_object_geo.sqrt()).select('labels')
      Map.addLayer(clean_map.unmask(0).updateMask(segment_id.gt(0)).reproject(ee.Projection('EPSG:4326').atScale(ee.Number(vars.image_data_scale))), display_pal, 'Map objects to be iterated through (OBIA)', false)
      
      // This is where we select the single or group of classes to vectorise for cleaning up
      var classn = segment_id.where({
        test: clean_map.neq(16) //TRF
                .and(clean_map.neq(15)) //RR
                .and(clean_map.neq(14)) //ORF
                .and(clean_map.neq(13)) //IRF
                //.and(clean_map.neq(12)) // deep L
                .and(clean_map.neq(11)) // shallow L 
                .and(clean_map.unmask(0).neq(0)), // no data values (want to reclaim the small gaps 
        value: ee.Image(0) // 99 ensures it's ignored in logic
      })
      
      // calculate neighbours
      var map_fc_neighbours = reduce_neighbours_mode()
      
      //print(map_fc_neighbours.limit(10))
      
      var mode_map = ee.Image().byte().paint(map_fc_neighbours, 'mode').unmask(0).rename('mode') // paint out the mode values to an image
      //Map.addLayer(mode_map, display_pal, "mode map", false)
      
      // replace small objects with mode underneath
      var clean_map = clean_map.unmask(0).where({
        test: segment_id.gt(0), 
        value: mode_map
      }).selfMask()
      
      */
      
    } else {
      
      if (vars.cleanup_stage == 1) {
        // BENTHIC CLEAN-UP RULES
        
        // reclaim shallow no data to surrounding class
        var smooth_map = clean_map
                            .focal_mode({
                              radius: vars.smooth_radius.multiply(3), // relates to smoothness required
                              kernelType: 'circle', units: 'pixels', iterations: 2
                            });
        
        var clean_map = clean_map.unmask(0).where({
          test: geo_map.gt(2).and(clean_map.eq(0)), 
          value: smooth_map
        }).selfMask();
        
        // cut benthic off to < 10 - 15 m
        clean_map = clean_map.where({
          test: depth.gt(vars.benthic_depth_cutoff),
          value: ee.Image(0)
        });
        
        // Deep (or land or missing) in geo == masked from benthic
        clean_map = clean_map.where({
          test: geo_map.unmask(0).lte(2),
          value: ee.Image(0)
        });
        
      }
    }
  }
  
  // Final clip to the classified extent and move on
  if (vars.geomorphic) {
    clean_map = clean_map.updateMask(clean_map.gt(1)); // this ignores 0/land; make it .gt(2) if you want to mask deep too
  } else {
    clean_map = clean_map.updateMask(clean_map.gt(1)); // this ignores 0/land; make it .gt(2) if you want to mask deep too
  }

  
  
  // 4. Export data
  
  var output_name = (vars.geomorphic) ? vars.geomorph_output_name : vars.benthic_output_name;
  
  if (vars.do_export) {
    print("For export, the image data scale must be set to:", vars.image_data_scale);
    
    Map.addLayer(region_extent, {}, "Export footprint", false);
    
    Export.image.toAsset({
      image: clean_map.set(vars),
      description: output_name,
      assetId: vars.asset_output + 'in_out/' + output_name,
      region: region_extent,
      scale: vars.image_data_scale,
      crs: 'EPSG:4326',
      maxPixels: 1e13,
      pyramidingPolicy: {'.default': 'mode'}
    });
    
  } else {
    if (vars.reproject_display) {
      Map.addLayer(clean_map.reproject(ee.Projection('EPSG:4326').atScale(vars.image_data_scale)), display_pal, output_name, true);
    } else {
      Map.addLayer(clean_map, display_pal, output_name, false);
    }
  }

}

//Generate title
var title = ui.Label({
  value: 'Classes',
  style: {fontWeight: 'bold', fontSize: '12px'}
});

// generate the legend
var geo_legend = pkg_vis.discrete_legend(map_palettes.geo_atlas_names, map_palettes.geo_atlas_cols, 'Geomorphic Zone', false);
var benthic_legend = pkg_vis.discrete_legend(map_palettes.benthic_atlas_names, map_palettes.benthic_atlas_cols, 'Benthic Habitat', false);
//var mask_legend = pkg_vis.discrete_legend(["Low confidence depth","Water conditions"], ["#f7f7f7","#bababa"], 'Confidence Mask reason', false)
var legend = (vars.geomorphic) ? geo_legend : benthic_legend;
pkg_vis.add_lgds([title, legend]);//, mask_legend])
// generate the legend
