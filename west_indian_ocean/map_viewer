/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var depth_pal = {"opacity":1,"bands":["depth"],"max":5,"palette":["e4e1ff","7f89ff","3a52ff","0007ff","000258"]},
    wcmc = ee.FeatureCollection("projects/coral_atlas/global_datasets/wcmc_reefs_2018v4_dissolved"),
    BondariesWCMCForWIO = 
    /* color: #00ffff */
    /* shown: false */
    /* locked: true */
    ee.Geometry.Polygon(
        [[[54.701770985703206, -2.9751249685105154],
          [52.548450673203206, -4.772691629173448],
          [52.196888173203206, -5.910289150084192],
          [51.757435048203206, -8.091037974566733],
          [48.285755360703206, -8.65623438835204],
          [44.814075673203206, -9.350691639103687],
          [46.440052235703206, -10.864858654100164],
          [45.736927235703206, -11.72673086956205],
          [43.583606923203206, -10.605801768506067],
          [41.781849110703206, -10.605801768506067],
          [41.737903798203206, -12.543027437564627],
          [44.638294423203206, -13.954584744088688],
          [46.352161610703206, -13.783928424683062],
          [48.857044423203206, -10.99430318398806],
          [49.955677235703206, -10.908013101551091],
          [52.680286610703206, -10.95116128603305],
          [53.339466298203206, -8.438948520327026],
          [54.613880360703206, -6.827435160865552],
          [55.624622548203206, -6.914694536706059],
          [56.108020985703206, -11.511507059571993],
          [58.788685048203206, -15.865441173681486],
          [56.942981923203206, -19.631456469862268],
          [54.438099110703206, -20.539442163648662],
          [54.130481923203206, -21.482966628121225],
          [54.965442860703206, -22.420415520660942],
          [55.844349110703206, -22.095048738332846],
          [57.074817860703206, -21.196440284100703],
          [58.481067860703206, -20.827232047085705],
          [59.184192860703206, -17.883867297837703],
          [63.754505360703206, -20.909357190677294],
          [64.9849741107032, -20.00354040738218],
          [63.666614735703206, -19.009403584868657],
          [61.776966298203206, -19.175515382142862],
          [60.370716298203206, -18.009288625640345],
          [60.458606923203206, -15.187980739313776],
          [58.964466298203206, -15.187980739313776],
          [56.811145985703206, -11.55456509703201],
          [57.514270985703206, -10.216806458907836],
          [56.327747548203206, -9.17720313716965],
          [56.327747548203206, -7.786369242288465],
          [57.250599110703206, -7.089164748909251],
          [56.108020985703206, -5.866575713917645],
          [57.602161610703206, -5.647957630653708],
          [57.206653798203206, -4.422260866394937],
          [56.547474110703206, -3.4138941523262103]]]),
    no_reef = 
    /* color: #01ff14 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[55.2248077855843, -20.980851493012523],
          [55.33741764886555, -21.08595829180467],
          [55.4884796605843, -21.2191575703884],
          [55.5763702855843, -21.37014202611179],
          [55.5763702855843, -21.549074333518252],
          [55.95265202386555, -21.487750868105195],
          [56.05702214105305, -21.23195887279921],
          [55.8839874730843, -20.93981411727935],
          [55.6917267308968, -20.672797751973356],
          [55.42530827386555, -20.62910598668815],
          [55.1479034887093, -20.793527159750223],
          [55.1204376683968, -20.867971649301655]]]),
    low_rrs = ee.Image("projects/coral_atlas/workflow/mapping/west_indian_ocean/west_indian_ocean_islands_low_tide_normalized_sr_jan2018_jan2020_v2_shift_mosaic/20200131T210330Z/west_indian_ocean_islands_low_tide_normalized_sr_jan2018_jan2020_v2_shift_mosaic"),
    wio_geo = ee.Image("projects/coral_atlas/west_indian_ocean/in_out/wio_geo"),
    wio_benthic = ee.Image("projects/coral_atlas/west_indian_ocean/in_out/wio_benthic"),
    geoclean3 = ee.Image("projects/coral_atlas/west_indian_ocean/in_out/wio_geo-clean_man3"),
    geoclean4 = ee.Image("projects/coral_atlas/west_indian_ocean/in_out/wio_geo-clean_man4"),
    benthic_clean = ee.Image("projects/coral_atlas/west_indian_ocean/in_out/wio_benthic-clean"),
    RCtoIRF = 
    /* color: #fffe44 */
    /* shown: false */
    ee.Geometry.MultiPolygon(
        [[[[55.659204329888894, -4.334751664179756],
           [55.669160689752175, -4.329274193622515],
           [55.66529830877073, -4.323283164810927],
           [55.65182289067991, -4.329445365177744]]],
         [[[55.641437377374245, -4.348102832274304],
           [55.65422614995725, -4.352638752251315],
           [55.647445525567605, -4.339202079783282]]]]),
    SSBRStoSL = 
    /* color: #61f1f4 */
    /* shown: false */
    ee.Geometry.MultiPolygon(
        [[[[47.59276366952485, -9.687179116346291],
           [47.585897214446724, -9.690224948811181],
           [47.55602813485688, -9.724404059517544],
           [47.583150632415474, -9.759594740247222],
           [47.602376706634224, -9.75485774946257],
           [47.61027312997407, -9.741999863736947],
           [47.62675262216157, -9.741323119180288],
           [47.635335691009224, -9.753504311155895],
           [47.64460540536469, -9.738277751694888],
           [47.65112853768891, -9.715605810020225],
           [47.640828855071724, -9.702746413933353],
           [47.59894347909516, -9.685486975255515]]],
         [[[46.25038479518611, -9.40622340341489],
           [46.25931118678767, -9.425867826694434],
           [46.330036784724705, -9.429933909852755],
           [46.334842192647045, -9.405545989593882],
           [46.270640837666576, -9.387932764844745]]]]),
    RCtoORF = 
    /* color: #ffc756 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[55.33929678436959, -5.819532133315801],
          [55.333116974799275, -5.8584678623598325],
          [55.36813589569771, -5.845148049131459],
          [55.363329377143025, -5.816116589567722]]]),
    MoreDeep = 
    /* color: #1b27ff */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[54.97193475746061, -4.238376289551878],
          [55.42237421058561, -4.271244437181423],
          [55.45533319496061, -4.068535503752379],
          [55.23147412172192, -3.952120122279829],
          [55.01313348792936, -3.9753817066470383]]]),
    geoclean1 = ee.Image("projects/coral_atlas/west_indian_ocean/in_out/wio_geo-clean_p1"),
    geoclean2 = ee.Image("projects/coral_atlas/west_indian_ocean/in_out/wio_geo-clean_p2");
/***** End of imports. If edited, may not auto-convert in the playground. *****/
// little viewing script for looking at reefs and classifications for each region. 
//The map_viewer WIO script is going to be used from the very beginning
//in the workflow to annotate masks 
// little viewing script for looking at reefs and classifications for each region. 
//The map_viewer WIO script is going to be used from the very beginning
//in the workflow to annotate masks 


// Current Region: West Indian Ocean  <--------- Indicate region here

// imports
var pkg_vis = require('users/mitchest/global_reefs:Modules/pkg_vis')
var map_palettes = require('users/mitchest/global_reefs:Modules/colour_pals')

// choogse where to centre (link this dynamically to map app?)
var centre_map = ee.Geometry.Point([50.26077595263271,-9.927142570159555]) // <---- change for region
Map.centerObject(centre_map, 5)

//splitting North Cari regions


//4. add turbidity for reference
//Map.addLayer(turbidity.focal_mode(5), {min:5, max:20, palette: ['#ffffe5','#fff7bc','#fee391','#fec44f','#fe9929','#ec7014','#cc4c02','#993404','#662506']}, "Accumulative turbidity (smooth)", false)
//Map.addLayer(turbidity, {min:5, max:20, palette: ['#ffffe5','#fff7bc','#fee391','#fec44f','#fe9929','#ec7014','#cc4c02','#993404','#662506']}, "Accumulative turbidity", false)



// add some background data
//Map.addLayer(any_rrs, {bands: ['b3','b2','b1'], min: 66, max: 1260}, "Any tide mosaic", false)
//Map.addLayer(high_rrs, {bands: ['b3','b2','b1'], min: 66, max: 1260}, "High tide mosaic", false)

var imageVisParam = {"opacity":1,"bands":["b3","b2","b1"],"max":1536,"gamma":1};
Map.addLayer(low_rrs, imageVisParam, 'Dove sr lowtide', false)
//Map.addLayer(Artifact_layer, {color: 'ffff00'}, 'Artifact Layer', false)

// West Indian Ocean classification

//Map.addLayer(benthic.updateMask(geo.gt(2)), map_palettes.benthic, "Nth. Cari & Baha Benthic - RAW", false)
//Map.addLayer(ee.ImageCollection([benthic_baha,benthic_cari]).mosaic(), map_palettes.benthic, "Nth. Cari & Baha Benthic - RAW", false)
Map.addLayer(wio_benthic, map_palettes.benthic, "wio_benthic - RAW", false)
Map.addLayer(benthic_clean, map_palettes.benthic, "WIO benthic - clean #1", false)
Map.addLayer(wio_geo, map_palettes.geo, "wio_geo - RAW", false)
Map.addLayer(geoclean1, map_palettes.geo, "wio_geo - firstPass", false)
Map.addLayer(geoclean2, map_palettes.geo, "wio_geo - 2ndPass", false)
Map.addLayer(geoclean3, map_palettes.geo, "wio_geo - manual", false)
Map.addLayer(geoclean4, map_palettes.geo, "wio_geo - manual CR edits", false)
//Map.addLayer(waves.lte(0.4), {}, "waves 0.4 threshold", false)
//Map.addLayer(ee.ImageCollection([hawaii_geo_west, hawaii_geo_east]).mosaic(), map_palettes.geo, "Hawaii east/west Geo - RAW", false)
//Map.addLayer(geo_clean, map_palettes.geo, "Nth. Cari & Baha Geo - FINAL", false)




var wcmc=wcmc.filterBounds(BondariesWCMCForWIO)

Map.addLayer(wcmc, {color:'#ffff00'}, "WCMC layer", false)

// #############
// example confidence layers

/*
// depth and nir combos
var depth_nir_flag = fiji_dove_ocean.select('b4').multiply(fiji_high_depth_ocean).gt(250000)
//Map.addLayer(depth_nir_flag, {}, "NIR flag", false)
var conf_flag = fiji_high_depth_ocean.eq(-1)
                        .or(fiji_high_depth_ocean.gt(1000))
                        .add(depth_nir_flag.eq(1))
                        .selfMask()
Map.addLayer(conf_flag, {min:1,max:2,palette:["#f7f7f7","#bababa"]}, "Confidence flag", false)

//straight depth missing/-1
var depth_flag = fiji_high_depth_ocean.gt(0).selfMask()
//Map.addLayer(depth_flag, {min:0,max:1,palette:["#ffff00"]}, "Valid depth retrievals", false)

//Map.addLayer(fiji_geo_clean.gt(0).updateMask(fiji_high_depth_ocean.lte(0)), {min:0,max:1,palette:["#ff0000"]}, "Unmapped area via original algorithm", false)
*/

////////// UI SET UP //////////


//Generate title
var title = ui.Label({
  value: 'Coral Atlas map classes',
  style: {fontWeight: 'bold', fontSize: '18px'}
})

// generate the legend
var geo_legend = pkg_vis.discrete_legend(map_palettes.geo_atlas_names, map_palettes.geo_atlas_cols, 'Geomorphic Zone', false)
var benthic_legend = pkg_vis.discrete_legend(map_palettes.benthic_atlas_names, map_palettes.benthic_atlas_cols, 'Benthic Habitat', false)
//var mask_legend = pkg_vis.discrete_legend(["Low confidence depth","Water conditions"], ["#f7f7f7","#bababa"], 'Confidence Mask reason', false)
pkg_vis.add_lgds([title, geo_legend, benthic_legend])//, mask_legend])


//show confidence layers
var conf_str = {"opacity":1,"bands":["constant"],"min":0,"max":9,"palette":["4d004b","810f7c","88419d","8c6bb1","8c96c6","9ebcda","bfd3e6","e0ecf4","f7fcfd"]};
Map.addLayer(benthic_conf_clean,conf_str,'confidence_benthic',false);
Map.addLayer(geo_conf_clean,conf_str,'confidence_geo',false);

//Confidence legend

var legend=ui.Panel({
  style: {
    position: 'bottom-right',
    padding: "8px 15px"
  }
});

//var vis = {min: 'low', max: 'high', palette: 'ece2f0,a6bddb,1c9099'};
var vis = {min: 'low', max: 'high', palette: '4d004b,810f7c,88419d,8c6bb1,8c96c6,9ebcda,bfd3e6,e0ecf4,f7fcfd'};

function makeColorBarParams(palette) {
  return {
    bbox: [0, 0, 1, 0.1],
    dimensions: '100x10',
    format: 'png',
    min: 0,
    max: 1,
    palette: palette,
  };
}

var colorBar=ui.Thumbnail({
  image: ee.Image.pixelLonLat().select(0),
  params: makeColorBarParams(vis.palette),
  style:{stretch:'horizontal', margin: '0px 8px',maxHeight: '24px'}
})
// Create a panel with three numbers for the legend.
var legendLabels = ui.Panel({
  widgets: [
    ui.Label(vis.min, {margin: '4px 8px'}),
    ui.Label(
        (' '),
        {margin: '4px 8px', textAlign: 'center', stretch: 'horizontal'}),
    ui.Label(vis.max, {margin: '4px 8px'})
  ],
  layout: ui.Panel.Layout.flow('horizontal')
});

var legendTitle = ui.Label({
  value: 'Confidence Layer Legend',
  style: {fontWeight: 'bold',position: 'bottom-right'}
});

legend.add(legendTitle);
legend.add(colorBar)
legend.add(legendLabels);

Map.add(legend)