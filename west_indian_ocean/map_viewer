/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var depth_pal = {"opacity":1,"bands":["depth"],"max":5,"palette":["e4e1ff","7f89ff","3a52ff","0007ff","000258"]},
    wcmc = ee.FeatureCollection("projects/coral_atlas/global_datasets/wcmc_reefs_2018v4_dissolved"),
    BondariesWCMCForWIO = 
    /* color: #00ffff */
    /* shown: false */
    /* locked: true */
    ee.Geometry.Polygon(
        [[[54.701770985703206, -2.9751249685105154],
          [52.548450673203206, -4.772691629173448],
          [52.196888173203206, -5.910289150084192],
          [51.757435048203206, -8.091037974566733],
          [48.285755360703206, -8.65623438835204],
          [44.814075673203206, -9.350691639103687],
          [46.440052235703206, -10.864858654100164],
          [45.736927235703206, -11.72673086956205],
          [43.583606923203206, -10.605801768506067],
          [41.781849110703206, -10.605801768506067],
          [41.737903798203206, -12.543027437564627],
          [44.638294423203206, -13.954584744088688],
          [46.352161610703206, -13.783928424683062],
          [48.857044423203206, -10.99430318398806],
          [49.955677235703206, -10.908013101551091],
          [52.680286610703206, -10.95116128603305],
          [53.339466298203206, -8.438948520327026],
          [54.613880360703206, -6.827435160865552],
          [55.624622548203206, -6.914694536706059],
          [56.108020985703206, -11.511507059571993],
          [58.788685048203206, -15.865441173681486],
          [56.942981923203206, -19.631456469862268],
          [54.438099110703206, -20.539442163648662],
          [54.130481923203206, -21.482966628121225],
          [54.965442860703206, -22.420415520660942],
          [55.844349110703206, -22.095048738332846],
          [57.074817860703206, -21.196440284100703],
          [58.481067860703206, -20.827232047085705],
          [59.184192860703206, -17.883867297837703],
          [63.754505360703206, -20.909357190677294],
          [64.9849741107032, -20.00354040738218],
          [63.666614735703206, -19.009403584868657],
          [61.776966298203206, -19.175515382142862],
          [60.370716298203206, -18.009288625640345],
          [60.458606923203206, -15.187980739313776],
          [58.964466298203206, -15.187980739313776],
          [56.811145985703206, -11.55456509703201],
          [57.514270985703206, -10.216806458907836],
          [56.327747548203206, -9.17720313716965],
          [56.327747548203206, -7.786369242288465],
          [57.250599110703206, -7.089164748909251],
          [56.108020985703206, -5.866575713917645],
          [57.602161610703206, -5.647957630653708],
          [57.206653798203206, -4.422260866394937],
          [56.547474110703206, -3.4138941523262103]]]),
    no_reef = 
    /* color: #01ff14 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[55.2248077855843, -20.980851493012523],
          [55.33741764886555, -21.08595829180467],
          [55.4884796605843, -21.2191575703884],
          [55.5763702855843, -21.37014202611179],
          [55.5763702855843, -21.549074333518252],
          [55.95265202386555, -21.487750868105195],
          [56.05702214105305, -21.23195887279921],
          [55.8839874730843, -20.93981411727935],
          [55.6917267308968, -20.672797751973356],
          [55.42530827386555, -20.62910598668815],
          [55.1479034887093, -20.793527159750223],
          [55.1204376683968, -20.867971649301655]]]),
    low_rrs = ee.Image("projects/coral_atlas/workflow/mapping/west_indian_ocean/west_indian_ocean_islands_low_tide_normalized_sr_jan2018_jan2020_v2_shift_mosaic/20200131T210330Z/west_indian_ocean_islands_low_tide_normalized_sr_jan2018_jan2020_v2_shift_mosaic"),
    wio_geo = ee.Image("projects/coral_atlas/west_indian_ocean/in_out/wio_geo"),
    wio_benthic = ee.Image("projects/coral_atlas/west_indian_ocean/in_out/wio_benthic"),
    geoclean3 = ee.Image("projects/coral_atlas/west_indian_ocean/in_out/wio_geo-clean_manual2"),
    benthic_clean = ee.Image("projects/coral_atlas/west_indian_ocean/in_out/wio_benthic-clean"),
    MayotteNotRB = 
    /* color: #d63000 */
    /* shown: false */
    ee.Geometry.MultiPolygon(
        [[[[44.93353752487357, -12.911249544927387],
           [44.94109062545951, -12.95809511901116],
           [45.033101123506384, -13.06714418570024],
           [45.121676458316315, -13.103275530389817],
           [45.211628955537634, -13.077845799375721],
           [45.25969414108451, -13.020319175455509],
           [45.25076774948295, -12.995565235483856],
           [45.214375537568884, -13.011622126750671],
           [45.17729668014701, -13.039719183798846],
           [45.090779346162634, -13.04105705936047],
           [45.03996757858451, -13.014298174238446],
           [45.000142139131384, -12.931996527163442],
           [44.97130302780326, -12.861717532702869],
           [44.931477588350134, -12.871758596798994]]],
         [[[45.066060107881384, -12.576102055618168],
           [45.06194023483451, -12.606928082828533],
           [45.12511162155326, -12.620999601831386],
           [45.13335136764701, -12.634400329135246],
           [45.16425041549857, -12.65048027450181],
           [45.203389209443884, -12.686656446537798],
           [45.24046806686576, -12.71679932983544],
           [45.274800342256384, -12.746938634929284],
           [45.30913261764701, -12.787118795281767],
           [45.324238818818884, -12.740241321207941],
           [45.283040088350134, -12.666559207025417],
           [45.200642627412634, -12.606257991208416],
           [45.12305168502982, -12.57744239467687]]]]),
    BMAtoCoral = 
    /* color: #1380f0 */
    /* shown: false */
    ee.Geometry.MultiPolygon(
        [[[[57.801999542038345, -20.332731662532623],
           [57.78071353129616, -20.349149246855852],
           [57.75290438822975, -20.38262283497072],
           [57.78483340434303, -20.4061143803561],
           [57.83564517192116, -20.34432072663058],
           [57.805776092331314, -20.327580688514043]]],
         [[[46.379132744394916, -9.363840121135988],
           [46.39183568628945, -9.374171781241422],
           [46.43269109400429, -9.376373570699558],
           [46.436295982920306, -9.387043583178746],
           [46.44711064966835, -9.394834178478282],
           [46.458783623301166, -9.386027405660645],
           [46.47457646998085, -9.382978855232931],
           [46.48968267115273, -9.386196768787226],
           [46.498780724131244, -9.379760911814145],
           [46.455522057139056, -9.365195110463779],
           [46.410890099131244, -9.358250734312143]]],
         [[[46.26602095772106, -9.484091094053468],
           [46.240356820243804, -9.480493958729495],
           [46.21572394720031, -9.466397310403345],
           [46.227309521785564, -9.493616434845022],
           [46.256106401179544, -9.499098343833625],
           [46.287650291217155, -9.498482567353868],
           [46.321128206805234, -9.486300115325815],
           [46.35318808518665, -9.473434889019712],
           [46.40961969154483, -9.453791273695941],
           [46.441458884967155, -9.463264716631668],
           [46.471671287310905, -9.460894154609212],
           [46.496905509723014, -9.449041099412153],
           [46.4987937848695, -9.4410823904624],
           [46.46531981636364, -9.452427728277064],
           [46.44712371040661, -9.452766389330776],
           [46.42154616524059, -9.444977100798987],
           [46.397003013228904, -9.445916441330047]]]]),
    SGtoRB = 
    /* color: #ffc82d */
    /* shown: false */
    ee.Geometry.MultiPolygon(
        [[[[44.448445469018495, -12.321078359117672],
           [44.48655429470209, -12.368199935205475],
           [44.49616733181146, -12.371050434455384],
           [44.50097385036615, -12.348077879907246],
           [44.47282138454584, -12.32057523606313],
           [44.450162082788026, -12.3140345485576]]],
         [[[44.30157592659927, -12.228031989796571],
           [44.29951599007583, -12.234323169554095],
           [44.3142788684938, -12.240530320115308],
           [44.332646635827786, -12.242962812308077],
           [44.345735884280096, -12.240656271181445],
           [44.35024192696548, -12.238852726238573],
           [44.327153471765286, -12.233400472560975]]],
         [[[44.22123840218521, -12.193889245577944],
           [44.26861694222427, -12.217965790817999],
           [44.27762916451431, -12.22174066032913],
           [44.28260734444595, -12.21486196887535],
           [44.25488403206802, -12.20001345239615],
           [44.209736895592556, -12.176984515316917],
           [44.214714989496294, -12.185436939991664]]],
         [[[44.203998477402614, -12.167784284373734],
           [44.20605841392605, -12.172482780836695],
           [44.23197928184597, -12.171727670938013],
           [44.231464297715114, -12.167364771720505],
           [44.20365515464871, -12.16459597160023]]]]),
    DL_SGtoSD = 
    /* color: #f6ff17 */
    /* shown: false */
    ee.Geometry.MultiPolygon(
        [[[[44.51724522032148, -12.26586971247598],
           [44.517588543075384, -12.342013892807694],
           [44.548487590926946, -12.34905695145454],
           [44.547285961288274, -12.262179346303313],
           [44.531664818702694, -12.225105587556078]]],
         [[[44.40244482739659, -12.13316362800548],
           [44.344251620609484, -12.180989957461227],
           [44.343736636478624, -12.189044071319936],
           [44.36639593823644, -12.188372904503423],
           [44.41806601269933, -12.169411740652926],
           [44.43746374829503, -12.132827974272223],
           [44.432142245609484, -12.107988425683828],
           [44.420125949222765, -12.10865979523274]]]]),
    SGtoRK = 
    /* color: #c28f56 */
    /* shown: false */
    ee.Geometry.MultiPolygon(
        [[[[44.40851124353974, -12.100236833710976],
           [44.502281270700394, -12.125580598812137],
           [44.50054147480959, -12.077992151041995],
           [44.48266895838349, -12.031410527464047],
           [44.43220527402953, -12.067001213904845]]],
         [[[44.512488995162045, -12.208197528132478],
           [44.518754635420834, -12.221032338514691],
           [44.532487545577084, -12.216754137545648],
           [44.52956930216888, -12.188314927265532],
           [44.51188818034271, -12.190496213686567]]],
         [[[43.66734196156403, -12.246025801394074],
           [43.60605852491806, -12.255000409752714],
           [43.60858969680278, -12.297856886329136],
           [43.63309534151488, -12.29039358685256],
           [43.77325757119539, -12.299702324424803],
           [43.77995239856942, -12.28477463934774],
           [43.73961176882459, -12.258774965759478],
           [43.70098776246897, -12.247367847929393]]],
         [[[43.773940936333965, -12.369967986497178],
           [43.782695666558574, -12.38036370440054],
           [43.80329503179295, -12.382040394329868],
           [43.87213124395115, -12.402327488361164],
           [43.89015568853123, -12.383046403117142],
           [43.87573613286717, -12.367955864271398],
           [43.78681553960545, -12.364434613093461]]],
         [[[43.66630261148744, -12.322737707302851],
           [43.66012268410097, -12.318041912626018],
           [43.650681426184704, -12.3136814019857],
           [43.64724819864564, -12.308482270699427],
           [43.642956615865536, -12.303702290718975],
           [43.62785046304994, -12.283323730449924],
           [43.61583416666322, -12.312339700543067],
           [43.65171139444642, -12.357618329894171],
           [43.66647427286439, -12.350743190256194],
           [43.675400664465954, -12.34001090393033],
           [43.67025082315736, -12.330452091129242]]]]),
    geoclean4 = ee.Image("projects/coral_atlas/west_indian_ocean/in_out/wio_geo-clean_manual_July10");
/***** End of imports. If edited, may not auto-convert in the playground. *****/
// little viewing script for looking at reefs and classifications for each region. 
//The map_viewer WIO script is going to be used from the very beginning
//in the workflow to annotate masks 
// little viewing script for looking at reefs and classifications for each region. 
//The map_viewer WIO script is going to be used from the very beginning
//in the workflow to annotate masks 


// Current Region: West Indian Ocean  <--------- Indicate region here

// imports
var pkg_vis = require('users/mitchest/global_reefs:Modules/pkg_vis')
var map_palettes = require('users/mitchest/global_reefs:Modules/colour_pals')

// choogse where to centre (link this dynamically to map app?)
var centre_map = ee.Geometry.Point([50.26077595263271,-9.927142570159555]) // <---- change for region
Map.centerObject(centre_map, 5)

//splitting North Cari regions


//4. add turbidity for reference
//Map.addLayer(turbidity.focal_mode(5), {min:5, max:20, palette: ['#ffffe5','#fff7bc','#fee391','#fec44f','#fe9929','#ec7014','#cc4c02','#993404','#662506']}, "Accumulative turbidity (smooth)", false)
//Map.addLayer(turbidity, {min:5, max:20, palette: ['#ffffe5','#fff7bc','#fee391','#fec44f','#fe9929','#ec7014','#cc4c02','#993404','#662506']}, "Accumulative turbidity", false)



// add some background data
//Map.addLayer(any_rrs, {bands: ['b3','b2','b1'], min: 66, max: 1260}, "Any tide mosaic", false)
//Map.addLayer(high_rrs, {bands: ['b3','b2','b1'], min: 66, max: 1260}, "High tide mosaic", false)

var imageVisParam = {"opacity":1,"bands":["b3","b2","b1"],"max":1536,"gamma":1};
Map.addLayer(low_rrs, imageVisParam, 'Dove sr lowtide', false)
//Map.addLayer(Artifact_layer, {color: 'ffff00'}, 'Artifact Layer', false)

// West Indian Ocean classification

//Map.addLayer(benthic.updateMask(geo.gt(2)), map_palettes.benthic, "Nth. Cari & Baha Benthic - RAW", false)
//Map.addLayer(ee.ImageCollection([benthic_baha,benthic_cari]).mosaic(), map_palettes.benthic, "Nth. Cari & Baha Benthic - RAW", false)
Map.addLayer(wio_benthic, map_palettes.benthic, "wio_benthic - RAW", false)
Map.addLayer(benthic_clean, map_palettes.benthic, "WIO benthic - clean", false)
Map.addLayer(wio_geo, map_palettes.geo, "wio_geo - RAW", false)
Map.addLayer(geoclean1, map_palettes.geo, "wio_geo - firstPass", false)
Map.addLayer(geoclean2, map_palettes.geo, "wio_geo - 2ndPass", false)
Map.addLayer(geoclean3, map_palettes.geo, "wio_geo - manual", false)
Map.addLayer(geoclean4, map_palettes.geo, "GEO manual July10", false)
Map.addLayer(waves.lte(0.4), {}, "waves 0.4 threshold", false)
//Map.addLayer(ee.ImageCollection([hawaii_geo_west, hawaii_geo_east]).mosaic(), map_palettes.geo, "Hawaii east/west Geo - RAW", false)
//Map.addLayer(geo_clean, map_palettes.geo, "Nth. Cari & Baha Geo - FINAL", false)




var wcmc=wcmc.filterBounds(BondariesWCMCForWIO)

Map.addLayer(wcmc, {color:'#ffff00'}, "WCMC layer", false)

// #############
// example confidence layers

/*
// depth and nir combos
var depth_nir_flag = fiji_dove_ocean.select('b4').multiply(fiji_high_depth_ocean).gt(250000)
//Map.addLayer(depth_nir_flag, {}, "NIR flag", false)
var conf_flag = fiji_high_depth_ocean.eq(-1)
                        .or(fiji_high_depth_ocean.gt(1000))
                        .add(depth_nir_flag.eq(1))
                        .selfMask()
Map.addLayer(conf_flag, {min:1,max:2,palette:["#f7f7f7","#bababa"]}, "Confidence flag", false)

//straight depth missing/-1
var depth_flag = fiji_high_depth_ocean.gt(0).selfMask()
//Map.addLayer(depth_flag, {min:0,max:1,palette:["#ffff00"]}, "Valid depth retrievals", false)

//Map.addLayer(fiji_geo_clean.gt(0).updateMask(fiji_high_depth_ocean.lte(0)), {min:0,max:1,palette:["#ff0000"]}, "Unmapped area via original algorithm", false)
*/

////////// UI SET UP //////////


//Generate title
var title = ui.Label({
  value: 'Coral Atlas map classes',
  style: {fontWeight: 'bold', fontSize: '18px'}
})

// generate the legend
var geo_legend = pkg_vis.discrete_legend(map_palettes.geo_atlas_names, map_palettes.geo_atlas_cols, 'Geomorphic Zone', false)
var benthic_legend = pkg_vis.discrete_legend(map_palettes.benthic_atlas_names, map_palettes.benthic_atlas_cols, 'Benthic Habitat', false)
//var mask_legend = pkg_vis.discrete_legend(["Low confidence depth","Water conditions"], ["#f7f7f7","#bababa"], 'Confidence Mask reason', false)
pkg_vis.add_lgds([title, geo_legend, benthic_legend])//, mask_legend])


//show confidence layers
var conf_str = {"opacity":1,"bands":["constant"],"min":0,"max":9,"palette":["4d004b","810f7c","88419d","8c6bb1","8c96c6","9ebcda","bfd3e6","e0ecf4","f7fcfd"]};
Map.addLayer(benthic_conf_clean,conf_str,'confidence_benthic',false);
Map.addLayer(geo_conf_clean,conf_str,'confidence_geo',false);

//Confidence legend

var legend=ui.Panel({
  style: {
    position: 'bottom-right',
    padding: "8px 15px"
  }
});

//var vis = {min: 'low', max: 'high', palette: 'ece2f0,a6bddb,1c9099'};
var vis = {min: 'low', max: 'high', palette: '4d004b,810f7c,88419d,8c6bb1,8c96c6,9ebcda,bfd3e6,e0ecf4,f7fcfd'};

function makeColorBarParams(palette) {
  return {
    bbox: [0, 0, 1, 0.1],
    dimensions: '100x10',
    format: 'png',
    min: 0,
    max: 1,
    palette: palette,
  };
}

var colorBar=ui.Thumbnail({
  image: ee.Image.pixelLonLat().select(0),
  params: makeColorBarParams(vis.palette),
  style:{stretch:'horizontal', margin: '0px 8px',maxHeight: '24px'}
})
// Create a panel with three numbers for the legend.
var legendLabels = ui.Panel({
  widgets: [
    ui.Label(vis.min, {margin: '4px 8px'}),
    ui.Label(
        (' '),
        {margin: '4px 8px', textAlign: 'center', stretch: 'horizontal'}),
    ui.Label(vis.max, {margin: '4px 8px'})
  ],
  layout: ui.Panel.Layout.flow('horizontal')
});

var legendTitle = ui.Label({
  value: 'Confidence Layer Legend',
  style: {fontWeight: 'bold',position: 'bottom-right'}
});

legend.add(legendTitle);
legend.add(colorBar)
legend.add(legendLabels);

Map.add(legend)