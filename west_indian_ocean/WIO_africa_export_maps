/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var pixels = ee.Image("projects/coral_atlas/west_indian_ocean/in_out/wio_pixels"),
    Refined_masks = /* color: #d63000 */ee.Geometry({
      "type": "GeometryCollection",
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                46.16883746799445,
                -9.314531487909539
              ],
              [
                46.16265765842414,
                -9.456796659566903
              ],
              [
                46.17982379611945,
                -9.456796659566903
              ],
              [
                46.19424335178351,
                -9.417510216611321
              ],
              [
                46.19698993381476,
                -9.361959694124929
              ],
              [
                46.20248309787726,
                -9.317919430876863
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                46.45650935965564,
                -9.312266659241466
              ],
              [
                46.41702724295642,
                -9.358340162918868
              ],
              [
                46.431446798620485,
                -9.36782512737417
              ],
              [
                46.47573543387439,
                -9.354613856068685
              ],
              [
                46.50251460867908,
                -9.362066429830495
              ],
              [
                46.52517391043689,
                -9.356307636859759
              ],
              [
                46.523800619421266,
                -9.335642947998812
              ],
              [
                46.494618185339235,
                -9.308539859872441
              ],
              [
                46.48054195242908,
                -9.304474215245325
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                46.402734536338706,
                -9.461302837152173
              ],
              [
                46.40668274800863,
                -9.466213263075925
              ],
              [
                46.42213227193441,
                -9.478065726138093
              ],
              [
                46.45131470601644,
                -9.477557771827156
              ],
              [
                46.476377267051596,
                -9.467906497126561
              ],
              [
                46.52924897115316,
                -9.44978846001932
              ],
              [
                46.52272583882894,
                -9.440813751911135
              ],
              [
                46.48396648964176,
                -9.451651105974403
              ],
              [
                46.477100034563634,
                -9.455376367640934
              ],
              [
                46.46388218291195,
                -9.460456466631383
              ],
              [
                46.45014919838199,
                -9.460117551420424
              ],
              [
                46.4380470099496,
                -9.460964331068102
              ],
              [
                46.429378171770665,
                -9.456053683610588
              ],
              [
                46.41032375892887,
                -9.45385240183381
              ],
              [
                46.40225567421207,
                -9.457746967700176
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                51.06907891021503,
                -9.921911707797031
              ],
              [
                51.24623345123066,
                -9.948965617329986
              ],
              [
                51.33824394927753,
                -9.902972641133722
              ],
              [
                51.37394951568378,
                -9.759541526856205
              ],
              [
                51.38218926177753,
                -9.597092161979024
              ],
              [
                51.29429863677753,
                -9.56459289845215
              ],
              [
                51.16932915435566,
                -9.57813463636326
              ],
              [
                51.04161308990253,
                -9.710814974077218
              ],
              [
                50.99217461334003,
                -9.865091230833565
              ],
              [
                51.01689385162128,
                -9.894855563571193
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                51.0797236393276,
                -9.484670137762558
              ],
              [
                51.079036993819784,
                -9.488733666937748
              ],
              [
                51.092769903976034,
                -9.494490250809905
              ],
              [
                51.107532782394,
                -9.49211990445608
              ],
              [
                51.120235724288534,
                -9.476542934986984
              ],
              [
                51.13156537516744,
                -9.464013120413039
              ],
              [
                51.15250806315572,
                -9.437936096584163
              ],
              [
                51.171390814620565,
                -9.419647136297725
              ],
              [
                51.18100385172994,
                -9.396953931977214
              ],
              [
                51.1899302433315,
                -9.37561418874666
              ],
              [
                51.149418158370565,
                -9.349403003631439
              ],
              [
                51.141178412276815,
                -9.368034417675291
              ],
              [
                51.14111949053025,
                -9.379848138771276
              ],
              [
                51.14180613603806,
                -9.387977620413071
              ],
              [
                51.14111949053025,
                -9.398139204273143
              ],
              [
                51.14043284502244,
                -9.405590842880327
              ],
              [
                51.13768626299119,
                -9.418461476838091
              ],
              [
                51.13219309892869,
                -9.430992949098664
              ],
              [
                51.12498332109666,
                -9.444201305402032
              ],
              [
                51.11399699297166,
                -9.452329272969385
              ],
              [
                51.09648753252244,
                -9.463843565052512
              ],
              [
                51.090307722952126,
                -9.469261922009649
              ],
              [
                51.085844527151345,
                -9.47603474801804
              ],
              [
                51.08103800859666,
                -9.47908247613114
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                50.992673749565505,
                -9.334973401926097
              ],
              [
                51.00434672319832,
                -9.318372978313194
              ],
              [
                51.011899823784255,
                -9.30041652961384
              ],
              [
                51.01395976030769,
                -9.284153290147161
              ],
              [
                51.00949656450691,
                -9.27161652792447
              ],
              [
                50.99919688188972,
                -9.264500869030986
              ],
              [
                50.98924052202644,
                -9.27364954683055
              ],
              [
                50.97138773882332,
                -9.309903070285834
              ],
              [
                50.97207438433113,
                -9.333279517346817
              ],
              [
                50.980657453178786,
                -9.33666727827349
              ],
              [
                50.98649393999519,
                -9.333957072166266
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                57.7825055556253,
                -20.39604038820671
              ],
              [
                57.777355708941506,
                -20.4005455061
              ],
              [
                57.77186253914249,
                -20.402476230585116
              ],
              [
                57.766389386856176,
                -20.40167462544841
              ],
              [
                57.76244117106251,
                -20.402318198246775
              ],
              [
                57.76123954016804,
                -20.403766227214753
              ],
              [
                57.76123954016636,
                -20.40682313255608
              ],
              [
                57.76188325586893,
                -20.4087939878485
              ],
              [
                57.763385309618016,
                -20.411167051560582
              ],
              [
                57.764844432845926,
                -20.41358028694495
              ],
              [
                57.765230673231,
                -20.414666226596925
              ],
              [
                57.76493026362329,
                -20.415953264852426
              ],
              [
                57.764157786619215,
                -20.41695875293173
              ],
              [
                57.76226950949802,
                -20.41905014709722
              ],
              [
                57.759007939923286,
                -20.423715462439294
              ],
              [
                57.75557470879064,
                -20.4280589047443
              ],
              [
                57.75231313921624,
                -20.42918496235959
              ],
              [
                57.75093984676265,
                -20.430632738611973
              ],
              [
                57.74716329251123,
                -20.436745421434516
              ],
              [
                57.74716329250802,
                -20.439158255663138
              ],
              [
                57.75042486208159,
                -20.440605938028355
              ],
              [
                57.773942495334786,
                -20.429345827069167
              ],
              [
                57.78527215805601,
                -20.419693647274254
              ],
              [
                57.790936989403676,
                -20.407305796266964
              ],
              [
                57.796601820736896,
                -20.39025076089859
              ],
              [
                57.79952006717339,
                -20.379147884100817
              ],
              [
                57.79814677472308,
                -20.377699623845878
              ],
              [
                57.794198558938724,
                -20.380596130765543
              ],
              [
                57.78904871226569,
                -20.38848079064052
              ],
              [
                57.78664545048244,
                -20.39105528612934
              ],
              [
                57.78510049647914,
                -20.393468836597002
              ],
              [
                57.783727204030924,
                -20.394916948735798
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                57.82575676368816,
                -20.264113916377664
              ],
              [
                57.82730171608074,
                -20.267817713418573
              ],
              [
                57.828160022965506,
                -20.27280964780128
              ],
              [
                57.8278167002116,
                -20.2769963076103
              ],
              [
                57.82713005470379,
                -20.280860816349968
              ],
              [
                57.82747337745769,
                -20.285047258792147
              ],
              [
                57.82713005470379,
                -20.290843684752684
              ],
              [
                57.82301018165691,
                -20.297605907687768
              ],
              [
                57.818718647233084,
                -20.30002091577697
              ],
              [
                57.81648704933269,
                -20.30340186384309
              ],
              [
                57.81648704933269,
                -20.306943730269
              ],
              [
                57.81837532447918,
                -20.31000254970915
              ],
              [
                57.820435261002615,
                -20.311773417551166
              ],
              [
                57.82472679542644,
                -20.31418820468676
              ],
              [
                57.82798836158855,
                -20.317085899517817
              ],
              [
                57.82833168434246,
                -20.3248128204515
              ],
              [
                57.827645038834646,
                -20.330285822599965
              ],
              [
                57.824898456803396,
                -20.339943589152934
              ],
              [
                57.82453784366908,
                -20.345460630638698
              ],
              [
                57.82968768497767,
                -20.350611008846958
              ],
              [
                57.83792743107142,
                -20.351254794049805
              ],
              [
                57.84822711368861,
                -20.34095390887207
              ],
              [
                57.85440692325892,
                -20.321637898778093
              ],
              [
                57.8478837909347,
                -20.26496369529465
              ],
              [
                57.84170398136439,
                -20.25272450002249
              ],
              [
                57.8314042987472,
                -20.254979161129057
              ],
              [
                57.826597780192515,
                -20.258522133861067
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                50.944054396237966,
                -8.844024647938788
              ],
              [
                50.922081739987966,
                -8.894228861920352
              ],
              [
                50.90422895678484,
                -8.991903785053813
              ],
              [
                50.927574904050466,
                -9.047512474256713
              ],
              [
                50.963280470456716,
                -9.059718111336538
              ],
              [
                51.215966017331716,
                -8.925433419950899
              ],
              [
                51.21733930834734,
                -8.872519774037949
              ],
              [
                51.191246779050466,
                -8.778884661462225
              ],
              [
                51.172020704831716,
                -8.72730738899314
              ],
              [
                51.14592817553484,
                -8.701516077077265
              ],
              [
                51.03606489428484,
                -8.677080563391257
              ],
              [
                51.00035932787859,
                -8.693371082840411
              ],
              [
                50.993492872800466,
                -8.780241861471605
              ],
              [
                51.034691603269216,
                -8.782956246593006
              ],
              [
                51.078636915769216,
                -8.763955133846663
              ],
              [
                51.09923628100359,
                -8.788384957225675
              ],
              [
                51.08275678881609,
                -8.823669635915996
              ],
              [
                51.02782514819109,
                -8.82638370243481
              ],
              [
                50.98937299975359,
                -8.819598498719802
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                53.26062688580538,
                -6.117119965380196
              ],
              [
                53.18097600689913,
                -6.069326325231498
              ],
              [
                53.14252385846163,
                -6.084347641931368
              ],
              [
                53.149390313539755,
                -6.117119965380196
              ],
              [
                53.163123223696005,
                -6.170370701809604
              ],
              [
                53.17822942486788,
                -6.234537553330291
              ],
              [
                53.19745549908663,
                -6.250919324491233
              ],
              [
                53.27161321393038,
                -6.276856079105384
              ],
              [
                53.33203801861788,
                -6.241363353575383
              ],
              [
                53.32105169049288,
                -6.16354398234659
              ],
              [
                53.28809270611788,
                -6.13077450787365
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                53.61378935385647,
                -5.570394266824802
              ],
              [
                53.68245390463772,
                -5.569027459325318
              ],
              [
                53.75386503745022,
                -5.582695391128092
              ],
              [
                53.85548857260647,
                -5.552625521572874
              ],
              [
                53.90080717612209,
                -5.491114200381858
              ],
              [
                53.85548857260647,
                -5.437799250553657
              ],
              [
                53.708702545627524,
                -5.42276084468795
              ],
              [
                53.601585846408774,
                -5.534856240595414
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                59.3792731599096,
                -15.835629512066568
              ],
              [
                59.36004708569085,
                -16.033707818910287
              ],
              [
                59.4067389802221,
                -16.14982239675077
              ],
              [
                59.5770270661596,
                -16.139269333615378
              ],
              [
                59.7637946442846,
                -16.078578314648794
              ],
              [
                59.7802741364721,
                -15.901677324597761
              ],
              [
                59.7088630036596,
                -15.817132249875295
              ],
              [
                59.50836251537835,
                -15.822417354648511
              ],
              [
                59.41497872631585,
                -15.846198615873027
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                59.63679656128213,
                -16.74638547513302
              ],
              [
                59.637483206789945,
                -16.753946857369616
              ],
              [
                59.65052947143838,
                -16.765124002569692
              ],
              [
                59.675935355227445,
                -16.766438917654106
              ],
              [
                59.70992430786416,
                -16.756576832957844
              ],
              [
                59.730866995852445,
                -16.74178274761943
              ],
              [
                59.72194060425088,
                -16.71120466405176
              ],
              [
                59.70580443481729,
                -16.706929917737753
              ],
              [
                59.663919058840726,
                -16.725672325587315
              ],
              [
                59.64160307983682,
                -16.740796434394756
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                63.37397497970235,
                -19.651409530610167
              ],
              [
                63.3818714030422,
                -19.651732856576825
              ],
              [
                63.38547629195821,
                -19.64946956112815
              ],
              [
                63.391141117397666,
                -19.649954555697516
              ],
              [
                63.39886587936056,
                -19.649954555697516
              ],
              [
                63.40504568893087,
                -19.652702830567424
              ],
              [
                63.41053885299337,
                -19.657714269426613
              ],
              [
                63.40985220748556,
                -19.65981579396514
              ],
              [
                63.410367191616416,
                -19.66288720337029
              ],
              [
                63.41088216146925,
                -19.66636267991654
              ],
              [
                63.413113773647666,
                -19.66757503061462
              ],
              [
                63.41620367843282,
                -19.66660514656867
              ],
              [
                63.41980856734884,
                -19.667736677385125
              ],
              [
                63.42307013351095,
                -19.66789832399264
              ],
              [
                63.42821997481954,
                -19.666281850582738
              ],
              [
                63.43199652511251,
                -19.664665360873926
              ],
              [
                63.433369816128135,
                -19.663048854867288
              ],
              [
                63.43457144576681,
                -19.663048854867288
              ],
              [
                63.43525809127462,
                -19.6601391029885
              ],
              [
                63.444871128383994,
                -19.653349476636613
              ],
              [
                63.44796103316915,
                -19.648176235110213
              ],
              [
                63.42495840865743,
                -19.64090108206116
              ],
              [
                63.375232302943594,
                -19.634324777621497
              ],
              [
                63.36853750924242,
                -19.637558352126664
              ],
              [
                63.36802252511156,
                -19.648228685947583
              ],
              [
                63.370940768519766,
                -19.64984534131289
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                63.28576360269628,
                -19.771496661185136
              ],
              [
                63.287823539219715,
                -19.776342841379755
              ],
              [
                63.29091344400487,
                -19.778604341703392
              ],
              [
                63.309796195469715,
                -19.780865809928557
              ],
              [
                63.31185613199315,
                -19.778927410558005
              ],
              [
                63.31219945474706,
                -19.777312059734403
              ],
              [
                63.311341147862294,
                -19.775858229991762
              ],
              [
                63.309796195469715,
                -19.773758230280954
              ],
              [
                63.30790792032323,
                -19.772627449744334
              ],
              [
                63.30275807901464,
                -19.77117357726617
              ],
              [
                63.288853507481434,
                -19.769719691526962
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        }
      ],
      "coordinates": []
    }),
    wio_lt_sr = ee.Image("projects/coral_atlas/workflow/mapping/west_indian_ocean/west_indian_ocean_islands_low_tide_normalized_sr_jan2018_jan2020_v2_shift_mosaic/20200131T210330Z/west_indian_ocean_islands_low_tide_normalized_sr_jan2018_jan2020_v2_shift_mosaic"),
    geo = ee.Image("projects/coral_atlas/west_indian_ocean/in_out/wio_geo-clean_manual_July10"),
    benthic = ee.Image("projects/coral_atlas/west_indian_ocean/in_out/wio_benthic-clean_July10"),
    not_reef = 
    /* color: #01ff14 */
    /* shown: false */
    /* locked: true */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[55.2248077855843, -20.980851493012523],
                  [55.33741764886555, -21.08595829180467],
                  [55.4884796605843, -21.2191575703884],
                  [55.5763702855843, -21.37014202611179],
                  [55.5763702855843, -21.549074333518252],
                  [55.95265202386555, -21.487750868105195],
                  [56.05702214105305, -21.23195887279921],
                  [55.8839874730843, -20.93981411727935],
                  [55.6917267308968, -20.672797751973356],
                  [55.42530827386555, -20.62910598668815],
                  [55.1479034887093, -20.793527159750223],
                  [55.1204376683968, -20.867971649301655]]]),
            {
              "system:index": "0"
            })]),
    reef_boundary = /* color: #d63000 */ee.Geometry.Polygon(
        [[[54.04514155541353, -2.3678612513908717],
          [41.38889155541353, -10.828875034298534],
          [44.11350093041353, -15.025328720481847],
          [55.36350093041353, -24.92220360800561],
          [67.49240718041354, -21.12128945135642],
          [59.58225093041353, -3.4211882584226188]]]);
/***** End of imports. If edited, may not auto-convert in the playground. *****/
/* export maps for WIO (This is to send another go to Eldang 16/07/2020) 
Script to export maps to GCS, ready for smoothing
- note the eventual smoothed output still needs to be QC'd by UQ, 
  to ensure smoothing has not done naything untoward
 
TODO: define output params up front
  - e.g. description, export path, GCS bucket etc.
 
TODO: link this to the reef_params module
  - in that case you'd just choose the region, and the exrpot would all happen automatically
  - let's just see if this process takes off, then i'll invest time to link it up with automation
  
TODO: deal with change in dateline (i.e. WGS-84 projection wrapping)
  - Fiji/south pacific might be the only region where this happens? worth it?
  **A: resonable solution below**
*/


/*
Script to export maps to GCS, ready for smoothing
- note the eventual smoothed output still needs to be QC'd by UQ, 
  to ensure smoothing has not done naything untoward
 
TODO: define output params up front
  - e.g. description, export path, GCS bucket etc.
 
TODO: link this to the reef_params module
  - in that case you'd just choose the region, and the exrpot would all happen automatically
  - let's just see if this process takes off, then i'll invest time to link it up with automation
  
TODO: deal with change in dateline (i.e. WGS-84 projection wrapping)
  - Fiji/south pacific might be the only region where this happens? worth it?
  **A: resonable solution below**
*/
Map.setCenter(53.62766108666353, -11.173976110741622, 6)
// so we can visualise maps before export
var map_palettes = require('users/mitchest/global_reefs:Modules/colour_pals')

// will need to import depth mosaic from pixels now
var depth = pixels.select('depth')//.multiply(100).uint16()

// addiitonal masking 


var FINAL_MASK_TO_GEOBENTHIC= not_reef.merge(Refined_masks);
var add_zone = function(f) {return(f.set('zone', 1))}
var exclude_fc = FINAL_MASK_TO_GEOBENTHIC.map(add_zone)


var exclude_mask = ee.Image().byte().paint(exclude_fc, 'zone').uint8()
//Map.addLayer(exclude_mask, {}, "image extra mask zone", false)

geo = geo.where(exclude_mask.eq(1), ee.Image(0))
benthic = benthic.where(geo.eq(0), ee.Image(0)) // may not always need this (only if extra masking is applied here)

// finalise layers (include 'mapped area' as zeros)
geo = geo.where(geo.lte(2), 0)
//print (geo)
benthic = benthic.unmask(0).updateMask(geo.gte(0))

// make reef/non-reef layer 
var reef_top = geo.eq([11,13,14,15,16,25,26]).reduce(ee.Reducer.sum())
print (reef_top)
var reef_all = geo.eq([11,12,13,14,15,16,21,22,23,24,25,26]).reduce(ee.Reducer.sum())
var reef_layer = reef_top.addBands(reef_all).reduce(ee.Reducer.sum())
print (reef_layer)

// check before export

//Map.addLayer(reef_layer, {min:0, max:2}, "reef layerNoSelf", false)
//Map.addLayer(reef_layer.selfMask(), {min:0, max:2}, "reef layer", false)
Map.addLayer(wio_lt_sr, {"opacity":1,"bands":["b1","b2","b3"],"min":1,"max":1514,"gamma":1}, 'WIO_lt_sr', false)
Map.addLayer(geo, map_palettes.geo, "geomorphic map", false)
Map.addLayer(benthic, map_palettes.benthic, "benthic map", false)
//Map.addLayer(Final_mask, {}, 'Final_mask', false)
//Map.addLayer(depth, {min: -3, max: 1200, palette:['#d0d1e6','#a6bddb','#74a9cf','#3690c0','#0570b0','#045a8d','#023858']}, "depth layer", false)

//Map.addLayer(exclude_fc, {}, "vector mask zone", false)

// combine into single stack
var export_stack = depth.updateMask(geo.gte(0)).rename('depth')
                    .addBands(reef_layer.rename('reef'))
                    .addBands(geo.rename('geomorphic'))
                    .addBands(benthic.rename('benthic'))
                    .toInt16()

Map.addLayer(export_stack, {}, "export raster stack", false)

//removing the fills in the masks to visually detect gaps between them

//Map.addLayer(ee.Image().byte().paint({featureCollection:not_reef, color:1, width: 1}), {}, 'not_reefOutline', false)
//Map.addLayer(ee.Image().byte().paint({featureCollection:Rivermouth, color: 1, width: 1}), {}, 'RivermouthOutline', false)
//Map.addLayer(ee.Image().byte().paint({featureCollection: slithers, color:1, width:1}), {}, 'SlithersOutline', false)


/*// add export region
var export_geom_east = ee.Geometry.Rectangle(-179.99998,-21.4794,-168.13175,-8.4)
var export_geom_west = ee.Geometry.Rectangle(162.7051,-23.052,179.99998,-7.8)
Map.addLayer(export_geom_west, {}, "export footprint west", true)
Map.addLayer(export_geom_east, {}, "export footprint east", true)

// add raster flag for either side of dateline
var latlong = ee.Image.pixelLonLat().select('longitude').clipToCollection(ee.FeatureCollection([export_geom_west,export_geom_east]))
//Map.addLayer(latlong)

var export_stack_east = export_stack.updateMask(latlong.lte(0))
var export_stack_west = export_stack.updateMask(latlong.gt(0))

Map.addLayer(export_stack_east, {}, "export raster stack east", false)
Map.addLayer(export_stack_west, {}, "export raster stack west", false)*/

// make east/west export geometries
/*var export_geom_east = latlong.lt(0).and(latlong.gt(-179.99998)).selfMask()
                            .reduceToVectors({
                              reducer: ee.Reducer.countEvery(),
                              geometry: export_geom,
                              scale: 5,
                              maxPixels: 1e13,
                              crs: 'EPSG:4326'
                            })

var export_geom_west = latlong.gt(0).and(latlong.lt(179.99998)).selfMask()
                            .reduceToVectors({
                              reducer: ee.Reducer.countEvery(),
                              geometry: export_geom,
                              scale: 5,
                              maxPixels: 1e13,
                              crs: 'EPSG:4326'
                            })*/


// run the export
Export.image.toCloudStorage({
  image: export_stack,
  description: 'ea_stack',
  bucket: 'coral-atlas-data-pipeline',
  fileNamePrefix: 'coral-gee-export-bucket/wio_delivery20201716/wio_stack',
  region: reef_boundary, 
  scale: 5,
  crs: 'EPSG:4326',
  maxPixels: 1e13, 
  skipEmptyTiles: true
});


/*
Export.table.toCloudStorage({
  collection: slithers, 
  bucket: 'coral-atlas-data-pipeline',
  fileNamePrefix: 'coral-gee-export-bucket/ea_updated20200618/Slither_Masks',
  fileFormat: 'SHP'
});

/*



// export the convex hull boundary

// export region convex hull, or manual
/*var export_geom = geo.gte(0).reduceToVectors({scale: 1000, maxPixels: 1e13, bestEffort: true, geometry: geo.geometry().bounds(100), crs: "EPSG:4326"}).geometry().convexHull({maxError: 100})

Export.table.toCloudStorage({
  collection: ee.FeatureCollection(export_geom),
  description: 'swp_convex_hull',
  bucket: 'coral-atlas-data-pipeline',
  fileNamePrefix: 'coral-gee-export-bucket/swp/new_geom/swp_convex_hull',
  fileFormat: "SHP"
})*/