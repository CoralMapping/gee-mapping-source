/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var wcmc = ee.FeatureCollection("projects/coral_atlas/global_datasets/wcmc_reefs_2018v4_dissolved"),
    land_dist = ee.Image("projects/coral_atlas/global_datasets/mod44w6_global_distToLand"),
    json_extent = ee.FeatureCollection("projects/coral_atlas/wio_extent"),
    region_extent = 
    /* color: #00ffff */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[54.701770985703206, -2.9751249685105154],
          [52.548450673203206, -4.772691629173448],
          [52.196888173203206, -5.910289150084192],
          [51.757435048203206, -8.091037974566733],
          [48.285755360703206, -8.65623438835204],
          [44.814075673203206, -9.350691639103687],
          [46.440052235703206, -10.864858654100164],
          [45.736927235703206, -11.72673086956205],
          [43.583606923203206, -10.605801768506067],
          [41.781849110703206, -10.605801768506067],
          [41.737903798203206, -12.543027437564627],
          [44.638294423203206, -13.954584744088688],
          [46.352161610703206, -13.783928424683062],
          [48.857044423203206, -10.99430318398806],
          [49.955677235703206, -10.908013101551091],
          [52.680286610703206, -10.95116128603305],
          [53.339466298203206, -8.438948520327026],
          [54.613880360703206, -6.827435160865552],
          [55.624622548203206, -6.914694536706059],
          [56.108020985703206, -11.511507059571993],
          [58.788685048203206, -15.865441173681486],
          [56.942981923203206, -19.631456469862268],
          [54.438099110703206, -20.539442163648662],
          [54.130481923203206, -21.482966628121225],
          [54.965442860703206, -22.420415520660942],
          [55.844349110703206, -22.095048738332846],
          [57.074817860703206, -21.196440284100703],
          [58.481067860703206, -20.827232047085705],
          [59.184192860703206, -17.883867297837703],
          [63.754505360703206, -20.909357190677294],
          [64.9849741107032, -20.00354040738218],
          [63.666614735703206, -19.009403584868657],
          [61.776966298203206, -19.175515382142862],
          [60.370716298203206, -18.009288625640345],
          [60.458606923203206, -15.187980739313776],
          [58.964466298203206, -15.187980739313776],
          [56.811145985703206, -11.55456509703201],
          [57.514270985703206, -10.216806458907836],
          [56.327747548203206, -9.17720313716965],
          [56.327747548203206, -7.786369242288465],
          [57.250599110703206, -7.089164748909251],
          [56.108020985703206, -5.866575713917645],
          [57.602161610703206, -5.647957630653708],
          [57.206653798203206, -4.422260866394937],
          [56.547474110703206, -3.4138941523262103]]]),
    not_reef = 
    /* color: #01ff14 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[55.2248077855843, -20.980851493012523],
          [55.33741764886555, -21.08595829180467],
          [55.4884796605843, -21.2191575703884],
          [55.5763702855843, -21.37014202611179],
          [55.5763702855843, -21.549074333518252],
          [55.95265202386555, -21.487750868105195],
          [56.05702214105305, -21.23195887279921],
          [55.8839874730843, -20.93981411727935],
          [55.6917267308968, -20.672797751973356],
          [55.42530827386555, -20.62910598668815],
          [55.1479034887093, -20.793527159750223],
          [55.1204376683968, -20.867971649301655]]]),
    reef_boundary = 
    /* color: #d6b113 */
    /* shown: false */
    /* displayProperties: [
      {
        "type": "rectangle"
      }
    ] */
    ee.Geometry.Polygon(
        [[[40.859926354273455, -2.4006076916703782],
          [40.859926354273455, -23.630158061970967],
          [65.42535604177345, -23.630158061970967],
          [65.42535604177345, -2.4006076916703782]]], null, false),
    waves = ee.Image("projects/coral_atlas/west_indian_ocean/in_out/wio_waves"),
    geoclean1 = ee.Image("projects/coral_atlas/west_indian_ocean/in_out/wio_geo-clean"),
    geoclean2 = ee.Image("projects/coral_atlas/west_indian_ocean/in_out/wio_geo-clean2"),
    notBRS = 
    /* color: #6a87ff */
    /* shown: false */
    ee.Geometry({
      "type": "GeometryCollection",
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                63.387482463052024,
                -19.645365472856682
              ],
              [
                63.40773850553249,
                -19.668644153784328
              ],
              [
                63.41529160611843,
                -19.678989149430404
              ],
              [
                63.436920939614524,
                -19.671877036660018
              ],
              [
                63.4520271407864,
                -19.656035287644524
              ],
              [
                63.430397807290305,
                -19.644072113765077
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                56.291036095816565,
                -7.0867722217660205
              ],
              [
                56.28940531273551,
                -7.121011289921165
              ],
              [
                56.27386995812125,
                -7.1471573153460355
              ],
              [
                56.25842161681023,
                -7.177303878051007
              ],
              [
                56.23473116417594,
                -7.20216979235917
              ],
              [
                56.2546438839025,
                -7.205916530014025
              ],
              [
                56.27601572533317,
                -7.1734721625084825
              ],
              [
                56.300101054839665,
                -7.133589380808558
              ],
              [
                56.30795112093978,
                -7.104245236291353
              ],
              [
                56.30014052828841,
                -7.090191683349689
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.2730685259352,
                -5.999629727622204
              ],
              [
                55.30551252617934,
                -6.0411133762831986
              ],
              [
                55.33572492852309,
                -6.028480831205856
              ],
              [
                55.292466261530905,
                -5.981020808937045
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.36012077800136,
                -5.810591344497242
              ],
              [
                55.36406898967128,
                -5.819642578989526
              ],
              [
                55.37488365641933,
                -5.818617918244809
              ],
              [
                55.39239311686855,
                -5.868824092344553
              ],
              [
                55.387071614183,
                -5.876166794106461
              ],
              [
                55.394453053391985,
                -5.894608501413393
              ],
              [
                55.41556740275722,
                -5.850723065832636
              ],
              [
                55.38586998454433,
                -5.807517307218006
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.48387169271242,
                -4.637219583131101
              ],
              [
                55.48425732674021,
                -4.595983309592369
              ],
              [
                55.469805231341965,
                -4.56633766598496
              ],
              [
                55.44728591632287,
                -4.548840935771542
              ],
              [
                55.44447457485944,
                -4.620279988603722
              ],
              [
                55.51459907918703,
                -4.701378951626519
              ],
              [
                55.50653099447023,
                -4.744319659933407
              ],
              [
                55.51116585164797,
                -4.781441546865494
              ],
              [
                55.54103493123781,
                -4.808811235810369
              ],
              [
                55.5542528572632,
                -4.791705308715674
              ],
              [
                55.53929774107125,
                -4.7251322338930795
              ],
              [
                55.546055089364295,
                -4.66534661872443
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.50949121607328,
                -4.615556906649137
              ],
              [
                55.50193811548734,
                -4.644644106697568
              ],
              [
                55.51721597803617,
                -4.642077637192425
              ],
              [
                55.520820866952185,
                -4.622914370181706
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.50228143824125,
                -4.595537375921035
              ],
              [
                55.5050280202725,
                -4.613674752558617
              ],
              [
                55.52099252832914,
                -4.601697291529005
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.249847228469854,
                -4.468732409512815
              ],
              [
                55.209335143508916,
                -4.500991498844698
              ],
              [
                55.23238150961814,
                -4.521922788797144
              ],
              [
                55.269803689793925,
                -4.495568746798674
              ],
              [
                55.260007318970054,
                -4.4783539047080065
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.234832164921386,
                -4.384276051805047
              ],
              [
                55.23676325697225,
                -4.40085686758109
              ],
              [
                55.249337551273925,
                -4.404515335694935
              ],
              [
                55.255088207401855,
                -4.395058994482067
              ],
              [
                55.248307583012206,
                -4.39681334739751
              ],
              [
                55.23779332367383,
                -4.382179350426744
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                59.58320527844629,
                -16.423968090345323
              ],
              [
                59.61753755383692,
                -16.471383478899316
              ],
              [
                59.66422944836817,
                -16.481918657792697
              ],
              [
                59.69169526868067,
                -16.547750528447033
              ],
              [
                59.69856172375879,
                -16.60829600897816
              ],
              [
                59.66285615735254,
                -16.68460876375893
              ],
              [
                59.59556489758692,
                -16.770095486035274
              ],
              [
                59.48570161633692,
                -16.820054554554602
              ],
              [
                59.42665010266504,
                -16.830570576779582
              ],
              [
                59.56809907727442,
                -16.867372054843788
              ],
              [
                59.76173311047754,
                -16.66882241231975
              ],
              [
                59.71778779797754,
                -16.441091650114952
              ],
              [
                59.63538737136394,
                -16.406194869823004
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.828112600685486,
                -4.33543569353075
              ],
              [
                55.816439627052674,
                -4.357944236441032
              ],
              [
                55.81935787046088,
                -4.377200059743823
              ],
              [
                55.8370470899073,
                -4.38572574892624
              ],
              [
                55.84176799665467,
                -4.3695082258315034
              ],
              [
                55.85953473028816,
                -4.35654261774953
              ],
              [
                55.84219279949729,
                -4.33469217128254
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.920225785017635,
                -4.330324164971091
              ],
              [
                55.92168490672174,
                -4.355229183853476
              ],
              [
                55.934473679304745,
                -4.338540344514846
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.889240906477596,
                -4.341474963063471
              ],
              [
                55.887781784773495,
                -4.329749808490764
              ],
              [
                55.87542216563287,
                -4.340362364970015
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.86218624837686,
                -4.282937819597402
              ],
              [
                55.873000915124905,
                -4.289699478636757
              ],
              [
                55.87407379873086,
                -4.283665342744513
              ],
              [
                55.86733608968545,
                -4.280412880955775
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.21067641039947,
                -3.704742576824706
              ],
              [
                55.19780180712799,
                -3.7368612393882796
              ],
              [
                55.21891615649322,
                -3.732835764595293
              ],
              [
                55.22664091845611,
                -3.7144211236621274
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.671871107340266,
                -3.7872876060180074
              ],
              [
                55.65470496964495,
                -3.8306220000104907
              ],
              [
                55.68474571061175,
                -3.8301081662486345
              ],
              [
                55.691097181559016,
                -3.7927687564602595
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                53.35571387720689,
                -5.075299855178982
              ],
              [
                53.33065131617173,
                -5.12163602705173
              ],
              [
                53.34747413111314,
                -5.129928309541868
              ],
              [
                53.374768290048685,
                -5.080429485078754
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                53.31915000391587,
                -5.10966759466591
              ],
              [
                53.30181220484361,
                -5.127705646446462
              ],
              [
                53.31674674463853,
                -5.1321509648966686
              ],
              [
                53.327303919321146,
                -5.1204391938878775
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                53.36076496268776,
                -5.418901278323088
              ],
              [
                53.31141231681374,
                -5.44034811903238
              ],
              [
                53.34153888846901,
                -5.462221400086802
              ],
              [
                53.37724445487526,
                -5.454702549625735
              ],
              [
                53.38024852897194,
                -5.4321454334280554
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                53.27836750175026,
                -5.417790465007561
              ],
              [
                53.28137157584694,
                -5.431547316565776
              ],
              [
                53.29733608390358,
                -5.435563232677452
              ],
              [
                53.31175563956764,
                -5.420097536532065
              ],
              [
                53.2873797240403,
                -5.4095874727034285
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                50.71737073220993,
                -9.334594832932975
              ],
              [
                50.73007367410446,
                -9.34738340960935
              ],
              [
                50.744579060457,
                -9.331461136587095
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                51.088128305231436,
                -9.298999561205788
              ],
              [
                51.116967313404665,
                -9.342364400316043
              ],
              [
                51.11902721824729,
                -9.416885235545312
              ],
              [
                51.0943142934007,
                -9.447702781297629
              ],
              [
                51.040749675318985,
                -9.527282144078118
              ],
              [
                50.97071585246313,
                -9.588052558995026
              ],
              [
                50.982390057612704,
                -9.610313710010008
              ],
              [
                51.043504612114354,
                -9.605490154337069
              ],
              [
                51.172585272570245,
                -9.43856087273725
              ],
              [
                51.17121199262463,
                -9.316617163025764
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                52.7317163262088,
                -7.187090045550269
              ],
              [
                52.79832094046661,
                -7.1632456539209555
              ],
              [
                52.794201067419735,
                -7.132586746939729
              ],
              [
                52.72141664359161,
                -7.168014632151676
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                52.77188508841583,
                -7.007886132129423
              ],
              [
                52.761071160492904,
                -7.031397760126753
              ],
              [
                52.736522844763485,
                -7.0467309128523
              ],
              [
                52.755748918982235,
                -7.053886175831244
              ],
              [
                52.786991289587704,
                -7.014701240610714
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        }
      ],
      "coordinates": []
    }),
    notRC = 
    /* color: #8b1b05 */
    /* shown: false */
    ee.Geometry({
      "type": "GeometryCollection",
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                63.35897378005308,
                -19.66080560630316
              ],
              [
                63.35382393874448,
                -19.66500854682159
              ],
              [
                63.325328150170265,
                -19.66274543869308
              ],
              [
                63.30987862624448,
                -19.67826325284056
              ],
              [
                63.29820565261167,
                -19.70864795124732
              ],
              [
                63.294085779564796,
                -19.73353324505831
              ],
              [
                63.30438546218198,
                -19.75873777212658
              ],
              [
                63.31743172683042,
                -19.770692373502364
              ],
              [
                63.31846169509214,
                -19.799444363645353
              ],
              [
                63.32910470046323,
                -19.82302358011929
              ],
              [
                63.34009102858823,
                -19.830128959683012
              ],
              [
                63.358287134545265,
                -19.83174377436466
              ],
              [
                63.37510994948667,
                -19.830451923932362
              ],
              [
                63.39982918776792,
                -19.826253337486527
              ],
              [
                63.42386178054136,
                -19.811718912556213
              ],
              [
                63.425921717064796,
                -19.800736466018027
              ],
              [
                63.442401209252296,
                -19.77812316037616
              ],
              [
                63.457164087670265,
                -19.766815303694507
              ],
              [
                63.459910669701515,
                -19.75001357856354
              ],
              [
                63.43107155837339,
                -19.756152875621353
              ],
              [
                63.39742592849058,
                -19.771984709150466
              ],
              [
                63.35897378005308,
                -19.781030765265317
              ],
              [
                63.34112099684995,
                -19.757122216719434
              ],
              [
                63.32498482741636,
                -19.746136006090286
              ],
              [
                63.327044763939796,
                -19.721575860180597
              ],
              [
                63.338031092064796,
                -19.705092593062616
              ],
              [
                63.37579659499448,
                -19.693133081161477
              ],
              [
                63.40806893386167,
                -19.67147439401659
              ],
              [
                63.39502266921323,
                -19.65789581372209
              ],
              [
                63.363780298607765,
                -19.658865750448278
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                59.61153532059345,
                -16.42994585013174
              ],
              [
                59.5926525691286,
                -16.444105389151165
              ],
              [
                59.64689756424579,
                -16.55339537348498
              ],
              [
                59.63694120438251,
                -16.616570980797796
              ],
              [
                59.663033733679384,
                -16.646177397268854
              ],
              [
                59.63488126785907,
                -16.695182407777324
              ],
              [
                59.599862346960634,
                -16.715241237803752
              ],
              [
                59.56381345780048,
                -16.71063775825573
              ],
              [
                59.55282712967548,
                -16.732338903472332
              ],
              [
                59.4772961238161,
                -16.8141891381164
              ],
              [
                59.48313261063251,
                -16.828320345564016
              ],
              [
                59.503731975866884,
                -16.82601998825323
              ],
              [
                59.52055479080829,
                -16.821747822006593
              ],
              [
                59.54149747879657,
                -16.810902659816936
              ],
              [
                59.5593502619997,
                -16.80794478065039
              ],
              [
                59.58544279129657,
                -16.78493747978403
              ],
              [
                59.62252164871845,
                -16.735626740311236
              ],
              [
                59.66097379715595,
                -16.70340349462209
              ],
              [
                59.67710996658954,
                -16.67906805138719
              ],
              [
                59.69015623123798,
                -16.6692014485878
              ],
              [
                59.69736600907001,
                -16.635980147574422
              ],
              [
                59.70938230545673,
                -16.58169534592866
              ],
              [
                59.70457578690204,
                -16.567216809781215
              ],
              [
                59.70732236893329,
                -16.547142493345337
              ],
              [
                59.70903898270282,
                -16.523445529238447
              ],
              [
                59.708695659948916,
                -16.495466204098182
              ],
              [
                59.69564939530048,
                -16.48624859887297
              ],
              [
                59.6860363581911,
                -16.473409060251615
              ],
              [
                59.67607999832782,
                -16.47703055475724
              ],
              [
                59.675736675573916,
                -16.465507382754478
              ],
              [
                59.66818357498798,
                -16.457605383167138
              ],
              [
                59.64243436844501,
                -16.444105389151165
              ],
              [
                59.6201183894411,
                -16.4335681560471
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                56.25391150735489,
                -7.18135521990668
              ],
              [
                56.257730982047896,
                -7.178246962093158
              ],
              [
                56.26244096981338,
                -7.171913277502194
              ],
              [
                56.26758004788727,
                -7.163876326179949
              ],
              [
                56.257173073517,
                -7.174542578174112
              ],
              [
                56.24824668191544,
                -7.175990273077357
              ],
              [
                56.24258185647599,
                -7.1814403772826685
              ],
              [
                56.24043608926407,
                -7.188508383878869
              ],
              [
                56.23897695862647,
                -7.196598126839712
              ],
              [
                56.24301100991837,
                -7.194809887396047
              ],
              [
                56.24970580361954,
                -7.186549790651255
              ],
              [
                56.252366554962315,
                -7.181781006627136
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.760208460300966,
                -4.586693132071576
              ],
              [
                55.76434979101996,
                -4.586864243678628
              ],
              [
                55.767203661411806,
                -4.581688099434422
              ],
              [
                55.761731955021425,
                -4.5807897565333375
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.76510413521519,
                -4.589938076120206
              ],
              [
                55.76654180011148,
                -4.591991406255027
              ],
              [
                55.769202551454256,
                -4.590708077420064
              ],
              [
                55.76883777102823,
                -4.587820579103629
              ],
              [
                55.76594098529215,
                -4.587884745859778
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.19917509814361,
                -3.7365186465077436
              ],
              [
                55.203123309813535,
                -3.732064926891052
              ],
              [
                55.20365813015946,
                -3.7288413225669137
              ],
              [
                55.20846464871415,
                -3.7243019146163796
              ],
              [
                55.2112112307454,
                -3.720105082664645
              ],
              [
                55.210782077303016,
                -3.7159082307250575
              ],
              [
                55.21498778103837,
                -3.7132530691853836
              ],
              [
                55.21515944241532,
                -3.7035745095572596
              ],
              [
                55.19722082852372,
                -3.703660160991948
              ],
              [
                55.19576170681962,
                -3.7330381128393753
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                53.38371079902288,
                -4.865353532696892
              ],
              [
                53.372123602219546,
                -4.879079531184894
              ],
              [
                53.359420660325014,
                -4.913970649101185
              ],
              [
                53.378389242478335,
                -4.919272571180837
              ],
              [
                53.38903224784943,
                -4.90456390937379
              ],
              [
                53.39031970817658,
                -4.871126154412039
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                53.32867721033677,
                -5.082481325608958
              ],
              [
                53.31863501978501,
                -5.094621248270158
              ],
              [
                53.32962134791001,
                -5.119840776465828
              ],
              [
                53.34841826868638,
                -5.111377384420133
              ],
              [
                53.360005411630716,
                -5.0888932851326185
              ],
              [
                53.36300944129869,
                -5.079147054884135
              ],
              [
                53.35193732691392,
                -5.0747013956996945
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                53.304387125497904,
                -5.108556228879029
              ],
              [
                53.30816367579087,
                -5.124884562914209
              ],
              [
                53.31992248011216,
                -5.112574234532677
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                53.32170533027678,
                -5.4060567630058545
              ],
              [
                53.32056807195998,
                -5.407652255397203
              ],
              [
                53.31730650579787,
                -5.421935362068974
              ],
              [
                53.316276537536154,
                -5.4341113896819175
              ],
              [
                53.322756754516135,
                -5.441246000295406
              ],
              [
                53.331768976806174,
                -5.448850462148551
              ],
              [
                53.347003924010764,
                -5.451499184688541
              ],
              [
                53.35331247961379,
                -5.447739704058611
              ],
              [
                53.35562990820266,
                -5.423088891014472
              ],
              [
                53.347990976928244,
                -5.417663013444322
              ],
              [
                53.34713267004348,
                -5.415526827800499
              ],
              [
                53.34365652716018,
                -5.415526827800499
              ],
              [
                53.336017595885764,
                -5.4086482587430895
              ],
              [
                53.329494463561545,
                -5.405230307146103
              ],
              [
                53.32292841589309,
                -5.405913899009305
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                45.20079062201968,
                -13.017780773125422
              ],
              [
                45.12268469550601,
                -13.043535890021626
              ],
              [
                45.03633902289859,
                -13.010923439944898
              ],
              [
                44.98964712836734,
                -12.972953800291556
              ],
              [
                44.98106405951968,
                -12.976132098396622
              ],
              [
                44.98484060981265,
                -12.98449584662958
              ],
              [
                44.992222049021635,
                -12.996204621182782
              ],
              [
                45.00132010200015,
                -13.001891541029911
              ],
              [
                45.024151065134916,
                -13.023467198196416
              ],
              [
                45.03977225043765,
                -13.035341370763204
              ],
              [
                45.06054327704898,
                -13.051061229772404
              ],
              [
                45.08697912909976,
                -13.062934077640787
              ],
              [
                45.10277197577945,
                -13.067448954509661
              ],
              [
                45.12663290717593,
                -13.070458826548485
              ],
              [
                45.14036581733218,
                -13.069288325117112
              ],
              [
                45.15032217719546,
                -13.067281738320236
              ],
              [
                45.17518911415312,
                -13.056245219439738
              ],
              [
                45.198020077287886,
                -13.045709900586763
              ],
              [
                45.21707449012968,
                -13.033668986549927
              ],
              [
                45.235270596086714,
                -13.018617020290952
              ],
              [
                45.24402532631132,
                -13.007076560243519
              ],
              [
                45.23956213051054,
                -13.004400434826314
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                44.94877536431133,
                -12.881612350730084
              ],
              [
                44.953410221489065,
                -12.889644596621032
              ],
              [
                44.96010501519024,
                -12.900521185513535
              ],
              [
                44.962679935844534,
                -12.90487168868353
              ],
              [
                44.967143131645315,
                -12.923109512563219
              ],
              [
                44.96851642266094,
                -12.92829617340439
              ],
              [
                44.9690314067918,
                -12.939840289590967
              ],
              [
                44.97349460259258,
                -12.944190107818589
              ],
              [
                44.97349460259258,
                -12.951551165744387
              ],
              [
                44.97624118462383,
                -12.954227860165027
              ],
              [
                44.97606952324688,
                -12.95874471677239
              ],
              [
                44.98207767144024,
                -12.974971266224342
              ],
              [
                44.992892338188284,
                -12.970287422451703
              ],
              [
                44.981906010063284,
                -12.91307050814189
              ],
              [
                44.966628147514456,
                -12.881110326809742
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                45.25799426230605,
                -12.889681601276202
              ],
              [
                45.26571902426894,
                -12.884996156503771
              ],
              [
                45.274302093116596,
                -12.87796782500847
              ],
              [
                45.27910861167128,
                -12.87361685434309
              ],
              [
                45.278078643409565,
                -12.85922464428706
              ],
              [
                45.289579955665424,
                -12.847509445377078
              ],
              [
                45.290266601173236,
                -12.838806372493094
              ],
              [
                45.227095214454486,
                -12.829768247136773
              ],
              [
                45.24202975424941,
                -12.86993520479734
              ],
              [
                45.240828124610736,
                -12.882486060746873
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                45.24872454795058,
                -12.88867758477668
              ],
              [
                45.23396166953261,
                -12.886334863955476
              ],
              [
                45.22503527793105,
                -12.907920533116197
              ],
              [
                45.23756655844863,
                -12.91494802340291
              ],
              [
                45.25301608237441,
                -12.891020283679257
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                45.20969827371578,
                -12.932798474127468
              ],
              [
                45.20592172342281,
                -12.954045543140891
              ],
              [
                45.219311310825155,
                -12.956889501527758
              ],
              [
                45.2301259775732,
                -12.932129245696112
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                45.28305306606092,
                -12.72885326193989
              ],
              [
                45.26623025111952,
                -12.718471609768038
              ],
              [
                45.26211037807264,
                -12.710601364697688
              ],
              [
                45.25198235683241,
                -12.707084793393902
              ],
              [
                45.23739113979139,
                -12.691008419273178
              ],
              [
                45.22513098123877,
                -12.680916324725763
              ],
              [
                45.218779510291505,
                -12.67354735492108
              ],
              [
                45.20933813455908,
                -12.663498416282017
              ],
              [
                45.199038451941895,
                -12.656463923584072
              ],
              [
                45.18410391214697,
                -12.637871830943988
              ],
              [
                45.15972799661963,
                -12.628826539853197
              ],
              [
                45.15303320291846,
                -12.621623579217337
              ],
              [
                45.13758367899268,
                -12.61425289796866
              ],
              [
                45.12453741434424,
                -12.613080270020438
              ],
              [
                45.103938049109864,
                -12.643901847144717
              ],
              [
                45.12299246195166,
                -12.661656067898784
              ],
              [
                45.15099756772485,
                -12.642848672907807
              ],
              [
                45.18618815000024,
                -12.681203098657065
              ],
              [
                45.290214944433835,
                -12.73847274729282
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                45.061688395573626,
                -12.59705008103259
              ],
              [
                45.06409165485097,
                -12.607939244010462
              ],
              [
                45.0877809248705,
                -12.60760419974196
              ],
              [
                45.114903422429094,
                -12.604421257337133
              ],
              [
                45.11026856525136,
                -12.595877374350435
              ],
              [
                45.09207245929433,
                -12.583479861472634
              ],
              [
                45.081944438054094,
                -12.584317550131843
              ],
              [
                45.07662293536855,
                -12.588338417634652
              ],
              [
                45.065464945866594,
                -12.591856625010678
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                44.944739930496546,
                -12.658525893289758
              ],
              [
                44.97340738044772,
                -12.75531605158549
              ],
              [
                45.00979959236178,
                -12.762682648316584
              ],
              [
                45.00722467170748,
                -12.710944518234125
              ],
              [
                44.97563897834811,
                -12.650653794636133
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                44.99999763783634,
                -12.670204037439879
              ],
              [
                45.054757617084384,
                -12.686951607529585
              ],
              [
                45.070722125141025,
                -12.66785928976794
              ],
              [
                44.99570610341251,
                -12.647090583584708
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                46.4583082891636,
                -12.32347050771603
              ],
              [
                46.43324572812844,
                -12.348625199676828
              ],
              [
                46.43049914609719,
                -12.353488161392791
              ],
              [
                46.43101413022805,
                -12.35717724446653
              ],
              [
                46.436850617044456,
                -12.36153700282711
              ],
              [
                46.43873889219094,
                -12.365393651542373
              ],
              [
                46.44354541074563,
                -12.364890613632701
              ],
              [
                46.454875061624534,
                -12.365393651542373
              ],
              [
                46.46071154844094,
                -12.36589668848382
              ],
              [
                46.464831421487816,
                -12.356003450950523
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                46.479079315774925,
                -12.292443065038528
              ],
              [
                46.465861389749534,
                -12.303512735444002
              ],
              [
                46.476847717874534,
                -12.309550540915547
              ],
              [
                46.484057495706566,
                -12.301835542627082
              ],
              [
                46.49143893491555,
                -12.294791215899066
              ],
              [
                46.4912672735386,
                -12.291604434649152
              ],
              [
                46.485087463968284,
                -12.292443065038528
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                47.37064251040342,
                -11.480535753029567
              ],
              [
                47.28652843569639,
                -11.538736225549375
              ],
              [
                47.31948742007139,
                -11.575063354136647
              ],
              [
                47.33253368471983,
                -11.586498696856667
              ],
              [
                47.347296563137796,
                -11.563291189509373
              ],
              [
                47.380255547512796,
                -11.538736225549375
              ],
              [
                47.41733440493467,
                -11.501395109601424
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                46.21438244043764,
                -9.385566748650627
              ],
              [
                46.2342951601642,
                -9.473285851119037
              ],
              [
                46.342098504890764,
                -9.45940130299509
              ],
              [
                46.419689447273576,
                -9.43772674173927
              ],
              [
                46.455395013679826,
                -9.448564192933484
              ],
              [
                46.49453380762514,
                -9.440097463318398
              ],
              [
                46.510326654304826,
                -9.399454268544186
              ],
              [
                46.449215204109514,
                -9.376759740370064
              ],
              [
                46.34896495996889,
                -9.372694891906315
              ],
              [
                46.2562678164142,
                -9.373372369956398
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                47.627532610200284,
                -9.760201337016902
              ],
              [
                47.639720567963955,
                -9.760370513705473
              ],
              [
                47.66083491732919,
                -9.726364274102803
              ],
              [
                47.65362513949716,
                -9.711644081894251
              ],
              [
                47.63542903354013,
                -9.690831671464162
              ],
              [
                47.6201511709913,
                -9.686770562710436
              ],
              [
                47.61019481112802,
                -9.677971325208969
              ],
              [
                47.60041011264169,
                -9.670017969943597
              ],
              [
                47.5816990225538,
                -9.662402879039403
              ],
              [
                47.56796611239755,
                -9.66646428230799
              ],
              [
                47.56075633456552,
                -9.677971325208969
              ],
              [
                47.55903972079599,
                -9.69066245958069
              ],
              [
                47.5542332022413,
                -9.69218536345969
              ],
              [
                47.54977000644052,
                -9.698446117873361
              ],
              [
                47.54256022860849,
                -9.70572198286097
              ],
              [
                47.51526606967294,
                -9.7348238614273
              ],
              [
                47.52556575229013,
                -9.740068697969463
              ],
              [
                47.53947032382333,
                -9.744805898852027
              ],
              [
                47.55251658847177,
                -9.75191157404641
              ],
              [
                47.55749476840341,
                -9.761047219600401
              ],
              [
                47.56796611239755,
                -9.766799164185365
              ],
              [
                47.574317583344815,
                -9.771366814081961
              ],
              [
                47.59045375277841,
                -9.771366814081961
              ],
              [
                47.602298387788174,
                -9.766968337521696
              ],
              [
                47.61362803866708,
                -9.761385572032285
              ],
              [
                47.621524462006924,
                -9.759524629403431
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                52.75602583549783,
                -7.076935376740097
              ],
              [
                52.7488160576658,
                -7.079831378755195
              ],
              [
                52.73800139091775,
                -7.091926249392546
              ],
              [
                52.73250822685525,
                -7.105894577922588
              ],
              [
                52.72907499931619,
                -7.125824262734697
              ],
              [
                52.72753004692361,
                -7.141154199938684
              ],
              [
                52.733194872363065,
                -7.166191991793118
              ],
              [
                52.73954634331033,
                -7.167554553285269
              ],
              [
                52.749674364550565,
                -7.163126213541086
              ],
              [
                52.762892290575955,
                -7.158357184173955
              ],
              [
                52.77353529594705,
                -7.149670609748762
              ],
              [
                52.7762818779783,
                -7.133829960647359
              ],
              [
                52.77267698906228,
                -7.104872519487724
              ],
              [
                52.76907210014627,
                -7.085623328238472
              ],
              [
                52.75928740165994,
                -7.078127850359325
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                52.73158734629545,
                -7.024495413221058
              ],
              [
                52.739655431012245,
                -7.038636147062533
              ],
              [
                52.75150006602201,
                -7.032502869587088
              ],
              [
                52.7592248279849,
                -7.022962054776992
              ],
              [
                52.76042645762357,
                -7.012058026779333
              ],
              [
                52.74978345225248,
                -7.008139329350144
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                51.081197547586875,
                -9.179241670570303
              ],
              [
                50.99811344114156,
                -9.179241670570303
              ],
              [
                50.95348148313375,
                -9.233465708747856
              ],
              [
                50.92532901731344,
                -9.61685978455494
              ],
              [
                51.034505653055625,
                -9.620921736300918
              ],
              [
                51.10935001340719,
                -9.467210729005341
              ],
              [
                51.11484317746969,
                -9.42589335586662
              ],
              [
                51.12102298704,
                -9.405571520267687
              ],
              [
                51.12308292356344,
                -9.370344178132845
              ],
              [
                51.105916785868125,
                -9.335113261538583
              ],
              [
                51.08463077512594,
                -9.304622093241917
              ],
              [
                51.07364444700094,
                -9.267351499936968
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        }
      ],
      "coordinates": []
    }),
    notSL = 
    /* color: #18faff */
    /* shown: false */
    ee.Geometry.MultiPolygon(
        [[[[59.638051022284046, -16.385113304999265],
           [59.63747166513683, -16.386719023397536],
           [59.63845871805431, -16.39303883777417],
           [59.64547537683727, -16.392704773877227],
           [59.65266369699718, -16.385870295888406],
           [59.6491017234254, -16.379262033499604],
           [59.63888787149669, -16.384038120978833]]],
         [[[55.92726365830179, -4.580810414679744],
           [55.92842237259622, -4.589323237524131],
           [55.93945161606546, -4.596723749769661],
           [55.952111642615755, -4.593087669534037],
           [55.93855039383646, -4.580938749445284],
           [55.93352929856058, -4.57871427691615]]],
         [[[53.38542735893341, -4.868646049930336],
           [53.3902338774881, -4.883612058595852],
           [53.39092054418197, -4.893574839600482],
           [53.38800227958771, -4.909010748322284],
           [53.3752135070047, -4.918417425313263],
           [53.394353750534975, -4.9193580857071755],
           [53.402850988694155, -4.894643931190626],
           [53.3986452849588, -4.87181031955577],
           [53.3905782199801, -4.866171016616823]]]]),
    notRS = 
    /* color: #cdffb1 */
    /* shown: false */
    ee.Geometry({
      "type": "GeometryCollection",
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                56.23603116066767,
                -7.200658750714251
              ],
              [
                56.26326009071769,
                -7.168513765468862
              ],
              [
                56.27244397438468,
                -7.149267247496633
              ],
              [
                56.289781773456944,
                -7.113326889815983
              ],
              [
                56.292270863422765,
                -7.081983238164409
              ],
              [
                56.28712102211417,
                -7.082153589863299
              ],
              [
                56.26600667274894,
                -7.1265532211206315
              ],
              [
                56.23888417519034,
                -7.169049882923931
              ],
              [
                56.23064442909659,
                -7.194000986881247
              ],
              [
                56.234850132831944,
                -7.20149456621353
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.3376331376205,
                -5.814690034760336
              ],
              [
                55.33196831218105,
                -5.831426043231253
              ],
              [
                55.34690285197597,
                -5.868311807215317
              ],
              [
                55.38209343425136,
                -5.896657542209159
              ],
              [
                55.39273643962245,
                -5.891193416609064
              ],
              [
                55.38655663005214,
                -5.875825275240834
              ],
              [
                55.39204979411464,
                -5.868824092344553
              ],
              [
                55.37454033366542,
                -5.819642578989526
              ],
              [
                55.36458397380214,
                -5.82083801416446
              ],
              [
                55.36012077800136,
                -5.811274461613691
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.410114515192056,
                -4.556027157040039
              ],
              [
                55.367686235535324,
                -4.597908836878544
              ],
              [
                55.351206743347824,
                -4.649239661902916
              ],
              [
                55.36501522396936,
                -4.664200662875082
              ],
              [
                55.37149051613818,
                -4.665821022733948
              ],
              [
                55.39101204901779,
                -4.662907184890436
              ],
              [
                55.39976673330511,
                -4.671248000462848
              ],
              [
                55.40968022376144,
                -4.678861445927304
              ],
              [
                55.41894295169075,
                -4.72270419385055
              ],
              [
                55.456365131866534,
                -4.816448866093658
              ],
              [
                55.543225788604815,
                -4.812343528772174
              ],
              [
                55.50443031741341,
                -4.776762903523618
              ],
              [
                55.50065376712044,
                -4.712439404403126
              ],
              [
                55.43954231692513,
                -4.641608243008132
              ],
              [
                55.44778206301888,
                -4.549551343988759
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.493398993223856,
                -4.596932859210054
              ],
              [
                55.485159247130106,
                -4.613188044883674
              ],
              [
                55.48378595611448,
                -4.635431379913749
              ],
              [
                55.50181040069456,
                -4.647066076478262
              ],
              [
                55.510393469542215,
                -4.6227698748294275
              ],
              [
                55.50181040069456,
                -4.594879546193957
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.212800440307944,
                -4.497264329196222
              ],
              [
                55.248763498779624,
                -4.468513445069405
              ],
              [
                55.22172683190951,
                -4.454479865518051
              ],
              [
                55.19589179467806,
                -4.469968130037858
              ],
              [
                55.19898169946322,
                -4.494012797884519
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.237321254887206,
                -4.381708661553993
              ],
              [
                55.24822175232373,
                -4.397198448704215
              ],
              [
                55.25766312805615,
                -4.394117632678941
              ],
              [
                55.25186955658398,
                -4.383676994868549
              ],
              [
                55.24092614380322,
                -4.381195182445789
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                59.542178209354496,
                -16.45623815582866
              ],
              [
                59.536685045291996,
                -16.70170917344621
              ],
              [
                59.56003099255762,
                -16.739193173043283
              ],
              [
                59.618395860721684,
                -16.720123286782073
              ],
              [
                59.665087755252934,
                -16.65237691127468
              ],
              [
                59.663027818729496,
                -16.567495712295862
              ],
              [
                59.61976915173731,
                -16.438457354556203
              ],
              [
                59.55179124646387,
                -16.435823023261843
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.852925767275465,
                -4.359623588421032
              ],
              [
                55.836703767153395,
                -4.373402219247135
              ],
              [
                55.83327053961433,
                -4.386667121315257
              ],
              [
                55.8439993756739,
                -4.387522913366598
              ],
              [
                55.861680497500075,
                -4.3633892020885
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.91087023997369,
                -4.340508790930588
              ],
              [
                55.921513245344784,
                -4.355913846289375
              ],
              [
                55.92013995432916,
                -4.330580921933151
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.85276286387506,
                -4.310749537479082
              ],
              [
                55.86495082163873,
                -4.335740786110828
              ],
              [
                55.8756796576983,
                -4.340447949496965
              ],
              [
                55.8881251075274,
                -4.3300921513473485
              ],
              [
                55.873018906355526,
                -4.308096308642123
              ],
              [
                55.86168925547662,
                -4.307582779410871
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.8547189784794,
                -4.2807552460055325
              ],
              [
                55.84690838582803,
                -4.2804984722325745
              ],
              [
                55.8446338725834,
                -4.286061884687516
              ],
              [
                55.85806637532998,
                -4.298044481629411
              ],
              [
                55.87428837545205,
                -4.299756265830215
              ],
              [
                55.874717528894436,
                -4.290854946031404
              ],
              [
                55.861757094934475,
                -4.282723842069514
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.692185617195754,
                -4.27719858268964
              ],
              [
                55.66368981902183,
                -4.291235487690717
              ],
              [
                55.65188294437173,
                -4.3242297560663445
              ],
              [
                55.6581109773296,
                -4.334280744907191
              ],
              [
                55.66257685471414,
                -4.3334864155632
              ],
              [
                55.66558359747043,
                -4.3316650437860895
              ],
              [
                55.667783027973876,
                -4.332766906986063
              ],
              [
                55.637935460377456,
                -4.344855793288283
              ],
              [
                55.66265469929278,
                -4.361244961572723
              ],
              [
                55.65733319476932,
                -4.3660375487809135
              ],
              [
                55.64617520141965,
                -4.372199401620932
              ],
              [
                55.753291937408044,
                -4.39154044383805
              ],
              [
                55.78762422447517,
                -4.369289643969999
              ],
              [
                55.80341707634194,
                -4.3398491101844705
              ],
              [
                55.796550618493555,
                -4.2771985823949255
              ],
              [
                55.723766170265144,
                -4.272063065314076
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.76308989797191,
                -4.576926577884321
              ],
              [
                55.76097631744807,
                -4.577439916803712
              ],
              [
                55.75812244705622,
                -4.57989967405843
              ],
              [
                55.760311129612376,
                -4.585867223885809
              ],
              [
                55.763100626987864,
                -4.583963602291873
              ],
              [
                55.76498890213435,
                -4.577568252173901
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.18449805041412,
                -3.7018304269569944
              ],
              [
                55.18398306628326,
                -3.7204166304280624
              ],
              [
                55.19780180712799,
                -3.7363473500172995
              ],
              [
                55.2109339024649,
                -3.703457806005205
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.671871107340266,
                -3.787630178938081
              ],
              [
                55.69058219742816,
                -3.789171755400169
              ],
              [
                55.6929854567055,
                -3.756284196870975
              ],
              [
                55.64783851456683,
                -3.7561129042498282
              ],
              [
                55.63153068375628,
                -3.7691310475296937
              ],
              [
                55.63874046158831,
                -3.814350447954211
              ],
              [
                55.655391615152766,
                -3.828224106482748
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                53.36628813514123,
                -4.8715873424663325
              ],
              [
                53.346461246103146,
                -4.9105836146244215
              ],
              [
                53.3700646854342,
                -4.923239810183643
              ],
              [
                53.38113684424768,
                -4.914089746933494
              ],
              [
                53.39049238929162,
                -4.884158757105654
              ],
              [
                53.38405508765588,
                -4.865515350480603
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                53.3014688820897,
                -5.128047595118687
              ],
              [
                53.32129577112779,
                -5.107701330808468
              ],
              [
                53.29915145350083,
                -5.107188391418856
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                53.33768943262681,
                -5.076069302265164
              ],
              [
                53.31314185572251,
                -5.086841465033535
              ],
              [
                53.3303938241063,
                -5.122234442793429
              ],
              [
                53.3564005227147,
                -5.0738464526234965
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                53.29619832639789,
                -5.3330725369637175
              ],
              [
                53.263925987530705,
                -5.369989775096002
              ],
              [
                53.30443807249164,
                -5.3834913555177035
              ],
              [
                53.32795568113422,
                -5.352385999671645
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                53.31141231681374,
                -5.440177230889103
              ],
              [
                53.36196659232643,
                -5.4183031483301045
              ],
              [
                53.346688729777604,
                -5.4018116169021475
              ],
              [
                53.319023119567404,
                -5.389080225112215
              ],
              [
                53.29438971197463,
                -5.393438226116041
              ],
              [
                53.28683661138869,
                -5.409844537241894
              ],
              [
                53.31018255865432,
                -5.419243785958078
              ],
              [
                53.30983923590041,
                -5.430693582195367
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                50.71676991739059,
                -9.332477473623397
              ],
              [
                50.73900006570602,
                -9.325955926166305
              ],
              [
                50.72011731424118,
                -9.318417881775293
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                50.924642371805625,
                -9.240243128011784
              ],
              [
                50.866964149149375,
                -9.40421668874566
              ],
              [
                50.987813758524375,
                -9.629045493331004
              ],
              [
                51.04068546262594,
                -9.179919522333895
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        }
      ],
      "coordinates": []
    }),
    Deep = 
    /* color: #0c16c2 */
    /* shown: false */
    ee.Geometry({
      "type": "GeometryCollection",
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.22752818329987,
                -4.408108871795463
              ],
              [
                55.24091777070221,
                -4.414227587181845
              ],
              [
                55.24602469666657,
                -4.4121737582671585
              ],
              [
                55.238085357982484,
                -4.401818951026618
              ],
              [
                55.22963103516754,
                -4.401690584742926
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.10923834644881,
                -4.2909914005764485
              ],
              [
                55.04881354176131,
                -4.30331627503444
              ],
              [
                55.074219425550375,
                -4.350559774055848
              ],
              [
                55.22734137379256,
                -4.338235667410778
              ],
              [
                55.28364630543319,
                -4.403277280043641
              ],
              [
                55.2019354900035,
                -4.459413893211122
              ],
              [
                55.22184820973006,
                -4.447091587584681
              ],
              [
                55.241760929456625,
                -4.451883619850726
              ],
              [
                55.274719913831625,
                -4.492956898680837
              ],
              [
                55.24794073902694,
                -4.513492671837868
              ],
              [
                55.23214789234725,
                -4.532658869311558
              ],
              [
                55.21360846363631,
                -4.5107546022620015
              ],
              [
                55.17652960621444,
                -4.495695035243141
              ],
              [
                55.11679144703475,
                -4.490903289511004
              ],
              [
                54.978089054456625,
                -4.531974370997968
              ],
              [
                54.91697760426131,
                -4.6524360040557715
              ],
              [
                54.980714183904006,
                -4.867446367255372
              ],
              [
                55.07272468195088,
                -4.967327610463236
              ],
              [
                55.26017890558369,
                -4.968011676737542
              ],
              [
                55.273254757092175,
                -4.845957072348354
              ],
              [
                55.30716420883822,
                -4.645328294065157
              ],
              [
                55.34836293930697,
                -4.535817464465671
              ],
              [
                55.39436818833041,
                -4.29072742675142
              ],
              [
                55.19455434555697,
                -4.305791140344339
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.79562920448245,
                -4.47278322018755
              ],
              [
                55.7818962943262,
                -4.549449268891032
              ],
              [
                55.83614128944339,
                -4.630213595310534
              ],
              [
                55.8917595755762,
                -4.591885902082193
              ],
              [
                55.93982476112308,
                -4.46799132425887
              ],
              [
                55.82790154334964,
                -4.441293046025351
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                56.51728440642244,
                -5.164048643290083
              ],
              [
                56.875713361500566,
                -5.140797029815418
              ],
              [
                56.82764817595369,
                -4.774132471344284
              ],
              [
                56.521404279469316,
                -4.750867128151854
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                59.55351282951431,
                -16.533729913227678
              ],
              [
                59.53497340080337,
                -16.611388274644575
              ],
              [
                59.56106593010025,
                -16.675202579352693
              ],
              [
                59.593338268967436,
                -16.656784137184257
              ],
              [
                59.5967714965065,
                -16.635732319737603
              ],
              [
                59.58647181388931,
                -16.59493784820497
              ],
              [
                59.60295130607681,
                -16.533729913227678
              ],
              [
                59.5747988402565,
                -16.4955473878938
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.82117717051568,
                -4.308927445808635
              ],
              [
                55.810190836200114,
                -4.319197927056913
              ],
              [
                55.82289378428521,
                -4.319882641422618
              ],
              [
                55.83267848277154,
                -4.319283533248809
              ],
              [
                55.82993190074029,
                -4.306873329048051
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.7622374049447,
                -4.5610817119859774
              ],
              [
                55.7576454631112,
                -4.567541377858183
              ],
              [
                55.762602185370724,
                -4.570129505810936
              ],
              [
                55.76743016159753,
                -4.561680623849451
              ],
              [
                55.7652629367135,
                -4.5610817119859774
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.71091965100533,
                -3.7313159072799964
              ],
              [
                55.7095463599897,
                -3.8080538077779056
              ],
              [
                55.791247143559765,
                -3.9298266636375776
              ],
              [
                55.891507419560014,
                -3.993361063616616
              ],
              [
                55.8908207740522,
                -3.751528778021327
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.12287161608795,
                -3.724099564361653
              ],
              [
                55.12364409228424,
                -3.7459399019339044
              ],
              [
                55.19805929919342,
                -3.741743173392664
              ],
              [
                55.19402525683502,
                -3.731122791000546
              ],
              [
                55.18072150012115,
                -3.705085182061557
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.320491846662975,
                -3.747443628452631
              ],
              [
                55.31980520115516,
                -3.8580927030910788
              ],
              [
                55.404605921370006,
                -3.843363153383337
              ],
              [
                55.41078573094032,
                -3.746073272679222
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                53.26492169506689,
                -4.873348693067708
              ],
              [
                53.29401773333353,
                -4.967073279212991
              ],
              [
                53.38963264885736,
                -4.9669022625227965
              ],
              [
                53.40113390568452,
                -4.941762443327266
              ],
              [
                53.35332481042124,
                -4.9229506204654285
              ],
              [
                53.31581861812553,
                -4.891479944724156
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                53.124339277890286,
                -5.25163236231433
              ],
              [
                53.218753035214505,
                -5.4560435993407665
              ],
              [
                53.36535185113247,
                -5.181200792805181
              ],
              [
                53.25411527886685,
                -5.109393539012181
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                53.33688933180449,
                -5.399080786231485
              ],
              [
                53.33997923658965,
                -5.404976800540399
              ],
              [
                53.35293967054961,
                -5.412923511595184
              ],
              [
                53.36366850660918,
                -5.418648496781997
              ],
              [
                53.36461264418242,
                -5.421553692394682
              ],
              [
                53.368818347917774,
                -5.423177177971778
              ],
              [
                53.37645727919219,
                -5.411641791065571
              ],
              [
                53.36263853834746,
                -5.394466474160993
              ],
              [
                53.35087973402617,
                -5.383357801229904
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                53.44910670219687,
                -5.4547502049421155
              ],
              [
                53.341646680224216,
                -5.486533789670236
              ],
              [
                53.422327527392184,
                -5.59895883502795
              ],
              [
                53.51708460747031,
                -5.521391257645976
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                50.84093216338972,
                -10.01183757588908
              ],
              [
                50.81106308379988,
                -10.044293031438755
              ],
              [
                50.816899570616286,
                -10.111898094436233
              ],
              [
                50.86496475616316,
                -10.081139548789313
              ],
              [
                50.86530807891707,
                -10.027727632193288
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        }
      ],
      "coordinates": []
    }),
    notSRS = 
    /* color: #e7ff78 */
    /* shown: false */
    ee.Geometry({
      "type": "GeometryCollection",
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.76433165988321,
                -4.589617246095629
              ],
              [
                55.76585515460367,
                -4.592461959582767
              ],
              [
                55.76933129748697,
                -4.591841684676566
              ],
              [
                55.768987974733065,
                -4.5874997452364195
              ],
              [
                55.76493247470255,
                -4.587927523694005
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                55.7651041360795,
                -4.57853440232471
              ],
              [
                55.76184256991739,
                -4.5870044743944804
              ],
              [
                55.76731427630777,
                -4.586041971260488
              ],
              [
                55.76885922870035,
                -4.579111910425983
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                53.3686055637301,
                -4.876205440500802
              ],
              [
                53.35641760596643,
                -4.895276138308276
              ],
              [
                53.35993666419397,
                -4.906820915542953
              ],
              [
                53.37924856910119,
                -4.913576655552374
              ],
              [
                53.3865441776217,
                -4.890829207974152
              ],
              [
                53.384913394540646,
                -4.8732977528464385
              ],
              [
                53.377703616708615,
                -4.8717583837001905
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                50.716941578767546,
                -9.332392778983523
              ],
              [
                50.73865674295212,
                -9.32621001471362
              ],
              [
                50.72037480630661,
                -9.318587277819127
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                50.72990201272751,
                -9.34738340960935
              ],
              [
                50.74475072183395,
                -9.33154583145327
              ],
              [
                50.71702740945602,
                -9.334679527037853
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                50.94530595782609,
                -9.247495590857218
              ],
              [
                50.88350786212297,
                -9.45684875316213
              ],
              [
                50.96933855059953,
                -9.599055088522832
              ],
              [
                51.02152360919328,
                -9.458203377969488
              ],
              [
                51.03250993731828,
                -9.233263152856834
              ],
              [
                51.025643482240156,
                -9.195984998379663
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        }
      ],
      "coordinates": []
    }),
    notTRF = 
    /* color: #007a00 */
    /* shown: false */
    ee.Geometry.MultiPolygon(
        [[[[55.93983436648838, -4.5775170906586435],
           [55.94567085330478, -4.59719490946505],
           [55.95803047244541, -4.58701384482381],
           [55.952880631136814, -4.582650486954896],
           [55.946357475403445, -4.57948492187818]]],
         [[[56.55640098204929, -10.367126295717428],
           [56.675877300408665, -10.515686790330534],
           [56.744541851189915, -10.477202937392848],
           [56.64909812560398, -10.333352679822562],
           [56.581463543084446, -10.328961842868994]]]]),
    notIRF = 
    /* color: #fffe64 */
    /* shown: false */
    ee.Geometry.MultiPolygon(
        [[[[45.13792558395689, -12.60845678017535],
           [45.121617753146346, -12.61515755996249],
           [45.13775392257994, -12.618675399148652],
           [45.141187150119, -12.616665211247872],
           [45.14341874801939, -12.621355625122748],
           [45.14650865280455, -12.618340368928216],
           [45.14719529831236, -12.623198264195157],
           [45.15423341476744, -12.624705868110627],
           [45.15749498092955, -12.629396134578702],
           [45.16401811325377, -12.631071208898845],
           [45.16676469528502, -12.628893610142882],
           [45.16727967941588, -12.635091342489451],
           [45.177579362033065, -12.638441405514508],
           [45.187535721896346, -12.646146383773596],
           [45.19663377487486, -12.655358552616763],
           [45.20298524582213, -12.661890616289574],
           [45.209508378146346, -12.665407812053656],
           [45.22238298141783, -12.6814858031887],
           [45.23439927780455, -12.690361759269345],
           [45.24092241012877, -12.697562779162455],
           [45.24057908737486, -12.703089004977974],
           [45.248475510714705, -12.703758842368138],
           [45.25465532028502, -12.709452388900742],
           [45.26152177536314, -12.71246656776409],
           [45.2646116801483, -12.719666961351138],
           [45.28308462692388, -12.73021600634958],
           [45.28789114547857, -12.737081022191207],
           [45.290981050263724, -12.744615581656024],
           [45.29115271164068, -12.754996163154546],
           [45.29458593917974, -12.760855980865296],
           [45.295959230195365, -12.77441675266707],
           [45.3035123307813, -12.777597569114354],
           [45.3035123307813, -12.735071768502666],
           [45.277248140107474, -12.703926301439845],
           [45.17863941341738, -12.619955316599338],
           [45.15134525448183, -12.611076911997399]]],
         [[[45.06791782528261, -12.590471126881141],
           [45.07547092586855, -12.590136059781104],
           [45.080620767177145, -12.584607389453923],
           [45.08456897884707, -12.588125647990736],
           [45.09298038631777, -12.586617828810084],
           [45.1001901641498, -12.593151647925065],
           [45.11512470394472, -12.60705640110169],
           [45.12422275692324, -12.597004847842665],
           [45.099846841395895, -12.57572776061396],
           [45.07358265072207, -12.576062846522778],
           [45.067145428582975, -12.582429309500075]]],
         [[[45.0119901265796, -12.645397529060597],
           [45.01971488854249, -12.642717555125538],
           [45.02417808434327, -12.638027533082607],
           [45.02761131188233, -12.635347481835332],
           [45.03482108971436, -12.63987005201022],
           [45.037052687614754, -12.638697541502657],
           [45.037739333122566, -12.64322005238035],
           [45.043747481315926, -12.647742483183535],
           [45.05439048668702, -12.648914952169175],
           [45.028411061495866, -12.621906547430962]]],
         [[[45.25411255434667, -12.892476412023473],
           [45.237461400782216, -12.915400103202398],
           [45.247246099268544, -12.920921554074267],
           [45.263897252833, -12.898165699267535]]],
         [[[45.21463043764745, -12.976965728628619],
           [45.22218353823339, -12.984493089458672],
           [45.21909363344823, -12.996870920305986],
           [45.23608810976659, -12.9948637464042],
           [45.23282654360448, -12.966928893033229]]],
         [[[45.22716171816503, -12.9334698520135],
           [45.21394379213964, -12.951036408789744],
           [45.21342880800878, -12.956724361805913],
           [45.23866303042089, -12.953378522820236],
           [45.233598790180245, -12.932549529190826]]],
         [[[45.15270147377226, -13.064271827542424],
           [45.15664968544218, -13.074806354685634],
           [45.21638784462187, -13.048051121358345],
           [45.25140676552031, -13.010421676411479],
           [45.24162206703398, -13.003564139713054],
           [45.22943410927031, -13.01309773685629],
           [45.23338232094023, -13.019286015991566],
           [45.22188100868437, -13.026310361785278],
           [45.20831975990507, -13.035508608562985],
           [45.179823971330855, -13.052566270233346],
           [45.15870962196562, -13.06326851579564]]],
         [[[46.4392538763218, -12.329340151829715],
           [46.432387421243675, -12.34141443495574],
           [46.43942553769875, -12.34443291877453],
           [46.44818026792336, -12.33135257098801],
           [46.45401675473977, -12.329340151829715],
           [46.45916659604836, -12.3244767417527],
           [46.452128479593284, -12.318271570364486]]],
         [[[46.42500598203469, -12.367405793498408],
           [46.461569855325706, -12.37210073113688],
           [46.4586516119175, -12.363381494094607],
           [46.44852359067727, -12.363381494094607],
           [46.441142151468284, -12.36086627550323],
           [46.4363356329136, -12.359021766490427],
           [46.43530566465188, -12.351140535986133],
           [46.42706591855813, -12.352985100579016]]]]),
    geoclean3 = ee.Image("projects/coral_atlas/west_indian_ocean/in_out/wio_geo-clean_man2"),
    RCtoORF = /* color: #d6c772 */ee.Geometry.Polygon(
        [[[51.15282304509833, -10.12348653193581],
          [51.13909013494208, -10.129232100275852],
          [51.121237351738955, -10.141060887393227],
          [51.097548081719424, -10.1478199982397],
          [51.09136827214911, -10.147144093575758],
          [51.071798875176455, -10.152889237722269],
          [51.06046922429755, -10.154916911028952],
          [51.052572800957705, -10.154578966370348],
          [51.02931119974378, -10.184488607505397],
          [51.03102781351331, -10.19597744907016],
          [51.046820660193, -10.223346254434679],
          [51.05128385599378, -10.237198702050351],
          [51.0633001523805, -10.251726229009599],
          [51.07050993021253, -10.255442466146398],
          [51.078406353552374, -10.246320715356493],
          [51.08218290384534, -10.235171552354466],
          [51.09042264993909, -10.237198702050351],
          [51.108618755896124, -10.230103621462712],
          [51.13951780374769, -10.211858400669174],
          [51.16149045999769, -10.17097179346953],
          [51.134541394989895, -10.193274266982499],
          [51.113081951696905, -10.217602379447435],
          [51.07394315775159, -10.211520516333504],
          [51.055403729040655, -10.207465876312039],
          [51.04235746439222, -10.196315349905007],
          [51.03789426859144, -10.182123206380329],
          [51.05471708353284, -10.166240773358597],
          [51.103814224570655, -10.159823055376146],
          [51.15016080911878, -10.144612361229905],
          [51.15737058695081, -10.127376174201675]]]),
    RCtoDL = 
    /* color: #b6a6ff */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[51.058150311071905, -10.192598421010974],
          [51.06398679788831, -10.208817428727594],
          [51.07668973978284, -10.211858400669174],
          [51.097632427771124, -10.214223580967657],
          [51.12715818460706, -10.19868064571247],
          [51.13848783548597, -10.184150694132944],
          [51.137801189978155, -10.158130290206838],
          [51.119605084021124, -10.154750861504667],
          [51.07325651224378, -10.183136951867535]]]);
/***** End of imports. If edited, may not auto-convert in the playground. *****/
///////////////////////////////
// Global coral atlas project - North Caribbean and Bahamas
// Contact: mitchell.lyons@gmail.com
// Region coordinator: Eva Kovacs (kovacsevam2@gmail.com)
// Description:
// - Developing a process to combine OBIA and supervised classification
// - This script loads the raw classification data (from *_classification script)
// - Then applied some cleanup and object-based relational rules
///////////////////////////////


// Table of contents
// 1. Setting constants
// 2. Data loads & vis
// 3. OBIA clean up rules
// 4. Export

// Load and libraries needed
var map_palettes = require('users/mitchest/global_reefs:Modules/colour_pals')
var param_module = require('users/mitchest/global_reefs:Modules/reef_params')

// ###########################################
// SENSOR GENERICS
var sensor_params = param_module.dove         //<------------ THIS IS WHERE YOU CHOOSE THE SENSOR
// REGION AND SENSOR SPECIFIC LOAD PATHS
var region_params = param_module.wio          //<------------ THIS IS WHERE YOU CHOOSE THE REGION
//  ^^ all the data paths are in this module ^^
// ###########################################

// 1. Setting constants

// These will get written to the asset metadata 

var vars = {
  
  // analysis type
  geomorphic: true, // map geomorphic zonation (when set to true) or benthic habitat (when set to false)

  // analysis parameters
  image_data_scale: ee.Number(sensor_params.pixel),
  small_object_geo: ee.Number(400).int(), // smallest object szie in pixels (geomorphic)
  small_object_benthic: ee.Number(130).int(), // smallest object szie in pixels (benthic)
  smooth_radius: ee.Number(3), // radius in pixels for initial smooth 
  dist_to_land: 2000, //distance to land in meters to disallow reef crest, and convert to terrestrial reef flat
  
  //############
  /* This is a stop-gap until we figure out how to chain together vectorisations in GEE
  - GEOMORPHIC: for large regions, the first pass does the small object filter, then the second pass does the OBIA clean
  -           : *in an ideal world* for smaller regions, can do both at once, but not handling that at present
              : 1st stage  - obia_2nd_pass + obia_clean set to false (no changes needed ML thinks); 
              : 2nd stage -  obia_2nd_pass + obia_clean set to true (object-based clean-up; review any OBIA rules); 
              : 3rd stage - manual_clean set to true (chop out all non-region-specific code, review final masks and any manual edits)
  - BENTHIC : can do both at once
            : One stage only - should have obia_2nd_pass and obia_clean set to true (so it uses the most recent geo map) */
  
  // CHANGE FOR EACH PASS
  obia_2nd_pass: true,
  obia_clean: true, // run object-based relationship rules + small object clean up
  fast_clean: true, // run a faster (but less precise) version of the OBIA clean; only applies to geomorphic (`obia_clean: true` also)
  smooth_output: false, // run smoother over final output (includes noise removal) (should be false for second pass)
  //############
  
  //CHANGE TO TRUE FOR MANUAL CLEAN
  // apply any manual touch ups
  manual_clean: true,
  
  // results/layers to show
  export_small_area: false,
  show_eg_area: false, // contrain the map add toe the corresponding example_area polygon geomtery (you can change that)
                              // - you can either set this, or have it false and just navigate to the area you want to see (keeping in mind ALL tiles in the zoom area will calcualte)
  reproject_display: true,
  //reproject_res: ee.Number(sensor_params.pixel).pow(2),
  
  
  //CHANGE DEPENDING ON WHETHER 1ST PASS, 2ND PASSS, OR MANUAL
    // export options 
  do_export: true, // export the results?
  geomorph_output_name: region_params.sname + '_geo-clean_man2',
  benthic_output_name: region_params.sname + '_benthic-clean',
  asset_output: region_params.asset // asset path

}

//CHANGE NAME OF INPUT LAYER AT circa LINE 136 DEPENDING ON PASS (// DEFINE THE MANUALLY EDITED MAP)

/*
############################
MANUAL ADDITION
############################
*/


//REEF BOUNDARY
//This can be hand drawn or imported from elsewhere, or could just be a big box

//reef_boundary = ee.FeatureCollection([ee.Feature(fl_cari_extent),ee.Feature(bahamas_extent)]).geometry()
Map.addLayer(reef_boundary, {}, "Manual reef outline", false)
Map.addLayer(region_extent, {}, "region_extent", false)

if (vars.manual_clean) {
  
  vars.obia_2nd_pass = false
  vars.obia_clean = false
  vars.fast_clean = false
  vars.smooth_output = false
  vars.do_export = false
  
  print("Doing manual clean ups - make sure this is what you want to do")
  print("Export the manual map, check 'manual' layer and ignore the 'final' map layer")
  
  //ADD DEPTH
  var depth = ee.Image(region_params.pixels).select('depth')
  var depth_cont = depth.lt(900)
  Map.addLayer(depth_cont, {}, "depth contour", false)
  
  //ADD WAVES
  Map.addLayer(waves.lt(0.4), {}, "0.4m Hs95 threshold", false)
  
  //DEFINE AREAS OF NO REEF and/or SPLITS
  var no_reef = ee.Image().byte().paint(ee.Feature(not_reef, {zone: 1}), "zone").clip(not_reef); //import CR not_reef layer
  var wio_extent = ee.Image().byte().paint(ee.Feature(region_extent, {zone: 1}), "zone").clip(region_extent)
  var notReefSlope = ee.Image().byte().paint(ee.Feature(notRS, {zone: 1}), "zone").clip(notRS)
  var notBackReefSlope = ee.Image().byte().paint(ee.Feature(notBRS, {zone: 1}), "zone").clip(notBRS)
  var notShelteredReefSlope = ee.Image().byte().paint(ee.Feature(notSRS, {zone: 1}), "zone").clip(notSRS)
  var notReefCrest = ee.Image().byte().paint(ee.Feature(notRC, {zone: 1}), "zone").clip(notRC)
  var notShallowLagoon = ee.Image().byte().paint(ee.Feature(notSL, {zone: 1}), "zone").clip(notSL)
  var notTRFlat = ee.Image().byte().paint(ee.Feature(notTRF, {zone: 1}), "zone").clip(notTRF)
  var notIRFlat = ee.Image().byte().paint(ee.Feature(notIRF, {zone: 1}), "zone").clip(notIRF)
  var DeepWater = ee.Image().byte().paint(ee.Feature(Deep, {zone: 1}), "zone").clip(Deep)
  
  // DEFINE THE MANUALLY EDITED MAP
  // 1st pass output for 2nd pass run
  // var man_geo = ee.Image(region_params.geo_map_clean)
  // 2nd pass output for manual run
  var man_geo = ee.Image(region_params.geo_map_clean_p2)
  
   // "NOT REEF" CLEAN
  // remove
 man_geo = man_geo.where({
   test: no_reef.eq(1),
  value: ee.Image(0)
 })
  
  
  // WAVE clean ############# ---> (to be integrated into RF classifier when DATA IS AVAILABLE)
  // remove
 man_geo = man_geo.where({
    test: waves.lte(0.4)
               .and(man_geo.eq(22)),
    value: ee.Image(21)
  })
  
  //WIO clean

 /* // Deep -> deep lagoon
  man_geo = man_geo.where({
    test: wio_extent.eq(1)
                     .and(man_geo.eq(2).or(man_geo.eq(23))),
    value: ee.Image(12)
  })*/
  
  // Deep water anomalies
  man_geo = man_geo.where({
    test: DeepWater.eq(1),
    value: ee.Image(2)
  })
  
    // Reef crest -> Inner reef flat
  man_geo = man_geo.where({
    test: notReefCrest.eq(1)
                     .and(man_geo.eq(15)),
    value: ee.Image(13)
  })
  
  //Reef Slope to Back Reef Slope
   man_geo = man_geo.where({
    test: notReefSlope.eq(1)
                     .and(man_geo.eq(22)),
    value: ee.Image(24)
  })
  
  // Shallow Lagoon to Inner Reef Flat
   man_geo = man_geo.where({
    test: notShallowLagoon.eq(1)
                     .and(man_geo.eq(11)),
    value: ee.Image(13)
  })
  
  // Sheltered Reef Slope to Back Reef Slope
   man_geo = man_geo.where({
    test: notShelteredReefSlope.eq(1)
                     .and(man_geo.eq(21)),
    value: ee.Image(24)
  })
  
  // Terrestrial Reef Flat to Inner Reef Flat
   man_geo = man_geo.where({
    test: notTRFlat.eq(1)
                     .and(man_geo.eq(16)),
    value: ee.Image(13)
  })
  
  //Inner Reef Flat to Outer Reef Flat
   man_geo = man_geo.where({
    test: notIRFlat.eq(1)
                     .and(man_geo.eq(13)),
    value: ee.Image(14)
  })
  
  // Add the manual layer to the map
  var image = ee.Image(region_params.image);
  Map.addLayer(image, {bands: ['b3','b2','b1'], min:200, max:1200}, 'Dove low tide', true);
  
  var geo_clean_p1 = ee.Image(region_params.geo_map_clean)
  Map.addLayer(geo_clean_p1, map_palettes.geo, 'Geo Clean Pass 1', false);
  
  var geo_clean_p2 = ee.Image(region_params.geo_map_clean_p2)
  Map.addLayer(geo_clean_p2, map_palettes.geo, 'Geo Clean Pass 2', false);
  
  Map.addLayer(man_geo, map_palettes.geo, 'Manually cleaned GEO', false)
  
  
  var output_name = (vars.manual_clean) ? vars.geomorph_output_name + "_man" : output_name;
  // Export
  Export.image.toAsset({
    image: man_geo,
    description: vars.geomorph_output_name,
    assetId: vars.asset_output + 'in_out/' + vars.geomorph_output_name,
    region: reef_boundary,
    scale: vars.image_data_scale,
    crs: 'EPSG:4326',
    maxPixels: 1e13,
    pyramidingPolicy: {'.default': 'mode'}
  })
  
  
}
/*
############################
*/

/* TRIAL #######
    Looks like with the sentinel/ls8 depth we can try to retain full resolution,
    because theres more (good) data either side of the depth threshold/marginal areas
  ##############
  
  Used to be --> output resolution (bigger for geomorphic) - relates back to object size and the min mapping unit defined in classification stage
*/
//if (vars.geomorphic) vars.image_data_scale = ee.Number(sensor_params.pixel)//.pow(2)



// 2. Data loads & vis

// load input data
if (vars.obia_2nd_pass) {
  // if it's 2nd pass, you want to make sure you're loading the latest geo clean map
  // - could change the path in reef_params to a list, check if it length is > 1, then take last element??
  
  // OR run a separate operation that joins the east/west clean1 maps via EPSG:3832, load via one ee.Image(), then save here as EPSG:4326
  //var geo_map = geo1.unmask(0, false).add(geo2.unmask(0,false)).selfMask().clip(swp_extent)
  
  var geo_map = ee.Image(region_params.geo_map_clean)
} else {
  //print(ee.List(region_params.geo_map).length())
  if (ee.List(region_params.geo_map).length().getInfo() > 1) {
    var geo_map = ee.Image(region_params.geo_map[0]).unmask(0, false)
             .add(ee.Image(region_params.geo_map[1]).unmask(0,false))
             .selfMask()
  } else {
    var geo_map = ee.Image(region_params.geo_map)
  }
}

//var benthic_map = (vars.obia_2nd_pass) ? ee.Image(region_params.benthic_map_clean) : ee.ImageCollection(region_params.benthic_map).mosaic()
//var benthic_map = ee.Image(region_params.benthic_map)

if (ee.List(region_params.benthic_map).length().getInfo() > 1) {
    var benthic_map = ee.Image(region_params.benthic_map[0]).unmask(0, false)
             .add(ee.Image(region_params.benthic_map[1]).unmask(0,false))
             .selfMask()
} else {
    var benthic_map = ee.Image(region_params.benthic_map)
}


var depth = ee.Image(region_params.pixels).select('depth')
var image = ee.Image(region_params.image)

var display_pal = (vars.geomorphic) ? map_palettes.geo : map_palettes.benthic
//Map.centerObject(eg_area, 11)
Map.addLayer(depth, {min:0, max:2500}, 'Depth data', false)
Map.addLayer(image, {bands: ['b3','b2','b1'], min:200, max:1200}, 'Dove low tide', false)

if (vars.geomorphic) {
  if (vars.obia_2nd_pass) {
    if (ee.List(region_params.geo_map).length().getInfo() > 1) {
      var geo_map_display = ee.Image(region_params.geo_map[0]).unmask(0, false)
                       .add(ee.Image(region_params.geo_map[1]).unmask(0,false))
                       .selfMask()
    } else {
    var geo_map_display = ee.Image(region_params.geo_map)
    }
    Map.addLayer(geo_map_display, display_pal, 'Raw GEO classification', false)
  } else {
    Map.addLayer(geo_map, display_pal, 'Raw GEO classification', false)
  }
}
if (!vars.geomorphic) {
  Map.addLayer(geo_map, map_palettes.geo, 'Clean GEO classification', false)
  Map.addLayer(benthic_map, display_pal, 'Raw BENTHIC classification', false)
}

// 3. Object-based re-classificaiton and cleaning

/*

// if we want to retain the land/waves flags, need to add them in before makign the mask

######## Not that straight forwards - the land and bright masks are a LOT of not land and not breakign waves... =(

// add in land, for geomorphic clean up rules
  geo_map = geo_map.unmask(0).where({
    test: depth.eq(-2).and(globcover.select('landcover').neq(210)),
    value: ee.Image(1)
  })
  
  // change -3 to reef rim, hope that clouds have been handleded by masking
  geo_map = geo_map.unmask(0).where({
    test: depth.eq(-3),
    value: ee.Image(15)
  })
  
  // remask
  geo_map = geo_map.updateMask(geo_map.gt(0))

*/

/* OUTPUT EXTENT
  - to the mapping extent just so it doesn't balloon out
  - to the 'reef boundary' extent for noise/deep removal
*/  
var class_extent_mask = geo_map.gt(0)


/*

########
Initial small object clean
 - this was originally at the end, but we needed to massively reduce the number of objects to 
   iterate through in the OBIA cleaning, so this happens first now
 - future collabs with google might fix this, but need to change the parallel serialisation of vector procesing
 
 - includes a possible special case for:
      - geomorphic to clean up turbid areas over size threshold; fix shallow vs. deep lagoon
      - benthic to allow breaking waves (temporal class) to grow into surrounding class
########

*/

if (vars.geomorphic && !vars.obia_2nd_pass) {
  
  // make a smooth map with masked area as a value
  var smooth_map = geo_map
                      //.unmask(99)
                      .focal_mode({
                        radius: vars.smooth_radius, // relates to smoothness required
                        kernelType: 'circle', units: 'pixels', iterations: 2
                      })
  //smooth_map = smooth_map.updateMask(smooth_map.neq(99)).updateMask(class_extent_mask)
  
  //replace small objects with smooth underneath
  var clean_map = geo_map.where({
    test: geo_map.connectedPixelCount(vars.small_object_geo, false).lt(vars.small_object_geo), 
    value: smooth_map
  //}).updateMask(smooth_map.neq(99)).updateMask(class_extent_mask)
  }).updateMask(class_extent_mask)
  
  
  // shallow lagoon > 5m == deep lagoon
  clean_map = clean_map.where({
    test: clean_map.eq(11)
                   .and(depth.gt(500)),
    value: ee.Image(12)
  })
  
  /*// deep lagoon == deep (to hard to differentiate deep water vs. deep lagoon effectively over large areas)
  clean_map = clean_map.where({
    test: clean_map.eq(12),
    value: ee.Image(2)
  })*/
  
  // DEEP WATER in depth data == deep (s2 + ls8 data should be good enough for this)
  clean_map = clean_map.where({
    test: depth.gt(1000), // set at 20m (2000) but may need changing based on depth data
    value: ee.Image(2)
  })
  
  
  // LAND mask cleaning
  Map.addLayer(land_dist.lte(vars.dist_to_land), {}, "Land mask", false)
  
  // reef crest close to land -> TRF
  clean_map = clean_map.where({
    test: land_dist.lte(vars.dist_to_land)
                   .and(clean_map.eq(15)),
    value: ee.Image(16)
  })
  
  // TRF far from land -> ORF
  clean_map = clean_map.where({
    test: land_dist.gt(vars.dist_to_land)
                   .and(clean_map.eq(16)),
    value: ee.Image(14)
  })
  
  
  
  /*//CLEAN UP SMALL (but slightly larger) TURBID AREAS
  var smooth_noturbid = clean_map
                          .updateMask(clean_map.neq(3))
                          .focal_mode({
                            radius: vars.smooth_radius.multiply(1.5),
                            kernelType: 'circle', units: 'pixels', iterations: 2
                          })
  
  clean_map = clean_map.where({
    test: clean_map.eq(3).connectedPixelCount(vars.small_object_geo.multiply(10), false).lt(vars.small_object_geo.multiply(10)), 
    value: smooth_noturbid
  }).updateMask(class_extent_mask)*/
}


if (!vars.geomorphic) {
  
  // make a smooth map with masked area as a value, and without temporal class (basically breaking waves)
  var smooth_map = benthic_map
                      //.unmask(99)
                      .focal_mode({
                        radius: vars.smooth_radius, // relates to smoothness required
                        kernelType: 'circle', units: 'pixels', iterations: 1
                      })
  //smooth_map = smooth_map.updateMask(smooth_map.neq(99)).updateMask(class_extent_mask)
  
  //replace small objects with smooth underneath
  var clean_map = benthic_map.where({
    test: benthic_map.connectedPixelCount(vars.small_object_benthic, false).lt(vars.small_object_benthic),
    value: smooth_map
  //}).updateMask(smooth_map.neq(99)).updateMask(class_extent_mask)
  }).updateMask(class_extent_mask)
  
  
  /*// CLEAN UP ALL TEMPORAL AREAS
  var smooth_notemp = benthic_map
                          .updateMask(benthic_map.neq(2))
                          .focal_mode({
                            radius: vars.smooth_radius.multiply(2),
                            kernelType: 'circle', units: 'pixels', iterations: 3
                          })
  
  
  clean_map = clean_map1.where({
    test: benthic_map.eq(2), 
    value: smooth_notemp
  }).updateMask(clean_map1.gte(0))
  
  // this catches any left over unmasked temporal, and assigned it back to temporal
  clean_map = clean_map.where({
    test: clean_map.unmask(99).eq(99).and(clean_map1.eq(2)),
    value: ee.Image(2)
  })*/
  
}



if (vars.geomorphic && vars.obia_2nd_pass) {
  var clean_map = geo_map
}

Map.addLayer(clean_map, display_pal, 'Clean map - init smooth/loaded', false)

if (vars.obia_clean) {
  
  if (vars.geomorphic && !vars.fast_clean) { // SHOULD TRY TO PUT THIS OUT TO A MODULE TO KEEP THE RULES THE SAME EVERYWEHRE?
    
    // #########
    // THE PLAN - vectorise one/few class/es at a time, thus only spending resources on what is actually needed to clean up
    // #########
    
    // FUNCTION that maps over feature colleciton and assigns neighbour percentages
    var set_neighbour_properties = function(f) {
      // make the 1px buffer
      var diff = f.buffer(vars.image_data_scale).difference(f, ee.ErrorMargin(0.5))
      // reduce the classes in the buffer zone
      var diff_classes = ee.Dictionary(
        clean_map.unmask(ee.Image(0)).reduceRegion({
          reducer: ee.Reducer.frequencyHistogram(),
          geometry: diff.geometry(),
          scale: vars.image_data_scale,
          maxPixels: 1e11
        }).get('classification')
      )
      // calculate the percentages
      var diff_sum = diff_classes.toArray().reduce(ee.Reducer.sum(), [0]).get([0])
      var diff_percs = diff_classes.map(function(k,v){return(ee.Number(v).divide(diff_sum).multiply(100).toUint8())})
      
      /* NOW, we can try to do the class logic right here (see /users/mitchest/global_reefs/obia_dev),
         or we can return the neighbour % and do image logic via (painted) rasters */
      
      return(f.set(diff_percs))
    }
    
    // FUNCTION to reduce the map to vectors and map the neighbour properties function
    var reduce_neighbours = function() {
      // reduce map to vectors
      var map_fc = clean_map
            .updateMask(segment_id).updateMask(clean_map.eq(classn)) // only vectorise class/es of interest
            .reduceToVectors({
              scale: vars.image_data_scale, 
              eightConnected: false,
              bestEffort: true, 
              maxPixels: 1e13,
              tileScale: 1,
              geometry: reef_boundary
            })
      // map the function, calculate neighbour properties
      return(map_fc.map(set_neighbour_properties))
    }
    
    // first make a make size threshold, so we're not vecortising huge objects when we don't have to
    var segment_id = clean_map.connectedComponents(ee.Kernel.plus(1),vars.small_object_geo.sqrt()).select('labels')
    //Map.addLayer(segment_id.reproject(ee.Projection('EPSG:4326').atScale(ee.Number(vars.image_data_scale))))
    Map.addLayer(clean_map.updateMask(segment_id).reproject(ee.Projection('EPSG:4326').atScale(ee.Number(vars.image_data_scale))), display_pal, 'Map objects to be iterated through (OBIA)', false)
    
    // This is where we select the single or group of classes to vectorise for cleaning up
    //var classn = ee.Number(15) // one class
    var classn = clean_map.where({
      test: clean_map.neq(16) //TRF
              .and(clean_map.neq(15)) //RR
              .and(clean_map.neq(14)) //ORF
              .and(clean_map.neq(13)) //IRF
              //.and(clean_map.neq(12)) // deep L
              .and(clean_map.neq(11)), // shallow L 
      value: ee.Image(99) // 99 ensures it's ignored in logic
    })
    
    // Minimum size of object to reclass based on neighbourhood
    var max_size = ee.Number(1000).divide(vars.image_data_scale).pow(2) // the first number is the square dimension of the desired min size
    // calculate neighbours
    var map_fc_neighbours = reduce_neighbours()
    
    // #########
    // REEF RIM
    // #########
    
    var focus_class = ee.Number(15) //RR
    
    // start the object-based neighbourhood rules
    // paint out to rasters (only paint the layers needed)
    var objsize = ee.Image(30000).paint(map_fc_neighbours, 'count').rename('count')
    //var nb24 = ee.Image().byte().paint(map_fc_neighbours, '24').unmask(0).rename('nb24') //OCL
    var nb22 = ee.Image().byte().paint(map_fc_neighbours, '22').unmask(0).rename('nb22') //SL ex
    var nb21 = ee.Image().byte().paint(map_fc_neighbours, '21').unmask(0).rename('nb21') //Sl sh
    var nb16 = ee.Image().byte().paint(map_fc_neighbours, '16').unmask(0).rename('nb16') //TRF
    var nb15 = ee.Image().byte().paint(map_fc_neighbours, '15').unmask(0).rename('nb15') //RR
    var nb14 = ee.Image().byte().paint(map_fc_neighbours, '14').unmask(0).rename('nb14') //ORF
    var nb13 = ee.Image().byte().paint(map_fc_neighbours, '13').unmask(0).rename('nb13') //IRF
    //var nb3 = ee.Image().byte().paint(map_fc_neighbours, '3').unmask(0).rename('nb3') //Turbid
    
    // RR surrounded by ORF --> ORF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb14.gt(75)),
      value: ee.Image(14)
    })
    
    // RR surrounded by IRF --> IRF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb13.gt(75)),
      value: ee.Image(13)
    })
    
    // RR surrounded by IRF + ORF --> IRF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb13.add(nb14).gt(75)),
      value: ee.Image(13)
    })
    
    // RR with decent border to TRF --> TRF (often dark, probably seagrass)
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb16.gt(40)),
      value: ee.Image(16)
    })
    
    /*// RR surrounded by OCL --> OCL
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb24.gt(75)),
      value: ee.Image(24)
    })*/
    
    /* with 2nd/3rd pass method, we don't really need this
    // RR surrounded by IRF + ORF --> IRF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb13.lte(75).and(nb14.lte(75))) // to ensure we're no re-writing previous rules
              .and(nb13.add(nb14).gt(75))
              .and(nb21.add(nb22).lte(0)), // to not get rid of complex reef rims (if touching slope, it's probably RR)
      value: ee.Image(13) // could try assigning to a place-holder, then deal with at the end?
    })*/
    
    /*// small RR objects touching OCL + stuff --> ORF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(objsize.lte(max_size))
              .and(nb13.lte(75).and(nb14.lte(75))) // to ensure we're no re-writing previous rules
              .and(nb24.gt(1)),
      value: ee.Image(14)
    })*/
    
    // ####
    // ORF
    // ####
    
    focus_class = ee.Number(14) // ORF
    
    //classn = ee.Number(14)
    //map_fc_neighbours = reduce_neighbours()
    //var nb22 = ee.Image().byte().paint(map_fc_neighbours, '22').unmask(0).rename('nb22') //SL ex
    //var nb21 = ee.Image().byte().paint(map_fc_neighbours, '21').unmask(0).rename('nb21') //Sl sh
    //nb15 = ee.Image().byte().paint(map_fc_neighbours, '15').unmask(0).rename('nb15') //RR
    //nb13 = ee.Image().byte().paint(map_fc_neighbours, '13').unmask(0).rename('nb13') //IRF
    //var nb1 = ee.Image().byte().paint(map_fc_neighbours, '1').unmask(0).rename('nb1') //Land
    
    // ORF surrounded by IRF --> IRF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb13.gt(75)),
      value: ee.Image(13)
    })
    
    // ORF surrounded by TRF --> TRF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb16.gt(75)),
      value: ee.Image(16)
    })
    
    // ORF surrounded by RR --> RR
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb15.gt(85)),
      value: ee.Image(15)
    })
    
    // ORF touching slope and RR --> RR
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb21.gt(0).or(nb22.gt(0)))
              .and(nb15.gt(0)),
      value: ee.Image(15)
    })
    
    /*// ORF touching land --> TRF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb1.gt(10)),
      value: ee.Image(16)
    })*/
    
    // ####
    // IRF
    // ####
    
    focus_class = ee.Number(13) // IRF
    
    //classn = ee.Number(13)
    //map_fc_neighbours = reduce_neighbours()
    //nb15 = ee.Image().byte().paint(map_fc_neighbours, '15').unmask(0).rename('nb15') //RR
    //nb14 = ee.Image().byte().paint(map_fc_neighbours, '14').unmask(0).rename('nb14') //ORF
    
    // IRF surrounded by ORF --> ORF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb14.gt(75)),
      value: ee.Image(14)
    })
    
    // IRF surrounded by TRF --> TRF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb16.gt(75)),
      value: ee.Image(16)
    })
    
    // IRF surrounded by RR --> RR
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb15.gt(85)),
      value: ee.Image(15)
    })
    
    /*// IRF touching land --> TRF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb1.gt(10)),
      value: ee.Image(16)
    })*/
    
    // ####
    // TRF
    // ####
    
    focus_class = ee.Number(16) // TRF
    
    //classn = ee.Number(16)
    //map_fc_neighbours = reduce_neighbours()
    //nb15 = ee.Image().byte().paint(map_fc_neighbours, '15').unmask(0).rename('nb15') //RR
    //nb14 = ee.Image().byte().paint(map_fc_neighbours, '14').unmask(0).rename('nb14') //ORF
    //nb13 = ee.Image().byte().paint(map_fc_neighbours, '13').unmask(0).rename('nb13') //IRF
    
    // TRF surrounded by ORF --> ORF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb14.gt(75)),
      value: ee.Image(14)
    })
    
    // TRF surrounded by IRF --> IRF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb13.gt(75)),
      value: ee.Image(13)
    })
    
    // TRF surrounded by IRF + ORF --> IRF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb13.add(nb14).gt(75)),
      value: ee.Image(13)
    })
    
    /*// TRF not touching land --> IRF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb1.lt(10)),
      value: ee.Image(13)
    })*/
    
    
    // ####
    // LAGOONS
    // ####
    
    var nb11 = ee.Image().byte().paint(map_fc_neighbours, '11').unmask(0).rename('nb11') // shallow lag
    //var nb12 = ee.Image().byte().paint(map_fc_neighbours, '12').unmask(0).rename('nb12') //deep lag
    
    // DL touching SL --> SL
    /* 
    This is a stop-gap until we have better depth product - below are the rules we want,
    but too much band-aiding is required to make it work, so for the moment just err on the side
    of shallow lagoon when it's mixed.
    */
    /*clean_map = clean_map.where({
      test: clean_map.eq(12)
              .and(nb11.gt(0)),
      value: ee.Image(11)
    })*/
    
    /*// SL sourrounded by DL --> DL
    clean_map = clean_map.where({
      test: clean_map.eq(11)
              .and(nb12.gt(75)),
      value: ee.Image(12)
    })*/
    
    /*// DL sourrounded by SL --> SL
    clean_map = clean_map.where({
      test: clean_map.eq(12)
              .and(nb11.gt(75)),
      value: ee.Image(11)
    })*/
    
    /*// DL/SL surrounded by IRF --> IRF
    clean_map = clean_map.where({
      test: clean_map.eq(11).or(clean_map.eq(12))
              .and(objsize.lte(max_size))
              .and(nb13.gt(80)),
      value: ee.Image(13)
    })*/
    
    // SL surrounded by IRF --> IRF
    clean_map = clean_map.where({
      test: clean_map.eq(11)
              .and(objsize.lte(max_size))
              .and(nb13.gt(80)),
      value: ee.Image(13)
    });
    
    /*// DL/SL touching OCL --> OCL
    clean_map = clean_map.where({
      test: clean_map.eq(11).or(clean_map.eq(12))
              .and(nb24.gt(0)),
      value: ee.Image(24)
    })*/
    
    
    /*// ####
    // Turbid
    // ####
    
    focus_class = ee.Number(3) // turbid
    
    // Turb surrounded by IRF --> IRF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb13.gt(75)),
      value: ee.Image(13)
    })
    
    // Turb surrounded by ORF --> ORF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb14.gt(75)),
      value: ee.Image(14)
    })
    
    // Turb surrounded by TRF --> TRF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb16.gt(75)),
      value: ee.Image(16)
    })*/
  
  } else if (vars.geomorphic && vars.fast_clean) {
    print("Executing the fast version OBIA");
    
    /* fast version of the geo clean up
      - blanket version assigns the underlying most common in neighbourhood
      - mode OBIA version iterates through objects+buffers but take the mode instead of doing the class percs, to see if that speeds things up
    */
    
    
    //############
    //# blanket version
    //############
    // make a very smooth map to capture the broader neighbourhood
    var smooth_map = clean_map
                        .focal_mode({
                          radius: vars.smooth_radius.multiply(3), // relates to smoothness required
                          kernelType: 'circle', units: 'pixels', iterations: 2
                        })
    
    
    // first make a make size threshold, so we're not vectorising huge objects when we don't have t
    // - the unmask(99) captures small no data values/ data gaps
    var segment_id = clean_map.unmask(0).connectedComponents(ee.Kernel.plus(1),vars.small_object_geo.sqrt().multiply(2)).select('labels').pow(2).log().int()
    Map.addLayer(clean_map.unmask(0).updateMask(segment_id.gt(0)).reproject(ee.Projection('EPSG:4326').atScale(ee.Number(vars.image_data_scale))), display_pal, 'Map objects to be iterated through (OBIA)', false)
    
    
    // replace small objects with smooth underneath
    var clean_map = clean_map.unmask(0).where({
      test: segment_id.gt(0), 
      value: smooth_map
    }).selfMask()
    //############
    //############
    
    
    /*    
    //############
    //# mode OBIA version
    //############
    
    // #########
    // THE FASTER PLAN - vectorise one/few class/es at a time, thus only spending resources on what is actually needed to clean up
    //                 - BUT, just assign the mode of the neighbours, so save resouces even further??
    // #########
    
    // FUNCTION that maps over feature colleciton and assigns neighbour percentages
    var set_neighbour_mode = function(f) {
      // make the 1px buffer
      var diff = f.buffer(vars.image_data_scale).difference(f, ee.ErrorMargin(0.5))
      // reduce the classes in the buffer zone
      var diff_mode = ee.Number(ee.Dictionary(
        clean_map.unmask(ee.Image(0)).reduceRegion({
          reducer: ee.Reducer.mode(),
          geometry: diff.geometry(),
          scale: vars.image_data_scale,
          maxPixels: 1e11
        })).get('classification'))
      
      return(f.set('mode',diff_mode))
    }
    
    // FUNCTION to reduce the map to vectors and map the neighbour properties function
    var reduce_neighbours_mode = function() {
      // reduce map to vectors
      var map_fc = clean_map.unmask(0)
            .updateMask(classn.gt(0)) // only vectorise class/es of interest
            .reduceToVectors({
              scale: vars.image_data_scale, 
              eightConnected: false,
              bestEffort: true, 
              maxPixels: 1e13,
              tileScale: 1,
              geometry: reef_boundary
            })
      // map the function, calculate neighbour properties
      return(map_fc.map(set_neighbour_mode))
    }
    
    // first make a make size threshold, so we're not vecortising huge objects when we don't have to
    var segment_id = clean_map.unmask(0).connectedComponents(ee.Kernel.plus(1),vars.small_object_geo.sqrt()).select('labels')
    Map.addLayer(clean_map.unmask(0).updateMask(segment_id.gt(0)).reproject(ee.Projection('EPSG:4326').atScale(ee.Number(vars.image_data_scale))), display_pal, 'Map objects to be iterated through (OBIA)', false)
    
    // This is where we select the single or group of classes to vectorise for cleaning up
    var classn = segment_id.where({
      test: clean_map.neq(16) //TRF
              .and(clean_map.neq(15)) //RR
              .and(clean_map.neq(14)) //ORF
              .and(clean_map.neq(13)) //IRF
              //.and(clean_map.neq(12)) // deep L
              .and(clean_map.neq(11)) // shallow L 
              .and(clean_map.unmask(0).neq(0)), // no data values (want to reclaim the small gaps 
      value: ee.Image(0) // 99 ensures it's ignored in logic
    })
    
    // calculate neighbours
    var map_fc_neighbours = reduce_neighbours_mode()
    
    //print(map_fc_neighbours.limit(10))
    
    var mode_map = ee.Image().byte().paint(map_fc_neighbours, 'mode').unmask(0).rename('mode') // paint out the mode values to an image
    //Map.addLayer(mode_map, display_pal, "mode map", false)
    
    // replace small objects with mode underneath
    var clean_map = clean_map.unmask(0).where({
      test: segment_id.gt(0), 
      value: mode_map
    }).selfMask()
    
    //############
    //############
    */
    
  } else {
    
    // BENTHIC CLEAN-UP RULES
    
    
    // reclaim shallow no data to surrounding class
    var smooth_map = clean_map
                        .focal_mode({
                          radius: vars.smooth_radius.multiply(3), // relates to smoothness required
                          kernelType: 'circle', units: 'pixels', iterations: 2
                        })
    
    var clean_map = clean_map.unmask(0).where({
      test: geo_map.gt(2).and(clean_map.eq(0)), 
      value: smooth_map
    }).selfMask()
    
    // cut benthic off to < 10 - 15 m
    clean_map = clean_map.where({
      test: depth.gt(1500),
      value: ee.Image(0)
    })
    
    // Deep (or land or missing) in geo == masked from benthic
    clean_map = clean_map.where({
      test: geo_map.unmask(0).lte(2),
      value: ee.Image(0)
    })
    
    /*// Deep lagoon in geo == masked from benthic
    clean_map = clean_map.where({
      test: geo_map.eq(12),
      value: ee.Image(0)
    })*/
    
    // Deep/shallow lagoon in geo && rock in benthic == seagrass
    clean_map = clean_map.where({
      test: geo_map.eq(11).or(geo_map.eq(12))
                   .and(clean_map.eq(13)),
      value: ee.Image(14)
    })
    
    // Deep/shallow lagoon in geo && coral in benthic == sand
    clean_map = clean_map.where({
      test: geo_map.eq(11).or(geo_map.eq(12))
                   .and(clean_map.eq(15)),
      value: ee.Image(11)
    })
    
    /*// turbid in geo == turbid (temporal - class num 2)
    // ############## ---> need to decide here whether to push geo turbid through regardless of benthic class
    clean_map = clean_map.where({
      test: geo_map.eq(3),
      value: ee.Image(2)
    })*/
    
    /*
    // Ignore in benthic + ORF in geo == rock
    clean_map = clean_map.where({
      test: clean_map.eq(0)
                     .and(geo_map.eq(14)),
      value: ee.Image(13)
    })
    
    // Ignore in benthic + IRF in geo == sand
    clean_map = clean_map.where({
      test: clean_map.eq(0)
                     .and(geo_map.eq(13)),
      value: ee.Image(11)
    })
    
    // Ignore in benthic + TRF in geo == sand
    clean_map = clean_map.where({
      test: clean_map.eq(0)
                     .and(geo_map.eq(16)),
      value: ee.Image(11)
    })
    
    // Ignore in benthic + RR in geo == rock
    */
    
    /*// seagrass in benthic + ORF/RR/slope in geo == coral/algae
    clean_map = clean_map.where({
      test: clean_map.eq(14)
                     .and(geo_map.eq(14).or(geo_map.eq(15)).or(geo_map.eq(21)).or(geo_map.eq(22))),
      value: ee.Image(15)
    })*/
    
    // ####--> CR: "Seagrass neighbouring deep water or no data not shallow a rock or coral algae class"
    
    // coral or algae in benthic + TRF in geo == seagrass
    clean_map = clean_map.where({
      test: clean_map.eq(15)
                     .and(geo_map.eq(16)),
      value: ee.Image(14)
    })
    
    // rock in benthic + TRF in geo == sand
    clean_map = clean_map.where({
      test: clean_map.eq(13)
                     .and(geo_map.eq(16)),
      value: ee.Image(11)
    })
    
    // seagrass in benthic and slope in geo == coral
    clean_map = clean_map.where({
      test: clean_map.eq(14)
                     .and(geo_map.eq(21).or(geo_map.eq(22))),
      value: ee.Image(15)
    })
    
    // coral or algae in benthic + plat in geo == seagrass
    clean_map = clean_map.where({
      test: clean_map.eq(15)
                     .and(geo_map.eq(23)),
      value: ee.Image(14)
    })
    
    /*// BMA in benthic and slope/plat in geo == sand
    clean_map = clean_map.where({
      test: clean_map.eq(18)
                     .and(geo_map.eq(2).or(geo_map.eq(12)).or(geo_map.eq(21)).or(geo_map.eq(22)).or(geo_map.eq(23))),
      value: ee.Image(11)
    })*/
    
    
    
    
  }
  
/*  // ####
  // Final small object clean (safety net for oddities with scaling and border buffers??)
  // ####
  
  var clean_size = (vars.geomorphic) ? vars.small_object_geo : vars.small_object_benthic
  
  var map_vsmooth = clean_map
                        .focal_mode({
                          radius: 10, // relates to smoothness required
                          kernelType: 'circle', units: 'pixels', iterations: 1
                        })
                        .updateMask(class_extent_mask)
  
  clean_map = clean_map.where({
    test: clean_map.connectedPixelCount(clean_size, false).lt(clean_size), 
    value: map_vsmooth
  })*/

}

// final smooth
if (vars.smooth_output) {
  // smooth the output lightly to make nice edges, and get rid of noise
  var noise_smooth = clean_map.unmask(99) // unmasking to a value allows us to include masked areas in the smooth, then re-mask after
                        .focal_mode({
                          radius: 2, // relates to smoothness required
                          kernelType: 'circle', units: 'pixels', iterations: 2
                        })
  clean_map = clean_map.updateMask(noise_smooth.neq(99)).updateMask(clean_map.gt(1)) // this ignores 0/land; make it .gt(2) if you want to mask deep too
} else {
  // just clip to the classified extent and move on
  if (vars.geomorphic) {
    clean_map = clean_map.updateMask(clean_map.gt(1)) // this ignores 0/land; make it .gt(2) if you want to mask deep too
  } else {
    clean_map = clean_map.updateMask(clean_map.gt(1)) // this ignores 0/land; make it .gt(2) if you want to mask deep too
  }
  
}


// 4. Export data

var output_name = (vars.geomorphic) ? vars.geomorph_output_name : vars.benthic_output_name


if (vars.do_export) {
  print("For export, the image data scale must be set to:", vars.image_data_scale)
  
  if (vars.export_small_area) {
    var export_convhull = export_small
  } else {
    //var export_convhull = clean_map.gt(2).reduceToVectors({scale: 1000, maxPixels: 1e13, bestEffort: true, geometry: region_extent, crs: "EPSG:4326"}).geometry().convexHull({maxError: 100})
    var export_convhull = reef_boundary
  }
  Map.addLayer(export_convhull, {}, "Export footprint", true)
  Export.image.toAsset({
    image: clean_map.set(vars),
    description: output_name,
    assetId: vars.asset_output + 'in_out/' + output_name,
    region: export_convhull,
    scale: vars.image_data_scale,
    crs: 'EPSG:4326',
    maxPixels: 1e13,
    pyramidingPolicy: {'.default': 'mode'}
  })
  /*Export.image.toCloudStorage({
    image: clean_map,//.set(vars),
    description: 'swp_geo_clean',
    bucket: 'mitchest_unet_bucket',
    fileNamePrefix: 'swp_geo_clean',
    region: export_convhull,
    scale: 25,
    crs: 'EPSG:4326',
    maxPixels: 1e13
  })*/
  
  
} else {
  if (vars.show_eg_area) {
    if (vars.reproject_display) {
      Map.addLayer(clean_map.clip(eg_area).reproject(ee.Projection('EPSG:4326').atScale(vars.image_data_scale)), display_pal, output_name + '_final', false)
    } else {
      Map.addLayer(clean_map.clip(eg_area), display_pal, output_name + '_final', false)
    }
  } else {
    if (vars.reproject_display) {
      Map.addLayer(clean_map.reproject(ee.Projection('EPSG:4326').atScale(vars.image_data_scale)), display_pal, output_name + '_final', false)
    } else {
      Map.addLayer(clean_map, display_pal, output_name + '_final', false)
    }
  }
}

//Generate title
var title = ui.Label({
  value: 'Classes',
  style: {fontWeight: 'bold', fontSize: '12px'}
});

/*// generate the legend
var geo_legend = pkg_vis.discrete_legend(map_palettes.geo_atlas_names, map_palettes.geo_atlas_cols, 'Geomorphic Zone', false);
var benthic_legend = pkg_vis.discrete_legend(map_palettes.benthic_atlas_names, map_palettes.benthic_atlas_cols, 'Benthic Habitat', false);
//var mask_legend = pkg_vis.discrete_legend(["Low confidence depth","Water conditions"], ["#f7f7f7","#bababa"], 'Confidence Mask reason', false)
var legend = (vars.geomorphic) ? geo_legend : benthic_legend;
pkg_vis.add_lgds([title, legend]);//, mask_legend])
// generate the legend*/