/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var eg_area = 
    /* color: #d63000 */
    /* shown: false */
    /* displayProperties: [
      {
        "type": "rectangle"
      }
    ] */
    ee.Geometry.Polygon(
        [[[158.09700006133824, 6.98282032937242],
          [158.09700006133824, 6.954194253230618],
          [158.14678186065464, 6.954194253230618],
          [158.14678186065464, 6.98282032937242]]], null, false),
    export_small = 
    /* color: #d63000 */
    /* shown: false */
    /* displayProperties: [
      {
        "type": "rectangle"
      }
    ] */
    ee.Geometry.Polygon(
        [[[157.9950896058224, 7.112454892191871],
          [157.9950896058224, 6.733464175742206],
          [158.4304228577755, 6.733464175742206],
          [158.4304228577755, 7.112454892191871]]], null, false),
    wmic_extent = 
    /* color: #d63000 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[130.7551960728133, 19.915585821970126],
          [130.7551960728133, 0.7075765650212411],
          [163.4944538853133, 0.7075765650212411],
          [163.4944538853133, 19.915585821970126]]], null, false),
    reef_boundary = 
    /* color: #d63000 */
    /* shown: false */
    ee.Geometry({
      "type": "GeometryCollection",
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                131.1171188623234,
                3.0051808362068866
              ],
              [
                131.1229553491398,
                2.9955809767869623
              ],
              [
                131.125873592548,
                2.9958381169768677
              ],
              [
                131.12741854494058,
                2.9994380732916164
              ],
              [
                131.13007929628336,
                3.0028665920966913
              ],
              [
                131.13445666139566,
                3.013409219940837
              ],
              [
                131.13342669313394,
                3.0202661588737305
              ],
              [
                131.1207237512394,
                3.018294793360804
              ],
              [
                131.11703303163492,
                3.013152083889876
              ],
              [
                131.11557390993082,
                3.0069808004556373
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                131.71866859492417,
                2.8134876317519355
              ],
              [
                131.72828163203354,
                2.798056628592094
              ],
              [
                131.74613441523667,
                2.794970403550101
              ],
              [
                131.76261390742417,
                2.7956562320388962
              ],
              [
                131.77325691279526,
                2.7973708015068017
              ],
              [
                131.781496658889,
                2.8076581656130517
              ],
              [
                131.79522956904526,
                2.826175192510456
              ],
              [
                131.8137689977562,
                2.83269037255542
              ],
              [
                131.81514228877182,
                2.848120915760402
              ],
              [
                131.8247553258812,
                2.8779527120781974
              ],
              [
                131.84226478633042,
                2.906412203872787
              ],
              [
                131.83814491328354,
                2.91944161163798
              ],
              [
                131.83986152705307,
                2.930413627320812
              ],
              [
                131.85016120967026,
                2.9430998863517215
              ],
              [
                131.84981788691636,
                2.957843195096333
              ],
              [
                131.8261053499795,
                2.998323802364765
              ],
              [
                131.82782196374905,
                3.012037826967198
              ],
              [
                131.8146040489421,
                3.015980669754854
              ],
              [
                131.79932617517483,
                3.0137520679142744
              ],
              [
                131.7814733919717,
                2.9671237571218225
              ],
              [
                131.73306488367092,
                2.906435440861376
              ],
              [
                131.73443817468655,
                2.880376175242504
              ],
              [
                131.72928833337795,
                2.8745470471785186
              ],
              [
                131.71692871423733,
                2.8375142464750303
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                132.3067901956411,
                4.2907706055624635
              ],
              [
                132.31039508455711,
                4.287689354952635
              ],
              [
                132.31657489412743,
                4.298302499140772
              ],
              [
                132.32120975130516,
                4.311825484862319
              ],
              [
                132.32138141268211,
                4.341609439086691
              ],
              [
                132.3103091064958,
                4.335447317508333
              ],
              [
                132.3016403543325,
                4.319014822379694
              ],
              [
                132.30249866121727,
                4.306519025440456
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                131.937656571673,
                4.652358358210062
              ],
              [
                131.94658296327455,
                4.645856688463634
              ],
              [
                131.95688264589174,
                4.643803517136325
              ],
              [
                131.97027223329408,
                4.652358358210062
              ],
              [
                131.96958558778627,
                4.6667302571169165
              ],
              [
                131.95344941835268,
                4.669125545015897
              ],
              [
                131.94005983095033,
                4.6636505892362985
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                132.21641162300162,
                5.343387733007776
              ],
              [
                132.2093734537665,
                5.330910612869323
              ],
              [
                132.21194842720084,
                5.314331424400584
              ],
              [
                132.22396472358756,
                5.306810744455725
              ],
              [
                132.2322044696813,
                5.307152595534372
              ],
              [
                132.24044421577506,
                5.315698810892492
              ],
              [
                132.2373543109899,
                5.333816394966432
              ],
              [
                132.2425041522985,
                5.3502243114946255
              ],
              [
                132.2431907978063,
                5.363213600071999
              ],
              [
                132.2318611659675,
                5.366973709126116
              ],
              [
                132.2205314960485,
                5.36526451511986
              ],
              [
                132.21366504097037,
                5.355009870986218
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                134.11325370931658,
                6.888138540669533
              ],
              [
                134.1204634871486,
                6.88353711468726
              ],
              [
                134.13196479940447,
                6.8802990474367425
              ],
              [
                134.14415275716814,
                6.889161073715341
              ],
              [
                134.15874397420916,
                6.900238373654085
              ],
              [
                134.16269218587908,
                6.90995210032868
              ],
              [
                134.15908729696307,
                6.919836038401765
              ],
              [
                134.1439810957912,
                6.931083026552157
              ],
              [
                134.12956154012713,
                6.92920854715278
              ],
              [
                134.11771690511736,
                6.925629974878134
              ],
              [
                134.12355339193377,
                6.909440856529485
              ],
              [
                134.12252342367205,
                6.90466922108508
              ],
              [
                134.11634361410174,
                6.904157971575555
              ],
              [
                134.11119377279314,
                6.8976820966565455
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                134.21982694287544,
                6.951624504528218
              ],
              [
                134.23767972607857,
                6.962529942178486
              ],
              [
                134.2829983295942,
                7.0156903136187365
              ],
              [
                134.32007718701607,
                7.040223825396011
              ],
              [
                134.37226224560982,
                7.092012529139463
              ],
              [
                134.40796781201607,
                7.104277423382419
              ],
              [
                134.40796781201607,
                7.135619554123927
              ],
              [
                134.47388578076607,
                7.176497367450935
              ],
              [
                134.4642727436567,
                7.216009096934457
              ],
              [
                134.5027248920942,
                7.247343533863988
              ],
              [
                134.54804349560982,
                7.237807196355539
              ],
              [
                134.58237577100044,
                7.284124656921371
              ],
              [
                134.63867272256815,
                7.361757340297979
              ],
              [
                134.66477323193794,
                7.455729754605989
              ],
              [
                134.66339994092232,
                7.570095893562277
              ],
              [
                134.6894924702192,
                7.662655812325723
              ],
              [
                134.6894924702192,
                7.798736734184982
              ],
              [
                134.72519803662544,
                7.857237969502388
              ],
              [
                134.72519803662544,
                8.010934330916959
              ],
              [
                134.66065335889107,
                8.027252680558814
              ],
              [
                134.61945462842232,
                7.9905354741746
              ],
              [
                134.56177640576607,
                8.029972341814009
              ],
              [
                134.52332425732857,
                8.031332165612561
              ],
              [
                134.47800565381294,
                7.97013559792007
              ],
              [
                134.46015287060982,
                7.904849172318234
              ],
              [
                134.53293729443794,
                7.78240934518786
              ],
              [
                134.54255033154732,
                7.721175983422907
              ],
              [
                134.44367337842232,
                7.582347617436034
              ],
              [
                134.35852933545357,
                7.541507184785806
              ],
              [
                134.34479642529732,
                7.462538103722892
              ],
              [
                134.25965238232857,
                7.409430177632663
              ],
              [
                134.1896145405317,
                7.338609658020769
              ],
              [
                134.20746732373482,
                7.292297830518859
              ],
              [
                134.1786282124067,
                7.310005861282488
              ],
              [
                134.1566555561567,
                7.274589099380002
              ],
              [
                134.2060940327192,
                7.138344855503339
              ],
              [
                134.22532010693794,
                7.115179276922142
              ],
              [
                134.23081327100044,
                7.093375311307696
              ],
              [
                134.24591947217232,
                7.0824729410866105
              ],
              [
                134.21982694287544,
                7.02795723138956
              ],
              [
                134.19922757764107,
                7.0047861153568265
              ],
              [
                134.21570706982857,
                6.972071992203277
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                134.68880582471138,
                8.027252680558814
              ],
              [
                134.71901822705513,
                8.027932597579635
              ],
              [
                134.734124428227,
                8.066685983833501
              ],
              [
                134.74030423779732,
                8.097957938758201
              ],
              [
                134.71970487256294,
                8.114272777908399
              ],
              [
                134.6949856342817,
                8.111553684009644
              ],
              [
                134.67781949658638,
                8.08368191220926
              ],
              [
                134.67713285107857,
                8.046289926687853
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                134.62838102002388,
                8.1380640640784
              ],
              [
                134.64486051221138,
                8.148939610371997
              ],
              [
                134.67232633252388,
                8.20195365852714
              ],
              [
                134.6781623587142,
                8.216904760513684
              ],
              [
                134.69223905225044,
                8.23865155334291
              ],
              [
                134.67987943310982,
                8.361632556513234
              ],
              [
                134.6730129780317,
                8.403749755366865
              ],
              [
                134.65378690381294,
                8.453333496415613
              ],
              [
                134.62494779248482,
                8.486612159333074
              ],
              [
                134.5909571799679,
                8.469294569849387
              ],
              [
                134.57327645318517,
                8.459616126004356
              ],
              [
                134.56658292432076,
                8.441787166035173
              ],
              [
                134.52675748486763,
                8.398315534605178
              ],
              [
                134.55696988721138,
                8.26447395878902
              ],
              [
                134.59267545361763,
                8.216225465493624
              ],
              [
                134.60915494580513,
                8.191759196916609
              ],
              [
                134.59885526318794,
                8.174088178403528
              ],
              [
                134.61052823682076,
                8.144181595217242
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                137.31702614187014,
                8.418180099987557
              ],
              [
                137.33762550710452,
                8.401877815995086
              ],
              [
                137.45572853444827,
                8.351608132989028
              ],
              [
                137.47632789968264,
                8.28162739747639
              ],
              [
                137.52645302175296,
                8.289781135249518
              ],
              [
                137.6115970647217,
                8.604248872077779
              ],
              [
                137.5449924504639,
                8.626652486592377
              ],
              [
                137.47632789968264,
                8.570980454531513
              ],
              [
                137.40011024831546,
                8.513942113549994
              ],
              [
                137.3534183537842,
                8.513942113549994
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                138.15587296736223,
                9.665009823008772
              ],
              [
                138.13115372908098,
                9.637932759028168
              ],
              [
                138.12772050154192,
                9.621346983777054
              ],
              [
                138.1105543638466,
                9.597990124581568
              ],
              [
                138.0937315489052,
                9.590881195480362
              ],
              [
                138.03776994001848,
                9.49811297690794
              ],
              [
                138.0171705747841,
                9.42360934059141
              ],
              [
                138.04154649031145,
                9.406335742316438
              ],
              [
                138.1266905332802,
                9.473054465483985
              ],
              [
                138.16205277693254,
                9.48456806297818
              ],
              [
                138.23758378279192,
                9.540098802368119
              ],
              [
                138.16754594099504,
                9.68227031429192
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                139.5494366892726,
                10.031352260328594
              ],
              [
                139.5775891550929,
                10.020533704153735
              ],
              [
                139.60299503888197,
                9.99957172471373
              ],
              [
                139.59200871075697,
                9.975227083985164
              ],
              [
                139.5720959910304,
                9.929237801922033
              ],
              [
                139.5666028269679,
                9.895418028595076
              ],
              [
                139.62908756817885,
                9.835210222385188
              ],
              [
                139.63595402325697,
                9.77431476833662
              ],
              [
                139.67234623517103,
                9.761457633527868
              ],
              [
                139.70187199200697,
                9.787848057516328
              ],
              [
                139.7149182566554,
                9.825738331312838
              ],
              [
                139.70599186505385,
                9.882565600932434
              ],
              [
                139.69363224591322,
                9.931266877320475
              ],
              [
                139.73826420392103,
                10.017152831306639
              ],
              [
                139.76161015118666,
                10.014448107656655
              ],
              [
                139.78289616192885,
                9.998219292477708
              ],
              [
                139.80418146879381,
                10.005995810672605
              ],
              [
                139.81585514630385,
                10.025943027384448
              ],
              [
                139.78838932599135,
                10.033380699396092
              ],
              [
                139.78152287091322,
                10.052988288305215
              ],
              [
                139.75062382306166,
                10.091523873646668
              ],
              [
                139.70667851056166,
                10.107072015307432
              ],
              [
                139.6757794627101,
                10.096255996307871
              ],
              [
                139.6160413035304,
                10.065833994842592
              ],
              [
                139.57793134219764,
                10.064483164139459
              ],
              [
                139.55218327130385,
                10.042846580341964
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                139.80006229962416,
                9.932619587263181
              ],
              [
                139.81242191876478,
                9.915033922057583
              ],
              [
                139.83851444806166,
                9.900829426665638
              ],
              [
                139.8570538767726,
                9.900829426665638
              ],
              [
                139.8680402048976,
                9.90962275825107
              ],
              [
                139.86186039532728,
                9.925855981639085
              ],
              [
                139.80624210919447,
                9.946146378981151
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                139.89310276593275,
                9.925179613390467
              ],
              [
                139.90443241681166,
                9.915033922057583
              ],
              [
                139.9281216868312,
                9.88290382915086
              ],
              [
                139.9391080149562,
                9.82878289731724
              ],
              [
                139.91988194073744,
                9.774991445880593
              ],
              [
                139.92640507306166,
                9.76382609041301
              ],
              [
                139.9391080149562,
                9.760442575420681
              ],
              [
                139.98065006817885,
                9.774991445880593
              ],
              [
                139.98065006817885,
                9.786494753400296
              ],
              [
                139.97035038556166,
                9.809838476026657
              ],
              [
                139.97447025860853,
                9.86159477250998
              ],
              [
                139.96554386700697,
                9.878168602443637
              ],
              [
                139.96485722149916,
                9.909284557548245
              ],
              [
                139.96279728497572,
                9.928899621465936
              ],
              [
                139.95799076642103,
                9.947160865794778
              ],
              [
                139.9456311472804,
                9.947499027365952
              ],
              [
                139.9339581736476,
                9.946822703873579
              ],
              [
                139.90443241681166,
                9.960687055501948
              ],
              [
                139.8951627024562,
                9.935663164185518
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                140.50021571537323,
                9.757506515048378
              ],
              [
                140.50742549320526,
                9.747017307796312
              ],
              [
                140.52150172611542,
                9.74904750269677
              ],
              [
                140.53386134525604,
                9.760890059866842
              ],
              [
                140.5362646045334,
                9.771378830314607
              ],
              [
                140.5263082446701,
                9.779498941649296
              ],
              [
                140.5146352710373,
                9.77814560353017
              ],
              [
                140.50570887943573,
                9.769348771507373
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                140.30980966047906,
                8.14738778047298
              ],
              [
                140.32491586165094,
                8.146708064849715
              ],
              [
                140.34688851790094,
                8.14806749494183
              ],
              [
                140.36474130110406,
                8.120878016657826
              ],
              [
                140.3949537034478,
                8.108642150366133
              ],
              [
                140.42035958723687,
                8.101844285963322
              ],
              [
                140.4320325608697,
                8.107962369095203
              ],
              [
                140.4210462327447,
                8.133793248790278
              ],
              [
                140.3935804124322,
                8.151466049966295
              ],
              [
                140.361308073565,
                8.1637006088867
              ],
              [
                140.33521554426812,
                8.165739665619459
              ],
              [
                140.3166761155572,
                8.158263073379013
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                142.97557923600752,
                6.669139429445437
              ],
              [
                142.99274537370283,
                6.670503425978059
              ],
              [
                143.0408105592497,
                6.673231407649806
              ],
              [
                143.07720277116377,
                6.666411424990474
              ],
              [
                143.09436890885908,
                6.669139429445437
              ],
              [
                143.09780213639814,
                6.690962917830759
              ],
              [
                143.07720277116377,
                6.714149305739784
              ],
              [
                143.02707663221204,
                6.715856585528289
              ],
              [
                142.97695252702314,
                6.694372749886782
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                143.81105998549373,
                7.346985258893093
              ],
              [
                143.82479289564998,
                7.336770020238127
              ],
              [
                143.82204631361873,
                7.323830381339672
              ],
              [
                143.8316593507281,
                7.312933551970162
              ],
              [
                143.88315776381404,
                7.321106198952727
              ],
              [
                143.89345744643123,
                7.331321797049264
              ],
              [
                143.90375712904842,
                7.329959730835329
              ],
              [
                143.91543010268123,
                7.333364888558797
              ],
              [
                143.92572978529842,
                7.353114289391519
              ],
              [
                143.92092326674373,
                7.385801021479466
              ],
              [
                143.90719035658748,
                7.394653262576239
              ],
              [
                143.89620402846248,
                7.379672443005683
              ],
              [
                143.88178447279842,
                7.377629564643466
              ],
              [
                143.87835124525935,
                7.366053075853854
              ],
              [
                143.8536320069781,
                7.384439122492875
              ],
              [
                143.82685283217342,
                7.381715311934133
              ],
              [
                143.8144932130328,
                7.361967184061986
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                144.42904094252498,
                7.2420976954974945
              ],
              [
                144.43762401137263,
                7.233583019039439
              ],
              [
                144.44861033949763,
                7.235626556043859
              ],
              [
                144.45959666762263,
                7.230858288643483
              ],
              [
                144.47126964125545,
                7.231880064468888
              ],
              [
                144.47126964125545,
                7.238351257654777
              ],
              [
                144.46543315443904,
                7.254358547067238
              ],
              [
                144.46234324965388,
                7.266959629823556
              ],
              [
                144.4468937257281,
                7.269003015365395
              ],
              [
                144.43281749281795,
                7.26389453408753
              ],
              [
                144.42560771498592,
                7.247206424203239
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                144.5505771974078,
                7.35583827579323
              ],
              [
                144.56877330336482,
                7.354816782851436
              ],
              [
                144.60138896498592,
                7.369457956907842
              ],
              [
                144.63743785414607,
                7.394312795045607
              ],
              [
                144.66730693373592,
                7.427677363256274
              ],
              [
                144.6614704469195,
                7.473634608358751
              ],
              [
                144.63228801283748,
                7.474996230897
              ],
              [
                144.58181956801326,
                7.410995395046697
              ],
              [
                144.56842998061092,
                7.411335849697507
              ],
              [
                144.54714396986873,
                7.371160387622016
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                144.48391456261515,
                8.619093051805331
              ],
              [
                144.47910804406047,
                8.576999477847316
              ],
              [
                144.5196201290214,
                8.563419909445207
              ],
              [
                144.54914588585734,
                8.588541729365723
              ],
              [
                144.50726050988078,
                8.622487490930558
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                145.37679531375568,
                9.235099000953271
              ],
              [
                145.37542202274005,
                9.22899924044259
              ],
              [
                145.38228847781818,
                9.214427163345107
              ],
              [
                145.39602138797443,
                9.218324405689762
              ],
              [
                145.3965363721053,
                9.229507557849567
              ],
              [
                145.38177349368732,
                9.241198655879904
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                145.84422924319904,
                7.677958850190265
              ],
              [
                145.86276867190998,
                7.6714941507492185
              ],
              [
                145.8806214551131,
                7.673535645401619
              ],
              [
                145.89332439700763,
                7.6840832115871684
              ],
              [
                145.89298107425373,
                7.709260213082703
              ],
              [
                145.88371135989826,
                7.715043907471583
              ],
              [
                145.86105205814044,
                7.706198225229487
              ],
              [
                145.83942272464435,
                7.688846542725026
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                146.15115978519123,
                7.433593633296417
              ],
              [
                146.15287639896076,
                7.408741008691037
              ],
              [
                146.15184643069904,
                7.396484403437675
              ],
              [
                146.1607728223006,
                7.391717853887224
              ],
              [
                146.1717591504256,
                7.396824869293337
              ],
              [
                146.18034221927326,
                7.403634131235542
              ],
              [
                146.18034221927326,
                7.414869183505703
              ],
              [
                146.17038585940998,
                7.43087012653375
              ],
              [
                146.15287639896076,
                7.437678861767982
              ],
              [
                146.1552796582381,
                7.448232192605079
              ],
              [
                146.1545930127303,
                7.455721499057612
              ],
              [
                146.15356304446857,
                7.4758058244488765
              ],
              [
                146.16901256839435,
                7.48806021340567
              ],
              [
                146.1834321240584,
                7.4911237568396825
              ],
              [
                146.18617870608966,
                7.50542000792879
              ],
              [
                146.18137218753498,
                7.523119477115486
              ],
              [
                146.1717591504256,
                7.526182773530001
              ],
              [
                146.15356304446857,
                7.519715789065499
              ],
              [
                146.12987377444904,
                7.490442971271017
              ],
              [
                146.11820080081623,
                7.464572332416697
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                146.25552990237873,
                7.494527668726091
              ],
              [
                146.35990001956623,
                7.442444913590595
              ],
              [
                146.39457561771076,
                7.443806633171983
              ],
              [
                146.39388897220294,
                7.464231919060161
              ],
              [
                146.35543682376544,
                7.482273461515276
              ],
              [
                146.34582378665607,
                7.508143050118508
              ],
              [
                146.33827068607013,
                7.534691816678801
              ],
              [
                146.31423767292918,
                7.528906172914394
              ],
              [
                146.29363872806232,
                7.518354306371403
              ],
              [
                146.2713227490584,
                7.524480944859384
              ],
              [
                146.25312664310138,
                7.510185320567824
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                146.6955983111626,
                8.05669989360822
              ],
              [
                146.72718400452197,
                8.053300538239712
              ],
              [
                146.74297685120166,
                8.080494581184551
              ],
              [
                146.77112931702197,
                8.075735755770845
              ],
              [
                146.81507462952197,
                8.074376081064587
              ],
              [
                146.81301469299854,
                8.095450524157197
              ],
              [
                146.75190324280322,
                8.101568704476765
              ],
              [
                146.72649735901416,
                8.097489927925848
              ],
              [
                146.69353837463916,
                8.088652437036705
              ],
              [
                146.68255204651416,
                8.075055918989936
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                149.38024306411907,
                7.57382974420004
              ],
              [
                149.40633559341595,
                7.525500527374904
              ],
              [
                149.4475343238847,
                7.523458328956717
              ],
              [
                149.45714736099407,
                7.558174392565642
              ],
              [
                149.44890761490032,
                7.645292585489055
              ],
              [
                149.43242812271282,
                7.655500588824205
              ],
              [
                149.4035890113847,
                7.639848217199524
              ],
              [
                149.37955641861126,
                7.593568289811886
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                149.1563966285722,
                7.371287686087984
              ],
              [
                149.18695235366985,
                7.334513739807219
              ],
              [
                149.20892500991985,
                7.346091051285111
              ],
              [
                149.21819472427532,
                7.358349052362386
              ],
              [
                149.20755171890423,
                7.3760544558991885
              ],
              [
                149.1625764381425,
                7.384906892180736
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                149.01632094497845,
                7.047880501858599
              ],
              [
                149.04704833145306,
                7.015510156668452
              ],
              [
                149.0820672523515,
                7.0466879502445625
              ],
              [
                149.07863402481243,
                7.058613328229165
              ],
              [
                149.04636168594524,
                7.072412310576497
              ],
              [
                149.01082778091595,
                7.076671172517011
              ],
              [
                149.0061929237382,
                7.070538398878663
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                149.15555569308975,
                6.955135710035334
              ],
              [
                149.16431042331436,
                6.963144355626446
              ],
              [
                149.17392346042374,
                6.9939848825810245
              ],
              [
                149.1615638412831,
                6.997392550835816
              ],
              [
                149.14903256076553,
                6.991429115072633
              ],
              [
                149.14491268771866,
                6.984102504081694
              ],
              [
                149.14233776706436,
                6.963314750856329
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                149.29752495963746,
                6.666174320710904
              ],
              [
                149.31537774284058,
                6.67452879042614
              ],
              [
                149.3225875206726,
                6.72652788984299
              ],
              [
                149.31846764762574,
                6.744768880323135
              ],
              [
                149.28465035636597,
                6.740166078279171
              ],
              [
                149.24327996452027,
                6.745791719284246
              ],
              [
                149.2420783348816,
                6.724482128534754
              ],
              [
                149.28430703361207,
                6.704705992252854
              ],
              [
                149.29203179557496,
                6.682030641760877
              ],
              [
                149.29323342521363,
                6.6670268241465
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                149.4620019362957,
                6.312186135384973
              ],
              [
                149.51933683619805,
                6.2446159484882084
              ],
              [
                149.53100980983086,
                6.2538305804665955
              ],
              [
                149.52894987330743,
                6.322764510452477
              ],
              [
                149.47470487819024,
                6.331977757592674
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                149.66914596259969,
                8.56421872828779
              ],
              [
                149.71309127509969,
                8.542490456616601
              ],
              [
                149.8902458161153,
                8.547243621919419
              ],
              [
                149.94929732978719,
                8.56082376755592
              ],
              [
                149.96509017646687,
                8.692525923867452
              ],
              [
                149.89230575263875,
                8.73732129821029
              ],
              [
                150.00697555244344,
                8.808575563897511
              ],
              [
                150.09417953193562,
                8.857427703503049
              ],
              [
                150.0825065583028,
                8.925945453867865
              ],
              [
                150.16353072822469,
                8.951042800790772
              ],
              [
                150.18344344795125,
                8.947651368498827
              ],
              [
                150.20198287666219,
                8.850643071430394
              ],
              [
                150.3070396393575,
                8.75293054427649
              ],
              [
                150.2850669831075,
                8.6803080730662
              ],
              [
                150.21296920478719,
                8.60767154602586
              ],
              [
                150.1099723786153,
                8.567613658725472
              ],
              [
                150.10173263252156,
                8.538416267784612
              ],
              [
                150.14499129951375,
                8.520760947149217
              ],
              [
                150.19099654853719,
                8.538416267784612
              ],
              [
                150.257601162795,
                8.571687535245935
              ],
              [
                150.3077262848653,
                8.547922640697097
              ],
              [
                150.36609115302937,
                8.570329581255953
              ],
              [
                150.43818893134969,
                8.544527534715238
              ],
              [
                150.44368209541219,
                8.567613658725472
              ],
              [
                150.40934982002156,
                8.620570642213073
              ],
              [
                150.35510482490437,
                8.724426210618187
              ],
              [
                150.35579147041219,
                8.748179973425303
              ],
              [
                150.34137191474812,
                8.787540013702841
              ],
              [
                150.23974837959187,
                8.851321540268767
              ],
              [
                150.21571578681844,
                8.911021888152819
              ],
              [
                150.22670211494344,
                8.927980438278903
              ],
              [
                150.1971763581075,
                9.001910484437696
              ],
              [
                150.12713851631062,
                9.001232295621717
              ],
              [
                150.05160751045125,
                8.961895171590202
              ],
              [
                150.05778732002156,
                8.905594985818498
              ],
              [
                150.0165885895528,
                8.885921790000774
              ],
              [
                149.88612594306844,
                8.792968657195603
              ],
              [
                149.78312911689656,
                8.702707161956729
              ],
              [
                149.7584098786153,
                8.70134967953787
              ],
              [
                149.73231734931844,
                8.693883438267958
              ],
              [
                149.66090621650594,
                8.590698381393365
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                151.3286615774692,
                8.559087669227754
              ],
              [
                151.32557167268405,
                8.549581574780364
              ],
              [
                151.34102119660983,
                8.527512941837799
              ],
              [
                151.3496042654575,
                8.528531522208475
              ],
              [
                151.35372413850436,
                8.562482645446723
              ],
              [
                151.32522834993014,
                8.567235561266413
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                151.66649116731296,
                8.481334451751016
              ],
              [
                151.69533027864108,
                8.434471192741416
              ],
              [
                151.7509485647739,
                8.416131846688138
              ],
              [
                151.94046272493014,
                8.552637131009334
              ],
              [
                151.93977607942233,
                8.574364823616753
              ],
              [
                151.83540596223483,
                8.618495371506599
              ],
              [
                151.74888862825046,
                8.631394098326352
              ],
              [
                151.71386970735202,
                8.617137585174138
              ],
              [
                151.67129768586764,
                8.575043794009478
              ],
              [
                151.67129768586764,
                8.518006060823575
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                152.01118721223483,
                8.585907155227174
              ],
              [
                152.07985176301608,
                8.542451848325586
              ],
              [
                152.10525764680514,
                8.548563050593039
              ],
              [
                152.11075081086764,
                8.585228204257689
              ],
              [
                152.2563196585239,
                8.595412341209371
              ],
              [
                152.35931648469577,
                8.687735991283816
              ],
              [
                152.34764351106296,
                8.754249252506817
              ],
              [
                152.3064447805942,
                8.797001505461203
              ],
              [
                152.237778370583,
                8.79802568799571
              ],
              [
                152.16636909700046,
                8.777322508686641
              ],
              [
                152.1471430227817,
                8.682984591465923
              ],
              [
                152.0091272757114,
                8.606954032305826
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                151.42157840537155,
                7.319495925120272
              ],
              [
                151.44767093466842,
                7.278631048660896
              ],
              [
                151.5458612422856,
                7.28544212049596
              ],
              [
                151.57538699912155,
                7.266370858813519
              ],
              [
                151.63100528525436,
                7.2146019314063645
              ],
              [
                151.68731021689499,
                7.215283140042071
              ],
              [
                151.81639957236374,
                7.205746125878425
              ],
              [
                151.82669925498092,
                7.17985893359124
              ],
              [
                151.87819766806686,
                7.132849479062316
              ],
              [
                151.82326602744186,
                7.123992083969136
              ],
              [
                151.83905887412155,
                7.085494496712897
              ],
              [
                151.89776706503952,
                7.0020152558075095
              ],
              [
                151.98565769003952,
                6.969641724678816
              ],
              [
                152.03354069243656,
                7.045414412339555
              ],
              [
                151.8989581729053,
                7.116280901988374
              ],
              [
                151.94015690337406,
                7.140809066198062
              ],
              [
                152.04384037505375,
                7.2164292723977015
              ],
              [
                152.04590031157718,
                7.373760394618869
              ],
              [
                151.96693607817875,
                7.6099922212708755
              ],
              [
                151.91337772856937,
                7.667839126828547
              ],
              [
                151.80626102935062,
                7.7032239496424095
              ],
              [
                151.67717167388187,
                7.684170949937646
              ],
              [
                151.66893192778812,
                7.595699428391851
              ],
              [
                151.59889408599125,
                7.52354761564424
              ],
              [
                151.50963016997562,
                7.4391283843192415
              ],
              [
                151.42723270903812,
                7.405083765980587
              ],
              [
                151.41899296294437,
                7.3778461776349005
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                152.56312656210983,
                7.000652204991119
              ],
              [
                152.56449985312545,
                6.9904291969984955
              ],
              [
                152.5782327632817,
                6.977479732506048
              ],
              [
                152.5940256099614,
                6.983272958307026
              ],
              [
                152.58269595908249,
                6.9989483858712145
              ],
              [
                152.56827640341842,
                7.008148935185211
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                152.6719598750981,
                6.9082962781537
              ],
              [
                152.6657800655278,
                6.8547829155548365
              ],
              [
                152.67573642539108,
                6.827853534117218
              ],
              [
                152.69736575888717,
                6.825467313213402
              ],
              [
                152.71384525107467,
                6.832966824551161
              ],
              [
                152.71350192832077,
                6.856828122940494
              ],
              [
                152.72448825644577,
                6.8701217568512805
              ],
              [
                152.75195407675827,
                6.887505178841176
              ],
              [
                152.75298404501999,
                6.905569628623988
              ],
              [
                152.67813968466842,
                6.922951749870666
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                153.1013393810974,
                5.917218461763455
              ],
              [
                153.13567165648803,
                5.887166219245767
              ],
              [
                153.1617641857849,
                5.881702000278098
              ],
              [
                153.1672573498474,
                5.945903169451118
              ],
              [
                153.1013393810974,
                5.94453726484718
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                153.5572719982849,
                5.560586574081494
              ],
              [
                153.58748440062865,
                5.552385544720854
              ],
              [
                153.60259060180053,
                5.576988289794531
              ],
              [
                153.57237819945678,
                5.650790317922328
              ],
              [
                153.52293972289428,
                5.609790344528361
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                153.71932033812865,
                5.488823710690979
              ],
              [
                153.77768520629272,
                5.484722713675845
              ],
              [
                153.83536342894897,
                5.484722713675845
              ],
              [
                153.83879665648803,
                5.507277847909387
              ],
              [
                153.8099575451599,
                5.551702120454181
              ],
              [
                153.75090603148803,
                5.569470893587805
              ],
              [
                153.7213802746521,
                5.572204503343322
              ],
              [
                153.69803432738647,
                5.525731412059868
              ],
              [
                153.69872097289428,
                5.504543937769665
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                153.4683050514494,
                5.398387674182969
              ],
              [
                153.49302428973064,
                5.36967579688399
              ],
              [
                153.56031554949627,
                5.342329894354036
              ],
              [
                153.60975402605877,
                5.276694760255704
              ],
              [
                153.66331237566814,
                5.265754893734601
              ],
              [
                153.75120300066814,
                5.316350156334091
              ],
              [
                153.75257629168377,
                5.360104870220754
              ],
              [
                153.65096342484193,
                5.468111389503693
              ],
              [
                153.58778136980877,
                5.515955386201547
              ],
              [
                153.5397161842619,
                5.51048763321815
              ],
              [
                153.48615783465252,
                5.533725235144548
              ],
              [
                153.4353460670744,
                5.464009705383777
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                154.89853222963063,
                3.84623486601743
              ],
              [
                154.9029954254314,
                3.8222560660917666
              ],
              [
                154.9297746002361,
                3.8051279411167775
              ],
              [
                154.96136029359548,
                3.811979232059114
              ],
              [
                154.9798997223064,
                3.8184879078947542
              ],
              [
                154.98916943666188,
                3.8445221169186485
              ],
              [
                154.97818310853688,
                3.872610766540105
              ],
              [
                154.9459107696697,
                3.8849420747712275
              ],
              [
                154.91775830384938,
                3.8784339067385583
              ],
              [
                154.89921887513844,
                3.852743281187403
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                157.13034338417302,
                5.783111226181515
              ],
              [
                157.15059942665349,
                5.767056954952113
              ],
              [
                157.20209783973942,
                5.768764877764247
              ],
              [
                157.25805944862614,
                5.772522289844326
              ],
              [
                157.29788488807927,
                5.761933155670794
              ],
              [
                157.34148687782536,
                5.7663737843874605
              ],
              [
                157.36483282509099,
                5.78652696983528
              ],
              [
                157.34526342811833,
                5.842542212646028
              ],
              [
                157.29342169227849,
                5.8695231686088
              ],
              [
                157.2669858402277,
                5.86576640477392
              ],
              [
                157.18664831581364,
                5.829563567819589
              ],
              [
                157.13755316200505,
                5.801897560736068
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                154.22569761854777,
                8.086608510834221
              ],
              [
                154.26483641249308,
                8.07573127794157
              ],
              [
                154.28337584120402,
                8.045817377837105
              ],
              [
                154.3094683705009,
                8.045817377837105
              ],
              [
                154.33075438124308,
                8.07301192392142
              ],
              [
                154.33281431776652,
                8.131473991076996
              ],
              [
                154.29092894178996,
                8.165459651223543
              ],
              [
                154.2442370472587,
                8.146428037123192
              ],
              [
                154.2222643910087,
                8.098845047128078
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                155.1506091175712,
                7.524016061504032
              ],
              [
                155.1945544300712,
                7.485212517681562
              ],
              [
                155.21309385878214,
                7.4321073389848475
              ],
              [
                155.22408018690714,
                7.412361465910417
              ],
              [
                155.29068480116496,
                7.410318738814769
              ],
              [
                155.32845030409464,
                7.3967003162360925
              ],
              [
                155.38475523573527,
                7.393976581269161
              ],
              [
                155.41496763807902,
                7.4341499648861475
              ],
              [
                155.42732725721964,
                7.47159641985727
              ],
              [
                155.40398130995402,
                7.517208672775677
              ],
              [
                155.4300738392509,
                7.576429369610339
              ],
              [
                155.42389402968058,
                7.626794592494059
              ],
              [
                155.35110960585246,
                7.638364145623276
              ],
              [
                155.32845030409464,
                7.601612719620557
              ],
              [
                155.16777525526652,
                7.6506139192054565
              ],
              [
                155.13275633436808,
                7.649933385452716
              ],
              [
                155.11971006971964,
                7.547841080201669
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                157.75848875624308,
                7.062238112450789
              ],
              [
                157.80037413221964,
                7.02543910407569
              ],
              [
                157.84363279921183,
                7.022031640915685
              ],
              [
                157.8415728626884,
                7.072459540265323
              ],
              [
                157.81204710585246,
                7.094264496417267
              ],
              [
                157.75505552870402,
                7.102441088895091
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                157.88963804823527,
                6.795038989439602
              ],
              [
                157.90680418593058,
                6.756173548301464
              ],
              [
                157.90955076796183,
                6.723442332409692
              ],
              [
                157.93907652479777,
                6.712531436714938
              ],
              [
                157.95830259901652,
                6.735716797268607
              ],
              [
                157.99263487440714,
                6.747309062267037
              ],
              [
                158.01872740370402,
                6.749354727299859
              ],
              [
                158.04344664198527,
                6.7807205072154035
              ],
              [
                158.02628050428996,
                6.81344783998201
              ],
              [
                158.00293455702433,
                6.842082424423696
              ],
              [
                157.96722899061808,
                6.822311108695595
              ],
              [
                157.93632994276652,
                6.824356455112039
              ],
              [
                157.91710386854777,
                6.8407189116620275
              ],
              [
                157.87933836561808,
                6.805948023106708
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                158.0733347548335,
                6.9133840490621665
              ],
              [
                158.09805399311475,
                6.843850336484126
              ],
              [
                158.1062937392085,
                6.7763520453029695
              ],
              [
                158.1783915175288,
                6.76816979026798
              ],
              [
                158.21959024799756,
                6.7552142695799535
              ],
              [
                158.26971537006787,
                6.747713546326374
              ],
              [
                158.3047342909663,
                6.753850510363007
              ],
              [
                158.31984049213818,
                6.784534161495934
              ],
              [
                158.3431864394038,
                6.826806210402712
              ],
              [
                158.37683206928662,
                6.836350995887765
              ],
              [
                158.38301187885693,
                6.84725908872779
              ],
              [
                158.37271219623975,
                6.879300167867791
              ],
              [
                158.34661966694287,
                6.945420656164214
              ],
              [
                158.3486796034663,
                6.986996827230012
              ],
              [
                158.26422220600537,
                7.064686629217427
              ],
              [
                158.23538309467725,
                7.0728637462326835
              ],
              [
                158.19761759174756,
                7.026524840106629
              ],
              [
                158.1399393690913,
                7.013576377555836
              ],
              [
                158.08638101948193,
                6.9740472677295475
              ],
              [
                158.06028849018506,
                6.94678386771005
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                154.69731286861483,
                1.0697487503441383
              ],
              [
                154.77044061519686,
                1.018945424903469
              ],
              [
                154.79069665767733,
                1.018602156421009
              ],
              [
                154.81507257320467,
                1.0337059348832671
              ],
              [
                154.8226256737906,
                1.0972096596695236
              ],
              [
                154.77559045650545,
                1.1164321465901064
              ],
              [
                154.71344903804842,
                1.1009855151307881
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                159.73862701658751,
                6.688127192925515
              ],
              [
                159.73862701658751,
                6.6557324151398385
              ],
              [
                159.7657495141461,
                6.656073423949784
              ],
              [
                159.77776581053283,
                6.70210743417532
              ],
              [
                159.74618011717345,
                6.705517188340209
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                160.68396621946837,
                6.230655292717886
              ],
              [
                160.68259292845275,
                6.213419624599977
              ],
              [
                160.6934075952008,
                6.207617391424428
              ],
              [
                160.69495254759337,
                6.19242889035601
              ],
              [
                160.71452194456603,
                6.186797087868246
              ],
              [
                160.73048645262267,
                6.22434130169777
              ],
              [
                160.7079988122418,
                6.236969207774015
              ],
              [
                160.68705612425353,
                6.241747255113353
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                162.89689505924278,
                5.277230750983185
              ],
              [
                162.9360338531881,
                5.256376482108236
              ],
              [
                162.96109641422325,
                5.262188397840271
              ],
              [
                162.97620261539512,
                5.25808587472115
              ],
              [
                162.99371207584434,
                5.249538864752842
              ],
              [
                163.01087821353966,
                5.253299563582454
              ],
              [
                163.0304476105123,
                5.272102716975948
              ],
              [
                163.04177726139122,
                5.2987680304125675
              ],
              [
                163.04727042545372,
                5.333294481831296
              ],
              [
                163.03216422428184,
                5.350386066566081
              ],
              [
                163.03628409732872,
                5.367477173818491
              ],
              [
                163.02735770572716,
                5.380807905037425
              ],
              [
                162.99851859439903,
                5.386960451728747
              ],
              [
                162.97757590641075,
                5.380466095062613
              ],
              [
                162.9422136627584,
                5.3671353563625175
              ],
              [
                162.92813742984825,
                5.330901621951157
              ],
              [
                162.89483512271934,
                5.326799554749805
              ],
              [
                162.89140189518028,
                5.3052632531724555
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                144.42371213895137,
                12.795064923771386
              ],
              [
                144.44087827664669,
                12.783011925521176
              ],
              [
                144.4587310598498,
                12.828877204529796
              ],
              [
                144.43435514432247,
                12.863521709388378
              ],
              [
                144.40070951443965,
                12.856158059932389
              ],
              [
                144.40242612820919,
                12.816658438637264
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                144.6413399432604,
                13.218971761166484
              ],
              [
                144.68322531923695,
                13.224319315541107
              ],
              [
                144.7457100604479,
                13.240361274785847
              ],
              [
                144.78278891786977,
                13.301177427221033
              ],
              [
                144.8061348651354,
                13.40606609263177
              ],
              [
                144.96131674990102,
                13.542953716631164
              ],
              [
                144.97573630556508,
                13.609032277080924
              ],
              [
                144.93110434755727,
                13.611034370192963
              ],
              [
                144.90295188173695,
                13.643065554707144
              ],
              [
                144.86381308779164,
                13.671089276544658
              ],
              [
                144.84046714052602,
                13.658412291110327
              ],
              [
                144.81986777529164,
                13.632388975606643
              ],
              [
                144.8226143573229,
                13.589010414817862
              ],
              [
                144.80201499208852,
                13.56297946561422
              ],
              [
                144.78278891786977,
                13.523593889879972
              ],
              [
                144.75532309755727,
                13.50757077428251
              ],
              [
                144.74296347841664,
                13.493549665042384
              ],
              [
                144.68391196474477,
                13.486204945828483
              ],
              [
                144.64820639833852,
                13.484201801394208
              ],
              [
                144.60563437685414,
                13.45815939641459
              ],
              [
                144.61181418642445,
                13.434785595157027
              ],
              [
                144.63722007021352,
                13.401390499817621
              ],
              [
                144.6145607684557,
                13.371998978816144
              ],
              [
                144.6028877948229,
                13.345276303514346
              ],
              [
                144.63516013369008,
                13.301177427221033
              ],
              [
                144.64477317079945,
                13.27244202185966
              ],
              [
                144.6255470965807,
                13.240361274785847
              ],
              [
                144.6303536151354,
                13.2203086607531
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                145.1191054621886,
                14.114789405998014
              ],
              [
                145.12771919802864,
                14.113572613202091
              ],
              [
                145.14522865847786,
                14.132883434485867
              ],
              [
                145.16205147341927,
                14.125891774535926
              ],
              [
                145.1644547326966,
                14.105248478472495
              ],
              [
                145.21217659548958,
                14.107246298529397
              ],
              [
                145.22659615115364,
                14.12123054860817
              ],
              [
                145.23346260623177,
                14.125891774535926
              ],
              [
                145.2348358972474,
                14.132550503168133
              ],
              [
                145.24307564334114,
                14.143204063675654
              ],
              [
                145.2629883630677,
                14.143536979400567
              ],
              [
                145.28324440554817,
                14.151193906516117
              ],
              [
                145.2956040246888,
                14.167172749320413
              ],
              [
                145.30212715701302,
                14.195465856521265
              ],
              [
                145.26710823611458,
                14.211108763756975
              ],
              [
                145.23655251101692,
                14.211441579824335
              ],
              [
                145.21183327273567,
                14.197962137597553
              ],
              [
                145.20470932559212,
                14.189141821342938
              ],
              [
                145.19649381117875,
                14.19124165468711
              ],
              [
                145.15083188490922,
                14.173933026959986
              ],
              [
                145.12405271010454,
                14.141642250727555
              ],
              [
                145.11443967299516,
                14.122665118739485
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                145.5260342901282,
                14.836934057880454
              ],
              [
                145.54182713680788,
                14.832287745858473
              ],
              [
                145.56654637508913,
                14.83427903465898
              ],
              [
                145.59675877743288,
                14.854854611911495
              ],
              [
                145.58233922176882,
                14.87874637127637
              ],
              [
                145.52534764462038,
                14.856182001242944
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                145.64825719051882,
                14.887870997771914
              ],
              [
                145.68808262997194,
                14.893179693618956
              ],
              [
                145.69220250301882,
                14.923038669158162
              ],
              [
                145.69769566708132,
                15.015243508507263
              ],
              [
                145.69288914852663,
                15.083542307298618
              ],
              [
                145.65581029110476,
                15.116689160948688
              ],
              [
                145.61598485165163,
                15.117352045226953
              ],
              [
                145.58439915829226,
                15.076912315956157
              ],
              [
                145.57203953915163,
                15.030496594166184
              ],
              [
                145.56311314755007,
                14.992693473839262
              ],
              [
                145.59469884090944,
                14.957868899391581
              ],
              [
                145.6310910528235,
                14.905455551676427
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                145.69357579403444,
                15.112048912997059
              ],
              [
                145.70318883114382,
                15.101773717131028
              ],
              [
                145.73099797421023,
                15.099121972944335
              ],
              [
                145.7409543340735,
                15.094812818020062
              ],
              [
                145.74507420712038,
                15.086525735951858
              ],
              [
                145.75846379452273,
                15.089177637377057
              ],
              [
                145.7629269903235,
                15.116357718032646
              ],
              [
                145.76395695858523,
                15.1279579118576
              ],
              [
                145.75365727596804,
                15.132266393598188
              ],
              [
                145.74953740292116,
                15.139226063633858
              ],
              [
                145.75400059872194,
                15.151156394384774
              ],
              [
                145.76361363583132,
                15.156127167040939
              ],
              [
                145.78146641903444,
                15.145191313057381
              ],
              [
                145.79966252499148,
                15.152481945179186
              ],
              [
                145.80000584774538,
                15.15977232608502
              ],
              [
                145.80240910702273,
                15.169713349543171
              ],
              [
                145.78833287411257,
                15.19390121939474
              ],
              [
                145.79176610165163,
                15.21477345349313
              ],
              [
                145.8168286626868,
                15.23994990452906
              ],
              [
                145.81854527645632,
                15.25154330954158
              ],
              [
                145.83536809139773,
                15.258167825274143
              ],
              [
                145.8372569024926,
                15.278536147284786
              ],
              [
                145.823351795011,
                15.295592411849507
              ],
              [
                145.80824559383913,
                15.295261250110455
              ],
              [
                145.7962292974524,
                15.28764438565788
              ],
              [
                145.76155369930788,
                15.260817573072613
              ],
              [
                145.72275822811648,
                15.261480004798484
              ],
              [
                145.69941228085085,
                15.248562209321815
              ],
              [
                145.67846959286257,
                15.226368245802284
              ],
              [
                145.68258946590944,
                15.21179183230091
              ],
              [
                145.68979924374148,
                15.205497160128283
              ],
              [
                145.69906895809694,
                15.196551776344782
              ],
              [
                145.6904858892493,
                15.18064793523794
              ],
              [
                145.67795460873174,
                15.156292857451277
              ],
              [
                145.6692857091956,
                15.146972570226392
              ],
              [
                145.6656807034368,
                15.139184633878688
              ],
              [
                145.67091649227663,
                15.132266393598188
              ],
              [
                145.68121617489382,
                15.1183463677597
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                146.05280635508032,
                16.00256068392974
              ],
              [
                146.06138942392798,
                16.0071808934613
              ],
              [
                146.06782652352902,
                16.022030505388518
              ],
              [
                146.06808421762915,
                16.03127025378747
              ],
              [
                146.05881450327368,
                16.031765210147203
              ],
              [
                146.04542491587134,
                16.007510904338396
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                145.6203913465354,
                16.327198385480074
              ],
              [
                145.65232036264868,
                16.3219266789728
              ],
              [
                145.72098491342993,
                16.322256164791312
              ],
              [
                145.7518839612815,
                16.34960155253511
              ],
              [
                145.74330089243384,
                16.39374144633858
              ],
              [
                145.61249492319556,
                16.377272505171256
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                145.76631834691142,
                16.6919824440841
              ],
              [
                145.78485777562236,
                16.68606294334339
              ],
              [
                145.79550078099345,
                16.690667015320802
              ],
              [
                145.79618742650126,
                16.70546506666809
              ],
              [
                145.79344084447,
                16.723550016190607
              ],
              [
                145.7769613522825,
                16.727166800349035
              ],
              [
                145.76151182835673,
                16.71730268198345
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                145.83343277592644,
                17.3246950528601
              ],
              [
                145.82656632084831,
                17.317812235402346
              ],
              [
                145.827767950487,
                17.305193067187098
              ],
              [
                145.83600769658074,
                17.29388424565623
              ],
              [
                145.84665070195183,
                17.29175352030319
              ],
              [
                145.85248718876824,
                17.29863731330859
              ],
              [
                145.8591819824694,
                17.310109729235748
              ],
              [
                145.85574875493035,
                17.31977878098775
              ],
              [
                145.84132919926628,
                17.32633378091141
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                145.8156001969947,
                17.62154081359592
              ],
              [
                145.8101070329322,
                17.60403406922968
              ],
              [
                145.81079367844,
                17.58848927545103
              ],
              [
                145.8207500383033,
                17.575070588837065
              ],
              [
                145.83963278976813,
                17.57556153394392
              ],
              [
                145.8566272660865,
                17.589798362286146
              ],
              [
                145.8573139115943,
                17.6097607612769
              ],
              [
                145.83448294845954,
                17.63528323568813
              ],
              [
                145.81869010177985,
                17.627430551314053
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                145.69653207516424,
                18.037816571112536
              ],
              [
                145.7222812817072,
                18.03879591612956
              ],
              [
                145.74494058346502,
                18.049894778589593
              ],
              [
                145.77858621334784,
                18.100809983646787
              ],
              [
                145.80296212887518,
                18.08873527755687
              ],
              [
                145.81909829830877,
                18.114515398859353
              ],
              [
                145.8197849438166,
                18.170631141546686
              ],
              [
                145.77824289059393,
                18.1827001961278
              ],
              [
                145.74768716549627,
                18.164433194613206
              ],
              [
                145.74665719723455,
                18.09983098440083
              ],
              [
                145.715758149383,
                18.09036704318096
              ],
              [
                145.6948154613947,
                18.05968731072643
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                145.64331704830877,
                18.811729224321816
              ],
              [
                145.63027078366034,
                18.799704402323336
              ],
              [
                145.62683755612127,
                18.756798040421213
              ],
              [
                145.64572030758612,
                18.73176428782568
              ],
              [
                145.671812836883,
                18.718758276708456
              ],
              [
                145.69138223385565,
                18.736966412009593
              ],
              [
                145.70408517575018,
                18.756798040421213
              ],
              [
                145.70065194821112,
                18.77175149750232
              ],
              [
                145.70236856198065,
                18.788328779924925
              ],
              [
                145.69000894284002,
                18.808479357182375
              ],
              [
                145.65396005367987,
                18.82245334030998
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                145.4024424317178,
                19.713583146276765
              ],
              [
                145.39042613533107,
                19.70728060620584
              ],
              [
                145.38270137336818,
                19.695321257837488
              ],
              [
                145.3844179871377,
                19.678673650344727
              ],
              [
                145.39883754280177,
                19.668813571873933
              ],
              [
                145.41823527839747,
                19.673824507238834
              ],
              [
                145.42596004036037,
                19.68950287332328
              ],
              [
                145.41857860115138,
                19.7071189993485
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                145.2142973809709,
                20.039119289597078
              ],
              [
                145.20279606871503,
                20.02912030547913
              ],
              [
                145.20468434386152,
                20.014765813073247
              ],
              [
                145.20931920103925,
                20.00589440431884
              ],
              [
                145.22906025938886,
                20.006539614549265
              ],
              [
                145.24450978331464,
                20.011056012085856
              ],
              [
                145.2424498467912,
                20.030087976910885
              ],
              [
                145.22700032286542,
                20.041215770079482
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                144.88630916001208,
                20.535702549644732
              ],
              [
                144.8935189378441,
                20.533773502129055
              ],
              [
                144.90064288498766,
                20.53666706427939
              ],
              [
                144.9059643876732,
                20.5453474222542
              ],
              [
                144.9034752977074,
                20.550892948504274
              ],
              [
                144.8975529802025,
                20.55145552688262
              ],
              [
                144.89334727646715,
                20.55563461571403
              ],
              [
                144.8847642076195,
                20.55298251489873
              ],
              [
                144.88493586899645,
                20.54156991962211
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        }
      ],
      "coordinates": []
    });
/***** End of imports. If edited, may not auto-convert in the playground. *****/
///////////////////////////////
// Global coral atlas project - West Micronesia region
// Contact: mitchell.lyons@gmail.com
// Description:
// - Developing a process to combine OBIA and supervised classification
// - This script loads the raw classification data (from *_classification script)
// - Then applied some cleanup and object-based relational rules
///////////////////////////////

// Table of contents
// 1. Setting constants
// 2. Data loads & vis
// 3. OBIA clean up rules
// 4. Export

// Load and libraries needed
var map_palettes = require('users/mitchest/global_reefs:Modules/colour_pals')
var param_module = require('users/mitchest/global_reefs:Modules/reef_params')

// ###########################################
// SENSOR GENERICS
var sensor_params = param_module.dove         //<------------ THIS IS WHERE YOU CHOOSE THE SENSOR
// REGION AND SENSOR SPECIFIC LOAD PATHS
var region_params = param_module.wmic  //<------------ THIS IS WHERE YOU CHOOSE THE REGION
//  ^^ all the data paths are in this module ^^
// ###########################################

// 1. Setting constants

// These will get written to the asset metadata 

var vars = {
  
  // analysis type
  geomorphic: true, // map geomorphic zonation (when set to true) or benthic habitat (when set to false)

  // analysis parameters
  image_data_scale: ee.Number(sensor_params.pixel),
  small_object: ee.Number(400).int(), // relates to the vars.min_object_size from the *_classification script
  smooth_radius: ee.Number(3), // radius in pixels for initial smooth 
  
  //############
  /* This is a stop-gap until we figure out how to chain together vectorisations in GEE
  - GEOMORPHIC: for large regions, the first pass does the small object filter, then the second pass does the OBIA clean
  -           : for smaller regions, can do both at once
  - BENTHIC : can do both at once */
  obia_2nd_pass: true,
  obia_clean: true, // run object-based relationship rules + small object clean up
  fast_clean: true, // run a faster (but less precise) version of the OBIA clean; only applies to geomorphic
  smooth_output: false, // run smoother over final output (includes noise removal) (should be false for second pass)
  //############
  
    // results/layers to show
  export_small_area: false,
  show_eg_area: false, // contrain the map add toe the corresponding example_area polygon geomtery (you can change that)
                              // - you can either set this, or have it false and just navigate to the area you want to see (keeping in mind ALL tiles in the zoom area will calcualte)
  reproject_display: true,
  //reproject_res: ee.Number(sensor_params.pixel).pow(2),
  
  // export options
  do_export: false, // export the results?
  geomorph_output_name: region_params.sname + '_geo-clean',
  benthic_output_name: region_params.sname + '_benthic-clean',
  asset_output: region_params.asset, // asset path

}

/* TRIAL #######
    Looks like with the sentinel/ls8 depth we can try to retain full resolution,
    because theres more (good) data either side of the depth threshold/marginal areas
  ##############
  
  Used to be --> output resolution (bigger for geomorphic) - relates back to object size and the min mapping unit defined in classification stage
*/
//if (vars.geomorphic) vars.image_data_scale = ee.Number(sensor_params.pixel)//.pow(2)



// 2. Data loads & vis

// load input data
//var geo_map = (vars.obia_2nd_pass) ? ee.Image(region_params.geo_map_clean) : ee.ImageCollection(region_params.geo_map).mosaic()
if (vars.obia_2nd_pass) {
  // OR ru na separate operation that joins the east/west clean1 maps via EPSG:3832, load via one ee.Image(), then save here as EPSG:4326
  //var geo_map = geo1.unmask(0, false).add(geo2.unmask(0,false)).selfMask().clip(swp_extent)
  var geo_map = ee.Image(region_params.geo_map_clean)
} else {
  var geo_map = ee.Image(region_params.geo_map).clip(reef_boundary)
}

//var benthic_map = (vars.obia_2nd_pass) ? ee.Image(region_params.benthic_map_clean) : ee.ImageCollection(region_params.benthic_map).mosaic()
/*var geo_map = (vars.obia_2nd_pass) ? ee.Image(region_params.geo_map_clean) : ee.Image(region_params.geo_map)
var benthic_map = (vars.obia_2nd_pass) ? ee.Image(region_params.benthic_map_clean) : ee.Image(region_params.benthic_map)*/
var depth = ee.Image(region_params.pixels).select('depth')
var image = ee.Image(region_params.image)

//var input_map = (vars.geomorphic) ? geo_map : benthic_map // Set the map to either geomorphic or benthic

var display_pal = (vars.geomorphic) ? map_palettes.geo : map_palettes.benthic
Map.centerObject(eg_area, 11)
Map.addLayer(depth, {}, 'Depth data', false)
Map.addLayer(image, {}, 'Dove low tide', false)



// 3. Object-based re-classificaiton and cleaning

/*

// if we want to retain the land/waves flags, need to add them in before makign the mask

######## Not that straight forwards - the land and bright masks are a LOT of not land and not breakign waves... =(

// add in land, for geomorphic clean up rules
  geo_map = geo_map.unmask(0).where({
    test: depth.eq(-2).and(globcover.select('landcover').neq(210)),
    value: ee.Image(1)
  })
  
  // change -3 to reef rim, hope that clouds have been handleded by masking
  geo_map = geo_map.unmask(0).where({
    test: depth.eq(-3),
    value: ee.Image(15)
  })
  
  // remask
  geo_map = geo_map.updateMask(geo_map.gt(0))

*/

/* OUTPUT EXTENT
  - to the mapping extent just so it doesn't balloon out
  - to the 'reef boundary' extent for noise/deep removal
*/  
var class_extent_mask = geo_map.gt(0).clip(reef_boundary)

Map.addLayer(geo_map, display_pal, 'Raw GEO classification', false)
//Map.addLayer(benthic_map, display_pal, 'Raw BENTHIC classification', false)

/*

// define the cleaned map to either do OBIA on or just export later
var clean_map = smooth_map
//Map.addLayer(clean_map.reproject(ee.Projection('EPSG:4326').atScale(ee.Number(vars.image_data_scale))), display_pal, "output_scale", true)

########
Initial small object clean
 - this was originally at the end, but we needed to massively reduce the number of objects to 
   iterate through in the OBIA cleaning, so this happens first now
 - future collabs with google might fix this, but need to change the parallel serialisation of vector procesing
 
 - includes a possible special case for:
      - geomorphic to clean up turbid areas over size threshold; fix shallow vs. deep lagoon
      - benthic to allow breaking waves (temporal class) to grow into surrounding class
########

*/

if (vars.geomorphic && !vars.obia_2nd_pass) {
  
  // make a smooth map with masked area as a value
  var smooth_map = geo_map
                      //.unmask(99)
                      .focal_mode({
                        radius: vars.smooth_radius, // relates to smoothness required
                        kernelType: 'circle', units: 'pixels', iterations: 2
                      })
  //smooth_map = smooth_map.updateMask(smooth_map.neq(99)).updateMask(class_extent_mask)
  
  //replace small objects with smooth underneath
  var clean_map = geo_map.where({
    test: geo_map.connectedPixelCount(vars.small_object, false).lt(vars.small_object), 
    value: smooth_map
  //}).updateMask(smooth_map.neq(99)).updateMask(class_extent_mask)
  }).updateMask(class_extent_mask)
  
  // shallow lagoon > 10m == deep lagoon
  clean_map = clean_map.where({
    test: clean_map.eq(11)
                   .and(depth.gt(1000)),
    value: ee.Image(12)
  })
  
  // deep lagoon == deep (to hard to differentiate deep water vs. deep lagoon effectively over large areas)
  clean_map = clean_map.where({
    test: clean_map.eq(12),
    value: ee.Image(2)
  })
  
  // deep water in depth data == deep (s2 + ls8 data should be good enough for this)
  clean_map = clean_map.where({
    test: depth.gt(1500),
    value: ee.Image(2)
  })
  
  
  /*//CLEAN UP SMALL (but slightly larger) TURBID AREAS
  var smooth_noturbid = clean_map
                          .updateMask(clean_map.neq(3))
                          .focal_mode({
                            radius: vars.smooth_radius.multiply(1.5),
                            kernelType: 'circle', units: 'pixels', iterations: 2
                          })
  
  clean_map = clean_map.where({
    test: clean_map.eq(3).connectedPixelCount(vars.small_object.multiply(10), false).lt(vars.small_object.multiply(10)), 
    value: smooth_noturbid
  }).updateMask(class_extent_mask)*/
}


if (!vars.geomorphic) {
  
  // make a smooth map with masked area as a value, and without temporal class (basically breaking waves)
  var smooth_map = benthic_map
                      //.unmask(99)
                      .focal_mode({
                        radius: vars.smooth_radius, // relates to smoothness required
                        kernelType: 'circle', units: 'pixels', iterations: 1
                      })
  //smooth_map = smooth_map.updateMask(smooth_map.neq(99)).updateMask(class_extent_mask)
  
  //replace small objects with smooth underneath
  var clean_map = benthic_map.where({
    test: benthic_map.connectedPixelCount(vars.small_object, false).lt(vars.small_object), 
    value: smooth_map
  //}).updateMask(smooth_map.neq(99)).updateMask(class_extent_mask)
  }).updateMask(class_extent_mask)
  
  // cut benthic off to < 10 m
  clean_map = clean_map.where({
    test: depth.gt(1000),
    value: ee.Image(0)
  })
  
  /*// CLEAN UP ALL TEMPORAL AREAS
  var smooth_notemp = benthic_map
                          .updateMask(benthic_map.neq(2))
                          .focal_mode({
                            radius: vars.smooth_radius.multiply(2),
                            kernelType: 'circle', units: 'pixels', iterations: 3
                          })
  
  
  clean_map = clean_map1.where({
    test: benthic_map.eq(2), 
    value: smooth_notemp
  }).updateMask(clean_map1.gte(0))
  
  // this catches any left over unmasked temporal, and assigned it back to temporal
  clean_map = clean_map.where({
    test: clean_map.unmask(99).eq(99).and(clean_map1.eq(2)),
    value: ee.Image(2)
  })*/
  
}



if (vars.geomorphic && vars.obia_2nd_pass) {
  var clean_map = geo_map
}

Map.addLayer(clean_map.reproject(ee.Projection('EPSG:4326').atScale(ee.Number(vars.image_data_scale))), display_pal, 'Initial smooth classification', false)

if (vars.obia_clean) {
  
  // #########
  // THE PLAN - vectorise one/few class/es at a time, thus only spending resources on what is actually needed to clean up
  // #########
  
  // FUNCTION that maps over feature colleciton and assigns neighbour percentages
  var set_neighbour_properties = function(f) {
    // make the 1px buffer
    var diff = f.buffer(vars.image_data_scale).difference(f, ee.ErrorMargin(0.5))
    // reduce the classes in the buffer zone
    var diff_classes = ee.Dictionary(
      clean_map.unmask(ee.Image(0)).reduceRegion({
        reducer: ee.Reducer.frequencyHistogram(),
        geometry: diff.geometry(),
        scale: vars.image_data_scale,
        maxPixels: 1e11
      }).get('classification')
    )
    // calculate the percentages
    var diff_sum = diff_classes.toArray().reduce(ee.Reducer.sum(), [0]).get([0])
    var diff_percs = diff_classes.map(function(k,v){return(ee.Number(v).divide(diff_sum).multiply(100).toUint8())})
    
    /* NOW, we can try to do the class logic right here (see /users/mitchest/global_reefs/obia_dev),
       or we can return the neighbour % and do image logic via (painted) rasters */
    
    return(f.set(diff_percs))
  }
  
  // FUNCTION to reduce the map to vectors and map the neighbour properties function
  var reduce_neighbours = function() {
    // reduce map to vectors
    var map_fc = clean_map
          .updateMask(segment_id).updateMask(clean_map.eq(classn)) // only vectorise class/es of interest
          .reduceToVectors({
            scale: vars.image_data_scale, 
            eightConnected: false,
            bestEffort: true, 
            maxPixels: 1e13,
            tileScale: 1,
            geometry: reef_boundary
          })
    // map the function, calculate neighbour properties
    return(map_fc.map(set_neighbour_properties))
  }
  
  if (vars.geomorphic && !vars.fast_clean) { // SHOULD TRY TO PUT THIS OUT TO A MODULE TO KEEP THE RULES THE SAME EVERYWEHRE?
    
    // first make a make size threshold, so we're not vecortising huge objects when we don't have to
    var segment_id = clean_map.connectedComponents(ee.Kernel.plus(1),vars.small_object.sqrt()).select('labels')
    //Map.addLayer(segment_id.reproject(ee.Projection('EPSG:4326').atScale(ee.Number(vars.image_data_scale))))
    Map.addLayer(clean_map.updateMask(segment_id).reproject(ee.Projection('EPSG:4326').atScale(ee.Number(vars.image_data_scale))), display_pal, 'Map objects to be iterated through (OBIA)', false)
    
    // This is where we select the single or group of classes to vectorise for cleaning up
    //var classn = ee.Number(15) // one class
    var classn = clean_map.where({
      test: clean_map.neq(16) //TRF
              .and(clean_map.neq(15)) //RR
              .and(clean_map.neq(14)) //ORF
              .and(clean_map.neq(13)) //IRF
              //.and(clean_map.neq(12)) // deep L
              .and(clean_map.neq(11)), // shallow L 
      value: ee.Image(99) // 99 ensures it's ignored in logic
    })
    
    // Minimum size of object to reclass based on neighbourhood
    var max_size = ee.Number(1000).divide(vars.image_data_scale).pow(2) // the first number is the square dimension of the desired min size
    // calculate neighbours
    var map_fc_neighbours = reduce_neighbours()
    
    // #########
    // REEF RIM
    // #########
    
    var focus_class = ee.Number(15) //RR
    
    // start the object-based neighbourhood rules
    // paint out to rasters (only paint the layers needed)
    var objsize = ee.Image(30000).paint(map_fc_neighbours, 'count').rename('count')
    //var nb24 = ee.Image().byte().paint(map_fc_neighbours, '24').unmask(0).rename('nb24') //OCL
    var nb22 = ee.Image().byte().paint(map_fc_neighbours, '22').unmask(0).rename('nb22') //SL ex
    var nb21 = ee.Image().byte().paint(map_fc_neighbours, '21').unmask(0).rename('nb21') //Sl sh
    var nb16 = ee.Image().byte().paint(map_fc_neighbours, '16').unmask(0).rename('nb16') //TRF
    var nb15 = ee.Image().byte().paint(map_fc_neighbours, '15').unmask(0).rename('nb15') //RR
    var nb14 = ee.Image().byte().paint(map_fc_neighbours, '14').unmask(0).rename('nb14') //ORF
    var nb13 = ee.Image().byte().paint(map_fc_neighbours, '13').unmask(0).rename('nb13') //IRF
    //var nb3 = ee.Image().byte().paint(map_fc_neighbours, '3').unmask(0).rename('nb3') //Turbid
    
    // RR surrounded by ORF --> ORF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb14.gt(75)),
      value: ee.Image(14)
    })
    
    // RR surrounded by IRF --> IRF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb13.gt(75)),
      value: ee.Image(13)
    })
    
    // RR surrounded by IRF + ORF --> IRF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb13.add(nb14).gt(75)),
      value: ee.Image(13)
    })
    
    // RR with decent border to TRF --> TRF (often dark, probably seagrass)
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb16.gt(40)),
      value: ee.Image(16)
    })
    
    /*// RR surrounded by OCL --> OCL
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb24.gt(75)),
      value: ee.Image(24)
    })*/
    
    /* with 2nd/3rd pass method, we don't really need this
    // RR surrounded by IRF + ORF --> IRF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb13.lte(75).and(nb14.lte(75))) // to ensure we're no re-writing previous rules
              .and(nb13.add(nb14).gt(75))
              .and(nb21.add(nb22).lte(0)), // to not get rid of complex reef rims (if touching slope, it's probably RR)
      value: ee.Image(13) // could try assigning to a place-holder, then deal with at the end?
    })*/
    
    /*// small RR objects touching OCL + stuff --> ORF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(objsize.lte(max_size))
              .and(nb13.lte(75).and(nb14.lte(75))) // to ensure we're no re-writing previous rules
              .and(nb24.gt(1)),
      value: ee.Image(14)
    })*/
    
    // ####
    // ORF
    // ####
    
    focus_class = ee.Number(14) // ORF
    
    //classn = ee.Number(14)
    //map_fc_neighbours = reduce_neighbours()
    //var nb22 = ee.Image().byte().paint(map_fc_neighbours, '22').unmask(0).rename('nb22') //SL ex
    //var nb21 = ee.Image().byte().paint(map_fc_neighbours, '21').unmask(0).rename('nb21') //Sl sh
    //nb15 = ee.Image().byte().paint(map_fc_neighbours, '15').unmask(0).rename('nb15') //RR
    //nb13 = ee.Image().byte().paint(map_fc_neighbours, '13').unmask(0).rename('nb13') //IRF
    //var nb1 = ee.Image().byte().paint(map_fc_neighbours, '1').unmask(0).rename('nb1') //Land
    
    // ORF surrounded by IRF --> IRF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb13.gt(75)),
      value: ee.Image(13)
    })
    
    // ORF surrounded by TRF --> TRF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb16.gt(75)),
      value: ee.Image(16)
    })
    
    // ORF surrounded by RR --> RR
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb15.gt(85)),
      value: ee.Image(15)
    })
    
    // ORF touching slope and RR --> RR
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb21.gt(0).or(nb22.gt(0)))
              .and(nb15.gt(0)),
      value: ee.Image(15)
    })
    
    /*// ORF touching land --> TRF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb1.gt(10)),
      value: ee.Image(16)
    })*/
    
    // ####
    // IRF
    // ####
    
    focus_class = ee.Number(13) // IRF
    
    //classn = ee.Number(13)
    //map_fc_neighbours = reduce_neighbours()
    //nb15 = ee.Image().byte().paint(map_fc_neighbours, '15').unmask(0).rename('nb15') //RR
    //nb14 = ee.Image().byte().paint(map_fc_neighbours, '14').unmask(0).rename('nb14') //ORF
    
    // IRF surrounded by ORF --> ORF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb14.gt(75)),
      value: ee.Image(14)
    })
    
    // IRF surrounded by TRF --> TRF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb16.gt(75)),
      value: ee.Image(16)
    })
    
    // IRF surrounded by RR --> RR
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb15.gt(85)),
      value: ee.Image(15)
    })
    
    /*// IRF touching land --> TRF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb1.gt(10)),
      value: ee.Image(16)
    })*/
    
    // ####
    // TRF
    // ####
    
    focus_class = ee.Number(16) // TRF
    
    //classn = ee.Number(16)
    //map_fc_neighbours = reduce_neighbours()
    //nb15 = ee.Image().byte().paint(map_fc_neighbours, '15').unmask(0).rename('nb15') //RR
    //nb14 = ee.Image().byte().paint(map_fc_neighbours, '14').unmask(0).rename('nb14') //ORF
    //nb13 = ee.Image().byte().paint(map_fc_neighbours, '13').unmask(0).rename('nb13') //IRF
    
    // TRF surrounded by ORF --> ORF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb14.gt(75)),
      value: ee.Image(14)
    })
    
    // TRF surrounded by IRF --> IRF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb13.gt(75)),
      value: ee.Image(13)
    })
    
    // TRF surrounded by IRF + ORF --> IRF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb13.add(nb14).gt(75)),
      value: ee.Image(13)
    })
    
    /*// TRF not touching land --> IRF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb1.lt(10)),
      value: ee.Image(13)
    })*/
    
    
    // ####
    // LAGOONS
    // ####
    
    var nb11 = ee.Image().byte().paint(map_fc_neighbours, '11').unmask(0).rename('nb11') // shallow lag
    //var nb12 = ee.Image().byte().paint(map_fc_neighbours, '12').unmask(0).rename('nb12') //deep lag
    
    // DL touching SL --> SL
    /* 
    This is a stop-gap until we have better depth product - below are the rules we want,
    but too much band-aiding is required to make it work, so for the moment just err on the side
    of shallow lagoon when it's mixed.
    */
    /*clean_map = clean_map.where({
      test: clean_map.eq(12)
              .and(nb11.gt(0)),
      value: ee.Image(11)
    })*/
    
    /*// SL sourrounded by DL --> DL
    clean_map = clean_map.where({
      test: clean_map.eq(11)
              .and(nb12.gt(75)),
      value: ee.Image(12)
    })*/
    
    /*// DL sourrounded by SL --> SL
    clean_map = clean_map.where({
      test: clean_map.eq(12)
              .and(nb11.gt(75)),
      value: ee.Image(11)
    })*/
    
    /*// DL/SL surrounded by IRF --> IRF
    clean_map = clean_map.where({
      test: clean_map.eq(11).or(clean_map.eq(12))
              .and(objsize.lte(max_size))
              .and(nb13.gt(80)),
      value: ee.Image(13)
    })*/
    
    // SL surrounded by IRF --> IRF
    clean_map = clean_map.where({
      test: clean_map.eq(11)
              .and(objsize.lte(max_size))
              .and(nb13.gt(80)),
      value: ee.Image(13)
    })
    
    /*// DL/SL touching OCL --> OCL
    clean_map = clean_map.where({
      test: clean_map.eq(11).or(clean_map.eq(12))
              .and(nb24.gt(0)),
      value: ee.Image(24)
    })*/
    
    
    /*// ####
    // Turbid
    // ####
    
    focus_class = ee.Number(3) // turbid
    
    // Turb surrounded by IRF --> IRF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb13.gt(75)),
      value: ee.Image(13)
    })
    
    // Turb surrounded by ORF --> ORF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb14.gt(75)),
      value: ee.Image(14)
    })
    
    // Turb surrounded by TRF --> TRF
    clean_map = clean_map.where({
      test: clean_map.eq(focus_class)
              .and(nb16.gt(75)),
      value: ee.Image(16)
    })*/
  
  } else if (vars.geomorphic && vars.fast_clean) {
    
    /* fast version of the geo clean up
      - at the moment it blanket assigned the underlying very smooth class
      - uses connectedComponents with the idea that we'll transition to doing the 
        OBIA iteration, but take the max, instead of doing the class percs, to see if that speeds things up
    */
    
    // make a very smooth map to capture the broader neighbourhood
    var smooth_map = clean_map
                        .focal_mode({
                          radius: vars.smooth_radius.multiply(3), // relates to smoothness required
                          kernelType: 'circle', units: 'pixels', iterations: 2
                        })
    
    
    // first make a make size threshold, so we're not vectorising huge objects when we don't have to
    // - the unmask(99) captures small no data values/ data gaps
    var segment_id = clean_map.unmask(ee.Image(99)).connectedComponents(ee.Kernel.plus(1),vars.small_object.sqrt()).select('labels')
    Map.addLayer(segment_id.reproject(ee.Projection('EPSG:4326').atScale(ee.Number(vars.image_data_scale))), display_pal, 'segment reduction', false)
    Map.addLayer(clean_map.updateMask(segment_id.gt(0)).reproject(ee.Projection('EPSG:4326').atScale(ee.Number(vars.image_data_scale))), display_pal, 'Map objects to be iterated through (OBIA)', false)
    
    
    // replace small objects with smooth underneath
    var clean_map = clean_map.where({
      test: segment_id.gt(0), 
      value: smooth_map
    })
    
  } else {
    
    // BENTHIC CLEAN-UP RULES
    
    // Deep (or land or missing) in geo == masked from benthic
    clean_map = clean_map.where({
      test: geo_map.unmask(0).lte(2),
      value: ee.Image(0)
    })
    
    // Deep lagoon in geo == masked from benthic
    clean_map = clean_map.where({
      test: geo_map.eq(12),
      value: ee.Image(0)
    })
    
    /*// turbid in geo == turbid (temporal - class num 2)
    // ############## ---> need to decide here whether to push geo turbid through regardless of benthic class
    clean_map = clean_map.where({
      test: geo_map.eq(3),
      value: ee.Image(2)
    })*/
    
    /*
    // Ignore in benthic + ORF in geo == rock
    clean_map = clean_map.where({
      test: clean_map.eq(0)
                     .and(geo_map.eq(14)),
      value: ee.Image(13)
    })
    
    // Ignore in benthic + IRF in geo == sand
    clean_map = clean_map.where({
      test: clean_map.eq(0)
                     .and(geo_map.eq(13)),
      value: ee.Image(11)
    })
    
    // Ignore in benthic + TRF in geo == sand
    clean_map = clean_map.where({
      test: clean_map.eq(0)
                     .and(geo_map.eq(16)),
      value: ee.Image(11)
    })
    
    // Ignore in benthic + RR in geo == rock
    */
    
    // seagrass in benthic + ORF or RR in geo == coral/algae
    clean_map = clean_map.where({
      test: clean_map.eq(14)
                     .and(geo_map.eq(14).or(geo_map.eq(15)).or(geo_map.eq(21)).or(geo_map.eq(22))),
      value: ee.Image(15)
    })
    
    // ####--> CR: "Seagrass neighbouring deep water or no data not shallow a rock or coral algae class"
    
    // coral or algae in benthic + TRF in geo == seagrass
    clean_map = clean_map.where({
      test: clean_map.eq(16)
                     .and(geo_map.eq(16)),
      value: ee.Image(14)
    })
    
    // BMA in benthic and slope/plat in geo == sand
    clean_map = clean_map.where({
      test: clean_map.eq(18)
                     .and(geo_map.eq(2).or(geo_map.eq(12)).or(geo_map.eq(21)).or(geo_map.eq(22)).or(geo_map.eq(23))),
      value: ee.Image(11)
    })
    
  }
  
/*  // ####
  // Final small object clean (safety net for oddities with scaling and border buffers??)
  // ####
  
  var map_vsmooth = clean_map
                        .focal_mode({
                          radius: 10, // relates to smoothness required
                          kernelType: 'circle', units: 'pixels', iterations: 1
                        })
                        .updateMask(class_extent_mask)
  
  clean_map = clean_map.where({
    test: clean_map.connectedPixelCount(vars.small_object, false).lt(vars.small_object), 
    value: map_vsmooth
  })*/

}

// final smooth
if (vars.smooth_output) {
  // smooth the output lightly to make nice edges, and get rid of noise
  var noise_smooth = clean_map.unmask(99) // unmasking to a value allows us to include masked areas in the smooth, then re-mask after
                        .focal_mode({
                          radius: 2, // relates to smoothness required
                          kernelType: 'circle', units: 'pixels', iterations: 2
                        })
  //clean_map = clean_map.updateMask(noise_smooth.neq(99)).updateMask(geo_map.gt(2)) // this ignores 0/land/deep water
  clean_map = clean_map.updateMask(noise_smooth.neq(99)).updateMask(geo_map.gt(1)) // this ignores 0/land
} else {
  // just clip to the classified extent and move on
  // clean_map = clean_map.updateMask(geo_map.gt(2)) // this ignores deep water
  clean_map = clean_map.updateMask(geo_map.gt(1)) // this ignores 0/land
}


// 4. Export data

var output_name = (vars.geomorphic) ? vars.geomorph_output_name : vars.benthic_output_name


if (vars.do_export) {
  print("For export, the image data scale must be set to:", vars.image_data_scale)
  
  if (vars.export_small_area) {
    var export_convhull = export_small
  } else {
    //var export_convhull = clean_map.gt(2).reduceToVectors({scale: 1000, maxPixels: 1e13, bestEffort: true, geometry: wmic_extent, crs: "EPSG:4326"}).geometry().convexHull({maxError: 100})
    var export_convhull = reef_boundary
  }
  Map.addLayer(export_convhull, {}, "Export footprint", true)
  Export.image.toAsset({
    image: clean_map.set(vars),
    description: output_name,
    assetId: vars.asset_output + 'in_out/' + output_name,
    region: export_convhull,
    scale: vars.image_data_scale,
    crs: 'EPSG:4326',
    maxPixels: 1e13,
    pyramidingPolicy: {'.default': 'mode'}
  })
  /*Export.image.toCloudStorage({
    image: clean_map,//.set(vars),
    description: 'swp_geo_clean',
    bucket: 'mitchest_unet_bucket',
    fileNamePrefix: 'swp_geo_clean',
    region: export_convhull,
    scale: 25,
    crs: 'EPSG:4326',
    maxPixels: 1e13
  })*/
  
  
} else {
  if (vars.show_eg_area) {
    if (vars.reproject_display) {
      Map.addLayer(clean_map.clip(eg_area).reproject(ee.Projection('EPSG:4326').atScale(vars.image_data_scale)), display_pal, output_name + '_final', false)
    } else {
      Map.addLayer(clean_map.clip(eg_area), display_pal, output_name + '_final', false)
    }
  } else {
    if (vars.reproject_display) {
      Map.addLayer(clean_map.reproject(ee.Projection('EPSG:4326').atScale(vars.image_data_scale)), display_pal, output_name + '_final', false)
    } else {
      Map.addLayer(clean_map, display_pal, output_name + '_final', false)
    }
  }
}
